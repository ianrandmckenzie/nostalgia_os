(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=n(i);fetch(i.href,r)}})();const hr="modulepreload",yr=function(e){return"/"+e},Mo={},Hn=function(t,n,o){let i=Promise.resolve();if(n&&n.length>0){let a=function(c){return Promise.all(c.map(f=>Promise.resolve(f).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),l=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));i=a(n.map(c=>{if(c=yr(c),c in Mo)return;Mo[c]=!0;const f=c.endsWith(".css"),p=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${p}`))return;const d=document.createElement("link");if(d.rel=f?"stylesheet":hr,f||(d.as="script"),d.crossOrigin="",d.href=c,l&&d.setAttribute("nonce",l),document.head.appendChild(d),f)return new Promise((u,m)=>{d.addEventListener("load",u),d.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${c}`)))})}))}function r(a){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=a,window.dispatchEvent(s),!s.defaultPrevented)throw a}return i.then(a=>{for(const s of a||[])s.status==="rejected"&&r(s.reason);return t().catch(r)})},mn={development:{API_BASE_URL:"http://abc.localhost:3000/",SUGGESTIONS_LIST_PATH:"end_data/public/ananan",SUGGESTIONS_SUBMISSIONS_PATH:"end_data/public/kfjbwef",TUBE_STREAMS_PATH:"tube-streams.json"},production:{API_BASE_URL:"https://backend.failureunit.tv/",SUGGESTIONS_LIST_PATH:"end_data/public/suggestions",SUGGESTIONS_SUBMISSIONS_PATH:"end_data/public/submit-suggestion",TUBE_STREAMS_PATH:"tube-streams.json"},trusted_providers:[{domains:["s3.ca-central-1.amazonaws.com","www.failureunit.tv"],dev_domains:["localhost","*.localhost","abc.localhost:3000"],types:["img","audio","video"]},{domains:["backend.failureunit.tv"],dev_domains:["abc.localhost:3000"],types:["connect"]},{domains:["i.ytimg.com","img.youtube.com"],dev_domains:[],types:["img"]},{domains:["www.youtube.com"],dev_domains:[],types:["frame"]}],db_name:"FailureUnitTV",site_name:"FU TV",branding_images:"custom_branding",disable_devvit:!0},br=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.hostname==="0.0.0.0",gn=br?"development":"production",Wt=mn[gn].API_BASE_URL,Zo=mn[gn].SUGGESTIONS_LIST_PATH,wr=mn[gn].SUGGESTIONS_SUBMISSIONS_PATH,Jo=mn[gn].TUBE_STREAMS_PATH;class vr{constructor(t="NostalgiaOS",n=1){this.dbName=t,this.version=n,this.db=null,this.cache=new Map,this.initPromise=this.init()}async init(){return new Promise((t,n)=>{const o=indexedDB.open(this.dbName,this.version);o.onerror=()=>{console.error("IndexedDB error:",o.error),n(o.error)},o.onsuccess=async()=>{this.db=o.result,await this.populateCache(),t(this.db)},o.onupgradeneeded=i=>{const r=i.target.result;r.objectStoreNames.contains("storage")||r.createObjectStore("storage",{keyPath:"key"})}})}async populateCache(){try{if(!this.db)return;const n=this.db.transaction(["storage"],"readonly").objectStore("storage");return new Promise((o,i)=>{const r=n.getAll();r.onsuccess=()=>{r.result.forEach(s=>{this.cache.set(s.key,s.value)}),o()},r.onerror=()=>{console.warn("Failed to populate cache:",r.error),i(r.error)}})}catch(t){console.warn("Failed to populate cache:",t)}}async ensureDB(){return this.db||await this.initPromise,this.db}async setItem(t,n){const r=(await this.ensureDB()).transaction(["storage"],"readwrite").objectStore("storage"),a={key:t,value:n,timestamp:Date.now()};return this.cache.set(t,n),new Promise((s,l)=>{const c=r.put(a);c.onsuccess=()=>s(),c.onerror=()=>l(c.error)})}async getItem(t){const i=(await this.ensureDB()).transaction(["storage"],"readonly").objectStore("storage");return new Promise((r,a)=>{const s=i.get(t);s.onsuccess=()=>{const l=s.result;let c=l?l.value:null;this.cache.set(t,c),r(c)},s.onerror=()=>a(s.error)})}async removeItem(t){const i=(await this.ensureDB()).transaction(["storage"],"readwrite").objectStore("storage");return this.cache.delete(t),new Promise((r,a)=>{const s=i.delete(t);s.onsuccess=()=>r(),s.onerror=()=>a(s.error)})}async clear(){const o=(await this.ensureDB()).transaction(["storage"],"readwrite").objectStore("storage");return this.cache.clear(),new Promise((i,r)=>{const a=o.clear();a.onsuccess=()=>i(),a.onerror=()=>r(a.error)})}async getAllKeys(){const o=(await this.ensureDB()).transaction(["storage"],"readonly").objectStore("storage");return new Promise((i,r)=>{const a=o.getAllKeys();a.onsuccess=()=>i(a.result),a.onerror=()=>r(a.error)})}setItemSync(t,n){this.cache.set(t,n),this.setItemWithRetry(t,n,3).catch(o=>{console.warn("Failed to save to IndexedDB after retries:",o)})}async setItemWithRetry(t,n,o=3){let i;for(let r=0;r<o;r++)try{await this.setItem(t,n);return}catch(a){i=a,console.warn(`setItem retry ${r+1}/${o} failed:`,a),r<o-1&&await new Promise(s=>setTimeout(s,Math.pow(2,r)*100))}throw i}getItemSync(t){return this.cache.has(t)?this.cache.get(t):(this.getItem(t).catch(console.warn),null)}removeItemSync(t){this.cache.delete(t),this.removeItem(t).catch(console.error)}clearSync(){this.cache.clear(),this.clear().catch(console.error)}}const ze=new vr,B={async ensureReady(){return await ze.ensureDB(),ze.cache.size===0&&await ze.populateCache(),ze.db},async setItem(e,t){return await ze.setItem(e,t)},async getItem(e){return await ze.getItem(e)},async removeItem(e){return await ze.removeItem(e)},async clear(){return await ze.clear()},async getAllKeys(){return await ze.getAllKeys()},async preloadKeys(e){for(const t of e)try{await this.getItem(t)}catch(n){console.warn(`Failed to preload key ${t}:`,n)}},setItemSync(e,t){return ze.setItemSync(e,t)},getItemSync(e){return ze.getItemSync(e)},removeItemSync(e){return ze.removeItemSync(e)},clearSync(){return ze.clearSync()}};typeof window<"u"&&(window.globalStorage=B,window.storage=B);function xr(e,t=[],n=[]){const o=document.createElement("div");return o.innerHTML=e,o.querySelectorAll("*").forEach(r=>{if(!t.includes(r.tagName.toLowerCase())){r.remove();return}[...r.attributes].forEach(s=>{n.includes(s.name.toLowerCase())||r.removeAttribute(s.name)})}),o.innerHTML}let dt;async function kr(){try{const e=await B.getItem("appState");if(e&&e.fileSystemState)return e.fileSystemState}catch(e){console.warn("Failed to get file system state from IndexedDB:",e);try{const t=B.getItemSync("appState");if(t&&t.fileSystemState)return t.fileSystemState}catch(t){console.warn("Failed to get file system state with fallback:",t)}}return dt}async function Ao(e){e.folders&&Object.keys(e.folders).forEach(t=>{const n=e.folders[t];n&&typeof n=="object"&&Object.keys(n).filter(o=>{const i=n[o];return i&&i.type==="shortcut"})});try{const t=await B.getItem("appState")||{};t.fileSystemState=e,await B.setItem("appState",t),dt=e,typeof window<"u"&&(window.fileSystemState=e)}catch(t){console.warn("Failed to set file system state in IndexedDB:",t);try{const n=B.getItemSync("appState")||{};n.fileSystemState=e,B.setItemSync("appState",n),dt=e,typeof window<"u"&&(window.fileSystemState=e)}catch(n){console.error("Failed to set file system state with fallback:",n)}}}function le(){try{const e=B.getItemSync("appState");if(e&&e.fileSystemState){const t=e.fileSystemState;return["C://","C://Desktop","C://Documents"].forEach(n=>{t.folders&&t.folders[n]&&Object.keys(t.folders[n]).filter(r=>{const a=t.folders[n][r];return a&&a.type==="shortcut"}).length>0}),t}}catch(e){console.warn("Failed to get file system state sync:",e)}return typeof window<"u"&&window.fileSystemState?window.fileSystemState:typeof dt<"u"?dt:(console.error("No file system state available anywhere!"),{folders:{"C://":{},"A://":{},"D://":{}}})}function Qn(e){e=normalizePath(e);const t=le();if(t.initialized!==!0&&Sr(),e.substring(1,4)==="://"&&e.length===4)return t.folders[e]||{};const n=t.folders[e]||{},o={};for(const[i,r]of Object.entries(n))i!=="contents"&&r&&typeof r=="object"&&r.type&&(o[i]=r);return o}const Er={files:[]};function Sr(){try{const e=le();if(!e.folders||!e.folders["C://"]){console.warn("File system structure not properly initialized for sync document fetch");return}const t=Er.files.map(o=>{const i=o.url.split(".").pop().toLowerCase();let r="image/file.webp";return["png","jpg","jpeg","gif"].includes(i)?r="image/image.webp":["mp4","webm"].includes(i)?r="image/video.webp":["mp3","wav"].includes(i)?r="image/audio.webp":i==="html"?r="image/html.webp":["md","txt"].includes(i)&&(r="image/doc.webp"),{id:o.id,name:o.url,type:"file",content:"",fullPath:`C://Documents/${o.id}`,content_type:i,icon_url:r,url:o.url}});e.folders["C://Documents"]||(e.folders["C://Documents"]={});const n={};t.forEach(o=>{n[o.id]=o}),e.folders["C://Documents"]={...e.folders["C://Documents"]||{},...n},e.initialized=!0;try{const o=B.getItemSync("appState")||{};o.fileSystemState=e,B.setItemSync("appState",o),dt=e,typeof window<"u"&&(window.fileSystemState=e)}catch(o){console.warn("Failed to save file system state sync:",o),dt=e,typeof window<"u"&&(window.fileSystemState=e)}}catch(e){console.error("Error loading documents sync:",e)}}document.addEventListener("dblclick",e=>{const t=e.target.closest("[data-open-file]");if(t){e.stopPropagation();const n=t.getAttribute("data-open-file");openFile(n,e)}});document.addEventListener("mobiledbltap",e=>{const t=e.target.closest("[data-open-file]");if(t){e.stopPropagation();const n=t.getAttribute("data-open-file");openFile(n,e)}});function Zt(e){return/^[A-Z]:\/\/$/.test(e)?e:e.replace(/\/+$/,"")}function Cr(e){if(/^[A-Z]:\/\/$/.test(e))return e;const t=le();function n(o){for(const i in o){const r=o[i];if(r.type==="folder"){if(r.fullPath===e)return i;const a=t.folders[r.fullPath]||{},s=n(a);if(s)return s}}return null}for(const o in t.folders)if(/^[A-Z]:\/\/$/.test(o)){const i=n(t.folders[o]);if(i)return i}return null}function Qo(e,t=null){e=Zt(e);const n=t||le();if(/^[A-Z]:\/\/$/.test(e))return{id:e,name:e,fullPath:e,contents:n.folders[e]};function o(){for(const i in n.folders)if(/^[A-Z]:\/\/$/.test(i))for(const r in n.folders[i]){const a=n.folders[i][r];if(a.type==="folder"&&Zt(a.fullPath)===e)return a}else for(const r in n.folders[i]){const a=n.folders[i][r];if(a.type==="folder"&&Zt(a.fullPath)===e)return a}return null}return o()}function hn(e,t=!1){if(/^[A-Z]:\/\/$/.test(e))return e;const n=le();function o(i,r=null){for(const a in i){const s=i[a];if(s.type==="folder"||t===!0){if(a===e)return s.fullPath;if(s.type==="folder"&&s.fullPath&&n.folders[s.fullPath]){const l=o(n.folders[s.fullPath],s.fullPath);if(l)return l}}}return null}for(const i in n.folders)if(/^[A-Z]:\/\/$/.test(i)){const r=o(n.folders[i],i);if(r)return r}return null}function Ht(e,t=!1){let n;if(/^[A-Z]:\/\//.test(e)?n=e:n=hn(e),!n){console.error("Folder not found for id/path:",e);return}const o=rt(n);if(!t){let a=document.getElementById("explorer-window");if(a)return a.querySelector(".file-explorer-window").outerHTML=o,a.querySelector(".file-explorer-window").setAttribute("data-current-path",n),ot(a.id,o),setTimeout(Pe,100),setTimeout(async()=>{await bt()},150),a}const i=t?`explorer-window-${Date.now()}`:"explorer-window",r=se(n,o,!1,i,!1,!1,{type:"integer",width:600,height:400},"Explorer");return setTimeout(async()=>{await bt()},150),r}function yt(e){const t=`openExplorer_${e}`,n=Date.now();if(window.explorerDebounce&&window.explorerDebounce[t]){const o=window.explorerDebounce[t];if(n-o<500)return}return window.explorerDebounce||(window.explorerDebounce={}),window.explorerDebounce[t]=n,setTimeout(()=>{window.explorerDebounce&&window.explorerDebounce[t]===n&&delete window.explorerDebounce[t]},1e3),Ht(e,!0)}window.openExplorerInNewWindow=yt;function it(){document.querySelectorAll(".file-explorer-window").forEach(e=>{const t=e.getAttribute("data-current-path"),n=rt(t),o=e.parentElement;o.innerHTML=n}),Pe()}function ei(e){e=normalizePath(e);const t=e.match(/^([A-Z]:\/\/)(.*)/);if(!t)return e;const n=t[1],o=t[2];let i=`<span class="cursor-pointer hover:underline" data-path="${n}">${n}</span>`;if(!o)return i;let r=n;return o.split("/").filter(Boolean).forEach(a=>{r=r.endsWith("/")?r+a:`${r}/${a}`;const s=Qo(r),l=s?s.name:a;i+=` / <span class="cursor-pointer hover:underline" data-path="${s?s.id:r}">${l}</span>`}),i}function rt(e="C://"){e=normalizePath(e);const t=Qn(e),n=['<ul class="pl-5">'];Object.values(t).forEach(r=>{const a=r.type==="folder";let s=a?"image/folder.webp":"image/file.webp";r.icon?s=r.icon:r.icon_url&&(s=r.icon_url);const l="cursor-pointer hover:bg-gray-50 file-item truncate"+(a?" folder-item":""),c=r.description?` (${r.description})`:"";if(a)n.push(`<li class="${l}" data-item-id="${r.id}" data-open-folder="${r.id}" title="${r.name}"><img src="${s}" class="inline h-4 w-4 mr-2" alt="${r.name} folder icon"> ${r.name}</li>`);else if(r.type==="shortcut")n.push(`<li class="${l}" data-item-id="${r.id}" data-open-shortcut="true" data-url="${r.url}" title="${r.name}${c}"><img src="${s}" class="inline h-4 w-4 mr-2" alt="${r.name} shortcut icon"> ${r.name}</li>`);else{const f=r.name||r.id||"Unknown File";r.name||console.warn("üîç EXPLORER: File missing name property, using fallback:",f,"Item:",r),n.push(`<li class="${l}" data-item-id="${r.id}" data-open-file="${r.id}" title="${f}${c}"><img src="${s}" class="inline h-4 w-4 mr-2" alt="${f} file icon"> ${f}</li>`)}}),n.push("</ul>");const o=["C://","A://","D://"].map(r=>`<li class="cursor-pointer border-b border-gray-200 hover:bg-gray-50 system-folder" data-open-drive="${r}"><img src="image/${r[0].toLowerCase()==="c"?"drive_c":r[0].toLowerCase()==="a"?"floppy":"cd"}.webp" class="inline h-4 w-4 mr-2" alt="${r} drive icon"> ${r}</li>`).join(""),i=ei(e);return`
    <div class="file-explorer-window" data-current-path="${e}">
      <div class="flex">
        <!-- Left Sidebar -->
        <div id="file-sidebar" class="w-1/4 border-r p-2"><ul>${o}</ul></div>

        <!-- Main Content -->
        <div id="file-main" class="w-3/4 p-2 min-h-96">
          <div id="breadcrumbs" class="mb-2">Path: ${i}</div>
          <div id="files-area">
            ${n.join("")}
          </div>
        </div>
      </div>
    </div>
  `}document.addEventListener("click",e=>{const t=e.target.closest(".file-explorer-window");if(t&&t.getAttribute("data-image-selection-mode")==="true"){const n=e.target.closest("[data-open-file]");if(n){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const o=t.getAttribute("data-current-path"),i=Qn(o),r=Object.values(i).find(a=>a.id===n.dataset.openFile);if(r&&["png","jpg","jpeg","gif","webp","avif"].includes(r.content_type)){t.querySelectorAll("[data-open-file]").forEach(l=>{l.classList.remove("bg-blue-100","border-blue-300"),l.style.backgroundColor="",l.style.border=""}),n.classList.add("bg-blue-100","border-blue-300"),n.style.backgroundColor="#dbeafe",n.style.border="2px solid #93c5fd",n.style.borderRadius="4px";const s=document.getElementById("selected-image-name");if(s)if(s.textContent=`Selected: ${r.name}`,window.watercolourSelectedFile=r,typeof window.updateWatercolourImageSelectionButton=="function")window.updateWatercolourImageSelectionButton(!0);else{const l=document.getElementById("open-selected-image");l&&(l.disabled=!1)}else console.error("Selection UI elements not found",{selectedNameSpan:s})}else{const a=document.getElementById("selected-image-name");if(a)if(a.textContent="Please select an image file",typeof window.updateWatercolourImageSelectionButton=="function")window.updateWatercolourImageSelectionButton(!1);else{const s=document.getElementById("open-selected-image");s&&(s.disabled=!0)}}return}}},!0);document.addEventListener("dblclick",e=>{const t=e.target.closest("[data-open-folder],[data-open-file],[data-open-shortcut]");if(!t)return;const n=e.target.closest(".file-explorer-window");if(n&&n.getAttribute("data-image-selection-mode")==="true")return e.preventDefault(),e.stopPropagation(),!1;if(t.dataset.openFolder)if(n){const o=t.dataset.openFolder;let i;if(/^[A-Z]:\/\//.test(o)?i=o:i=hn(o),i){const r=rt(i);n.outerHTML=r;const a=n.closest(".window");a&&a.id&&ot(a.id,r),setTimeout(Pe,100),setTimeout(async()=>{await bt()},150)}}else Ht(t.dataset.openFolder);else t.dataset.openFile?$t(t.dataset.openFile,e):t.dataset.openShortcut&&Jt(t)});document.addEventListener("click",e=>{const t=e.target.closest("[data-open-drive]");if(t){const n=t.closest(".file-explorer-window");if(n){const o=t.dataset.openDrive,i=rt(o);n.outerHTML=i;const r=n.closest(".window");r&&r.id&&ot(r.id,i),setTimeout(Pe,100),setTimeout(async()=>{await bt()},150)}else Ht(t.dataset.openDrive)}});document.addEventListener("click",e=>{const t=e.target.closest("[data-path]");if(t){e.stopPropagation();const n=t.closest(".file-explorer-window");if(n){let o=t.dataset.path;if(o&&!/^[A-Z]:\/\//.test(o)){const a=hn(o);a&&(o=a)}const i=rt(o);n.outerHTML=i;const r=n.closest(".window");r&&r.id&&ot(r.id,i),setTimeout(Pe,100),setTimeout(async()=>{await bt()},150)}else Ht(t.dataset.path)}});const $n=new Set;async function $t(e,t){if($n.has(e))return;const n=document.getElementById(e);if(n){Ce(n);return}$n.add(e);try{let o;const i=t&&t.target===document.body,r=t&&t.target?t.target.closest(".file-explorer-window"):null;let a;i?a="C://Documents":r?a=r.getAttribute("data-current-path"):(t&&t.srcElement&&t.srcElement.classList.contains("desktop-folder-icon"),a="C://Desktop");const s=Qn(a);if(o=Object.values(s).find(d=>d.id===e),!o||typeof o=="string"){const d=`File ${typeof o=="string"?`"${o}"`:""}`;re(`${d}not found.`,"error");return}let l="",c="default";if(o.type==="ugc-file")if(o.content_type==="text"||o.content_type==="txt")l=`<div id="file-content" style="padding:10px;">
          <div id="text-editor" contenteditable="true" style="padding:10px; overflow:auto;" role="textbox" aria-label="Text file editor" title="Edit the contents of this text file">${o.content||o.contents||"Empty file"}</div>
        </div>`,c="editor",setTimeout(()=>{const d=document.getElementById("text-editor");d&&d.addEventListener("input",function(){ot(o.id,this.innerHTML),o.content=this.innerHTML,Q()})},100);else if(o.content_type==="markdown"||o.content_type==="md"){const d=`letterpad_${o.id}`;let u=o.content||o.contents||"";try{const m=await B.getItem(d);m&&m.content!==void 0&&(u=m.content)}catch(m){console.warn("Error checking existing storage for markdown file:",m)}await B.setItem(d,{content:u}),l=`<div id="file-content" style="padding:10px;">
          <div class="letterpad_editor min-h-48 h-full w-full" data-letterpad-editor-id="${o.id}"></div>
        </div>`,c="editor",setTimeout(async()=>{const m=document.querySelector(`[data-letterpad-editor-id="${o.id}"]`);m&&typeof initializeLetterPad=="function"&&await initializeLetterPad(m)},100)}else o.content_type==="html"?l=o.content||o.contents||'<p style="padding:10px;">Empty HTML file.</p>':["png","jpg","jpeg","gif","webp","avif"].includes(o.content_type)?o.dataURL?l=`<img src="${o.dataURL}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:o.isLargeFile&&o.storageLocation==="indexeddb"?(l='<div style="padding:10px; text-align:center;">Loading image...</div>',c="image",setTimeout(async()=>{try{const d=await B.getItem(`file_data_${o.id}`);if(d){const u=`<img src="${d}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`,m=document.getElementById(o.id);if(m){const g=m.querySelector(".p-2");g&&(g.innerHTML=u)}}else throw console.error("No image data found in IndexedDB for file:",o.id),new Error("Image data not found in storage")}catch(d){console.error("Error loading large image file:",d),console.error("File object details:",o);const u=document.getElementById(o.id);if(u){const m=u.querySelector(".p-2");m&&(m.innerHTML=`<p style="padding:10px;">Error loading image: ${d.message}</p>`)}}},100)):o.file&&o.file instanceof File?l=`<img src="${URL.createObjectURL(o.file)}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:o.isDefault||o.isSystemFile||o.path?l=`<img src="${o.path||`media/${o.name}`}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:l=`<p style="padding:10px;">Image file not found or invalid.<br>Debug: isLargeFile=${o.isLargeFile}, storage=${o.storageLocation}</p>`:["mp3","wav","ogg"].includes(o.content_type)?o.dataURL?l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
                <source src="${o.dataURL}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>`:o.isLargeFile&&o.storageLocation==="indexeddb"?(l='<div style="padding:10px; text-align:center;">Loading audio...</div>',c="audio",setTimeout(async()=>{try{const d=await B.getItem(`file_data_${o.id}`);if(d){const u=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
                  <source src="${d}" type="audio/mpeg">
                  Your browser does not support the audio element.
                </audio>`,m=document.getElementById(o.id);if(m){const g=m.querySelector(".p-2");g&&(g.innerHTML=u)}}else throw new Error("Audio data not found in IndexedDB")}catch(d){console.error("Error loading large audio file:",d);const u=document.getElementById(o.id);if(u){const m=u.querySelector(".p-2");m&&(m.innerHTML=`<p style="padding:10px;">Error loading audio: ${d.message}</p>`)}}},100)):o.file&&o.file instanceof File?l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
                <source src="${URL.createObjectURL(o.file)}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>`:o.tempObjectURL?l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;"
                       onerror="console.error('üîç AUDIO: Audio element error:', event.target.error)">
                <source src="${o.tempObjectURL}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>`:o.isDefault||o.isSystemFile||o.path?l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
                <source src="${o.path||`media/${o.name}`}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>`:l='<p style="padding:10px;">Audio file not found or invalid.<br>Debug: Missing required properties for audio playback.</p>':["mp4","webm","avi","mov"].includes(o.content_type)?o.dataURL?l=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
              <source src="${o.dataURL}" type="video/mp4">
              Your browser does not support the video tag.
            </video>`:o.tempObjectURL?l=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;"
                       onerror="console.error('üîç VIDEO: Video element error:', event.target.error)">
              <source src="${o.tempObjectURL}" type="video/mp4">
              Your browser does not support the video tag.
            </video>`:o.isLargeFile&&o.storageLocation==="indexeddb"?(l='<div style="padding:10px; text-align:center;">Loading video...</div>',c="video",setTimeout(async()=>{try{const d=await B.getItem(`file_data_${o.id}`);if(d){const u=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
                  <source src="${d}" type="video/mp4">
                  Your browser does not support the video tag.
                </video>`,m=document.getElementById(o.id);if(m){const g=m.querySelector(".p-2");g&&(g.innerHTML=u)}}}catch(d){console.error("Error loading large video file:",d);const u=document.getElementById(o.id);if(u){const m=u.querySelector(".p-2");m&&(m.innerHTML=`<p style="padding:10px;">Error loading video: ${d.message}</p>`)}}},100)):o.file&&o.file instanceof File?l=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
              <source src="${URL.createObjectURL(o.file)}" type="video/mp4">
              Your browser does not support the video tag.
            </video>`:l='<p style="padding:10px;">Video file not found or invalid.</p>':l=`<p style="padding:10px;">${o.content||o.contents||"Empty file"}</p>`;else["image","jpg","jpeg","png","webp","avif","gif"].includes(o.content_type)?o.file?l=`<img src="${URL.createObjectURL(o.file)}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:l=`<img src="./media/${o.name}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:["video","mov","mp4","webm","avi"].includes(o.content_type)?l=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
              <source src="./media/${o.name}" type="video/mp4">
              Your browser does not support the video tag.
            </video>`:["audio","mp3","ogg","wav"].includes(o.content_type)?o.file?l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
                <source src="${URL.createObjectURL(o.file)}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>`:o.isDefault||o.isSystemFile||o.path?l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
                <source src="${o.path||`media/${o.name}`}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>`:l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
                <source src="./media/${o.name}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>`:o.content_type==="html"?(l=o.contents?o.contents:'<p style="padding:10px;">Loading HTML file...</p>',o.contents||fetch(`./media/${o.name}`).then(d=>d.text()).then(d=>{const u=document.getElementById(o.id),m=u?u.querySelector(".p-2"):null;m&&(m.innerHTML=d),o.contents=d,Q()}).catch(d=>{console.error("Error loading HTML file:",d);const u=document.getElementById(o.id),m=u?u.querySelector(".p-2"):null;m&&(m.innerHTML="<p>Error loading HTML file.</p>")})):o.content_type==="text"||o.content_type==="txt"?(l='<div id="file-content" style="padding:10px;">Loading file...</div>',fetch(`./media/${o.name}`).then(d=>d.text()).then(d=>{const u=document.getElementById(o.id),m=u?u.querySelector(".p-2"):null;m&&(m.innerHTML=`<div id="text-editor" contenteditable="true" style="padding:10px; overflow:auto;" role="textbox" aria-label="Text file editor" title="Edit the contents of this text file">${d}</div>`,document.getElementById("text-editor").addEventListener("input",function(){ot(o.id,this.innerHTML),o.type="ugc-file",o.content=this.innerHTML,Q()})),o.content=d,Q()}).catch(d=>{console.error("Error loading text file:",d);const u=document.getElementById(o.id),m=u?u.querySelector(".p-2"):null;m&&(m.innerHTML="<p>Error loading file.</p>")}),c="editor"):o.content_type==="markdown"||o.content_type==="md"?(l='<div id="file-content" style="padding:10px;">Loading file...</div>',fetch(`./media/${o.name}`).then(d=>d.text()).then(d=>{const u=document.getElementById(o.id),m=u?u.querySelector(".p-2"):null;m&&(m.innerHTML=`<div class="letterpad_editor min-h-48 h-full w-full" data-letterpad-editor-id="${o.id}"></div>`),Q()}).catch(d=>{console.error("Error loading markdown file:",d);const u=document.getElementById(o.id),m=u?u.querySelector(".p-2"):null;m&&(m.innerHTML="<p>Error loading file.</p>")}),c="editor"):l=`<p style="padding:10px;">Content of ${o.name}</p>`;let f=null;t&&t.target&&(f=t.target.closest("#windows-container > div"));let p=se(o.name,l,!1,o.id,!1,!1,{type:"integer",width:420,height:350},c,f);if(o.content_type==="image"){let d=p.querySelector("img");d&&(d.onload=function(){let u=d.naturalWidth+20,m=d.naturalHeight+60;p.style.width=u+"px",p.style.height=m+"px",J[p.id].dimensions={type:"integer",width:u,height:m},Q()})}else if(o.content_type==="video"){let d=p.querySelector("video");d&&(d.onloadedmetadata=function(){let u=d.videoWidth+20,m=d.videoHeight+60;p.style.width=u+"px",p.style.height=m+"px",J[p.id].dimensions={type:"integer",width:u,height:m},Q()})}}finally{$n.delete(e)}}function Jt(e){if(!e)return;const t=e.getAttribute("data-url");t&&window.open(t,"_blank")}function Ir(e){if(!e||!window.watercolourImageSelectionCallback)return!1;if(!["png","jpg","jpeg","gif","webp","avif"].includes(e.content_type))return alert("Please select an image file (.png, .jpg, .jpeg, .gif, .webp)"),!1;let t=null;if(e.dataURL){t=e.dataURL;const n={name:e.name,path:Pn(),data:t,storageKey:e.storageLocation==="indexeddb"?`file_data_${e.id}`:null};return window.watercolourImageSelectionCallback(t,n),de("explorer-image-select"),window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null,!0}else{if(e.isLargeFile&&e.storageLocation==="indexeddb")return B.getItem(`file_data_${e.id}`).then(n=>{if(n){const o={name:e.name,path:Pn(),data:n,storageKey:`file_data_${e.id}`};window.watercolourImageSelectionCallback(n,o),de("explorer-image-select"),window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null}else alert("Could not load image data.")}).catch(n=>{console.error("Error loading image:",n),alert("Error loading image: "+n.message)}),!0;if(e.file&&e.file instanceof File){const n=new FileReader;return n.onload=o=>{const i={name:e.name,path:Pn(),data:o.target.result,storageKey:null};window.watercolourImageSelectionCallback(o.target.result,i),de("explorer-image-select"),window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null},n.readAsDataURL(e.file),!0}}return alert("Could not load the selected image."),!1}function Pn(){const e=document.querySelectorAll(".file-explorer-window");return e.length>0&&e[e.length-1].getAttribute("data-current-path")||"C://Documents"}async function bt(){try{const e=document.getElementById("explorer-window");if(e){const t=e.querySelector(".file-explorer-window");if(t){const o={currentPath:t.getAttribute("data-current-path")||"C://",timestamp:Date.now()};await B.setItem("fileExplorerState",o)}}}catch(e){console.warn("Failed to save file explorer state:",e);try{const t=document.getElementById("explorer-window");if(t){const n=t.querySelector(".file-explorer-window");if(n){const i={currentPath:n.getAttribute("data-current-path")||"C://",timestamp:Date.now()};B.setItemSync("fileExplorerState",i)}}}catch(t){console.error("Failed to save file explorer state with fallback:",t)}}}async function Lr(){try{const e=await B.getItem("fileExplorerState");if(e)return e}catch(e){console.warn("Failed to load file explorer state:",e);try{const t=B.getItemSync("fileExplorerState");if(t)return t}catch(t){console.warn("Failed to load file explorer state with fallback:",t)}}return{currentPath:"C://",timestamp:0}}function Mr(e){setTimeout(async()=>{await ti()},50)}async function ti(){const e=await Lr(),t=document.getElementById("explorer-window");if(t&&e.currentPath){const n=rt(e.currentPath),o=t.querySelector(".file-explorer-window");o?(o.outerHTML=n,setTimeout(()=>{Pe(),it()},100)):console.warn("‚ö†Ô∏è Could not find .file-explorer-window element")}else console.warn("‚ö†Ô∏è No explorer window found or no current path in state")}typeof window<"u"&&(window.initializeFileExplorerUI=Mr,window.restoreFileExplorerState=ti);function Ut(e){e.addEventListener("keydown",function(t){if(t.key==="ContextMenu"||t.shiftKey&&t.key==="F10"||t.ctrlKey&&t.key===" "){t.preventDefault();const n=e.getBoundingClientRect(),o=new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,clientX:n.left+n.width/2,clientY:n.top+n.height/2,button:2});e.dispatchEvent(o),setTimeout(()=>{const i=document.getElementById("context-menu");i&&!i.classList.contains("hidden")&&Ar(i)},10)}})}function Ar(e){if(!e)return;e.setAttribute("role","menu"),e.setAttribute("aria-label","Context menu");const t=Array.from(e.children).filter(n=>n.classList.contains("cursor-pointer")&&!n.classList.contains("text-gray-400"));t.forEach((n,o)=>{n.setAttribute("role","menuitem"),n.setAttribute("tabindex",o===0?"0":"-1"),n.addEventListener("keydown",function(r){(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),n.click())}),n.addEventListener("mouseenter",function(){t.forEach(r=>{r.classList.remove("bg-gray-50"),r.style.backgroundColor=""}),n.classList.add("bg-gray-50"),n.style.backgroundColor="#f9fafb"}),n.addEventListener("mouseleave",function(){document.activeElement!==n&&(n.classList.remove("bg-gray-50"),n.style.backgroundColor="")});const i=n.querySelector("div.absolute");i&&(n.setAttribute("aria-haspopup","true"),n.setAttribute("aria-expanded","false"),i.setAttribute("role","menu"),i.setAttribute("aria-label","Submenu"),Array.from(i.children).filter(a=>a.classList.contains("cursor-pointer")).forEach((a,s)=>{a.setAttribute("role","menuitem"),a.setAttribute("tabindex","-1"),a.addEventListener("keydown",function(l){(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),a.click())})}))}),t.length>0&&setTimeout(()=>{t[0].focus(),t[0].classList.add("bg-gray-50"),t[0].style.backgroundColor="#f9fafb"},50)}function Do(){document.addEventListener("keydown",function(r){const a=document.getElementById("context-menu");if(a&&!a.classList.contains("hidden")){e(r,a);return}const l=document.querySelector(".file-explorer-window:focus-within");if(l){const c=document.activeElement;switch(r.key){case"F2":r.preventDefault(),console.log("F2 - Rename functionality would trigger here");break;case"Delete":r.preventDefault(),console.log("Delete - Delete functionality would trigger here");break;case"Enter":r.preventDefault(),c&&c.classList.contains("file-item")&&c.dispatchEvent(new MouseEvent("dblclick",{bubbles:!0}));break;case"ArrowDown":case"ArrowUp":r.preventDefault(),o(r.key==="ArrowDown"?"down":"up",l);break}}});function e(r,a){const s=Array.from(a.children).filter(c=>!c.classList.contains("text-gray-400")&&c.classList.contains("cursor-pointer"));if(s.length===0)return;let l=-1;for(let c=0;c<s.length;c++)if(s[c].classList.contains("bg-gray-50")||s[c].matches(":focus")){l=c;break}switch(r.key){case"ArrowDown":r.preventDefault(),r.stopPropagation(),l=l===-1?0:(l+1)%s.length,t(s,l);break;case"ArrowUp":r.preventDefault(),r.stopPropagation(),l=l===-1?s.length-1:(l-1+s.length)%s.length,t(s,l);break;case"ArrowRight":if(r.preventDefault(),r.stopPropagation(),l>=0&&s[l]){const f=s[l].querySelector("div.absolute");if(f){f.classList.remove("hidden");const p=Array.from(f.children).filter(d=>d.classList.contains("cursor-pointer"));p.length>0&&n(p,0)}}break;case"ArrowLeft":r.preventDefault(),r.stopPropagation();const c=a.querySelector("div.absolute:not(.hidden)");c&&(c.classList.add("hidden"),l>=0&&s[l]&&t(s,l));break;case"Enter":case" ":r.preventDefault(),r.stopPropagation(),l>=0&&s[l]&&s[l].click();break;case"Escape":r.preventDefault(),r.stopPropagation(),typeof hideContextMenu=="function"?hideContextMenu():a.classList.add("hidden");break}}function t(r,a){r.forEach(s=>{s.classList.remove("bg-gray-50"),s.style.backgroundColor=""}),r[a]&&(r[a].classList.add("bg-gray-50"),r[a].style.backgroundColor="#f9fafb",r[a].focus())}function n(r,a){r.forEach(s=>{s.classList.remove("bg-gray-50"),s.style.backgroundColor=""}),r[a]&&(r[a].classList.add("bg-gray-50"),r[a].style.backgroundColor="#f9fafb",r[a].focus())}function o(r,a){const s=Array.from(a.querySelectorAll(".file-item, .folder-item")),l=document.activeElement;let c=s.indexOf(l);if(c===-1&&s.length>0){s[0].focus();return}let f;r==="down"?f=(c+1)%s.length:f=(c-1+s.length)%s.length,s[f]&&s[f].focus()}new MutationObserver(function(r){r.forEach(function(a){a.addedNodes.forEach(function(s){var l,c;if(s.nodeType===Node.ELEMENT_NODE){const f=(l=s.querySelectorAll)==null?void 0:l.call(s,".file-item, .folder-item, .draggable-icon");f==null||f.forEach(d=>{Ut(d),d.hasAttribute("tabindex")||d.setAttribute("tabindex","0")});const p=(c=s.querySelectorAll)==null?void 0:c.call(s,".file-explorer-window");p==null||p.forEach(d=>{Ut(d),d.hasAttribute("tabindex")||d.setAttribute("tabindex","0")})}})})}).observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll(".file-item, .folder-item, .draggable-icon").forEach(r=>{Ut(r),r.hasAttribute("tabindex")||r.setAttribute("tabindex","0")}),document.querySelectorAll(".file-explorer-window").forEach(r=>{Ut(r),r.hasAttribute("tabindex")||r.setAttribute("tabindex","0")})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Do):Do();function Ze(e,t=null){let n;typeof e!="string"?n=e:n=document.getElementById(e),n.classList.toggle("bg-gray-50"),n.classList.toggle("bg-gray-200"),n.classList.toggle("border-gray-300"),n.classList.toggle("border-black");const o=n.querySelector("span");o.classList.toggle("border-gray-300"),o.classList.toggle("border-black");const i=n.querySelector("img");i&&(i.classList.toggle("border-gray-300"),i.classList.toggle("border-black")),t&&(o.innerHTML=t)}function Dr(e){if(!e)return!0;try{return new URL(e,location.href).origin===location.origin}catch{return!1}}function ni(){document.getElementById("error-overlay").classList.remove("hidden"),document.getElementById("error-overlay").style.zIndex="9999";function e(t){location.reload()}document.addEventListener("keydown",e,{once:!0})}window.onerror=function(e,t,n,o,i){Dr(t)&&ni()};window.addEventListener("unhandledrejection",function(e){ni()});function Br(e){if(window.watercolourImageSelectionCallback=e,window.watercolourSelectedFile=null,typeof getExplorerWindowContent=="function"&&typeof createWindow=="function"){const n=getExplorerWindowContent("C://Documents").replace(/<div id="file-sidebar"[\s\S]*?<\/ul><\/div>/g,"").replace(/<div id="breadcrumbs"[\s\S]*?<\/div>/g,""),o=createWindow("Select Image - File Explorer",n,!0,"explorer-image-select",!1,!1,{type:"integer",width:600,height:550},"file-explorer");bringToFront(o),setTimeout(()=>{if(o){const i=o.querySelector(".file-explorer-window");i?i.setAttribute("data-image-selection-mode","true"):console.error("Could not find .file-explorer-window div!");const r=o.querySelector(".p-2");if(r){const a=document.createElement("div");a.className="bg-blue-100 border border-blue-300 text-blue-800 px-3 py-2 rounded mb-3 text-sm",a.innerHTML='<strong>Select an image:</strong> Click any image file (.png, .jpg, .jpeg, .gif, .webp) to select it, then click "Open Selected Image".',r.insertBefore(a,r.firstChild);const s=document.createElement("div");s.className="-mt-2 p-3 bg-gray-50 border-t border-gray-200 flex items-center justify-between",s.id="watercolour-selection-ui";const l=document.createElement("div");l.className="flex gap-2";const c=fe("Cancel");c.id="cancel-selection";const f=fe("Open");f.id="open-selected-image",f.disabled=!0,f.style.opacity="0.5",f.style.cursor="not-allowed",l.appendChild(c),l.appendChild(f),s.innerHTML=`
            <div>
              <span id="selected-image-name" class="text-sm text-gray-600">No image selected</span>
            </div>
          `,s.appendChild(l),r.appendChild(s),c.addEventListener("click",()=>{window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null,closeWindow("explorer-image-select")}),f.addEventListener("click",()=>{const p=window.watercolourSelectedFile;p&&window.watercolourImageSelectionCallback&&!f.disabled&&handleWatercolourImageSelection(p)}),window.updateWatercolourImageSelectionButton=function(p){p?(f.disabled=!1,f.style.opacity="1",f.style.cursor="pointer"):(f.disabled=!0,f.style.opacity="0.5",f.style.cursor="not-allowed")}}}else console.error("Explorer window not found!")},100)}else showDialogBox("File explorer functionality not available.","error")}function fe(e){const t=document.createElement("button");t.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2";const n=document.createElement("span");return n.className="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3",n.textContent=e,t.appendChild(n),t.setAttribute("aria-label",e),t.setAttribute("title",e),t}function eo(e,t="",n=null,o=null){return showDialogBox(e,"prompt",n,o,{defaultValue:t})}const oi=Object.freeze(Object.defineProperty({__proto__:null,makeWin95Button:fe,makeWin95Prompt:eo,openFileExplorerForImageSelection:Br,toggleButtonActiveState:Ze},Symbol.toStringTag,{value:"Module"}));function ii(){const e=document.getElementById("compost-bin");if(e){Ce(e);return}const n=se("Compost Bin","",!1,"compost-bin",!1,!1,{type:"integer",width:600,height:400},"App",null,"gray").querySelector(".p-2");n.className="p-2 bg-gray-100 h-full flex flex-col";const o=document.createElement("div");o.className="h-full flex flex-col";const i=document.createElement("div");i.className="bg-gray-200 border-b border-gray-400 p-2 flex justify-between items-center";const r=document.createElement("div");r.className="text-sm";const l=(le().folders["C://Desktop"]||{}).compostbin,c=Object.keys((l==null?void 0:l.contents)||{}).length;r.textContent=`Compost Bin - ${c} item(s)`;const f=document.createElement("div");f.className="flex space-x-2";const p=document.createElement("button");p.className="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs",p.textContent="Empty Bin",p.setAttribute("aria-label","Empty all items from compost bin"),p.setAttribute("title","Permanently delete all items in the compost bin"),p.addEventListener("click",ri),f.appendChild(p),i.appendChild(r),i.appendChild(f);const d=document.createElement("div");d.className="flex-1 bg-white border border-gray-400 p-2 overflow-auto",d.id="compost-bin-content",yn(d),o.appendChild(i),o.appendChild(d),n.appendChild(o)}function yn(e){const o=(le().folders["C://Desktop"]||{}).compostbin,i=(o==null?void 0:o.contents)||{};if(e.innerHTML="",Object.keys(i).length===0){const a=document.createElement("div");a.className="text-center text-gray-500 mt-8",a.textContent="The Compost Bin is empty",e.appendChild(a);return}const r=document.createElement("div");r.className="grid grid-cols-6 gap-4 p-2",Object.values(i).forEach(a=>{const s=Tr(a);r.appendChild(s)}),e.appendChild(r)}function Tr(e){const t=document.createElement("div");t.className="flex flex-col items-center p-2 hover:bg-blue-100 cursor-pointer",t.draggable=!0,t.setAttribute("data-item-id",e.id);const n=document.createElement("img");n.className="w-8 h-8 mb-1",n.src=e.icon||Fr(e.type),n.alt=e.name;const o=document.createElement("div");return o.className="text-xs text-center text-gray-700 break-words max-w-16",o.textContent=e.name,t.appendChild(n),t.appendChild(o),t.addEventListener("dragstart",i=>{i.dataTransfer.setData("text/plain",e.id),i.dataTransfer.setData("application/x-compost-item","true"),i.dataTransfer.effectAllowed="move"}),t}async function to(e,t){const n=le();if(e==="compostbin"){re("Cannot move the Compost Bin to itself!","error");return}let o=null,i=null;if(t==="C://Desktop"?i=n.folders["C://Desktop"]||{}:i=n.folders[t]||{},i&&i[e]){o=i[e];const a=(n.folders["C://Desktop"]||{}).compostbin;if(!a){console.error("Compost bin not found in unified structure"),re("Compost Bin not found!","error");return}if(a.contents||(a.contents={}),o.originalPath=t,a.contents[e]=o,delete i[e],t==="C://Desktop"){const l="icon-"+e;me[l]&&delete me[l]}await ke(n),Q(),it(),ye();const s=document.getElementById("compost-bin");if(s){const l=s.querySelector("#compost-bin-content");l&&(yn(l),ai(s))}}}function ri(){const e=le(),n=(e.folders["C://Desktop"]||{}).compostbin;if(!n){re("Compost Bin not found!","error");return}const o=Object.keys(n.contents||{}).length;if(o===0){re("The Compost Bin is already empty.","info");return}const i=`window-${Date.now()}`,r=se("Empty Compost Bin","",!1,i,!1,!1,{type:"integer",width:320,height:140},"Default"),a=r.querySelector(".p-2");a.classList.add("p-4","flex","flex-col","justify-between","h-full");const s=document.createElement("p");s.textContent=`Are you sure you want to permanently delete all ${o} item(s) in the Compost Bin?`,a.appendChild(s);const l=document.createElement("div");l.className="flex justify-end space-x-2",a.appendChild(l);const c=document.createElement("button");c.className="px-4 py-2 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200",c.textContent="Cancel",c.setAttribute("aria-label","Cancel empty bin operation"),c.setAttribute("title","Cancel and keep items in compost bin");const f=document.createElement("button");f.className="px-4 py-2 bg-red-500 border-2 border-red-600 hover:bg-red-400 text-white",f.textContent="Empty Bin",f.setAttribute("aria-label","Confirm empty bin operation"),f.setAttribute("title","Permanently delete all items in compost bin"),l.append(c,f),c.addEventListener("click",()=>de(i)),f.addEventListener("click",async()=>{const p=Object.keys(n.contents||{});n.contents={},p.forEach(u=>{const m="icon-"+u;me[m]&&delete me[m]}),await ke(e),Q();const d=document.getElementById("compost-bin");if(d){const u=d.querySelector("#compost-bin-content");u&&(yn(u),ai(d))}de(i),re(`${o} item(s) permanently deleted from Compost Bin`,"info")}),Ce(r)}function ai(e){const t=e.querySelector(".bg-gray-200");if(t){const n=t.querySelector(".text-sm");if(n){const r=(le().folders["C://Desktop"]||{}).compostbin,a=Object.keys((r==null?void 0:r.contents)||{}).length;n.textContent=`Compost Bin - ${a} item(s)`}}}function Fr(e){switch(e){case"folder":return"./image/folder.webp";case"ugc-file":return"./image/doc.webp";case"app":return"./image/computer.webp";default:return"./image/file.webp"}}function si(){try{new Audio("audio/youve_got_mail.mp3").play().catch(o=>console.log("Audio playback prevented:",o))}catch(n){console.log("Could not play audio:",n)}if(window.location.href.includes("reddit.com")){if(document.getElementById("mailbox-error"))return;se("‚ö†Ô∏è Error",'<div class="text-center p-4"><p class="mb-4">Mail Box is not available in Reddit context.</p><button id="error-ok-btn" class="bg-gray-200 border-t-2 border-l-2 border-gray-300 h-8" aria-label="Close error dialog" title="Close this error message"><span class="border-b-2 border-r-2 border-black block h-full w-full py-1 px-3 leading-6">OK</span></button></div>',!1,"mailbox-error",!1,!1,{type:"integer",width:300,height:150},"Default"),setTimeout(()=>{const n=document.getElementById("error-ok-btn");n&&n.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),de("mailbox-error")})},100);return}const t=se("Mail Box","",!1,"mailbox",!1,!1,{type:"integer",width:600,height:400},"App",null,"white");qn(t)}function qn(e){if(!e)return;const t=e.querySelector(".p-2");if(!t)return;t.innerHTML="",t.classList.add("flex","flex-col","h-full");const n=document.createElement("div");n.className="flex-1 flex overflow-hidden",t.appendChild(n);const o=document.createElement("div");o.id="mailbox-list",o.className="w-1/3 border-r border-gray-300 flex flex-col overflow-y-auto",n.appendChild(o);const i=document.createElement("button");i.id="compose-btn",i.className="p-2 border-b border-gray-300 text-blue-500 hover:bg-gray-100",i.textContent="Compose",i.setAttribute("aria-label","Compose new email"),i.setAttribute("title","Create and send a new email message"),o.appendChild(i);const r=document.createElement("div");r.id="mailbox-detail",r.className="flex-1 p-2 overflow-y-auto",n.appendChild(r);const a=document.createElement("div");a.id="placeholder",a.className="text-gray-500",a.textContent="Select a message to view",r.appendChild(a);function s(d){let u="",m="";try{const g=new URL(d,window.location.origin),x=g.searchParams.get("response-content-disposition");if(x){const I=x.match(/filename\\*?=(?:UTF-8'')?("?)([^";]+)\\1/i);I&&I[2]&&(u=decodeURIComponent(I[2]))}u||(u=g.pathname.split("/").pop());const b=g.searchParams.get("response-content-type");b&&(m=b.split("/").pop()),!m&&u&&u.includes(".")&&(m=u.split(".").pop())}catch{const b=d.split("/").pop().split("?")[0];u=b,b.includes(".")&&(m=b.split(".").pop())}return{name:u||"attachment",ext:(m||"").toLowerCase()}}function l(d){return d.map(u=>{const m={};return["file_1","file_2","file_3"].forEach(g=>{if(u[g]){const x=u[g],b=s(x);m[g]={name:b.name,url:x,ext:b.ext}}}),{id:u.id,email:u.email||u.name||"Unknown",title:u.subject||"No Subject",mail:u.message||"",phone:u.phone||"",company:u.company||"",timestamp:u.created_at||null,public:!1,files:m}})}function c(){try{for(;o.children.length>1;)o.removeChild(o.lastChild);fetch(`${Wt}${Zo}`).then(d=>{if(!d.ok)throw new Error("Failed to fetch submissions");return d.json()}).then(d=>{l(d.data).forEach(m=>{const g=document.createElement("div");g.className="p-2 border-b border-gray-300 hover:bg-gray-200 cursor-pointer truncate",g.textContent=m.title||m.email,g.addEventListener("click",()=>f(m)),o.appendChild(g)})}).catch(d=>{console.error("Error loading messages:",d);const u=document.createElement("div");u.className="p-2 text-red-500 text-sm",u.textContent="Failed to load messages",o.appendChild(u)})}catch(d){console.error("Error loading messages:",d)}}function f(d){for(;r.firstChild;)r.removeChild(r.firstChild);const u=document.createElement("div");u.className="mb-4 border-b border-gray-200 pb-2";const m=(x,b)=>{const I=document.createElement("div");I.className="mb-1";const h=document.createElement("strong");return h.textContent=x+": ",I.append(h,document.createTextNode(b||"")),I};u.appendChild(m("From",d.email)),u.appendChild(m("Title",d.title||"(No Title)")),d.phone&&u.appendChild(m("Phone",d.phone)),d.company&&u.appendChild(m("Company",d.company)),d.timestamp&&u.appendChild(m("Date",new Date(d.timestamp).toLocaleString()));const g=document.createElement("div");if(g.className="mb-2 whitespace-pre-wrap font-sans",g.textContent=d.mail,r.append(u,g),d.files&&Object.keys(d.files).length){const x=document.createElement("div");x.className="mt-4 border-t border-gray-200 pt-2";const b=document.createElement("strong");b.textContent="Attachments:",x.appendChild(b);const I=document.createElement("div");I.className="flex flex-col gap-2 mt-2",Object.values(d.files).forEach(h=>{const H=h.url||h.contents;if(!H)return;const O=document.createElement("div");O.className="border p-2 rounded bg-gray-50";let j=h.ext;if(j||(j=H.split(".").pop().toLowerCase().split("?")[0]),["jpg","jpeg","png","gif","webp","svg"].includes(j)){const F=document.createElement("img");F.src=H,F.alt=h.name,F.className="max-w-full h-auto max-h-96 object-contain block mb-1",O.appendChild(F)}else if(["mp3","wav","ogg"].includes(j)){const F=document.createElement("audio");F.controls=!0,F.src=H,F.className="w-full mb-1",O.appendChild(F)}else if(["mp4","webm"].includes(j)){const F=document.createElement("video");F.controls=!0,F.src=H,F.className="max-w-full h-auto max-h-96 mb-1",O.appendChild(F)}const $=document.createElement("a");$.href=H,$.className="text-blue-500 hover:underline text-sm break-all",$.textContent=h.name,$.target="_blank",O.appendChild($),I.appendChild(O)}),x.appendChild(I),r.appendChild(x)}}function p(){const u=se("New Mail","",!1,"compose-mail",!1,!1,{type:"integer",width:400,height:600},"App",null,"white").querySelector(".p-2");u.classList.add("p-4");const m=document.createElement("form");m.id="compose-form",m.className="flex flex-col space-y-4",u.appendChild(m);const g=(L,A)=>{const M=document.createElement("div"),S=document.createElement("label");return S.className="block text-sm font-medium text-gray-700",S.textContent=L,M.append(S,A),M},x=document.createElement("input");x.type="email",x.name="from",x.required=!0,x.id="from-email",x.setAttribute("aria-label","Your email address"),x.setAttribute("aria-describedby","from-help"),x.className="mt-1 block w-full border border-gray-300 rounded p-2",m.appendChild(g("Your Email",x));const b=document.createElement("input");b.type="text",b.name="to",b.value="Nostalgia OS Team",b.readOnly=!0,b.id="to-email",b.setAttribute("aria-label","Recipient"),b.className="mt-1 block w-full border border-gray-300 rounded p-2 bg-gray-100",m.appendChild(g("To",b));const I=document.createElement("input");I.type="text",I.name="subject",I.id="email-subject",I.setAttribute("aria-label","Email subject line (optional)"),I.className="mt-1 block w-full border border-gray-300 rounded p-2",m.appendChild(g("Mail Title (optional)",I));const h=document.createElement("textarea");h.name="message",h.required=!0,h.id="email-message",h.setAttribute("aria-label","Email message content"),h.className="mt-1 block w-full border border-gray-300 rounded p-2",m.appendChild(g("Your Mail",h));const H=document.createElement("input");H.type="tel",H.name="phone",H.id="phone-number",H.setAttribute("aria-label","Phone number (optional)"),H.className="mt-1 block w-full border border-gray-300 rounded p-2",m.appendChild(g("Phone (optional)",H));const O=document.createElement("input");O.type="text",O.name="company",O.id="company-name",O.setAttribute("aria-label","Company name (optional)"),O.className="mt-1 block w-full border border-gray-300 rounded p-2",m.appendChild(g("Company (optional)",O));const j=document.createElement("div");j.className="border-t border-gray-200 pt-2 mt-2",m.appendChild(j);const $=document.createElement("label");$.className="block text-sm font-medium text-gray-700 mb-1",$.textContent="Attachments (max 3)",j.appendChild($);const F=document.createElement("input");F.type="file",F.name="file1",F.className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-2",j.appendChild(F);const N=document.createElement("input");N.type="file",N.name="file2",N.className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-2",j.appendChild(N);const _=document.createElement("input");_.type="file",_.name="file3",_.className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100",j.appendChild(_);const V=document.createElement("div");V.className="flex justify-end space-x-2",m.appendChild(V);const Z=document.createElement("button");Z.type="button",Z.id="cancel-compose",Z.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2",Z.innerHTML='<span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Cancel</span>',Z.setAttribute("aria-label","Cancel mail composition"),Z.setAttribute("title","Cancel and discard mail"),V.appendChild(Z);const k=document.createElement("button");k.type="submit",k.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2",k.innerHTML='<span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Submit</span>',k.setAttribute("aria-label","Submit mail"),k.setAttribute("title","Submit your mail"),V.appendChild(k),m.addEventListener("submit",async L=>{L.preventDefault();const A=k.innerHTML;k.disabled=!0,k.innerHTML='<span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Sending...</span>';const M=new FormData(m),S=new FormData,T=M.get("subject")||"No Subject";S.append("creator_model[title]",`Contact: ${T}`),S.append("creator_model[feed_slug]","suggestions"),S.append("creator_model[model_type]","page");const X=(ee,oe,te,ie=!1)=>{const we=`creator_model[creator_fields_attributes][${ee}]`;S.append(`${we}[html_input_label]`,oe),ie?te instanceof File&&te.size>0&&S.append(`${we}[file]`,te):S.append(`${we}[string_content]`,te||"")};X(0,"name",M.get("from")),X(1,"email",M.get("from")),X(2,"phone",M.get("phone")),X(3,"company",M.get("company")),X(4,"subject",T),X(5,"message",M.get("message")),X(6,"file_1",M.get("file1"),!0),X(7,"file_2",M.get("file2"),!0),X(8,"file_3",M.get("file3"),!0);try{if((await fetch(`${Wt}${wr}`,{method:"POST",body:S})).ok)showDialogBox("Mail submitted successfully!","success"),c(),de("compose-mail");else throw new Error("Failed to submit form")}catch(ee){console.error(ee),showDialogBox("Error submitting mail.","error"),k.disabled=!1,k.innerHTML=A}}),Z.addEventListener("click",()=>de("compose-mail"))}i.addEventListener("click",p),c()}let Yt=null;function $r(){return Yt||(Yt=new Promise(e=>{if(window.YT&&window.YT.Player){e();return}const t=document.createElement("script");t.src="https://www.youtube.com/iframe_api";const n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n),window.onYouTubeIframeAPIReady=()=>{e()}}),Yt)}async function li(){const e=se("TubeStream",'<div class="p-2 h-full flex items-center justify-center">Loading...</div>',!1,"tubestream",!1,!1,{type:"integer",width:580,height:380},"default",null,"white");await _n(e)}async function _n(e){if(!e)return;const t=e.querySelector(".p-2");if(!t)return;if(!await zr()){t.innerHTML=`<div style="display: flex; justify-content: center; align-items: center; height: 100%; flex-direction: column; text-align: center; padding: 20px; font-family: 'MS Sans Serif', sans-serif;">
      <p>Unable to connect to YouTube.</p>
      <p>You might be offline or there is a network error.</p>
    </div>`;return}let o=[];try{const i=await fetch(`${Wt}${Jo}`);if(!i.ok)throw new Error("Network response was not ok");o=(await i.json()).data}catch(i){console.warn("Error fetching playlist, using fallback:",i),o=Wr.data}if(Array.isArray(o)&&(o=o.filter(i=>!i||typeof i!="object"||Object.keys(i).length===0?!1:i.type==="single"||i.type==="livestream"?!!(i.video_id||i.beginning_video_id):!!i.playlist_id)),!o||o.length===0){t.innerHTML='<div class="p-4 text-center">No content available.</div>';return}e.tubeStreamState={playlistData:o,currentIndex:0,player:null},await $r(),t.innerHTML="",t.style.padding="0",t.style.height="100%",t.style.overflow="hidden",ci(e)}function ci(e){const t=e.tubeStreamState;if(!t||!t.playlistData)return;const n=e.querySelector(".p-2");if(!n)return;if(t.player){try{typeof t.player.destroy=="function"&&t.player.destroy()}catch(f){console.warn("Error destroying player:",f)}t.player=null}n.innerHTML="";const o=`player-${Date.now()}-${Math.floor(Math.random()*1e3)}`;t.playerDivId=o;const i=document.createElement("div");i.id=o,n.appendChild(i);const r=t.playlistData[t.currentIndex];if(!r){console.warn("No data for current index",t.currentIndex);return}let a={autoplay:1,controls:1,rel:0,fs:1,enablejsapi:1};if(r.custom_parameters){const f=new URLSearchParams(r.custom_parameters.replace(/&amp;/g,"&"));for(const[p,d]of f)p!=="loop"&&(a[p]=d==="true"?1:d==="false"?0:d)}let s=null,l=null;r.type==="single"||r.type==="livestream"?s=r.video_id||r.beginning_video_id:(s=r.beginning_video_id,l=r.playlist_id);const c={height:"100%",width:"100%",playerVars:a,events:{onStateChange:f=>Pr(f,e)}};l?(c.playerVars.listType="playlist",c.playerVars.list=l,s&&(c.videoId=s)):c.videoId=s,t.player=new YT.Player(o,c)}function Pr(e,t){if(e.data===YT.PlayerState.ENDED){const n=t.tubeStreamState;if(!n)return;if(n.playlistData[n.currentIndex].type==="playlist"){const i=n.player;if(i&&typeof i.getPlaylist=="function"){const r=i.getPlaylist(),a=i.getPlaylistIndex();(!r||r.length===0||a===r.length-1)&&setTimeout(()=>zn(t),200)}else setTimeout(()=>zn(t),200)}else setTimeout(()=>zn(t),200)}}function zn(e){const t=e.tubeStreamState;t&&(t.currentIndex++,t.currentIndex>=t.playlistData.length&&(t.currentIndex=0),ci(e))}function zr(){return new Promise(e=>{const t=new Image;t.onload=()=>e(!0),t.onerror=()=>e(!1),t.src="https://img.youtube.com/vi/qhCsL1cx4Qc/default.jpg?"+new Date().getTime()})}const Wr={data:[{slug:"111",type:"playlist",playlist_id:"PLfznZzH31A46XXPSw2dcb-gqhMXcBMOHV",beginning_video_id:"qhCsL1cx4Qc",custom_parameters:"autoplay=true&loop=false"}]};async function di(){const e=document.getElementById("watercolour");if(e){const i=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,a)=>getComputedStyle(a).zIndex>getComputedStyle(r).zIndex?a:r);e.style.zIndex=`${parseInt(i.style.zIndex)+1}`;return}const t=pi();se("Watercolour",t,!1,"watercolour",!1,!1,{type:"integer",width:700,height:440},"app",null,"white").setAttribute("data-disable-desktop-pan","true"),ui()}async function ui(e){await fi()}function pi(){return`
<div id="watercolour-container" style="background-color: #f3f4f6; position: relative; height: calc(100% - 0.25rem); margin-top: -0.5rem; margin: 0; padding: 0;">
  <!-- Top Menu Bar -->
  <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background-color: white; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); border-bottom: 1px solid #e5e7eb;">
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <!-- File Dropdown Menu -->
      <div style="position: relative;">
        <button id="fileMenuBtn" style="padding: 0.25rem 0.75rem; border-radius: 0.25rem; border: 1px solid #d1d5db; background-color: white; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'" onclick="toggleFileDropdown(event)">
          File
          <svg style="width: 0.75rem; height: 0.75rem; pointer-events: none;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div id="fileDropdown" style="position: absolute; left: 0; top: 100%; margin-top: 0.25rem; width: 10rem; background-color: white; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 50; display: none;">
          <button id="loadBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; border-bottom: 1px solid #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">Open...</button>
          <button id="newBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; border-bottom: 1px solid #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">New</button>
          <button id="saveAsBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; border-bottom: 1px solid #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">Save</button>
          <button id="exportBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">Export...</button>
        </div>
      </div>

      <button id="undoBtn" style="padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #d1d5db; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">
        <svg style="height: 1rem; width: 1rem; display: inline;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
          <path style="opacity: 0.4;" d="M97.6 97.6c87.5-87.5 229.3-87.5 316.8 0C458.1 141.3 480 198.7 480 256s-21.9 114.7-65.6 158.4c-87.5 87.5-229.3 87.5-316.8 0l45.3-45.3c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L97.6 97.6z" />
          <path d="M176 224l24-24L40 40 16 64l0 160H176z" />
        </svg>
        <span class="undo-redo-text">Undo</span>
      </button>
      <button id="redoBtn" style="padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #d1d5db; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">
        <svg style="height: 1rem; width: 1rem; display: inline;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
          <path style="opacity: 0.4;" d="M32 256c0 57.3 21.9 114.7 65.6 158.4c87.5 87.5 229.3 87.5 316.8 0l-45.3-45.3c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3s163.8-62.5 226.3 0c15.1-15.1 30.2-30.2 45.3-45.3c-87.5-87.5-229.3-87.5-316.8 0C53.9 141.3 32 198.7 32 256z" />
          <path d="M336 224l-24-24L472 40l24 24 0 160H336z" />
        </svg>
        <span class="undo-redo-text">Redo</span>
      </button>
    </div>
    <div id="status" style="font-size: 0.75rem; color: #6b7280;">
      Tool: Brush | x: 0, y: 0
    </div>
  </div>

  <!-- Main Content Area -->
  <div id="watercolour-main-content" style="display: flex; flex-direction: column;">
    <div id="watercolour-workspace" style="display: flex; flex: 1;">
    <!-- Left Toolbar -->
    <div style="width: 3rem; padding: 0.5rem; background-color: white; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; gap: 0.5rem;">
      <button data-tool="brush" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='#f3f4f6'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/brush.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Brush</span>
      </button>
      <button data-tool="line" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/line.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Line</span>
      </button>
      <button data-tool="rectangle" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/rectangle.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Rectangle</span>
      </button>
      <button data-tool="ellipse" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/ellipse.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Ellipse</span>
      </button>
      <button data-tool="eraser" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/eraser.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Eraser</span>
      </button>
      <button data-tool="fill" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/fill.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Fill</span>
      </button>
      <button data-tool="picker" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/picker.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Picker</span>
      </button>
    </div>

    <!-- Canvas Container -->
    <div style="flex: 1; position: relative;">
      <canvas id="watercolourCanvas" width="420" height="300" style="background: white; margin: 0.5rem; margin-bottom: 2rem; position: absolute; inset: 0; border: 1px solid #d1d5db;"></canvas>
    </div>

    <!-- Right Panel: Color Palette & Stroke Size (Desktop) -->
    <div id="watercolour-color-panel" class="watercolour-color-panel-desktop" style="width: 8rem; padding: 0.5rem; background-color: white; border-left: 1px solid #e5e7eb; display: flex; flex-direction: column; gap: 1rem;">
      <!-- Color Palette -->
      <div style="display: flex; flex-direction: column; gap: 0.5rem;">
        <div id="watercolour-color-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.25rem;">
          <!-- 16 predefined colors -->
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #000000;" data-color="#000000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #808080;" data-color="#808080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #800000;" data-color="#800000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FF0000;" data-color="#FF0000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #808000;" data-color="#808000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FFFF00;" data-color="#FFFF00"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #008000;" data-color="#008000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #00FF00;" data-color="#00FF00"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #008080;" data-color="#008080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #00FFFF;" data-color="#00FFFF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #000080;" data-color="#000080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #0000FF;" data-color="#0000FF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #800080;" data-color="#800080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FF00FF;" data-color="#FF00FF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FFFFFF;" data-color="#FFFFFF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #C0C0C0;" data-color="#C0C0C0"></div>
        </div>
        <input id="colorPicker" type="color" style="width: 100%;" />
      </div>
      <!-- Stroke Size -->
      <div>
        <label for="strokeSize" style="font-size: 0.875rem;">Size</label>
        <input id="strokeSize" type="range" min="1" max="50" value="5" style="width: 100%;" aria-label="Brush stroke size" title="Adjust brush stroke size" />
      </div>
    </div>
    </div>

    <!-- Bottom Panel: Color Palette & Stroke Size (Mobile) -->
    <div id="watercolour-color-panel-mobile" class="watercolour-color-panel-mobile" style="display: none; width: 100%; padding: 0.5rem; background-color: white; border-top: 1px solid #e5e7eb;">
      <div style="display: flex; gap: 1rem; align-items: center; justify-content: space-around;">
        <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 0.25rem; flex-shrink: 0;">
          <!-- 16 predefined colors -->
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #000000;" data-color="#000000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #808080;" data-color="#808080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #800000;" data-color="#800000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FF0000;" data-color="#FF0000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #808000;" data-color="#808000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FFFF00;" data-color="#FFFF00"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #008000;" data-color="#008000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #00FF00;" data-color="#00FF00"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #008080;" data-color="#008080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #00FFFF;" data-color="#00FFFF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #000080;" data-color="#000080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #0000FF;" data-color="#0000FF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #800080;" data-color="#800080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FF00FF;" data-color="#FF00FF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FFFFFF;" data-color="#FFFFFF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #C0C0C0;" data-color="#C0C0C0"></div>
        </div>
        <input id="colorPickerMobile" type="color" style="width: 3rem; height: 3rem; border: 1px solid #d1d5db; cursor: pointer;" />
        <div style="display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0;">
          <label for="strokeSizeMobile" style="font-size: 0.875rem; white-space: nowrap;">Size</label>
          <input id="strokeSizeMobile" type="range" min="1" max="50" value="5" style="min-width: 80px;" aria-label="Brush stroke size" title="Adjust brush stroke size" />
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden text input for Text Tool -->
  <input type="text" id="textInput" style="position: absolute; border: 1px solid #9ca3af; padding: 0.25rem; display: none; font-size: 16px; line-height: 1; color: #000;" />
</div>
`}async function fi(){window.toggleFileDropdown=function(y){y.stopPropagation();const w=document.getElementById("fileDropdown");w&&(w.style.display=w.style.display==="none"?"block":"none")},document.addEventListener("click",function(y){const w=document.getElementById("fileDropdown"),v=document.getElementById("fileMenuBtn");w&&v&&!v.contains(y.target)&&!w.contains(y.target)&&(w.style.display="none")});const e=document.getElementById("watercolourCanvas"),t=e.getContext("2d",{willReadFrequently:!0});let n=null,o=!1,i="brush",r,a,s="#000000",l=5,c=null,f=null,p=null;const d=document.getElementById("textInput"),u=document.getElementById("strokeSize"),m=document.getElementById("strokeSizeMobile"),g=document.getElementById("colorPicker"),x=document.getElementById("colorPickerMobile");let b=[],I=[];const h=y=>{l=y,t.lineWidth=l,u&&(u.value=y),m&&(m.value=y),i==="text"&&d.style.display==="block"&&(d.style.fontSize=`${l*4}px`),Ee().catch(console.error)};u&&u.addEventListener("input",y=>h(y.target.value)),m&&m.addEventListener("input",y=>h(y.target.value));const H=y=>{s=y,t.strokeStyle=s,t.fillStyle=s,g&&(g.value=y),x&&(x.value=y),i==="text"&&d.style.display==="block"&&(d.style.color=s),Ee().catch(console.error)};g&&g.addEventListener("change",y=>H(y.target.value)),x&&x.addEventListener("change",y=>H(y.target.value)),window.addEventListener("resize",k),document.body.addEventListener("touchmove",y=>{o&&y.preventDefault()},{passive:!1}),document.addEventListener("wheel",y=>{o&&y.preventDefault()},{passive:!1}),document.querySelectorAll(".tool-btn").forEach(y=>{y.addEventListener("click",()=>{document.querySelectorAll(".tool-btn").forEach(w=>w.classList.remove("bg-gray-100")),y.classList.add("bg-gray-100"),i=y.getAttribute("data-tool"),e.style.cursor=`url("./image/watercolour-icons/resized_${i}.png"), auto`,Ee().catch(console.error)})}),document.querySelectorAll("[data-color]").forEach(y=>{y.addEventListener("click",()=>{H(y.getAttribute("data-color"))})});let O=0;const j=3;function $(){if(O++,O>j){F();return}const y=document.getElementById("fileMenuBtn"),w=document.getElementById("fileDropdown"),v=document.getElementById("saveAsBtn");if(y&&w&&v){N();return}setTimeout($,200)}function F(){const y=document.getElementById("loadBtn"),w=document.getElementById("newBtn"),v=document.getElementById("exportBtn");if(!y||!w||!v){console.error("Could not find expected buttons");return}y.addEventListener("click",()=>{te()}),w.addEventListener("click",()=>{showDialogBox("Clear canvas? Unsaved work will be lost.","confirmation",()=>{const E=e.offsetWidth,z=e.offsetHeight;t.clearRect(0,0,E,z),t.fillStyle="white",t.fillRect(0,0,E,z),c=e.toDataURL(),_(),p=null})}),v.addEventListener("click",()=>{const E=document.createElement("a");E.download="drawing.png",E.href=e.toDataURL(),E.click()})}function N(){const y=document.getElementById("fileMenuBtn"),w=document.getElementById("fileDropdown"),v=document.getElementById("saveAsBtn"),E=document.getElementById("loadBtn"),z=document.getElementById("newBtn"),C=document.getElementById("exportBtn");y.addEventListener("click",U=>{U.stopPropagation(),w.classList.toggle("hidden")}),document.addEventListener("click",U=>{!y.contains(U.target)&&!w.contains(U.target)&&w.classList.add("hidden")}),w.addEventListener("click",()=>{w.classList.add("hidden")}),v.addEventListener("click",async()=>{await oe()}),E.addEventListener("click",()=>{te()}),z.addEventListener("click",()=>{showDialogBox("Clear canvas? Unsaved work will be lost.","confirmation",()=>{const U=e.offsetWidth,Y=e.offsetHeight;t.clearRect(0,0,U,Y),t.fillStyle="white",t.fillRect(0,0,U,Y),c=e.toDataURL(),_()})}),C.addEventListener("click",()=>{const U=document.createElement("a");U.download="drawing.png",U.href=e.toDataURL(),U.click()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",$):$(),e.addEventListener("pointerdown",y=>{y.preventDefault();const w=Z(y);if(r=w.x,a=w.y,i==="fill"){_(),S(w.x,w.y,s),c=e.toDataURL(),_();return}if(o=!0,i==="brush"||i==="eraser")t.beginPath(),t.moveTo(r,a);else if(["line","rectangle","ellipse"].includes(i))f=document.createElement("canvas"),f.width=e.width,f.height=e.height,f.getContext("2d").drawImage(e,0,0);else if(i==="text"){const v=Z(y);if(d.style.display==="block"){A();return}const E=e.getBoundingClientRect();d.style.left=E.left+v.x+"px",d.style.top=E.top+v.y+"px",d.style.display="block",d.style.fontSize=`${l*4}px`,d.style.color=s,d.dataset.x=v.x,d.dataset.y=v.y,setTimeout(()=>{d.focus(),d.onblur=A},0),d.onkeydown=z=>{z.key==="Enter"&&A()}}}),e.addEventListener("pointermove",y=>{const w=Z(y);if(L(w.x,w.y),!!o){if(y.preventDefault(),i==="brush")t.lineTo(w.x,w.y),t.stroke();else if(i==="eraser")t.strokeStyle="white",t.lineTo(w.x,w.y),t.stroke(),t.strokeStyle=s;else if(["line","rectangle","ellipse"].includes(i)){const v=e.offsetWidth,E=e.offsetHeight;t.clearRect(0,0,v,E),f&&t.drawImage(f,0,0,v,E),M(w.x,w.y)}}}),e.addEventListener("pointerup",y=>{const w=Z(y);o&&["line","rectangle","ellipse"].includes(i)&&M(w.x,w.y,!0),o=!1,c=e.toDataURL(),_(),f=null}),e.addEventListener("click",y=>{const w=Z(y);if(i==="picker"){const v=window.devicePixelRatio||1,E=t.getImageData(Math.floor(w.x*v),Math.floor(w.y*v),1,1).data;s=ee(E[0],E[1],E[2]),t.strokeStyle=s,t.fillStyle=s,document.getElementById("colorPicker").value=s,Ee().catch(console.error)}}),document.getElementById("undoBtn").addEventListener("click",()=>{if(b.length>1){const y=b.pop();I.push(y);const w=b[b.length-1];V(w),c=w,Ee().catch(console.error)}}),document.getElementById("redoBtn").addEventListener("click",()=>{if(I.length){const y=I.pop();b.push(y),V(y),c=y,Ee().catch(console.error)}});function _(){const y=e.toDataURL();b.push(y),c=y,I=[],Ee().catch(console.error)}function V(y){const w=new Image;w.src=y,w.alt="Watercolour painting canvas state",w.onload=()=>{const v=e.offsetWidth,E=e.offsetHeight;t.clearRect(0,0,v,E),t.drawImage(w,0,0,v,E)}}function Z(y){const w=e.getBoundingClientRect();return{x:y.clientX-w.left,y:y.clientY-w.top}}function k(){const y=window.devicePixelRatio||1,w=e.offsetWidth,v=e.offsetHeight;if(t.getImageData(0,0,e.width,e.height),e.width=w*y,e.height=v*y,e.style.width=w+"px",e.style.height=v+"px",t.setTransform(y,0,0,y,0,0),c){const E=new Image;E.src=c,E.alt="Saved watercolour painting for canvas restoration",E.onload=()=>{t.clearRect(0,0,w,v),t.drawImage(E,0,0,w,v)}}else t.fillStyle="white",t.fillRect(0,0,w,v)}function L(y,w){const v=document.getElementById("status");v.textContent=`Tool: ${i.charAt(0).toUpperCase()+i.slice(1)} | x: ${Math.floor(y)}, y: ${Math.floor(w)}`}function A(){const y=parseFloat(d.dataset.x),w=parseFloat(d.dataset.y),v=d.value;d.style.display="none",d.value="",d.onblur=null,t.fillStyle=s,t.font=`${l*4}px sans-serif`,t.textBaseline="top",t.fillText(v,y,w),_()}function M(y,w,v=!1){const E=r,z=a,C=y-r,U=w-a;t.lineWidth=l,t.strokeStyle=s,t.fillStyle=s,i==="line"?(t.beginPath(),t.moveTo(E,z),t.lineTo(y,w),t.stroke()):i==="rectangle"?t.strokeRect(E,z,C,U):i==="ellipse"&&(t.beginPath(),t.ellipse(E+C/2,z+U/2,Math.abs(C/2),Math.abs(U/2),0,0,Math.PI*2),t.stroke())}function S(y,w,v){const E=window.devicePixelRatio||1,z=e.width,C=e.height,U=t.getImageData(0,0,z,C),Y=U.data,q=X(v),ce=q.r,he=q.g,Be=q.b,Le=Math.floor(y*E),Ge=Math.floor(w*E),Oe=(Ge*z+Le)*4,Qe=Y[Oe],at=Y[Oe+1],je=Y[Oe+2],Ke=Y[Oe+3];if(Qe===ce&&at===he&&je===Be)return;const ft=[[Le,Ge]];for(;ft.length;){const[He,Dn]=ft.pop();let Te=Dn;for(;Te>=0&&T(Y,He,Te,z,Qe,at,je,Ke);)Te--;Te++;let et=!1,st=!1;for(;Te<C&&T(Y,He,Te,z,Qe,at,je,Ke);){const lt=(Te*z+He)*4;Y[lt]=ce,Y[lt+1]=he,Y[lt+2]=Be,Y[lt+3]=255,He>0&&(T(Y,He-1,Te,z,Qe,at,je,Ke)?et||(ft.push([He-1,Te]),et=!0):et=!1),He<z-1&&(T(Y,He+1,Te,z,Qe,at,je,Ke)?st||(ft.push([He+1,Te]),st=!0):st=!1),Te++}}t.putImageData(U,0,0)}function T(y,w,v,E,z,C,U,Y){const q=(v*E+w)*4;return y[q]===z&&y[q+1]===C&&y[q+2]===U&&y[q+3]===Y}function X(y){y=y.replace(/^#/,"");let w=parseInt(y,16);return y.length===3?{r:(w>>8)*17,g:(w>>4&15)*17,b:(w&15)*17}:{r:w>>16&255,g:w>>8&255,b:w&255}}function ee(y,w,v){return"#"+((1<<24)+(y<<16)+(w<<8)+v).toString(16).slice(1)}async function oe(){try{const y=e.toDataURL("image/png"),w=globalStorage,v=globalAddFileToFileSystem;if(!w){showDialogBox("Cannot access storage. Please ensure the main OS is loaded.","error");return}const E=Date.now(),z=`watercolour_drawing_${E}`;await w.setItem(z,y),makeWin95Prompt("Enter a filename for your drawing:",`drawing_${E}.png`,async C=>{if(C){const U=C.endsWith(".png")?C:C+".png",Y=we();if(v){const q=y.split(",")[1],ce=atob(q),he=new Uint8Array(ce.length);for(let Oe=0;Oe<ce.length;Oe++)he[Oe]=ce.charCodeAt(Oe);const Be=new Blob([he],{type:"image/png"}),Le=new File([Be],U,{type:"image/png"}),Ge=await v(U,y,Y,"png",Le);p={name:U,path:Y,storageKey:z,data:y},refreshExplorerViews&&refreshExplorerViews(),Y==="C://Desktop"&&renderDesktopIcons&&renderDesktopIcons(),showDialogBox(`Drawing saved as "${U}" in ${Y}!`,"info")}else showDialogBox("File system not available. Drawing saved to storage only.","info")}else showDialogBox("Drawing saved to storage but not added to file system.","info")},()=>{showDialogBox("Drawing saved to storage but not added to file system.","info")})}catch(y){console.error("Error saving drawing:",y),showDialogBox("Error saving drawing: "+y.message,"error")}}function te(){if(openFileExplorerForImageSelection)openFileExplorerForImageSelection((y,w)=>{y&&ie(y,w)});else if(se&&getExplorerWindowContent){window.watercolourLoadCallback=(w,v)=>{w&&ie(w,v)};const y=getExplorerWindowContent("C://Documents");se("Select Image - File Explorer",y,!0,"explorer-watercolour-load",!1,!1,{type:"integer",width:600,height:500},"file-explorer"),showDialogBox("Select an image file from the file explorer to load it onto the canvas.","info")}else showDialogBox("File explorer not available. Please ensure the main OS is loaded.","error")}function ie(y,w=null){const v=new Image;v.alt="Image to be loaded onto watercolour canvas",v.onload=()=>{const E=e.offsetWidth,z=e.offsetHeight;t.clearRect(0,0,E,z),t.fillStyle="white",t.fillRect(0,0,E,z);const C=Math.min(E/v.width,z/v.height),U=v.width*C,Y=v.height*C,q=(E-U)/2,ce=(z-Y)/2;t.drawImage(v,q,ce,U,Y),c=e.toDataURL(),_()},v.onerror=()=>{console.error("Error loading selected image."),showDialogBox("Error loading selected image.","error")},v.src=y,v.alt="User-selected image to import into watercolour canvas"}function we(){if(parent&&parent.document){const y=parent.document.querySelectorAll(".file-explorer-window");if(y.length>0){const v=y[y.length-1].getAttribute("data-current-path");if(v)return v}}return"C://Documents"}async function Ee(){try{const y={currentTool:i,activeColor:s,strokeSize:l,canvasData:e.toDataURL(),currentFile:p,undoStack:b.slice(-10),redoStack:I.slice(-10)};await storage.setItem("watercolour_state",y)}catch(y){console.warn("Failed to save Watercolour state:",y);try{const w={currentTool:i,activeColor:s,strokeSize:l,canvasData:e.toDataURL(),currentFile:p,undoStack:b.slice(-10),redoStack:I.slice(-10)};storage.setItemSync("watercolour_state",w)}catch(w){console.error("Failed to save Watercolour state with fallback:",w)}}}async function ve(){try{const y=await storage.getItem("watercolour_state");if(y)return y}catch(y){console.warn("Failed to load Watercolour state:",y);try{const w=storage.getItemSync("watercolour_state");if(w)return w}catch(w){console.warn("Failed to load Watercolour state with fallback:",w)}}return null}async function R(){n=await ve(),n&&(i=n.currentTool||"brush",s=n.activeColor||"#000000",l=n.strokeSize||5,p=n.currentFile||null,b=n.undoStack||[],I=n.redoStack||[]);const y=window.devicePixelRatio||1,w=e.offsetWidth,v=e.offsetHeight;e.width=w*y,e.height=v*y,e.style.width=w+"px",e.style.height=v+"px",t.setTransform(y,0,0,y,0,0),u&&(u.value=l),g&&(g.value=s),t.strokeStyle=s,t.fillStyle=s,t.lineWidth=l,document.querySelectorAll(".tool-btn").forEach(z=>{z.classList.remove("bg-gray-100"),z.getAttribute("data-tool")===i&&z.classList.add("bg-gray-100")});const E=n==null?void 0:n.canvasData;if(E){const z=new Image;z.alt="Saved watercolour canvas state for restoration",z.onload=function(){t.clearRect(0,0,w,v),t.drawImage(z,0,0,w,v)},z.src=E}else t.fillStyle="white",t.fillRect(0,0,w,v),_()}await R()}function Nr(e,t){const n={C:"Clear all",CE:"Clear entry","¬±":"Change sign","‚àö":"Square root","%":"Percent","1/x":"Reciprocal","=":"Equals","+":"Plus","-":"Minus","√ó":"Multiply","√∑":"Divide",".":"Decimal point"};return n[e]?n[e]:t==="number"?`Number ${e}`:t==="operator"?`Operator ${e}`:e}function mi(){const e=document.getElementById("calculator");if(e){const o=[...document.querySelectorAll("*")].filter(i=>getComputedStyle(i).zIndex>100&&getComputedStyle(i).zIndex<1e3).reduce((i,r)=>getComputedStyle(r).zIndex>getComputedStyle(i).zIndex?r:i);e.style.zIndex=`${parseInt(o.style.zIndex)+1}`;return}const t=se("Calculator","",!1,"calculator",!1,!1,{type:"integer",width:250,height:360},"App",null,"gray-100");gi(t).catch(n=>{console.error("Error initializing Calculator:",n)})}async function gi(e){const t=e.querySelector(".p-2");t.className="p-4 bg-gray-100 h-full overflow-hidden",t.innerHTML="";let n=await Or();n||(n={display:"0",previousValue:null,operation:null,waitingForOperand:!1});const o=document.createElement("div");o.className="flex flex-col h-full space-y-1 pb-6";const i=document.createElement("div");i.className="bg-white border-2 p-2 mb-2",i.style.borderTopColor="#808080",i.style.borderLeftColor="#808080",i.style.borderBottomColor="#ffffff",i.style.borderRightColor="#ffffff";const r=document.createElement("div");r.id="calc-display",r.className="text-right text-lg font-mono bg-white text-black min-h-6 px-1",r.textContent=n.display,i.appendChild(r);const a=document.createElement("div");a.className="grid grid-cols-4 gap-1 flex-1",[{text:"C",type:"clear",className:"col-span-2"},{text:"¬±",type:"sign"},{text:"/",type:"operator"},{text:"7",type:"number"},{text:"8",type:"number"},{text:"9",type:"number"},{text:"*",type:"operator"},{text:"4",type:"number"},{text:"5",type:"number"},{text:"6",type:"number"},{text:"-",type:"operator"},{text:"1",type:"number"},{text:"2",type:"number"},{text:"3",type:"number"},{text:"+",type:"operator"},{text:"0",type:"number",className:"col-span-2"},{text:".",type:"decimal"},{text:"=",type:"equals"}].forEach(u=>{const m=document.createElement("button");m.textContent=u.text,m.className=`bg-gray-200 border-2 hover:bg-gray-300 font-mono text-sm py-2 select-none ${u.className||""}`,m.style.borderTopColor="#ffffff",m.style.borderLeftColor="#ffffff",m.style.borderBottomColor="#808080",m.style.borderRightColor="#808080",m.style.transition="none";const g=Nr(u.text,u.type);m.setAttribute("aria-label",g),m.setAttribute("title",g),m.addEventListener("mousedown",()=>{m.style.borderTopColor="#808080",m.style.borderLeftColor="#808080",m.style.borderBottomColor="#ffffff",m.style.borderRightColor="#ffffff",m.classList.add("bg-gray-300")}),m.addEventListener("mouseup",()=>{m.style.borderTopColor="#ffffff",m.style.borderLeftColor="#ffffff",m.style.borderBottomColor="#808080",m.style.borderRightColor="#808080",m.classList.remove("bg-gray-300")}),m.addEventListener("mouseleave",()=>{m.style.borderTopColor="#ffffff",m.style.borderLeftColor="#ffffff",m.style.borderBottomColor="#808080",m.style.borderRightColor="#808080",m.classList.remove("bg-gray-300")}),m.addEventListener("click",async()=>await c(u.text,u.type)),a.appendChild(m)}),o.appendChild(i),o.appendChild(a),t.appendChild(o);async function l(){r.textContent=n.display,await Rr(n)}async function c(u,m){switch(m){case"number":n.waitingForOperand?(n.display=u,n.waitingForOperand=!1):n.display=n.display==="0"?u:n.display+u;break;case"decimal":n.waitingForOperand?(n.display="0.",n.waitingForOperand=!1):n.display.indexOf(".")===-1&&(n.display+=".");break;case"clear":n.display="0",n.previousValue=null,n.operation=null,n.waitingForOperand=!1;break;case"sign":n.display!=="0"&&(n.display=n.display.charAt(0)==="-"?n.display.slice(1):"-"+n.display);break;case"operator":const g=parseFloat(n.display);if(n.previousValue===null)n.previousValue=g;else if(n.operation){const b=n.previousValue||0,I=f(b,g,n.operation);n.display=String(I),n.previousValue=I}n.waitingForOperand=!0,n.operation=u;break;case"equals":const x=parseFloat(n.display);if(n.previousValue!==null&&n.operation){const b=n.previousValue||0,I=f(b,x,n.operation);n.display=String(I),n.previousValue=null,n.operation=null,n.waitingForOperand=!0}break}await l()}function f(u,m,g){switch(g){case"+":return u+m;case"-":return u-m;case"*":return u*m;case"/":return m!==0?u/m:0;default:return m}}async function p(u){const m=u.key;/[0-9]/.test(m)?await c(m,"number"):["+","-","*","/"].includes(m)?await c(m,"operator"):m==="."?await c(m,"decimal"):m==="Enter"||m==="="?await c("=","equals"):m==="Escape"||m==="c"||m==="C"?await c("C","clear"):m==="Backspace"&&(n.display.length>1?n.display=n.display.slice(0,-1):n.display="0",await l())}document.addEventListener("keydown",p);const d=new MutationObserver(u=>{u.forEach(m=>{m.removedNodes.forEach(g=>{g.id==="calculator"&&(document.removeEventListener("keydown",p),d.disconnect())})})});d.observe(document.getElementById("windows-container"),{childList:!0})}async function Rr(e){try{await B.setItem("calculator_state",e)}catch(t){console.warn("Failed to save Calculator state:",t)}}async function Or(){try{const e=await B.getItem("calculator_state");if(e)return e}catch(e){console.warn("Failed to load Calculator state:",e)}return null}function hi(){const e=document.getElementById("solitaire");if(e){const o=[...document.querySelectorAll("*")].filter(i=>getComputedStyle(i).zIndex>100&&getComputedStyle(i).zIndex<1e3).reduce((i,r)=>getComputedStyle(r).zIndex>getComputedStyle(i).zIndex?r:i);e.style.zIndex=`${parseInt(o.style.zIndex)+1}`;return}const t=se("Solitaire","",!1,"solitaire",!1,!1,{type:"integer",width:700,height:500},"App",null,"green");yi(t).catch(console.error)}async function yi(e){const t=e.querySelector(".p-2");t.className="bg-green-600 h-full overflow-hidden",t.style.backgroundImage="radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1) 0%, transparent 50%)",t.innerHTML="";let n=await Hr();n||(n={deck:[],waste:[],foundations:[[],[],[],[]],tableaus:[[],[],[],[],[],[],[]],score:0,moves:0,time:0,gameStarted:!1,selectedCard:null,selectedPile:null,dragElement:null,drawCount:1});let o=null,i=await B.getItem("solitaire-high-score")||0;const r=["‚ô†","‚ô£","‚ô•","‚ô¶"],a=["A","2","3","4","5","6","7","8","9","10","J","Q","K"],s={"‚ô†":"black","‚ô£":"black","‚ô•":"red","‚ô¶":"red"},l=document.createElement("div");l.className="flex flex-col h-full";const c=document.createElement("div");c.className="bg-gray-200 border-b border-gray-400 p-1 flex flex-wrap md:flex-nowrap items-center gap-2 md:gap-4";const f=document.createElement("button");f.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",f.textContent="Game",f.setAttribute("aria-label","Game menu options"),f.setAttribute("title","Access game options and settings");const p=document.createElement("button");p.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",p.textContent="New Game",p.setAttribute("aria-label","Start new solitaire game"),p.setAttribute("title","Start a new game of solitaire"),p.addEventListener("click",ie);const d=document.createElement("select");d.className="ml-2 text-sm border rounded p-1 bg-white";const u=document.createElement("option");u.value="1",u.text="Easy (Draw 1)";const m=document.createElement("option");m.value="3",m.text="Normal (Draw 3)",d.appendChild(u),d.appendChild(m),d.title="Select difficulty / draw count",d.value=n.drawCount?String(n.drawCount):"1",d.addEventListener("change",R=>{n.drawCount=parseInt(R.target.value,10),Xe(n).catch(console.error)});const g=document.createElement("div");g.className="text-xs md:text-sm font-mono ml-auto flex space-x-2 md:space-x-4",g.innerHTML=`<span>Score: <span id="score">0</span></span><span>High: <span id="high-score">${i}</span></span><span>Time: <span id="time">0:00</span></span>`,c.appendChild(p),c.appendChild(d),c.appendChild(g);const x=document.createElement("div");x.className="flex-1 p-2 md:p-4 relative overflow-scroll",x.id="solitaire-game-area";const b=document.createElement("div");b.className="lg:flex justify-between mb-6";const I=document.createElement("div");I.className="flex space-x-4 mb-4 lg:mb-0";const h=document.createElement("div");h.className="w-12 h-[4.5rem] md:w-16 md:h-24 border-2 border-gray-400 rounded bg-blue-800 flex items-center justify-center cursor-pointer",h.style.borderStyle="outset",h.id="deck-slot",h.addEventListener("click",V);const H=document.createElement("div");H.className="w-12 h-[4.5rem] md:w-16 md:h-24 border-2 border-gray-400 rounded bg-green-700 relative",H.style.borderStyle="inset",H.id="waste-slot",I.appendChild(h),I.appendChild(H);const O=document.createElement("div");O.className="flex space-x-2";for(let R=0;R<4;R++){const y=document.createElement("div");y.className="w-12 h-[4.5rem] md:w-16 md:h-24 border-2 border-gray-400 rounded bg-green-700 relative",y.style.borderStyle="inset",y.id=`foundation-${R}`,y.dataset.foundationIndex=R,y.addEventListener("click",w=>void 0),O.appendChild(y)}b.appendChild(I),b.appendChild(O);const j=document.createElement("div");j.className="flex space-x-2";for(let R=0;R<7;R++){const y=document.createElement("div");y.className="w-12 min-h-[6rem] md:w-16 md:min-h-32 relative",y.id=`tableau-${R}`,y.dataset.tableauIndex=R,y.addEventListener("click",w=>void 0),j.appendChild(y)}x.appendChild(b),x.appendChild(j),l.appendChild(c),l.appendChild(x),t.appendChild(l);function $(R,y,w=!0){const v=document.createElement("div");if(v.className="card absolute w-12 h-[4.5rem] md:w-16 md:h-24 border border-gray-800 rounded bg-white cursor-pointer transition-all duration-200 text-[10px] md:text-xs",v.style.fontFamily="ui-serif, Georgia, 'Cambria', 'Times New Roman', Times, serif",v.style.userSelect="none",v.style.pointerEvents="auto",v.dataset.suit=R,v.dataset.value=y,v.dataset.faceUp=w,w){const E=s[R];v.style.color=E,v.innerHTML=`
        <div class="p-0.5 md:p-1 h-full flex flex-col justify-between leading-none">
          <div class="flex justify-between items-center">
            <span class="font-bold text-xs md:text-sm">${y}</span>
            <span class="text-sm md:text-lg">${R}</span>
          </div>
          <div class="text-center text-xl md:text-2xl">${R}</div>
          <div class="flex justify-between items-center rotate-180">
            <span class="font-bold text-xs md:text-sm">${y}</span>
            <span class="text-sm md:text-lg">${R}</span>
          </div>
        </div>
      `}else v.style.background="linear-gradient(45deg, #000080, #0000cd)",v.style.color="white",v.innerHTML=`
        <div class="w-full h-full flex items-center justify-center text-xs">
          <div class="text-center">‚ô†‚ô•‚ô¶‚ô£</div>
        </div>
      `;return v.addEventListener("mousedown",Z),v.addEventListener("touchstart",Z,{passive:!1}),v.addEventListener("dblclick",L),v}function F(){n.deck=[];for(const R of r)for(const y of a)n.deck.push({suit:R,value:y});for(let R=n.deck.length-1;R>0;R--){const y=Math.floor(Math.random()*(R+1));[n.deck[R],n.deck[y]]=[n.deck[y],n.deck[R]]}}function N(){n.waste=[],n.foundations=[[],[],[],[]],n.tableaus=[[],[],[],[],[],[],[]];for(let R=0;R<7;R++)for(let y=0;y<=R;y++){const w=n.deck.pop();w.faceUp=y===R,n.tableaus[R].push(w)}_(),Xe(n).catch(console.error)}function _(){document.querySelectorAll(".card").forEach(w=>w.remove());const R=document.getElementById("deck-slot");n.deck.length>0?(R.innerHTML="üÇ†",R.style.fontSize="40px",R.style.color="white"):(R.innerHTML="‚Üª",R.style.fontSize="24px",R.style.color="white");const y=document.getElementById("waste-slot");if(y.innerHTML="",n.waste.length>0){const w=n.waste[n.waste.length-1],v=$(w.suit,w.value,!0);v.classList.add("card"),v.style.position="absolute",v.style.top="0",v.style.left="0",y.appendChild(v)}for(let w=0;w<4;w++){const v=document.getElementById(`foundation-${w}`);v.innerHTML="";const E=r[w];if(v.innerHTML=`<div class="absolute inset-0 flex items-center justify-center text-4xl text-gray-500 opacity-30">${E}</div>`,n.foundations[w].length>0){const z=n.foundations[w][n.foundations[w].length-1],C=$(z.suit,z.value,!0);C.classList.add("card"),C.style.position="absolute",C.style.top="0",C.style.left="0",v.appendChild(C)}}for(let w=0;w<7;w++){const v=document.getElementById(`tableau-${w}`);v.innerHTML="",n.tableaus[w].length===0&&(v.innerHTML='<div class="w-12 h-[4.5rem] md:w-16 md:h-24 border-2 border-gray-400 border-dashed rounded bg-green-700 opacity-50"></div>'),n.tableaus[w].forEach((E,z)=>{const C=$(E.suit,E.value,E.faceUp);C.classList.add("card"),C.style.position="absolute";const U=window.innerWidth<768?15:20;C.style.top=`${z*U}px`,C.style.left="0",C.style.zIndex=z+1,C.dataset.tableauIndex=w,C.dataset.cardIndex=z,v.appendChild(C)})}te()}function V(){const R=n.drawCount||1;if(n.deck.length>0){for(let y=0;y<R&&n.deck.length!==0;y++){const w=n.deck.pop();w.faceUp=!0,n.waste.push(w)}n.moves++}else n.waste.length>0&&(n.deck=n.waste.reverse(),n.deck.forEach(y=>y.faceUp=!1),n.waste=[],n.moves++);_(),Xe(n).catch(console.error)}function Z(R){let y=R.target;for(;y&&y!==document.body&&!(y.classList&&y.classList.contains("card"));)y=y.parentElement;if(!y||!y.classList.contains("card")||y.dataset.faceUp!=="true")return;R.preventDefault(),R.stopPropagation(),n.selectedCard=y,n.dragElement=y.cloneNode(!0),n.dragElement.style.position="fixed",n.dragElement.style.pointerEvents="none",n.dragElement.style.zIndex="1000",n.dragElement.style.transition="none",n.dragElement.style.left="0",n.dragElement.style.top="0";const w=R.type==="touchstart"?R.touches[0]:R,v=32,E=48;n.dragElement.style.transform=`translate3d(${w.clientX-v}px, ${w.clientY-E}px, 0) rotate(5deg)`,document.body.appendChild(n.dragElement),y.style.opacity="0.5";const z=document.body.style.touchAction;document.body.style.touchAction="none";let C=null;function U(q){q.cancelable&&q.preventDefault();const ce=q.type&&q.type.startsWith("touch")?q.touches[0]:q;n.dragElement&&(C&&cancelAnimationFrame(C),C=requestAnimationFrame(()=>{n.dragElement&&(n.dragElement.style.transform=`translate3d(${ce.clientX-v}px, ${ce.clientY-E}px, 0) rotate(5deg)`)}))}function Y(q){if(document.removeEventListener("mousemove",U),document.removeEventListener("mouseup",Y),document.removeEventListener("touchmove",U),document.removeEventListener("touchend",Y),C&&(cancelAnimationFrame(C),C=null),n.dragElement&&document.body.contains(n.dragElement)&&(document.body.removeChild(n.dragElement),n.dragElement=null),document.body.style.touchAction=z||"",n.selectedCard){n.selectedCard.style.opacity="1";const ce=q.type==="touchend"?q.changedTouches[0]:q,he=document.elementFromPoint(ce.clientX,ce.clientY);k(he),n.selectedCard=null}}document.addEventListener("mousemove",U),document.addEventListener("mouseup",Y),document.addEventListener("touchmove",U,{passive:!1}),document.addEventListener("touchend",Y)}function k(R){const y=n.selectedCard;if(!y||!R)return;let w=R,v=null,E=null;for(;w&&w!==document.body;){if(w.id&&w.id.startsWith("foundation-")){v=w,E="foundation";break}if(w.dataset&&w.dataset.tableauIndex!==void 0){v=w,E="tableau";break}if(w.classList&&w.classList.contains("card")&&w.dataset.tableauIndex!==void 0){v=w.parentElement,E="tableau";break}w=w.parentElement}if(v&&E==="foundation"){const z=parseInt(v.dataset.foundationIndex);A(y,z)&&S(y)}else if(v&&E==="tableau"){const z=parseInt(v.dataset.tableauIndex);M(y,z)&&T(y,z)}}function L(R){let y=R.target;for(;y&&!y.classList.contains("card");)y=y.parentElement;if(!(!y||y.dataset.faceUp!=="true")){for(let w=0;w<4;w++)if(A(y,w)){S(y);return}}}function A(R,y){const w=R.dataset.suit,v=R.dataset.value,E=n.foundations[y],z=r[y];if(w!==z){const C=r.indexOf(w);return C!==-1&&n.foundations[C].length===0?v==="A":!1}if(E.length===0)return v==="A";{const C=E[E.length-1],U=a.indexOf(C.value);return a.indexOf(v)===U+1}}function M(R,y){const w=R.dataset.suit,v=R.dataset.value,E=n.tableaus[y];if(E.length===0)return v==="K";const z=E[E.length-1];if(!z.faceUp)return!1;const C=s[z.suit],U=s[w],Y=a.indexOf(z.value),q=a.indexOf(v);return C!==U&&q===Y-1}function S(R,y){const w=R.dataset.suit,v=r.indexOf(w);if(v===-1)return;X(R);const E={suit:w,value:R.dataset.value,faceUp:!0};n.foundations[v].push(E),n.moves++,n.score+=10,_(),Ee(),Xe(n).catch(console.error)}function T(R,y){const w=X(R,!0);n.tableaus[y].push(...w),n.moves++,_(),Xe(n).catch(console.error)}function X(R,y=!1){const w=R.dataset.suit,v=R.dataset.value;if(n.waste.length>0&&n.waste[n.waste.length-1].suit===w&&n.waste[n.waste.length-1].value===v)return[n.waste.pop()];for(let E=0;E<7;E++){const z=n.tableaus[E],C=z.findIndex(U=>U.suit===w&&U.value===v);if(C!==-1){const U=y?z.length-C:1,Y=z.splice(C,U);return z.length>0&&!z[z.length-1].faceUp&&(z[z.length-1].faceUp=!0,n.score+=5,Xe(n).catch(console.error)),Y}}return[]}function ee(R,y){}function oe(R,y){}function te(){if(document.getElementById("score").textContent=n.score,n.gameStarted){const R=Math.floor(n.time/60),y=n.time%60;document.getElementById("time").textContent=`${R}:${y.toString().padStart(2,"0")}`}}function ie(){n.score=0,n.moves=0,n.time=0,n.gameStarted=!0,o&&clearInterval(o),o=setInterval(()=>{n.time++,te(),Xe(n).catch(console.error)},1e3),F(),N(),qr().catch(console.error)}function we(){n.gameStarted&&(o=setInterval(()=>{n.time++,te(),Xe(n).catch(console.error)},1e3)),te(),_()}function Ee(){n.foundations.reduce((y,w)=>y+w.length,0)===52&&(o&&clearInterval(o),Xe(n).catch(console.error),n.score>i&&(i=n.score,B.setItemSync("solitaire-high-score",i),document.getElementById("high-score").textContent=i,window.isDevvit&&window.parent.postMessage({type:"setGameScore",data:{game:"solitaire",score:i}},"*")),setTimeout(()=>{_r()},500))}const ve=new MutationObserver(R=>{R.forEach(y=>{y.removedNodes.forEach(w=>{w.id==="solitaire"&&(o&&clearInterval(o),ve.disconnect())})})});ve.observe(document.getElementById("windows-container"),{childList:!0}),!n.gameStarted||n.deck.length===0?ie():we()}async function Xe(e){try{const t={...e,selectedCard:null,selectedPile:null,dragElement:null};await B.setItem("solitaire_gameState",t)}catch(t){console.warn("Failed to save Solitaire game state:",t);try{const n={...e,selectedCard:null,selectedPile:null,dragElement:null};B.setItemSync("solitaire_gameState",n)}catch(n){console.error("Failed to save Solitaire game state with fallback:",n)}}}async function Hr(){try{const e=await B.getItem("solitaire_gameState");if(e){const t=e;return t.selectedCard=null,t.selectedPile=null,t.dragElement=null,t}}catch(e){console.warn("Failed to load Solitaire game state:",e);try{const t=B.getItemSync("solitaire_gameState");if(t){const n=t;return n.selectedCard=null,n.selectedPile=null,n.dragElement=null,n}}catch(t){console.warn("Failed to load Solitaire game state with fallback:",t)}}return null}async function qr(){try{await B.removeItem("solitaire_gameState")}catch(e){console.warn("Failed to clear Solitaire game state:",e);try{B.removeItemSync("solitaire_gameState")}catch(t){console.error("Failed to clear Solitaire game state with fallback:",t)}}}function _r(){const e=document.createElement("canvas");e.id="solitaire-win-canvas",Object.assign(e.style,{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",zIndex:9999,pointerEvents:"none"}),document.body.appendChild(e);const t=e.getContext("2d");e.width=window.innerWidth,e.height=window.innerHeight;const n=["‚ô†","‚ô•","‚ô£","‚ô¶"],o=["A","2","3","4","5","6","7","8","9","10","J","Q","K"],i={"‚ô†":"black","‚ô£":"black","‚ô•":"red","‚ô¶":"red"},r=[],a=.2,s=75,l=100,c=.02;let f=0,p,d=!0;const u=setInterval(()=>{if(f===52)return clearInterval(u);const g=n[f%4],x=o[Math.floor(f/4)];r.push({x:Math.random()*e.width,y:-50,vx:(Math.random()-.5)*4,vy:Math.random()*2,suit:g,value:x,color:i[g]}),f++},100);function m(){t.fillStyle=`rgba(10,100,10,${c})`,t.fillRect(0,0,e.width,e.height),r.forEach(g=>{g.vy+=a,g.x+=g.vx,g.y+=g.vy,g.y>e.height-l&&(g.y=e.height-l,g.vy*=-.7),t.fillStyle="white",t.fillRect(g.x,g.y,s,l),t.strokeStyle="#333",t.strokeRect(g.x,g.y,s,l),t.fillStyle=g.color,t.font="24px sans-serif",t.fillText(g.value+g.suit,g.x+10,g.y+30)}),d&&(p=requestAnimationFrame(m))}m(),setTimeout(()=>{d=!1,clearInterval(u),cancelAnimationFrame(p),document.body.removeChild(e),showDialogBox("Congratulations! You won!","confirmation")},8e3)}function bi(){const e=document.getElementById("chess");if(e){const a=[...document.querySelectorAll("*")].filter(s=>getComputedStyle(s).zIndex>100&&getComputedStyle(s).zIndex<1e3).reduce((s,l)=>getComputedStyle(l).zIndex>getComputedStyle(s).zIndex?l:s);e.style.zIndex=`${parseInt(a.style.zIndex)+1}`;return}const t=window.innerWidth<600,n=t?Math.min(window.innerWidth-20,600):600,o=t?Math.min(window.innerHeight-60,690):690,i=se("Guillotine Chess","",!1,"chess",!1,!1,{type:"integer",width:n,height:o},"App",null,"white");wi(i).catch(r=>{console.error("Error initializing Chess:",r)})}async function wi(e){const t=e.querySelector(".p-2");t.className="p-4 bg-white h-full overflow-hidden",t.innerHTML="";let n=await na();n||(n={board:Bo(),currentPlayer:"white",difficulty:"easy",gameOver:!1,winner:null,moveHistory:[],selectedSquare:null,possibleMoves:[],gameStarted:!0,enPassantTarget:null,halfMoveClock:0,fullMoveNumber:1});const o=document.createElement("div");o.className="flex flex-col h-full";const i=document.createElement("div");i.className="flex justify-between items-center mb-4 p-2 bg-gray-100 rounded",i.innerHTML=`
    <div class="flex items-center space-x-4">
      <span class="font-semibold">Difficulty: <span id="difficulty-dropdown-container"></span></span>
      <span class="font-semibold">Turn: <span class="text-${n.currentPlayer==="white"?"gray-800":"gray-600"}">${n.currentPlayer.charAt(0).toUpperCase()+n.currentPlayer.slice(1)}</span></span>
    </div>
    <div class="space-x-2" id="button-container">
    </div>
  `,o.appendChild(i);const a=ia([{value:"easy",text:"Easy"},{value:"medium",text:"Medium"},{value:"hard",text:"Hard"}],n.difficulty,async m=>{n.difficulty=m,await an(n)});a.id="difficulty-select",a.className+=" ml-1",i.querySelector("#difficulty-dropdown-container").appendChild(a);const s=oa("New Game");s.id="new-game-btn",i.querySelector("#button-container").appendChild(s);const l=document.createElement("div");l.className="flex-1 flex items-center justify-center";const c=document.createElement("div");c.id="chess-board",c.className="grid grid-cols-8 border-4 border-gray-800";const p=window.innerWidth<600?Math.min(window.innerWidth-60,480):480,d=p/8;c.style.width=`${p}px`,c.style.height=`${p}px`,c.style.gap="0";for(let m=0;m<8;m++)for(let g=0;g<8;g++){const x=document.createElement("div");x.className=`chess-square flex items-center justify-center cursor-pointer text-4xl font-bold select-none ${(m+g)%2===0?"bg-amber-100":"bg-amber-600"}`,x.style.width=`${d}px`,x.style.height=`${d}px`,x.dataset.row=m,x.dataset.col=g;const b=n.board[m][g];b&&(x.textContent=vi(b),x.style.color=b.color==="white"?"#000":"#444"),x.addEventListener("click",async()=>await jr(m,g,n,e)),c.appendChild(x)}l.appendChild(c),o.appendChild(l);const u=document.createElement("div");u.id="status-bar",u.className="mt-4 p-2 text-center",n.gameOver?u.innerHTML=`<span class="text-lg font-bold text-green-600">Game Over! ${n.winner?n.winner.charAt(0).toUpperCase()+n.winner.slice(1)+" wins!":"Draw!"}</span>`:u.innerHTML='<span class="text-gray-600">Guillotine Chess: Capture the King to win! Kings can be captured like any other piece.</span>',o.appendChild(u),i.querySelector("#new-game-btn").addEventListener("click",async()=>{n.board=Bo(),n.currentPlayer="white",n.gameOver=!1,n.winner=null,n.moveHistory=[],n.selectedSquare=null,n.possibleMoves=[],await an(n),no(n,e)}),t.appendChild(o),rn(n),n.currentPlayer==="black"&&!n.gameOver&&setTimeout(async()=>await Si(n,e),500)}function no(e,t){const n=t.querySelector("#difficulty-select");n&&(n.value=e.difficulty);const o=t.querySelector(".text-gray-800, .text-gray-600");o&&o.parentElement&&o.parentElement.textContent.includes("Turn:")&&(o.textContent=e.currentPlayer.charAt(0).toUpperCase()+e.currentPlayer.slice(1),o.className=e.currentPlayer==="white"?"text-gray-800":"text-gray-600"),document.querySelectorAll(".chess-square").forEach(a=>{const s=parseInt(a.dataset.row),l=parseInt(a.dataset.col),c=e.board[s][l];c?(a.textContent=vi(c),a.style.color=c.color==="white"?"#000":"#444"):a.textContent=""});const r=t.querySelector("#status-bar");r&&(e.gameOver?r.innerHTML=`<span class="text-lg font-bold text-green-600">Game Over! ${e.winner?e.winner.charAt(0).toUpperCase()+e.winner.slice(1)+" wins!":"Draw!"}</span>`:r.innerHTML='<span class="text-gray-600">Guillotine Chess: Capture the King to win! Kings can be captured like any other piece.</span>'),e.selectedSquare=null,e.possibleMoves=[],rn(e),e.currentPlayer==="black"&&!e.gameOver&&setTimeout(async()=>await Si(e,t),500)}function Bo(){const e=Array(8).fill(null).map(()=>Array(8).fill(null)),t=["rook","knight","bishop","queen","king","bishop","knight","rook"];for(let n=0;n<8;n++)e[0][n]={type:t[n],color:"black"},e[1][n]={type:"pawn",color:"black"};for(let n=0;n<8;n++)e[6][n]={type:"pawn",color:"white"},e[7][n]={type:t[n],color:"white"};return e}function vi(e){return{white:{king:"‚ôî",queen:"‚ôï",rook:"‚ôñ",bishop:"‚ôó",knight:"‚ôò",pawn:"‚ôô"},black:{king:"‚ôö",queen:"‚ôõ",rook:"‚ôú",bishop:"‚ôù",knight:"‚ôû",pawn:"‚ôü"}}[e.color][e.type]}async function jr(e,t,n,o){if(n.gameOver||n.currentPlayer==="black")return;const i=n.board[e][t];if(n.selectedSquare){const[r,a]=n.selectedSquare;if(r===e&&a===t){n.selectedSquare=null,n.possibleMoves=[],rn(n);return}if(n.possibleMoves.some(s=>s.row===e&&s.col===t)){qt(n,r,a,e,t),n.selectedSquare=null,n.possibleMoves=[],n.gameOver||(n.currentPlayer=n.currentPlayer==="white"?"black":"white"),await an(n),Li(n)&&(n.gameOver=!0,n.winner=Ai(n),Di(n)),no(n,o);return}}i&&i.color===n.currentPlayer&&(n.selectedSquare=[e,t],n.possibleMoves=xi(n,e,t),rn(n))}function rn(e){const t=document.querySelectorAll(".chess-square"),i=(window.innerWidth<600?Math.min(window.innerWidth-60,480):480)/8;t.forEach(r=>{const a=parseInt(r.dataset.row),s=parseInt(r.dataset.col);r.className=`chess-square flex items-center justify-center cursor-pointer text-4xl font-bold select-none ${(a+s)%2===0?"bg-amber-100":"bg-amber-600"}`,r.style.width=`${i}px`,r.style.height=`${i}px`,e.selectedSquare&&e.selectedSquare[0]===a&&e.selectedSquare[1]===s&&(r.className+=" bg-blue-300"),e.possibleMoves.some(l=>l.row===a&&l.col===s)&&(r.className+=" bg-green-300")})}function xi(e,t,n){const o=e.board[t][n];if(!o)return[];const i=[];switch(o.type){case"pawn":i.push(...Yr(e.board,t,n,o.color)),i.push(...Ur(e,t,n));break;case"rook":i.push(...oo(e.board,t,n,o.color));break;case"knight":i.push(...ki(e.board,t,n,o.color));break;case"bishop":i.push(...io(e.board,t,n,o.color));break;case"queen":i.push(...Ei(e.board,t,n,o.color));break;case"king":i.push(...Gr(e.board,t,n,o.color));break}return i}function Ur(e,t,n){const o=e.board[t][n];if(o.type!=="pawn"||!e.enPassantTarget)return[];const i=[],r=o.color==="white"?-1:1,a=e.enPassantTarget.row,s=e.enPassantTarget.col;return t===a-r&&Math.abs(n-s)===1&&i.push({row:a,col:s}),i}function Yr(e,t,n,o){const i=[],r=o==="white"?-1:1,a=o==="white"?6:1;nt(t+r,n)&&!e[t+r][n]&&(i.push({row:t+r,col:n}),t===a&&!e[t+2*r][n]&&i.push({row:t+2*r,col:n}));for(const s of[-1,1]){const l=t+r,c=n+s;nt(l,c)&&e[l][c]&&e[l][c].color!==o&&i.push({row:l,col:c})}return i}function oo(e,t,n,o){const i=[],r=[[0,1],[0,-1],[1,0],[-1,0]];for(const[a,s]of r)for(let l=1;l<8;l++){const c=t+l*a,f=n+l*s;if(!nt(c,f))break;if(!e[c][f])i.push({row:c,col:f});else{e[c][f].color!==o&&i.push({row:c,col:f});break}}return i}function ki(e,t,n,o){const i=[],r=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];for(const[a,s]of r){const l=t+a,c=n+s;nt(l,c)&&(!e[l][c]||e[l][c].color!==o)&&i.push({row:l,col:c})}return i}function io(e,t,n,o){const i=[],r=[[1,1],[1,-1],[-1,1],[-1,-1]];for(const[a,s]of r)for(let l=1;l<8;l++){const c=t+l*a,f=n+l*s;if(!nt(c,f))break;if(!e[c][f])i.push({row:c,col:f});else{e[c][f].color!==o&&i.push({row:c,col:f});break}}return i}function Ei(e,t,n,o){return[...oo(e,t,n,o),...io(e,t,n,o)]}function Gr(e,t,n,o){const i=[],r=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const[a,s]of r){const l=t+a,c=n+s;nt(l,c)&&(!e[l][c]||e[l][c].color!==o)&&i.push({row:l,col:c})}return i}function nt(e,t){return e>=0&&e<8&&t>=0&&t<8}function qt(e,t,n,o,i){const r=e.board[t][n],a=e.board[o][i];if(e.enPassantTarget=null,a&&a.type==="king"&&(e.gameOver=!0,e.winner=r.color),r.type==="pawn"&&n!==i&&!a){const s=r.color==="white"?o+1:o-1;e.board[s][i]=null}if(r.type==="pawn"&&Math.abs(o-t)===2){const s=r.color==="white"?o+1:o-1;e.enPassantTarget={row:s,col:i}}r.type==="pawn"&&(o===0||o===7)&&(r.type="queen"),r.type==="pawn"||a?e.halfMoveClock=0:e.halfMoveClock++,r.color==="black"&&e.fullMoveNumber++,e.board[o][i]=r,e.board[t][n]=null,e.moveHistory.push({from:{row:t,col:n},to:{row:o,col:i},piece:{...r},captured:a,enPassantTarget:e.enPassantTarget,halfMoveClock:e.halfMoveClock})}async function Si(e,t){let n;switch(e.difficulty){case"easy":n=Kr(e,"black");break;case"medium":n=To(e,"black",2);break;case"hard":n=To(e,"black",3);break}n&&(qt(e,n.from.row,n.from.col,n.to.row,n.to.col),e.gameOver||(e.currentPlayer="white"),Li(e)&&(e.gameOver=!0,e.winner=Ai(e),Di(e)),await an(e),no(e,t))}function Kr(e,t){const n=Nt(e,t);return n.length>0?n[Math.floor(Math.random()*n.length)]:null}function To(e,t,n=2){const o=t,i=1e9;let r=null,a=-i;const s=Ii(e,Nt(e,t));for(const l of s){const c=ro(e);qt(c,l.from.row,l.from.col,l.to.row,l.to.col),c.currentPlayer="white";const f=-Ci(c,n-1,-i,i,"white",o);f>a&&(a=f,r=l)}return r}function Ci(e,t,n,o,i,r){const s=ut(e.board,r),l=ut(e.board,"white");if(!s)return-1e9+(3-t);if(!l)return 1e9-(3-t);if(t===0)return $o(e,r);const c=Nt(e,i);if(c.length===0)return(i===r?-1:1)*-10+$o(e,r);let f=i===r?-1e9:1e9;const p=Ii(e,c);for(const d of p){const u=ro(e);qt(u,d.from.row,d.from.col,d.to.row,d.to.col),u.currentPlayer=i==="white"?"black":"white";const m=Ci(u,t-1,n,o,u.currentPlayer,r);if(i===r?(m>f&&(f=m),f>n&&(n=f)):(m<f&&(f=m),f<o&&(o=f)),n>=o)break}return f}function Nt(e,t){const n=[];for(let o=0;o<8;o++)for(let i=0;i<8;i++){const r=e.board[o][i];if(r&&r.color===t){const a=Zr(e,o,i);for(const s of a)n.push({from:{row:o,col:i},to:{row:s.row,col:s.col}})}}return n}function Ii(e,t){const n=e.currentPlayer==="white"?"black":"white";return ut(e.board,n),t.sort((o,i)=>Fo(e,i)-Fo(e,o))}function Fo(e,t){const n=e.board[t.from.row][t.from.col],o=e.board[t.to.row][t.to.col];let i=0;o&&(i+=10*Qt(o.type)-Qt(n.type)*.1),n.type==="pawn"&&(i+=.2*(n.color==="white"?7-t.to.row:t.to.row)),(n.type==="knight"||n.type==="bishop")&&(i+=.3),t.to.row>=2&&t.to.row<=5&&t.to.col>=2&&t.to.col<=5&&(i+=.2);const r=ro(e);qt(r,t.from.row,t.from.col,t.to.row,t.to.col),Pt(r,t.to.row,t.to.col,n.color)&&(i-=Math.min(1.5,Qt(n.type)*.6));const s=n.color==="white"?"black":"white",l=ut(r.board,s);return l&&Pt(r,l.row,l.col,s)&&Pt(r,l.row,l.col,s),l&&Mi(r,t.to.row,t.to.col,l.row,l.col)&&(i+=1),i}function ro(e){return{board:e.board.map(t=>t.map(n=>n?{...n}:null)),currentPlayer:e.currentPlayer,difficulty:e.difficulty,gameOver:e.gameOver,winner:e.winner,moveHistory:e.moveHistory?[...e.moveHistory]:[],selectedSquare:null,possibleMoves:[],gameStarted:e.gameStarted,enPassantTarget:e.enPassantTarget?{...e.enPassantTarget}:null,halfMoveClock:e.halfMoveClock,fullMoveNumber:e.fullMoveNumber}}function $o(e,t){let n=0;for(let l=0;l<8;l++)for(let c=0;c<8;c++){const f=e.board[l][c];if(!f)continue;const p=Qt(f.type),d=Xr(f,l,c),u=(f.color===t?1:-1)*(p+d);n+=u}const o=Nt(e,t).length,i="white",r=Nt(e,i).length;n+=.05*(o-r);const a=ut(e.board,t),s=ut(e.board,i);return a&&Pt(e,a.row,a.col,t)&&(n-=1.5),s&&Pt(e,s.row,s.col,i)&&(n+=1),n}function Xr(e,t,n){let o=0;return t>=2&&t<=5&&n>=2&&n<=5&&(o+=.2),e.type==="pawn"?o+=.05*(e.color==="white"?7-t:t):e.type==="knight"||e.type==="bishop"?o+=.1:(e.type==="rook"||e.type==="queen")&&(o+=.05),o}function Qt(e){return{pawn:1,knight:3,bishop:3,rook:5,queen:9,king:100}[e]||0}function Li(e){if(e.gameOver)return!0;let t=!1,n=!1;for(let o=0;o<8;o++)for(let i=0;i<8;i++){const r=e.board[o][i];r&&r.type==="king"&&(r.color==="white"&&(t=!0),r.color==="black"&&(n=!0))}return t?n?!1:(e.gameOver=!0,e.winner="white",!0):(e.gameOver=!0,e.winner="black",!0)}function Vr(e,t){const n=ut(e.board,t);if(!n)return!1;const o=t==="white"?"black":"white";for(let i=0;i<8;i++)for(let r=0;r<8;r++){const a=e.board[i][r];if(a&&a.color===o&&Qr(e.board,i,r).some(l=>l.row===n.row&&l.col===n.col))return!0}return!1}function ut(e,t){for(let n=0;n<8;n++)for(let o=0;o<8;o++){const i=e[n][o];if(i&&i.type==="king"&&i.color===t)return{row:n,col:o}}return null}function Zr(e,t,n){if(!e.board[t][n])return[];const i=xi(e,t,n),r=[];for(const a of i)Jr(e,t,n,a.row,a.col)&&r.push(a);return r}function Jr(e,t,n,o,i){const r=e.board.map(l=>l.map(c=>c?{...c}:null)),a=r[t][n];r[o][i],r[o][i]=a,r[t][n]=null;const s={...e,board:r};return!Vr(s,a.color)}function Pt(e,t,n,o){const i=o==="white"?"black":"white";for(let r=0;r<8;r++)for(let a=0;a<8;a++){const s=e.board[r][a];if(s&&s.color===i&&Mi(e,r,a,t,n))return!0}return!1}function Mi(e,t,n,o,i){const r=e.board[t][n];if(!r)return!1;const a=o-t,s=i-n,l=Math.abs(a),c=Math.abs(s);switch(r.type){case"pawn":const f=r.color==="white"?-1:1;return a===f&&c===1;case"rook":return a===0||s===0?Wn(e,t,n,o,i):!1;case"bishop":return l===c?Wn(e,t,n,o,i):!1;case"queen":return a===0||s===0||l===c?Wn(e,t,n,o,i):!1;case"knight":return l===2&&c===1||l===1&&c===2;case"king":return l<=1&&c<=1&&!(a===0&&s===0);default:return!1}}function Wn(e,t,n,o,i){const r=o>t?1:o<t?-1:0,a=i>n?1:i<n?-1:0;let s=t+r,l=n+a;for(;s!==o||l!==i;){if(e.board[s][l]!==null)return!1;s+=r,l+=a}return!0}function Qr(e,t,n){const o=e[t][n];if(!o)return[];switch(o.type){case"pawn":return ea(e,t,n,o.color);case"rook":return oo(e,t,n,o.color);case"knight":return ki(e,t,n,o.color);case"bishop":return io(e,t,n,o.color);case"queen":return Ei(e,t,n,o.color);case"king":return ta(e,t,n,o.color);default:return[]}}function ea(e,t,n,o){const i=[],r=o==="white"?-1:1;for(const a of[-1,1]){const s=t+r,l=n+a;nt(s,l)&&i.push({row:s,col:l})}return i}function ta(e,t,n,o){const i=[],r=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const[a,s]of r){const l=t+a,c=n+s;nt(l,c)&&i.push({row:l,col:c})}return i}function Ai(e){return e.winner}function Di(e){!e||!e.winner||(e.winner==="white"?re("Congratulations ‚Äî you captured the king. You win.","info"):e.winner==="black"&&re("Your king was captured. You lose.","info"))}async function an(e){try{await B.setItem("chessGameState",e)}catch(t){console.warn("Failed to save chess game state:",t)}}async function na(){try{const e=await B.getItem("chessGameState");return e||null}catch(e){return console.warn("Failed to load chess game state:",e),null}}function oa(e){const t=document.createElement("button");t.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2";const n=document.createElement("span");return n.className="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3",n.textContent=e,t.appendChild(n),t}function ia(e,t=null,n=null){const o=document.createElement("select");return o.className="bg-white border-t-2 border-l-2 border-black border-b-2 border-r-2 border-gray-300 px-2 py-1",o.setAttribute("aria-label","Select game difficulty"),o.setAttribute("title","Choose the difficulty level for the chess game"),e.forEach(i=>{const r=document.createElement("option");typeof i=="string"?(r.value=i,r.textContent=i):(r.value=i.value,r.textContent=i.text||i.value),t!==null&&r.value===t&&(r.selected=!0),o.appendChild(r)}),n&&typeof n=="function"&&o.addEventListener("change",i=>n(i.target.value,i)),o}function Bi(){const e=document.getElementById("bombbroomer");if(e){const o=[...document.querySelectorAll("*")].filter(i=>getComputedStyle(i).zIndex>100&&getComputedStyle(i).zIndex<1e3).reduce((i,r)=>getComputedStyle(r).zIndex>getComputedStyle(i).zIndex?r:i);e.style.zIndex=`${parseInt(o.style.zIndex)+1}`;return}const t=se("Bombbroomer","",!1,"bombbroomer",!1,!1,{type:"integer",width:400,height:490},"App",null,"gray");Ti(t).catch(n=>{console.error("Error initializing Bombbroomer:",n)})}async function Ti(e){const t=e.querySelector(".p-2");t.className="p-2 bg-gray-200 h-full overflow-hidden",t.innerHTML="";let n=await ra();n||(n={grid:[],gameStarted:!1,gameOver:!1,gameWon:!1,bombs:10,flaggedCount:0,rows:9,cols:9,firstClick:!0,timer:0,timerInterval:null});let o=await B.getItem("bombbroomer-best-time")||null;const i=document.createElement("div");i.className="flex flex-col h-full bg-gray-200 pb-4";const r=document.createElement("div");r.className="bg-gray-200 border-b-2 border-gray-400 p-1 flex items-center space-x-4",r.style.borderStyle="inset";const a=document.createElement("button");a.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",a.textContent="Game",a.setAttribute("aria-label","Game menu options"),a.setAttribute("title","Access game options and settings");const s=document.createElement("button");s.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",s.textContent="New Game",s.setAttribute("aria-label","Start new game"),s.setAttribute("title","Start a new minesweeper game"),s.addEventListener("click",async()=>await _()),r.appendChild(s);const l=document.createElement("div");l.className="bg-gray-200 border-2 border-gray-400 p-2 flex justify-between items-center",l.style.borderStyle="inset";const c=document.createElement("div");c.className="bg-black text-red-500 px-2 py-1 font-mono text-lg border-2 border-gray-500",c.style.borderStyle="inset",c.id="bomb-counter",c.textContent="010";const f=document.createElement("button");f.className="w-8 h-8 bg-gray-200 border-2 border-gray-400 text-lg hover:bg-gray-300",f.style.borderStyle="outset",f.id="face-button",f.textContent="üôÇ",f.setAttribute("aria-label","New game - Click to restart"),f.setAttribute("title","Click to start a new game"),f.addEventListener("click",async()=>await _());const p=document.createElement("div");p.className="bg-black text-red-500 px-2 py-1 font-mono text-lg border-2 border-gray-500",p.style.borderStyle="inset",p.id="timer-display",p.textContent="000";const d=document.createElement("div");d.className="bg-black text-red-500 px-2 py-1 font-mono text-lg border-2 border-gray-500",d.style.borderStyle="inset",d.id="best-time-display",d.textContent=o?o.toString().padStart(3,"0"):"---",l.appendChild(c),l.appendChild(f),l.appendChild(p),l.appendChild(d);const u=document.createElement("div");u.className="flex-1 p-4 flex items-center justify-center";const m=document.createElement("div");m.className="grid grid-cols-9 gap-0 border-2 border-gray-400 bg-gray-300",m.style.borderStyle="inset",m.id="game-grid",u.appendChild(m),i.appendChild(r),i.appendChild(l),i.appendChild(u),t.appendChild(i);function g(){n.grid=[],n.gameStarted=!1,n.gameOver=!1,n.gameWon=!1,n.flaggedCount=0,n.firstClick=!0,n.timer=0,n.timerInterval&&clearInterval(n.timerInterval);for(let k=0;k<n.rows;k++){n.grid[k]=[];for(let L=0;L<n.cols;L++)n.grid[k][L]={isBomb:!1,isRevealed:!1,isFlagged:!1,neighborCount:0}}N(),I()}function x(k,L){let A=0;for(;A<n.bombs;){const M=Math.floor(Math.random()*n.rows),S=Math.floor(Math.random()*n.cols);!n.grid[M][S].isBomb&&!(M===k&&S===L)&&(n.grid[M][S].isBomb=!0,A++)}for(let M=0;M<n.rows;M++)for(let S=0;S<n.cols;S++)n.grid[M][S].isBomb||(n.grid[M][S].neighborCount=b(M,S))}function b(k,L){let A=0;for(let M=Math.max(0,k-1);M<=Math.min(n.rows-1,k+1);M++)for(let S=Math.max(0,L-1);S<=Math.min(n.cols-1,L+1);S++)(M!==k||S!==L)&&n.grid[M][S].isBomb&&A++;return A}function I(){const k=document.getElementById("game-grid");k.innerHTML="";for(let L=0;L<n.rows;L++)for(let A=0;A<n.cols;A++){const M=document.createElement("button");M.className="w-8 h-8 border border-gray-500 bg-gray-200 text-sm font-bold flex items-center justify-center",M.style.borderStyle="outset",M.dataset.row=L,M.dataset.col=A,M.setAttribute("aria-label",`Cell row ${L+1}, column ${A+1}`),M.setAttribute("title",`Minesweeper cell at row ${L+1}, column ${A+1}`);const S=n.grid[L][A];if(S.isRevealed){if(M.style.borderStyle="inset",M.className=M.className.replace("bg-gray-200","bg-gray-300"),S.isBomb)M.textContent="üí£",M.style.backgroundColor=n.gameOver?"#ff0000":"#gray-300";else if(S.neighborCount>0){M.textContent=S.neighborCount;const T=["","#0000ff","#008000","#ff0000","#800080","#800000","#008080","#000000","#808080"];M.style.color=T[S.neighborCount]||"#000000"}}else S.isFlagged&&(M.textContent="üö©");M.addEventListener("click",async T=>await h(T,L,A)),M.addEventListener("contextmenu",async T=>await H(T,L,A)),k.appendChild(M)}}async function h(k,L,A){if(k.preventDefault(),n.gameOver||n.gameWon)return;const M=n.grid[L][A];M.isRevealed||M.isFlagged||(n.firstClick&&(x(L,A),n.firstClick=!1,n.gameStarted=!0,j()),M.isBomb?await $():(O(L,A),await F()),I(),await Bt(n))}async function H(k,L,A){if(k.preventDefault(),n.gameOver||n.gameWon)return;const M=n.grid[L][A];M.isRevealed||(M.isFlagged?(M.isFlagged=!1,n.flaggedCount--):(M.isFlagged=!0,n.flaggedCount++),N(),I(),await Bt(n))}function O(k,L){const A=n.grid[k][L];if(!(A.isRevealed||A.isFlagged)&&(A.isRevealed=!0,A.neighborCount===0))for(let M=Math.max(0,k-1);M<=Math.min(n.rows-1,k+1);M++)for(let S=Math.max(0,L-1);S<=Math.min(n.cols-1,L+1);S++)(M!==k||S!==L)&&O(M,S)}function j(){n.timerInterval=setInterval(async()=>{n.timer++,N(),await Bt(n)},1e3)}async function $(){n.gameOver=!0,n.timerInterval&&clearInterval(n.timerInterval);for(let k=0;k<n.rows;k++)for(let L=0;L<n.cols;L++)n.grid[k][L].isBomb&&(n.grid[k][L].isRevealed=!0);await Bt(n),document.getElementById("face-button").textContent="üòµ",setTimeout(()=>{showDialogBox("Game Over! Try again?","confirmation")},500)}async function F(){let k=0;for(let A=0;A<n.rows;A++)for(let M=0;M<n.cols;M++)n.grid[A][M].isRevealed&&!n.grid[A][M].isBomb&&k++;const L=n.rows*n.cols-n.bombs;k===L&&(n.gameWon=!0,n.timerInterval&&clearInterval(n.timerInterval),(o===null||n.timer<o)&&(o=n.timer,B.setItemSync("bombbroomer-best-time",o),document.getElementById("best-time-display").textContent=o.toString().padStart(3,"0"),window.isDevvit&&window.parent.postMessage({type:"setGameScore",data:{game:"bombbroomer",score:o}},"*")),await Bt(n),document.getElementById("face-button").textContent="üòé",setTimeout(()=>{showDialogBox("Congratulations! You won!","confirmation")},500))}function N(){const k=document.getElementById("bomb-counter"),L=document.getElementById("timer-display"),A=n.bombs-n.flaggedCount;k.textContent=A.toString().padStart(3,"0"),L.textContent=Math.min(n.timer,999).toString().padStart(3,"0")}async function _(){document.getElementById("face-button").textContent="üôÇ",g(),await aa()}function V(){const k=document.getElementById("face-button");n.gameOver?k.textContent="üòµ":n.gameWon?k.textContent="üòé":k.textContent="üôÇ",n.gameStarted&&!n.gameOver&&!n.gameWon&&j(),N(),I()}const Z=new MutationObserver(k=>{k.forEach(L=>{L.removedNodes.forEach(A=>{A.id==="bombbroomer"&&(n.timerInterval&&clearInterval(n.timerInterval),Z.disconnect())})})});Z.observe(document.getElementById("windows-container"),{childList:!0}),n.grid.length===0?_():V()}async function Bt(e){try{const t={...e,timerInterval:null};await B.setItem("bombbroomer_gameState",t)}catch(t){console.warn("Failed to save Bombbroomer game state:",t)}}async function ra(){try{const e=await B.getItem("bombbroomer_gameState");if(e){const t=e;return t.timerInterval=null,t}}catch(e){console.warn("Failed to load Bombbroomer game state:",e)}return null}async function aa(){try{await B.removeItem("bombbroomer_gameState")}catch(e){console.warn("Failed to clear Bombbroomer game state:",e)}}function Fi(){const e=document.getElementById("mediaplayer");if(e){const o=[...document.querySelectorAll("*")].filter(i=>getComputedStyle(i).zIndex>100&&getComputedStyle(i).zIndex<1e3).reduce((i,r)=>getComputedStyle(r).zIndex>getComputedStyle(i).zIndex?r:i);e.style.zIndex=`${parseInt(o.style.zIndex)+1}`;return}const t=se("Media Player","",!1,"mediaplayer",!1,!1,{type:"integer",width:500,height:400},"App",null,"gray");$i(t).catch(console.error)}async function $i(e){const t=e.querySelector(".p-2");t.className="p-2 bg-gray-200 h-full flex",t.innerHTML="";let n=await ao();n?((!isFinite(n.volume)||n.volume<0||n.volume>1)&&(n.volume=.5),(!isFinite(n.currentTime)||n.currentTime<0)&&(n.currentTime=0),Number.isInteger(n.currentTrackIndex)||(n.currentTrackIndex=-1),Array.isArray(n.playlist)||(n.playlist=[])):n={currentTrackIndex:-1,currentTime:0,volume:.5,isPlaying:!1,playlist:[]};const o=document.createElement("div");o.className="w-1/2 bg-white border-2 border-gray-400 mr-2 flex flex-col",o.innerHTML=`
    <div class="bg-gray-300 border-b-2 border-gray-400 p-2 flex justify-between items-center">
      <div class="text-xs font-bold">Media Playlist:</div>
      <button id="add-song-btn" onclick="setTimeout(function(){toggleButtonActiveState('add-song-btn', 'Add Media')}, 1000);toggleButtonActiveState('add-song-btn', 'Adding media...');" class="bg-gray-200 border-t-2 border-l-2 border-gray-300"><span class="border-b-2 border-r-2 border-black block h-full w-full py-1 px-2 text-xs">Add</span></button>
      <input type="file" id="song-file-input" class="hidden" accept="audio/*,video/*">
    </div>
    <div id="playlist-container" class="flex-1 p-2 overflow-y-auto space-y-1">
      <div class="text-xs text-gray-500">Loading playlist...</div>
    </div>
  `;const i=document.createElement("div");i.className="w-1/2 flex flex-col";const r=document.createElement("div");r.id="media-container",r.className="w-full bg-black mb-2 flex items-center justify-center min-h-32",r.innerHTML=`
    <audio id="audio-player" class="w-full hidden"></audio>
    <video id="video-player" class="w-full max-h-48 hidden" controls></video>
    <div id="audio-placeholder" class="text-white text-2xl p-4 flex items-center justify-center" style="display: none;">üéµ üé∂ üéµ</div>
    <div id="media-placeholder" class="text-white text-sm p-4">No media selected</div>
  `,i.appendChild(r);const a=document.createElement("div");a.className="bg-gray-300 border-2 border-gray-400 p-3 mb-2";const s=document.createElement("div");s.className="text-center mb-2",s.innerHTML=`
    <div id="current-track-name" class="font-bold text-sm">Media Player</div>
    <div id="current-time" class="text-xs text-gray-600">Ready to play</div>
  `;const l=document.createElement("div");l.className="mb-3",l.innerHTML=`
    <div id="progress-container" class="w-full h-2 bg-gray-400 border border-gray-500 cursor-pointer">
      <div id="progress-bar" class="h-full bg-blue-500" style="width: 0%"></div>
    </div>
  `;const c=document.createElement("div");c.className="flex justify-center space-x-2 mb-2",c.innerHTML=`
    <button id="prev-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs" aria-label="Previous track" title="Play previous track">‚èÆ</button>
    <button id="play-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs" aria-label="Play" title="Play/pause current track">‚ñ∂</button>
    <button id="stop-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs" aria-label="Stop" title="Stop playback">‚èπ</button>
    <button id="next-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs" aria-label="Next track" title="Play next track">‚è≠</button>
  `;const f=document.createElement("div");f.className="flex items-center justify-center space-x-2",f.innerHTML=`
    <span class="text-xs">üîä</span>
    <input type="range" id="volume-control" min="0" max="1" step="0.01" value="0.5" class="w-20" aria-label="Volume control" title="Adjust playback volume">
    <span class="text-xs" id="volume-display">50%</span>
  `,a.appendChild(s),a.appendChild(l),a.appendChild(c),a.appendChild(f),i.appendChild(a),t.appendChild(o),t.appendChild(i);const p=t.querySelector("#audio-player"),d=t.querySelector("#video-player");let u=n.currentTrackIndex,m=n.playlist;const g=t.querySelector("#play-btn"),x=t.querySelector("#next-btn"),b=t.querySelector("#prev-btn"),I=t.querySelector("#stop-btn"),h=t.querySelector("#volume-control"),H=t.querySelector("#progress-bar"),O=t.querySelector("#progress-container"),j=t.querySelector("#add-song-btn"),$=t.querySelector("#song-file-input");let F;const N="media_player_db",_="songs";function V(){const v=indexedDB.open(N,1);v.onerror=E=>{console.error("Database error: ",E.target.errorCode)},v.onupgradeneeded=E=>{F=E.target.result,F.createObjectStore(_,{keyPath:"id",autoIncrement:!0}).createIndex("name","name",{unique:!1})},v.onsuccess=E=>{F=E.target.result,k().catch(console.error)}}function Z(v){const E=v.name.split(".").pop().toLowerCase();wo(v.name,"","C://Media",E,v).then(z=>{z?k().catch(console.error):console.error("üéµ MEDIAPLAYER: Failed to add song to file system")}).catch(z=>{console.error("üéµ MEDIAPLAYER: Error adding song to file system:",z)})}async function k(){m=[];try{const z=le().folders["C://Media"];if(z){const U=Object.entries(z).filter(([q,ce])=>q!=="contents"&&ce&&typeof ce=="object"&&ce.type).map(([q,ce])=>ce).map(async q=>{if(q.content_type&&["mp3","wav","audio","mp4","webm","avi","mov"].includes(q.content_type)){const ce=["mp4","webm","avi","mov"].includes(q.content_type),he={name:q.name,file:q.file,id:q.id,isFileSystem:!0,source:"filesystem",isVideo:ce,contentType:q.content_type,type:q.file&&q.file.type?q.file.type:ce?"video/"+q.content_type:"audio/"+q.content_type};if(q.storageLocation==="indexeddb"&&!q.dataURL||!q.dataURL&&!q.file&&!q.path&&q.id&&q.id.startsWith("file-"))try{const Be=await storage.getItem(`file_data_${q.id}`);if(Be){q.dataURL=Be,he.dataURL=Be;const Le=le();Le.folders["C://Media"]&&Le.folders["C://Media"][q.id]&&(Le.folders["C://Media"][q.id].dataURL=Be,Le.folders["C://Media"][q.id].tempObjectURL=null,setFileSystemState(Le))}else{console.warn("üéµ MEDIAPLAYER: No stored data found in IndexedDB for:",q.name,"File ID:",q.id);const Le=`file_data_${q.name}`,Ge=await storage.getItem(Le);Ge&&(q.dataURL=Ge,he.dataURL=Ge)}}catch(Be){console.error("üéµ MEDIAPLAYER: Failed to load data from IndexedDB for:",q.name,Be)}return(q.isDefault||q.isSystemFile)&&q.path?(he.path=q.path,he.isDefault=q.isDefault,he.isSystemFile=q.isSystemFile):q.dataURL||he.dataURL?he.dataURL=q.dataURL||he.dataURL:q.file?he.file=q.file:q.tempObjectURL?he.tempObjectURL=q.tempObjectURL:he.path=`media/${q.name}`,he}return null});m=(await Promise.all(U)).filter(q=>q!==null)}}catch(E){console.error("Could not load songs from file system:",E)}m.some(E=>E.name==="too_many_screws_final.mp3")||m.unshift({name:"too_many_screws_final.mp3",path:"media/too_many_screws_final.mp3",isDefault:!0,id:"fallback-default-song",source:"fallback"}),L(),m.length>0&&(n.currentTrackIndex>=0&&n.currentTrackIndex<m.length?(A(n.currentTrackIndex),p.addEventListener("loadedmetadata",()=>{p.currentTime=n.currentTime||0},{once:!0})):A(0))}function L(){const v=t.querySelector("#playlist-container");v.innerHTML="",m.forEach((E,z)=>{const C=document.createElement("div");C.className="text-xs cursor-pointer hover:bg-gray-100 p-1 rounded";const U=E.name||E.id||"Unknown Track";E.name||console.warn("üéµ MEDIAPLAYER: Track missing name property, using fallback:",U,"Track:",E),C.textContent=U,C.dataset.index=z,C.addEventListener("click",()=>{A(z),S()}),v.appendChild(C)})}function A(v){if(v<0||v>=m.length)return;u=v,n.currentTrackIndex=u;const E=m[v],z=E.type&&E.type.startsWith("video/")||E.contentType&&["mp4","webm","avi","mov"].includes(E.contentType)||E.isVideo===!0||E.file&&E.file.type&&E.file.type.startsWith("video/");p.style.display="none",d.style.display="none";const C=t.querySelector("#media-placeholder"),U=t.querySelector("#audio-placeholder");C&&(C.style.display="none"),U&&(U.style.display="none");const Y=z?d:p,q=z?p:d;if(z?Y.style.display="block":U&&(U.style.display="flex"),q.pause(),q.currentTime=0,E.isDefault||E.path&&!E.file&&!E.dataURL)Y.src=E.path;else if(E.dataURL)Y.src=E.dataURL;else if(E.tempObjectURL)Y.src=E.tempObjectURL;else if(E.isFileSystem&&E.file){const ce=URL.createObjectURL(E.file);Y.src=ce}else if(E.file){const ce=URL.createObjectURL(E.file);Y.src=ce}else{console.error("Unable to load track - no valid source:",E);return}t.querySelector("#current-track-name").textContent=E.name||E.id||"Unknown Track",M(),Ve(n).catch(console.error)}function M(){t.querySelectorAll("#playlist-container > div").forEach((E,z)=>{z===u?E.classList.add("bg-blue-200"):E.classList.remove("bg-blue-200")})}function S(){const E=T().play();E!==void 0&&E.catch(z=>{z.name==="AbortError"||console.error("Playback failed:",z)})}function T(){return d.style.display==="block"?d:p}function X(){const v=T();v.paused?S():v.pause()}function ee(){const v=T();v.pause(),v.currentTime=0}function oe(){const v=(u+1)%m.length;A(v),S()}function te(){const v=(u-1+m.length)%m.length;A(v),S()}function ie(){const v=T();v.volume=h.value;const E=v===p?d:p;E.volume=h.value,n.volume=v.volume,t.querySelector("#volume-display").textContent=`${Math.round(h.value*100)}%`,Ve(n).catch(console.error)}function we(){const v=T();if(v.duration){const E=v.currentTime/v.duration*100;H.style.width=`${E}%`;const z=C=>{const U=Math.floor(C/60),Y=Math.floor(C%60).toString().padStart(2,"0");return`${U}:${Y}`};t.querySelector("#current-time").textContent=`${z(v.currentTime)} / ${z(v.duration)}`}}function Ee(v){const E=T();if(!E.duration)return;const z=v.offsetX,C=O.offsetWidth;E.currentTime=z/C*E.duration}g.addEventListener("click",X),p.addEventListener("play",()=>g.textContent="‚è∏"),p.addEventListener("pause",()=>g.textContent="‚ñ∂"),p.addEventListener("ended",oe),p.addEventListener("timeupdate",we),p.addEventListener("volumechange",()=>{h.value=p.volume,ie()}),d.addEventListener("play",()=>g.textContent="‚è∏"),d.addEventListener("pause",()=>g.textContent="‚ñ∂"),d.addEventListener("ended",oe),d.addEventListener("timeupdate",we),d.addEventListener("volumechange",()=>{h.value=d.volume,ie()}),p.addEventListener("error",v=>{console.error("üéµ MEDIAPLAYER: Audio error:",v.target.error,"Source:",p.src)}),d.addEventListener("error",v=>{console.error("üéµ MEDIAPLAYER: Video error:",v.target.error,"Source:",d.src)}),p.addEventListener("loadstart",()=>{}),d.addEventListener("loadstart",()=>{}),I.addEventListener("click",ee),x.addEventListener("click",oe),b.addEventListener("click",te),h.addEventListener("input",ie),O.addEventListener("click",Ee),j.addEventListener("click",()=>$.click()),$.addEventListener("change",v=>{const E=v.target.files[0];E&&Z(E)});const ve=isFinite(n.volume)&&n.volume>=0&&n.volume<=1?n.volume:.5;h.value=ve,p.volume=ve,d.volume=ve,t.querySelector("#volume-display").textContent=`${Math.round(ve*100)}%`,n.volume=ve,p.addEventListener("timeupdate",()=>{p.style.display==="block"&&(n.currentTime=p.currentTime,Math.floor(p.currentTime)%5===0&&Ve(n).catch(console.error))}),p.addEventListener("play",()=>{p.style.display==="block"&&(n.isPlaying=!0,Ve(n).catch(console.error))}),p.addEventListener("pause",()=>{p.style.display==="block"&&(n.isPlaying=!1,Ve(n).catch(console.error))}),d.addEventListener("timeupdate",()=>{d.style.display==="block"&&(n.currentTime=d.currentTime,Math.floor(d.currentTime)%5===0&&Ve(n).catch(console.error))}),d.addEventListener("play",()=>{d.style.display==="block"&&(n.isPlaying=!0,Ve(n).catch(console.error))}),d.addEventListener("pause",()=>{d.style.display==="block"&&(n.isPlaying=!1,Ve(n).catch(console.error))}),V(),ie(),n.currentTrackIndex>=0&&m.length>n.currentTrackIndex&&setTimeout(async()=>{await Pi()},500),window.refreshMediaPlayerPlaylist=function(){F&&k().catch(console.error)};const R=setInterval(()=>{try{const E=le().folders["C://Media"];if(E){const z=Object.values(E).filter(Y=>Y.content_type&&["mp3","wav","audio","mp4","webm","avi","mov"].includes(Y.content_type)).map(Y=>Y.name),C=m.filter(Y=>Y.source==="filesystem"||Y.isFileSystem).map(Y=>Y.name);z.filter(Y=>!C.includes(Y)).length>0&&k().catch(console.error)}}catch{}},1e4),y=e,w=y.remove;y.remove=function(){return clearInterval(R),window.refreshMediaPlayerPlaylist===window.refreshMediaPlayerPlaylist&&delete window.refreshMediaPlayerPlaylist,w.call(this)}}async function Pi(){const e=await ao();if(!(!e||e.currentTrackIndex<0)&&playlist.length>e.currentTrackIndex){let n=function(){const o=getActivePlayer();e.currentTime>0&&(o.currentTime=e.currentTime),e.isPlaying&&safePlay()};var t=n;loadTrack(e.currentTrackIndex),audio.addEventListener("loadedmetadata",function o(){audio.style.display==="block"&&n(),audio.removeEventListener("loadedmetadata",o)}),video.addEventListener("loadedmetadata",function o(){video.style.display==="block"&&n(),video.removeEventListener("loadedmetadata",o)})}}async function Ve(e){try{await storage.setItem("mediaplayer_state",e)}catch(t){console.warn("Failed to save Media Player state:",t);try{storage.setItemSync("mediaplayer_state",e)}catch(n){console.error("Failed to save Media Player state with fallback:",n)}}}async function ao(){try{const e=await storage.getItem("mediaplayer_state");if(e)return e}catch(e){console.warn("Failed to load Media Player state:",e);try{const t=storage.getItemSync("mediaplayer_state");if(t)return t}catch(t){console.warn("Failed to load Media Player state with fallback:",t)}}return null}async function sa(){try{await storage.removeItem("mediaplayer_state")}catch(e){console.warn("Failed to clear Media Player state:",e);try{storage.removeItemSync("mediaplayer_state")}catch(t){console.error("Failed to clear Media Player state with fallback:",t)}}}class la{constructor(){this.shortcuts=new Map,this.customMappings=new Map,this.isInitialized=!1,this.preventDefaults=new Set,this.sequenceBuffer=[],this.sequenceTimer=null,this.shortcutMode=!1,this.sequenceMap={"g w":()=>typeof window.cycleWindows=="function"&&window.cycleWindows(),"g d":()=>typeof window.minimizeAllWindows=="function"&&window.minimizeAllWindows(),"g s":()=>typeof window.toggleStartMenu=="function"&&window.toggleStartMenu(),"w c":()=>typeof window.closeActiveWindow=="function"&&window.closeActiveWindow(),"w m":()=>typeof window.minimizeActiveWindow=="function"&&window.minimizeActiveWindow()},this.shortcutModeMap={c:()=>typeof window.closeActiveWindow=="function"&&window.closeActiveWindow(),m:()=>typeof window.minimizeActiveWindow=="function"&&window.minimizeActiveWindow(),x:()=>{var t;return typeof window.toggleFullScreen=="function"&&window.toggleFullScreen((t=window.getActiveWindowId)==null?void 0:t.call(window))},s:()=>typeof window.toggleStartMenu=="function"&&window.toggleStartMenu(),d:()=>typeof window.minimizeAllWindows=="function"&&window.minimizeAllWindows()},this.defaultShortcuts={"global.toggleStartMenu":{key:"Alt+S",description:"Open/Close Start Menu"},"global.cycleWindows":{key:"Alt+W",description:"Cycle open windows"},"global.minimizeActiveWindow":{key:"Alt+M",description:"Minimize active window"},"global.closeActiveWindow":{key:"Alt+Q",description:"Close active window"},"global.showDesktop":{key:"Alt+D",description:"Show desktop (minimize all)"},"fileExplorer.rename":{key:"Alt+R",description:"Rename selected file"},"global.escapeAction":{key:"Escape",description:"Close menus/dialogs"},"global.toggleShortcutMode":{key:"Alt+K",description:"Enter Shortcut Mode"},"desktop.activateIcon":{key:"Enter",description:"Activate selected desktop icon"},"desktop.moveUp":{key:"ArrowUp",description:"Move icon up"},"desktop.moveDown":{key:"ArrowDown",description:"Move icon down"},"desktop.moveLeft":{key:"ArrowLeft",description:"Move icon left"},"desktop.moveRight":{key:"ArrowRight",description:"Move icon right"},"desktop.fineMoveUp":{key:"Shift+ArrowUp",description:"Fine move icon up"},"desktop.fineMoveDown":{key:"Shift+ArrowDown",description:"Fine move icon down"},"desktop.fineMoveLeft":{key:"Shift+ArrowLeft",description:"Fine move icon left"},"desktop.fineMoveRight":{key:"Shift+ArrowRight",description:"Fine move icon right"},"startMenu.navigateDown":{key:"ArrowDown",description:"Navigate down in start menu"},"startMenu.navigateUp":{key:"ArrowUp",description:"Navigate up in start menu"},"startMenu.enterSubmenu":{key:"ArrowRight",description:"Enter submenu"},"startMenu.exitSubmenu":{key:"ArrowLeft",description:"Exit submenu"},"startMenu.activateItem":{key:"Enter",description:"Activate start menu item"},"startMenu.close":{key:"Escape",description:"Close start menu"}}}async initialize(){this.isInitialized||(await this.loadCustomMappings(),this.setupShortcuts(),this.setupGlobalKeyboardHandler(),this.isInitialized=!0,console.log("üéπ Keyboard service initialized with",this.shortcuts.size,"shortcuts"))}async loadCustomMappings(){var t;try{const o=(t=(await Re()).folders["C://Documents"])==null?void 0:t["keyboard_config.json"];if(o&&o.content){const i=JSON.parse(o.content);this.customMappings=new Map(Object.entries(i.customMappings||{})),console.log("üìã Loaded",this.customMappings.size,"custom keyboard mappings")}}catch(n){console.warn("‚ö†Ô∏è Could not load keyboard config:",n)}}async saveCustomMappings(){try{const t=await Re();t.folders["C://Documents"]||(t.folders["C://Documents"]={});const n={customMappings:Object.fromEntries(this.customMappings),timestamp:Date.now()};t.folders["C://Documents"]["keyboard_config.json"]={id:"keyboard_config.json",name:"keyboard_config.json",type:"file",content_type:"json",content:JSON.stringify(n,null,2),fullPath:"C://Documents/keyboard_config.json"},await Q(),console.log("üíæ Saved keyboard configuration")}catch(t){console.error("‚ùå Failed to save keyboard config:",t)}}setupShortcuts(){this.shortcuts.clear();for(const[t,n]of Object.entries(this.defaultShortcuts)){const o=this.customMappings.get(t);this.shortcuts.set(t,{...n,key:o||n.key,isCustom:!!o})}}setupGlobalKeyboardHandler(){document.removeEventListener("keydown",this.globalHandler),this.globalHandler=this.handleGlobalKeyboard.bind(this),document.addEventListener("keydown",this.globalHandler,!0)}handleGlobalKeyboard(t){const n=t.target,o=/input|textarea|select/i.test(n.tagName)||n.isContentEditable;if(/Mac|iPod|iPhone|iPad/.test(navigator.platform)&&t.metaKey)return;if(this.shortcutMode){if(t.key==="Escape"){this.shortcutMode=!1;return}if(!t.metaKey&&!t.ctrlKey&&!t.altKey){const s=t.key.toLowerCase(),l=this.shortcutModeMap[s];if(l){t.preventDefault(),l(),this.shortcutMode=!1;return}}}const r=this.getKeyCombo(t),a=this.getContext(t);for(const[s,l]of this.shortcuts.entries())if(this.matchesKeyCombo(r,l.key)&&this.isActionValidForContext(s,a)){t.preventDefault(),t.stopPropagation(),this.executeAction(s,t,a);return}if(!o&&!t.metaKey&&!t.ctrlKey&&!t.altKey&&t.key.length===1){this.sequenceBuffer.push(t.key.toLowerCase()),clearTimeout(this.sequenceTimer),this.sequenceTimer=setTimeout(()=>{this.sequenceBuffer=[]},650);const s=this.sequenceBuffer.join(" ");this.sequenceMap[s]?(t.preventDefault(),this.sequenceMap[s](),this.sequenceBuffer=[]):this.sequenceBuffer.length>2&&(this.sequenceBuffer=[])}}getKeyCombo(t){const n=[];t.ctrlKey&&n.push("Ctrl"),t.altKey&&n.push("Alt"),t.shiftKey&&n.push("Shift"),t.metaKey&&n.push("Meta");let o=t.key===" "?"Space":t.key;return t.altKey&&t.code&&t.code.startsWith("Key")&&(o=t.code.slice(3)),["Control","Alt","Shift","Meta"].includes(o)||n.push(o),n.join("+")}matchesKeyCombo(t,n){const o=i=>i.toLowerCase().replace(/\s+/g,"");return o(t)===o(n)}getContext(t){const n=t.target,o=[];return n.closest("#start-menu")&&o.push("startMenu"),n.closest("#context-menu")&&o.push("contextMenu"),n.closest(".file-explorer-window")&&o.push("fileExplorer"),n.closest(".draggable-icon")&&o.push("desktop"),n.closest("#window-tabs")&&o.push("taskbar"),n.closest('[role="dialog"]')&&o.push("window"),o.push("global"),o}isActionValidForContext(t,n){const o=t.split(".")[0];return n.includes(o)||o==="global"}async executeAction(t,n,o){console.log("üéπ Executing keyboard action:",t);try{switch(t){case"global.toggleStartMenu":typeof window.toggleStartMenu=="function"&&window.toggleStartMenu();break;case"global.toggleShortcutMode":this.shortcutMode=!this.shortcutMode,this.shortcutMode&&typeof window.showDialogBox=="function"&&window.showDialogBox("Shortcut Mode: c(close) m(minimize) x(max) s(start) d(desktop) Esc(cancel)","info");break;case"global.cycleWindows":typeof window.cycleWindows=="function"&&window.cycleWindows();break;case"global.closeActiveWindow":typeof window.closeActiveWindow=="function"&&window.closeActiveWindow();break;case"global.minimizeActiveWindow":typeof window.minimizeActiveWindow=="function"&&window.minimizeActiveWindow();break;case"global.showDesktop":typeof window.minimizeAllWindows=="function"&&window.minimizeAllWindows();break;case"global.escapeAction":this.handleGlobalEscape();break;case"desktop.activateIcon":case"desktop.activateIcon2":this.handleDesktopActivate(n);break;case"desktop.startDrag":this.handleDesktopStartDrag(n);break;case"desktop.cutIcon":this.handleDesktopCut(n);break;case"desktop.pasteIcon":this.handleDesktopPaste(n);break;case"desktop.escapeAction":this.handleDesktopEscape(n);break;case"desktop.moveUp":case"desktop.moveDown":case"desktop.moveLeft":case"desktop.moveRight":this.handleDesktopMove(n,t);break;case"desktop.fineMoveUp":case"desktop.fineMoveDown":case"desktop.fineMoveLeft":case"desktop.fineMoveRight":this.handleDesktopFineMove(n,t);break;case"startMenu.navigateDown":case"startMenu.navigateUp":case"startMenu.enterSubmenu":case"startMenu.exitSubmenu":case"startMenu.activateItem":case"startMenu.activateItem2":case"startMenu.close":case"startMenu.goToFirst":case"startMenu.goToLast":this.handleStartMenuAction(t,n);break;case"fileExplorer.rename":case"fileExplorer.delete":case"fileExplorer.open":case"fileExplorer.navigateDown":case"fileExplorer.navigateUp":case"fileExplorer.openContextMenu":case"fileExplorer.openContextMenu2":case"fileExplorer.openContextMenu3":this.handleFileExplorerAction(t,n);break;case"contextMenu.navigateDown":case"contextMenu.navigateUp":case"contextMenu.enterSubmenu":case"contextMenu.exitSubmenu":case"contextMenu.activateItem":case"contextMenu.activateItem2":case"contextMenu.close":this.handleContextMenuAction(t,n);break;case"window.minimize":case"window.maximize":case"window.close":this.handleWindowAction(t,n);break;case"taskbar.activateButton":case"taskbar.activateButton2":case"taskbar.mediaControl":case"taskbar.minimizeAll":this.handleTaskbarAction(t,n);break;default:console.warn("üéπ Unknown keyboard action:",t)}}catch(i){console.error("‚ùå Error executing keyboard action:",t,i)}}handleGlobalEscape(){const t=document.getElementById("start-menu"),n=document.getElementById("context-menu");if(t&&!t.classList.contains("hidden")){t.classList.add("hidden"),t.setAttribute("aria-hidden","true"),typeof window.updateStartMenuFocusability=="function"&&window.updateStartMenuFocusability(!1);const o=document.getElementById("start-button");o&&(o.setAttribute("aria-expanded","false"),o.focus())}n&&!n.classList.contains("hidden")&&n.classList.add("hidden")}handleDesktopActivate(t){const n=t.target.closest(".draggable-icon");n&&n.dispatchEvent(new MouseEvent("dblclick",{bubbles:!0}))}handleDesktopStartDrag(t){const n=t.target.closest(".draggable-icon");n&&typeof window.startKeyboardDrag=="function"&&window.startKeyboardDrag(n)}handleDesktopCut(t){const n=t.target.closest(".draggable-icon");n&&typeof window.cutIcon=="function"&&window.cutIcon(n)}handleDesktopPaste(t){typeof window.pasteIcon=="function"&&window.pasteIcon()}handleDesktopEscape(t){typeof window.endKeyboardDrag=="function"&&window.endKeyboardDrag(!1)}handleDesktopMove(t,n){const o=t.target.closest(".draggable-icon");if(!o)return;const i=n.split(".")[1].replace("move","").toLowerCase(),r={up:"ArrowUp",down:"ArrowDown",left:"ArrowLeft",right:"ArrowRight"};typeof window.moveIconWithKeyboard=="function"&&window.moveIconWithKeyboard(o,r[i])}handleDesktopFineMove(t,n){const o=t.target.closest(".draggable-icon");if(!o)return;const i=n.split(".")[1].replace("fineMove","").toLowerCase(),r=parseInt(o.style.left)||0,a=parseInt(o.style.top)||0,s=5;let l=r,c=a;switch(i){case"up":c=Math.max(16,a-s);break;case"down":c=a+s;break;case"left":l=Math.max(16,r-s);break;case"right":l=r+s;break}o.style.left=l+"px",o.style.top=c+"px",typeof window.constrainIconPosition=="function"&&window.constrainIconPosition(o),typeof window.desktopIconsState<"u"&&(window.desktopIconsState[o.id]={left:o.style.left,top:o.style.top}),typeof window.saveState=="function"&&window.saveState()}handleStartMenuAction(t,n){const o=t.split(".")[1],i=window.startMenuKeyboardNavState;i&&typeof i.handleAction=="function"&&i.handleAction(o,n)}handleFileExplorerAction(t,n){const o=t.split(".")[1];switch(o){case"rename":console.log("Rename functionality would trigger here");break;case"delete":console.log("Delete - Delete functionality would trigger here");break;case"open":const i=document.activeElement;i&&i.classList.contains("file-item")&&i.dispatchEvent(new MouseEvent("dblclick",{bubbles:!0}));break;case"navigateDown":case"navigateUp":const r=o==="navigateDown"?"down":"up",a=document.querySelector(".file-explorer-window:focus-within");a&&typeof window.navigateFileList=="function"&&window.navigateFileList(r,a);break;case"openContextMenu":case"openContextMenu2":case"openContextMenu3":const s=n.target,l=s.getBoundingClientRect(),c=new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,clientX:l.left+l.width/2,clientY:l.top+l.height/2,button:2});s.dispatchEvent(c);break}}handleContextMenuAction(t,n){const o=document.getElementById("context-menu");o&&typeof window.handleContextMenuNavigation=="function"&&window.handleContextMenuNavigation(n,o)}handleWindowAction(t,n){const o=t.split(".")[1],i=document.querySelector('[role="dialog"]:not([aria-hidden="true"])');if(!i)return;const r=i.id;switch(o){case"minimize":typeof window.minimizeWindow=="function"&&window.minimizeWindow(r);break;case"maximize":typeof window.toggleFullScreen=="function"&&window.toggleFullScreen(r);break;case"close":typeof window.closeWindow=="function"&&window.closeWindow(r);break}}handleTaskbarAction(t,n){switch(t.split(".")[1]){case"activateButton":case"activateButton2":const i=n.target.closest("button");i&&i.click();break;case"mediaControl":typeof window.toggleMediaPlayback=="function"&&window.toggleMediaPlayback();break;case"minimizeAll":typeof window.minimizeAllWindows=="function"&&window.minimizeAllWindows();break}}remapShortcut(t,n){if(!this.defaultShortcuts[t])throw new Error(`Unknown action: ${t}`);this.customMappings.set(t,n),this.setupShortcuts(),this.saveCustomMappings()}removeCustomMapping(t){this.customMappings.delete(t),this.setupShortcuts(),this.saveCustomMappings()}resetToDefaults(){this.customMappings.clear(),this.setupShortcuts(),this.saveCustomMappings()}getShortcuts(){return Array.from(this.shortcuts.entries()).map(([t,n])=>({id:t,...n}))}getShortcutsByContext(){const t={};for(const[n,o]of this.shortcuts.entries()){const i=n.split(".")[0];t[i]||(t[i]=[]),t[i].push({id:n,...o})}return t}}const De=new la;async function zi(){console.log("üéπ Starting keyboard app launch...");try{await De.initialize(),console.log("üéπ Keyboard service initialized successfully");const e=document.getElementById("keyboard-app");if(e){console.log("üéπ Existing keyboard window found, bringing to front"),typeof window.bringToFront=="function"&&window.bringToFront(e);return}const t="keyboard-app",n=ca();console.log("üéπ Creating keyboard app window..."),se("Keyboard Shortcuts",n,!1,t,!1,!1,{type:"integer",width:800,height:600},"default"),console.log("üéπ Window created, initializing app..."),setTimeout(()=>Wi(t),100)}catch(e){console.error("‚ùå Failed to launch keyboard app:",e)}}function ca(){return`
    <div class="keyboard-app h-full flex flex-col bg-gray-50">
      <div class="bg-gray-600 text-white p-3 flex items-center">
        <div class="w-8 h-8 bg-white bg-opacity-20 rounded mr-3 flex items-center justify-center">
          <span class="text-sm font-bold">‚å®Ô∏è</span>
        </div>
        <div>
          <h1 class="text-lg font-bold">Keyboard Shortcuts Manager</h1>
          <p class="text-sm opacity-90">Customize keyboard shortcuts for the entire system</p>
        </div>
      </div>

      <div class="flex-1 flex">
        <!-- Sidebar -->
        <div class="w-64 bg-white border-r border-gray-300 flex flex-col">
          <div class="p-3 border-b border-gray-200">
            <h2 class="font-bold text-gray-800">Categories</h2>
          </div>
          <div class="flex-1 overflow-y-auto">
            <div id="keyboard-categories" class="p-2 space-y-1">
              <!-- Categories will be populated here -->
            </div>
          </div>
          <div class="p-3 border-t border-gray-200 space-y-2">
            <div id="keyboard-reset-btn-container"></div>
            <div id="keyboard-export-btn-container"></div>
          </div>
        </div>

        <!-- Main content -->
        <div class="flex-1 flex flex-col">
          <div class="p-4 border-b border-gray-200 bg-gray-100">
            <div class="flex items-center justify-between">
              <div>
                <h2 id="keyboard-category-title" class="text-xl font-bold text-gray-800">Global Shortcuts</h2>
                <p id="keyboard-category-desc" class="text-sm text-gray-600">System-wide keyboard shortcuts</p>
              </div>
              <div class="flex items-center space-x-2">
                <input type="text" id="keyboard-search" placeholder="Search shortcuts..."
                       class="px-3 py-1 border border-gray-300 rounded text-sm">
                <div id="keyboard-help-btn-container"></div>
              </div>
            </div>
          </div>

          <div class="flex-1 overflow-y-auto p-4">
            <div id="keyboard-touch-banner" class="hidden mb-3 bg-blue-50 border border-blue-200 text-blue-800 rounded p-3 text-sm">
              <strong>Touch tips:</strong> Swipe the taskbar to switch windows, two-finger tap on the desktop to show the desktop, and two-finger swipe on a window title bar to minimize (down) or maximize (up).
            </div>
            <div id="keyboard-shortcuts-list">
              <!-- Shortcuts list will be populated here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Status bar -->
      <div class="bg-gray-200 border-t border-gray-300 px-4 py-2 text-sm text-gray-600">
        <div class="flex items-center justify-between">
          <span id="keyboard-status">Ready</span>
          <span id="keyboard-count">0 shortcuts loaded</span>
        </div>
      </div>
    </div>
  `}function Wi(e){const t=document.getElementById(e);if(!t){console.error("‚ùå Keyboard app window not found:",e);return}if(t.dataset.keyboardInitialized==="true"){const k=t.querySelector("#keyboard-categories");if(t.querySelector("#keyboard-shortcuts-list"),k&&k.children.length===0)t.dataset.keyboardInitialized="false";else return}console.log("üéπ Initializing keyboard app UI...");let n="global",o=null,i=null;const r="ontouchstart"in window||navigator.maxTouchPoints>0,a=document.getElementById("keyboard-touch-banner");r&&a&&a.classList.remove("hidden");const s={"global.toggleStartMenu":"Tap Start button","global.cycleWindows":"Swipe left/right on taskbar","global.minimizeActiveWindow":"Two-finger swipe down on window title bar","global.closeActiveWindow":"Tap the X button on the window title bar","global.showDesktop":"Two-finger tap on desktop","global.escapeAction":"Tap outside the menu/dialog","desktop.activateIcon":"Double-tap icon","desktop.moveUp":"Drag icon up","desktop.moveDown":"Drag icon down","desktop.moveLeft":"Drag icon left","desktop.moveRight":"Drag icon right","desktop.fineMoveUp":"Drag icon up (slowly)","desktop.fineMoveDown":"Drag icon down (slowly)","desktop.fineMoveLeft":"Drag icon left (slowly)","desktop.fineMoveRight":"Drag icon right (slowly)","startMenu.navigateDown":"Scroll and tap items","startMenu.navigateUp":"Scroll and tap items","startMenu.enterSubmenu":"Tap submenu","startMenu.exitSubmenu":"Tap Back or outside","startMenu.activateItem":"Tap item","startMenu.close":"Tap outside menu","fileExplorer.rename":"Long-press item ‚Üí Rename","contextMenu.navigateDown":"Scroll menu and tap","contextMenu.navigateUp":"Scroll menu and tap","contextMenu.enterSubmenu":"Tap submenu","contextMenu.exitSubmenu":"Tap outside menu","contextMenu.activateItem":"Tap menu item","contextMenu.close":"Tap outside menu","window.minimize":"Tap _ button or two-finger swipe down on title bar","window.maximize":"Tap ‚õ∂ button or two-finger swipe up on title bar","window.close":"Tap X button","taskbar.activateButton":"Tap taskbar button","taskbar.mediaControl":"Tap media control","taskbar.minimizeAll":"Tap Show Desktop or two-finger tap on desktop"};function l(k){return r&&s[k]||null}De.initialize().then(()=>{console.log("üéπ Keyboard service ready, populating UI..."),c(),f("global"),h("Keyboard service initialized")}).catch(k=>{console.error("‚ùå Failed to initialize keyboard service:",k),h("Failed to initialize keyboard service")});function c(){const k=De.getShortcutsByContext(),L=t.querySelector("#keyboard-categories"),A={global:"Global",desktop:"Desktop",startMenu:"Start Menu",fileExplorer:"File Explorer",contextMenu:"Context Menu",window:"Windows",taskbar:"Taskbar"},M={global:"image/html.webp",desktop:"image/desktop.webp",startMenu:"image/door-icon.webp",fileExplorer:"image/folder.webp",contextMenu:"image/doc.webp",window:"image/generic-window.webp",taskbar:"image/desktop.webp"};L.innerHTML="",Object.keys(k).forEach(S=>{const T=document.createElement("button");T.className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 text-sm flex items-center space-x-2";const X=document.createElement("img");X.src=M[S]||"image/file.webp",X.className="w-4 h-4",X.alt="";const ee=document.createElement("span");ee.textContent=A[S]||S,T.appendChild(X),T.appendChild(ee),T.onclick=()=>f(S),L.appendChild(T)})}function f(k){n=k;const L=De.getShortcutsByContext()[k]||[],A={global:"Global Shortcuts",desktop:"Desktop Shortcuts",startMenu:"Start Menu Navigation",fileExplorer:"File Explorer",contextMenu:"Context Menus",window:"Window Management",taskbar:"Taskbar Controls"},M={global:"System-wide keyboard shortcuts",desktop:"Desktop icon management and navigation",startMenu:"Start menu navigation and activation",fileExplorer:"File and folder operations",contextMenu:"Context menu navigation",window:"Window control operations",taskbar:"Taskbar button and control shortcuts"};t.querySelector("#keyboard-category-title").textContent=A[k]||k,t.querySelector("#keyboard-category-desc").textContent=M[k]||"",t.querySelectorAll("#keyboard-categories button").forEach(T=>{T.classList.remove("bg-gray-100","border-gray-300")});const S=Array.from(t.querySelectorAll("#keyboard-categories button")).find(T=>{const X=T.querySelector("span");return X&&X.textContent===(A[k]||k)});S&&S.classList.add("bg-gray-100","border-gray-300"),p(L),h(`Showing ${L.length} shortcuts in ${A[k]}`),t.querySelector("#keyboard-count").textContent=`${L.length} shortcuts`}function p(k){const L=t.querySelector("#keyboard-shortcuts-list");if(L.innerHTML="",k.length===0){L.innerHTML='<div class="text-center text-gray-500 py-8">No shortcuts in this category</div>';return}k.forEach(A=>{var te;const M=document.createElement("div");M.className="bg-white border border-gray-200 rounded-lg p-4 mb-3 hover:shadow-md transition-shadow";const S=A.isCustom,T=((te=De.defaultShortcuts[A.id])==null?void 0:te.key)||"",X=l(A.id);M.innerHTML=`
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="flex items-center space-x-2">
              <h3 class="font-medium text-gray-800">${A.description}</h3>
              ${S?'<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">Custom</span>':""}
            </div>
            <p class="text-sm text-gray-500 mt-1">Action: ${A.id}</p>
            ${S?`<p class="text-xs text-gray-400 mt-1">Default: ${T}</p>`:""}
            ${X?`<p class="text-xs text-blue-700 mt-2"><span class="bg-blue-50 border border-blue-200 rounded px-2 py-0.5">Touch: ${X}</span></p>`:""}
          </div>
          <div class="flex items-center space-x-2">
            <code class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">${A.key}</code>
            <div class="edit-shortcut-btn" data-shortcut-id="${A.id}"></div>
            ${S?`<div class="reset-shortcut-btn" data-shortcut-id="${A.id}"></div>`:""}
          </div>
        </div>
      `,L.appendChild(M);const ee=M.querySelector(".edit-shortcut-btn"),oe=fe("Edit");if(oe.onclick=()=>d(A.id),ee.appendChild(oe),S){const ie=M.querySelector(".reset-shortcut-btn"),we=fe("Reset");we.onclick=()=>x(A.id),ie.appendChild(we)}})}function d(k){o=k,i=null;const L=De.shortcuts.get(k),A=L?L.description:k,M="keyboard-capture-window",S=`
      <div class="p-4 bg-gray-100 h-full flex flex-col">
        <h3 class="text-lg font-bold mb-4">Remap Shortcut</h3>
        <p class="mb-4">Remapping: <strong>${A}</strong></p>
        <div class="flex-1 flex items-center justify-center">
          <div id="keyboard-capture-display" class="text-xl font-mono bg-white p-6 border-2 border-gray-400 text-center min-w-64" style="border-style: inset;">
            Press any key combination...
          </div>
        </div>
        <p class="text-sm text-gray-600 mb-4 text-center">
          Press the key combination you want to assign.<br>
          Press Escape to cancel.
        </p>
        <div class="flex justify-center space-x-2">
          <div id="keyboard-capture-cancel-btn"></div>
          <div id="keyboard-capture-save-btn"></div>
        </div>
      </div>
    `;se("Capture Key Combination",S,!1,M,!1,!1,{type:"integer",width:400,height:250},"default"),setTimeout(()=>{const T=document.getElementById(M);if(!T)return;const X=T.querySelector("#keyboard-capture-cancel-btn"),ee=T.querySelector("#keyboard-capture-save-btn"),oe=fe("Cancel");oe.onclick=()=>{m(),de(M)},X.appendChild(oe);const te=fe("Save");te.disabled=!0,te.onclick=()=>{g(),de(M)},ee.appendChild(te),document.addEventListener("keydown",u,!0),T.focus()},100)}function u(k){if(k.preventDefault(),k.stopPropagation(),k.key==="Escape"){m(),de("keyboard-capture-window");return}i=De.getKeyCombo(k);const L=document.getElementById("keyboard-capture-window");if(!L)return;const A=L.querySelector("#keyboard-capture-display"),M=L.querySelector("#keyboard-capture-save-btn");A.textContent=i;const S=M.querySelector("button");S&&(S.disabled=!1)}function m(){document.removeEventListener("keydown",u,!0),o=null,i=null}function g(){if(!(!o||!i)){try{De.remapShortcut(o,i),f(n),h(`Shortcut updated: ${o} ‚Üí ${i}`)}catch(k){h(`Error: ${k.message}`)}m()}}function x(k){De.removeCustomMapping(k),f(n),h(`Shortcut reset to default: ${k}`)}function b(){typeof window.showDialogBox=="function"?window.showDialogBox("Are you sure you want to reset all shortcuts to their defaults? This cannot be undone.","confirm",k=>{k&&(De.resetToDefaults(),f(n),h("All shortcuts reset to defaults"))}):confirm("Are you sure you want to reset all shortcuts to their defaults? This cannot be undone.")&&(De.resetToDefaults(),f(n),h("All shortcuts reset to defaults"))}function I(){const k={customMappings:Object.fromEntries(De.customMappings),timestamp:Date.now(),version:"1.0"},L=new Blob([JSON.stringify(k,null,2)],{type:"application/json"}),A=URL.createObjectURL(L),M=document.createElement("a");M.href=A,M.download="keyboard-shortcuts.json",M.click(),URL.revokeObjectURL(A),h("Settings exported successfully")}function h(k){t.querySelector("#keyboard-status").textContent=k}function H(k,L){t.querySelector("#keyboard-category-title").textContent=`Search Results for "${k}"`,t.querySelector("#keyboard-category-desc").textContent=`Found ${L.length} shortcuts across all categories`,t.querySelectorAll("#keyboard-categories button").forEach(A=>{A.classList.remove("bg-gray-100","border-gray-300")}),O(L),h(`${L.length} shortcuts found for "${k}"`),t.querySelector("#keyboard-count").textContent=`${L.length} shortcuts found`}function O(k){const L=t.querySelector("#keyboard-shortcuts-list");if(L.innerHTML="",k.length===0){L.innerHTML='<div class="text-center text-gray-500 py-8">No shortcuts found matching your search</div>';return}const A={};k.forEach(T=>{const X=T.id.split(".")[0];A[X]||(A[X]=[]),A[X].push(T)});const M={global:"Global",desktop:"Desktop",startMenu:"Start Menu",fileExplorer:"File Explorer",contextMenu:"Context Menu",window:"Windows",taskbar:"Taskbar"},S={global:"image/html.webp",desktop:"image/desktop.webp",startMenu:"image/door-icon.webp",fileExplorer:"image/folder.webp",contextMenu:"image/doc.webp",window:"image/generic-window.webp",taskbar:"image/desktop.webp"};Object.keys(A).forEach(T=>{const X=A[T],ee=document.createElement("div");ee.className="mb-2 mt-4 first:mt-0",ee.innerHTML=`
        <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wide border-b border-gray-200 pb-1 flex items-center space-x-2">
          <img src="${S[T]||"image/file.webp"}" class="w-4 h-4" alt="">
          <span>${M[T]||T} (${X.length})</span>
        </h3>
      `,L.appendChild(ee),X.forEach(oe=>{var y;const te=document.createElement("div");te.className="bg-white border border-gray-200 rounded-lg p-4 mb-3 hover:shadow-md transition-shadow";const ie=oe.isCustom,we=((y=De.defaultShortcuts[oe.id])==null?void 0:y.key)||"",Ee=l(oe.id);te.innerHTML=`
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <div class="flex items-center space-x-2">
                <h3 class="font-medium text-gray-800">${oe.description}</h3>
                ${ie?'<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">Custom</span>':""}
              </div>
              <p class="text-sm text-gray-500 mt-1">Action: ${oe.id}</p>
              ${ie?`<p class="text-xs text-gray-400 mt-1">Default: ${we}</p>`:""}
      ${Ee?`<p class="text-xs text-blue-700 mt-2"><span class="bg-blue-50 border border-blue-200 rounded px-2 py-0.5">Touch: ${Ee}</span></p>`:""}
            </div>
            <div class="flex items-center space-x-2">
              <code class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">${oe.key}</code>
              <div class="edit-shortcut-btn" data-shortcut-id="${oe.id}"></div>
              ${ie?`<div class="reset-shortcut-btn" data-shortcut-id="${oe.id}"></div>`:""}
            </div>
          </div>
        `,L.appendChild(te);const ve=te.querySelector(".edit-shortcut-btn"),R=fe("Edit");if(R.onclick=()=>d(oe.id),ve.appendChild(R),ie){const w=te.querySelector(".reset-shortcut-btn"),v=fe("Reset");v.onclick=()=>x(oe.id),w.appendChild(v)}})})}function j(){t.querySelector("#keyboard-search").addEventListener("input",L=>{const A=L.target.value.toLowerCase();if(!A.trim()){f(n);return}const S=De.getShortcuts().filter(T=>T.description.toLowerCase().includes(A)||T.key.toLowerCase().includes(A)||T.id.toLowerCase().includes(A));H(A,S)})}const $=t.querySelector("#keyboard-reset-btn-container"),F=t.querySelector("#keyboard-export-btn-container"),N=t.querySelector("#keyboard-help-btn-container"),_=fe("Reset All to Defaults");_.onclick=b,_.style.width="100%",$.appendChild(_);const V=fe("Export Settings");V.onclick=I,V.style.width="100%",F.appendChild(V);const Z=fe("Help");Z.onclick=()=>{typeof window.showDialogBox=="function"&&window.showDialogBox(`
        <h3>Keyboard Shortcuts Help</h3>
        <p><strong>Editing Shortcuts:</strong> Click "Edit" next to any shortcut to assign a new key combination.</p>
        <p><strong>Resetting:</strong> Use "Reset" to restore a shortcut to its default, or "Reset All" for everything.</p>
        <p><strong>Key Combinations:</strong> You can use Ctrl, Alt, Shift, and Meta (Windows/Cmd) keys with letters, numbers, and function keys.</p>
        <p><strong>Search:</strong> Use the search box to quickly find specific shortcuts.</p>
        <p><strong>Export:</strong> Save your custom shortcuts to a file for backup or sharing.</p>
  ${r?"<p><strong>Touch:</strong> Swipe the taskbar to switch windows; two-finger tap on the desktop to show the desktop; two-finger swipe on a window title bar to minimize (down) or maximize (up). Touch equivalents appear under each shortcut.</p>":""}
      `,"info")},N.appendChild(Z),j(),t.dataset.keyboardInitialized="true"}typeof window<"u"&&(window.keyboardService=De,window.launchKeyboard=zi,window.initializeKeyboardApp=Wi);function so({windowId:e,container:t,overlayText:n="Paused",overlayZ:o=50}){if(!t)throw new Error("Pause controller: container required");const i=t.style.position;(!i||i==="static")&&(t.style.position="relative");const r=document.createElement("div");r.className="game-pause-overlay",Object.assign(r.style,{position:"absolute",inset:"0",display:"none",background:"rgba(0,0,0,0.55)",color:"white",fontFamily:"monospace",fontSize:"36px",fontWeight:"bold",alignItems:"center",justifyContent:"center",zIndex:String(o),pointerEvents:"none"}),r.textContent=n,t.appendChild(r);let a=!1,s=!1;function l(){const m=Array.from(document.querySelectorAll("#windows-container > div")).filter(g=>g.style.display!=="none"&&g.id!=="taskbar");return m.length?(m.sort((g,x)=>(parseInt(x.style.zIndex)||0)-(parseInt(g.style.zIndex)||0)),m[0].id||null):null}function c(){if(s)return;const m=document.hidden||l()!==e;m!==a&&(a=m,r.style.display=a?"flex":"none")}function f(){c()}document.addEventListener("visibilitychange",f);const p=document.getElementById("windows-container");let d=null;p&&"MutationObserver"in window&&(d=new MutationObserver(()=>{requestAnimationFrame(c)}),d.observe(p,{childList:!0,subtree:!1}));function u(){s=!0,document.removeEventListener("visibilitychange",f),d&&d.disconnect(),r&&r.parentElement===t&&r.remove()}return{get paused(){return a},overlay:r,recompute:c,destroy:u}}function Ni(){const e=document.getElementById("pong");if(e){Ce(e);return}const t=window.innerWidth<600,n=t?Math.min(window.innerWidth-20,700):700,o=t?Math.min(window.innerHeight-60,500):500,i=se("Pong","",!1,"pong",!1,!1,{type:"integer",width:n,height:o},"App",null,"black");lo(i).catch(console.error)}async function lo(e){if(!e&&(e=document.getElementById("pong"),!e))return;const t=e.querySelector(".p-2");t.className="p-2 bg-black h-full overflow-hidden flex flex-col",t.innerHTML="";const n=document.createElement("div");n.className="flex items-center justify-between text-white px-2 pb-2",n.style.fontFamily="monospace",n.innerHTML='<div>üôã Player</div><div id="pong-score">0 - 0</div><div>High: <span id="pong-high-score">0</span></div>';const o=document.createElement("div");o.className="flex-1 flex items-center justify-center";const i=document.createElement("canvas");i.id="pong-canvas",i.style.background="#000",i.style.border="2px inset #666";const r=window.innerWidth<600;i.width=r?Math.min(window.innerWidth-40,640):640,i.height=r?Math.min(window.innerHeight-150,360):360,o.appendChild(i);const a=document.createElement("div");a.className="text-xs text-gray-300 pt-2",a.textContent=r?"Drag on screen to move paddle.":"Controls: W/S or Up/Down to move paddle. Click canvas to focus.",t.appendChild(n),t.appendChild(o),t.appendChild(a);const s=i.getContext("2d");let l=0,c=0,f=0;f=await B.getItem("pong-high-score")||0;const p={paddleHeight:60,paddleWidth:8,playerY:(i.height-60)/2,aiY:(i.height-60)/2,ballX:i.width/2,ballY:i.height/2,ballVX:3,ballVY:2,ballRadius:6,upPressed:!1,downPressed:!1,running:!0,rafId:null},d=so({windowId:"pong",container:o,overlayZ:10});function u($=1){p.ballX=i.width/2,p.ballY=i.height/2,p.ballVX=3*$,p.ballVY=Math.random()*3-1.5}function m(){s.fillStyle="#000",s.fillRect(0,0,i.width,i.height),s.fillStyle="#444";for(let $=0;$<i.height;$+=20)s.fillRect(i.width/2-1,$+5,2,10);s.fillStyle="#fff",s.fillRect(20,p.playerY,p.paddleWidth,p.paddleHeight),s.fillRect(i.width-20-p.paddleWidth,p.aiY,p.paddleWidth,p.paddleHeight),s.beginPath(),s.arc(p.ballX,p.ballY,p.ballRadius,0,Math.PI*2),s.fill()}function g($){p.upPressed&&(p.playerY-=6*$),p.downPressed&&(p.playerY+=6*$),p.playerY=Math.max(0,Math.min(i.height-p.paddleHeight,p.playerY));const F=p.aiY+p.paddleHeight/2;if(F<p.ballY-10&&(p.aiY+=3.2*$),F>p.ballY+10&&(p.aiY-=3.2*$),p.aiY=Math.max(0,Math.min(i.height-p.paddleHeight,p.aiY)),p.ballX+=p.ballVX*$,p.ballY+=p.ballVY*$,(p.ballY-p.ballRadius<=0||p.ballY+p.ballRadius>=i.height)&&(p.ballVY=-p.ballVY),p.ballX-p.ballRadius<=20+p.paddleWidth&&p.ballY>=p.playerY&&p.ballY<=p.playerY+p.paddleHeight){p.ballVX=-p.ballVX;const N=(p.ballY-(p.playerY+p.paddleHeight/2))/(p.paddleHeight/2);p.ballVY+=N*2,p.ballX=20+p.paddleWidth+p.ballRadius+1}if(p.ballX+p.ballRadius>=i.width-20-p.paddleWidth&&p.ballY>=p.aiY&&p.ballY<=p.aiY+p.paddleHeight){p.ballVX=-p.ballVX;const N=(p.ballY-(p.aiY+p.paddleHeight/2))/(p.paddleHeight/2);p.ballVY+=N*2,p.ballX=i.width-20-p.paddleWidth-p.ballRadius-1}p.ballX<0&&(c+=1,I(),u(1)),p.ballX>i.width&&(l+=1,l>f&&(f=l,B.setItemSync("pong-high-score",f),window.isDevvit&&window.parent.postMessage({type:"setGameScore",data:{game:"pong",score:f}},"*")),I(),u(-1))}let x=null;function b($){if(!p.running)return;d.recompute(),x==null&&(x=$);const F=$-x;x=$;let N=F/(1e3/60);N>3&&(N=3),d.paused||(g(N),m()),p.rafId=requestAnimationFrame(b)}function I(){const $=document.getElementById("pong-score"),F=document.getElementById("pong-high-score");$&&($.textContent=`${l} - ${c}`),F&&(F.textContent=String(f))}function h($){($.key==="w"||$.key==="W"||$.key==="ArrowUp")&&(p.upPressed=!0),($.key==="s"||$.key==="S"||$.key==="ArrowDown")&&(p.downPressed=!0)}function H($){($.key==="w"||$.key==="W"||$.key==="ArrowUp")&&(p.upPressed=!1),($.key==="s"||$.key==="S"||$.key==="ArrowDown")&&(p.downPressed=!1)}i.addEventListener("touchmove",$=>{if($.preventDefault(),$.touches.length>0){const F=$.touches[0].clientY,N=i.getBoundingClientRect(),_=F-N.top;p.playerY=_-p.paddleHeight/2,p.playerY=Math.max(0,Math.min(i.height-p.paddleHeight,p.playerY))}},{passive:!1}),i.addEventListener("touchstart",$=>{$.preventDefault()},{passive:!1}),i.addEventListener("click",()=>i.focus()),i.setAttribute("tabindex","0"),i.style.outline="none",document.addEventListener("keydown",h),document.addEventListener("keyup",H);const O=new MutationObserver($=>{$.forEach(F=>{F.removedNodes.forEach(N=>{N.id==="pong"&&(j(),O.disconnect())})})});O.observe(document.getElementById("windows-container"),{childList:!0});function j(){p.running=!1,p.rafId&&cancelAnimationFrame(p.rafId),document.removeEventListener("keydown",h),document.removeEventListener("keyup",H),d.destroy()}u(1),I(),p.rafId=requestAnimationFrame(b)}typeof window<"u"&&(window.initializePongUI=lo);function Ri(){const e=document.getElementById("snake");if(e){Ce(e);return}const t=window.innerWidth<600,n=t?Math.min(window.innerWidth-20,620):620,o=t?Math.min(window.innerHeight-60,520):520,i=se("Snake","",!1,"snake",!1,!1,{type:"integer",width:n,height:o},"App",null,"black");co(i).catch(console.error)}async function co(e){if(!e&&(e=document.getElementById("snake"),!e))return;const t=e.querySelector(".p-2");t.className="p-2 bg-black h-full overflow-hidden flex flex-col items-center",t.innerHTML="";const n=document.createElement("div");n.className="w-full flex items-center justify-between text-white px-2 pb-2",n.style.fontFamily="monospace",n.innerHTML='<div>Score: <span id="snake-score">0</span></div><div id="snake-status">Playing</div><div>High: <span id="snake-high-score">0</span></div>';const o=document.createElement("div");o.className="flex-1 flex items-center justify-center w-full";const i=document.createElement("canvas");i.id="snake-canvas";const r=window.innerWidth<600;i.width=r?Math.min(window.innerWidth-40,560):560,i.height=r?Math.min(window.innerHeight-150,420):420,i.style.background="#000",i.style.border="2px inset #666",o.appendChild(i);const a=document.createElement("div");a.className="text-xs text-gray-300 pt-2",a.textContent=r?"Swipe to move. Tap R to restart.":"Controls: Arrow keys or W/A/S/D. Press R to restart.",t.appendChild(n),t.appendChild(o),t.appendChild(a);const s=i.getContext("2d"),l=20,c=Math.floor(i.width/l),f=Math.floor(i.height/l);let p=[{x:Math.floor(c/2),y:Math.floor(f/2)}],d={x:1,y:0},u=null,m=0,g=0,x=!0,b=8,I=0,h=null;const H=so({windowId:"snake",container:o,overlayZ:10});g=await B.getItem("snake-high-score")||0;function O(){let S=!1;for(;!S;){const T=Math.floor(Math.random()*c),X=Math.floor(Math.random()*f);S=!p.some(ee=>ee.x===T&&ee.y===X),S&&(u={x:T,y:X})}}function j(){p=[{x:Math.floor(c/2),y:Math.floor(f/2)}],d={x:1,y:0},m=0,x=!0,b=8,O(),$()}function $(){const S=document.getElementById("snake-score"),T=document.getElementById("snake-status"),X=document.getElementById("snake-length"),ee=document.getElementById("snake-high-score");S&&(S.textContent=String(m)),T&&(T.textContent=x?"Playing":"Game Over"),X&&(X.textContent=String(p.length)),ee&&(ee.textContent=String(g))}function F(){s.fillStyle="#000",s.fillRect(0,0,i.width,i.height),u&&(s.fillStyle="#e3342f",s.fillRect(u.x*l,u.y*l,l,l));for(let S=0;S<p.length;S++){const T=p[S];s.fillStyle=S%2===0?"#7ed957":"#5aa83d",s.fillRect(T.x*l,T.y*l,l-1,l-1)}}function N(){if(!x)return;const S={x:p[0].x+d.x,y:p[0].y+d.y};if(S.x<0&&(S.x=c-1),S.x>=c&&(S.x=0),S.y<0&&(S.y=f-1),S.y>=f&&(S.y=0),p.some(T=>T.x===S.x&&T.y===S.y)){x=!1,$();return}p.unshift(S),u&&S.x===u.x&&S.y===u.y?(m+=1,m>g&&(g=m,B.setItemSync("snake-high-score",g),window.isDevvit&&window.parent.postMessage({type:"setGameScore",data:{game:"snake",score:g}},"*")),m%5===0&&(b=Math.min(20,b+1)),O()):p.pop(),$()}let _=0;function V(S){I||(I=S),H.recompute();let T=S-I;T>1e3&&(T=1e3),I=S,H.paused||(_+=T);const X=1e3/b;let ee=!1;for(;_>=X;)N(),_-=X,ee=!0;ee&&!H.paused&&F(),h=requestAnimationFrame(V)}function Z(S){const T=S.key;(T==="ArrowUp"||T==="w"||T==="W")&&d.y===0&&(d={x:0,y:-1}),(T==="ArrowDown"||T==="s"||T==="S")&&d.y===0&&(d={x:0,y:1}),(T==="ArrowLeft"||T==="a"||T==="A")&&d.x===0&&(d={x:-1,y:0}),(T==="ArrowRight"||T==="d"||T==="D")&&d.x===0&&(d={x:1,y:0}),(T==="r"||T==="R")&&j()}let k=0,L=0;i.addEventListener("touchstart",S=>{k=S.touches[0].clientX,L=S.touches[0].clientY,S.preventDefault()},{passive:!1}),i.addEventListener("touchmove",S=>{S.preventDefault()},{passive:!1}),i.addEventListener("touchend",S=>{if(!x)return;const T=S.changedTouches[0].clientX,X=S.changedTouches[0].clientY,ee=T-k,oe=X-L;Math.abs(ee)>Math.abs(oe)?Math.abs(ee)>30&&(ee>0&&d.x===0?d={x:1,y:0}:ee<0&&d.x===0&&(d={x:-1,y:0})):Math.abs(oe)>30&&(oe>0&&d.y===0?d={x:0,y:1}:oe<0&&d.y===0&&(d={x:0,y:-1}))},{passive:!1}),i.addEventListener("click",()=>i.focus()),i.setAttribute("tabindex","0"),i.style.outline="none",document.addEventListener("keydown",Z);const A=new MutationObserver(S=>{S.forEach(T=>{T.removedNodes.forEach(X=>{X.id==="snake"&&(M(),A.disconnect())})})});A.observe(document.getElementById("windows-container"),{childList:!0});function M(){x=!1,h&&cancelAnimationFrame(h),document.removeEventListener("keydown",Z),H.destroy()}j(),F(),h=requestAnimationFrame(V)}typeof window<"u"&&(window.initializeSnakeUI=co);function Oi(){const e=document.getElementById("happyturd");if(e){Ce(e);return}const t=window.innerWidth<600,n=t?Math.min(window.innerWidth-20,360):360,o=t?Math.min(window.innerHeight-60,640):640,i=se("Happy Turd","",!1,"happyturd",!1,!1,{type:"integer",width:n,height:o},"App",null,"black");uo(i).catch(console.error)}async function uo(e){if(!e&&(e=document.getElementById("happyturd"),!e))return;const t=e.querySelector(".p-2");t.className="p-2 bg-black h-full overflow-hidden flex flex-col",t.innerHTML="";let n=await B.getItem("happyturd-difficulty")||"medium",o=oe(n),i=await B.getItem("happyturd-theme")||"system";const r=document.createElement("div");r.className="flex items-center justify-between px-2 py-1 bg-gray-800 border-b border-gray-600",r.innerHTML=`
    <div class="flex items-center gap-2">
      <div class="relative">
        <button id="difficultyMenuBtn" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded border border-gray-600 flex items-center gap-1" onclick="toggleDifficultyDropdown(event)">
          Difficulty
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div id="difficultyDropdown" class="absolute left-0 top-full mt-1 w-32 bg-gray-700 border border-gray-600 rounded shadow-lg z-50 hidden">
          <button class="w-full text-left px-3 py-2 text-white hover:bg-gray-600 flex items-center justify-between text-sm" onclick="setDifficulty('easy')">
            <span>Easy</span>
            <span id="easy-check" class="text-green-400 ${n==="easy"?"":"hidden"}">‚úì</span>
          </button>
          <button class="w-full text-left px-3 py-2 text-white hover:bg-gray-600 flex items-center justify-between text-sm" onclick="setDifficulty('medium')">
            <span>Medium</span>
            <span id="medium-check" class="text-green-400 ${n==="medium"?"":"hidden"}">‚úì</span>
          </button>
          <button class="w-full text-left px-3 py-2 text-white hover:bg-gray-600 flex items-center justify-between text-sm" onclick="setDifficulty('hard')">
            <span>Hard</span>
            <span id="hard-check" class="text-green-400 ${n==="hard"?"":"hidden"}">‚úì</span>
          </button>
        </div>
      </div>
      <div class="relative">
        <button id="themeMenuBtn" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded border border-gray-600 flex items-center gap-1" onclick="toggleThemeDropdown(event)">
          Theme
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div id="themeDropdown" class="absolute left-0 top-full mt-1 w-32 bg-gray-700 border border-gray-600 rounded shadow-lg z-50 hidden">
          <button class="w-full text-left px-3 py-2 text-white hover:bg-gray-600 flex items-center justify-between text-sm" onclick="setTheme('system')">
            <span>System</span>
            <span id="system-check" class="text-green-400 ${i==="system"?"":"hidden"}">‚úì</span>
          </button>
          <button class="w-full text-left px-3 py-2 text-white hover:bg-gray-600 flex items-center justify-between text-sm" onclick="setTheme('light')">
            <span>Light</span>
            <span id="light-check" class="text-green-400 ${i==="light"?"":"hidden"}">‚úì</span>
          </button>
          <button class="w-full text-left px-3 py-2 text-white hover:bg-gray-600 flex items-center justify-between text-sm" onclick="setTheme('dark')">
            <span>Dark</span>
            <span id="dark-check" class="text-green-400 ${i==="dark"?"":"hidden"}">‚úì</span>
          </button>
        </div>
      </div>
    </div>
  `;const a=document.createElement("div");a.className="w-full flex items-center justify-between text-white px-2 pb-2",a.style.fontFamily="monospace",a.innerHTML='<div>Best: <span id="happyturd-best">0</span></div><div id="happyturd-score">0</div><div id="happyturd-status">Playing</div>';const s=document.createElement("div");s.className="flex-1 flex items-center justify-center w-full";const l=document.createElement("canvas");l.id="happyturd-canvas";const c=window.innerWidth<600;l.width=c?Math.min(window.innerWidth-40,320):320,l.height=c?Math.min(window.innerHeight-150,480):480,l.style.background="#87ceeb",l.style.border="2px inset #666",s.appendChild(l);const f=document.createElement("div");f.id="happyturd-intro",f.className="absolute inset-0 bg-black/70 flex flex-col items-center justify-center z-10",f.style.display="flex",f.style.fontFamily="monospace";const p=document.createElement("img");p.src="/image/happyturd.webp",p.alt="Happy Turd Logo",p.className="w-20 h-20 md:w-32 md:h-32 mb-4 md:mb-8 drop-shadow-lg";const d=document.createElement("h1");d.textContent="Happy Turd",d.className="text-white text-lg md:text-xl font-bold mb-2 md:mb-8 text-center drop-shadow-lg",d.style.fontFamily="monospace";const u=document.createElement("div");u.className="text-white text-xs md:text-sm mb-2 md:mb-8 text-left max-w-xs drop-shadow",u.style.fontFamily="monospace",u.innerHTML=`
    <p class="mb-4">Help the turd fly past the pipes!</p>
    <p class="mb-2">‚Ä¢ Click or press SPACE to flap</p>
    <p class="mb-2">‚Ä¢ Avoid the pipes</p>
    <p class="mb-2">‚Ä¢ Collect points by passing between the pipes</p>
    <p class="mb-4">‚Ä¢ Don't hit the ground, ceiling, or pipes</p>
  `;const m=document.createElement("button");m.textContent="Start Game",m.className=" px-4 md:px-8 py-1.5 md:py-3 bg-green-600 hover:bg-green-700 text-white text-xl font-bold rounded-lg border-2 border-green-400 transition-colors drop-shadow-lg",m.style.fontFamily="monospace",m.onclick=()=>Qe(),f.appendChild(p),f.appendChild(d),f.appendChild(u),f.appendChild(m);const g=document.createElement("div");g.id="happyturd-gameover",g.className="absolute inset-0 bg-black/20 flex flex-col items-center justify-center z-10",g.style.display="none",g.style.fontFamily="monospace",g.style.opacity="0",g.style.transition="opacity 200ms ease-in-out";const x=document.createElement("h1");x.textContent="Game Over",x.className="text-white text-3xl font-bold mb-6 text-center drop-shadow-lg",x.style.fontFamily="monospace";const b=document.createElement("div");b.className="text-white text-xl mb-4 text-center drop-shadow",b.style.fontFamily="monospace",b.innerHTML=`
    <p class="mb-2">Score: <span id="gameover-score" class="text-yellow-400 font-bold">0</span></p>
    <p class="mb-2">Best: <span id="gameover-best" class="text-green-400 font-bold">0</span></p>
    <p id="new-high-score" class="text-red-400 font-bold text-lg" style="display: none;">üéâ New High Score! üéâ</p>
  `;const I=document.createElement("button");I.textContent="Try Again",I.className="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold rounded-lg border-2 border-blue-400 transition-colors drop-shadow-lg mt-4",I.style.fontFamily="monospace",I.onclick=()=>at(),g.appendChild(x),g.appendChild(b),g.appendChild(I),s.style.position="relative",s.appendChild(f),s.appendChild(g),t.appendChild(r),t.appendChild(a),t.appendChild(s);const h=l.getContext("2d");let H=0,O=0;const j=.45,$=-8.5;let F=0,N=60,_=l.height/2;const V=28;let Z="intro",k=0,L=0;const A=8,M=2;let S=[],T=!1;const X=120;let ee=0;O=await B.getItem("happyturd-best-score")||0;function oe(W){switch(W){case"easy":return 260;case"medium":return 195;case"hard":return 130;default:return 195}}window.toggleDifficultyDropdown=function(W){W.stopPropagation(),document.getElementById("difficultyDropdown").classList.toggle("hidden")},window.setDifficulty=async function(W){n=W,o=oe(W),document.getElementById("easy-check").classList.toggle("hidden",W!=="easy"),document.getElementById("medium-check").classList.toggle("hidden",W!=="medium"),document.getElementById("hard-check").classList.toggle("hidden",W!=="hard"),await B.setItem("happyturd-difficulty",W),document.getElementById("difficultyDropdown").classList.add("hidden"),je()},document.addEventListener("click",function(W){const K=document.getElementById("difficultyDropdown"),G=document.getElementById("difficultyMenuBtn");K&&G&&!K.contains(W.target)&&!G.contains(W.target)&&K.classList.add("hidden")}),window.toggleThemeDropdown=function(W){W.stopPropagation(),document.getElementById("themeDropdown").classList.toggle("hidden")},window.setTheme=async function(W){i=W,document.getElementById("system-check").classList.toggle("hidden",W!=="system"),document.getElementById("light-check").classList.toggle("hidden",W!=="light"),document.getElementById("dark-check").classList.toggle("hidden",W!=="dark"),await B.setItem("happyturd-theme",W),document.getElementById("themeDropdown").classList.add("hidden"),z(),Y&&cancelAnimationFrame(Y),Y=requestAnimationFrame(st)},document.addEventListener("click",function(W){const K=document.getElementById("themeDropdown"),G=document.getElementById("themeMenuBtn");K&&G&&!K.contains(W.target)&&!G.contains(W.target)&&K.classList.add("hidden")});const te=[],ie=52;let we=0;const Ee=90;let ve=[],R=[],y=[],w=[];const v=()=>i==="dark"?!0:i==="light"?!1:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;let E=[];const z=()=>{E=v()?Array.from({length:50},()=>({x:Math.random()*l.width,y:Math.random()*(l.height*.6),size:Math.random()*2+.5,brightness:Math.random()*.5+.5})):[]};z();const C={x:l.width*.8,y:50,size:35,rays:Array.from({length:12},(W,K)=>({angle:K/12*Math.PI*2,length:35*(.8+Math.random()*.4)}))};let U=!0,Y=null;const q=so({windowId:"happyturd",container:s,overlayZ:30});function ce(){const W=40+Math.random()*(l.height-o-120);te.push({x:l.width,top:W,passed:!1})}function he(){const W=20+Math.random()*100,K=20+Math.random()*30;ve.push({x:l.width+Math.random()*200,y:W,size:K,puffs:Array.from({length:3+Math.floor(Math.random()*3)},()=>({x:(Math.random()-.5)*K,y:(Math.random()-.5)*K*.5,radius:K*(.3+Math.random()*.4)}))})}function Be(){const W=l.height,K=200+Math.random()*150,G=40+Math.random()*80;R.push({x:l.width+Math.random()*300,baseY:W,width:K,height:G,color:`hsl(${80+Math.random()*40}, ${30+Math.random()*20}%, ${30+Math.random()*30}%)`})}function Le(){const W=l.height-40,K=80+Math.random()*100,G=60+Math.random()*80;y.push({x:l.width+Math.random()*500,baseY:W,height:K,width:G,peaks:Array.from({length:2+Math.floor(Math.random()*3)},()=>({offset:(Math.random()-.5)*G*.8,height:.7+Math.random()*.3}))})}function Ge(){const W=50+Math.floor(Math.random()*10);for(let K=0;K<W;K++)w.push({x:Math.random()*l.width,height:15+Math.random()*10})}function Oe(W,K){S=[],T=!0,ee=X;const G=15+Math.floor(Math.random()*6);for(let P=0;P<G;P++){const ue=Math.PI*2*P/G+(Math.random()-.5)*.5,ge=2+Math.random()*4,xe=3+Math.random()*5;S.push({x:W,y:K,vx:Math.cos(ue)*ge,vy:Math.sin(ue)*ge-Math.random()*2,size:xe,opacity:1,rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*.2})}}function Qe(){Z="playing";const W=document.getElementById("happyturd-intro");W&&(W.style.display="none"),je()}function at(){const W=document.getElementById("happyturd-gameover");W&&(W.style.opacity="0",setTimeout(()=>{W.style.display="none"},200)),je()}function je(){H=0,F=0,_=l.height/2,te.length=0,we=0,U=!0,Z="playing",Ke();const W=document.getElementById("happyturd-gameover");W&&(W.style.opacity="0",setTimeout(()=>{W.style.display="none"},200)),S=[],T=!1,ee=0,ve.length=0,R.length=0,y.length=0,w.length=0;for(let K=0;K<5;K++)he();for(let K=0;K<3;K++)Be();for(let K=0;K<4;K++)Le();Ge()}function Ke(){const W=document.getElementById("happyturd-score"),K=document.getElementById("happyturd-status"),G=document.getElementById("happyturd-best");W&&(W.textContent=String(H)),K&&(Z==="intro"?K.textContent="Ready":K.textContent=U?"Playing":"Game Over"),G&&(G.textContent=String(O))}function ft(W,K){k>0&&(h.font=`${V*1}px serif`,h.textAlign="center",h.textBaseline="middle",h.save(),h.translate(W-V*.4,K),h.scale(-1,1),h.fillText("ü™Ω",0,0),h.restore(),h.fillText("ü™Ω",W+V*.4,K));const G=U?"üí©":"‚ò†Ô∏è";h.font=`${V}px serif`,h.fillText(G,W,K+2)}function He(){const W=v(),K=h.createLinearGradient(0,0,0,l.height);W?(K.addColorStop(0,"#000011"),K.addColorStop(1,"#000033")):(K.addColorStop(0,"#87ceeb"),K.addColorStop(1,"#4a90e2")),h.fillStyle=K,h.fillRect(0,0,l.width,l.height),W&&(h.fillStyle="rgba(255, 255, 255, 0.8)",E.forEach(P=>{h.beginPath(),h.arc(P.x,P.y,P.size,0,Math.PI*2),h.fill()})),W?(h.fillStyle="#E6E6E6",h.beginPath(),h.arc(C.x,C.y,C.size,0,Math.PI*2),h.fill(),h.fillStyle="#CCCCCC",h.beginPath(),h.arc(C.x-C.size*.2,C.y-C.size*.1,C.size*.15,0,Math.PI*2),h.fill(),h.beginPath(),h.arc(C.x+C.size*.3,C.y+C.size*.2,C.size*.1,0,Math.PI*2),h.fill(),h.fillStyle="#000",h.strokeStyle="#000",h.beginPath(),h.arc(C.x-C.size*.25,C.y-C.size*.15,C.size*.08,0,Math.PI*2),h.fill(),h.beginPath(),h.arc(C.x+C.size*.25,C.y-C.size*.15,C.size*.08,0,Math.PI*2),h.fill(),h.beginPath(),U?h.arc(C.x,C.y+C.size*.1,C.size*.3,0,Math.PI):h.arc(C.x,C.y+C.size*.25,C.size*.3,Math.PI,0),h.stroke()):(h.strokeStyle="#FFD700",h.lineWidth=2,h.beginPath(),C.rays.forEach(P=>{const ue=C.x+Math.cos(P.angle)*P.length,ge=C.y+Math.sin(P.angle)*P.length;h.moveTo(C.x,C.y),h.lineTo(ue,ge)}),h.stroke(),h.fillStyle="#FFFF00",h.beginPath(),h.arc(C.x,C.y,C.size,0,Math.PI*2),h.fill(),h.fillStyle="#000",h.beginPath(),h.arc(C.x-C.size*.3,C.y-C.size*.2,C.size*.1,0,Math.PI*2),h.fill(),h.beginPath(),h.arc(C.x+C.size*.3,C.y-C.size*.2,C.size*.1,0,Math.PI*2),h.fill(),h.beginPath(),U?h.arc(C.x,C.y+C.size*.1,C.size*.4,0,Math.PI):h.arc(C.x,C.y+C.size*.3,C.size*.4,Math.PI,0),h.stroke()),y.forEach(P=>{const ue=h.createLinearGradient(0,P.baseY-P.height,0,P.baseY);ue.addColorStop(0,"#444"),ue.addColorStop(1,"#888"),h.fillStyle=ue,h.beginPath(),h.moveTo(P.x,P.baseY),P.peaks.sort((ge,xe)=>ge.offset-xe.offset),P.peaks.forEach(ge=>{h.lineTo(P.x+P.width/2+ge.offset,P.baseY-P.height*ge.height)}),h.lineTo(P.x+P.width,P.baseY),h.closePath(),h.fill()}),R.forEach(P=>{const ue=h.createLinearGradient(0,P.baseY-P.height,0,P.baseY);ue.addColorStop(0,P.color.replace(/hsl\(([^,]+), ([^,]+)%, ([^%]+)%\)/,(ge,xe,qe,Me)=>`hsl(${xe}, ${qe}%, ${Math.max(60,parseInt(Me))}%)`)),ue.addColorStop(1,P.color.replace(/hsl\(([^,]+), ([^,]+)%, ([^%]+)%\)/,(ge,xe,qe,Me)=>`hsl(${xe}, ${qe}%, ${Math.min(90,parseInt(Me)+20)}%)`)),h.fillStyle=ue,h.beginPath(),h.ellipse(P.x+P.width/2,P.baseY,P.width/2,P.height,0,0,Math.PI*2),h.fill()}),h.fillStyle="rgba(255, 255, 255, 0.8)",ve.forEach(P=>{P.puffs.forEach(ue=>{h.beginPath(),h.arc(P.x+ue.x,P.y+ue.y,ue.radius,0,Math.PI*2),h.fill()})});const G=h.createLinearGradient(0,l.height-40,0,l.height);G.addColorStop(0,"#A0522D"),G.addColorStop(1,"#654321"),h.fillStyle=G,h.fillRect(0,l.height-40,l.width,40),te.forEach(P=>{const ue=h.createLinearGradient(P.x,0,P.x+ie,0);ue.addColorStop(0,"#1a5d2e"),ue.addColorStop(.3,"#2f9e44"),ue.addColorStop(.7,"#2f9e44"),ue.addColorStop(1,"#1a5d2e"),h.fillStyle=ue,h.fillRect(P.x,0,ie,P.top);const ge=h.createLinearGradient(P.x,0,P.x+ie,0);ge.addColorStop(0,"#1a5d2e"),ge.addColorStop(.3,"#2f9e44"),ge.addColorStop(.7,"#2f9e44"),ge.addColorStop(1,"#1a5d2e"),h.fillStyle=ge,h.fillRect(P.x,P.top+o,ie,l.height-(P.top+o)-40);const xe=ie/2,qe=xe*.8,Me=ie*1.3,Ae=(Me-ie)/2,Ct=P.x+ie/2,Bn=Math.max(0,P.top-qe),tt=h.createLinearGradient(P.x-Ae,0,P.x-Ae+Me,0);tt.addColorStop(0,"#2a7a4a"),tt.addColorStop(.3,"#4ade80"),tt.addColorStop(.7,"#4ade80"),tt.addColorStop(1,"#2a7a4a"),h.fillStyle=tt,h.fillRect(P.x-Ae,Bn,Me,P.top-Bn);const jt=Math.min(l.height-40,P.top+o+qe),mt=h.createLinearGradient(P.x-Ae,0,P.x-Ae+Me,0);mt.addColorStop(0,"#2a7a4a"),mt.addColorStop(.3,"#4ade80"),mt.addColorStop(.7,"#4ade80"),mt.addColorStop(1,"#2a7a4a"),h.fillStyle=mt,h.fillRect(P.x-Ae,P.top+o,Me,jt-(P.top+o)),Math.min(l.height-40,P.top+o+qe);const It=h.createLinearGradient(P.x-Ae,0,P.x-Ae+Me,0);It.addColorStop(0,"#2a7a4a"),It.addColorStop(.4,"#4ade80"),It.addColorStop(.6,"#4ade80"),It.addColorStop(1,"#2a7a4a"),h.fillStyle=It;const Lt=Ct,Mt=P.top+o-Ae*.05,Tn=Me*.5,Io=xe*.5;h.beginPath(),h.moveTo(Lt-Tn,Mt),h.quadraticCurveTo(Lt,Mt-Io*1.1,Lt+Tn,Mt),h.quadraticCurveTo(Lt,Mt+Io*.8,Lt-Tn,Mt),h.closePath(),h.fill(),h.fillStyle="#000",h.save(),h.beginPath(),h.rect(P.x-Ae,P.top+o-Ae*1.5,Me,qe*.6),h.beginPath();const At=Ct,Dt=P.top+o+Ae*.3,Fn=xe,Lo=xe*.15;h.moveTo(At-Fn,Dt),h.quadraticCurveTo(At,Dt-Lo*2.5,At+Fn,Dt),h.quadraticCurveTo(At,Dt+Lo*1.1,At-Fn,Dt),h.closePath(),h.fill(),h.restore()}),ft(N,_),T&&S.forEach(P=>{h.save(),h.globalAlpha=P.opacity,h.translate(P.x,P.y),h.rotate(P.rotation),h.fillStyle="#8B4513",h.beginPath(),h.ellipse(0,0,P.size,P.size*.6,0,0,Math.PI*2),h.fill(),h.strokeStyle="#654321",h.lineWidth=1,h.stroke(),h.restore()}),h.fillStyle="#83d683",w.forEach(P=>{const ge=P.height/100;h.beginPath(),h.moveTo(P.x,l.height),h.lineTo(P.x-4*ge,l.height-40-P.height*.7),h.lineTo(P.x+4*.5*ge,l.height-40-P.height*.9),h.lineTo(P.x+4*ge,l.height-40-P.height*.6),h.closePath(),h.fill()})}function Dn(){if(_+V/2>=l.height-40||_-V/2<=0)return!0;for(const W of te){const K=(ie*1.3-ie)/2,G=W.x-K,P=W.x+ie+K,ue=W.top,ge=W.top+o;if(N+V/2>G&&N-V/2<P&&(_-V/2<ue||_+V/2>ge))return!0;const xe=ie/2,qe=W.x+ie/2,Me=xe*.3,Ae=N-qe,Ct=_-W.top;if(Math.sqrt(Ae*Ae+Ct*Ct)<V/2+Me)return!0;const tt=N-qe,jt=_-(W.top+o);if(Math.sqrt(tt*tt+jt*jt)<V/2+Me)return!0}return!1}function Te(W){if(!U)return;F+=j*W,_+=F*W,k>0&&(k-=W,k<0&&(k=0),k===0&&L>0&&(L--,L>0&&(k=A)));for(const G of te)G.x-=2.2*W,!G.passed&&G.x+ie<N&&(G.passed=!0,H+=1,Ke());for(;te.length&&te[0].x+ie<-10;)te.shift();we+=W,we>=Ee&&(we-=Ee,ce()),ve.forEach(G=>G.x-=.8*W),R.forEach(G=>G.x-=1.2*W),y.forEach(G=>G.x-=.6*W),w.forEach(G=>G.x-=1.8*W),ve=ve.filter(G=>G.x>-100),R=R.filter(G=>G.x>-200),y=y.filter(G=>G.x>-100),w=w.filter(G=>G.x>10);const K=G=>1-Math.pow(1-G,W);if(Math.random()<K(.005)&&he(),Math.random()<K(.003)&&Be(),Math.random()<K(.004)&&Le(),Math.random()<K(.006))for(let G=0;G<2+Math.floor(Math.random()*3);G++)w.push({x:l.width+Math.random()*50,height:15+Math.random()*10});if(Dn()){U=!1;const G=H>O;O=Math.max(O,H),B.setItemSync("happyturd-best-score",O),Ke();const P=document.getElementById("gameover-score"),ue=document.getElementById("gameover-best"),ge=document.getElementById("new-high-score");P&&(P.textContent=String(H)),ue&&(ue.textContent=String(O)),ge&&(ge.style.display=G?"block":"none");const xe=document.getElementById("happyturd-gameover");xe&&setTimeout(()=>{xe.style.display="flex",xe.offsetHeight,xe.style.opacity="1"},500),Oe(N,_)}}let et=null;function st(W){et==null&&(et=W);let K=W-et;et=W;let G=K/(1e3/60);G>3&&(G=3),q.recompute(),!q.paused&&Z==="playing"&&Te(G),!q.paused&&T&&(S.forEach(P=>{P.vy+=j*.3*G,P.x+=P.vx*G,P.y+=P.vy*G,P.rotation+=P.rotationSpeed*G,P.opacity=ee/X}),ee-=G,ee<=0&&(T=!1,S=[])),He(),Y=requestAnimationFrame(st)}function lt(){if(Z==="intro"){Qe();return}U&&(F=$,k=A,L=M)}function So(W){W.code==="Space"&&(W.preventDefault(),lt()),(W.key==="r"||W.key==="R")&&je()}l.addEventListener("click",()=>lt()),l.setAttribute("tabindex","0"),l.style.outline="none",document.addEventListener("keydown",So);const Co=new MutationObserver(W=>{W.forEach(K=>{K.removedNodes.forEach(G=>{G.id==="happyturd"&&(gr(),Co.disconnect())})})});Co.observe(document.getElementById("windows-container"),{childList:!0});function gr(){U=!1,Y&&cancelAnimationFrame(Y),document.removeEventListener("keydown",So),q.destroy()}Ke(),Y=requestAnimationFrame(st)}typeof window<"u"&&(window.initializeHappyTurdUI=uo);let Ft=!1;function Hi(){se("OS Update",'<div id="os-update-content" style="padding: 20px;">Loading update information...</div>',!1,"os-update-window",!1,!1,{type:"integer",width:600,height:500},"default"),setTimeout(po,100)}async function po(){const e=document.getElementById("os-update-content");if(e){if(Ft){e.innerHTML='<p class="text-yellow-600">An update is already in progress...</p>';return}try{const t=await fetch("./api/system_manifest.json");if(!t.ok)throw new Error("Failed to fetch system manifest");const n=await t.json(),o=await B.getItem("installedVersions")||{systemVersion:"0.0.0",files:{},apps:{}},i=[],r=[],a=[],s=[];for(const l of n.defaultFiles){const c=o.files[l.id];c?Po(l.version,c)>0&&a.push(l):i.push(l)}for(const l of n.apps){const c=o.apps[l.id];c?Po(l.version,c)>0&&s.push(l):r.push(l)}da(n,o,i,r,a,s)}catch(t){console.error("Error checking for updates:",t),e.innerHTML=`
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        <strong>Error:</strong> Failed to check for updates. Please try again later.
        <br><small>${t.message}</small>
      </div>
    `}}}function da(e,t,n,o,i,r){const a=document.getElementById("os-update-content");if(!a)return;const s=n.length>0||o.length>0||i.length>0||r.length>0;let l=`
    <div class="os-update-info">
      <h2 class="text-xl font-bold mb-4">System Update Check</h2>

      <div class="mb-6 p-4 bg-gray-100 rounded">
        <h3 class="text-lg font-semibold mb-2">Current System</h3>
        <p><strong>System Version:</strong> ${t.systemVersion||"0.0.0"}</p>
        <p><strong>Latest Version:</strong> ${e.version}</p>
        <p><strong>Installed Files:</strong> ${Object.keys(t.files).length}</p>
        <p><strong>Installed Apps:</strong> ${Object.keys(t.apps).length}</p>
      </div>
  `;s?(l+=`
      <div class="mb-6 p-4 bg-blue-100 border border-blue-400 rounded">
        <h3 class="text-lg font-semibold mb-2">‚ú® Updates Available!</h3>
    `,n.length>0&&(l+=`
        <div class="mb-3">
          <h4 class="font-semibold">New Default Files (${n.length}):</h4>
          <ul class="list-disc list-inside ml-4">
            ${n.map(p=>`<li>${p.name} (v${p.version}) - ${p.description}</li>`).join("")}
          </ul>
        </div>
      `),i.length>0&&(l+=`
        <div class="mb-3">
          <h4 class="font-semibold">Updated Files (${i.length}):</h4>
          <ul class="list-disc list-inside ml-4">
            ${i.map(p=>`<li>${p.name} (v${p.version})</li>`).join("")}
          </ul>
        </div>
      `),o.length>0&&(l+=`
        <div class="mb-3">
          <h4 class="font-semibold">New Applications (${o.length}):</h4>
          <ul class="list-disc list-inside ml-4">
            ${o.map(p=>`<li>${p.name} (v${p.version})</li>`).join("")}
          </ul>
        </div>
      `),r.length>0&&(l+=`
        <div class="mb-3">
          <h4 class="font-semibold">Updated Applications (${r.length}):</h4>
          <ul class="list-disc list-inside ml-4">
            ${r.map(p=>`<li>${p.name} (v${p.version})</li>`).join("")}
          </ul>
        </div>
      `),l+=`
        <p class="mt-3 text-sm text-gray-700">
          <strong>Note:</strong> Installing updates will add new files to your system.
          Your existing files and data will not be modified or deleted.
        </p>
      </div>
    `,l+=`
      <div class="mb-4">
        <div id="install-update-btn-container"></div>
      </div>
    `):l+=`
      <div class="mb-6 p-4 bg-green-100 border border-green-400 rounded">
        <h3 class="text-lg font-semibold">‚úì System is up to date!</h3>
        <p class="mt-2">You have the latest version of all files and applications.</p>
      </div>
    `,l+=`
    <div class="mt-6 flex gap-3">
      <div id="refresh-btn-container"></div>
    </div>
  </div>
  `,a.innerHTML=l;const c=fe("Check Again");c.onclick=po;const f=document.getElementById("refresh-btn-container");if(f&&f.appendChild(c),s){const p=fe("Install Updates");p.onclick=()=>ua(e,n,o,i,r);const d=document.getElementById("install-update-btn-container");d&&d.appendChild(p)}}async function ua(e,t,n,o,i){const r=document.getElementById("os-update-content");if(!r||Ft)return;Ft=!0,r.innerHTML=`
    <div class="text-center py-8">
      <h2 class="text-xl font-bold mb-4">Installing Updates...</h2>
      <div class="mb-4">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"></div>
      </div>
      <p class="text-gray-600">Please wait while we install the updates.</p>
      <div id="install-progress" class="mt-4 text-sm text-left max-w-md mx-auto"></div>
    </div>
  `;const a=document.getElementById("install-progress"),s=l=>{a&&(a.innerHTML+=`<p class="text-gray-700">${l}</p>`,a.scrollTop=a.scrollHeight)};try{const l=await B.getItem("installedVersions")||{systemVersion:"0.0.0",files:{},apps:{}},c=[...t,...o];if(c.length>0){s(`Installing ${c.length} file(s)...`);for(const p of c)try{await pa(p),l.files[p.id]=p.version,s(`‚úì Installed: ${p.name}`)}catch(d){s(`‚úó Failed to install ${p.name}: ${d.message}`),console.error("Error installing file:",p,d)}}const f=[...n,...i];if(f.length>0){s(`Registering ${f.length} app(s)...`);for(const p of f)l.apps[p.id]=p.version,s(`‚úì Registered: ${p.name}`)}l.systemVersion=e.version,await B.setItem("installedVersions",l),s("‚úì All updates installed successfully!"),setTimeout(()=>{r.innerHTML=`
        <div class="text-center py-8">
          <h2 class="text-xl font-bold mb-4 text-green-600">‚úì Updates Installed Successfully!</h2>
          <p class="mb-4">The following updates have been installed:</p>
          <div class="text-left max-w-md mx-auto mb-6">
            ${c.length>0?`<p>‚Ä¢ ${c.length} file(s) added</p>`:""}
            ${f.length>0?`<p>‚Ä¢ ${f.length} app(s) registered</p>`:""}
          </div>
          <p class="text-sm text-gray-600 mb-4">
            Check your Documents and Media folders to see the new files!
          </p>
          <div id="close-btn-container"></div>
        </div>
      `;const p=fe("Close");p.onclick=()=>{const u=document.getElementById("os-update-window");u&&u.remove()};const d=document.getElementById("close-btn-container");d&&d.appendChild(p),Ft=!1},1e3)}catch(l){console.error("Error installing updates:",l),r.innerHTML=`
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
        <strong>Error:</strong> Failed to install updates.
        <br><small>${l.message}</small>
      </div>
    `,Ft=!1}}async function pa(e){try{const t=await fetch(`./${e.path}`);if(!t.ok)throw new Error(`Failed to fetch file: ${e.path}`);const n=await kr(),o=n.folders[e.targetFolder];if(!o)throw new Error(`Target folder not found: ${e.targetFolder}`);const i=Object.values(o).find(l=>l.id===e.id||l.name===e.name);if(i){i.version=e.version,i.description=e.description,await Ao(n),await Q();return}const r=["md","txt","html"].includes(e.contentType);let a,s;if(r){const l=await t.text();s={id:e.id,name:e.name,type:"ugc-file",fullPath:`${e.targetFolder}/${e.id}`,content_type:e.contentType,icon:e.icon,contents:l,version:e.version,description:e.description,isDefault:!0,isSystemFile:!0}}else{const l=await t.blob(),c=await fa(l);await B.setItem(`file_data_${e.id}`,c),s={id:e.id,name:e.name,type:"ugc-file",fullPath:`${e.targetFolder}/${e.id}`,content_type:e.contentType,icon:e.icon,contents:"",version:e.version,description:e.description,isDefault:!0,isSystemFile:!0,isLargeFile:!0,storageLocation:"indexeddb",dataURL:c}}o[e.id]=s,await Ao(n),await Q()}catch(t){throw console.error("Error installing default file:",e,t),t}}function fa(e){return new Promise((t,n)=>{const o=new FileReader;o.onload=()=>t(o.result),o.onerror=n,o.readAsDataURL(e)})}function Po(e,t){const n=e.split(".").map(Number),o=t.split(".").map(Number);for(let i=0;i<Math.max(n.length,o.length);i++){const r=n[i]||0,a=o[i]||0;if(r>a)return 1;if(r<a)return-1}return 0}function jn(){po()}function en(e){const t=document.getElementById(e);if(t)if(e==="keyboard")console.log("üîç Skipping generic keyboard element, will handle in keyboard case");else{const o=[...document.querySelectorAll("*")].filter(i=>getComputedStyle(i).zIndex>100&&getComputedStyle(i).zIndex<1e3).reduce((i,r)=>getComputedStyle(r).zIndex>getComputedStyle(i).zIndex?r:i,t);t.style.zIndex=`${parseInt(getComputedStyle(o).zIndex)+1}`;return}if(console.log(`üîç Checking app cases for ${e}...`),(e==="mailbox"||e.includes("shortcut-mailboxapp"))&&si(),(e==="watercolour"||e.includes("shortcut-watercolourapp"))&&di(),(e==="calculator"||e.includes("shortcut-calcapp"))&&mi(),(e==="solitaire"||e.includes("shortcut-solapp"))&&hi(),(e==="chess"||e.includes("shortcut-chessapp"))&&bi(),(e==="bombbroomer"||e.includes("shortcut-bombapp"))&&Bi(),(e==="mediaplayer"||e.includes("shortcut-mediaapp"))&&Fi(),(e==="compostbin"||e.includes("shortcut-compostbinapp"))&&ii(),(e==="storage"||e.includes("shortcut-storageapp"))&&Ji(),(e==="tubestream"||e.includes("shortcut-tubestreamapp"))&&li(),(e==="osupdate"||e.includes("shortcut-osupdateapp"))&&Hi(),(e==="pong"||e.includes("shortcut-pongapp"))&&Ni(),(e==="snake"||e.includes("shortcut-snakeapp"))&&Ri(),(e==="happyturd"||e.includes("shortcut-happyturdapp"))&&Oi(),e==="keyboard"){const n=document.getElementById("keyboard-app");if(n){console.log("üîç Keyboard app window already exists, bringing to front");const i=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,a)=>getComputedStyle(a).zIndex>getComputedStyle(r).zIndex?a:r,n);n.style.zIndex=`${parseInt(getComputedStyle(i).zIndex)+1}`;return}zi().catch(console.error)}console.log("üîç Finished checking all cases")}let pe={isActive:!1,selectedIcon:null,cutIcon:null,moveStep:20,gridStep:112};function ma(e){pe.isActive=!0,pe.selectedIcon=e,e.classList.add("dragging","keyboard-dragging"),e.style.zIndex="1000",wa(e),_e("Drag mode activated. Use arrow keys to move, Enter to drop, or Escape to cancel."),xa()}function tn(e=!1){if(!pe.isActive||!pe.selectedIcon)return;const t=pe.selectedIcon;t.classList.remove("dragging","keyboard-dragging"),t.style.zIndex="",va(),ka(),e?(Rt(t),me[t.id]={left:t.style.left,top:t.style.top},Q(),_e("Icon moved successfully.")):_e("Drag operation cancelled."),pe.isActive=!1,pe.selectedIcon=null}function ga(e,t){if(!pe.isActive)return;const n=parseInt(e.style.left)||0,o=parseInt(e.style.top)||0,i=pe.moveStep;let r=n,a=o;switch(t){case"ArrowUp":a=Math.max(16,o-i);break;case"ArrowDown":a=o+i;break;case"ArrowLeft":r=Math.max(16,n-i);break;case"ArrowRight":r=n+i;break}e.style.left=r+"px",e.style.top=a+"px",ji(e,r+48,a+48)}function ha(e){if(!pe.isActive)return;const t=parseInt(e.style.left)||0,n=parseInt(e.style.top)||0,o=pe.gridStep,i=16+Math.round((t-16)/o)*o,r=16+Math.round((n-16)/o)*o;e.style.left=Math.max(16,i)+"px",e.style.top=Math.max(16,r)+"px",_e("Icon snapped to grid.")}function ya(e){pe.cutIcon&&pe.cutIcon.classList.remove("cut-icon"),pe.cutIcon=e,e.classList.add("cut-icon"),_e("Icon cut. Navigate to destination and press Ctrl+V to paste.")}function ba(){if(!pe.cutIcon){_e("No icon to paste.");return}const e=document.activeElement,t=pe.cutIcon;if(e&&e.classList.contains("draggable-icon")){const n=e.getBoundingClientRect(),o=document.getElementById("desktop").getBoundingClientRect(),i=n.left-o.left+120,r=n.top-o.top;t.style.left=i+"px",t.style.top=r+"px",Rt(t),me[t.id]={left:t.style.left,top:t.style.top},Q()}t.classList.remove("cut-icon"),pe.cutIcon=null,_e("Icon pasted successfully.")}function wa(e){document.querySelectorAll(".desktop-folder-icon[data-item-id]").forEach(t=>{const n=Ot(t.getAttribute("data-item-id")),o=t.getAttribute("data-item-id");(n&&n.type==="folder"||o==="compostbin")&&t!==e&&t.classList.add("drag-hover-target")})}function va(){document.querySelectorAll(".drag-hover-target").forEach(e=>{e.classList.remove("drag-hover-target")}),document.querySelectorAll(".desktop-folder-icon").forEach(e=>{e.classList.remove("dragover")})}function xa(e){const t=document.createElement("div");t.id="keyboard-drag-indicator",t.className="fixed bottom-4 left-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50",t.innerHTML=`
    <div class="text-sm font-medium">Keyboard Drag Mode</div>
    <div class="text-xs">‚Üë‚Üì‚Üê‚Üí Move ‚Ä¢ Enter Drop ‚Ä¢ Esc Cancel ‚Ä¢ G Grid Snap</div>
  `,document.body.appendChild(t)}function ka(){const e=document.getElementById("keyboard-drag-indicator");e&&e.remove()}function _e(e,t="polite"){let n=document.getElementById("sr-announcements");n||(n=document.createElement("div"),n.id="sr-announcements",n.setAttribute("aria-live","polite"),n.setAttribute("aria-atomic","true"),n.className="sr-only",document.body.appendChild(n)),n.textContent=e,setTimeout(()=>{n.textContent=""},1e3)}async function Ea(e){if(!pe.isActive)return;const t=e.getBoundingClientRect(),n=t.left+t.width/2,o=t.top+t.height/2,i=document.elementFromPoint(n,o),r=i==null?void 0:i.closest(".desktop-folder-icon[data-item-id]");if(r&&r!==e){const a=e.getAttribute("data-item-id"),s=r.getAttribute("data-item-id"),l=Ot(s);if(s==="compostbin"){await to(a,"C://Desktop"),_e("Icon moved to compost bin."),tn(!0);return}else if(l&&l.type==="folder"){await wn(a,s),_e(`Icon moved to ${l.name} folder.`),tn(!0);return}}tn(!0)}function bn(e){let t=!1,n,o,i=5,r=0;e.addEventListener("pointerdown",function(a){if(!a.isPrimary||pe.isActive)return;a.preventDefault(),t=!1,n=a.clientX,o=a.clientY,r=Date.now();const s=e.getBoundingClientRect(),l=a.clientX-s.left,c=a.clientY-s.top,f=a.pointerType==="touch";function p(u){if(!u.isPrimary)return;const m=Math.sqrt(Math.pow(u.clientX-n,2)+Math.pow(u.clientY-o,2));!t&&m>i&&(t=!0,e.classList.add("dragging"),f&&(e.classList.add("touch-dragging"),navigator.vibrate&&navigator.vibrate(50)),e.style.zIndex="1000",document.querySelectorAll(".desktop-folder-icon[data-item-id]").forEach(g=>{const x=Ot(g.getAttribute("data-item-id")),b=g.getAttribute("data-item-id");(x&&x.type==="folder"||b==="compostbin")&&g!==e&&g.classList.add("drag-hover-target")}),document.body.style.overflow="hidden",_e("Drag started. Move to reposition or drop on a folder.")),t&&(e.style.left=u.clientX-l+"px",e.style.top=u.clientY-c+"px",e.style.position="absolute",Rt(e),ji(u.clientX,u.clientY,e))}async function d(u){if(u.isPrimary){if(document.removeEventListener("pointermove",p),document.removeEventListener("pointerup",d),document.removeEventListener("pointercancel",d),t){e.style.zIndex="",e.classList.remove("dragging");const m=e.style.pointerEvents;e.style.pointerEvents="none";const g=document.elementFromPoint(u.clientX,u.clientY);e.style.pointerEvents=m;const x=g?g.closest(".desktop-folder-icon[data-item-id]"):null,b=g?g.closest(".file-explorer-window"):null;if(x&&x!==e){const I=x.getAttribute("data-item-id"),h=Ot(I),H=e.getAttribute("data-item-id");if(H!==I){if(I==="compostbin"){await to(H,"C://Desktop");return}else if(h&&h.type==="folder"){await wn(H,I);return}}}else if(b){const I=e.getAttribute("data-item-id"),h=b.getAttribute("data-current-path");if(h&&I){await Un(I,h);return}}Rt(e),me[e.id]={left:e.style.left,top:e.style.top},Q()}document.querySelectorAll(".drag-hover-target").forEach(m=>{m.classList.remove("drag-hover-target")}),document.querySelectorAll(".desktop-folder-icon").forEach(m=>{m.classList.remove("dragover")}),document.querySelectorAll(".file-explorer-window").forEach(m=>{m.classList.remove("dragover")}),document.body.style.overflow="",t=!1}}document.addEventListener("pointermove",p),document.addEventListener("pointerup",d),document.addEventListener("pointercancel",d)}),e.addEventListener("click",function(a){const s=Date.now()-r;!t&&s>100&&(document.querySelectorAll(".draggable-icon").forEach(l=>l.classList.remove("bg-gray-50")),e.classList.add("bg-gray-50"))})}function Sa(){const e=document.getElementById("bgColorInput").value,t=document.getElementById("bgImageInput").value.trim(),n=document.getElementById("clockSecondsInput").checked;be.bgColor=e,be.bgImage=t,be.clockSeconds=n,qi(),Q()}async function ye(){const e=document.getElementById("desktop-icons");e.innerHTML="",document.getElementById("windows-container").querySelectorAll(".desktop-folder-icon").forEach(c=>{c.parentElement&&c.parentElement.classList.contains("draggable-icon")&&c.parentElement.remove()});let o=await Re();if(!o||!o.folders||!o.folders["C://Desktop"]){if(typeof Kn=="function")await Kn(),o=await Re();else if(console.warn("initializeAppState not available, using default fileSystemState"),typeof window.fileSystemState<"u"?o=window.fileSystemState:typeof Ne<"u"?o=Ne:(console.error("No fileSystemState available, creating minimal fallback structure"),o={folders:{"C://":{Documents:{id:"Documents",name:"Documents",type:"folder",fullPath:"C://Documents",contents:{}},Desktop:{id:"Desktop",name:"Desktop",type:"folder",fullPath:"C://Desktop",contents:{compostbin:{id:"compostbin",name:"Compost Bin",type:"app",fullPath:"C://Desktop/compostbin",content_type:"html",contents:{},icon:"./image/compost-bin.webp"}}},Media:{id:"Media",name:"Media",type:"folder",fullPath:"C://Media",contents:{}}},"A://":{},"D://":{}}}),typeof ke=="function")try{ke(o)}catch(c){console.warn("Failed to update global file system state:",c)}}if(!o||!o.folders||!o.folders["C://Desktop"]){console.error("File system structure is still invalid after initialization attempts:",o);return}const i=o.folders["C://Desktop"]||{};i||(o.folders["C://Desktop"]={});const r=[];Object.values(i).forEach(c=>{const f=document.createElement("div");f.id="icon-"+c.id,f.className="flex flex-col items-center cursor-pointer draggable-icon desktop-folder-icon z-10 h-32 truncate-ellipsis w-24 text-wrap absolute",f.setAttribute("role","button"),f.setAttribute("tabindex","0"),f.setAttribute("aria-label",`${c.name} - Double-click to open`);let p=c.type==="folder"?"image/folder.webp":"image/file.webp";c.icon?p=c.icon:c.icon_url&&(p=c.icon_url),f.setAttribute("data-item-id",c.id),f.setAttribute("data-current-path","C://Desktop");const d=()=>{c.type==="ugc-file"||c.type==="file"?$t(c.id,null):c.type==="app"?en(c.id):c.type==="folder"?yt(c.id):c.type==="shortcut"&&Jt(f)};if(c.type==="ugc-file"||c.type==="file"?(f.addEventListener("dblclick",u=>{u.stopPropagation(),$t(c.id,u)}),f.addEventListener("mobiledbltap",u=>{u.stopPropagation(),$t(c.id,u)})):c.type==="app"?(f.dataset.isVendorApplication=!0,p=c.icon,f.addEventListener("dblclick",()=>en(c.id)),f.addEventListener("mobiledbltap",()=>en(c.id))):c.type==="folder"?(f.addEventListener("dblclick",()=>yt(c.id)),f.addEventListener("mobiledbltap",()=>yt(c.id))):c.type==="shortcut"&&(f.dataset.url=c.url,p=c.icon_url,f.addEventListener("dblclick",()=>Jt(f)),f.addEventListener("mobiledbltap",()=>Jt(f))),f.addEventListener("keydown",function(u){if(u.key==="Enter"||u.key===" ")pe.isActive&&pe.selectedIcon===f?(u.preventDefault(),Ea(f)):pe.isActive||(u.preventDefault(),d());else if(u.key==="Escape")pe.isActive&&pe.selectedIcon===f&&(u.preventDefault(),tn(!1));else if(u.key==="d"&&u.ctrlKey)u.preventDefault(),ma(f);else if(u.key==="x"&&u.ctrlKey)u.preventDefault(),ya(f);else if(u.key==="v"&&u.ctrlKey)u.preventDefault(),ba();else if(u.key==="g"&&pe.isActive&&pe.selectedIcon===f)u.preventDefault(),ha(f);else if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(u.key)){if(pe.isActive&&pe.selectedIcon===f)u.preventDefault(),ga(f,u.key);else if(u.shiftKey){u.preventDefault();const m=parseInt(f.style.left)||0,g=parseInt(f.style.top)||0,x=5;let b=m,I=g;switch(u.key){case"ArrowUp":I=Math.max(16,g-x);break;case"ArrowDown":I=g+x;break;case"ArrowLeft":b=Math.max(16,m-x);break;case"ArrowRight":b=m+x;break}f.style.left=b+"px",f.style.top=I+"px",Rt(f),me[f.id]={left:f.style.left,top:f.style.top},Q(),_e(`Icon moved to position ${b}, ${I}`)}}}),f.innerHTML=`
      <img src="${p}" alt="${c.name} icon" class="mb-1 p-1 h-16 w-16 desktop-folder-icon" />
      <span class="text-xs text-black max-w-20 text-center desktop-folder-icon truncate block">${c.name}</span>
    `,me[f.id]){const u=me[f.id];f.style.left=u.left,f.style.top=u.top,r.push({left:parseInt(u.left),top:parseInt(u.top),width:96,height:128})}else{const u=Ia(r);f.style.left=u.left+"px",f.style.top=u.top+"px",r.push({left:u.left,top:u.top,width:96,height:128})}e.appendChild(f),bn(f),_i(f)});let a=0,s=0;e.querySelectorAll(".draggable-icon").forEach(c=>{const f=parseInt(c.style.left)||0,p=parseInt(c.style.top)||0;a=Math.max(a,f+100),s=Math.max(s,p+140)}),e.style.minWidth="100%",e.style.minHeight="100%",e.style.width=Math.max(window.innerWidth-32,a)+"px",e.style.height=Math.max(window.innerHeight-80,s)+"px",typeof Pe=="function"&&Pe()}function qi(){const e=document.getElementById("desktop");be.bgColor&&(e.style.backgroundColor=be.bgColor),be.bgImage?(e.style.backgroundImage=`url(${be.bgImage})`,e.style.backgroundSize="cover",e.style.backgroundRepeat="no-repeat"):e.style.backgroundImage="none"}function Ca(){return`
    <div class="space-y-4">
      <div>
        <label for="bgColorInput" class="block text-sm font-medium">Desktop Background Color:</label>
        <input id="bgColorInput" type="color" value="${be.bgColor}" class="border mt-1" aria-describedby="bgColorHelp" />
        <p id="bgColorHelp" class="text-xs text-gray-600 mt-1">Choose a color for your desktop background</p>
      </div>
      <div>
        <label for="bgImageInput" class="block text-sm font-medium">Background Image URL:</label>
        <input id="bgImageInput" type="text" placeholder="Enter image URL" value="${be.bgImage}" class="border w-full mt-1" aria-describedby="bgImageHelp" />
        <p id="bgImageHelp" class="text-xs text-gray-600 mt-1">Enter a URL to display an image as your desktop background</p>
      </div>
      <div>
        <label for="clockSecondsInput" class="block text-sm font-medium">Show Seconds on Clock:</label>
        <input id="clockSecondsInput" type="checkbox" ${be.clockSeconds?"checked":""} class="mt-1" aria-describedby="clockSecondsHelp" />
        <p id="clockSecondsHelp" class="text-xs text-gray-600 mt-1">Display seconds in the taskbar clock</p>
      </div>
      <button id="settings-apply-button"
              class="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2"
              aria-label="Apply desktop settings changes">
        <span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Apply</span>
      </button>
    </div>
  `}function Ia(e,t=96,n=128,o=16){const a=t+o,s=n+o,c=document.getElementById("desktop").getBoundingClientRect(),f=c.width-t,p=c.height-n-40;let d=16,u=16;for(;d<=f;){for(;u<=p;){const m={left:d,top:u,right:d+t,bottom:u+n};let g=!1;for(const x of e){const b={left:x.left,top:x.top,right:x.left+x.width,bottom:x.top+x.height};if(!(m.right<=b.left||m.left>=b.right||m.bottom<=b.top||m.top>=b.bottom)){g=!0;break}}if(!g)return{left:d,top:u};u+=s}u=16,d+=a}return{left:16,top:16}}function Rt(e){const n=document.getElementById("desktop").getBoundingClientRect(),o=e.getBoundingClientRect();let i=parseInt(e.style.left)||0,r=parseInt(e.style.top)||0;i=Math.max(0,Math.min(i,n.width-o.width)),r=Math.max(0,Math.min(r,n.height-o.height-40)),e.style.left=i+"px",e.style.top=r+"px"}function Ot(e){const t=le();for(const n in t.folders){const o=t.folders[n];if(o[e])return o[e];if(o.contents&&o.contents[e])return o.contents[e]}return null}function _i(e){let t=0;e.addEventListener("pointerdown",function(n){let o=new Date().getTime(),i=o-t;if(i<300&&i>0){let r=new Event("mobiledbltap");e.dispatchEvent(r)}t=o})}document.querySelectorAll("[onmobiledbltap]").forEach(e=>{_i(e),e.addEventListener("mobiledbltap",function(){let t=e.getAttribute("onmobiledbltap");if(t)try{const n=new CustomEvent("mobiledbltap-action",{detail:{action:t,element:e}});document.dispatchEvent(n)}catch(n){console.error(`Error dispatching event for: ${t}`,n)}})});document.addEventListener("mobiledbltap-action",function(e){const{action:t,element:n}=e.detail,o=["openExplorerInNewWindow","openApp","openShortcut"],i=t.match(/^(\w+)\((.*)\)$/);if(i){const[,r,a]=i;if(o.includes(r))try{if(r==="openExplorerInNewWindow"&&window.openExplorerInNewWindow){const s=a.replace(/['"]/g,"");window.openExplorerInNewWindow(s)}else if(r==="openApp"&&window.openApp){const s=a.replace(/['"]/g,"");window.openApp(s)}else r==="openShortcut"&&window.openShortcut&&window.openShortcut(n)}catch(s){console.error(`Error executing safe action ${r}:`,s)}else console.warn(`Blocked potentially unsafe action: ${r}`)}else console.warn(`Invalid action format: ${t}`)});function ji(e,t,n){document.querySelectorAll(".desktop-folder-icon").forEach(s=>{s.classList.remove("dragover")}),document.querySelectorAll(".file-explorer-window").forEach(s=>{s.classList.remove("dragover")});const o=n.style.pointerEvents;n.style.pointerEvents="none";const i=document.elementFromPoint(e,t),r=i?i.closest(".desktop-folder-icon[data-item-id]"):null,a=i?i.closest(".file-explorer-window"):null;if(n.style.pointerEvents=o,r&&r!==n){const s=r.getAttribute("data-item-id"),l=Ot(s);(l&&l.type==="folder"||s==="compostbin")&&r.classList.add("dragover")}else a&&a.classList.add("dragover")}typeof window<"u"&&(window.renderDesktopIcons=ye,window.makeIconDraggable=bn,window.applyDesktopSettings=qi,Ma());function Pe(){requestAnimationFrame(()=>{document.querySelectorAll(".file-item").forEach(o=>{o.removeEventListener("dragstart",zo),o.removeEventListener("dragover",Wo),o.removeEventListener("dragleave",No),o.removeEventListener("drop",Ro),o.removeEventListener("dragend",Oo),o.setAttribute("draggable",!0),o.addEventListener("dragstart",zo),o.addEventListener("dragover",Wo),o.addEventListener("dragleave",No),o.addEventListener("drop",Ro),o.addEventListener("dragend",Oo)}),document.querySelectorAll(".file-explorer-window").forEach(o=>{o.removeEventListener("dragover",jo),o.removeEventListener("dragleave",Uo),o.removeEventListener("drop",Yo),o.addEventListener("dragover",jo),o.addEventListener("dragleave",Uo),o.addEventListener("drop",Yo)}),document.querySelectorAll(".desktop-folder-icon[data-item-id]").forEach(o=>{const i=o.getAttribute("data-item-id"),r=mo(i);(r&&r.type==="folder"||i==="compostbin")&&(o.removeEventListener("dragover",Ho),o.removeEventListener("dragleave",qo),o.removeEventListener("drop",_o),o.addEventListener("dragover",Ho),o.addEventListener("dragleave",qo),o.addEventListener("drop",_o))})})}function zo(e){e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",this.getAttribute("data-item-id")),this.classList.add("dragging")}function Wo(e){(e.dataTransfer.types.includes("application/x-compost-item")||e.dataTransfer.types.includes("text/plain"))&&(e.preventDefault(),e.dataTransfer.dropEffect="move",this.classList.add("dragover"))}function No(e){this.classList.remove("dragover")}async function Ro(e){e.stopPropagation(),this.classList.remove("dragover");const t=e.dataTransfer.getData("text/plain"),n=this.getAttribute("data-item-id"),o=e.dataTransfer.getData("application/x-compost-item")==="true";if(t===n)return;const i=document.querySelector(`[data-item-id="${t}"]`),r=this;if(o){if(r.classList.contains("folder-item")){const a=r.closest(".file-explorer-window"),s=a?a.getAttribute("data-current-path"):"C://",l=s==="C://"?s+n:s+"/"+n;await go(t,l)}return}if(r.classList.contains("folder-item"))await wn(t,n);else{const a=this.getBoundingClientRect(),s=e.clientY-a.top,l=this.parentElement;s<a.height/2?l.insertBefore(i,this):l.insertBefore(i,this.nextSibling),await La()}i&&i.classList.remove("dragging")}function Oo(e){this.classList.remove("dragging"),document.querySelectorAll(".file-item").forEach(n=>n.classList.remove("dragover"));const t=document.getElementById("desktop");t&&t.classList.remove("drag-hover-target"),document.querySelectorAll(".drag-hover-target").forEach(n=>{n.classList.remove("drag-hover-target")})}async function wn(e,t){let n=le();const o=fo(e,n);if(!o){console.error("Item not found:",e);return}const{item:i,parent:r}=o,a=i.fullPath&&i.fullPath.includes("C://Desktop");if(delete r[e],a){const c="icon-"+e;me[c]&&delete me[c]}let s=findFolderFullPathById(t),l=findFolderObjectByFullPath(s,n);if(!l){console.error("Target folder not found:",t);return}l.contents||(l.contents={}),l.contents[e]=i,/^[A-Z]:\/\/$/.test(s)||(n.folders[s]||(n.folders[s]={}),n.folders[s][e]=i),i.fullPath=s+"/"+i.name,await ke(n),Q(),it(),(s.includes("Desktop")||Ui(e).includes("Desktop"))&&ye()}async function Un(e,t){let n=le();const o=fo(e,n);if(!o){console.error("Item not found:",e);return}const{item:i,parent:r}=o,a=i.fullPath&&i.fullPath.includes("C://Desktop");if(delete r[e],a){const s="icon-"+e;typeof me<"u"&&me[s]&&delete me[s]}n.folders[t]||(n.folders[t]={}),n.folders[t][e]=i,i.fullPath=t+"/"+i.name,await ke(n),Q(),it(),(t.includes("Desktop")||a)&&ye()}async function La(){const e=document.querySelector(".file-explorer-window");if(!e)return;const t=e.getAttribute("data-current-path"),n=Array.from(e.querySelectorAll("ul > li"));let o=le(),i=findFolderObjectByFullPath(t,o);if(!i||!i.contents)return;let r={};n.forEach(a=>{const s=a.getAttribute("data-item-id");i.contents[s]&&(r[s]=i.contents[s])}),i.contents=r,await ke(o),Q()}function fo(e,t){for(const n in t.folders){const o=t.folders[n];if(o[e])return{item:o[e],parent:o};if(o.contents&&o.contents[e])return{item:o.contents[e],parent:o.contents}}return null}function mo(e){const t=le();for(const n in t.folders){const o=t.folders[n];if(o[e])return o[e];if(o.contents&&o.contents[e])return o.contents[e]}return null}function Ui(e){const t=le();for(const n in t.folders){const o=t.folders[n];if(o[e]||o.contents&&o.contents[e])return n}return""}function Ho(e){(e.dataTransfer.types.includes("application/x-compost-item")||e.dataTransfer.types.includes("text/plain"))&&(e.preventDefault(),e.dataTransfer.dropEffect="move",this.classList.add("dragover"))}function qo(e){this.classList.remove("dragover")}async function _o(e){e.preventDefault(),e.stopPropagation(),this.classList.remove("dragover");const t=e.dataTransfer.getData("text/plain"),n=this.getAttribute("data-item-id"),o=e.dataTransfer.getData("application/x-compost-item")==="true";if(t&&n&&t!==n)if(o){const i=mo(n);i&&i.type==="folder"&&await go(t,i.fullPath)}else if(n==="compostbin"){const i=Ui(t);await moveItemToCompostBin(t,i)}else await wn(t,n)}function jo(e){e.dataTransfer.types.includes("text/plain")&&(e.preventDefault(),e.dataTransfer.dropEffect="move",this.classList.add("dragover"))}function Uo(e){this.contains(e.relatedTarget)||this.classList.remove("dragover")}async function Yo(e){e.preventDefault(),e.stopPropagation(),this.classList.remove("dragover");const t=e.dataTransfer.getData("text/plain"),n=this.getAttribute("data-current-path");if(t&&n){const o=mo(t);if(o){const i=o.fullPath;if(i&&i.startsWith(n))return;i&&i.includes("C://Desktop")?await Un(t,n):await Un(t,n)}}}Pe();async function go(e,t){const n=le(),i=(n.folders["C://Desktop"]||{}).compostbin;if(!i||!i.contents||!i.contents[e]){console.error("Item not found in compost bin:",e);return}const r=i.contents[e];delete i.contents[e];let a;if(t==="C://Desktop")n.folders["C://Desktop"]||(n.folders["C://Desktop"]={}),a=n.folders["C://Desktop"];else{const l=findFolderObjectByFullPath(t,n);if(!l){console.error("Target folder not found:",t);return}l.contents||(l.contents={}),a=l.contents}r.fullPath=t+"/"+r.id,a[e]=r,await ke(n),Q(),it(),ye();const s=document.getElementById("compost-bin");if(s){const l=s.querySelector("#compost-bin-content");l&&(loadCompostBinContents(l),updateCompostBinHeader(s))}}function Ma(){const e=document.getElementById("desktop");e&&(e.addEventListener("dragover",t=>{const n=t.dataTransfer.types.includes("application/x-compost-item"),o=t.dataTransfer.types.includes("text/plain");(n||o)&&(t.preventDefault(),t.dataTransfer.dropEffect="move",e.classList.add("drag-hover-target"))}),e.addEventListener("dragleave",t=>{e.contains(t.relatedTarget)||e.classList.remove("drag-hover-target")}),e.addEventListener("drop",async t=>{t.preventDefault(),e.classList.remove("drag-hover-target");const n=t.dataTransfer.getData("application/x-compost-item")==="true",o=t.dataTransfer.getData("text/plain");o&&(n?await go(o,"C://Desktop"):await Aa(o))}))}async function Aa(e){const t=le(),n=fo(e,t);if(!n){console.error("Item not found:",e);return}const{item:o,parent:i}=n;o.fullPath&&o.fullPath==="C://Desktop/"+o.id||(delete i[e],t.folders["C://Desktop"]||(t.folders["C://Desktop"]={}),t.folders["C://Desktop"][e]=o,o.fullPath="C://Desktop/"+o.id,await ke(t),Q(),it(),ye())}let ne=null;function Yi(){if(!(window.innerWidth<=768))return;const t=document.getElementById("desktop-stage");t&&(ne={stage:t,vertical:null,horizontal:null,isDragging:!1,dragStart:{x:0,y:0},scrollStart:{x:0,y:0}},Da(),Ba(),t.addEventListener("scroll",Nn,{passive:!0}),window.addEventListener("resize",()=>{Go(),Nn()}),Go(),Nn())}function Da(){const{stage:e}=ne,t=document.createElement("div");t.id="custom-scrollbar-vertical",t.className="custom-scrollbar-track custom-scrollbar-vertical",t.style.opacity="0";const n=document.createElement("div");n.className="custom-scrollbar-button custom-scrollbar-up",n.innerHTML='<svg width="10" height="10" viewBox="0 0 10 10"><path d="M5 2 L9 8 L1 8 Z" fill="black"/></svg>',t.appendChild(n);const o=document.createElement("div");o.className="custom-scrollbar-track-area";const i=document.createElement("div");i.className="custom-scrollbar-thumb",o.appendChild(i),t.appendChild(o);const r=document.createElement("div");r.className="custom-scrollbar-button custom-scrollbar-down",r.innerHTML='<svg width="10" height="10" viewBox="0 0 10 10"><path d="M5 8 L9 2 L1 2 Z" fill="black"/></svg>',t.appendChild(r),document.body.appendChild(t),ne.vertical={track:t,trackArea:o,thumb:i,upBtn:n,downBtn:r},Ta()}function Ba(){const{stage:e}=ne,t=document.createElement("div");t.id="custom-scrollbar-horizontal",t.className="custom-scrollbar-track custom-scrollbar-horizontal",t.style.opacity="0";const n=document.createElement("div");n.className="custom-scrollbar-button custom-scrollbar-left",n.innerHTML='<svg width="10" height="10" viewBox="0 0 10 10"><path d="M2 5 L8 9 L8 1 Z" fill="black"/></svg>',t.appendChild(n);const o=document.createElement("div");o.className="custom-scrollbar-track-area";const i=document.createElement("div");i.className="custom-scrollbar-thumb",o.appendChild(i),t.appendChild(o);const r=document.createElement("div");r.className="custom-scrollbar-button custom-scrollbar-right",r.innerHTML='<svg width="10" height="10" viewBox="0 0 10 10"><path d="M8 5 L2 9 L2 1 Z" fill="black"/></svg>',t.appendChild(r),document.body.appendChild(t),ne.horizontal={track:t,trackArea:o,thumb:i,leftBtn:n,rightBtn:r},Fa()}function Ta(){const{stage:e,vertical:t}=ne,{thumb:n,upBtn:o,downBtn:i,trackArea:r}=t;n.addEventListener("pointerdown",l=>{l.preventDefault(),ne.isDragging=!0,ne.dragStart.y=l.clientY,ne.scrollStart.y=e.scrollTop,document.body.style.userSelect="none",n.style.cursor="grabbing"});let a;o.addEventListener("pointerdown",l=>{l.preventDefault(),e.scrollTop-=40,a=setInterval(()=>{e.scrollTop-=40},100)}),o.addEventListener("pointerup",()=>clearInterval(a)),o.addEventListener("pointerleave",()=>clearInterval(a));let s;i.addEventListener("pointerdown",l=>{l.preventDefault(),e.scrollTop+=40,s=setInterval(()=>{e.scrollTop+=40},100)}),i.addEventListener("pointerup",()=>clearInterval(s)),i.addEventListener("pointerleave",()=>clearInterval(s)),r.addEventListener("pointerdown",l=>{if(l.target===n)return;l.preventDefault();const c=r.getBoundingClientRect(),f=l.clientY-c.top,d=n.getBoundingClientRect().top-c.top;f<d?e.scrollTop-=e.clientHeight*.9:e.scrollTop+=e.clientHeight*.9})}function Fa(){const{stage:e,horizontal:t}=ne,{thumb:n,leftBtn:o,rightBtn:i,trackArea:r}=t;n.addEventListener("pointerdown",l=>{l.preventDefault(),ne.isDragging=!0,ne.dragStart.x=l.clientX,ne.scrollStart.x=e.scrollLeft,document.body.style.userSelect="none",n.style.cursor="grabbing"});let a;o.addEventListener("pointerdown",l=>{l.preventDefault(),e.scrollLeft-=40,a=setInterval(()=>{e.scrollLeft-=40},100)}),o.addEventListener("pointerup",()=>clearInterval(a)),o.addEventListener("pointerleave",()=>clearInterval(a));let s;i.addEventListener("pointerdown",l=>{l.preventDefault(),e.scrollLeft+=40,s=setInterval(()=>{e.scrollLeft+=40},100)}),i.addEventListener("pointerup",()=>clearInterval(s)),i.addEventListener("pointerleave",()=>clearInterval(s)),r.addEventListener("pointerdown",l=>{if(l.target===n)return;l.preventDefault();const c=r.getBoundingClientRect(),f=l.clientX-c.left,d=n.getBoundingClientRect().left-c.left;f<d?e.scrollLeft-=e.clientWidth*.9:e.scrollLeft+=e.clientWidth*.9})}document.addEventListener("pointermove",e=>{if(!ne||!ne.isDragging)return;const{stage:t,vertical:n,horizontal:o,dragStart:i,scrollStart:r}=ne;if(n&&Math.abs(e.clientY-i.y)>Math.abs(e.clientX-i.x)){const{trackArea:a}=n,s=a.getBoundingClientRect(),l=e.clientY-i.y,c=t.scrollHeight/s.height;t.scrollTop=r.y+l*c}else if(o&&Math.abs(e.clientX-i.x)>Math.abs(e.clientY-i.y)){const{trackArea:a}=o,s=a.getBoundingClientRect(),l=e.clientX-i.x,c=t.scrollWidth/s.width;t.scrollLeft=r.x+l*c}});document.addEventListener("pointerup",()=>{ne&&ne.isDragging&&(ne.isDragging=!1,document.body.style.userSelect="",ne.vertical&&(ne.vertical.thumb.style.cursor="grab"),ne.horizontal&&(ne.horizontal.thumb.style.cursor="grab"))});function Go(){if(!ne)return;const{stage:e,vertical:t,horizontal:n}=ne;if(t){const{track:o,trackArea:i,thumb:r}=t,a=e.scrollHeight>e.clientHeight;if(o.style.display=a?"flex":"none",a){const s=Math.max(40,e.clientHeight/e.scrollHeight*i.clientHeight);r.style.height=s+"px"}}if(n){const{track:o,trackArea:i,thumb:r}=n,a=e.scrollWidth>e.clientWidth;if(o.style.display=a?"flex":"none",a){const s=Math.max(40,e.clientWidth/e.scrollWidth*i.clientWidth);r.style.width=s+"px"}}}function Nn(){if(!ne)return;const{stage:e,vertical:t,horizontal:n}=ne;if(t&&t.track.style.display!=="none"){const{trackArea:o,thumb:i}=t,r=e.scrollTop/(e.scrollHeight-e.clientHeight),a=o.clientHeight-i.clientHeight,s=r*a;i.style.transform=`translateY(${s}px)`}if(n&&n.track.style.display!=="none"){const{trackArea:o,thumb:i}=n,r=e.scrollLeft/(e.scrollWidth-e.clientWidth),a=o.clientWidth-i.clientWidth,s=r*a;i.style.transform=`translateX(${s}px)`}}function We(){ne&&(ne.vertical&&(ne.vertical.track.style.transition="opacity 0.3s ease",ne.vertical.track.style.opacity="1"),ne.horizontal&&(ne.horizontal.track.style.transition="opacity 0.3s ease",ne.horizontal.track.style.opacity="1"))}function pt(){ne&&(ne.vertical&&(ne.vertical.track.style.transition="opacity 0.3s ease",ne.vertical.track.style.opacity="0"),ne.horizontal&&(ne.horizontal.track.style.transition="opacity 0.3s ease",ne.horizontal.track.style.opacity="0"))}typeof window<"u"&&(window.initializeCustomScrollbars=Yi,window.showCustomScrollbars=We,window.hideCustomScrollbars=pt);function ho(e,t){const n={calculator:"image/calculator.webp",mediaplayer:"image/video.webp",bombbroomer:"image/bombbroomer.webp",solitaire:"image/solitaire.webp",pong:"image/pong.webp",snake:"image/snake.webp",happyturd:"image/happyturd.webp",chess:"image/guillotine_chess.webp",mailbox:"image/mail.webp",watercolour:"image/watercolour.webp",compostbin:"image/compost-bin.webp",storage:"image/drive_c.webp","explorer-window":"image/computer.webp",tubestream:"image/youtube.webp"},o={Settings:"image/gears.webp","About This Computer":"image/info.webp","My Computer":"image/computer.webp","File Explorer":"image/computer.webp","Media Player":"image/video.webp",Calculator:"image/calculator.webp",Bombbroomer:"image/bombbroomer.webp",Solitaire:"image/solitaire.webp",Pong:"image/pong.webp",Snake:"image/snake.webp","Happy Turd":"image/happyturd.webp","Guillotine Chess":"image/guillotine_chess.webp",Chess:"image/guillotine_chess.webp","Mail Box":"image/mail.webp",Watercolour:"image/watercolour.webp","Compost Bin":"image/compost-bin.webp","Storage Manager":"image/drive_c.webp",TubeStream:"image/youtube.webp","Security Policy":"image/info.webp"};if(n[e])return n[e];if(o[t])return o[t];if(e&&e.includes("-")){const i=t.toLowerCase(),r=e.toLowerCase();if(i.match(/\.(jpg|jpeg|png|gif|webp|avif|bmp)$/i)||r.match(/\.(jpg|jpeg|png|gif|webp|avif|bmp)$/i))return"image/image.webp";if(i.match(/\.(mp4|webm|avi|mov|mkv)$/i)||r.match(/\.(mp4|webm|avi|mov|mkv)$/i))return"image/video.webp";if(i.match(/\.(mp3|wav|ogg|m4a|flac)$/i)||r.match(/\.(mp3|wav|ogg|m4a|flac)$/i))return"image/audio.webp";if(i.match(/\.(txt|md|doc|docx)$/i)||r.match(/\.(txt|md|doc|docx)$/i)||i.includes("letterpad"))return"image/file.webp";if(i.match(/\.(html|htm)$/i)||r.match(/\.(html|htm)$/i))return"image/html.webp"}return t.includes("LetterPad")||t.includes(".md")||t.includes(".txt")?"image/file.webp":t.includes(".jpg")||t.includes(".png")||t.includes(".gif")||t.includes(".webp")||t.includes(".jpeg")||t.includes(".bmp")||t.includes(".avif")?"image/image.webp":t.includes(".mp4")||t.includes(".webm")||t.includes(".avi")||t.includes(".mov")||t.includes(".mkv")?"image/video.webp":t.includes(".mp3")||t.includes(".wav")||t.includes(".ogg")||t.includes(".m4a")||t.includes(".flac")?"image/audio.webp":t.includes(".html")||t.includes(".htm")?"image/html.webp":null}function se(e,t,n=!1,o=null,i=!1,r=!1,a={type:"default"},s="default",l=null,c="white",f=null){let p=t;o||(o="window-"+Date.now()),s==="Settings"&&(p=Ca()),s==="Explorer"&&(p=t||getExplorerWindowContent()),s==="App"&&(p=t);let d="";a.type==="integer"?d=`width: ${a.width}px; height: ${a.height}px; max-width:100%;`:d="width: 100%; height: 100%;";const u=document.createElement("div");u.id=o,u.className="absolute border border-gray-500 shadow-lg overflow-auto z-20",u.style.cssText=d,u.style.minWidth="320px",u.style.minHeight="200px",u.setAttribute("role","dialog"),u.setAttribute("aria-label",e),u.setAttribute("aria-modal","false"),i?(u.style.display="none",u.setAttribute("aria-hidden","true")):u.setAttribute("aria-hidden","false"),u.textContent="";const m=document.createElement("div");m.className="relative w-full h-[calc(100%-2.5rem)]";const g=document.createElement("div");g.className="bg-handlebar-blue sticky top-0 left-0 text-white px-2 py-1 flex justify-between items-center cursor-move",g.style.backgroundColor="#003f7f",g.setAttribute("role","banner");const x=document.createElement("span");x.textContent=e,x.className="window-title flex-1 truncate pr-2",x.style.maxWidth="calc(100% - 120px)",x.id=`${o}-title`;const b=document.createElement("div");b.className="my-1 flex-shrink-0",b.setAttribute("role","group"),b.setAttribute("aria-label","Window controls");const I=document.createElement("button");I.id=`minimizeWindow-${o}`,I.className="bg-yellow-500 h-6 w-6 text-white",I.textContent="_",I.setAttribute("aria-label",`Minimize ${e}`),I.setAttribute("title","Minimize window"),I.addEventListener("click",k=>{Je(o),k.stopPropagation()});const h=document.createElement("button");h.id=`toggleFullScreen-${o}`,h.className="bg-green-500 h-6 w-6 text-white ml-1",h.textContent="‚õ∂",h.setAttribute("aria-label",`Toggle fullscreen for ${e}`),h.setAttribute("title","Toggle fullscreen"),h.addEventListener("click",k=>{vt(o),k.stopPropagation()});const H=document.createElement("button");H.id=`closeWindow-${o}`,H.className="bg-red-500 h-6 w-6 text-white ml-1",H.textContent="X",H.setAttribute("aria-label",`Close ${e}`),H.setAttribute("title","Close window"),H.addEventListener("click",k=>{de(o),k.stopPropagation()}),b.append(I,h,H),g.append(x,b);const O=document.createElement("div");if(O.className=`p-2 bg-${c} h-full ${s==="editor"?"w-full":""} overflow-auto`,O.innerHTML=p,O.setAttribute("role","main"),O.setAttribute("aria-labelledby",`${o}-title`),s==="default"&&(O.setAttribute("role","textbox"),O.setAttribute("aria-label",`Editable content for ${e}`),O.addEventListener("input",()=>{updateContent(o,O.innerHTML)})),s==="Explorer"&&setTimeout(()=>{typeof Pe=="function"&&Pe()},50),m.append(g,O),u.appendChild(m),f!=null)u.style.zIndex=f,parseInt(f)>Se&&zt(parseInt(f));else{try{const k=document.getElementById("windows-container");if(k){let L=Se;const A=k.children;for(let M=0;M<A.length;M++){const S=parseInt(getComputedStyle(A[M]).zIndex)||0;S>L&&(L=S)}L>Se&&zt(L)}}catch{}zt(Se+1),u.style.zIndex=Se}u.addEventListener("click",function(){Ce(u)},!0),document.getElementById("windows-container").appendChild(u);const j=document.createElement("div");j.id="tab-"+o,j.className="bg-gray-200 border border-gray-500 px-2 py-1 cursor-pointer flex items-center",j.setAttribute("role","tab"),j.setAttribute("aria-label",`${e} window tab`),j.setAttribute("aria-pressed",i?"false":"true"),j.setAttribute("tabindex","0");const $=ho(o,e);if($){const k=document.createElement("img");k.src=$,k.className="h-4 w-4 mr-2",k.alt="",j.appendChild(k);const L=document.createElement("span");L.textContent=e,j.appendChild(L)}else j.textContent=e;const F=function(){u.style.display==="none"?(Ce(u),j.setAttribute("aria-pressed","true")):(Je(u.id),j.setAttribute("aria-pressed","false"))};j.onclick=F,j.addEventListener("keydown",function(k){(k.key==="Enter"||k.key===" ")&&(k.preventDefault(),F())}),j.addEventListener("contextmenu",function(k){k.preventDefault(),za(k,o,u)}),document.getElementById("window-tabs").appendChild(j);const N=J[o],_=N?N.position:null,V=N?N.dimensions:a,Z=N?N.fullScreen:!1;if(J[o]={id:o,title:e,content:p,isNav:n,isMinimized:i,dimensions:r&&N?V:a,windowType:s,position:_,fullScreen:Z,color:c,zIndex:parseInt(u.style.zIndex)||Se},n&&(Fe[e]=o),i||Ce(u),a.type!=="default"){if(r&&_&&(u.style.left=_.left,u.style.top=_.top),r&&V&&V.type==="integer"){const k=window.innerWidth,L=window.innerHeight-48,A=30,M=k-10,S=L-A-10,T=Math.max(320,Math.min(V.width,M)),X=Math.max(200,Math.min(V.height,S));u.style.width=T+"px",u.style.height=X+"px",J[o]&&(J[o].dimensions={type:"integer",width:T,height:X})}if(!r||!_)if(l){let k=parseInt(l.style.left,10)||0,L=parseInt(l.style.top,10)||0,A=k+30,M=L+30,S=window.innerWidth,T=window.innerHeight-40,X=a.width,ee=a.height;if(A+X>S||M+ee>T){A=0,M=0;const oe=Array.from(document.querySelectorAll("#windows-container > div")).find(te=>(parseInt(te.style.left,10)||0)<=10&&(parseInt(te.style.top,10)||0)<=10);oe&&(A=(parseInt(oe.style.left,10)||0)+30)}u.style.left=A+"px",u.style.top=M+"px"}else u.style.left="100px",u.style.top="100px";Ki(u),Xi(u)}r||Q();try{bo(u)}catch{}return r&&Z&&setTimeout(()=>{vt(o)},10),u}function Je(e){const t=document.getElementById(e);if(t){const n=J[e]&&J[e].fullScreen;t.style.display="none",t.setAttribute("aria-hidden","true"),J[e]&&(J[e].isMinimized=!0,Q());const o=document.getElementById("tab-"+e);if(o&&(o.classList.remove("bg-gray-50"),o.setAttribute("aria-pressed","false")),n&&!Object.values(J).some(r=>r.fullScreen&&!r.isMinimized)){typeof We=="function"&&We();const r=document.getElementById("desktop-stage");r&&(r.style.overflow="scroll")}}}function Ce(e){let t=!1;try{const r=document.getElementById("windows-container");if(r){let a=Se;const s=r.children;for(let l=0;l<s.length;l++){const c=parseInt(getComputedStyle(s[l]).zIndex)||0;c>a&&(a=c)}a>Se&&zt(a)}}catch{}const n=J[e.id]&&J[e.id].fullScreen,o=Object.keys(J).filter(r=>J[r].fullScreen).map(r=>document.getElementById(r)).filter(r=>r);if(e.style.display==="none"){e.style.display="block",e.setAttribute("aria-hidden","false"),J[e.id]&&(J[e.id].isMinimized=!1,t=!0);const r=document.getElementById("tab-"+e.id);if(r&&r.setAttribute("aria-pressed","true"),n){typeof pt=="function"&&pt();const a=document.getElementById("desktop-stage");a&&(a.style.overflow="hidden")}if(!n&&o.length>0){o.forEach(s=>{s.id!==e.id&&Je(s.id)}),typeof We=="function"&&We();const a=document.getElementById("desktop-stage");a&&(a.style.overflow="scroll")}}n&&o.forEach(r=>{if(J[r.id]&&J[r.id].fullScreen){const a=document.getElementById("desktop-stage"),s=a?a.scrollLeft:0,l=a?a.scrollTop:0;r.style.left=s+"px",r.style.top=l+"px"}}),zt(Se+1),e.style.zIndex=Se,J[e.id]&&(J[e.id].zIndex=Se,t=!0),t&&Q(),document.querySelectorAll("#window-tabs > div").forEach(r=>r.classList.remove("bg-gray-50"));const i=document.getElementById("tab-"+e.id);i&&i.classList.add("bg-gray-50"),e.querySelector("video, audio")&&(or(e.id),updateMediaControl())}let Ye=-1,sn=!1;function Yn(){const e=Array.from(document.querySelectorAll("#windows-container > div")).filter(t=>t.style.display!=="none"&&t.id!=="taskbar");if(e.length!==0){if(e.length===1){Ce(e[0]);return}e.sort((t,n)=>{const o=parseInt(t.style.zIndex)||0;return(parseInt(n.style.zIndex)||0)-o}),sn?Ye=(Ye+1)%e.length:($a(e),sn=!0,Ye=0),yo(Ye)}}function $a(e){const t=document.getElementById("window-cycle-popup"),n=document.getElementById("window-cycle-list");if(!t||!n)return;n.innerHTML="",e.forEach((i,r)=>{var p;const a=((p=i.querySelector(".window-title"))==null?void 0:p.textContent)||"Unknown Window",s=i.id,l=ho(s,a),c=document.createElement("div");if(c.className="flex flex-col items-center p-3 border-2 border-transparent rounded-lg min-w-16 cursor-pointer hover:bg-gray-100 transition-all duration-200",c.setAttribute("data-window-index",r),l){const d=document.createElement("img");d.src=l,d.className="h-8 w-8 mb-1",d.alt="",c.appendChild(d)}else{const d=document.createElement("div");d.className="h-8 w-8 mb-1 bg-gray-400 rounded flex items-center justify-center text-white text-sm",d.textContent=a.charAt(0),c.appendChild(d)}const f=document.createElement("span");f.className="text-xs text-center break-words max-w-16",f.textContent=a.length>10?a.substring(0,10)+"...":a,c.appendChild(f),c.addEventListener("click",()=>{Ye=r,Gi(e[r])}),n.appendChild(c)});const o=i=>{n.contains(i.target)||(wt(),t.removeEventListener("click",o))};t.addEventListener("click",o),t.classList.remove("hidden"),t.style.display="flex",yo(0)}function yo(e){const t=document.querySelectorAll("#window-cycle-list > div");t.forEach(n=>{n.classList.remove("border-blue-500","bg-blue-100"),n.classList.add("border-transparent"),n.style.transform="translateY(0)",n.style.boxShadow="none"}),t[e]&&(t[e].classList.remove("border-transparent"),t[e].classList.add("border-blue-500","bg-blue-100"),t[e].style.transform="translateY(-2px)",t[e].style.boxShadow="0 4px 8px rgba(59, 130, 246, 0.3)")}function Gi(e){var i;if(!e)return;Ce(e),e.focus();const t=document.getElementById("window-cycle-popup");t&&(t.classList.add("hidden"),t.style.display="none"),sn=!1,Ye=-1;const n=((i=e.querySelector(".window-title"))==null?void 0:i.textContent)||"Unknown Window";let o=document.getElementById("window-cycle-announce");o||(o=document.createElement("div"),o.id="window-cycle-announce",o.className="sr-only",o.setAttribute("aria-live","polite"),o.setAttribute("aria-atomic","true"),document.body.appendChild(o)),o.textContent=`Switched to ${n}`}function wt(){if(sn){const e=Array.from(document.querySelectorAll("#windows-container > div")).filter(t=>t.style.display!=="none"&&t.id!=="taskbar");if(e.length>0){e.sort((n,o)=>{const i=parseInt(n.style.zIndex)||0;return(parseInt(o.style.zIndex)||0)-i});const t=e[Ye]||e[0];Gi(t)}}}function Ko(){var n;const e=Array.from(document.querySelectorAll("#windows-container > div")).filter(o=>o.style.display!=="none"&&o.id!=="taskbar");if(e.length===0)return;e.sort((o,i)=>{const r=parseInt(o.style.zIndex)||0;return(parseInt(i.style.zIndex)||0)-r});const t=e[0];if(t){de(t.id);const o=((n=t.querySelector(".window-title"))==null?void 0:n.textContent)||"Unknown Window";let i=document.getElementById("window-cycle-announce");i||(i=document.createElement("div"),i.id="window-cycle-announce",i.className="sr-only",i.setAttribute("aria-live","polite"),i.setAttribute("aria-atomic","true"),document.body.appendChild(i)),i.textContent=`Closed ${o}`}}function Pa(){var n;const e=Array.from(document.querySelectorAll("#windows-container > div")).filter(o=>o.style.display!=="none"&&o.id!=="taskbar");if(e.length===0)return;e.sort((o,i)=>{const r=parseInt(o.style.zIndex)||0;return(parseInt(i.style.zIndex)||0)-r});const t=e[0];if(t){Je(t.id);const o=((n=t.querySelector(".window-title"))==null?void 0:n.textContent)||"Unknown Window";let i=document.getElementById("window-cycle-announce");i||(i=document.createElement("div"),i.id="window-cycle-announce",i.className="sr-only",i.setAttribute("aria-live","polite"),i.setAttribute("aria-atomic","true"),document.body.appendChild(i)),i.textContent=`Minimized ${o}`}}function de(e){const t=J[e]&&J[e].fullScreen,n=document.getElementById(e);n&&n.remove();const o=document.getElementById("tab-"+e);o&&o.remove(),xt===e&&(or(null),updateMediaControl()),delete J[e];for(const i in Fe)if(Fe[i]===e){delete Fe[i];break}if(t&&!Object.values(J).some(r=>r.fullScreen&&!r.isMinimized)){typeof We=="function"&&We();const r=document.getElementById("desktop-stage");r&&(r.style.overflow="scroll")}Q()}function Ki(e){const t=e.querySelector(".cursor-move");t&&t.addEventListener("mousedown",function(n){n.preventDefault();const o=e.getBoundingClientRect(),i=n.clientX-o.left,r=n.clientY-o.top;let a=0,s=0;const l=document.getElementById("desktop-stage");if(l){const p=getComputedStyle(l).transform;if(p&&p!=="none"){const d=p.match(/matrix\(([^)]+)\)/);if(d&&d[1]){const u=d[1].split(",").map(m=>parseFloat(m.trim()));u.length===6&&(a=u[4],s=u[5])}}}function c(p){let d=p.clientX-i-a,u=p.clientY-r-s;const m=window.innerHeight-48,g=-s+m-30;u<-s&&(u=-s),u>g&&(u=g),e.style.left=d+"px",e.style.top=u+"px"}function f(){document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",f),J[e.id]&&(J[e.id].position={left:e.style.left,top:e.style.top},Q())}document.addEventListener("mousemove",c),document.addEventListener("mouseup",f),Ce(e)})}function Xi(e){const t=document.createElement("div");t.className="absolute bottom-0 right-0 w-6 h-6 cursor-se-resize",t.style.background="rgba(0,0,0,0.2)",t.style.zIndex="1100",t.style.pointerEvents="auto",t.style.borderTop="1px solid rgba(255,255,255,0.2)",t.style.borderLeft="1px solid rgba(255,255,255,0.05)",e.appendChild(t),t.addEventListener("mousedown",function(n){n.preventDefault(),n.stopPropagation();const o=n.clientX,i=n.clientY,r=parseInt(document.defaultView.getComputedStyle(e).width,10),a=parseInt(document.defaultView.getComputedStyle(e).height,10);function s(c){const f=Math.max(r+c.clientX-o,350),p=Math.max(a+c.clientY-i,200);e.style.width=f+"px",e.style.height=p+"px"}function l(){document.documentElement.removeEventListener("mousemove",s,!1),document.documentElement.removeEventListener("mouseup",l,!1),J[e.id].dimensions={type:"integer",width:parseInt(e.style.width),height:parseInt(e.style.height)},Q()}document.documentElement.addEventListener("mousemove",s,!1),document.documentElement.addEventListener("mouseup",l,!1)})}function vt(e){const t=document.getElementById(e);if(!t)return;let n=J[e];const o=document.getElementById("desktop-stage"),i=o?o.scrollLeft:0,r=o?o.scrollTop:0;n.fullScreen?(n.originalDimensions&&n.originalPosition?(t.style.left=n.originalPosition.left,t.style.top=n.originalPosition.top,t.style.width=n.originalDimensions.width+"px",t.style.height=n.originalDimensions.height+"px",n.dimensions=n.originalDimensions):(t.style.left="15%",t.style.top="15%",t.style.width="70vw",t.style.height="70vh",n.dimensions={type:"integer",width:window.innerWidth*.7,height:window.innerHeight*.7}),n.fullScreen=!1,Ki(t),Xi(t),setTimeout(()=>bo(t),0),Object.values(J).some(s=>s.fullScreen)||(typeof We=="function"&&We(),o&&(o.style.overflow="scroll"))):(n.originalDimensions=n.dimensions,n.originalPosition=n.position,t.style.left=i+"px",t.style.top=r+"px",t.style.width="100vw",t.style.height="calc(100vh - 48px)",t.style.maxWidth="none",t.style.maxHeight="none",n.dimensions={type:"viewport"},n.fullScreen=!0,typeof pt=="function"&&pt(),o&&(o.style.overflow="hidden")),Q()}if(typeof window<"u"){const e=document.getElementById("desktop-stage");e&&e.addEventListener("scroll",()=>{Object.values(J).forEach(t=>{if(t.fullScreen){const n=document.getElementById(t.id);n&&(n.style.left=e.scrollLeft+"px",n.style.top=e.scrollTop+"px")}})},{passive:!0})}function re(e,t,n=null,o=null,i={}){const r=t==="confirmation"||t==="confirm",a=t==="prompt",s=(r||a?"promptWindow-":"dialogWindow-")+Date.now(),l=r&&(n||o);let c;if(a){const d=i.defaultValue||"";c=`
      <div class="flex flex-col p-4 h-full justify-between">
        <div class="mb-4">
          <p class="text-sm mb-3">${e}</p>
          <input type="text" id="${s}-input" value="${d.replace(/"/g,"&quot;")}" class="w-full px-2 py-1 border-2 border-gray-400 bg-white" style="border-top-color:#808080; border-left-color:#808080; border-bottom-color:#ffffff; border-right-color:#ffffff; border-style: inset;" aria-label="Text input for prompt dialog" title="Enter your response here" />
        </div>
        <div class="flex gap-2 justify-center">
          <button id="${s}-ok-button" class="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2"><span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">OK</span></button>
          <button id="${s}-cancel-button" class="bg-gray-200 border-t-2 border-l-2 border-gray-300"><span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Cancel</span></button>
        </div>
      </div>
    `}else l?c=`
      <div class="text-center p-4">
        <h2 class="text-lg mb-4">${e}</h2>
        <div class="flex gap-2 justify-center">
          <button id="${s}-ok-button" class="bg-gray-200 border-2 border-gray-400 px-4 py-2 hover:bg-gray-300" style="border-style: outset;">
            OK
          </button>
          <button id="${s}-cancel-button" class="bg-gray-200 border-2 border-gray-400 px-4 py-2 hover:bg-gray-300" style="border-style: outset;">
            Cancel
          </button>
        </div>
      </div>
    `:c=`
      <div class="text-center p-4">
        <h2 class="text-lg mb-4">${e}</h2>
        <button id="${s}-button" class="bg-gray-200 border-2 border-gray-400 px-4 py-2 hover:bg-gray-300" style="border-style: outset;">
          OK
        </button>
      </div>
    `;let f="‚ö†Ô∏è Information";a?(f="üí¨ Input Required",Rn(e,"polite")):r?(f=l?"‚ö†Ô∏è Confirmation":"‚úÖ Success",Rn(e,"polite")):t==="error"&&(f="‚ö†Ô∏è Error",new Audio("./audio/error-pop-up.mp3").play().catch(u=>console.log("Audio play failed",u)),Rn(e,"assertive"));const p=se(f,c,!1,s,!1,!1,{type:"integer",width:350,height:180},"default");return Ce(p),setTimeout(()=>{Ce(p)},10),setTimeout(()=>{if(a){const d=document.getElementById(`${s}-ok-button`),u=document.getElementById(`${s}-cancel-button`),m=document.getElementById(`${s}-input`);m&&(setTimeout(()=>{m.focus(),m.select()},10),m.addEventListener("keydown",g=>{if(g.key==="Enter"){g.preventDefault();const x=m.value;de(s),n&&n(x)}else g.key==="Escape"&&(g.preventDefault(),de(s),o&&o(null))})),d&&d.addEventListener("click",()=>{const g=m?m.value:"";de(s),n&&n(g)}),u&&u.addEventListener("click",()=>{de(s),o&&o(null)})}else if(l){const d=document.getElementById(`${s}-ok-button`),u=document.getElementById(`${s}-cancel-button`);d&&d.addEventListener("click",()=>{de(s),n&&n()}),u&&u.addEventListener("click",()=>{de(s),o&&o()})}else{const d=document.getElementById(`${s}-button`);d&&d.addEventListener("click",()=>{de(s),n&&n()})}},100),p}function Rn(e,t="polite"){const n=document.getElementById(t==="assertive"?"sr-alerts":"sr-announcements");n.textContent=e,setTimeout(()=>{n.textContent=""},1e3)}document.addEventListener("click",e=>{e.target.closest("#settings-apply-button")&&(e.stopPropagation(),re("Are you sure you want to apply these desktop settings changes?","confirmation",()=>{Ze("settings-apply-button","Applied!"),setTimeout(()=>{Ze("settings-apply-button","Apply")},1e3),Sa(),re("Your settings have successfully been saved!","info")}))});function za(e,t,n){const o=document.getElementById("context-menu");o.replaceChildren(),o.style.zIndex=Math.max((Se||1e3)+100,1e4);const i=(p,d,u)=>{const m=document.createElement("div");return m.className="px-4 py-2 hover:bg-gray-50 cursor-pointer",m.textContent=p,u&&m.addEventListener("click",u),o.appendChild(m),m},r=n.style.display==="none",a=J[t]&&J[t].fullScreen;r?i("Restore",!1,()=>{Ce(n),hideContextMenu()}):i("Minimize",!1,()=>{Je(t),hideContextMenu()}),a||i("Maximize",!1,()=>{vt(t),hideContextMenu()}),i("Close",!1,()=>{de(t),hideContextMenu()}),o.classList.remove("hidden");const s=o.getBoundingClientRect(),l=48;let c=e.pageX;c+s.width>window.innerWidth&&(c=window.innerWidth-s.width-10);let f=window.innerHeight-l-s.height-5;o.style.left=c+"px",o.style.top=f+"px",setTimeout(()=>{document.addEventListener("click",hideContextMenu,{once:!0})},0)}function bo(e){if(!e)return;const t=J[e.id];if(t&&t.fullScreen)return;const n=window.innerWidth,o=window.innerHeight-48,i=e.getBoundingClientRect();let r=!1;i.width>n&&(e.style.width=Math.max(350,n-10)+"px",r=!0);const s=o-30-10;i.height>o&&(e.style.height=Math.max(200,s)+"px",r=!0),r&&t&&(t.dimensions={type:"integer",width:parseInt(e.style.width),height:parseInt(e.style.height)});let l=0,c=0;const f=document.getElementById("desktop-stage");if(f){const x=getComputedStyle(f).transform;if(x&&x!=="none"){const b=x.match(/matrix\(([^)]+)\)/);if(b){const I=b[1].split(",").map(h=>parseFloat(h.trim()));I.length===6&&(l=I[4],c=I[5])}}}const p=parseInt(e.style.left,10)||0,d=parseInt(e.style.top,10)||0;let u=p,m=d;p+i.width<-l+50&&(u=-l+20,r=!0),p>-l+n-50&&(u=-l+n-i.width-20,r=!0),d<-c&&(m=-c,r=!0);const g=-c+o-30;m>g&&(m=g,r=!0),e.style.left=u+"px",e.style.top=m+"px",r&&t&&(t.position={left:e.style.left,top:e.style.top},Q())}let On=null;window.addEventListener("resize",()=>{On&&cancelAnimationFrame(On),On=requestAnimationFrame(()=>{document.querySelectorAll("#windows-container > div").forEach(e=>bo(e))})});(function(){if(typeof window>"u"||window.__touchGesturesSetup||!("ontouchstart"in window||navigator.maxTouchPoints>0))return;window.__touchGesturesSetup=!0;function n(s,{threshold:l=50,onLeft:c,onRight:f}={}){if(!s)return;let p=0,d=0;s.addEventListener("touchstart",u=>{if(!u.touches||u.touches.length!==1)return;const m=u.touches[0];p=m.clientX,d=m.clientY},{passive:!0}),s.addEventListener("touchmove",u=>{!u.touches||u.touches.length},{passive:!0}),s.addEventListener("touchend",u=>{if(u.changedTouches&&u.changedTouches.length===1){const m=u.changedTouches[0],g=m.clientX-p,x=m.clientY-d;Math.abs(g)>Math.abs(x)&&Math.abs(g)>l&&(g<0&&typeof c=="function"&&c(u),g>0&&typeof f=="function"&&f(u))}},{passive:!0})}function o(s,{maxDuration:l=300,maxMove:c=15,onTap:f}={}){if(!s)return;let p=0,d=[];s.addEventListener("touchstart",u=>{u.touches.length===2?(p=Date.now(),d=Array.from(u.touches).map(m=>({x:m.clientX,y:m.clientY}))):(p=0,d=[])},{passive:!0}),s.addEventListener("touchend",u=>{if(!p)return;if(Date.now()-p>l){p=0;return}const g=u.changedTouches;if(!g||g.length<1){p=0;return}let x=!1;Array.from(g).forEach((b,I)=>{const h=d[I]||d[0];h&&Math.hypot(b.clientX-h.x,b.clientY-h.y)>c&&(x=!0)}),!x&&typeof f=="function"&&f(u),p=0,d=[]},{passive:!0})}function i({threshold:s=60}={}){let l=0,c=!1,f=null;document.addEventListener("touchstart",p=>{if(p.touches.length===2){const d=p.target.closest(".cursor-move");if(d){l=(p.touches[0].clientY+p.touches[1].clientY)/2,c=!0;const u=d.closest('[role="dialog"]');f=u?u.id:null}}},{passive:!0}),document.addEventListener("touchmove",p=>{},{passive:!0}),document.addEventListener("touchend",p=>{var x;if(!c)return;if(!p.target.closest(".cursor-move")){c=!1,f=null;return}const m=(((x=p.changedTouches[0])==null?void 0:x.clientY)??l)-l,g=f;c=!1,f=null,g&&(m>s?typeof Je=="function"&&Je(g):m<-s&&typeof vt=="function"&&vt(g))},{passive:!0})}const r=document.getElementById("window-tabs");n(r,{onLeft:()=>{if(!window.__isWindowCycling)try{Yn()}catch{}try{const s=document.querySelectorAll("#window-cycle-list > div");s.length&&typeof window<"u"&&(Ye=(Ye-1+s.length)%s.length,yo(Ye))}catch{}setTimeout(()=>{try{wt()}catch{}},10)},onRight:()=>{try{Yn()}catch{}setTimeout(()=>{try{wt()}catch{}},10)}});const a=document.getElementById("desktop-stage")||document.body;o(a,{onTap:()=>{try{typeof window.minimizeAllWindows=="function"&&window.minimizeAllWindows()}catch{}}}),i(),function(){let l=null,c=0,f=0,p=null;const d=500,u=12;function m(){l&&(clearTimeout(l),l=null)}document.body.classList.add("no-context-menu"),document.addEventListener("touchstart",g=>{if(!g.touches||g.touches.length!==1){m();return}if(g.target.closest&&g.target.closest('input, textarea, [contenteditable="true"]')){m();return}const b=g.touches[0];c=b.clientX,f=b.clientY,p=g.target,m(),l=setTimeout(()=>{const I=document.elementFromPoint(c,f)||p||document.body,h=new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,view:window,clientX:c,clientY:f});I.dispatchEvent(h),navigator.vibrate&&navigator.vibrate(50),m()},d)},{passive:!0}),document.addEventListener("contextmenu",g=>{("ontouchstart"in window||navigator.maxTouchPoints>0)&&(g.target.closest('input, textarea, [contenteditable="true"]')||g.preventDefault())}),document.addEventListener("touchmove",g=>{if(!l||!g.touches||g.touches.length!==1)return;const x=g.touches[0];(Math.abs(x.clientX-c)>u||Math.abs(x.clientY-f)>u)&&m()},{passive:!0}),document.addEventListener("touchend",()=>{m()},{passive:!0}),document.addEventListener("touchcancel",()=>{m()},{passive:!0})}()})();function vn(){const e=document.createElement("div");e.className="w-3xl fixed left-0 top-0 h-full w-full bg-gradient-to-b from-40% from-blue-500 to-cyan-500",e.id="splash-screen",e.style.zIndex="9000",e.innerHTML=`
  <div class="flex flex-col items-center justify-center h-full">
    <img id="splash-image" src="./image/logo.webp" alt="Startup" class="mb-4 max-w-48">
    <h1 class="sr-only">Doorways '25, a Nostalgia Inducing Operating System</h1>
    <div class="mx-auto w-72 text-sm pl-3 mb-2 bg-black py-1 border-2 border-lime-400 text-lime-300"><em>i hacked the mainframe credentials for u</em><br><span class="text-xs text-lime-500">sincerely, _N30_phreak_</span></div>
    <form id="splash-form" class="bg-gray-300 border border-gray-500 p-4 w-96">
      <div class="mb-2">
        <label class="block text-sm">Username</label>
        <input type="text" id="splash-username" value="admin" class="border px-1 py-1 w-full" readonly>
      </div>
      <div class="mb-2">
        <label class="block text-sm">Password</label>
        <input type="password" id="splash-password" value="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="border px-1 py-1 w-full" readonly>
      </div>
      <button id="splash-login" class="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2"><span class="border-b-2 border-r-2 border-black block h-full max-h-10 w-full py-1.5 px-3">Login</span></button>
    </form>
  </div>
`,document.body.appendChild(e);const t=new Audio("./audio/startup.mp3");t.id="splash-audio",document.getElementById("splash-login").addEventListener("click",function(n){t.play().catch(o=>console.log("Audio play failed",o)),n.preventDefault(),document.getElementById("splash-image").src="./image/icon.gif",t.currentTime=0,setTimeout(function(){e.remove()},3e3)})}async function Vi(){const e=document.createElement("div");e.className="w-3xl fixed left-0 top-0 h-full w-full bg-gradient-to-b from-blue-500 to-cyan-500",e.id="splash-screen",e.style.zIndex="9999",e.innerHTML=`
  <div class="flex flex-col items-center justify-center h-full">
    <img id="splash-image" src="./image/logo.webp" alt="Startup" class="mb-4 max-w-48">
    <h2 class="text-4xl text-gray-900 font-bold mb-2">System Loading ...</h2>
  </div>
`,document.body.appendChild(e);try{typeof un=="function"&&await un()}catch(t){console.warn("System update check failed:",t)}setTimeout(function(){e.remove(),typeof window.showCustomScrollbars=="function"&&window.showCustomScrollbars()},1e3)}typeof window<"u"&&(window.showSplash=vn,window.showOSLoading=Vi);async function ln(){await B.setItem("explicitRestart",!0),Za(),Ja(),Xa([]),Va({clockSeconds:!1,bgColor:"#20b1b1",bgImage:""}),vn()}async function Zi(){await B.setItem("explicitRestart",!0);try{await Q()}catch(e){console.warn("Failed to save state before logout:",e)}vn()}typeof window<"u"&&(window.restart=ln,window.logout=Zi);function Ji(){se("Storage Manager",'<div id="storage-content" style="padding: 20px;">Loading storage information...</div>',!1,"storage-window",!1,!1,{type:"integer",width:600,height:500},"default"),setTimeout(cn,100)}async function cn(){const e=document.getElementById("storage-content");if(e)try{const t=await navigator.storage.estimate(),n=(t.quota/(1024*1024)).toFixed(2),o=(t.usage/(1024*1024)).toFixed(2),i=((t.quota-t.usage)/(1024*1024)).toFixed(2),r=(t.usage/t.quota*100).toFixed(1),a=await Na(),s=`
      <div class="storage-manager">
        <h2 class="text-xl font-bold mb-4">Storage Information</h2>

        <!-- Storage Capacity -->
        <div class="mb-6 p-4 bg-gray-100 rounded">
          <h3 class="text-lg font-semibold mb-2">Storage Capacity</h3>
          <div class="mb-2">
            <div class="flex justify-between mb-1">
              <span>Used: ${o} MB</span>
              <span>Available: ${i} MB</span>
            </div>
            <div class="w-full bg-gray-300 rounded-full h-4">
              <div class="bg-blue-500 h-4 rounded-full" style="width: ${r}%"></div>
            </div>
            <div class="text-sm text-gray-600 mt-1">
              ${r}% of ${n} MB total capacity used
            </div>
          </div>
        </div>

        <!-- Data Categories -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-3">Data Categories</h3>
          <div class="grid grid-cols-2 gap-4">
            ${Gt("App Data",a.appData,"bg-blue-100")}
            ${Gt("Media Files",a.mediaData,"bg-green-100")}
            ${Gt("Files & Folders",a.fileData,"bg-yellow-100")}
            ${Gt("Miscellaneous",a.miscData,"bg-gray-100")}
          </div>
        </div>

        <!-- Detailed Breakdown -->
        <div class="mb-4">
          <h3 class="text-lg font-semibold mb-3">Detailed Breakdown</h3>
          <div class="bg-white border rounded p-3">
            ${Wa(a)}
          </div>
        </div>

        <!-- Actions -->
        <div class="mt-6 flex gap-3">
          <div id="refresh-btn-container"></div>
          <div id="cleanup-btn-container"></div>
          <div id="restore-btn-container"></div>
        </div>
      </div>
    `;e.innerHTML=s;const l=await er(),c=fe("Refresh Data");c.onclick=_t,document.getElementById("refresh-btn-container").appendChild(c);const f=fe("Cleanup Options");f.onclick=Qi,document.getElementById("cleanup-btn-container").appendChild(f);const p=fe("Restore All Applications");p.onclick=Ya,l.count===0?(p.disabled=!0,p.title="All applications are already in the Start menu",p.style.opacity="0.6",p.style.cursor="not-allowed"):p.title=`Restore ${l.count} missing applications to Start menu`,document.getElementById("restore-btn-container").appendChild(p)}catch(t){const n=document.createElement("div");n.className="text-red-500",n.textContent=`Error loading storage data: ${t.message}`,e.innerHTML="",e.appendChild(n)}}function Gt(e,t,n){const o=(t.totalSize/1024).toFixed(1);return`
    <div class="p-4 ${n} rounded">
      <h4 class="font-semibold">${e}</h4>
      <div class="text-2xl font-bold">${t.count}</div>
      <div class="text-sm text-gray-600">items (${o} KB)</div>
    </div>
  `}function Wa(e){let t='<div class="space-y-2 text-sm">';return e.appData.breakdown.length>0&&(t+="<div><strong>App Data:</strong></div>",e.appData.breakdown.forEach(n=>{t+=`<div class="ml-4">‚Ä¢ ${n.name}: ${n.count} items</div>`})),e.mediaData.breakdown.length>0&&(t+='<div class="mt-3"><strong>Media Files:</strong></div>',e.mediaData.breakdown.forEach(n=>{const o=(n.size/1024).toFixed(1);t+=`<div class="ml-4">‚Ä¢ ${n.type}: ${n.count} files (${o} KB)</div>`})),e.fileData.breakdown.length>0&&(t+='<div class="mt-3"><strong>Files & Folders:</strong></div>',e.fileData.breakdown.forEach(n=>{t+=`<div class="ml-4">‚Ä¢ ${n.name}: ${n.count} items</div>`})),t+="</div>",t}async function Na(){const e={appData:{count:0,totalSize:0,breakdown:[]},mediaData:{count:0,totalSize:0,breakdown:[]},fileData:{count:0,totalSize:0,breakdown:[]},miscData:{count:0,totalSize:0,breakdown:[]}};return await Ra(e),await Oa(e),e}async function Ra(e){try{const n=await B.getItem("appState")||{},o=JSON.stringify(n).length;if(n.fileSystemState){const i=JSON.stringify(n.fileSystemState).length;e.fileData.totalSize+=i;const r=n.fileSystemState;r.folders&&Object.values(r.folders).forEach(a=>{Gn(a,e.fileData)})}if(n.windowStates){const i=JSON.stringify(n.windowStates).length;e.appData.totalSize+=i,e.appData.count+=Object.keys(n.windowStates).length,e.appData.breakdown.push({name:"Window States",count:Object.keys(n.windowStates).length})}if(n.desktopIconsState){const i=JSON.stringify(n.desktopIconsState).length;e.appData.totalSize+=i,e.appData.count+=Object.keys(n.desktopIconsState).length,e.appData.breakdown.push({name:"Desktop Icons",count:Object.keys(n.desktopIconsState).length})}if(n.desktopSettings){const i=JSON.stringify(n.desktopSettings).length;e.appData.totalSize+=i,e.appData.count+=1,e.appData.breakdown.push({name:"Desktop Settings",count:1})}}catch(t){console.error("Error analyzing storage:",t)}}function Gn(e,t){!e||typeof e!="object"||(e.type==="folder"?(t.count++,e.contents&&Object.values(e.contents).forEach(n=>{Gn(n,t)})):e.type==="ugc-file"?(t.count++,["mp3","mp4","jpg","jpeg","png","gif","webp","wav","webm"].includes(e.content_type)):Object.values(e).forEach(n=>{n&&typeof n=="object"&&Gn(n,t)}))}async function Oa(e){try{const t=await indexedDB.databases();for(const n of t)n.name==="media_player_db"?await Ha(e):(e.miscData.count+=1,e.miscData.breakdown.push({name:`Database: ${n.name}`,count:1}))}catch(t){console.error("Error analyzing IndexedDB:",t)}}async function Ha(e){return new Promise((t,n)=>{const o=indexedDB.open("media_player_db");o.onsuccess=i=>{const r=i.target.result,l=r.transaction(["songs"],"readonly").objectStore("songs").getAll();l.onsuccess=()=>{const c=l.result,f={};c.forEach(p=>{const d=p.type||"unknown";f[d]||(f[d]={count:0,size:0}),f[d].count++,p.file&&p.file.size&&(f[d].size+=p.file.size,e.mediaData.totalSize+=p.file.size),e.mediaData.count++}),Object.entries(f).forEach(([p,d])=>{e.mediaData.breakdown.push({type:p.toUpperCase(),count:d.count,size:d.size})}),r.close(),t()},l.onerror=()=>{r.close(),n(l.error)}},o.onerror=()=>{n(o.error)}})}function _t(){const e=document.getElementById("storage-content");e&&(e.innerHTML="Refreshing storage information...",setTimeout(cn,100))}function qa(e,t=null,n=null){const o=document.createElement("select");return o.className="bg-white border-t-2 border-l-2 border-black border-b-2 border-r-2 border-gray-300 px-2 py-1",o.setAttribute("aria-label","Select storage cleanup option"),o.setAttribute("title","Choose which type of data to clean up"),e.forEach(i=>{const r=document.createElement("option");typeof i=="string"?(r.value=i,r.textContent=i):(r.value=i.value,r.textContent=i.text||i.value),t!==null&&r.value===t&&(r.selected=!0),o.appendChild(r)}),n&&typeof n=="function"&&o.addEventListener("change",i=>n(i.target.value,i)),o}function Qi(){const e=se("Storage Cleanup",'<div id="cleanup-content" style="padding: 20px;">Loading cleanup options...</div>',!1,"storage-cleanup-window",!1,!1,{type:"integer",width:400,height:340},"default");setTimeout(()=>{const n=[...document.querySelectorAll("*")].filter(o=>getComputedStyle(o).zIndex>100&&getComputedStyle(o).zIndex<1e3).reduce((o,i)=>getComputedStyle(i).zIndex>getComputedStyle(o).zIndex?i:o);e.style.zIndex=`${parseInt(n.style.zIndex)+1}`},50),setTimeout(_a,100)}function _a(){const e=document.getElementById("cleanup-content");if(!e)return;const t=`
    <div class="cleanup-options">
      <h3 class="text-lg font-semibold mb-4">Storage Cleanup Options</h3>
      <p class="text-sm text-gray-600 mb-4">Choose what data to clear:</p>

      <div class="space-y-3">
        <div id="clear-media-btn-container"></div>
        <div id="clear-desktop-btn-container"></div>
        <div id="full-restart-btn-container"></div>
      </div>
    </div>
  `;e.innerHTML=t;const n=fe("Clear Media Player Data");n.onclick=ja,n.className+=" w-full mb-2",document.getElementById("clear-media-btn-container").appendChild(n);const o=fe("Reset Desktop Settings");o.onclick=Ua,o.className+=" w-full mb-2",document.getElementById("clear-desktop-btn-container").appendChild(o);const i=fe("Factory Reset");i.onclick=tr,i.className+=" w-full mb-2",i.style.backgroundColor="#ffcccc",document.getElementById("full-restart-btn-container").appendChild(i)}async function ja(){try{await new Promise((t,n)=>{const o=indexedDB.deleteDatabase("media_player_db");o.onsuccess=t,o.onerror=n});const e=getFileSystemStateSync();e.folders["C://Media"]&&(e.folders["C://Media"]={},setFileSystemState(e),saveState()),re("Media player data cleared successfully!","info"),_t()}catch(e){re("Error clearing media player data: "+e.message,"error")}}async function Ua(){const t=await B.getItem("appState")||{};t.desktopSettings={clockSeconds:!1,bgColor:"#20b1b1",bgImage:""},t.desktopIconsState={},t.startMenuOrder=[],await B.setItem("appState",t),re("Desktop settings reset successfully!","info"),_t()}async function er(){try{const e=[{id:"mycomp",text:"My Computer",icon:"image/computer.webp"},{id:"mailboxapp",text:"Mail Box",icon:"image/mail.webp"},{id:"mediaapp",text:"Media Player",icon:"image/video.webp"},{id:"watercolourapp",text:"Watercolour",icon:"image/watercolour.webp"},{id:"letterpad",text:"LetterPad",icon:"image/file.webp"},{id:"calcapp",text:"Calculator",icon:"image/calculator.webp"},{id:"keyboard",text:"Keyboard",icon:"image/keyboard.webp"},{id:"sysset",text:"System Settings",icon:"image/gears.webp"},{id:"storageapp",text:"Storage Manager",icon:"image/drive_c.webp"},{id:"osupdateapp",text:"OS Update",icon:"image/power.webp"},{id:"abtcomp",text:"About This Computer",icon:"image/info.webp"},{id:"solapp",text:"Solitaire",icon:"image/solitaire.webp"},{id:"chessapp",text:"Guillotine Chess",icon:"image/guillotine_chess.webp"},{id:"bombapp",text:"Bombbroomer",icon:"image/bombbroomer.webp"},{id:"pongapp",text:"Pong",icon:"image/pong.webp"},{id:"snakeapp",text:"Snake",icon:"image/snake.webp"},{id:"happyturdapp",text:"Happy Turd",icon:"image/happyturd.webp"}];let t=[];try{const i=await B.getItem("startMenuOrder");i&&Array.isArray(i)?t=i:t=typeof startMenuOrder<"u"?startMenuOrder:window.startMenuOrder||[]}catch{t=typeof startMenuOrder<"u"?startMenuOrder:window.startMenuOrder||[]}const n=new Set;t.forEach(i=>{typeof i=="string"?n.add(i):i&&i.type==="group"&&i.items&&i.items.forEach(r=>{r&&r.id&&n.add(r.id)})});const o=e.filter(i=>!n.has(i.id));return{count:o.length,apps:o}}catch(e){return console.error("Error checking for missing apps:",e),{count:0,apps:[]}}}async function Ya(){try{const e=await er();if(e.count===0){typeof re=="function"?re("All applications are already present in the Start menu.","info"):alert("All applications are already present in the Start menu.");return}const t=`This will restore ${e.count} missing applications to the Start menu:

${e.apps.map(n=>`‚Ä¢ ${n.text}`).join(`
`)}

Proceed?`;typeof re=="function"?re(t,"confirmation",async()=>{await Xo(e.apps)}):confirm(t)&&await Xo(e.apps)}catch(e){console.error("‚ùå Error in restoreAllApplications:",e),typeof re=="function"?re("Failed to restore applications: "+e.message,"error"):alert("Failed to restore applications: "+e.message)}}async function Xo(e){try{let t=[];try{const o=await B.getItem("startMenuOrder");o&&Array.isArray(o)?t=[...o]:t=typeof startMenuOrder<"u"?[...startMenuOrder]:[...window.startMenuOrder||[]]}catch{t=typeof startMenuOrder<"u"?[...startMenuOrder]:[...window.startMenuOrder||[]]}const n={letterpad:"utilities-group",calcapp:"utilities-group",sysset:"utilities-group",storageapp:"utilities-group",osupdateapp:"utilities-group",abtcomp:"utilities-group",solapp:"games-group",chessapp:"games-group",bombapp:"games-group",pongapp:"games-group",snakeapp:"games-group"};e.forEach(o=>{const i=n[o.id];if(i){let r=!1;if(t=t.map(a=>typeof a=="object"&&a.type==="group"&&a.id===i?(r=!0,{...a,items:[...a.items||[],{id:o.id,text:o.text,icon:o.icon}]}):a),!r){const a=Ga(i);if(a){a.items=[{id:o.id,text:o.text,icon:o.icon}];const s=t.findIndex(l=>l==="rstrtcomp");s!==-1?t.splice(s,0,a):t.push(a)}}}else{const r=t.findIndex(a=>a==="rstrtcomp");r!==-1?t.splice(r,0,o.id):t.push(o.id)}}),window.startMenuOrder=t,typeof startMenuOrder<"u"&&(startMenuOrder=t),await B.setItem("startMenuOrder",t),typeof saveState=="function"&&await saveState(),typeof generateStartMenuHTML=="function"?generateStartMenuHTML():typeof window.generateStartMenuHTML=="function"&&window.generateStartMenuHTML(),typeof safeInitializeStartMenuDragDrop=="function"?setTimeout(()=>{safeInitializeStartMenuDragDrop()},50):typeof window.safeInitializeStartMenuDragDrop=="function"&&setTimeout(()=>{window.safeInitializeStartMenuDragDrop()},50),typeof re=="function"?re(`Successfully restored ${e.length} applications to the Start menu.`,"info"):alert(`Successfully restored ${e.length} applications to the Start menu.`),setTimeout(()=>{_t()},500)}catch(t){console.error("‚ùå Error performing app restore:",t),typeof re=="function"?re("Failed to restore applications: "+t.message,"error"):alert("Failed to restore applications: "+t.message)}}function Ga(e){return{"utilities-group":{id:"utilities-group",text:"Utilities",type:"group",items:[]},"games-group":{id:"games-group",text:"Games",type:"group",items:[]}}[e]||null}function tr(){re("This will completely wipe the entire hard drive and reset the system to factory defaults. All your files, settings, and data will be permanently deleted.","confirmation",()=>{confirm(`‚ö†Ô∏è FINAL WARNING ‚ö†Ô∏è

This will permanently delete EVERYTHING you have ever saved in this application:

‚Ä¢ All uploaded files and media
‚Ä¢ All documents and folders
‚Ä¢ All settings and customizations
‚Ä¢ All application data

This action cannot be undone!

Are you absolutely sure you want to proceed?`)&&Ka()},()=>{})}function Ka(){B.clearSync();const e=indexedDB.deleteDatabase("media_player_db");e.onsuccess=()=>{},e.onerror=t=>{console.error("Factory reset: Error clearing media player database:",t)},windowStates={},desktopIconsState={},startMenuOrder=[],desktopSettings={clockSeconds:!1,bgColor:"#20b1b1",bgImage:""},window.location.reload()}let Ne={folders:{"C://":{Documents:{id:"Documents",name:"Documents",type:"folder",fullPath:"C://Documents",contents:{}},Desktop:{id:"Desktop",name:"Desktop",type:"folder",fullPath:"C://Desktop",contents:{compostbin:{id:"compostbin",name:"Compost Bin",type:"app",fullPath:"C://Desktop/compostbin",content_type:"html",contents:{},icon:"./image/compost-bin.webp"}}},Media:{id:"Media",name:"Media",type:"folder",fullPath:"C://Media",contents:{}}},"A://":{"folder-34862398":{id:"folder-34862398",name:"example folder",type:"folder",fullPath:"A://folder-34862398",contents:{}}},"D://":{}}},J={},me={},Fe={},be={clockSeconds:!1,bgColor:"#20b1b1",bgImage:""},ae,nr={},Se=100,xt=null;function Xa(e){ae=e,typeof window<"u"&&(window.startMenuOrder=e)}function zt(e){Se=e,typeof window<"u"&&(window.highestZ=e)}function or(e){xt=e,typeof window<"u"&&(window.activeMediaWindow=e)}function Va(e){Object.assign(be,e),typeof window<"u"&&(window.desktopSettings=be)}function Za(){Object.keys(J).forEach(e=>delete J[e]),typeof window<"u"&&(window.windowStates=J)}function Ja(){Object.keys(me).forEach(e=>delete me[e]),typeof window<"u"&&(window.desktopIconsState=me)}typeof window<"u"&&(window.fileSystemState=Ne,window.windowStates=J,window.desktopIconsState=me,window.navWindows=Fe,window.desktopSettings=be,window.fileFolderMapping=nr,window.highestZ=Se,window.activeMediaWindow=xt);let dn=!1;typeof window<"u"&&(window.isInitializing=dn);async function Q(){if(dn)return;const e=typeof ae<"u"?ae:window.startMenuOrder||[],t=Object.fromEntries(Object.entries(J).filter(([o])=>!/^dialogWindow-/.test(o)&&!/^promptWindow-/.test(o))),n={fileSystemState:Ne,windowStates:t,desktopIconsState:me,desktopSettings:be,navWindows:Fe,startMenuOrder:e};try{await B.setItem("appState",n);const o=Date.now(),i=await B.getItem("appState")}catch(o){console.warn("Failed to save state to IndexedDB:",o),B.setItemSync("appState",n)}}typeof window<"u"&&(window.saveState=Q);function Re(){return Ne}function ke(e){Ne=e,typeof window<"u"&&(window.fileSystemState=e)}function ot(e,t){J[e]&&(J[e].content=t,Q())}async function wo(e,t,n,o,i=null,r=!1){const a=await Re();if(!a||!a.folders){console.error("File system not initialized, creating basic structure");const g={folders:{"C://":{Documents:{id:"Documents",name:"Documents",type:"folder",fullPath:"C://Documents",contents:{}},Desktop:{id:"Desktop",name:"Desktop",type:"folder",fullPath:"C://Desktop",contents:{}},Media:{id:"Media",name:"Media",type:"folder",fullPath:"C://Media",contents:{}}},"A://":{},"D://":{}}};ke(g),a=g}const s=n.match(/^([A-Z]:\/\/)/);if(!s)return console.error("Invalid path format:",n),null;const l=s[1],c=n.replace(/^[A-Z]:\/\//,"").split("/").filter(g=>g);a.folders[l]||(console.error("Drive does not exist:",l),a.folders[l]={});let f=a.folders[l];if(c.length===0)f=a.folders[l];else if(f=a.folders[n],!f)return console.error("Target folder not found in unified structure:",n),console.error("Available folders:",Object.keys(a.folders)),null;const p=c.length===0;let d="image/file.webp";["png","jpg","jpeg","gif"].includes(o)?d="image/image.webp":["mp4","webm"].includes(o)?d="image/video.webp":["mp3","wav","audio"].includes(o)?d="image/audio.webp":o==="html"?d="image/html.webp":["md","txt"].includes(o)&&(d="image/doc.webp");const u=`file-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,m={id:u,name:e,type:"ugc-file",fullPath:p?`${n}${e}`:`${n}/${e}`,content_type:o,icon:d,contents:t||"",file:i||null};if(i&&["png","jpg","jpeg","gif","webp","avif","mp3","wav","ogg","mp4","webm","avi","mov"].includes(o)){m.isLargeFile=!0,m.storageLocation="indexeddb";const g=URL.createObjectURL(i);m.tempObjectURL=g;const x=new FileReader;x.onload=async function(b){const I=b.target.result,h=I.length*.75/(1024*1024);try{await B.setItem(`file_data_${u}`,I);const j=await Re();let $;p?$=j.folders[l][u]:$=j.folders[n][u],$?($.isLargeFile=!0,$.storageLocation="indexeddb",$.dataURL=I):(console.error("üéµ ADDFILE: File entry not found after creation:",u),console.error("üéµ ADDFILE: Looking in:",p?l:n),console.error("üéµ ADDFILE: Available keys:",Object.keys(p?j.folders[l]||{}:j.folders[n]||{})))}catch(j){console.error("Failed to store file in IndexedDB:",j);const $=await Re();let F;p?F=$.folders[l][u]:F=$.folders[n][u],F&&(F.isLargeFile=!0,F.storageLocation="failed"),showDialogBox(`File "${e}" could not be stored (${h.toFixed(2)}MB). Storage error: ${j.message}`,"error")}const H=await Re();let O;p?O=H.folders[l][u]:O=H.folders[n][u],O?O.file=null:console.error("üéµ ADDFILE: Could not find file entry to remove File object:",u),ke(H);try{await Q()}catch(j){console.error("Failed to save state after file storage:",j)}n==="C://Desktop"&&typeof renderDesktopIcons=="function"?renderDesktopIcons():typeof refreshAllExplorerWindows=="function"&&refreshAllExplorerWindows(n)},x.readAsDataURL(i)}if(f[u]=m,ke(a),!r&&(!i||!["png","jpg","jpeg","gif","webp","avif","mp3","wav","ogg","mp4","webm","avi","mov"].includes(o)))try{await Q()}catch(g){console.error("Failed to save state after non-binary file:",g)}return n==="C://Desktop"?typeof renderDesktopIcons=="function"?renderDesktopIcons():typeof window.renderDesktopIcons=="function"?window.renderDesktopIcons():console.warn("renderDesktopIcons function not found"):typeof refreshAllExplorerWindows=="function"?refreshAllExplorerWindows(n):typeof window.refreshAllExplorerWindows=="function"?window.refreshAllExplorerWindows(n):console.warn("refreshAllExplorerWindows function not found"),n==="C://Media"&&["mp3","wav","ogg","audio","mp4","webm","avi","mov"].includes(o)&&typeof window.refreshMediaPlayerPlaylist=="function"&&setTimeout(()=>{window.refreshMediaPlayerPlaylist()},100),m}window.globalAddFileToFileSystem=wo;function Kt(e){if(e.folders||(e.folders={}),e.folders["C://"]&&typeof e.folders["C://"]=="object"){const o=e.folders["C://"];for(const[i,r]of Object.entries(o))if(r&&typeof r=="object"&&r.type==="folder"){const a=`C://${r.name||i}`;e.folders[a]||(e.folders[a]=r.contents||{},r.contents&&Object.values(r.contents).forEach(s=>{s.type==="folder"&&s.fullPath&&n(s.fullPath,s,e)}))}}const t=["C://Desktop","C://Documents","C://Media"];for(const o of t)e.folders[o]||(e.folders[o]={});function n(o,i,r){i.contents&&Object.keys(i.contents).length>0&&(r.folders[o]||(r.folders[o]={}),Object.assign(r.folders[o],i.contents),Object.values(i.contents).forEach(a=>{a.type==="folder"&&a.fullPath&&n(a.fullPath,a,r)}))}return e}async function Kn(){dn=!0,typeof window<"u"&&(window.isInitializing=!0);try{await B.ensureReady()}catch(t){console.error("Failed to initialize storage:",t)}let e;try{e=await B.getItem("appState")}catch(t){console.error("Failed to load app state from storage:",t),e=null}if(e){const t=e;if(t.fileSystemState&&typeof t.fileSystemState=="object"){const o=Kt(t.fileSystemState);ke(o)}else{console.warn("Invalid fileSystemState in saved data, using default");const o=Kt(Ne);ke(o)}J=t.windowStates&&typeof t.windowStates=="object"?t.windowStates:{},me=t.desktopIconsState&&typeof t.desktopIconsState=="object"?t.desktopIconsState:{},Fe=t.navWindows&&typeof t.navWindows=="object"?t.navWindows:{};let n=[];try{const o=await B.getItem("startMenuOrder");o&&Array.isArray(o)?n=o:t.startMenuOrder&&Array.isArray(t.startMenuOrder)&&(n=t.startMenuOrder)}catch(o){console.warn("‚ö† Error loading from direct storage, using appState:",o),n=t.startMenuOrder&&Array.isArray(t.startMenuOrder)?t.startMenuOrder:[]}ae=n,typeof window<"u"&&(window.startMenuOrder=ae),be={clockSeconds:!1,bgColor:"#20b1b1",bgImage:"",...t.desktopSettings||{}},typeof window<"u"&&typeof window.applyDesktopSettings=="function"&&window.applyDesktopSettings(),setTimeout(async()=>{const o=await Re();if(o&&o.folders&&o.folders["C://Media"]){const i=o.folders["C://Media"];if(i&&!Object.values(i).some(a=>a.name==="too_many_screws_final.mp3")){const a={id:"default-music-file",name:"too_many_screws_final.mp3",type:"ugc-file",fullPath:"C://Media/too_many_screws_final.mp3",content_type:"mp3",icon:"image/audio.webp",contents:"",file:null,isDefault:!0,path:"media/too_many_screws_final.mp3",isSystemFile:!0};o.folders["C://Media"]["default-music-file"]=a,ke(o),await Q()}}await un()},100)}else{let t=null;try{if((await fetch("custom-config.js",{method:"HEAD"})).ok)try{const o=await fetch("custom_data/data.json");o.ok&&(t=await o.json(),console.log("Loaded initial state from custom_data"))}catch(o){console.warn("Failed to load custom_data/data.json despite custom-config.js presence",o)}if(!t)try{const o=await fetch("default_data/data.json");o.ok&&(t=await o.json(),console.log("Loaded initial state from default_data"))}catch(o){console.warn("Failed to load default_data/data.json",o)}}catch(n){console.warn("Error checking for initial data",n)}if(t){t.fileSystemState&&(t.fileSystemState=Kt(t.fileSystemState)),Ne=t.fileSystemState||Ne,J=t.windowStates||{},me=t.desktopIconsState||{},be=t.desktopSettings||be,Fe=t.navWindows||{},ae=t.startMenuOrder||[],typeof window<"u"&&(window.startMenuOrder=ae);try{await B.setItem("appState",t)}catch(n){console.error("Failed to save loaded initial state:",n)}}else{ae=[],typeof window<"u"&&(window.startMenuOrder=ae);const o={fileSystemState:Kt(Ne),windowStates:J,desktopIconsState:me,desktopSettings:be,navWindows:Fe};try{await B.setItem("appState",o)}catch(i){console.error("Failed to save initial app state:",i)}}setTimeout(async()=>{const n=await Re();if(n.folders["C://Media"]&&!Object.values(n.folders["C://Media"]).some(i=>i.name==="too_many_screws_final.mp3")){const i={id:"default-music-file",name:"too_many_screws_final.mp3",type:"ugc-file",fullPath:"C://Media/too_many_screws_final.mp3",content_type:"mp3",icon:"image/audio.webp",contents:"",file:null,isDefault:!0,path:"media/too_many_screws_final.mp3",isSystemFile:!0};n.folders["C://Media"]["default-music-file"]=i,ke(n),await Q()}},100),await un()}dn=!1,typeof window<"u"&&(window.isInitializing=!1)}async function Qa(){const e=await B.getItem("fileSystemState");e&&(Ne=e)}async function es(){if(J&&Object.keys(J).length>0){Object.keys(J).forEach(t=>{(/^dialogWindow-/.test(t)||/^promptWindow-/.test(t))&&delete J[t]});const e=Object.entries(J).sort(([,t],[,n])=>(t.zIndex||0)-(n.zIndex||0));for(const[t,n]of e)createWindow(n.title,n.content,n.isNav,n.id,n.isMinimized,!0,n.dimensions,n.windowType,null,n.color||"white",n.zIndex),await ir(n.id);if(typeof window.initializeAllLetterPadEditors=="function")try{await window.initializeAllLetterPadEditors()}catch(t){console.warn("Error during global LetterPad initialization:",t)}}}async function ir(e){await new Promise(n=>setTimeout(n,50));const t={"storage-window":()=>{typeof cn=="function"?setTimeout(cn,100):console.warn("loadStorageData function not available for storage window restoration")},calculator:()=>{const n=document.getElementById("calculator");if(n){const o=n.querySelector(".p-2");Ue(o)&&initializeCalculatorUI(n)}},mediaplayer:()=>{const n=document.getElementById("mediaplayer");if(n){const o=n.querySelector(".p-2");Ue(o)&&initializeMediaPlayerUI(n)}},bombbroomer:()=>{const n=document.getElementById("bombbroomer");if(n){const o=n.querySelector(".p-2");Ue(o)&&(typeof initializeBombbroomerUI=="function"?initializeBombbroomerUI(n):console.warn("initializeBombbroomerUI function not available"))}},solitaire:()=>{const n=document.getElementById("solitaire");if(n){const o=n.querySelector(".p-2");Ue(o)&&initializeSolitaireUI(n)}},chess:()=>{const n=document.getElementById("chess");if(n){const o=n.querySelector(".p-2");Ue(o)&&(typeof initializeChessUI=="function"?initializeChessUI(n):console.warn("initializeChessUI function not available"))}},"compost-bin":()=>{const n=document.getElementById("compost-bin");if(n){const o=n.querySelector(".p-2");if(o&&Ue(o)){o.innerHTML="",o.className="p-2 bg-gray-100 h-full flex flex-col";const i=document.createElement("div");i.className="h-full flex flex-col";const r=document.createElement("div");r.className="bg-gray-200 border-b border-gray-400 p-2 flex justify-between items-center";const a=document.createElement("div");a.className="text-sm";const c=(le().folders["C://Desktop"]||{}).compostbin,f=Object.keys((c==null?void 0:c.contents)||{}).length;a.textContent=`Compost Bin - ${f} item(s)`;const p=document.createElement("div");p.className="flex space-x-2";const d=document.createElement("button");d.className="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs",d.textContent="Empty Bin",typeof emptyCompostBin=="function"&&d.addEventListener("click",emptyCompostBin),p.appendChild(d),r.appendChild(a),r.appendChild(p);const u=document.createElement("div");u.className="flex-1 bg-white border border-gray-400 p-2 overflow-auto",u.id="compost-bin-content",typeof loadCompostBinContents=="function"?loadCompostBinContents(u):console.warn("üóëÔ∏è loadCompostBinContents function not available"),i.appendChild(r),i.appendChild(u),o.appendChild(i)}else{const i=n.querySelector("#compost-bin-content");i&&typeof loadCompostBinContents=="function"?(loadCompostBinContents(i),typeof updateCompostBinHeader=="function"&&updateCompostBinHeader(n)):console.warn("Compost bin content area not found or loadCompostBinContents not available")}}else console.warn("üóëÔ∏è Compost bin window not found during restoration")},snake:()=>{const n=document.getElementById("snake");if(n){const o=n.querySelector(".p-2");Ue(o)&&(typeof initializeSnakeUI=="function"?initializeSnakeUI(n):console.warn("initializeSnakeUI function not available for restoration"))}},pong:()=>{const n=document.getElementById("pong");if(n){const o=n.querySelector(".p-2");Ue(o)&&(typeof initializePongUI=="function"?initializePongUI(n):console.warn("initializePongUI function not available for restoration"))}},happyturd:()=>{const n=document.getElementById("happyturd");if(n){const o=n.querySelector(".p-2");Ue(o)&&(typeof initializeHappyTurdUI=="function"?initializeHappyTurdUI(n):console.warn("initializeHappyTurdUI function not available for restoration"))}},watercolour:()=>{const n=document.getElementById("watercolour");if(n){const o=n.querySelector(".p-2");Ue(o)?initializeWatercolourUI(n):typeof initializeWatercolour=="function"?initializeWatercolour():initializeWatercolourUI(n)}},"keyboard-app":()=>{document.getElementById("keyboard-app")&&(typeof window.initializeKeyboardApp=="function"?window.initializeKeyboardApp("keyboard-app"):console.warn("initializeKeyboardApp function not available for keyboard-app restoration"))},tubestream:()=>{const n=document.getElementById("tubestream");n&&typeof _n=="function"&&_n(n)},mailbox:()=>{const n=document.getElementById("mailbox");n&&typeof qn=="function"&&qn(n)},"os-update-window":()=>{typeof jn=="function"&&jn()},"explorer-window":()=>{const n=document.getElementById("explorer-window");n&&(typeof initializeFileExplorerUI=="function"?initializeFileExplorerUI(n):typeof restoreFileExplorerState=="function"&&setTimeout(restoreFileExplorerState,100))}};if(t[e])try{t[e]()}catch(n){console.warn(`Failed to initialize restored app ${e}:`,n)}else{const n=document.getElementById(e);if(n){const o=n.querySelector(".letterpad_editor");if(o)try{typeof initializeLetterPad=="function"?await initializeLetterPad(o):console.warn("initializeLetterPad function not available")}catch(i){console.warn(`Failed to initialize LetterPad editor in window ${e}:`,i)}}}}function Ue(e){if(!e)return!0;const t=e.innerHTML.trim();return!t||t.length<50&&!t.includes("button")&&!t.includes("canvas")&&!t.includes("input")?!0:!e.querySelector('button, canvas, input[type="text"], .game-board, #media-container, #game-grid, #calc-display, #compost-bin-content')}function ts(e,t){if(typeof t!="function"){console.warn(`Launch function not available for ${e}`);return}const n=document.getElementById(e);if(!n){console.warn(`Window ${e} not found for reinitialization`);return}try{const o=e+"-temp-"+Date.now();n.id=o,t();const i=document.getElementById(e);if(i&&i!==n){const r=n.querySelector(".p-2"),a=i.querySelector(".p-2");r&&a&&(r.innerHTML=a.innerHTML,r.className=a.className),i.remove();const s=document.getElementById("tab-"+e);s&&s.remove(),delete J[e]}n.id=e}catch(o){n&&n.id!==e&&(n.id=e),console.error(`Failed to reinitialize ${e}:`,o)}}function ns(){}async function os(){try{await Q()}catch(e){console.error("Failed to save state manually:",e)}}function is(e){ir(e)}function rs(e){const t={calculator:launchCalculator,mediaplayer:launchMediaPlayer,bombbroomer:launchBombbroomer,solitaire:launchSolitaire};t[e]?ts(e,t[e]):console.warn(`No launch function found for ${e}`)}function as(){const e=document.getElementById("bombbroomer");e&&typeof initializeBombbroomerUI=="function"?initializeBombbroomerUI(e):console.warn("Bombbroomer window not found or function not available")}async function ss(){try{if(await Q(),await B.getItem("appState")){const t=await navigator.storage.estimate();return!0}else return console.error("‚úó No data found after save"),!1}catch(e){return console.error("‚úó Data integrity test failed:",e),!1}}async function ls(){try{const e=await B.getItem("appState"),t=await B.getItem("explicitRestart");return!!e}catch(e){return console.error("‚úó Session persistence test failed:",e),!1}}async function cs(){await B.setItem("explicitRestart",!0)}typeof window<"u"&&(window.debugWindowStates=ns,window.forceSaveState=os,window.testAppRestoration=is,window.testAppReinitialization=rs,window.testBombbroomerInit=as,window.testDataIntegrity=ss,window.testSessionPersistence=ls,window.simulateRestart=cs,window.saveState=Q,window.getFileSystemState=Re,window.setFileSystemState=ke,window.updateContent=ot);window.addEventListener("beforeunload",async e=>{try{const t={fileSystemState:Ne,windowStates:J,desktopIconsState:me,desktopSettings:be,navWindows:Fe};B.setItemSync("appState",t)}catch(t){console.error("Failed to save state during page unload:",t)}});setInterval(async()=>{try{await Q()}catch(e){console.error("Failed to save periodic backup:",e)}},3e4);async function ds(){for(const e in me){const t=document.getElementById(e);if(t){const n=me[e];t.style.position="absolute",t.style.left=n.left,t.style.top=n.top}}}Qa().then(()=>{}).catch(console.error);let Xt=null;async function un(){return Xt||(Xt=(async()=>{try{const e=await fetch("/api/system_manifest.json");if(!e.ok)throw new Error("Manifest fetch failed");const t=await e.json(),n=await B.getItem("systemVersion");if(!n||t.version!==n){console.log("System update detected:",n,"->",t.version);for(const i of t.defaultFiles){const a=(await Re()).folders[i.targetFolder];let s=null;if(a&&(s=Object.keys(a).find(l=>a[l].name===i.name)),s){const l=a[s];if(l.isSystemFile||!l.version||l.version!==i.version){if(["md","txt","html","json"].includes(i.contentType))try{const c=await fetch(i.path);c.ok&&(l.contents=await c.text())}catch{}i.path&&!["md","txt","html","json"].includes(i.contentType)&&(l.path=i.path),l.version=i.version,i.description&&(l.description=i.description),l.isSystemFile=!0}}else{let l="";if(["md","txt","html","json"].includes(i.contentType))try{const f=await fetch(i.path);f.ok&&(l=await f.text())}catch{console.warn("Failed to fetch content for",i.name)}const c=await wo(i.name,l,i.targetFolder,i.contentType,null,!0);c&&(i.path&&!["md","txt","html","json"].includes(i.contentType)&&(c.path=i.path),c.isSystemFile=!0,c.version=i.version,i.description&&(c.description=i.description))}}await B.setItem("systemVersion",t.version),await Q()}}catch(e){console.warn("System manifest processing failed:",e)}finally{}})(),Xt)}async function us(){const e={mailbox:!1,tubestream:!1},t=async i=>{const r=new AbortController,a=setTimeout(()=>r.abort(),3e4);try{const s=await fetch(i,{method:"HEAD",signal:r.signal});return s.ok?!0:s.status===405||s.status===404?(await fetch(i,{method:"GET",signal:r.signal})).ok:!1}catch(s){return console.warn(`Probe failed for ${i}:`,s),!1}finally{clearTimeout(a)}},[n,o]=await Promise.all([t(`${Wt}${Zo}`),t(`${Wt}${Jo}`)]);return e.mailbox=n,e.tubestream=o,console.log("üîç API Probe Results:",e),e}let gt=new Set;const Tt=[{id:"mycomp",text:"My Computer",icon:"image/computer.webp",type:"item"},{id:"mailboxapp",text:"Mail Box",icon:"image/mail.webp",type:"item"},{id:"mediaapp",text:"Media Player",icon:"image/video.webp",type:"item"},{id:"tubestreamapp",text:"TubeStream",icon:"image/youtube.webp",type:"item"},{id:"watercolourapp",text:"Watercolour",icon:"image/watercolour.webp",type:"item"},{id:"utilities-group",text:"Utilities",type:"group",items:[{id:"letterpad",text:"LetterPad",icon:"image/file.webp"},{id:"calcapp",text:"Calculator",icon:"image/calculator.webp"},{id:"keyboard",text:"Keyboard",icon:"image/keyboard.webp"},{id:"sysset",text:"System Settings",icon:"image/gears.webp"},{id:"storageapp",text:"Storage Manager",icon:"image/drive_c.webp"},{id:"osupdateapp",text:"OS Update",icon:"image/power.webp"},{id:"abtcomp",text:"About This Computer",icon:"image/info.webp"}]},{id:"games-group",text:"Games",type:"group",items:[{id:"solapp",text:"Solitaire",icon:"image/solitaire.webp"},{id:"chessapp",text:"Guillotine Chess",icon:"image/guillotine_chess.webp"},{id:"bombapp",text:"Bombbroomer",icon:"image/bombbroomer.webp"},{id:"pongapp",text:"Pong",icon:"image/pong.webp"},{id:"snakeapp",text:"Snake",icon:"image/snake.webp"},{id:"happyturdapp",text:"Happy Turd",icon:"image/happyturd.webp"}]},{id:"rstrtcomp",text:"Restart",icon:"image/power.webp",type:"item",fixed:!0}];let D={isDragging:!1,draggedElement:null,draggedFromGroup:null,placeholder:null,startY:0,startX:0,draggedItemData:null};function xn(){const e=document.getElementById("start-menu");if(!e){console.error("Start menu container not found");return}const t=typeof ae<"u"?ae:window.startMenuOrder||[];let n=[...Tt];if(t&&t.length>0){const i=[],r=new Set;t.forEach(a=>{if(typeof a=="string"){const s=Tt.find(l=>l.id===a);s&&(i.push(s),r.add(a))}else if(a&&a.type==="group"){let s=Tt.find(l=>l.type==="group"&&(l.id===a.id||l.text===a.name));if(s){const l={...s,items:a.items||s.items};i.push(l),r.add(s.id)}else i.push({id:a.id||`custom-group-${Date.now()}`,text:a.name,type:"group",items:a.items||[]})}}),Tt.forEach(a=>{!r.has(a.id)&&!a.fixed&&i.push(a)}),Tt.forEach(a=>{a.fixed&&i.push(a)}),n=i}const o=document.createElement("ul");if(n.forEach(i=>{if(!gt.has(i.id)){if(i.type==="item"){const r=ps(i);o.appendChild(r)}else if(i.type==="group"){const r=i.items.filter(a=>!gt.has(a.id));if(r.length>0){const a={...i,items:r},s=fs(a);o.appendChild(s)}}}}),e.innerHTML="",e.appendChild(o),typeof window.updateStartMenuFocusability=="function"){const i=!e.classList.contains("hidden");window.updateStartMenuFocusability(i)}}function ps(e){const t=document.createElement("li");return t.id=e.id,t.className=e.fixed?"px-4 py-2 hover:bg-gray-50 cursor-pointer flex items-center relative":"px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center relative",t.setAttribute("role","menuitem"),t.setAttribute("tabindex","-1"),t.setAttribute("aria-label",e.text),t.innerHTML=`
    <img src="${e.icon}" class="h-6 w-6 inline mr-2" alt="${e.text} icon">
    ${e.text}
  `,t.addEventListener("click",n=>{const o=t.querySelector(".start-menu-context-menu");o&&o.style.display!=="none"||kt(e.id)}),t.addEventListener("mouseenter",()=>{var n;(n=window.startMenuKeyboardNavState)!=null&&n.isKeyboardNavigating()&&Vn()}),e.fixed||rr(t,e,!1),t}function fs(e){const t=document.createElement("li");t.className="group relative",t.setAttribute("data-group-id",e.id);let n="";e.items.forEach(a=>{n+=`
      <li id="${a.id}" class="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center submenu-item relative" data-submenu-item data-parent-group="${e.id}" role="menuitem" tabindex="-1" aria-label="${a.text}">
        <img src="${a.icon}" class="h-6 w-6 inline mr-2" alt="${a.text} icon">
        ${a.text}
      </li>
    `}),t.innerHTML=`
    <a href="#" data-submenu-trigger class="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center justify-between" role="menuitem" tabindex="-1" aria-label="${e.text}" aria-haspopup="true" aria-expanded="false">
      <div class="flex items-center">
        ${e.text}
      </div>
      <span class="md:rotate-0 text-xs">&#9654;</span>
    </a>
    <ul class="submenu hidden pl-4 bg-gray-100 md:pl-0 md:absolute md:left-full md:bottom-0 md:w-48 md:bg-white md:border md:border-gray-500 md:shadow-lg" data-submenu-container data-group-id="${e.id}" role="menu">
      ${n}
    </ul>
  `,t.querySelectorAll("ul li").forEach((a,s)=>{a.addEventListener("click",c=>{var f;((f=a.querySelector(".start-menu-context-menu"))==null?void 0:f.style.display)==="none"&&kt(a.id)}),a.addEventListener("mouseenter",()=>{var c;(c=window.startMenuKeyboardNavState)!=null&&c.isKeyboardNavigating()&&Vn()});const l=e.items[s];l&&rr(a,l,!0,e.id)});const i=t.querySelector("[data-submenu-trigger]"),r=t.querySelector("[data-submenu-container]");if(i&&i.addEventListener("mouseenter",()=>{var a;(a=window.startMenuKeyboardNavState)!=null&&a.isKeyboardNavigating()&&Vn()}),i&&r){let a;window.matchMedia("(hover: hover)").matches?(t.addEventListener("mouseenter",()=>{clearTimeout(a),r.classList.remove("hidden"),r.classList.add("block")}),t.addEventListener("mouseleave",()=>{a=setTimeout(()=>{r.classList.add("hidden"),r.classList.remove("block")},100)})):i.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation();const c=!r.classList.contains("hidden");document.querySelectorAll("[data-submenu-container]").forEach(f=>{f!==r&&(f.classList.add("hidden"),f.classList.remove("block"))}),c?(r.classList.add("hidden"),r.classList.remove("block")):(r.classList.remove("hidden"),r.classList.add("block"))})}return t}function kt(e){if(console.log("üîç Start menu item clicked:",e),D.isDragging){console.log("üîç Ignoring click - drag operation in progress");return}if(typeof toggleStartMenu=="function")toggleStartMenu();else{const t=document.getElementById("start-menu");if(t){t.classList.add("hidden"),t.setAttribute("aria-hidden","true"),typeof window.updateStartMenuFocusability=="function"&&window.updateStartMenuFocusability(!1);const n=document.getElementById("start-button");n&&n.setAttribute("aria-expanded","false")}}switch(e){case"mycomp":typeof openExplorer=="function"&&openExplorer("C://");break;case"abtcomp":typeof openAboutWindow=="function"&&openAboutWindow();break;case"sysset":typeof openNav=="function"&&openNav("Settings","",{type:"integer",width:600,height:400},"Settings");break;case"storageapp":typeof openApp=="function"&&openApp("storage");break;case"mailboxapp":typeof openApp=="function"&&openApp("mailbox");break;case"osupdateapp":typeof openApp=="function"&&openApp("osupdate");break;case"watercolourapp":typeof openApp=="function"&&openApp("watercolour");break;case"letterpad":typeof createNewFile=="function"&&createNewFile(null,"C://Documents",t=>{typeof openFile=="function"&&openFile(t,{target:document.body})});break;case"calcapp":typeof openApp=="function"&&openApp("calculator");break;case"keyboard":console.log("üîç Keyboard case triggered, calling openApp"),typeof openApp=="function"&&openApp("keyboard");break;case"solapp":typeof openApp=="function"&&openApp("solitaire");break;case"chessapp":typeof openApp=="function"&&openApp("chess");break;case"bombapp":typeof openApp=="function"&&openApp("bombbroomer");break;case"pongapp":typeof openApp=="function"&&openApp("pong");break;case"snakeapp":typeof openApp=="function"&&openApp("snake");break;case"happyturdapp":typeof openApp=="function"&&openApp("happyturd");break;case"mediaapp":typeof openApp=="function"&&openApp("mediaplayer");break;case"tubestreamapp":typeof openApp=="function"&&openApp("tubestream");break;case"rstrtcomp":typeof ln=="function"&&ln();break;default:console.warn("Unknown start menu item clicked:",e)}}function rr(e,t,n=!1,o=null){let i=!1;const a=!["mycomp","storageapp","sysset"].includes(t.id),s=document.createElement("div");s.className="start-menu-context-menu absolute hidden bg-gray-100 border-r border-t border-b border-gray-500 z-50 w-48",s.style.display="none";let l=`
    <div class="context-menu-item px-4 py-2 hover:bg-gray-50 cursor-pointer select-none flex items-center" data-action="open">
      Open
    </div>
    <div class="context-menu-item px-4 py-2 hover:bg-gray-50 cursor-pointer select-none flex items-center" data-action="shortcut">
      Create shortcut
    </div>`;a&&(l+=`
    <div class="context-menu-item px-4 py-2 hover:bg-gray-50 cursor-pointer select-none flex items-center text-red-600" data-action="uninstall">
      Uninstall
    </div>`),s.innerHTML=l,e.appendChild(s),s.addEventListener("click",m=>{var x;m.stopPropagation();const g=(x=m.target.closest(".context-menu-item"))==null?void 0:x.dataset.action;g&&(ms(g,t,n,o),u(s))});let c;e.addEventListener("mouseenter",()=>{D.isDragging||(clearTimeout(c),c=setTimeout(()=>{!i&&!D.isDragging&&d(s,e)},800))}),e.addEventListener("mouseleave",()=>{clearTimeout(c),setTimeout(()=>{s.matches(":hover")||u(s)},200)}),s.addEventListener("mouseleave",()=>{setTimeout(()=>{e.matches(":hover")||u(s)},200)});let f,p=!1;e.addEventListener("touchstart",m=>{D.isDragging||(p=!1,f=setTimeout(()=>{!p&&!i&&(m.preventDefault(),d(s,e))},500))}),e.addEventListener("touchmove",()=>{p=!0,clearTimeout(f)}),e.addEventListener("touchend",()=>{clearTimeout(f)}),document.addEventListener("click",m=>{!s.contains(m.target)&&!e.contains(m.target)&&u(s)});function d(m,g){document.querySelectorAll(".start-menu-context-menu").forEach(I=>{I!==m&&(I.style.display="none")}),m.style.display="block",m.classList.remove("hidden"),i=!0;const x=g.getBoundingClientRect(),b=m.getBoundingClientRect();m.style.left=`${g.offsetWidth}px`,m.style.top="-1px",document.getElementById("start-menu").getBoundingClientRect(),x.right+b.width>window.innerWidth&&(m.style.left=`-${b.width+5}px`)}function u(m){m.style.display="none",m.classList.add("hidden"),i=!1}}function ms(e,t,n,o){switch(e){case"open":kt(t.id);break;case"shortcut":if(gs(t),typeof toggleStartMenu=="function")toggleStartMenu();else{const i=document.getElementById("start-menu");if(i){i.classList.add("hidden"),i.setAttribute("aria-hidden","true");const r=document.getElementById("start-button");r&&r.setAttribute("aria-expanded","false")}}break;case"uninstall":if(hs(t,n,o),typeof toggleStartMenu=="function")toggleStartMenu();else{const i=document.getElementById("start-menu");if(i){i.classList.add("hidden"),i.setAttribute("aria-hidden","true");const r=document.getElementById("start-button");r&&r.setAttribute("aria-expanded","false")}}break}}async function gs(e){try{const t=await getFileSystemState();if(!t.folders["C://Desktop"]){console.error("Desktop folder not found"),typeof showDialogBox=="function"&&showDialogBox("Desktop folder not found","error");return}const n=`shortcut-${e.id}-${Date.now()}`;let o=e.icon||"image/file.webp";const i={id:n,name:e.text,type:"app",fullPath:`C://Desktop/${n}`,content_type:"html",contents:{},icon:o,isShortcut:!0,targetId:e.id};t.folders["C://Desktop"][n]=i,await ke(t),await Q(),typeof renderDesktopIcons=="function"?renderDesktopIcons():typeof window.renderDesktopIcons=="function"&&window.renderDesktopIcons()}catch(t){console.error("‚ùå Failed to create desktop shortcut:",t),typeof showDialogBox=="function"&&showDialogBox("Failed to create desktop shortcut","error")}}function hs(e,t,n){const o=`Are you sure you want to uninstall "${e.text}" from the Start menu?`;typeof showDialogBox=="function"?showDialogBox(o,"confirmation",()=>{Vo(e,t,n)},()=>{}):confirm(o)&&Vo(e,t,n)}async function Vo(e,t,n){try{let o=[];try{const i=await B.getItem("startMenuOrder");i&&Array.isArray(i)?o=i:o=typeof ae<"u"?ae:window.startMenuOrder||[]}catch{o=typeof ae<"u"?ae:window.startMenuOrder||[]}if(t&&n){const i=o.map(r=>typeof r=="object"&&r.type==="group"&&r.id===n?{...r,items:r.items.filter(a=>a.id!==e.id)}:r);window.startMenuOrder=i,typeof ae<"u"&&(ae=i),await B.setItem("startMenuOrder",i)}else{const i=o.filter(r=>typeof r=="string"?r!==e.id:!0);window.startMenuOrder=i,typeof ae<"u"&&(ae=i),await B.setItem("startMenuOrder",i)}typeof Q=="function"&&await Q(),xn(),setTimeout(()=>{En()},50),typeof showDialogBox=="function"&&showDialogBox(`"${e.id}" has been uninstalled from the Start menu`,"info")}catch(o){console.error("‚ùå Failed to uninstall item:",o),typeof showDialogBox=="function"&&showDialogBox("Failed to uninstall item","error")}}function ar(){xn();const e=document.getElementById("start-menu");if(!e)return console.warn("Start menu element not found"),!1;const t=e.querySelectorAll("ul > li:not(.group):not(#rstrtcomp)"),n=e.querySelectorAll(".submenu-item");return t.forEach(o=>{sr(o)}),n.forEach(o=>{vo(o)}),ys(),!0}function ys(){const e=document.getElementById("start-menu");e&&(e.addEventListener("dragover",t=>{const n=t.target.closest(".group");if(n&&D.isDragging){const o=n.querySelector("[data-submenu-container]");o&&(o.classList.remove("hidden"),o.classList.add("block"))}}),e.addEventListener("dragleave",t=>{D.isDragging||e.querySelectorAll("[data-submenu-container]").forEach(o=>{o.classList.remove("block")})}))}function vo(e){e.addEventListener("pointerdown",n);function n(r){var f;if(r.button!==0)return;D.startY=r.clientY,D.startX=r.clientX,D.draggedElement=e,D.draggedFromGroup=e.getAttribute("data-parent-group");const a=((f=e.querySelector("img"))==null?void 0:f.src)||"",s=e.cloneNode(!0),l=s.querySelector(".start-menu-context-menu");l&&l.remove();const c=s.textContent.trim();D.draggedItemData={id:e.id,text:c,icon:a,parentGroup:D.draggedFromGroup},document.addEventListener("pointermove",o),document.addEventListener("pointerup",i),document.addEventListener("pointercancel",i),r.preventDefault()}function o(r){if(!r.isPrimary)return;const a=Math.sqrt(Math.pow(r.clientY-D.startY,2)+Math.pow(r.clientX-D.startX,2));!D.isDragging&&a>5&&(D.isDragging=!0,bs(e)),D.isDragging&&ws(r)}function i(r){r.isPrimary&&(document.removeEventListener("pointermove",o),document.removeEventListener("pointerup",i),document.removeEventListener("pointercancel",i),D.isDragging&&vs(),lr())}}function sr(e){e.addEventListener("pointerdown",n);function n(r){r.button===0&&(D.startY=r.clientY,D.draggedElement=e,document.addEventListener("pointermove",o),document.addEventListener("pointerup",i),document.addEventListener("pointercancel",i),r.preventDefault())}function o(r){if(!r.isPrimary)return;const a=Math.abs(r.clientY-D.startY);!D.isDragging&&a>5&&(D.isDragging=!0,xs(e)),D.isDragging&&ks(r)}function i(r){r.isPrimary&&(document.removeEventListener("pointermove",o),document.removeEventListener("pointerup",i),document.removeEventListener("pointercancel",i),D.isDragging&&Es(),lr())}}function lr(){D.placeholder&&D.placeholder.remove(),D.draggedElement&&(D.draggedElement.classList.remove("opacity-50","cursor-grabbing"),D.draggedElement.classList.add("cursor-grab")),document.querySelectorAll(".start-menu-context-menu").forEach(e=>{e.style.display="none",e.classList.add("hidden")}),D.isDragging=!1,D.draggedElement=null,D.draggedFromGroup=null,D.placeholder=null,D.startY=0,D.startX=0,D.draggedItemData=null}function bs(e,t){document.querySelectorAll(".start-menu-context-menu").forEach(n=>{n.style.display="none",n.classList.add("hidden")}),e.classList.add("opacity-50","cursor-grabbing"),e.classList.remove("cursor-grab"),D.placeholder=document.createElement("li"),D.placeholder.className="submenu-placeholder h-8 bg-blue-100 border-2 border-dashed border-blue-500 rounded my-0.5 px-4 py-1",D.placeholder.innerHTML='<span class="text-yellow-600 text-sm"></span>',e.parentNode.insertBefore(D.placeholder,e.nextSibling)}function ws(e){if(!D.placeholder||!D.draggedItemData)return;const t=document.getElementById("start-menu"),n=document.elementFromPoint(e.clientX,e.clientY),o=n==null?void 0:n.closest("[data-submenu-container]");n==null||n.closest(".submenu-item");const i=n==null?void 0:n.closest("ul > li:not(.group)");if(o){o.getAttribute("data-group-id");const r=Array.from(o.querySelectorAll(".submenu-item")).filter(l=>l!==D.draggedElement&&!l.classList.contains("submenu-placeholder"));let a=null,s=!0;for(let l=0;l<r.length;l++){const c=r[l],f=c.getBoundingClientRect(),p=f.top+f.height/2;if(e.clientY<p){a=c,s=!0;break}else if(l===r.length-1){a=c,s=!1;break}}a?s?o.insertBefore(D.placeholder,a):o.insertBefore(D.placeholder,a.nextSibling):o.appendChild(D.placeholder)}else if(i&&!i.classList.contains("group")){const r=t.querySelector("ul"),a=Array.from(r.children).filter(c=>c!==D.draggedElement&&!c.classList.contains("start-menu-placeholder")&&!c.classList.contains("group")&&c.id!=="rstrtcomp");D.placeholder.classList.contains("start-menu-placeholder")||(D.placeholder.className="start-menu-placeholder h-10 bg-indigo-100 border-2 border-dashed border-indigo-500 rounded my-0.5",D.placeholder.innerHTML="");let s=null,l=!0;for(let c=0;c<a.length;c++){const f=a[c],p=f.getBoundingClientRect(),d=p.top+p.height/2;if(e.clientY<d){s=f,l=!0;break}else if(c===a.length-1){s=f,l=!1;break}}if(s)l?r.insertBefore(D.placeholder,s):r.insertBefore(D.placeholder,s.nextSibling);else{const c=r.querySelector("#rstrtcomp");c?r.insertBefore(D.placeholder,c):r.appendChild(D.placeholder)}}}function vs(e){if(!D.placeholder||!D.draggedElement||!D.draggedItemData)return;D.draggedElement.classList.remove("opacity-50","cursor-grabbing");const t=D.placeholder.parentNode,n=t.tagName==="UL"&&!t.hasAttribute("data-submenu-container"),o=t.getAttribute("data-group-id");if(n){D.draggedElement.remove();const i=document.createElement("li");i.id=D.draggedItemData.id,i.className="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center",i.innerHTML=`
      <img src="${D.draggedItemData.icon}" class="h-6 w-6 inline mr-2" alt="${D.draggedItemData.text}">
      ${D.draggedItemData.text}
    `,i.addEventListener("click",()=>kt(i.id)),t.insertBefore(i,D.placeholder),D.placeholder.remove(),sr(i)}else if(o&&o!==D.draggedFromGroup){D.draggedElement.remove();const i=document.createElement("li");i.id=D.draggedItemData.id,i.className="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center submenu-item",i.setAttribute("data-submenu-item",""),i.setAttribute("data-parent-group",o),i.innerHTML=`
      <img src="${D.draggedItemData.icon}" class="h-6 w-6 inline mr-2" alt="${D.draggedItemData.text}">
      ${D.draggedItemData.text}
    `,i.addEventListener("click",()=>kt(i.id)),t.insertBefore(i,D.placeholder),D.placeholder.remove(),vo(i)}else o===D.draggedFromGroup&&(t.insertBefore(D.draggedElement,D.placeholder),D.placeholder.remove());setTimeout(async()=>{try{await Et()}catch(i){console.error("‚ùå Failed to save submenu changes:",i)}},10)}function xs(e,t){document.querySelectorAll(".start-menu-context-menu").forEach(n=>{n.style.display="none",n.classList.add("hidden")}),e.classList.add("opacity-50","cursor-grabbing"),e.classList.remove("cursor-grab"),D.placeholder=document.createElement("li"),D.placeholder.className="start-menu-placeholder h-10 bg-indigo-100 border-2 border-dashed border-indigo-500 rounded my-0.5",e.parentNode.insertBefore(D.placeholder,e.nextSibling)}function ks(e){if(!D.placeholder)return;const t=document.getElementById("start-menu"),n=document.elementFromPoint(e.clientX,e.clientY),o=n==null?void 0:n.closest("[data-submenu-container]");if(o&&D.draggedElement&&!D.draggedElement.classList.contains("submenu-item")){o.getAttribute("data-group-id");const l=Array.from(o.querySelectorAll(".submenu-item")).filter(p=>!p.classList.contains("submenu-placeholder"));D.placeholder.classList.contains("submenu-placeholder")||(D.placeholder.className="submenu-placeholder h-8 bg-blue-100 border-2 border-dashed border-blue-500 rounded my-0.5 px-4 py-1",D.placeholder.innerHTML='<span class="text-blue-600 text-sm"></span>');let c=null,f=!0;for(let p=0;p<l.length;p++){const d=l[p],u=d.getBoundingClientRect(),m=u.top+u.height/2;if(e.clientY<m){c=d,f=!0;break}else if(p===l.length-1){c=d,f=!1;break}}c?f?o.insertBefore(D.placeholder,c):o.insertBefore(D.placeholder,c.nextSibling):o.appendChild(D.placeholder);return}const i=t.querySelector("ul"),r=Array.from(i.children).filter(l=>l!==D.draggedElement&&!l.classList.contains("start-menu-placeholder")&&!l.classList.contains("group")&&l.id!=="rstrtcomp");D.placeholder.classList.contains("start-menu-placeholder")||(D.placeholder.className="start-menu-placeholder h-10 bg-indigo-100 border-2 border-dashed border-indigo-500 rounded my-0.5",D.placeholder.innerHTML="");let a=null,s=!0;for(let l=0;l<r.length;l++){const c=r[l],f=c.getBoundingClientRect(),p=f.top+f.height/2;if(e.clientY<p){a=c,s=!0;break}else if(l===r.length-1){a=c,s=!1;break}}if(a)s?i.insertBefore(D.placeholder,a):i.insertBefore(D.placeholder,a.nextSibling);else{const l=i.querySelector("#rstrtcomp");l&&i.insertBefore(D.placeholder,l)}}function Es(e){var i;if(!D.placeholder||!D.draggedElement)return;D.draggedElement.classList.remove("opacity-50","cursor-grabbing");const t=D.placeholder.parentNode,n=t.hasAttribute("data-submenu-container"),o=t.getAttribute("data-group-id");if(n){const r=D.draggedElement.cloneNode(!0),a=r.querySelector(".start-menu-context-menu");a&&a.remove();const s={id:D.draggedElement.id,text:r.textContent.trim(),icon:((i=D.draggedElement.querySelector("img"))==null?void 0:i.src)||""};D.draggedElement.remove();const l=document.createElement("li");l.id=s.id,l.className="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center submenu-item",l.setAttribute("data-submenu-item",""),l.setAttribute("data-parent-group",o),l.innerHTML=`
      <img src="${s.icon}" class="h-6 w-6 inline mr-2" alt="${s.text}">
      ${s.text}
    `,l.addEventListener("click",()=>kt(l.id)),t.insertBefore(l,D.placeholder),D.placeholder.remove(),vo(l)}else D.draggedElement.classList.add("cursor-grab"),t.insertBefore(D.draggedElement,D.placeholder),D.placeholder.remove();setTimeout(async()=>{try{await Et()}catch(r){console.error("‚ùå Failed to save start menu order:",r)}},10)}async function Et(){if(typeof window.isInitializing<"u"&&window.isInitializing)return;const t=document.getElementById("start-menu").querySelector("ul"),n=Array.from(t.children),o=[];if(n.forEach(i=>{if(i.id&&!i.classList.contains("group")&&i.id!=="rstrtcomp")o.push(i.id);else if(i.classList.contains("group")){const r=i.getAttribute("data-group-id"),a=i.querySelector("[data-submenu-trigger]"),s=i.querySelector("[data-submenu-container]");if(a&&s&&r){const l=a.cloneNode(!0),c=l.querySelector(".start-menu-context-menu");c&&c.remove();const f=l.textContent.trim(),p=Array.from(s.querySelectorAll(".submenu-item")).map(u=>{var x;const m=u.cloneNode(!0),g=m.querySelector(".start-menu-context-menu");return g&&g.remove(),{id:u.id,text:m.textContent.trim(),icon:((x=u.querySelector("img"))==null?void 0:x.src)||""}}),d={type:"group",id:r,name:f,items:p};o.push(d)}}}),!o||o.length===0){console.warn("Refusing to save empty start menu order - likely a race condition");return}if(typeof window<"u"){window.startMenuOrder=o;try{typeof ae<"u"&&(ae=o)}catch{}}try{await B.setItem("startMenuOrder",o),typeof Q=="function"?await Q():typeof window.saveState=="function"?await window.saveState():console.warn("‚ö† saveState function not available, only saved directly");try{const i=await B.getItem("startMenuOrder");JSON.stringify(i)===JSON.stringify(o)||console.warn("‚ö† Start menu order mismatch in direct storage after save")}catch(i){console.warn("Could not verify direct save:",i)}}catch(i){console.error("Failed to save start menu order:",i)}}async function kn(){let e=[];try{const t=await B.getItem("startMenuOrder");t&&Array.isArray(t)?e=t:e=typeof ae<"u"?ae:window.startMenuOrder||[]}catch(t){console.warn("‚ö† Failed to load from direct storage, using global variables:",t),e=typeof ae<"u"?ae:window.startMenuOrder||[]}typeof window<"u"&&(window.startMenuOrder=e);try{typeof ae<"u"&&(ae=e)}catch{}xn(),Xn=!1,setTimeout(()=>{En()},50)}let Xn=!1;document.addEventListener("DOMContentLoaded",()=>{});function En(){if(Xn)return!0;const e=ar();return e&&(Xn=!0),e}window.initializeStartMenuDragDrop=ar;window.safeInitializeStartMenuDragDrop=En;window.restoreStartMenuOrder=kn;window.saveStartMenuOrder=Et;window.debugStartMenuState=async function(){const e=document.getElementById("start-menu"),t=e==null?void 0:e.querySelector("ul");Array.from((t==null?void 0:t.children)||[]).map(n=>{var r;const o=n.cloneNode(!0),i=o.querySelector(".start-menu-context-menu");return i&&i.remove(),{id:n.id,text:(r=o.textContent)==null?void 0:r.trim()}});try{const n=await B.getItem("appState")}catch(n){console.error("Error reading from storage:",n)}};window.testSaveStartMenu=function(){Et().catch(e=>{console.error("Test save failed:",e)})};window.testBasicSave=async function(){if(window.startMenuOrder=["test1","test2","test3"],typeof window.saveState=="function")try{await window.saveState();const e=await B.getItem("appState")}catch(e){console.error("‚ùå Basic save failed:",e)}else console.error("‚ùå window.saveState not available")};window.testRealSave=async function(){await Et()};window.testRestore=function(){kn()};async function Ss(){try{const e=await us();e.mailbox||gt.add("mailboxapp"),e.tubestream||gt.add("tubestreamapp"),gt.size>0&&(console.log("üîç Hiding unavailable apps:",Array.from(gt)),xn(),setTimeout(()=>{En()},50))}catch(e){console.error("Failed to initialize API probes:",e)}}function pn(){kn(),Ss()}window.initializeStartMenu=pn;window.testFullStartMenuFlow=async function(){await debugStartMenuState(),pn(),await debugStartMenuState(),await testRealSave(),testRestore(),await debugStartMenuState()};window.testStartMenuSave=async function(){const e=["app-calculator","app-chess","app-mediaplayer"];await Et();const t=await B.getItem("startMenuOrder"),n=await B.getItem("appState");return{testOrder:e,directResult:t,appStateResult:n==null?void 0:n.startMenuOrder,globalResult:typeof ae<"u"?ae:null,windowResult:window.startMenuOrder}};window.testStartMenuRestore=async function(){var t;typeof window<"u"&&(window.startMenuOrder=[]);try{typeof ae<"u"&&(ae=[])}catch{console.warn("Could not clear global startMenuOrder")}return await kn(),{globalResult:typeof ae<"u"?ae:null,windowResult:window.startMenuOrder,menuHTML:((t=document.getElementById("start-menu"))==null?void 0:t.innerHTML.substring(0,200))+"..."}};window.debugStorageContents=async function(){try{const e=await B.getItem("appState"),t=await B.getItem("startMenuOrder");return{appState:e,directStartMenu:t,globalStartMenu:typeof ae<"u"?ae:null,windowStartMenu:window.startMenuOrder}}catch(e){return console.error("‚ùå Error debugging storage:",e),{error:e.message}}};function Vn(){document.querySelectorAll('#start-menu [role="menuitem"]').forEach(t=>{t.classList.remove("bg-gray-50","focus-visible","keyboard-focused"),t.setAttribute("tabindex","-1"),t.blur()}),window.startMenuKeyboardNavState&&window.startMenuKeyboardNavState.setKeyboardNavigating(!1)}function Cs(e,t=!1){var o;const n=document.querySelectorAll('#start-menu [role="menuitem"]');if(n.forEach(i=>{i.classList.remove("bg-gray-50","focus-visible","keyboard-focused"),i.setAttribute("tabindex","-1"),i.hasAttribute("aria-haspopup")&&i.setAttribute("aria-expanded","false")}),document.querySelectorAll("[data-submenu-container]").forEach(i=>{i.classList.add("hidden"),i.classList.remove("block")}),n[e]){const i=n[e];if(i.classList.add("bg-gray-50","focus-visible","keyboard-focused"),i.setAttribute("tabindex","0"),i.focus(),t&&i.hasAttribute("data-submenu-trigger")){const r=i.closest("li"),a=r==null?void 0:r.querySelector("[data-submenu-container]");a&&(a.classList.remove("hidden"),a.classList.add("block"),i.setAttribute("aria-expanded","true"))}if(i.hasAttribute("data-submenu-item")){const r=i.getAttribute("data-parent-group");if(r){const a=document.querySelector(`[data-submenu-container][data-group-id="${r}"]`);if(a){a.classList.remove("hidden"),a.classList.add("block");const s=(o=a.closest("li"))==null?void 0:o.querySelector("[data-submenu-trigger]");s&&s.setAttribute("aria-expanded","true")}}}i.scrollIntoView({behavior:"smooth",block:"nearest"})}}function Is(){let e=0,t=[],n=!1,o=!1;window.startMenuKeyboardNavState={isKeyboardNavigating:()=>o,setKeyboardNavigating:f=>{o=f}};function i(f,p=!1){o=!0,Cs(f,p)}document.addEventListener("keydown",function(f){const p=/Mac|iPod|iPhone|iPad/.test(navigator.platform);if((f.key==="Meta"||f.key==="OS")&&!p){f.preventDefault();const d=document.getElementById("start-menu"),u=document.getElementById("start-button");d&&u&&(d.classList.contains("hidden")?(typeof toggleStartMenu=="function"?toggleStartMenu():(d.classList.remove("hidden"),d.setAttribute("aria-hidden","false"),u.setAttribute("aria-expanded","true"),typeof window.updateStartMenuFocusability=="function"&&window.updateStartMenuFocusability(!0)),setTimeout(l,10)):(typeof toggleStartMenu=="function"?toggleStartMenu():(d.classList.add("hidden"),d.setAttribute("aria-hidden","true"),u.setAttribute("aria-expanded","false"),typeof window.updateStartMenuFocusability=="function"&&window.updateStartMenuFocusability(!1)),u.focus()))}});function r(){return t=Array.from(document.querySelectorAll('#start-menu [role="menuitem"]')),t}function a(){return t.filter(f=>!f.hasAttribute("data-submenu-item"))}function s(f){return t.filter(p=>p.hasAttribute("data-submenu-item")&&p.getAttribute("data-parent-group")===f)}function l(){r(),e=0,n=!1,t.length>0&&i(e)}const c=document.getElementById("start-button");c&&c.addEventListener("click",()=>{setTimeout(l,10)}),document.addEventListener("keydown",function(f){const p=document.getElementById("start-menu");if(!(!p||p.classList.contains("hidden"))&&(r(),t.length!==0))switch(f.key){case"ArrowDown":if(f.preventDefault(),n){const d=t[e],u=d.getAttribute("data-parent-group"),m=s(u),x=(m.indexOf(d)+1)%m.length,b=m[x];e=t.indexOf(b)}else{const d=a(),u=t[e],g=(d.indexOf(u)+1)%d.length,x=d[g];e=t.indexOf(x)}i(e);break;case"ArrowUp":if(f.preventDefault(),n){const d=t[e],u=d.getAttribute("data-parent-group"),m=s(u),x=(m.indexOf(d)-1+m.length)%m.length,b=m[x];e=t.indexOf(b)}else{const d=a(),u=t[e],g=(d.indexOf(u)-1+d.length)%d.length,x=d[g];e=t.indexOf(x)}i(e);break;case"ArrowRight":if(f.preventDefault(),t[e]&&t[e].hasAttribute("data-submenu-trigger")&&t[e].classList.contains("focus-visible")){const d=t[e].closest("li"),u=d==null?void 0:d.querySelector("[data-submenu-container]"),m=u==null?void 0:u.querySelectorAll('[role="menuitem"]');if(m&&m.length>0){for(let g=0;g<t.length;g++)if(m[0]===t[g]){e=g,n=!0,i(e);break}}}break;case"ArrowLeft":if(f.preventDefault(),t[e]&&t[e].hasAttribute("data-submenu-item")){const d=t[e].getAttribute("data-parent-group");if(d)for(let u=0;u<t.length;u++){const m=t[u];if(m.hasAttribute("data-submenu-trigger")){const g=m.closest("li");if((g==null?void 0:g.getAttribute("data-group-id"))===d){e=u,n=!1,i(e,!1);break}}}}break;case"Enter":case" ":f.preventDefault(),t[e]&&t[e].click();break;case"Escape":f.preventDefault(),p&&(p.classList.add("hidden"),p.setAttribute("aria-hidden","true"),c&&(c.setAttribute("aria-expanded","false"),c.focus()));break;case"Home":if(f.preventDefault(),n){const u=t[e].getAttribute("data-parent-group"),m=s(u);if(m.length>0){const g=m[0];e=t.indexOf(g)}}else{const d=a();if(d.length>0){const u=d[0];e=t.indexOf(u)}}i(e);break;case"End":if(f.preventDefault(),n){const u=t[e].getAttribute("data-parent-group"),m=s(u);if(m.length>0){const g=m[m.length-1];e=t.indexOf(g)}}else{const d=a();if(d.length>0){const u=d[d.length-1];e=t.indexOf(u)}}i(e);break}}),r()}function Zn(e){const t=document.getElementById("start-menu");if(!t)return;t.querySelectorAll('[role="menuitem"], a[data-submenu-trigger]').forEach(o=>{e?o.setAttribute("tabindex","-1"):(o.setAttribute("tabindex","-1"),o.blur())})}function St(){const e=document.getElementById("start-menu"),t=document.getElementById("start-button"),n=e.classList.contains("hidden");e.classList.toggle("hidden"),t.setAttribute("aria-expanded",n?"true":"false"),n?(e.setAttribute("aria-hidden","false"),Zn(!0),typeof pt=="function"&&pt()):(e.setAttribute("aria-hidden","true"),Zn(!1),!Object.values(J).some(i=>i.fullScreen)&&typeof We=="function"&&We()),Ze("start-button"),Ls(),e.classList.contains("hidden")||setTimeout(()=>{typeof safeInitializeStartMenuDragDrop=="function"?safeInitializeStartMenuDragDrop():typeof initializeStartMenuDragDrop=="function"?initializeStartMenuDragDrop():console.warn("Start menu drag and drop initialization functions not available")},10)}function Sn(){for(const t in J)Je(t);document.querySelectorAll("#window-tabs > div").forEach(t=>{t.classList.remove("bg-gray-50")}),typeof We=="function"&&We();const e=document.getElementById("desktop-stage");e&&(e.style.overflow="scroll")}function Cn(e,t="",n={type:"default"},o="default"){if(Fe[e]){const i=document.getElementById(Fe[e]);if(i){Ce(i);return}else delete Fe[e]}se(e,t,!0,null,!1,!1,n,o)}function In(){const e=document.getElementById("clock"),t=new Date;let n=t.getHours(),o=t.getMinutes(),i=t.getSeconds();n=n<10?"0"+n:n,o=o<10?"0"+o:o,i=i<10?"0"+i:i;let a=typeof be<"u"&&be&&be.clockSeconds||!1?`${n}:${o}:${i}`:`${n}:${o}`;e.textContent=a}function Ln(){const e=Mn();e&&(e.paused?e.play():e.pause(),xo())}function xo(){const e=Mn(),t=document.getElementById("media-control");e?(t.textContent=e.paused?"‚ñ∂":"‚è∏",t.setAttribute("aria-label",e.paused?"Play media":"Pause media"),t.style.display="inline-block"):(t.textContent="",t.setAttribute("aria-label","No media playing"),t.style.display="none")}function Mn(){if(xt){const e=document.getElementById(xt);if(e)return e.querySelector("video, audio")}return null}setInterval(In,1e3);In();document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelectorAll("[data-submenu-trigger]");window.innerWidth<1024&&e.forEach(n=>{const o=n.nextElementSibling,i=n.querySelector("span");n.addEventListener("click",r=>{r.preventDefault(),o.classList.contains("hidden")?(o.classList.remove("hidden"),o.classList.add("block"),i.classList.add("rotate-90")):(o.classList.remove("block"),o.classList.add("hidden"),i.classList.remove("rotate-90"))})})});document.getElementById("media-control").addEventListener("click",()=>{Ln()});document.getElementById("min-all-btn").addEventListener("click",()=>{St(),Sn()});document.getElementById("start-button").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),St()});document.getElementById("start-button").addEventListener("touchstart",e=>{e.preventDefault(),e.stopPropagation(),St()},{passive:!1});function Ls(){const e=document.getElementById("start-button").querySelector("img");e.src.includes("image/door-closed.webp")?e.src=e.src.replace("door-closed","door-open"):e.src=e.src.replace("door-open","door-closed")}const Ms=Object.freeze(Object.defineProperty({__proto__:null,getActiveMediaElement:Mn,minimizeAllWindows:Sn,openNav:Cn,toggleMediaPlayback:Ln,toggleStartMenu:St,updateClock:In,updateMediaControl:xo,updateStartMenuFocusability:Zn},Symbol.toStringTag,{value:"Module"}));async function ct(e){if(e.dataset.initialized==="true")return;e.dataset.initialized="true";try{await B.ensureReady()}catch(F){console.warn("Storage not ready, falling back to sync methods:",F)}const t=e.getAttribute("data-letterpad-editor-id"),n=`letterpad_${t}`;let o=null,i="sans";try{const F=await B.getItem(n);if(F)try{const N=F;o=N.content,i=N.font||"sans"}catch(N){console.error("Error accessing stored markdown data for editor "+t,N)}}catch(F){console.warn("Failed to load LetterPad content for editor "+t+", trying sync method:",F);try{const N=B.getItemSync(n);if(N){const _=N;o=_.content,i=_.font||"sans"}}catch(N){console.warn("Sync fallback also failed:",N)}}const r=document.createElement("div");r.className="flex flex-col h-full w-full border rounded p-2 bg-white";const a=document.createElement("div");a.className="flex flex-wrap gap-2 mb-2";const s=document.createElement("select");s.className="border rounded p-1",s.id="heading-selector",s.setAttribute("aria-label","Select text formatting style"),s.setAttribute("title","Choose the text style (paragraph, heading 1, etc.)"),[{value:"paragraph",text:"Paragraph"},{value:"h1",text:"Heading 1"},{value:"h2",text:"Heading 2"},{value:"h3",text:"Heading 3"}].forEach(F=>{const N=document.createElement("option");N.value=F.value,N.textContent=F.text,s.appendChild(N)}),a.appendChild(s);const c=document.createElement("select");c.className="border rounded p-1",c.id="font-selector",c.setAttribute("aria-label","Select font family"),c.setAttribute("title","Choose the font family for your text"),[{value:"sans",text:"Pixelify Sans"},{value:"serif",text:"Coral Pixels"},{value:"blackletter",text:"Jacquard 12"}].forEach(F=>{const N=document.createElement("option");N.value=F.value,N.textContent=F.text,c.appendChild(N)}),a.appendChild(c),c.value=i;const p=["font-sans","font-serif","font-blackletter"];function d(){p.forEach(F=>b.classList.remove(F)),b.classList.add(`font-${i}`)}function u(F){var te;$();const N=O.start,_=O.end;if(N===_)return;const V=b.value,Z=V.substring(N,_),k=V.substring(0,N),L=V.substring(_),A=/^\[font=(sans|serif|blackletter)\]/,M="[/font]",S=`[font=${F}]`;let T=Z;const X=A.test(Z),ee=Z.endsWith(M);if(X&&ee){T=T.replace(A,""),T=T.slice(0,T.length-M.length);const ie=(te=Z.match(A))==null?void 0:te[1];if(ie&&ie!==F){const we=`${S}${T}${M}`;b.value=k+we+L,b.selectionStart=N+S.length,b.selectionEnd=N+S.length+T.length;return}else{b.value=k+T+L,b.selectionStart=N,b.selectionEnd=N+T.length;return}}const oe=`${S}${T}${M}`;b.value=k+oe+L,O.start=b.selectionStart=N+S.length,O.end=b.selectionEnd=N+S.length+T.length}const m=document.createElement("button");m.type="button",m.className="border rounded p-1 hover:bg-gray-200",m.textContent="Bold",m.setAttribute("aria-label","Apply bold formatting"),m.setAttribute("title","Make selected text bold"),a.appendChild(m);const g=document.createElement("button");g.type="button",g.className="border rounded p-1 hover:bg-gray-200",g.textContent="Italic",g.setAttribute("aria-label","Apply italic formatting"),g.setAttribute("title","Make selected text italic"),a.appendChild(g);const x=document.createElement("button");x.type="button",x.className="border rounded p-1 hover:bg-gray-200",x.textContent="Underline",x.setAttribute("aria-label","Apply underline formatting"),x.setAttribute("title","Underline selected text"),a.appendChild(x);const b=document.createElement("textarea");b.className="w-full h-full flex-1 min-h-0 border rounded p-2 resize-none",b.id="markdown-editor",b.setAttribute("aria-label","Markdown text editor"),b.setAttribute("placeholder","Type your text here using Markdown formatting..."),b.setAttribute("title","Enter your text with Markdown formatting"),d();const I=document.createElement("div");I.className="w-full h-full flex-1 min-h-0 border rounded p-2 overflow-auto";const h=document.createElement("button");h.type="button",h.className="border rounded p-1 hover:bg-gray-200 self-end",h.setAttribute("aria-label","Toggle between edit and preview mode"),h.setAttribute("title","Switch between editing and preview modes"),o?h.textContent="Edit":h.textContent="Save & Preview";const H=document.createElement("div");H.className="flex-1 min-h-0 flex flex-col",H.appendChild(b),H.appendChild(I),r.appendChild(a),r.appendChild(H),r.appendChild(h),e.appendChild(r),a.addEventListener("mousedown",F=>{F.target&&F.target.closest("button")&&F.preventDefault()}),c.addEventListener("mousedown",j),s.addEventListener("mousedown",j);let O={start:0,end:0};function j(){O.start=b.selectionStart,O.end=b.selectionEnd}function $(){b.focus(),b.selectionStart=O.start,b.selectionEnd=O.end}["keyup","mouseup","select","input"].forEach(F=>{b.addEventListener(F,j)}),m.addEventListener("click",function(F){F.preventDefault(),$(),Jn("**",b)}),g.addEventListener("click",function(F){F.preventDefault(),$(),Jn("*",b)}),x.addEventListener("click",function(F){F.preventDefault(),$();const N=b.selectionStart,_=b.selectionEnd,V=b.value.substring(N,_),Z=b.value.substring(0,N),k=b.value.substring(_);if(N!==_)if(V.startsWith("<u>")&&V.endsWith("</u>")){const L=V.substring(3,V.length-4);b.value=Z+L+k,b.selectionStart=N,b.selectionEnd=_-7}else{const L=`<u>${V}</u>`;b.value=Z+L+k,b.selectionStart=N,b.selectionEnd=_+7}}),s.addEventListener("change",function(){const F=s.value;$();const N=O.start,_=b.value,V=_.lastIndexOf(`
`,N-1)+1;let Z="";F==="h1"?Z="# ":F==="h2"?Z="## ":F==="h3"?Z="### ":Z="";const k=_.indexOf(`
`,N),A=_.substring(V,k===-1?_.length:k).replace(/^(#{1,6}\s)?/,Z);b.value=_.substring(0,V)+A+_.substring(k===-1?_.length:k)}),o?(b.value=o,I.innerHTML=nn(o),b.classList.add("hidden"),a.classList.add("hidden"),h.classList.remove("hidden"),I.classList.remove("hidden")):I.classList.add("hidden"),h.addEventListener("click",async function(){if(b.classList.contains("hidden"))I.classList.add("hidden"),b.classList.remove("hidden"),a.classList.remove("hidden"),h.textContent="Preview & Save";else{const F=b.value;I.innerHTML=nn(F);try{await B.setItem(n,{content:F,font:i})}catch(N){console.warn("Failed to save LetterPad content for editor "+t,N)}b.classList.add("hidden"),I.classList.remove("hidden"),h.textContent="Edit",a.classList.add("hidden")}}),c.addEventListener("change",function(){i=c.value,b.classList.contains("hidden")||($(),u(i),I.classList.contains("hidden")||(I.innerHTML=nn(b.value)))})}document.addEventListener("DOMContentLoaded",async function(){try{await B.ensureReady()}catch(n){console.warn("Storage not ready during LetterPad initialization:",n)}const e=document.querySelectorAll(".letterpad_editor");for(const n of e)try{await ct(n)}catch(o){console.error("Error initializing LetterPad editor during DOMContentLoaded:",o)}new MutationObserver(n=>{n.forEach(o=>{o.type==="childList"&&o.addedNodes.forEach(i=>{i.nodeType===Node.ELEMENT_NODE&&(i.classList.contains("letterpad_editor")&&ct(i).catch(r=>{console.error("Error initializing LetterPad editor:",r)}),i.querySelectorAll&&i.querySelectorAll(".letterpad_editor").forEach(r=>{ct(r).catch(a=>{console.error("Error initializing LetterPad editor:",a)})}))})})}).observe(document.body,{childList:!0,subtree:!0})});async function cr(){const e=document.querySelectorAll('.letterpad_editor:not([data-initialized="true"])');for(const t of e)try{await ct(t)}catch(n){console.error("Error initializing LetterPad editor:",n)}}window.initializeAllLetterPadEditors=cr;function Jn(e,t){const n=t.selectionStart,o=t.selectionEnd;if(n===o)return;const i=t.value.substring(n,o),r=t.value.substring(0,n),a=t.value.substring(o),s=e.length,l=i.startsWith(e),c=i.endsWith(e);let f,p=2*s;l&&c?(f=i.slice(s,-s),p=-p):f=e+i+e,t.value=r+f+a,setTimeout(()=>{t.focus(),t.selectionStart=n,t.selectionEnd=o+p},0)}function nn(e){let t=e;const n=/\[font=(sans|serif|blackletter)\]([\s\S]+?)\[\/font\]/g;return t=t.replace(n,(r,a,s)=>`<span class="font-${a}">${s}</span>`),t=t.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/\*(.+?)\*/g,"<em>$1</em>"),t=t.replace(/###### (.*)/g,'<h6 class="mt-1 mb-2 text-2xl">$1</h6>'),t=t.replace(/##### (.*)/g,'<h5 class="mt-1 mb-2 text-3xl">$1</h5>'),t=t.replace(/#### (.*)/g,'<h4 class="mt-1 mb-2 text-4xl">$1</h4>'),t=t.replace(/### (.*)/g,'<h3 class="mt-1 mb-2 text-5xl">$1</h3>'),t=t.replace(/## (.*)/g,'<h2 class="mt-1 mb-2 text-6xl">$1</h2>'),t=t.replace(/# (.*)/g,'<h1 class="mt-1 mb-2 text-7xl">$1</h1>'),t=t.replace(/\n/g,"<br>"),xr(t,["strong","em","h1","h2","h3","h4","h5","h6","br","u","span"],["class"])}document.addEventListener("contextmenu",function(e){let t=e.target.closest(".draggable-icon, .file-item"),n=e.target.closest(".file-explorer-window"),o=e.target.closest("#explorer-window"),i=n||o,r=e.target.closest("#windows-container > div"),a=e.target.closest("#desktop-icons"),l=(e.target.id==="windows-container"||a)&&!r;if(!t&&!i&&!l)return;e.preventDefault();let c;if(n)c=n.getAttribute("data-current-path");else if(o){const f=o.querySelector(".file-explorer-window");c=(f==null?void 0:f.getAttribute("data-current-path"))||"C://"}else l?c="C://Desktop":c="C://";dr(e,t,c)});document.addEventListener("click",function(){$e()});function dr(e,t,n){const o=document.getElementById("context-menu");o.replaceChildren(),o.style.zIndex=Se+100;const i=(g,x,b,I=!1)=>{const h=document.createElement("div");return h.className=`px-4 py-2 relative ${x?"text-gray-400":"hover:bg-gray-50 cursor-pointer"}`,I?h.innerHTML=`${g} <span class="float-right">‚ñ∂</span>`:h.textContent=g,!x&&b&&h.addEventListener("click",b),o.appendChild(h),h},r=(g,x)=>{const b=document.createElement("div");b.className="absolute left-full top-0 bg-white border border-gray-500 shadow-lg hidden min-w-32",b.style.zIndex=Se+101,x.forEach(({text:H,disabled:O,onclick:j})=>{const $=document.createElement("div");$.textContent=H,$.className=`px-4 py-2 ${O?"text-gray-400":"hover:bg-gray-50 cursor-pointer"}`,!O&&j&&$.addEventListener("click",F=>{$e(),j(F)}),b.appendChild($)}),g.appendChild(b);let I;const h=()=>{b.classList.remove("hidden"),b.style.left="100%",b.style.right="auto",b.style.top="0",b.style.bottom="auto";const H=b.getBoundingClientRect(),O=window.innerWidth,j=window.innerHeight;H.right>O&&(b.style.left="auto",b.style.right="100%"),H.bottom>j&&(b.style.top="auto",b.style.bottom="0")};g.addEventListener("mouseenter",()=>{clearTimeout(I),h()}),g.addEventListener("mouseleave",()=>{I=setTimeout(()=>{b.classList.add("hidden")},200)}),g.addEventListener("touchstart",H=>{b.contains(H.target)||(H.preventDefault(),b.classList.contains("hidden")?h():b.classList.add("hidden"))}),b.addEventListener("mouseenter",()=>{clearTimeout(I)}),b.addEventListener("mouseleave",()=>{I=setTimeout(()=>{b.classList.add("hidden")},200)})};if(t){t.classList.add("right-click-target");const g=t.getAttribute("data-is-vendor-application")==="true",x=t.getAttribute("data-item-id")==="compostbin",b=t.getAttribute("data-item-id");let I=!1;if(b&&!x){const h=le();if(h&&h.folders){const H=t.closest(".file-explorer-window");let O=n;H&&(O=H.getAttribute("data-current-path"));const j=h.folders[O];j&&j[b]&&(I=j[b].type==="folder")}}x?i("Empty Compost Bin",!1,h=>{h.stopPropagation(),$e(),typeof emptyCompostBin=="function"&&emptyCompostBin()}):(I&&i("Open in new window",!1,h=>{h.stopPropagation(),$e();const H=document.querySelector(".right-click-target");if(H){const O=H.getAttribute("data-item-id");O&&yt(O)}H.classList.remove("right-click-target")}),i("Edit Name",g,h=>As(h)),i("Send to Compost Bin",g,h=>Ds(h)),i("New Folder",!0),i("New File",!0),i("New Shortcut",!0))}else{i("New Folder",!1,x=>ur(x,n));const g=i("New File",!1,null,!0);r(g,[{text:"LetterPad",disabled:!1,onclick:async x=>await Fs(x,n)},{text:"Image",disabled:!1,onclick:x=>$s(x,n)},{text:"Audio",disabled:!1,onclick:x=>Ps(x,n)},{text:"Video",disabled:!1,onclick:x=>zs(x,n)}]),i("New Shortcut",!1,x=>Ts(x,n))}let a=e.clientY,s=e.clientX;o.style.visibility="hidden",o.classList.remove("hidden");const l=o.getBoundingClientRect(),c=window.innerWidth,f=window.innerHeight,p=window.innerWidth<=768,d=p?22:0,u=p?22:0,m=48;s+l.width>c-d&&(s=c-l.width-d-5),a+l.height>f-m-u&&(a=f-l.height-m-u-5),s<5&&(s=5),a<5&&(a=5),o.style.top=`${a}px`,o.style.left=`${s}px`,o.style.visibility="visible"}function $e(){document.getElementById("context-menu").classList.add("hidden")}function As(e,t){e.stopPropagation(),$e();const n=document.querySelector(".right-click-target");if(n.classList.remove("right-click-target"),!n){re("No item selected.","error");return}const o=n.getAttribute("data-item-id"),i=n.closest(".file-explorer-window");let r;i?r=i.getAttribute("data-current-path"):r=n.getAttribute("data-current-path");let a=le();if(!a||!a.folders){console.error("File system state not properly initialized:",a),re("File system not initialized. Please refresh the page.","error");return}let s={};const l=r.length===4;if(s=a.folders[r],!s){console.error("Folder contents not found for path:",r),re("Folder contents not found.","error");return}if(!(o in s)){re("Item not found.","error");return}let c=s[o];if(!c){re("Item not found in file system.","error");return}const f=`window-${Date.now()}`,d=se("Edit Item Name","",!1,f,!1,!1,{type:"integer",width:300,height:150},"Default").querySelector(".p-2");d.classList.add("p-4");const u=document.createElement("form");u.id="edit-name-form",u.className="flex flex-col space-y-4",d.appendChild(u);const m=document.createElement("input");m.type="text",m.name="newName",m.required=!0,m.value=c.name,m.id="rename-input",m.setAttribute("aria-label","Enter new file or folder name"),m.setAttribute("title","Type the new name for this item"),m.className="mt-1 block w-full border border-gray-300 rounded p-2",u.appendChild(fn("New Name",m));const g=document.createElement("div");g.className="flex justify-end space-x-2",u.appendChild(g);const x=fe("Cancel"),b=fe("Submit");x.id="cancel-edit-button",b.id="submit-edit-button",g.append(x,b),x.addEventListener("click",()=>de(f)),b.addEventListener("click",()=>Ze("submit-edit-button","Editing..."));const I=document.getElementById("edit-name-form");I.addEventListener("submit",function(H){H.preventDefault();const O=I.newName.value.trim();if(O&&O!==c.name){if(c.type==="folder"&&c.fullPath){let _=function(V,Z){if(a.folders[V]){a.folders[Z]=a.folders[V],delete a.folders[V];for(const k in a.folders[Z]){const L=a.folders[Z][k];if(L.type==="folder"&&L.fullPath&&L.fullPath.startsWith(V)){const A=L.fullPath,M=L.fullPath.replace(V,Z);L.fullPath=M,a.folders[A]&&_(A,M)}}}};var j=_;const $=/^[A-Z]:\/\/$/;let F;$.test(r)?F=r+O:F=r+"/"+O;const N=c.fullPath;c.fullPath=F,_(N,F)}c.name=O,r==="C://Desktop"?typeof ye=="function"?ye():console.error("renderDesktopIcons function not available"):typeof Ie=="function"?Ie(r):console.error("refreshAllExplorerWindows function not available"),setFileSystemState(a),Q().catch($=>{console.error("Failed to save state after renaming:",$)}),setTimeout(()=>{r==="C://Desktop"&&typeof ye=="function"?ye():typeof Ie=="function"&&Ie(r)},100)}de(f)}),document.getElementById("cancel-edit-button").addEventListener("click",function(){de(f)})}function Ds(e){e.stopPropagation(),$e();const t=document.querySelector(".right-click-target");if(t&&t.classList.remove("right-click-target"),!t){re("No file selected.","error");return}const n=t.getAttribute("data-item-id"),o=t.closest(".file-explorer-window"),i=o?o.getAttribute("data-current-path"):t.getAttribute("data-current-path");to(n,i)}function ur(e,t){e.stopPropagation(),$e();const n=t||"C://";eo("Enter the name for the new folder:","New Folder",async o=>{(!o||!o.trim())&&(o="Untitled"),o=o.trim();let i=le();if(!i||!i.folders){console.error("File system state not properly initialized:",i),re("File system not initialized. Please refresh the page.","error");return}const r="folder-"+Date.now(),a=/^[A-Z]:\/\/$/;let s=a.test(n)?n+o:n+"/"+o;const l={id:r,name:o,type:"folder",fullPath:s,contents:{}};let c;a.test(t)?(c=i.folders[t],c||(i.folders[t]={},c=i.folders[t])):t==="C://Desktop"?(i.folders["C://Desktop"]||(i.folders["C://Desktop"]={}),c=i.folders["C://Desktop"]):(c=i.folders[t],c||(console.warn("Parent folder contents not found, creating:",t),i.folders[t]={},c=i.folders[t])),c[r]=l,i.folders[s]={},await setFileSystemState(i);try{await Q(),t==="C://Desktop"?typeof ye=="function"&&ye():typeof Ie=="function"&&Ie(n)}catch(f){console.error("Failed to save state after creating folder:",f)}},()=>{})}function Bs(e,t,n=null){e&&e.stopPropagation(),$e();const o=t||"C://",i=`window-${Date.now()}`,a=se("New File","",!1,i,!1,!1,{type:"integer",width:300,height:150},"Default").querySelector(".p-2");a.classList.add("p-4");const s=document.createElement("form");s.id="create-file-form",s.className="flex flex-col space-y-4",a.appendChild(s);const l=document.createElement("input");l.type="text",l.name="fileName",l.required=!0,l.value="New File.rtf",l.id="create-file-name",l.setAttribute("aria-label","Enter file name"),l.setAttribute("title","Enter the name for the new file"),l.className="mt-1 block w-full border border-gray-300 rounded p-2",s.appendChild(fn("File Name",l));const c=document.createElement("div");c.className="flex justify-end space-x-2",s.appendChild(c);const f=fe("Cancel");f.id="cancel-file-button";const p=fe("Submit");p.id="submit-file-button",c.append(f,p),f.addEventListener("click",d=>{d.preventDefault(),Ze("cancel-file-button","Cancelling..."),setTimeout(()=>de(i),100)}),s.addEventListener("submit",d=>{d.preventDefault(),Ze("submit-file-button","Submitting..."),setTimeout(()=>de(i),100);const u=l.value.trim()||"Untitled",m={id:`file-${Date.now()}`,name:u,type:"ugc-file",content:"",content_type:"markdown",icon_url:"image/doc.webp",description:""};An(m,o)&&(t==="C://Desktop"?ye():Ie(o),Q().catch(g=>{console.error("Failed to save state after creating file:",g)}),typeof n=="function"&&n(m.id,m))})}function Ts(e,t){e.stopPropagation(),$e();const n=`window-${Date.now()}`,i=se("New Shortcut","",!1,n,!1,!1,{type:"integer",width:300,height:200},"Default").querySelector(".p-2");i.classList.add("p-4");const r=document.createElement("form");r.id="create-shortcut-form",r.className="flex flex-col space-y-4",i.appendChild(r);const a=document.createElement("input");a.type="text",a.name="shortcutName",a.placeholder="Example Website",a.id="shortcut-name",a.setAttribute("aria-label","Enter shortcut name"),a.setAttribute("title","Enter a display name for the shortcut"),a.className="mt-1 block w-full border border-gray-300 rounded p-2",r.appendChild(fn("Shortcut Name",a));const s=document.createElement("input");s.type="url",s.name="shortcutURL",s.required=!0,s.placeholder="https://example.com",s.id="shortcut-url",s.setAttribute("aria-label","Enter website URL"),s.setAttribute("title","Enter the full URL of the website"),s.className="mt-1 block w-full border border-gray-300 rounded p-2",r.appendChild(fn("Shortcut URL",s));const l=document.createElement("div");l.className="flex justify-end space-x-2";const c=fe("Cancel");c.id="cancel-shortcut-button";const f=fe("Submit");f.id="submit-shortcut-button",l.append(c,f),r.appendChild(l),c.addEventListener("click",()=>{e.preventDefault(),Ze("cancel-shortcut-button","Cancelling..."),setTimeout(()=>de(n),100)}),r.addEventListener("submit",async p=>{p.preventDefault(),Ze("submit-shortcut-button","Submitting..."),setTimeout(()=>de(n),100);const d=s.value.trim();if(!d)return;const u=a.value.trim()||d.replace(d.substring(15),"‚Ä¶"),m=`shortcut-${Date.now()}`;let g="https://www.google.com/s2/favicons?sz=64&domain=";try{g+=new URL(d).hostname}catch{g="image/doc.webp"}const x={id:m,name:u,type:"shortcut",url:d,icon_url:g,description:"",fullPath:t==="C://Desktop"?`C://Desktop/${u}`:`${t}/${u}`};if(!await An(x,t)){console.error("Failed to save shortcut to filesystem");return}t==="C://Desktop"?setTimeout(async()=>{await ye()},100):it(),Pe();try{await Q()}catch(I){console.error("Failed to save state after creating shortcut:",I)}})}async function Fs(e,t,n=null){e&&e.stopPropagation(),$e();const o=t||"C://";eo("Enter the name for the new LetterPad document:","New LetterPad.md",async i=>{(!i||!i.trim())&&(i="New LetterPad.md"),i=i.trim(),i.endsWith(".md")||(i=i+".md");const r=`file-${Date.now()}`,a="",s={id:r,name:i,type:"ugc-file",content:a,content_type:"markdown",icon_url:"image/doc.webp"};if(await An(s,o)){try{await Q()}catch(l){console.error("Failed to save state after creating LetterPad:",l)}t==="C://Desktop"?ye():Ie(o),se(i,`<div class="letterpad_editor min-h-48 h-full w-full" data-letterpad-editor-id="${r}"></div>`,!1,r,!1,!1,{type:"integer",width:600,height:500},"editor"),setTimeout(()=>{const l=`letterpad_${r}`;B.setItemSync(l,{content:a});const c=document.querySelector(`[data-letterpad-editor-id="${r}"]`);c&&typeof ct=="function"&&ct(c)},100),typeof n=="function"&&n(s.id,s)}},()=>{})}function $s(e,t,n=null){e&&e.stopPropagation(),$e();const o=t||"C://",i=document.createElement("input");i.type="file",i.accept="image/*",i.setAttribute("aria-label","Select image file to upload"),i.setAttribute("title","Choose an image file from your computer"),i.style.display="none",i.addEventListener("change",async r=>{const a=r.target.files[0];if(a){const l=a.size/1048576;if(l>25){re(`Image file "${a.name}" is too large (${l.toFixed(2)}MB). Maximum allowed size is 25MB.`,"error"),document.body.removeChild(i);return}const c=a.name.split(".").pop().toLowerCase(),f=await ko(a.name,o,c,a);f&&typeof n=="function"&&n(f.id,f),t==="C://Desktop"?typeof ye=="function"&&ye():typeof Ie=="function"&&Ie(o)}document.body.removeChild(i)}),document.body.appendChild(i),i.click()}function Ps(e,t,n=null){e&&e.stopPropagation(),$e();const o=t||"C://",i=document.createElement("input");i.type="file",i.accept="audio/*",i.style.display="none",i.setAttribute("aria-label","Select audio file to upload"),i.setAttribute("title","Choose an audio file from your computer"),i.addEventListener("change",async r=>{const a=r.target.files[0];if(a){const l=a.size/1048576;if(l>50){re(`Audio file "${a.name}" is too large (${l.toFixed(2)}MB). Maximum allowed size is 50MB.`,"error"),document.body.removeChild(i);return}const c=a.name.split(".").pop().toLowerCase(),f=await ko(a.name,o,c,a);f&&typeof n=="function"&&n(f.id,f),t==="C://Desktop"?typeof ye=="function"&&ye():typeof Ie=="function"&&Ie(o)}document.body.removeChild(i)}),document.body.appendChild(i),i.click()}function zs(e,t,n=null){e&&e.stopPropagation(),$e();const o=t||"C://",i=document.createElement("input");i.type="file",i.accept="video/*",i.style.display="none",i.setAttribute("aria-label","Select video file to upload"),i.setAttribute("title","Choose a video file from your computer"),i.addEventListener("change",async r=>{const a=r.target.files[0];if(a){const l=a.size/1048576;if(l>100){re(`Video file "${a.name}" is too large (${l.toFixed(2)}MB). Maximum allowed size is 100MB.`,"error"),document.body.removeChild(i);return}const c=a.name.split(".").pop().toLowerCase(),f=await ko(a.name,o,c,a);f&&typeof n=="function"&&n(f.id,f),t==="C://Desktop"?typeof ye=="function"&&ye():typeof Ie=="function"&&Ie(o)}document.body.removeChild(i)}),document.body.appendChild(i),i.click()}function fn(e,t){const n=document.createElement("div"),o=document.createElement("label");return o.className="block text-sm font-medium text-gray-700",o.textContent=e,n.append(o,t),n}function Ie(e){const t=document.querySelectorAll(".file-explorer-window");let n=0;t.forEach((o,i)=>{if(o.getAttribute("data-current-path")===e)try{const a=rt(e),s=document.createElement("div");s.innerHTML=a;const l=s.querySelector(".file-explorer-window");if(l){o.innerHTML=l.innerHTML,o.setAttribute("data-current-path",e);const c=o.closest(".window");c&&c.id&&ot(c.id,a),n++}else console.warn(`Failed to get new explorer content for window ${i}`)}catch(a){console.error(`Error refreshing window ${i}:`,a)}}),setTimeout(()=>{typeof Pe=="function"&&Pe()},50)}window.refreshAllExplorerWindows=Ie;async function An(e,t){const n=le();if(!n||!n.folders)return console.error("File system state not properly initialized:",n),re("File system not initialized. Please refresh the page.","error"),!1;let o=n.folders[t];return o||(console.warn("Parent folder contents not found, creating:",t),n.folders[t]={},o=n.folders[t]),o[e.id]=e,await setFileSystemState(n),le().folders[t],!0}async function ko(e,t,n,o){const i=`file-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;let r="image/file.webp";["png","jpg","jpeg","gif","webp","avif"].includes(n)?r="image/image.webp":["mp4","webm","avi","mov"].includes(n)?r="image/video.webp":["mp3","wav","ogg"].includes(n)&&(r="image/audio.webp");const a={id:i,name:e,type:"ugc-file",content_type:n,icon_url:r,content:"",isLargeFile:!0,storageLocation:"indexeddb",file:null};if(!An(a,t))return null;if(o&&["png","jpg","jpeg","gif","webp","avif","mp3","wav","ogg","mp4","webm","avi","mov"].includes(n)){const s=URL.createObjectURL(o),l=le(),c=l.folders[t];c&&c[i]&&(c[i].tempObjectURL=s,c[i].file=o,setFileSystemState(l));try{const f=await new Promise((m,g)=>{const x=new FileReader;x.onload=b=>m(b.target.result),x.onerror=g,x.readAsDataURL(o)}),p=f.length*.75/(1024*1024);await B.setItem(`file_data_${i}`,f);const d=le(),u=d.folders[t];u&&u[i]&&(u[i].isLargeFile=!0,u[i].storageLocation="indexeddb",u[i].content="",u[i].fileSizeInMB=p,u[i].actualSizeInMB=p,u[i].dataURL=f,u[i].file=null),setFileSystemState(d),await Q(),t==="C://Media"&&["mp3","wav","ogg","mp4","webm","avi","mov"].includes(n)&&typeof window.refreshMediaPlayerPlaylist=="function"&&setTimeout(()=>{window.refreshMediaPlayerPlaylist()},200)}catch(f){console.error("Failed to store binary file:",f);const p=le(),d=p.folders[t];d&&d[i]&&(d[i].isLargeFile=!0,d[i].storageLocation="failed",setFileSystemState(p)),re(`File "${e}" could not be stored. Storage error: ${f.message}`,"error")}}else await Q();return a}async function Ws(){const e=window.location.href.includes("reddit.com");let t="1.0.0";try{t=(await(await fetch("./package.json")).json()).version||"1.0.0"}catch(o){console.warn("Could not fetch version from package.json:",o)}const n=`
    <div class="p-4 gap-y-2 flex flex-col">
      <img src="./image/logo.webp" class="w-48 h-auto mx-auto mb-4" alt="Nostalgia OS startup logo">
      <h1 class="text-xl font-bold mb-2">About This Computer</h1>
      <p>Made by multimedia artist Ian McKenzie.</p>
      <p>More shenanigans @ ${e?"relentlesscurious.com":'<a href="https://www.relentlesscurious.com" target="_blank">relentlesscurious.com</a>'}</p>
      <p>Version: ${t}</p>
      <p>Copyright ¬© Ian Rand McKenzie, 2025</p>
      <p>This project must be purchased for use, but is open source and free for non-commercial use for those who contribute via code, security research, bug reporting, etc. ‚Äî contributors may do so on <a target="_blank" href="https://github.com/ianrandmckenzie/nostalgia_os">github.com/ianrandmckenzie/nostalgia_os</a></p>
    </div>
  `;se("About This Computer",n,!1,null,!1,!1,{type:"integer",width:400,height:640},"default",null,"gray-200")}const pr=`
<div class="max-w-4xl mx-auto text-black font-mono bg-gray-50 p-6 h-full overflow-auto">
  <h1 class="text-3xl font-bold text-black mb-6">Security Policy</h1>

  <div class="bg-gray-100 rounded-lg p-4 mb-6 border border-gray-700">
    <p class="text-lg text-black mb-4">
      At relentlessCurious, we take security seriously. This policy outlines our commitment to maintaining a secure environment for our users and provides guidelines for responsible disclosure of security vulnerabilities.
    </p>
  </div>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Reporting Security Vulnerabilities</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black mb-3">
        If you discover a security vulnerability in our systems, please report it responsibly by contacting our developer, Ian, at:
      </p>
      <div class="bg-gray-200 rounded p-3 border border-gray-600 mb-3">
        <p class="text-black font-mono">hey@relentlesscurious.com</p>
      </div>
      <p class="text-black mb-3">
        Please include the following information in your report:
      </p>
      <ul class="list-disc list-inside text-black space-y-1 ml-4">
        <li>Description of the vulnerability</li>
        <li>Steps to reproduce the issue</li>
        <li>Potential impact assessment</li>
        <li>Suggested remediation (if applicable)</li>
        <li>Your contact information for follow-up</li>
      </ul>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Response Timeline</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="bg-gray-200 rounded p-3 border border-gray-600">
          <h3 class="text-lg font-semibold text-black mb-2">Initial Response</h3>
          <p class="text-black">Within 48 hours of receiving your report</p>
        </div>
        <div class="bg-gray-200 rounded p-3 border border-gray-600">
          <h3 class="text-lg font-semibold text-black mb-2">Investigation</h3>
          <p class="text-black">Within 7 days for initial assessment</p>
        </div>
        <div class="bg-gray-200 rounded p-3 border border-gray-600">
          <h3 class="text-lg font-semibold text-black mb-2">Resolution</h3>
          <p class="text-black">Timeline varies based on severity</p>
        </div>
        <div class="bg-gray-200 rounded p-3 border border-gray-600">
          <h3 class="text-lg font-semibold text-black mb-2">Disclosure</h3>
          <p class="text-black">After fix is deployed and verified</p>
        </div>
      </div>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Scope</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <h3 class="text-lg font-semibold text-black mb-2">In Scope</h3>
      <ul class="list-disc list-inside text-black space-y-1 mb-3 ml-4">
        <li>relentlessCurious.com and all subdomains</li>
        <li>Web applications and APIs</li>
        <li>Smart contracts (when deployed)</li>
        <li>Infrastructure vulnerabilities</li>
        <li>Social engineering vulnerabilities</li>
      </ul>

      <h3 class="text-lg font-semibold text-black mb-2">Out of Scope</h3>
      <ul class="list-disc list-inside text-black space-y-1 ml-4">
        <li>Third-party services we don't control</li>
        <li>Social media accounts</li>
        <li>Physical security issues</li>
        <li>Denial of Service (DoS) attacks</li>
        <li>Spam or social engineering attacks</li>
      </ul>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Responsible Disclosure Guidelines</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black mb-3">We ask that security researchers:</p>
      <ul class="list-disc list-inside text-black space-y-1 ml-4">
        <li>Allow us reasonable time to investigate and address the issue before public disclosure</li>
        <li>Avoid accessing, modifying, or deleting user data</li>
        <li>Do not perform testing that could degrade or damage our systems</li>
        <li>Do not use social engineering, phishing, or physical attacks</li>
        <li>Make a good faith effort to avoid privacy violations and data destruction</li>
        <li>Contact us immediately if you inadvertently access sensitive data</li>
      </ul>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Security Measures</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black mb-3">Our security implementation includes:</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="space-y-2">
          <h3 class="text-lg font-semibold text-black">Web Security</h3>
          <ul class="list-disc list-inside text-black text-sm space-y-1 ml-4">
            <li>Content Security Policy (CSP)</li>
            <li>HTTP Strict Transport Security (HSTS)</li>
            <li>Input validation and sanitization</li>
          </ul>
        </div>
        <div class="space-y-2">
          <h3 class="text-lg font-semibold text-black">Data Protection</h3>
          <ul class="list-disc list-inside text-black text-sm space-y-1 ml-4">
            <li>Encryption in transit and at rest</li>
            <li>Regular security audits</li>
            <li>Access controls and monitoring</li>
            <li>Secure development practices</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Recognition</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black mb-3">
        We appreciate the security research community's efforts in keeping our platform secure. Researchers who responsibly disclose valid security vulnerabilities may be:
      </p>
      <ul class="list-disc list-inside text-black space-y-1 ml-4">
        <li>Acknowledged in our security advisory (with permission)</li>
        <li>Listed in our hall of fame</li>
        <li>Considered for our bug bounty program (when available)</li>
      </ul>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Legal Safe Harbor</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black">
        relentlessCurious will not pursue legal action against security researchers who:
      </p>
      <ul class="list-disc list-inside text-black space-y-1 mt-3 ml-4">
        <li>Follow our responsible disclosure policy</li>
        <li>Report vulnerabilities in good faith</li>
        <li>Do not violate any applicable laws</li>
        <li>Do not access, modify, or delete user data</li>
        <li>Do not disrupt our services</li>
      </ul>
    </div>
  </section>

  <footer class="mt-8 pt-6 border-t border-gray-700">
    <div class="text-center">
      <p class="text-black text-sm">
        Last updated: July 15, 2025
      </p>
      <p class="text-black text-sm mt-2">
        This policy is subject to change. Check back regularly for updates.
      </p>
    </div>
  </footer>
</div>
`,Ns={"/security-policy":{title:"Security Policy",content:pr,icon:"image/info.webp"}};function Rs(){Cn("Security Policy",pr,{type:"integer",width:800,height:600},"default")}function Eo(e){const t=Ns[e];return t?(Cn(t.title,t.content,{type:"integer",width:800,height:600},"default"),!0):!1}function fr(){const e=window.location.pathname;e==="/security-policy"&&setTimeout(()=>{Eo(e),window.history.replaceState({},"","/")},500)}window.addEventListener("popstate",function(e){const t=window.location.pathname;Eo(t)||console.log("No route found for:",t)});const Os=1180,Hs=820;let ht,Vt;function qs(){document.addEventListener("touchstart",e=>{var f;const t=e.target.closest(".cursor-move");if(!t)return;const n=t.closest("#windows-container > div");if(!n)return;const o=(f=window.windowStates)==null?void 0:f[n.id];if(o!=null&&o.fullScreen||e.touches.length!==1)return;const i=e.touches[0],r=n.getBoundingClientRect(),a=i.clientX-r.left,s=i.clientY-r.top;function l(p){if(p.touches.length!==1)return;const d=p.touches[0],u=ht?ht.scrollLeft:0,m=ht?ht.scrollTop:0;n.style.left=d.clientX+u-a+"px",n.style.top=d.clientY+m-s+"px",p.preventDefault()}function c(p){var u;window.removeEventListener("touchmove",l,{passive:!1}),window.removeEventListener("touchend",c);const d=(u=window.windowStates)==null?void 0:u[n.id];d&&(d.position={left:n.style.left,top:n.style.top},window.saveState&&window.saveState())}window.addEventListener("touchmove",l,{passive:!1}),window.addEventListener("touchend",c,{passive:!1})},{passive:!0})}function mr(){ht=document.getElementById("desktop-stage"),Vt=document.getElementById("windows-container"),!(!ht||!Vt)&&(Vt.style.minWidth=Os+"px",Vt.style.minHeight=Hs+"px",qs())}typeof window<"u"&&(window.initializeDesktopPan=mr);async function _s(){const e=await B.getItem("appState"),n=`
    <div class="flex flex-col h-full p-4">
      <h2 class="text-lg font-bold mb-2">Developer Data Export</h2>
      <p class="mb-2 text-sm">Copy this JSON to create a default data set.</p>
      <textarea id="dev-data-export" class="flex-1 w-full p-2 border border-gray-400 font-mono text-xs mb-4" readonly>${JSON.stringify(e,null,2)}</textarea>
      <div class="flex justify-end space-x-2">
        <button id="copy-dev-data" class="px-4 py-2 bg-gray-200 border-2 border-gray-400 hover:bg-gray-300 active:border-gray-600">Copy to Clipboard</button>
        <button id="close-dev-data" class="px-4 py-2 bg-gray-200 border-2 border-gray-400 hover:bg-gray-300 active:border-gray-600">Close</button>
      </div>
    </div>
  `,o="dev-data-modal";se("Developer Data",n,!1,o,!1,!0,{width:600,height:500}),setTimeout(()=>{const i=document.getElementById("copy-dev-data"),r=document.getElementById("close-dev-data"),a=document.getElementById("dev-data-export");i&&a&&i.addEventListener("click",()=>{a.select(),document.execCommand("copy"),i.textContent="Copied!",setTimeout(()=>i.textContent="Copy to Clipboard",2e3)}),r&&r.addEventListener("click",()=>{const s=document.getElementById(o);if(s)if(window.closeWindow)window.closeWindow(o);else{s.remove();const l=document.getElementById(`taskbar-${o}`);l&&l.remove()}})},100)}typeof window<"u"&&(window.showDevDataModal=_s);window.isDevvit=!1;const on="1.0";Vi();async function js(){var t;await((t=B.ensureReady)==null?void 0:t.call(B))||Promise.resolve();let e=await B.getItem("version");if(e||await B.setItem("version",on),e!==on){const n=await B.getItem("explicitRestart");await B.removeItem("appState"),await B.removeItem("version"),await B.setItem("version",on),n&&await B.setItem("explicitRestart",n)}}typeof window<"u"&&(window.version=on,window.highestZ=Se,window.activeMediaWindow=xt,window.windowStates=J,window.desktopIconsState=me,window.navWindows=Fe,window.desktopSettings=be,window.startMenuOrder=ae,window.fileFolderMapping=nr,window.createWindow=se,window.minimizeWindow=Je,window.bringToFront=Ce,window.closeWindow=de,window.toggleFullScreen=vt,window.showDialogBox=re,window.getAppIcon=ho,window.renderDesktopIcons=ye,window.makeIconDraggable=bn,window.toggleStartMenu=St,window.minimizeAllWindows=Sn,window.openNav=Cn,window.updateClock=In,window.toggleMediaPlayback=Ln,window.updateMediaControl=xo,window.getActiveMediaElement=Mn,window.openApp=en,window.openExplorer=Ht,window.openExplorerInNewWindow=yt,window.refreshExplorerViews=it,window.getExplorerWindowContent=rt,window.getBreadcrumbsHtml=ei,window.openFile=$t,window.normalizePath=Zt,window.getFolderIdByFullPath=Cr,window.findFolderObjectByFullPath=Qo,window.findFolderFullPathById=hn,window.showContextMenu=dr,window.hideContextMenu=$e,window.createNewFolder=ur,window.createNewFile=Bs,window.refreshAllExplorerWindows=Ie,window.saveFileExplorerState=bt,window.handleWatercolourImageSelection=Ir,window.launchCompostBin=ii,window.loadCompostBinContents=yn,window.emptyCompostBin=ri,window.launchStorageManager=Ji,window.refreshStorageData=_t,window.fullSystemRestart=tr,window.openCleanupWindow=Qi,window.makeWin95Dropdown=qa,window.launchOSUpdate=Hi,window.refreshUpdateCheck=jn,window.openAboutWindow=Ws,window.launchCalculator=mi,window.initializeCalculatorUI=gi,window.launchSolitaire=hi,window.initializeSolitaireUI=yi,window.launchChess=bi,window.initializeChessUI=wi,window.launchBombbroomer=Bi,window.initializeBombbroomerUI=Ti,window.launchHappyTurd=Oi,window.initializeHappyTurdUI=uo,window.launchPong=Ni,window.initializePongUI=lo,window.launchSnake=Ri,window.initializeSnakeUI=co,window.initializeLetterPad=ct,window.initializeAllLetterPadEditors=cr,window.applyFormatting=Jn,window.convertMarkdownToHTML=nn,window.launchMailbox=si,window.launchWatercolour=di,window.initializeWatercolourUI=ui,window.getWatercolourHTML=pi,window.initializeWatercolour=fi,window.launchTubeStream=li,window.launchMediaPlayer=Fi,window.initializeMediaPlayerUI=$i,window.restoreMediaPlayerSession=Pi,window.saveMediaPlayerState=Ve,window.loadMediaPlayerState=ao,window.clearMediaPlayerState=sa,window.initializeRouter=fr,window.handleRoute=Eo,window.openSecurityPolicy=Rs,window.restart=ln,window.logout=Zi,window.storage=B);document.getElementById("desktop").addEventListener("click",function(e){e.target.closest(".draggable-icon")||document.querySelectorAll(".draggable-icon").forEach(t=>t.classList.remove("bg-gray-50"))});function Us(){const e=document.getElementById("media-control");e&&e.addEventListener("keydown",function(o){(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),Ln())});const t=document.getElementById("start-button");t&&t.addEventListener("keydown",function(o){(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),St())});const n=document.getElementById("min-all-btn");n&&n.addEventListener("keydown",function(o){(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),Sn())}),document.addEventListener("keydown",function(o){if(o.key==="Escape"){const i=document.getElementById("start-menu"),r=document.getElementById("context-menu");if(i&&!i.classList.contains("hidden")){document.getElementById("start-button").setAttribute("aria-expanded","false"),i.classList.add("hidden"),i.setAttribute("aria-hidden","true");const{toggleButtonActiveState:s}=window;s&&s("start-button")}r&&!r.classList.contains("hidden")&&(r.classList.add("hidden"),r.setAttribute("aria-hidden","true"))}})}window.addEventListener("click",async function(e){const t=document.getElementById("start-menu"),n=document.getElementById("start-button");if(!t.contains(e.target)&&!n.contains(e.target)){if(!t.classList.contains("hidden")){const{toggleButtonActiveState:o}=await Hn(async()=>{const{toggleButtonActiveState:i}=await Promise.resolve().then(()=>oi);return{toggleButtonActiveState:i}},void 0);o("start-button")}t.classList.add("hidden"),t.setAttribute("aria-hidden","true"),n.setAttribute("aria-expanded","false")}});window.addEventListener("load",async function(){await js();const{toggleButtonActiveState:e,makeWin95Button:t,makeWin95Prompt:n,openFileExplorerForImageSelection:o}=await Hn(async()=>{const{toggleButtonActiveState:a,makeWin95Button:s,makeWin95Prompt:l,openFileExplorerForImageSelection:c}=await Promise.resolve().then(()=>oi);return{toggleButtonActiveState:a,makeWin95Button:s,makeWin95Prompt:l,openFileExplorerForImageSelection:c}},void 0);window.toggleButtonActiveState=e,window.makeWin95Button=t,window.makeWin95Prompt=n,window.openFileExplorerForImageSelection=o;const i=await B.getItem("appState"),r=await B.getItem("explicitRestart");if((!i||r)&&(vn(),r&&await B.removeItem("explicitRestart")),await Kn(),await es(),await ye(),await ds(),mr(),Yi(),typeof pn=="function"){pn();const{updateStartMenuFocusability:a}=await Hn(async()=>{const{updateStartMenuFocusability:l}=await Promise.resolve().then(()=>Ms);return{updateStartMenuFocusability:l}},void 0);window.updateStartMenuFocusability=a;const s=document.getElementById("start-menu");s&&s.classList.contains("hidden")&&a(!1)}else console.error("initializeStartMenu function not available");fr(),Us(),document.querySelectorAll(".draggable-icon").forEach(a=>bn(a))});document.addEventListener("keydown",function(e){if(e.altKey)switch(e.key){case"Tab":e.preventDefault(),Yn();break;case"F4":e.preventDefault(),Ko();break}if(e.key==="Escape"&&wt(),e.key==="Enter"&&document.getElementById("window-cycle-popup")&&!document.getElementById("window-cycle-popup").classList.contains("hidden")&&(e.preventDefault(),wt()),e.ctrlKey)switch(e.key){case"w":e.preventDefault(),Ko();break;case"m":e.preventDefault(),Pa();break}});document.addEventListener("keyup",function(e){if(e.key==="Alt"){const t=document.getElementById("window-cycle-popup");t&&!t.classList.contains("hidden")&&wt()}});Is();
