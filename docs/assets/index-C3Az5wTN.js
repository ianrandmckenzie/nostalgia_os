(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(o){if(o.ep)return;o.ep=!0;const r=t(o);fetch(o.href,r)}})();const Tr="modulepreload",Fr=function(e){return"/"+e},To={},an=function(n,t,i){let o=Promise.resolve();if(t&&t.length>0){let a=function(c){return Promise.all(c.map(d=>Promise.resolve(d).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),l=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));o=a(t.map(c=>{if(c=Fr(c),c in To)return;To[c]=!0;const d=c.endsWith(".css"),p=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${p}`))return;const m=document.createElement("link");if(m.rel=d?"stylesheet":Tr,d||(m.as="script"),m.crossOrigin="",m.href=c,l&&m.setAttribute("nonce",l),document.head.appendChild(m),d)return new Promise((u,f)=>{m.addEventListener("load",u),m.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${c}`)))})}))}function r(a){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=a,window.dispatchEvent(s),!s.defaultPrevented)throw a}return o.then(a=>{for(const s of a||[])s.status==="rejected"&&r(s.reason);return n().catch(r)})},At={development:{API_BASE_URL:"http://abc.localhost:3000/",SUGGESTIONS_LIST_PATH:"end_data/public/ananan",SUGGESTIONS_SUBMISSIONS_PATH:"end_data/public/kfjbwef",TUBE_STREAMS_PATH:"tube-streams.json",CUSTOM_APPS_PATH:"end_data/public/custom_apps",DEFAULT_FILES_PATH:"end_data/public/default-files"},production:{API_BASE_URL:"https://backend.failureunit.tv/",SUGGESTIONS_LIST_PATH:"end_data/public/suggestions",SUGGESTIONS_SUBMISSIONS_PATH:"end_data/public/submit-suggestion",TUBE_STREAMS_PATH:"end_data/public/tube-streams",CUSTOM_APPS_PATH:"end_data/public/custom_apps",DEFAULT_FILES_PATH:"end_data/public/default-files"},trusted_providers:[{domains:["s3.ca-central-1.amazonaws.com","www.failureunit.tv"],dev_domains:["localhost","*.localhost","abc.localhost:3000"],types:["img","audio","video"]},{domains:["backend.failureunit.tv"],dev_domains:["abc.localhost:3000"],types:["connect"]},{domains:["i.ytimg.com","img.youtube.com"],dev_domains:[],types:["img"]},{domains:["www.youtube.com"],dev_domains:[],types:["frame"]}],db_name:"FailureUnitTV",site_name:"FU TV",branding_images:"custom_branding",disable_devvit:!0},Pr=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.hostname==="0.0.0.0",Dt=Pr?"development":"production",Ue=At[Dt].API_BASE_URL,oi=At[Dt].SUGGESTIONS_LIST_PATH,$r=At[Dt].SUGGESTIONS_SUBMISSIONS_PATH,ii=At[Dt].TUBE_STREAMS_PATH,zr=At[Dt].CUSTOM_APPS_PATH,_n=At[Dt].DEFAULT_FILES_PATH;class Nr{constructor(n="NostalgiaOS",t=1){this.dbName=n,this.version=t,this.db=null,this.cache=new Map,this.initPromise=this.init()}async init(){return new Promise((n,t)=>{const i=indexedDB.open(this.dbName,this.version);i.onerror=()=>{console.error("IndexedDB error:",i.error),t(i.error)},i.onsuccess=async()=>{this.db=i.result,await this.populateCache(),n(this.db)},i.onupgradeneeded=o=>{const r=o.target.result;r.objectStoreNames.contains("storage")||r.createObjectStore("storage",{keyPath:"key"})}})}async populateCache(){try{if(!this.db)return;const t=this.db.transaction(["storage"],"readonly").objectStore("storage");return new Promise((i,o)=>{const r=t.getAll();r.onsuccess=()=>{r.result.forEach(s=>{this.cache.set(s.key,s.value)}),i()},r.onerror=()=>{console.warn("Failed to populate cache:",r.error),o(r.error)}})}catch(n){console.warn("Failed to populate cache:",n)}}async ensureDB(){return this.db||await this.initPromise,this.db}async setItem(n,t){const r=(await this.ensureDB()).transaction(["storage"],"readwrite").objectStore("storage"),a={key:n,value:t,timestamp:Date.now()};return this.cache.set(n,t),new Promise((s,l)=>{const c=r.put(a);c.onsuccess=()=>s(),c.onerror=()=>l(c.error)})}async getItem(n){const o=(await this.ensureDB()).transaction(["storage"],"readonly").objectStore("storage");return new Promise((r,a)=>{const s=o.get(n);s.onsuccess=()=>{const l=s.result;let c=l?l.value:null;this.cache.set(n,c),r(c)},s.onerror=()=>a(s.error)})}async removeItem(n){const o=(await this.ensureDB()).transaction(["storage"],"readwrite").objectStore("storage");return this.cache.delete(n),new Promise((r,a)=>{const s=o.delete(n);s.onsuccess=()=>r(),s.onerror=()=>a(s.error)})}async clear(){const i=(await this.ensureDB()).transaction(["storage"],"readwrite").objectStore("storage");return this.cache.clear(),new Promise((o,r)=>{const a=i.clear();a.onsuccess=()=>o(),a.onerror=()=>r(a.error)})}async getAllKeys(){const i=(await this.ensureDB()).transaction(["storage"],"readonly").objectStore("storage");return new Promise((o,r)=>{const a=i.getAllKeys();a.onsuccess=()=>o(a.result),a.onerror=()=>r(a.error)})}setItemSync(n,t){this.cache.set(n,t),this.setItemWithRetry(n,t,3).catch(i=>{console.warn("Failed to save to IndexedDB after retries:",i)})}async setItemWithRetry(n,t,i=3){let o;for(let r=0;r<i;r++)try{await this.setItem(n,t);return}catch(a){o=a,console.warn(`setItem retry ${r+1}/${i} failed:`,a),r<i-1&&await new Promise(s=>setTimeout(s,Math.pow(2,r)*100))}throw o}getItemSync(n){return this.cache.has(n)?this.cache.get(n):(this.getItem(n).catch(console.warn),null)}removeItemSync(n){this.cache.delete(n),this.removeItem(n).catch(console.error)}clearSync(){this.cache.clear(),this.clear().catch(console.error)}}const $e=new Nr,z={async ensureReady(){return await $e.ensureDB(),$e.cache.size===0&&await $e.populateCache(),$e.db},async setItem(e,n){return await $e.setItem(e,n)},async getItem(e){return await $e.getItem(e)},async removeItem(e){return await $e.removeItem(e)},async clear(){return await $e.clear()},async getAllKeys(){return await $e.getAllKeys()},async preloadKeys(e){for(const n of e)try{await this.getItem(n)}catch(t){console.warn(`Failed to preload key ${n}:`,t)}},setItemSync(e,n){return $e.setItemSync(e,n)},getItemSync(e){return $e.getItemSync(e)},removeItemSync(e){return $e.removeItemSync(e)},clearSync(){return $e.clearSync()}};typeof window<"u"&&(window.globalStorage=z,window.storage=z);let ot={folders:{"C://":{Documents:{id:"Documents",name:"Documents",type:"folder",fullPath:"C://Documents",contents:{}},Desktop:{id:"Desktop",name:"Desktop",type:"folder",fullPath:"C://Desktop",contents:{compostbin:{id:"compostbin",name:"Compost Bin",type:"app",fullPath:"C://Desktop/compostbin",content_type:"html",contents:{},icon:"./image/compost-bin.webp"}}},Media:{id:"Media",name:"Media",type:"folder",fullPath:"C://Media",contents:{}}},"A://":{"folder-34862398":{id:"folder-34862398",name:"example folder",type:"folder",fullPath:"A://folder-34862398",contents:{}}},"D://":{}}},J={},fe={},Oe={},be={clockSeconds:!1,bgColor:"#20b1b1",bgImage:""},xt,ri={},Se=100,kt=null,Ce={deletedSlugs:[],movedSlugs:{}};function ai(e){xt=e,typeof window<"u"&&(window.startMenuOrder=e)}function Rt(e){Se=e,typeof window<"u"&&(window.highestZ=e)}function si(e){kt=e,typeof window<"u"&&(window.activeMediaWindow=e)}function Or(e){Object.assign(J,e),typeof window<"u"&&(window.windowStates=J)}function Wr(e){Object.assign(fe,e),typeof window<"u"&&(window.desktopIconsState=fe)}function li(e){Object.assign(be,e),typeof window<"u"&&(window.desktopSettings=be)}function Rr(){Object.keys(J).forEach(e=>delete J[e]),typeof window<"u"&&(window.windowStates=J)}function _r(){Object.keys(fe).forEach(e=>delete fe[e]),typeof window<"u"&&(window.desktopIconsState=fe)}function Ne(){return ot}function xe(e){ot=e,typeof window<"u"&&(window.fileSystemState=e)}typeof window<"u"&&(window.fileSystemState=ot,window.windowStates=J,window.desktopIconsState=fe,window.navWindows=Oe,window.desktopSettings=be,window.fileFolderMapping=ri,window.highestZ=Se,window.activeMediaWindow=kt,window.getFileSystemState=Ne,window.setFileSystemState=xe);let oo=!1;typeof window<"u"&&(window.isInitializing=oo);function Fo(e){oo=e,typeof window<"u"&&(window.isInitializing=e)}async function Q(){if(oo)return;const e=typeof xt<"u"?xt:window.startMenuOrder||[],n=Object.fromEntries(Object.entries(J).filter(([i])=>!/^dialogWindow-/.test(i)&&!/^promptWindow-/.test(i))),t={fileSystemState:ot,windowStates:n,desktopIconsState:fe,desktopSettings:be,navWindows:Oe,startMenuOrder:e,apiOverrides:Ce};console.log("üíæ Saving state. apiOverrides:",JSON.stringify(Ce));try{await z.setItem("appState",t);const i=Date.now(),o=await z.getItem("appState")}catch(i){console.warn("Failed to save state to IndexedDB:",i),z.setItemSync("appState",t)}}typeof window<"u"&&(window.saveState=Q);typeof window<"u"&&(window.addEventListener("beforeunload",async e=>{try{const n=typeof xt<"u"?xt:window.startMenuOrder||[],t={fileSystemState:ot,windowStates:J,desktopIconsState:fe,desktopSettings:be,navWindows:Oe,startMenuOrder:n,apiOverrides:Ce};z.setItemSync("appState",t)}catch(n){console.error("Failed to save state during page unload:",n)}}),setInterval(async()=>{try{await Q()}catch(e){console.error("Failed to save periodic backup:",e)}},3e4));function it(e,n){J[e]&&(J[e].content=n,Q())}async function ci(e,n,t,i,o=null,r=!1){const a=await Ne();if(!a||!a.folders){console.error("File system not initialized, creating basic structure");const g={folders:{"C://":{Documents:{id:"Documents",name:"Documents",type:"folder",fullPath:"C://Documents",contents:{}},Desktop:{id:"Desktop",name:"Desktop",type:"folder",fullPath:"C://Desktop",contents:{}},Media:{id:"Media",name:"Media",type:"folder",fullPath:"C://Media",contents:{}}},"A://":{},"D://":{}}};xe(g),a=g}const s=t.match(/^([A-Z]:\/\/)/);if(!s)return console.error("Invalid path format:",t),null;const l=s[1],c=t.replace(/^[A-Z]:\/\//,"").split("/").filter(g=>g);a.folders[l]||(console.error("Drive does not exist:",l),a.folders[l]={});let d=a.folders[l];if(c.length===0)d=a.folders[l];else if(d=a.folders[t],!d)return console.error("Target folder not found in unified structure:",t),console.error("Available folders:",Object.keys(a.folders)),null;const p=c.length===0;let m="image/file.webp";["png","jpg","jpeg","gif"].includes(i)?m="image/image.webp":["mp4","webm"].includes(i)?m="image/video.webp":["mp3","wav","audio"].includes(i)?m="image/audio.webp":i==="html"?m="image/html.webp":["md","txt"].includes(i)&&(m="image/doc.webp");const u=`file-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,f={id:u,name:e,type:"ugc-file",fullPath:p?`${t}${e}`:`${t}/${e}`,content_type:i,icon:m,contents:n||"",file:o||null};if(o&&["png","jpg","jpeg","gif","webp","avif","mp3","wav","ogg","mp4","webm","avi","mov"].includes(i)){f.isLargeFile=!0,f.storageLocation="indexeddb";const g=URL.createObjectURL(o);f.tempObjectURL=g;const w=new FileReader;w.onload=async function(b){const C=b.target.result,h=C.length*.75/(1024*1024);try{await z.setItem(`file_data_${u}`,C);const j=await Ne();let A;p?A=j.folders[l][u]:A=j.folders[t][u],A?(A.isLargeFile=!0,A.storageLocation="indexeddb",A.dataURL=C):(console.error("üéµ ADDFILE: File entry not found after creation:",u),console.error("üéµ ADDFILE: Looking in:",p?l:t),console.error("üéµ ADDFILE: Available keys:",Object.keys(p?j.folders[l]||{}:j.folders[t]||{})))}catch(j){console.error("Failed to store file in IndexedDB:",j);const A=await Ne();let M;p?M=A.folders[l][u]:M=A.folders[t][u],M&&(M.isLargeFile=!0,M.storageLocation="failed"),typeof showDialogBox=="function"&&showDialogBox(`File "${e}" could not be stored (${h.toFixed(2)}MB). Storage error: ${j.message}`,"error")}const _=await Ne();let N;p?N=_.folders[l][u]:N=_.folders[t][u],N?N.file=null:console.error("üéµ ADDFILE: Could not find file entry to remove File object:",u),xe(_);try{await Q()}catch(j){console.error("Failed to save state after file storage:",j)}t==="C://Desktop"&&typeof renderDesktopIcons=="function"?renderDesktopIcons():typeof refreshAllExplorerWindows=="function"&&refreshAllExplorerWindows(t)},w.readAsDataURL(o)}if(d[u]=f,xe(a),!r&&(!o||!["png","jpg","jpeg","gif","webp","avif","mp3","wav","ogg","mp4","webm","avi","mov"].includes(i)))try{await Q()}catch(g){console.error("Failed to save state after non-binary file:",g)}return t==="C://Desktop"?typeof renderDesktopIcons=="function"?renderDesktopIcons():typeof window.renderDesktopIcons=="function"?window.renderDesktopIcons():console.warn("renderDesktopIcons function not found"):typeof refreshAllExplorerWindows=="function"?refreshAllExplorerWindows(t):typeof window.refreshAllExplorerWindows=="function"?window.refreshAllExplorerWindows(t):console.warn("refreshAllExplorerWindows function not found"),t==="C://Media"&&["mp3","wav","ogg","audio","mp4","webm","avi","mov"].includes(i)&&typeof window.refreshMediaPlayerPlaylist=="function"&&setTimeout(()=>{window.refreshMediaPlayerPlaylist()},100),f}typeof window<"u"&&(window.globalAddFileToFileSystem=ci);function Po(e){if(e.folders||(e.folders={}),e.folders["C://"]&&typeof e.folders["C://"]=="object"){const i=e.folders["C://"];for(const[o,r]of Object.entries(i))if(r&&typeof r=="object"&&r.type==="folder"){const a=`C://${r.name||o}`;e.folders[a]||(e.folders[a]=r.contents||{},r.contents&&Object.values(r.contents).forEach(s=>{s.type==="folder"&&s.fullPath&&t(s.fullPath,s,e)}))}}const n=[{path:"C://Desktop",name:"Desktop"},{path:"C://Documents",name:"Documents"},{path:"C://Media",name:"Media"}];e.folders["C://"]||(e.folders["C://"]={});for(const i of n)e.folders[i.path]||(e.folders[i.path]={}),e.folders["C://"][i.name]||(e.folders["C://"][i.name]={id:i.name,name:i.name,type:"folder",fullPath:i.path,contents:{}});e.folders["C://Desktop"]&&!e.folders["C://Desktop"].compostbin&&(e.folders["C://Desktop"].compostbin={id:"compostbin",name:"Compost Bin",type:"app",fullPath:"C://Desktop/compostbin",content_type:"html",contents:{},icon:"./image/compost-bin.webp"});function t(i,o,r){o.contents&&Object.keys(o.contents).length>0&&(r.folders[i]||(r.folders[i]={}),Object.assign(r.folders[i],o.contents),Object.values(o.contents).forEach(a=>{a.type==="folder"&&a.fullPath&&t(a.fullPath,a,r)}))}return e}function Hr(e,n){n.folders||(n.folders={}),n.folders["C://"]||(n.folders["C://"]={});const t=e.map(o=>{const r={};if(Object.keys(o).forEach(a=>{a.toLowerCase()==="fullpath"?r.fullPath=o[a]:a.toLowerCase()==="parentpath"?r.parentPath=o[a]:a.toLowerCase()==="islargefile"?r.isLargeFile=o[a]:a.toLowerCase()==="content_type"?r.content_type=o[a]:a.toLowerCase()==="url"?r.url=o[a]:r[a]=o[a]}),!r.name&&r.fullPath){const a=r.fullPath.split("/").filter(s=>s);r.name=a[a.length-1]}return r.id||(r.id=r.name||`item-${Date.now()}-${Math.random().toString(36).substr(2,9)}`),o.slug&&(r.slug=o.slug),r});console.log("üîç Checking for moved items to cleanup. apiOverrides:",JSON.stringify(Ce)),t.forEach(o=>{if(o.slug&&Ce.movedSlugs[o.slug]){const r=Ce.movedSlugs[o.slug];console.log(`üßπ Cleanup: Item ${o.slug} is moved to ${r}. Scanning for ghosts...`);for(const a in n.folders){const s=n.folders[a];for(const l in s){const c=s[l];c&&c.slug===o.slug&&(c.fullPath!==r?(console.log(`üëª DESTROYING GHOST: ${o.slug} found at ${c.fullPath} (should be at ${r})`),delete s[l]):console.log(`‚úÖ Found valid instance of ${o.slug} at ${c.fullPath}`))}}}});const i=t.filter(o=>o.slug&&Ce.deletedSlugs.includes(o.slug)?(console.log(`Skipping deleted API item: ${o.slug}`),!1):o.slug&&Ce.movedSlugs[o.slug]?(console.log(`üö´ Skipping moved API item (relying on local state): ${o.slug}`),!1):!0);i.forEach(o=>{o.type==="folder"&&(n.folders[o.fullPath]||(n.folders[o.fullPath]={}))}),i.forEach(o=>{const r=o.parentPath;if(!r)return;if(r==="C://Desktop/compostbin"&&n.folders["C://Desktop"]&&n.folders["C://Desktop"].compostbin){n.folders["C://Desktop"].compostbin.contents||(n.folders["C://Desktop"].compostbin.contents={}),n.folders["C://Desktop"].compostbin.contents[o.id]=s;return}n.folders[r]||(n.folders[r]={});const a=n.folders[r],s={...o};o.type==="folder"&&(s.contents={}),a[o.id]=s})}function $o(e){if(!e||!e.folders)return e;console.log("üîß Running file system repair...");let n=0;return Object.keys(e.folders).forEach(t=>{const i=e.folders[t];if(i){if(Object.prototype.hasOwnProperty.call(i,"undefined")){console.log(`Repairing 'undefined' key in ${t}`);const o=i.undefined;let r=o.name||`repaired-${Date.now()}-${Math.random().toString(36).substr(2,5)}`;i[r]&&(r=`${r}-${Math.random().toString(36).substr(2,5)}`),o.id=r,o.name||(o.name=r),i[r]=o,delete i.undefined,n++}Object.keys(i).forEach(o=>{const r=i[o];if(r&&typeof r=="object"){let a=!1;(!r.id||r.id==="undefined")&&(r.id=o!=="undefined"?o:r.name||`repaired-${Date.now()}`,a=!0),r.name||(r.name=r.id,a=!0),a&&n++}})}}),n>0&&console.log(`‚úÖ Repaired ${n} items in file system`),e}typeof window<"u"&&(window.updateContent=it);function qr(e,n=[],t=[]){const i=document.createElement("div");return i.innerHTML=e,i.querySelectorAll("*").forEach(r=>{if(!n.includes(r.tagName.toLowerCase())){r.remove();return}[...r.attributes].forEach(s=>{t.includes(s.name.toLowerCase())||r.removeAttribute(s.name)})}),i.innerHTML}function io(e,n){const t=document.getElementById(e);if(t&&t.dataset.customAppIcon)return t.dataset.customAppIcon;const i={calculator:"image/calculator.webp",mediaplayer:"image/video.webp",bombbroomer:"image/bombbroomer.webp",solitaire:"image/solitaire.webp",pong:"image/pong.webp",snake:"image/snake.webp",happyturd:"image/happyturd.webp",chess:"image/guillotine_chess.webp",mailbox:"image/mail.webp",watercolour:"image/watercolour.webp",compostbin:"image/compost-bin.webp",storage:"image/drive_c.webp","explorer-window":"image/computer.webp",tubestream:"image/youtube.webp"},o={Settings:"image/gears.webp","Desktop Settings":"image/gears.webp","About This Computer":"image/info.webp","My Computer":"image/computer.webp","File Explorer":"image/computer.webp","Media Player":"image/video.webp",Calculator:"image/calculator.webp",Bombbroomer:"image/bombbroomer.webp",Solitaire:"image/solitaire.webp",Pong:"image/pong.webp",Snake:"image/snake.webp","Happy Turd":"image/happyturd.webp","Guillotine Chess":"image/guillotine_chess.webp",Chess:"image/guillotine_chess.webp","Mail Box":"image/mail.webp",Watercolour:"image/watercolour.webp","Compost Bin":"image/compost-bin.webp","Storage Manager":"image/drive_c.webp",TubeStream:"image/youtube.webp","Security Policy":"image/info.webp"};if(i[e])return i[e];if(o[n])return o[n];if(e&&e.includes("-")){const r=n.toLowerCase(),a=e.toLowerCase();if(r.match(/\.(jpg|jpeg|png|gif|webp|avif|bmp)$/i)||a.match(/\.(jpg|jpeg|png|gif|webp|avif|bmp)$/i))return"image/image.webp";if(r.match(/\.(mp4|webm|avi|mov|mkv)$/i)||a.match(/\.(mp4|webm|avi|mov|mkv)$/i))return"image/video.webp";if(r.match(/\.(mp3|wav|ogg|m4a|flac)$/i)||a.match(/\.(mp3|wav|ogg|m4a|flac)$/i))return"image/audio.webp";if(r.match(/\.(txt|md|doc|docx)$/i)||a.match(/\.(txt|md|doc|docx)$/i)||r.includes("letterpad"))return"image/file.webp";if(r.match(/\.(html|htm)$/i)||a.match(/\.(html|htm)$/i))return"image/html.webp"}return n.includes("LetterPad")||n.includes(".md")||n.includes(".txt")?"image/file.webp":n.includes(".jpg")||n.includes(".png")||n.includes(".gif")||n.includes(".webp")||n.includes(".jpeg")||n.includes(".bmp")||n.includes(".avif")?"image/image.webp":n.includes(".mp4")||n.includes(".webm")||n.includes(".avi")||n.includes(".mov")||n.includes(".mkv")?"image/video.webp":n.includes(".mp3")||n.includes(".wav")||n.includes(".ogg")||n.includes(".m4a")||n.includes(".flac")?"image/audio.webp":n.includes(".html")||n.includes(".htm")?"image/html.webp":null}function ro(e){if(!e)return;const n=J[e.id];if(n&&n.fullScreen)return;const t=window.innerWidth,i=window.innerHeight-48,o=e.getBoundingClientRect();let r=!1;o.width>t&&(e.style.width=Math.max(350,t-10)+"px",r=!0);const s=i-30-10;o.height>i&&(e.style.height=Math.max(200,s)+"px",r=!0),r&&n&&(n.dimensions={type:"integer",width:parseInt(e.style.width),height:parseInt(e.style.height)});let l=0,c=0;const d=document.getElementById("desktop-stage");if(d){const w=getComputedStyle(d).transform;if(w&&w!=="none"){const b=w.match(/matrix\(([^)]+)\)/);if(b){const C=b[1].split(",").map(h=>parseFloat(h.trim()));C.length===6&&(l=C[4],c=C[5])}}}const p=parseInt(e.style.left,10)||0,m=parseInt(e.style.top,10)||0;let u=p,f=m;p+o.width<-l+50&&(u=-l+20,r=!0),p>-l+t-50&&(u=-l+t-o.width-20,r=!0),m<-c&&(f=-c,r=!0);const g=-c+i-30;f>g&&(f=g,r=!0),e.style.left=u+"px",e.style.top=f+"px",r&&n&&(n.position={left:e.style.left,top:e.style.top},Q())}let Hn=null;typeof window<"u"&&window.addEventListener("resize",()=>{Hn&&cancelAnimationFrame(Hn),Hn=requestAnimationFrame(()=>{document.querySelectorAll("#windows-container > div").forEach(e=>ro(e))})});let oe=null;function di(){if(!(window.innerWidth<=768))return;const n=document.getElementById("desktop-stage");n&&(oe={stage:n,vertical:null,horizontal:null,isDragging:!1,dragStart:{x:0,y:0},scrollStart:{x:0,y:0}},jr(),Ur(),n.addEventListener("scroll",qn,{passive:!0}),window.addEventListener("resize",()=>{zo(),qn()}),zo(),qn())}function jr(){const{stage:e}=oe,n=document.createElement("div");n.id="custom-scrollbar-vertical",n.className="custom-scrollbar-track custom-scrollbar-vertical",n.style.opacity="0";const t=document.createElement("div");t.className="custom-scrollbar-button custom-scrollbar-up",t.innerHTML='<svg width="10" height="10" viewBox="0 0 10 10"><path d="M5 2 L9 8 L1 8 Z" fill="black"/></svg>',n.appendChild(t);const i=document.createElement("div");i.className="custom-scrollbar-track-area";const o=document.createElement("div");o.className="custom-scrollbar-thumb",i.appendChild(o),n.appendChild(i);const r=document.createElement("div");r.className="custom-scrollbar-button custom-scrollbar-down",r.innerHTML='<svg width="10" height="10" viewBox="0 0 10 10"><path d="M5 8 L9 2 L1 2 Z" fill="black"/></svg>',n.appendChild(r),document.body.appendChild(n),oe.vertical={track:n,trackArea:i,thumb:o,upBtn:t,downBtn:r},Yr()}function Ur(){const{stage:e}=oe,n=document.createElement("div");n.id="custom-scrollbar-horizontal",n.className="custom-scrollbar-track custom-scrollbar-horizontal",n.style.opacity="0";const t=document.createElement("div");t.className="custom-scrollbar-button custom-scrollbar-left",t.innerHTML='<svg width="10" height="10" viewBox="0 0 10 10"><path d="M2 5 L8 9 L8 1 Z" fill="black"/></svg>',n.appendChild(t);const i=document.createElement("div");i.className="custom-scrollbar-track-area";const o=document.createElement("div");o.className="custom-scrollbar-thumb",i.appendChild(o),n.appendChild(i);const r=document.createElement("div");r.className="custom-scrollbar-button custom-scrollbar-right",r.innerHTML='<svg width="10" height="10" viewBox="0 0 10 10"><path d="M8 5 L2 9 L2 1 Z" fill="black"/></svg>',n.appendChild(r),document.body.appendChild(n),oe.horizontal={track:n,trackArea:i,thumb:o,leftBtn:t,rightBtn:r},Gr()}function Yr(){const{stage:e,vertical:n}=oe,{thumb:t,upBtn:i,downBtn:o,trackArea:r}=n;t.addEventListener("pointerdown",l=>{l.preventDefault(),oe.isDragging=!0,oe.dragStart.y=l.clientY,oe.scrollStart.y=e.scrollTop,document.body.style.userSelect="none",t.style.cursor="grabbing"});let a;i.addEventListener("pointerdown",l=>{l.preventDefault(),e.scrollTop-=40,a=setInterval(()=>{e.scrollTop-=40},100)}),i.addEventListener("pointerup",()=>clearInterval(a)),i.addEventListener("pointerleave",()=>clearInterval(a));let s;o.addEventListener("pointerdown",l=>{l.preventDefault(),e.scrollTop+=40,s=setInterval(()=>{e.scrollTop+=40},100)}),o.addEventListener("pointerup",()=>clearInterval(s)),o.addEventListener("pointerleave",()=>clearInterval(s)),r.addEventListener("pointerdown",l=>{if(l.target===t)return;l.preventDefault();const c=r.getBoundingClientRect(),d=l.clientY-c.top,m=t.getBoundingClientRect().top-c.top;d<m?e.scrollTop-=e.clientHeight*.9:e.scrollTop+=e.clientHeight*.9})}function Gr(){const{stage:e,horizontal:n}=oe,{thumb:t,leftBtn:i,rightBtn:o,trackArea:r}=n;t.addEventListener("pointerdown",l=>{l.preventDefault(),oe.isDragging=!0,oe.dragStart.x=l.clientX,oe.scrollStart.x=e.scrollLeft,document.body.style.userSelect="none",t.style.cursor="grabbing"});let a;i.addEventListener("pointerdown",l=>{l.preventDefault(),e.scrollLeft-=40,a=setInterval(()=>{e.scrollLeft-=40},100)}),i.addEventListener("pointerup",()=>clearInterval(a)),i.addEventListener("pointerleave",()=>clearInterval(a));let s;o.addEventListener("pointerdown",l=>{l.preventDefault(),e.scrollLeft+=40,s=setInterval(()=>{e.scrollLeft+=40},100)}),o.addEventListener("pointerup",()=>clearInterval(s)),o.addEventListener("pointerleave",()=>clearInterval(s)),r.addEventListener("pointerdown",l=>{if(l.target===t)return;l.preventDefault();const c=r.getBoundingClientRect(),d=l.clientX-c.left,m=t.getBoundingClientRect().left-c.left;d<m?e.scrollLeft-=e.clientWidth*.9:e.scrollLeft+=e.clientWidth*.9})}document.addEventListener("pointermove",e=>{if(!oe||!oe.isDragging)return;const{stage:n,vertical:t,horizontal:i,dragStart:o,scrollStart:r}=oe;if(t&&Math.abs(e.clientY-o.y)>Math.abs(e.clientX-o.x)){const{trackArea:a}=t,s=a.getBoundingClientRect(),l=e.clientY-o.y,c=n.scrollHeight/s.height;n.scrollTop=r.y+l*c}else if(i&&Math.abs(e.clientX-o.x)>Math.abs(e.clientY-o.y)){const{trackArea:a}=i,s=a.getBoundingClientRect(),l=e.clientX-o.x,c=n.scrollWidth/s.width;n.scrollLeft=r.x+l*c}});document.addEventListener("pointerup",()=>{oe&&oe.isDragging&&(oe.isDragging=!1,document.body.style.userSelect="",oe.vertical&&(oe.vertical.thumb.style.cursor="grab"),oe.horizontal&&(oe.horizontal.thumb.style.cursor="grab"))});function zo(){if(!oe)return;const{stage:e,vertical:n,horizontal:t}=oe;if(n){const{track:i,trackArea:o,thumb:r}=n,a=e.scrollHeight>e.clientHeight;if(i.style.display=a?"flex":"none",a){const s=Math.max(40,e.clientHeight/e.scrollHeight*o.clientHeight);r.style.height=s+"px"}}if(t){const{track:i,trackArea:o,thumb:r}=t,a=e.scrollWidth>e.clientWidth;if(i.style.display=a?"flex":"none",a){const s=Math.max(40,e.clientWidth/e.scrollWidth*o.clientWidth);r.style.width=s+"px"}}}function qn(){if(!oe)return;const{stage:e,vertical:n,horizontal:t}=oe;if(n&&n.track.style.display!=="none"){const{trackArea:i,thumb:o}=n,r=e.scrollTop/(e.scrollHeight-e.clientHeight),a=i.clientHeight-o.clientHeight,s=r*a;o.style.transform=`translateY(${s}px)`}if(t&&t.track.style.display!=="none"){const{trackArea:i,thumb:o}=t,r=e.scrollLeft/(e.scrollWidth-e.clientWidth),a=i.clientWidth-o.clientWidth,s=r*a;o.style.transform=`translateX(${s}px)`}}function ze(){oe&&(oe.vertical&&(oe.vertical.track.style.transition="opacity 0.3s ease",oe.vertical.track.style.opacity="1"),oe.horizontal&&(oe.horizontal.track.style.transition="opacity 0.3s ease",oe.horizontal.track.style.opacity="1"))}function ft(){oe&&(oe.vertical&&(oe.vertical.track.style.transition="opacity 0.3s ease",oe.vertical.track.style.opacity="0"),oe.horizontal&&(oe.horizontal.track.style.transition="opacity 0.3s ease",oe.horizontal.track.style.opacity="0"))}typeof window<"u"&&(window.initializeCustomScrollbars=di,window.showCustomScrollbars=ze,window.hideCustomScrollbars=ft);function ui(e){const n=e.querySelector(".cursor-move");n&&n.addEventListener("mousedown",function(t){t.preventDefault();const i=e.getBoundingClientRect(),o=t.clientX-i.left,r=t.clientY-i.top;let a=0,s=0;const l=document.getElementById("desktop-stage");if(l){const p=getComputedStyle(l).transform;if(p&&p!=="none"){const m=p.match(/matrix\(([^)]+)\)/);if(m&&m[1]){const u=m[1].split(",").map(f=>parseFloat(f.trim()));u.length===6&&(a=u[4],s=u[5])}}}function c(p){let m=p.clientX-o-a,u=p.clientY-r-s;const f=window.innerHeight-48,g=-s+f-30;u<-s&&(u=-s),u>g&&(u=g),e.style.left=m+"px",e.style.top=u+"px"}function d(){document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",d),J[e.id]&&(J[e.id].position={left:e.style.left,top:e.style.top},Q())}document.addEventListener("mousemove",c),document.addEventListener("mouseup",d),ke(e)})}function pi(e){const n=document.createElement("div");n.className="absolute bottom-0 right-0 w-6 h-6 cursor-se-resize",n.style.background="rgba(0,0,0,0.2)",n.style.zIndex="1100",n.style.pointerEvents="auto",n.style.borderTop="1px solid rgba(255,255,255,0.2)",n.style.borderLeft="1px solid rgba(255,255,255,0.05)",e.appendChild(n),n.addEventListener("mousedown",function(t){t.preventDefault(),t.stopPropagation();const i=t.clientX,o=t.clientY,r=parseInt(document.defaultView.getComputedStyle(e).width,10),a=parseInt(document.defaultView.getComputedStyle(e).height,10);function s(c){const d=Math.max(r+c.clientX-i,350),p=Math.max(a+c.clientY-o,200);e.style.width=d+"px",e.style.height=p+"px"}function l(){document.documentElement.removeEventListener("mousemove",s,!1),document.documentElement.removeEventListener("mouseup",l,!1),J[e.id].dimensions={type:"integer",width:parseInt(e.style.width),height:parseInt(e.style.height)},Q()}document.documentElement.addEventListener("mousemove",s,!1),document.documentElement.addEventListener("mouseup",l,!1)})}function Je(e){const n=document.getElementById(e);if(n){const t=J[e]&&J[e].fullScreen;n.style.display="none",n.setAttribute("aria-hidden","true"),J[e]&&(J[e].isMinimized=!0,Q());const i=document.getElementById("tab-"+e);if(i&&(i.classList.remove("bg-gray-50"),i.setAttribute("aria-pressed","false")),t&&!Object.values(J).some(r=>r.fullScreen&&!r.isMinimized)){typeof ze=="function"&&ze();const r=document.getElementById("desktop-stage");r&&(r.style.overflow="scroll")}}}function ke(e){let n=!1;try{const r=document.getElementById("windows-container");if(r){let a=Se;const s=r.children;for(let l=0;l<s.length;l++){const c=parseInt(getComputedStyle(s[l]).zIndex)||0;c>a&&(a=c)}a>Se&&Rt(a)}}catch{}const t=J[e.id]&&J[e.id].fullScreen,i=Object.keys(J).filter(r=>J[r].fullScreen).map(r=>document.getElementById(r)).filter(r=>r);if(e.style.display==="none"){e.style.display="block",e.setAttribute("aria-hidden","false"),J[e.id]&&(J[e.id].isMinimized=!1,n=!0);const r=document.getElementById("tab-"+e.id);if(r&&r.setAttribute("aria-pressed","true"),t){typeof ft=="function"&&ft();const a=document.getElementById("desktop-stage");a&&(a.style.overflow="hidden")}if(!t&&i.length>0){i.forEach(s=>{s.id!==e.id&&Je(s.id)}),typeof ze=="function"&&ze();const a=document.getElementById("desktop-stage");a&&(a.style.overflow="scroll")}}t&&i.forEach(r=>{if(J[r.id]&&J[r.id].fullScreen){const a=document.getElementById("desktop-stage"),s=a?a.scrollLeft:0,l=a?a.scrollTop:0;r.style.left=s+"px",r.style.top=l+"px"}}),Rt(Se+1),e.style.zIndex=Se,J[e.id]&&(J[e.id].zIndex=Se,n=!0),n&&Q(),document.querySelectorAll("#window-tabs > div").forEach(r=>r.classList.remove("bg-gray-50"));const o=document.getElementById("tab-"+e.id);o&&o.classList.add("bg-gray-50"),e.querySelector("video, audio")&&(si(e.id),typeof updateMediaControl=="function"&&updateMediaControl())}function le(e){const n=J[e]&&J[e].fullScreen,t=document.getElementById(e);t&&t.remove();const i=document.getElementById("tab-"+e);i&&i.remove(),kt===e&&(si(null),typeof updateMediaControl=="function"&&updateMediaControl()),delete J[e];for(const o in Oe)if(Oe[o]===e){delete Oe[o];break}if(n&&!Object.values(J).some(r=>r.fullScreen&&!r.isMinimized)){typeof ze=="function"&&ze();const r=document.getElementById("desktop-stage");r&&(r.style.overflow="scroll")}Q()}function Et(e){const n=document.getElementById(e);if(!n)return;let t=J[e];const i=document.getElementById("desktop-stage"),o=i?i.scrollLeft:0,r=i?i.scrollTop:0;t.fullScreen?(t.originalDimensions&&t.originalPosition?(n.style.left=t.originalPosition.left,n.style.top=t.originalPosition.top,n.style.width=t.originalDimensions.width+"px",n.style.height=t.originalDimensions.height+"px",t.dimensions=t.originalDimensions):(n.style.left="15%",n.style.top="15%",n.style.width="70vw",n.style.height="70vh",t.dimensions={type:"integer",width:window.innerWidth*.7,height:window.innerHeight*.7}),t.fullScreen=!1,ui(n),pi(n),setTimeout(()=>ro(n),0),Object.values(J).some(s=>s.fullScreen)||(typeof ze=="function"&&ze(),i&&(i.style.overflow="scroll"))):(t.originalDimensions=t.dimensions,t.originalPosition=t.position,n.style.left=o+"px",n.style.top=r+"px",n.style.width="100vw",n.style.height="calc(100vh - 48px)",n.style.maxWidth="none",n.style.maxHeight="none",t.dimensions={type:"viewport"},t.fullScreen=!0,typeof ft=="function"&&ft(),i&&(i.style.overflow="hidden")),Q()}if(typeof window<"u"){const e=document.getElementById("desktop-stage");e&&e.addEventListener("scroll",()=>{Object.values(J).forEach(n=>{if(n.fullScreen){const t=document.getElementById(n.id);t&&(t.style.left=e.scrollLeft+"px",t.style.top=e.scrollTop+"px")}})},{passive:!0})}function No(){var t;const e=Array.from(document.querySelectorAll("#windows-container > div")).filter(i=>i.style.display!=="none"&&i.id!=="taskbar");if(e.length===0)return;e.sort((i,o)=>{const r=parseInt(i.style.zIndex)||0;return(parseInt(o.style.zIndex)||0)-r});const n=e[0];if(n){le(n.id);const i=((t=n.querySelector(".window-title"))==null?void 0:t.textContent)||"Unknown Window";let o=document.getElementById("window-cycle-announce");o||(o=document.createElement("div"),o.id="window-cycle-announce",o.className="sr-only",o.setAttribute("aria-live","polite"),o.setAttribute("aria-atomic","true"),document.body.appendChild(o)),o.textContent=`Closed ${i}`}}function Kr(){var t;const e=Array.from(document.querySelectorAll("#windows-container > div")).filter(i=>i.style.display!=="none"&&i.id!=="taskbar");if(e.length===0)return;e.sort((i,o)=>{const r=parseInt(i.style.zIndex)||0;return(parseInt(o.style.zIndex)||0)-r});const n=e[0];if(n){Je(n.id);const i=((t=n.querySelector(".window-title"))==null?void 0:t.textContent)||"Unknown Window";let o=document.getElementById("window-cycle-announce");o||(o=document.createElement("div"),o.id="window-cycle-announce",o.className="sr-only",o.setAttribute("aria-live","polite"),o.setAttribute("aria-atomic","true"),document.body.appendChild(o)),o.textContent=`Minimized ${i}`}}function Xr(e,n,t){const i=document.getElementById("context-menu");i.replaceChildren(),i.style.zIndex=Math.max((Se||1e3)+100,1e4);const o=(p,m,u)=>{const f=document.createElement("div");return f.className="px-4 py-2 hover:bg-gray-50 cursor-pointer",f.textContent=p,u&&f.addEventListener("click",u),i.appendChild(f),f},r=t.style.display==="none",a=J[n]&&J[n].fullScreen;r?o("Restore",!1,()=>{ke(t),typeof hideContextMenu=="function"&&hideContextMenu()}):o("Minimize",!1,()=>{Je(n),typeof hideContextMenu=="function"&&hideContextMenu()}),a||o("Maximize",!1,()=>{Et(n),typeof hideContextMenu=="function"&&hideContextMenu()}),o("Close",!1,()=>{le(n),typeof hideContextMenu=="function"&&hideContextMenu()}),i.classList.remove("hidden");const s=i.getBoundingClientRect(),l=48;let c=e.pageX;c+s.width>window.innerWidth&&(c=window.innerWidth-s.width-10);let d=window.innerHeight-l-s.height-5;i.style.left=c+"px",i.style.top=d+"px",setTimeout(()=>{typeof hideContextMenu=="function"&&document.addEventListener("click",hideContextMenu,{once:!0})},0)}let ut;async function Vr(){try{const e=await z.getItem("appState");if(e&&e.fileSystemState)return e.fileSystemState}catch(e){console.warn("Failed to get file system state from IndexedDB:",e);try{const n=z.getItemSync("appState");if(n&&n.fileSystemState)return n.fileSystemState}catch(n){console.warn("Failed to get file system state with fallback:",n)}}return ut}function se(){if(typeof window<"u"&&window.fileSystemState)return window.fileSystemState;if(typeof ut<"u")return ut;try{const e=z.getItemSync("appState");if(e&&e.fileSystemState){const n=e.fileSystemState;return["C://","C://Desktop","C://Documents"].forEach(t=>{n.folders&&n.folders[t]&&Object.keys(n.folders[t]).filter(r=>{const a=n.folders[t][r];return a&&a.type==="shortcut"}).length>0}),n}}catch(e){console.warn("Failed to get file system state sync:",e)}return typeof window<"u"&&window.fileSystemState?window.fileSystemState:typeof ut<"u"?ut:(console.error("No file system state available anywhere!"),{folders:{"C://":{},"A://":{},"D://":{}}})}function ao(e){e=normalizePath(e);const n=se();if(n.initialized!==!0&&Jr(),e.substring(1,4)==="://"&&e.length===4)return n.folders[e]||{};const t=n.folders[e]||{},i={};for(const[o,r]of Object.entries(t))o!=="contents"&&r&&typeof r=="object"&&r.type&&(i[o]=r);return i}const Zr={files:[]};function Jr(){try{const e=se();if(!e.folders||!e.folders["C://"]){console.warn("File system structure not properly initialized for sync document fetch");return}const n=Zr.files.map(i=>{const o=i.url.split(".").pop().toLowerCase();let r="image/file.webp";return["png","jpg","jpeg","gif"].includes(o)?r="image/image.webp":["mp4","webm"].includes(o)?r="image/video.webp":["mp3","wav"].includes(o)?r="image/audio.webp":o==="html"?r="image/html.webp":["md","txt"].includes(o)&&(r="image/doc.webp"),{id:i.id,name:i.url,type:"file",content:"",fullPath:`C://Documents/${i.id}`,content_type:o,icon_url:r,url:i.url}});e.folders["C://Documents"]||(e.folders["C://Documents"]={});const t={};n.forEach(i=>{t[i.id]=i}),e.folders["C://Documents"]={...e.folders["C://Documents"]||{},...t},e.initialized=!0;try{const i=z.getItemSync("appState")||{};i.fileSystemState=e,z.setItemSync("appState",i),ut=e,typeof window<"u"&&(window.fileSystemState=e)}catch(i){console.warn("Failed to save file system state sync:",i),ut=e,typeof window<"u"&&(window.fileSystemState=e)}}catch(e){console.error("Error loading documents sync:",e)}}document.addEventListener("dblclick",e=>{const n=e.target.closest("[data-open-file]");if(n){e.stopPropagation();const t=n.getAttribute("data-open-file");openFile(t,e)}});document.addEventListener("mobiledbltap",e=>{const n=e.target.closest("[data-open-file]");if(n){e.stopPropagation();const t=n.getAttribute("data-open-file");openFile(t,e)}});function sn(e){return/^[A-Z]:\/\/$/.test(e)?e:e.replace(/\/+$/,"")}function Qr(e){if(/^[A-Z]:\/\/$/.test(e))return e;const n=se();function t(i){for(const o in i){const r=i[o];if(r.type==="folder"){if(r.fullPath===e)return o;const a=n.folders[r.fullPath]||{},s=t(a);if(s)return s}}return null}for(const i in n.folders)if(/^[A-Z]:\/\/$/.test(i)){const o=t(n.folders[i]);if(o)return o}return null}function fi(e,n=null){e=sn(e);const t=n||se();if(/^[A-Z]:\/\/$/.test(e))return{id:e,name:e,fullPath:e,contents:t.folders[e]};function i(){for(const o in t.folders)if(/^[A-Z]:\/\/$/.test(o))for(const r in t.folders[o]){const a=t.folders[o][r];if(a.type==="folder"&&sn(a.fullPath)===e)return a}else for(const r in t.folders[o]){const a=t.folders[o][r];if(a.type==="folder"&&sn(a.fullPath)===e)return a}return null}return i()}function wn(e,n=!1){if(/^[A-Z]:\/\/$/.test(e))return e;const t=se();function i(o,r=null){for(const a in o){const s=o[a];if(s.type==="folder"||n===!0){if(a===e)return s.fullPath;if(s.type==="folder"&&s.fullPath&&t.folders[s.fullPath]){const l=i(t.folders[s.fullPath],s.fullPath);if(l)return l}}}return null}for(const o in t.folders)if(/^[A-Z]:\/\/$/.test(o)){const r=i(t.folders[o],o);if(r)return r}return null}function Kt(e,n=!1){let t;if(/^[A-Z]:\/\//.test(e)?t=e:t=wn(e),!t){console.error("Folder not found for id/path:",e);return}const i=st(t);if(!n){let a=document.getElementById("explorer-window");if(a)return a.querySelector(".file-explorer-window").outerHTML=i,a.querySelector(".file-explorer-window").setAttribute("data-current-path",t),it(a.id,i),setTimeout(Pe,100),setTimeout(async()=>{await St()},150),a}const o=n?`explorer-window-${Date.now()}`:"explorer-window",r=ae(t,i,!1,o,!1,!1,{type:"integer",width:600,height:400},"Explorer");return setTimeout(async()=>{await St()},150),r}function wt(e){const n=`openExplorer_${e}`,t=Date.now();if(window.explorerDebounce&&window.explorerDebounce[n]){const i=window.explorerDebounce[n];if(t-i<500)return}return window.explorerDebounce||(window.explorerDebounce={}),window.explorerDebounce[n]=t,setTimeout(()=>{window.explorerDebounce&&window.explorerDebounce[n]===t&&delete window.explorerDebounce[n]},1e3),Kt(e,!0)}window.openExplorerInNewWindow=wt;function at(){document.querySelectorAll(".file-explorer-window").forEach(e=>{const n=e.getAttribute("data-current-path"),t=st(n),i=e.parentElement;i.innerHTML=t}),Pe()}function mi(e){e=normalizePath(e);const n=e.match(/^([A-Z]:\/\/)(.*)/);if(!n)return e;const t=n[1],i=n[2];let o=`<span class="cursor-pointer hover:underline" data-path="${t}">${t}</span>`;if(!i)return o;let r=t;return i.split("/").filter(Boolean).forEach(a=>{r=r.endsWith("/")?r+a:`${r}/${a}`;const s=fi(r),l=s?s.name:a;o+=` / <span class="cursor-pointer hover:underline" data-path="${s?s.id:r}">${l}</span>`}),o}function st(e="C://"){e=normalizePath(e);const n=ao(e),t=['<ul class="pl-5">'];Object.values(n).forEach(r=>{const a=r.type==="folder";let s=a?"image/folder.webp":"image/file.webp";r.icon?s=r.icon:r.icon_url&&(s=r.icon_url);const l="cursor-pointer hover:bg-gray-50 file-item truncate"+(a?" folder-item":""),c=r.description?` (${r.description})`:"";if(a)t.push(`<li class="${l}" data-item-id="${r.id}" data-open-folder="${r.id}" title="${r.name}"><img src="${s}" class="inline h-4 w-4 mr-2" alt="${r.name} folder icon"> ${r.name}</li>`);else if(r.type==="shortcut")t.push(`<li class="${l}" data-item-id="${r.id}" data-open-shortcut="true" data-url="${r.url}" title="${r.name}${c}"><img src="${s}" class="inline h-4 w-4 mr-2" alt="${r.name} shortcut icon"> ${r.name}</li>`);else{const d=r.name||r.id||"Unknown File";r.name||console.warn("üîç EXPLORER: File missing name property, using fallback:",d,"Item:",r),t.push(`<li class="${l}" data-item-id="${r.id}" data-open-file="${r.id}" title="${d}${c}"><img src="${s}" class="inline h-4 w-4 mr-2" alt="${d} file icon"> ${d}</li>`)}}),t.push("</ul>");const i=["C://","A://","D://"].map(r=>`<li class="cursor-pointer border-b border-gray-200 hover:bg-gray-50 system-folder" data-open-drive="${r}"><img src="image/${r[0].toLowerCase()==="c"?"drive_c":r[0].toLowerCase()==="a"?"floppy":"cd"}.webp" class="inline h-4 w-4 mr-2" alt="${r} drive icon"> ${r}</li>`).join(""),o=mi(e);return`
    <div class="file-explorer-window" data-current-path="${e}">
      <div class="flex">
        <!-- Left Sidebar -->
        <div id="file-sidebar" class="w-1/4 border-r p-2"><ul>${i}</ul></div>

        <!-- Main Content -->
        <div id="file-main" class="w-3/4 p-2 min-h-96">
          <div id="breadcrumbs" class="mb-2">Path: ${o}</div>
          <div id="files-area">
            ${t.join("")}
          </div>
        </div>
      </div>
    </div>
  `}document.addEventListener("click",e=>{const n=e.target.closest(".file-explorer-window");if(n&&n.getAttribute("data-image-selection-mode")==="true"){const t=e.target.closest("[data-open-file]");if(t){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const i=n.getAttribute("data-current-path"),o=ao(i),r=Object.values(o).find(a=>a.id===t.dataset.openFile);if(r&&["png","jpg","jpeg","gif","webp","avif"].includes(r.content_type)){n.querySelectorAll("[data-open-file]").forEach(l=>{l.classList.remove("bg-blue-100","border-blue-300"),l.style.backgroundColor="",l.style.border=""}),t.classList.add("bg-blue-100","border-blue-300"),t.style.backgroundColor="#dbeafe",t.style.border="2px solid #93c5fd",t.style.borderRadius="4px";const s=document.getElementById("selected-image-name");if(s)if(s.textContent=`Selected: ${r.name}`,window.watercolourSelectedFile=r,typeof window.updateWatercolourImageSelectionButton=="function")window.updateWatercolourImageSelectionButton(!0);else{const l=document.getElementById("open-selected-image");l&&(l.disabled=!1)}else console.error("Selection UI elements not found",{selectedNameSpan:s})}else{const a=document.getElementById("selected-image-name");if(a)if(a.textContent="Please select an image file",typeof window.updateWatercolourImageSelectionButton=="function")window.updateWatercolourImageSelectionButton(!1);else{const s=document.getElementById("open-selected-image");s&&(s.disabled=!0)}}return}}},!0);document.addEventListener("dblclick",e=>{const n=e.target.closest("[data-open-folder],[data-open-file],[data-open-shortcut]");if(console.log("[FILE EXPLORER] Double-click detected, target li:",n),!n)return;const t=e.target.closest(".file-explorer-window");if(t&&t.getAttribute("data-image-selection-mode")==="true")return e.preventDefault(),e.stopPropagation(),!1;if(console.log("[FILE EXPLORER] Dataset:",n.dataset),n.dataset.openFolder)if(t){const i=n.dataset.openFolder;let o;if(/^[A-Z]:\/\//.test(i)?o=i:o=wn(i),o){const r=st(o);t.outerHTML=r;const a=t.closest(".window");a&&a.id&&it(a.id,r),setTimeout(Pe,100),setTimeout(async()=>{await St()},150)}}else Kt(n.dataset.openFolder);else n.dataset.openFile?_t(n.dataset.openFile,e):n.dataset.openShortcut&&ln(n)});document.addEventListener("click",e=>{const n=e.target.closest("[data-open-drive]");if(n){const t=n.closest(".file-explorer-window");if(t){const i=n.dataset.openDrive,o=st(i);t.outerHTML=o;const r=t.closest(".window");r&&r.id&&it(r.id,o),setTimeout(Pe,100),setTimeout(async()=>{await St()},150)}else Kt(n.dataset.openDrive)}});document.addEventListener("click",e=>{const n=e.target.closest("[data-path]");if(n){e.stopPropagation();const t=n.closest(".file-explorer-window");if(t){let i=n.dataset.path;if(i&&!/^[A-Z]:\/\//.test(i)){const a=wn(i);a&&(i=a)}const o=st(i);t.outerHTML=o;const r=t.closest(".window");r&&r.id&&it(r.id,o),setTimeout(Pe,100),setTimeout(async()=>{await St()},150)}else Kt(n.dataset.path)}});const jn=new Set;async function _t(e,n){if(console.log("[FILE EXPLORER] openFile called with:",e),jn.has(e)){console.log("[FILE EXPLORER] File already being opened, skipping");return}const t=document.getElementById("windows-container"),i=document.getElementById(e);if(i&&t&&t.contains(i)){console.log("[FILE EXPLORER] Window already exists, bringing to front"),ke(i);return}jn.add(e);try{let o;const r=n&&n.target===document.body,a=n&&n.target?n.target.closest(".file-explorer-window"):null;let s;r?s="C://Documents":a?s=a.getAttribute("data-current-path"):(n&&n.srcElement&&n.srcElement.classList.contains("desktop-folder-icon"),s="C://Desktop"),console.log("[FILE EXPLORER] Current path:",s);const l=ao(s);if(console.log("[FILE EXPLORER] Items in path:",Object.keys(l)),o=Object.values(l).find(u=>u.id===e),console.log("[FILE EXPLORER] Found file:",o),o||console.log("[FILE EXPLORER] File not found in current path"),!o||typeof o=="string"){const u=`File ${typeof o=="string"?`"${o}"`:""}`;ie(`${u}not found.`,"error");return}if(console.log("[FILE EXPLORER] File type:",o.type,"isCustomApp:",o.isCustomApp),o.type==="app"||o.isCustomApp){console.log("[FILE EXPLORER] Detected as app, launching via openApp:",o.id),typeof openApp=="function"?openApp(o.id):typeof window.openApp=="function"&&window.openApp(o.id);return}let c="",d="default";if(o.type==="ugc-file")if(o.content_type==="text"||o.content_type==="txt")c=`<div id="file-content" style="padding:10px;">
          <div id="text-editor" contenteditable="true" style="padding:10px; overflow:auto;" role="textbox" aria-label="Text file editor" title="Edit the contents of this text file">${o.content||o.contents||"Empty file"}</div>
        </div>`,d="editor",setTimeout(()=>{const u=document.getElementById("text-editor");u&&u.addEventListener("input",function(){it(o.id,this.innerHTML),o.content=this.innerHTML,Q()})},100);else if(o.content_type==="markdown"||o.content_type==="md"){const u=`letterpad_${o.id}`;let f=o.content||o.contents||"";try{const g=await z.getItem(u);g&&g.content!==void 0&&(f=g.content)}catch(g){console.warn("Error checking existing storage for markdown file:",g)}await z.setItem(u,{content:f}),c=`<div id="file-content" style="padding:10px;">
          <div class="letterpad_editor min-h-48 h-full w-full" data-letterpad-editor-id="${o.id}"></div>
        </div>`,d="editor",setTimeout(async()=>{const g=document.querySelector(`[data-letterpad-editor-id="${o.id}"]`);g&&typeof initializeLetterPad=="function"&&await initializeLetterPad(g)},100)}else o.content_type==="html"?c=o.content||o.contents||'<p style="padding:10px;">Empty HTML file.</p>':["png","jpg","jpeg","gif","webp","avif"].includes(o.content_type)?o.dataURL?c=`<img src="${o.dataURL}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:o.url?c=`<img src="${o.url}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:o.isLargeFile&&o.storageLocation==="indexeddb"?(c='<div style="padding:10px; text-align:center;">Loading image...</div>',d="image",setTimeout(async()=>{try{const u=await z.getItem(`file_data_${o.id}`);if(u){const f=`<img src="${u}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`,g=document.getElementById(o.id);if(g){const w=g.querySelector(".p-2");w&&(w.innerHTML=f)}}else throw console.error("No image data found in IndexedDB for file:",o.id),new Error("Image data not found in storage")}catch(u){console.error("Error loading large image file:",u),console.error("File object details:",o);const f=document.getElementById(o.id);if(f){const g=f.querySelector(".p-2");g&&(g.innerHTML=`<p style="padding:10px;">Error loading image: ${u.message}</p>`)}}},100)):o.file&&o.file instanceof File?c=`<img src="${URL.createObjectURL(o.file)}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:o.isDefault||o.isSystemFile||o.path?c=`<img src="${o.path||`media/${o.name}`}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:c=`<p style="padding:10px;">Image file not found or invalid.<br>Debug: isLargeFile=${o.isLargeFile}, storage=${o.storageLocation}</p>`:["mp3","wav","ogg"].includes(o.content_type)?o.dataURL?c=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
                <source src="${o.dataURL}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>`:o.url?c=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
                <source src="${o.url}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>`:o.isLargeFile&&o.storageLocation==="indexeddb"?(c='<div style="padding:10px; text-align:center;">Loading audio...</div>',d="audio",setTimeout(async()=>{try{const u=await z.getItem(`file_data_${o.id}`);if(u){const f=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
                  <source src="${u}" type="audio/mpeg">
                  Your browser does not support the audio element.
                </audio>`,g=document.getElementById(o.id);if(g){const w=g.querySelector(".p-2");w&&(w.innerHTML=f)}}else throw new Error("Audio data not found in IndexedDB")}catch(u){console.error("Error loading large audio file:",u);const f=document.getElementById(o.id);if(f){const g=f.querySelector(".p-2");g&&(g.innerHTML=`<p style="padding:10px;">Error loading audio: ${u.message}</p>`)}}},100)):o.file&&o.file instanceof File?c=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
                <source src="${URL.createObjectURL(o.file)}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>`:o.tempObjectURL?c=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;"
                       onerror="console.error('üîç AUDIO: Audio element error:', event.target.error)">
                <source src="${o.tempObjectURL}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>`:o.isDefault||o.isSystemFile||o.path?c=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
                <source src="${o.path||`media/${o.name}`}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>`:c='<p style="padding:10px;">Audio file not found or invalid.<br>Debug: Missing required properties for audio playback.</p>':["mp4","webm","avi","mov"].includes(o.content_type)?o.dataURL?c=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
              <source src="${o.dataURL}" type="video/mp4">
              Your browser does not support the video tag.
            </video>`:o.url?c=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
              <source src="${o.url}" type="video/mp4">
              Your browser does not support the video tag.
            </video>`:o.tempObjectURL?c=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;"
                       onerror="console.error('üîç VIDEO: Video element error:', event.target.error)">
              <source src="${o.tempObjectURL}" type="video/mp4">
              Your browser does not support the video tag.
            </video>`:o.isLargeFile&&o.storageLocation==="indexeddb"?(c='<div style="padding:10px; text-align:center;">Loading video...</div>',d="video",setTimeout(async()=>{try{const u=await z.getItem(`file_data_${o.id}`);if(u){const f=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
                  <source src="${u}" type="video/mp4">
                  Your browser does not support the video tag.
                </video>`,g=document.getElementById(o.id);if(g){const w=g.querySelector(".p-2");w&&(w.innerHTML=f)}}}catch(u){console.error("Error loading large video file:",u);const f=document.getElementById(o.id);if(f){const g=f.querySelector(".p-2");g&&(g.innerHTML=`<p style="padding:10px;">Error loading video: ${u.message}</p>`)}}},100)):o.file&&o.file instanceof File?c=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
              <source src="${URL.createObjectURL(o.file)}" type="video/mp4">
              Your browser does not support the video tag.
            </video>`:c='<p style="padding:10px;">Video file not found or invalid.</p>':c=`<p style="padding:10px;">${o.content||o.contents||"Empty file"}</p>`;else["image","jpg","jpeg","png","webp","avif","gif"].includes(o.content_type)?o.file?c=`<img src="${URL.createObjectURL(o.file)}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:c=`<img src="./media/${o.name}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:["video","mov","mp4","webm","avi"].includes(o.content_type)?c=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
              <source src="./media/${o.name}" type="video/mp4">
              Your browser does not support the video tag.
            </video>`:["audio","mp3","ogg","wav"].includes(o.content_type)?o.file?c=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
                <source src="${URL.createObjectURL(o.file)}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>`:o.isDefault||o.isSystemFile||o.path?c=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
                <source src="${o.path||`media/${o.name}`}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>`:c=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
                <source src="./media/${o.name}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>`:o.content_type==="html"?(c=o.contents?o.contents:'<p style="padding:10px;">Loading HTML file...</p>',o.contents||fetch(`./media/${o.name}`).then(u=>u.text()).then(u=>{const f=document.getElementById(o.id),g=f?f.querySelector(".p-2"):null;g&&(g.innerHTML=u),o.contents=u,Q()}).catch(u=>{console.error("Error loading HTML file:",u);const f=document.getElementById(o.id),g=f?f.querySelector(".p-2"):null;g&&(g.innerHTML="<p>Error loading HTML file.</p>")})):o.content_type==="text"||o.content_type==="txt"?(c='<div id="file-content" style="padding:10px;">Loading file...</div>',fetch(`./media/${o.name}`).then(u=>u.text()).then(u=>{const f=document.getElementById(o.id),g=f?f.querySelector(".p-2"):null;g&&(g.innerHTML=`<div id="text-editor" contenteditable="true" style="padding:10px; overflow:auto;" role="textbox" aria-label="Text file editor" title="Edit the contents of this text file">${u}</div>`,document.getElementById("text-editor").addEventListener("input",function(){it(o.id,this.innerHTML),o.type="ugc-file",o.content=this.innerHTML,Q()})),o.content=u,Q()}).catch(u=>{console.error("Error loading text file:",u);const f=document.getElementById(o.id),g=f?f.querySelector(".p-2"):null;g&&(g.innerHTML="<p>Error loading file.</p>")}),d="editor"):o.content_type==="markdown"||o.content_type==="md"?(c='<div id="file-content" style="padding:10px;">Loading file...</div>',fetch(`./media/${o.name}`).then(u=>u.text()).then(u=>{const f=document.getElementById(o.id),g=f?f.querySelector(".p-2"):null;g&&(g.innerHTML=`<div class="letterpad_editor min-h-48 h-full w-full" data-letterpad-editor-id="${o.id}"></div>`),Q()}).catch(u=>{console.error("Error loading markdown file:",u);const f=document.getElementById(o.id),g=f?f.querySelector(".p-2"):null;g&&(g.innerHTML="<p>Error loading file.</p>")}),d="editor"):c=`<p style="padding:10px;">Content of ${o.name}</p>`;let p=null;n&&n.target&&(p=n.target.closest("#windows-container > div"));let m=ae(o.name,c,!1,o.id,!1,!1,{type:"integer",width:420,height:350},d,p);if(o.content_type==="image"){let u=m.querySelector("img");u&&(u.onload=function(){let f=u.naturalWidth+20,g=u.naturalHeight+60;m.style.width=f+"px",m.style.height=g+"px",J[m.id].dimensions={type:"integer",width:f,height:g},Q()})}else if(o.content_type==="video"){let u=m.querySelector("video");u&&(u.onloadedmetadata=function(){let f=u.videoWidth+20,g=u.videoHeight+60;m.style.width=f+"px",m.style.height=g+"px",J[m.id].dimensions={type:"integer",width:f,height:g},Q()})}}finally{jn.delete(e)}}function ln(e){if(!e)return;const n=e.getAttribute("data-url");n&&window.open(n,"_blank")}function ea(e){if(!e||!window.watercolourImageSelectionCallback)return!1;if(!["png","jpg","jpeg","gif","webp","avif"].includes(e.content_type))return alert("Please select an image file (.png, .jpg, .jpeg, .gif, .webp)"),!1;let n=null;if(e.dataURL){n=e.dataURL;const t={name:e.name,path:en(),data:n,storageKey:e.storageLocation==="indexeddb"?`file_data_${e.id}`:null};return window.watercolourImageSelectionCallback(n,t),le("explorer-image-select"),window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null,!0}else{if(e.isLargeFile&&e.storageLocation==="indexeddb")return z.getItem(`file_data_${e.id}`).then(t=>{if(t){const i={name:e.name,path:en(),data:t,storageKey:`file_data_${e.id}`};window.watercolourImageSelectionCallback(t,i),le("explorer-image-select"),window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null}else alert("Could not load image data.")}).catch(t=>{console.error("Error loading image:",t),alert("Error loading image: "+t.message)}),!0;if(e.file&&e.file instanceof File){const t=new FileReader;return t.onload=i=>{const o={name:e.name,path:en(),data:i.target.result,storageKey:null};window.watercolourImageSelectionCallback(i.target.result,o),le("explorer-image-select"),window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null},t.readAsDataURL(e.file),!0}else{let t=e.path;t||(t=`./media/${e.name}`);const i={name:e.name,path:en(),data:t,storageKey:null};return window.watercolourImageSelectionCallback(t,i),le("explorer-image-select"),window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null,!0}}}function en(){const e=document.querySelectorAll(".file-explorer-window");return e.length>0&&e[e.length-1].getAttribute("data-current-path")||"C://Documents"}async function St(){try{const e=document.getElementById("explorer-window");if(e){const n=e.querySelector(".file-explorer-window");if(n){const i={currentPath:n.getAttribute("data-current-path")||"C://",timestamp:Date.now()};await z.setItem("fileExplorerState",i)}}}catch(e){console.warn("Failed to save file explorer state:",e);try{const n=document.getElementById("explorer-window");if(n){const t=n.querySelector(".file-explorer-window");if(t){const o={currentPath:t.getAttribute("data-current-path")||"C://",timestamp:Date.now()};z.setItemSync("fileExplorerState",o)}}}catch(n){console.error("Failed to save file explorer state with fallback:",n)}}}async function ta(){try{const e=await z.getItem("fileExplorerState");if(e)return e}catch(e){console.warn("Failed to load file explorer state:",e);try{const n=z.getItemSync("fileExplorerState");if(n)return n}catch(n){console.warn("Failed to load file explorer state with fallback:",n)}}return{currentPath:"C://",timestamp:0}}function na(e){setTimeout(async()=>{await gi()},50)}async function gi(){const e=await ta(),n=document.getElementById("explorer-window");if(n&&e.currentPath){const t=st(e.currentPath),i=n.querySelector(".file-explorer-window");i?(i.outerHTML=t,setTimeout(()=>{Pe(),at()},100)):console.warn("‚ö†Ô∏è Could not find .file-explorer-window element")}else console.warn("‚ö†Ô∏è No explorer window found or no current path in state")}typeof window<"u"&&(window.initializeFileExplorerUI=na,window.restoreFileExplorerState=gi);function tn(e){e.addEventListener("keydown",function(n){if(n.key==="ContextMenu"||n.shiftKey&&n.key==="F10"||n.ctrlKey&&n.key===" "){n.preventDefault();const t=e.getBoundingClientRect(),i=new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,clientX:t.left+t.width/2,clientY:t.top+t.height/2,button:2});e.dispatchEvent(i),setTimeout(()=>{const o=document.getElementById("context-menu");o&&!o.classList.contains("hidden")&&oa(o)},10)}})}function oa(e){if(!e)return;e.setAttribute("role","menu"),e.setAttribute("aria-label","Context menu");const n=Array.from(e.children).filter(t=>t.classList.contains("cursor-pointer")&&!t.classList.contains("text-gray-400"));n.forEach((t,i)=>{t.setAttribute("role","menuitem"),t.setAttribute("tabindex",i===0?"0":"-1"),t.addEventListener("keydown",function(r){(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),t.click())}),t.addEventListener("mouseenter",function(){n.forEach(r=>{r.classList.remove("bg-gray-50"),r.style.backgroundColor=""}),t.classList.add("bg-gray-50"),t.style.backgroundColor="#f9fafb"}),t.addEventListener("mouseleave",function(){document.activeElement!==t&&(t.classList.remove("bg-gray-50"),t.style.backgroundColor="")});const o=t.querySelector("div.absolute");o&&(t.setAttribute("aria-haspopup","true"),t.setAttribute("aria-expanded","false"),o.setAttribute("role","menu"),o.setAttribute("aria-label","Submenu"),Array.from(o.children).filter(a=>a.classList.contains("cursor-pointer")).forEach((a,s)=>{a.setAttribute("role","menuitem"),a.setAttribute("tabindex","-1"),a.addEventListener("keydown",function(l){(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),a.click())})}))}),n.length>0&&setTimeout(()=>{n[0].focus(),n[0].classList.add("bg-gray-50"),n[0].style.backgroundColor="#f9fafb"},50)}function Oo(){document.addEventListener("keydown",function(r){const a=document.getElementById("context-menu");if(a&&!a.classList.contains("hidden")){e(r,a);return}const l=document.querySelector(".file-explorer-window:focus-within");if(l){const c=document.activeElement;switch(r.key){case"F2":r.preventDefault(),console.log("F2 - Rename functionality would trigger here");break;case"Delete":r.preventDefault(),console.log("Delete - Delete functionality would trigger here");break;case"Enter":r.preventDefault(),c&&c.classList.contains("file-item")&&c.dispatchEvent(new MouseEvent("dblclick",{bubbles:!0}));break;case"ArrowDown":case"ArrowUp":r.preventDefault(),i(r.key==="ArrowDown"?"down":"up",l);break}}});function e(r,a){const s=Array.from(a.children).filter(c=>!c.classList.contains("text-gray-400")&&c.classList.contains("cursor-pointer"));if(s.length===0)return;let l=-1;for(let c=0;c<s.length;c++)if(s[c].classList.contains("bg-gray-50")||s[c].matches(":focus")){l=c;break}switch(r.key){case"ArrowDown":r.preventDefault(),r.stopPropagation(),l=l===-1?0:(l+1)%s.length,n(s,l);break;case"ArrowUp":r.preventDefault(),r.stopPropagation(),l=l===-1?s.length-1:(l-1+s.length)%s.length,n(s,l);break;case"ArrowRight":if(r.preventDefault(),r.stopPropagation(),l>=0&&s[l]){const d=s[l].querySelector("div.absolute");if(d){d.classList.remove("hidden");const p=Array.from(d.children).filter(m=>m.classList.contains("cursor-pointer"));p.length>0&&t(p,0)}}break;case"ArrowLeft":r.preventDefault(),r.stopPropagation();const c=a.querySelector("div.absolute:not(.hidden)");c&&(c.classList.add("hidden"),l>=0&&s[l]&&n(s,l));break;case"Enter":case" ":r.preventDefault(),r.stopPropagation(),l>=0&&s[l]&&s[l].click();break;case"Escape":r.preventDefault(),r.stopPropagation(),typeof hideContextMenu=="function"?hideContextMenu():a.classList.add("hidden");break}}function n(r,a){r.forEach(s=>{s.classList.remove("bg-gray-50"),s.style.backgroundColor=""}),r[a]&&(r[a].classList.add("bg-gray-50"),r[a].style.backgroundColor="#f9fafb",r[a].focus())}function t(r,a){r.forEach(s=>{s.classList.remove("bg-gray-50"),s.style.backgroundColor=""}),r[a]&&(r[a].classList.add("bg-gray-50"),r[a].style.backgroundColor="#f9fafb",r[a].focus())}function i(r,a){const s=Array.from(a.querySelectorAll(".file-item, .folder-item")),l=document.activeElement;let c=s.indexOf(l);if(c===-1&&s.length>0){s[0].focus();return}let d;r==="down"?d=(c+1)%s.length:d=(c-1+s.length)%s.length,s[d]&&s[d].focus()}new MutationObserver(function(r){r.forEach(function(a){a.addedNodes.forEach(function(s){var l,c;if(s.nodeType===Node.ELEMENT_NODE){const d=(l=s.querySelectorAll)==null?void 0:l.call(s,".file-item, .folder-item, .draggable-icon");d==null||d.forEach(m=>{tn(m),m.hasAttribute("tabindex")||m.setAttribute("tabindex","0")});const p=(c=s.querySelectorAll)==null?void 0:c.call(s,".file-explorer-window");p==null||p.forEach(m=>{tn(m),m.hasAttribute("tabindex")||m.setAttribute("tabindex","0")})}})})}).observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll(".file-item, .folder-item, .draggable-icon").forEach(r=>{tn(r),r.hasAttribute("tabindex")||r.setAttribute("tabindex","0")}),document.querySelectorAll(".file-explorer-window").forEach(r=>{tn(r),r.hasAttribute("tabindex")||r.setAttribute("tabindex","0")})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Oo):Oo();function Qe(e,n=null){let t;typeof e!="string"?t=e:t=document.getElementById(e),t.classList.toggle("bg-gray-50"),t.classList.toggle("bg-gray-200"),t.classList.toggle("border-gray-300"),t.classList.toggle("border-black");const i=t.querySelector("span");i.classList.toggle("border-gray-300"),i.classList.toggle("border-black");const o=t.querySelector("img");o&&(o.classList.toggle("border-gray-300"),o.classList.toggle("border-black")),n&&(i.innerHTML=n)}function ia(e){if(!e)return!0;try{return new URL(e,location.href).origin===location.origin}catch{return!1}}function hi(){document.getElementById("error-overlay").classList.remove("hidden"),document.getElementById("error-overlay").style.zIndex="9999";function e(n){location.reload()}document.addEventListener("keydown",e,{once:!0})}window.onerror=function(e,n,t,i,o){ia(n)&&hi()};window.addEventListener("unhandledrejection",function(e){hi()});function yi(e){if(window.watercolourImageSelectionCallback=e,window.watercolourSelectedFile=null,typeof getExplorerWindowContent=="function"&&typeof createWindow=="function"){const t=getExplorerWindowContent("C://Documents").replace(/<div id="file-sidebar"[\s\S]*?<\/ul><\/div>/g,"").replace(/<div id="breadcrumbs"[\s\S]*?<\/div>/g,""),i=createWindow("Select Image - File Explorer",t,!0,"explorer-image-select",!1,!1,{type:"integer",width:600,height:550},"file-explorer");bringToFront(i),setTimeout(()=>{if(i){const o=i.querySelector(".file-explorer-window");o?o.setAttribute("data-image-selection-mode","true"):console.error("Could not find .file-explorer-window div!");const r=i.querySelector(".p-2");if(r){const a=document.createElement("div");a.className="bg-blue-100 border border-blue-300 text-blue-800 px-3 py-2 rounded mb-3 text-sm",a.innerHTML='<strong>Select an image:</strong> Click any image file (.png, .jpg, .jpeg, .gif, .webp) to select it, then click "Open Selected Image".',r.insertBefore(a,r.firstChild);const s=document.createElement("div");s.className="-mt-2 p-3 bg-gray-50 border-t border-gray-200 flex items-center justify-between",s.id="watercolour-selection-ui";const l=document.createElement("div");l.className="flex gap-2";const c=me("Cancel");c.id="cancel-selection";const d=me("Open");d.id="open-selected-image",d.disabled=!0,d.style.opacity="0.5",d.style.cursor="not-allowed",l.appendChild(c),l.appendChild(d),s.innerHTML=`
            <div>
              <span id="selected-image-name" class="text-sm text-gray-600">No image selected</span>
            </div>
          `,s.appendChild(l),r.appendChild(s),c.addEventListener("click",()=>{window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null,closeWindow("explorer-image-select")}),d.addEventListener("click",()=>{const p=window.watercolourSelectedFile;p&&window.watercolourImageSelectionCallback&&!d.disabled&&handleWatercolourImageSelection(p)}),window.updateWatercolourImageSelectionButton=function(p){p?(d.disabled=!1,d.style.opacity="1",d.style.cursor="pointer"):(d.disabled=!0,d.style.opacity="0.5",d.style.cursor="not-allowed")}}}else console.error("Explorer window not found!")},100)}else showDialogBox("File explorer functionality not available.","error")}function me(e){const n=document.createElement("button");n.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2";const t=document.createElement("span");return t.className="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3",t.textContent=e,n.appendChild(t),n.setAttribute("aria-label",e),n.setAttribute("title",e),n}function so(e,n="",t=null,i=null){return showDialogBox(e,"prompt",t,i,{defaultValue:n})}const bi=Object.freeze(Object.defineProperty({__proto__:null,makeWin95Button:me,makeWin95Prompt:so,openFileExplorerForImageSelection:yi,toggleButtonActiveState:Qe},Symbol.toStringTag,{value:"Module"}));function wi(){const e=document.getElementById("compost-bin");if(e){ke(e);return}const t=ae("Compost Bin","",!1,"compost-bin",!1,!1,{type:"integer",width:600,height:400},"App",null,"gray").querySelector(".p-2");t.className="p-2 bg-gray-100 h-full flex flex-col";const i=document.createElement("div");i.className="h-full flex flex-col";const o=document.createElement("div");o.className="bg-gray-200 border-b border-gray-400 p-2 flex justify-between items-center";const r=document.createElement("div");r.className="text-sm";const l=(se().folders["C://Desktop"]||{}).compostbin,c=Object.keys((l==null?void 0:l.contents)||{}).length;r.textContent=`Compost Bin - ${c} item(s)`;const d=document.createElement("div");d.className="flex space-x-2";const p=document.createElement("button");p.className="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs",p.textContent="Empty Bin",p.setAttribute("aria-label","Empty all items from compost bin"),p.setAttribute("title","Permanently delete all items in the compost bin"),p.addEventListener("click",vi),d.appendChild(p),o.appendChild(r),o.appendChild(d);const m=document.createElement("div");m.className="flex-1 bg-white border border-gray-400 p-2 overflow-auto",m.id="compost-bin-content",m.addEventListener("dragover",sa),m.addEventListener("dragleave",la),m.addEventListener("drop",ca),Xt(m),i.appendChild(o),i.appendChild(m),t.appendChild(i)}function Xt(e){const i=(se().folders["C://Desktop"]||{}).compostbin,o=(i==null?void 0:i.contents)||{};if(e.innerHTML="",Object.keys(o).length===0){const a=document.createElement("div");a.className="text-center text-gray-500 mt-8",a.textContent="The Compost Bin is empty",e.appendChild(a);return}const r=document.createElement("div");r.className="grid grid-cols-6 gap-4 p-2",Object.values(o).forEach(a=>{const s=ra(a);r.appendChild(s)}),e.appendChild(r)}function ra(e){const n=document.createElement("div");n.className="flex flex-col items-center p-2 hover:bg-blue-100 cursor-pointer",n.draggable=!0,n.setAttribute("data-item-id",e.id);const t=document.createElement("img");t.className="w-8 h-8 mb-1",t.src=e.icon||aa(e.type),t.alt=e.name;const i=document.createElement("div");return i.className="text-xs text-center text-gray-700 break-words max-w-16",i.textContent=e.name,n.appendChild(t),n.appendChild(i),n.addEventListener("dragstart",o=>{o.dataTransfer.setData("text/plain",e.id),o.dataTransfer.setData("application/x-compost-item","true"),o.dataTransfer.effectAllowed="move"}),n}async function Ct(e,n){console.log("moveItemToCompostBin called",{itemId:e,fromPath:n});let t=await Vr();if(t||(t=se()),e==="compostbin"){ie("Cannot move the Compost Bin to itself!","error");return}let i=null,o=null;if(n&&(n==="C://Desktop"?o=t.folders["C://Desktop"]:o=t.folders[n]),!o||!o[e]){console.log("Item not found in provided path, searching FS...");for(const r in t.folders){if(t.folders[r][e]){o=t.folders[r],n=r;break}if(t.folders[r].contents&&t.folders[r].contents[e]){o=t.folders[r].contents,n=r;break}}}if(o&&o[e]){if(i=o[e],i.type==="app"){let l=!1;if(i.isCustomApp&&i.customAppData&&(l=String(i.customAppData.compostable)==="true"),!l){ie("This application cannot be moved to the Compost Bin.","error");return}}const a=(t.folders["C://Desktop"]||{}).compostbin;if(!a){console.error("Compost bin not found in unified structure"),ie("Compost Bin not found!","error");return}if(a.contents||(a.contents={}),i.originalPath=n,a.contents[e]=i,i.slug&&gt(i.slug,"C://Desktop/compostbin/"+i.name),delete o[e],n==="C://Desktop"){const l="icon-"+e;fe[l]&&delete fe[l]}await xe(t),Q(),at(),he();const s=document.getElementById("compost-bin");if(s){const l=s.querySelector("#compost-bin-content");l&&(Xt(l),lo(s))}}else console.error("Item not found in file system:",e),ie("Could not find item to move to Compost Bin.","error")}function vi(){const e=se(),t=(e.folders["C://Desktop"]||{}).compostbin;if(!t){ie("Compost Bin not found!","error");return}const i=Object.keys(t.contents||{}).length;if(i===0){ie("The Compost Bin is already empty.","info");return}const o=`window-${Date.now()}`,r=ae("Empty Compost Bin","",!1,o,!1,!1,{type:"integer",width:320,height:140},"Default"),a=r.querySelector(".p-2");a.classList.add("p-4","flex","flex-col","justify-between","h-full");const s=document.createElement("p");s.textContent=`Are you sure you want to permanently delete all ${i} item(s) in the Compost Bin?`,a.appendChild(s);const l=document.createElement("div");l.className="flex justify-end space-x-2",a.appendChild(l);const c=document.createElement("button");c.className="px-4 py-2 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200",c.textContent="Cancel",c.setAttribute("aria-label","Cancel empty bin operation"),c.setAttribute("title","Cancel and keep items in compost bin");const d=document.createElement("button");d.className="px-4 py-2 bg-red-500 border-2 border-red-600 hover:bg-red-400 text-white",d.textContent="Empty Bin",d.setAttribute("aria-label","Confirm empty bin operation"),d.setAttribute("title","Permanently delete all items in compost bin"),l.append(c,d),c.addEventListener("click",()=>le(o)),d.addEventListener("click",async()=>{const p=t.contents||{},m=Object.keys(p);e.deletedCustomApps||(e.deletedCustomApps=[]),Object.values(p).forEach(f=>{f.isCustomApp&&(e.deletedCustomApps.includes(f.id)||e.deletedCustomApps.push(f.id)),f.slug&&yr(f.slug)}),t.contents={},m.forEach(f=>{const g="icon-"+f;fe[g]&&delete fe[g]}),await xe(e),Q();const u=document.getElementById("compost-bin");if(u){const f=u.querySelector("#compost-bin-content");f&&(Xt(f),lo(u))}le(o),ie(`${i} item(s) permanently deleted from Compost Bin`,"info")}),ke(r)}function lo(e){const n=e.querySelector(".bg-gray-200");if(n){const t=n.querySelector(".text-sm");if(t){const r=(se().folders["C://Desktop"]||{}).compostbin,a=Object.keys((r==null?void 0:r.contents)||{}).length;t.textContent=`Compost Bin - ${a} item(s)`}}}function aa(e){switch(e){case"folder":return"./image/folder.webp";case"ugc-file":return"./image/doc.webp";case"app":return"./image/computer.webp";default:return"./image/file.webp"}}function sa(e){if(e.preventDefault(),e.stopPropagation(),e.dataTransfer.types.includes("application/x-non-compostable")){e.dataTransfer.dropEffect="none";return}e.dataTransfer.dropEffect="move",this.classList.add("bg-blue-50")}function la(e){this.classList.remove("bg-blue-50")}async function ca(e){if(e.preventDefault(),e.stopPropagation(),this.classList.remove("bg-blue-50"),e.dataTransfer.types.includes("application/x-non-compostable")||e.dataTransfer.getData("application/x-compost-item")==="true")return;const i=e.dataTransfer.getData("text/plain");i&&await Ct(i,null)}function Pe(){requestAnimationFrame(()=>{document.querySelectorAll(".file-item").forEach(i=>{i.removeEventListener("dragstart",Wo),i.removeEventListener("dragover",Ro),i.removeEventListener("dragleave",_o),i.removeEventListener("drop",Ho),i.removeEventListener("dragend",qo),i.setAttribute("draggable",!0),i.addEventListener("dragstart",Wo),i.addEventListener("dragover",Ro),i.addEventListener("dragleave",_o),i.addEventListener("drop",Ho),i.addEventListener("dragend",qo)}),document.querySelectorAll(".file-explorer-window").forEach(i=>{i.removeEventListener("dragover",Go),i.removeEventListener("dragleave",Ko),i.removeEventListener("drop",Xo),i.addEventListener("dragover",Go),i.addEventListener("dragleave",Ko),i.addEventListener("drop",Xo)}),document.querySelectorAll(".desktop-folder-icon[data-item-id]").forEach(i=>{const o=i.getAttribute("data-item-id"),r=xn(o);(r&&r.type==="folder"||o==="compostbin")&&(i.removeEventListener("dragover",jo),i.removeEventListener("dragleave",Uo),i.removeEventListener("drop",Yo),i.addEventListener("dragover",jo),i.addEventListener("dragleave",Uo),i.addEventListener("drop",Yo))})})}function Wo(e){e.dataTransfer.effectAllowed="move";const n=this.getAttribute("data-item-id");e.dataTransfer.setData("text/plain",n),this.classList.add("dragging");const t=xn(n);let i=!0;t&&t.type==="app"&&(t.isCustomApp&&t.customAppData?i=String(t.customAppData.compostable)==="true":i=!1),i||e.dataTransfer.setData("application/x-non-compostable","true")}function Ro(e){(e.dataTransfer.types.includes("application/x-compost-item")||e.dataTransfer.types.includes("text/plain"))&&(e.preventDefault(),e.dataTransfer.dropEffect="move",this.classList.add("dragover"))}function _o(e){this.classList.remove("dragover")}async function Ho(e){e.stopPropagation(),this.classList.remove("dragover");const n=e.dataTransfer.getData("text/plain"),t=this.getAttribute("data-item-id"),i=e.dataTransfer.getData("application/x-compost-item")==="true";if(n===t)return;const o=document.querySelector(`[data-item-id="${n}"]`),r=this;if(i){if(r.classList.contains("folder-item")){const a=r.closest(".file-explorer-window"),s=a?a.getAttribute("data-current-path"):"C://",l=s==="C://"?s+t:s+"/"+t;await kn(n,l)}return}if(r.classList.contains("folder-item"))await vn(n,t);else{const a=this.getBoundingClientRect(),s=e.clientY-a.top,l=this.parentElement;s<a.height/2?l.insertBefore(o,this):l.insertBefore(o,this.nextSibling),await da()}o&&o.classList.remove("dragging")}function qo(e){this.classList.remove("dragging"),document.querySelectorAll(".file-item").forEach(t=>t.classList.remove("dragover"));const n=document.getElementById("desktop");n&&n.classList.remove("drag-hover-target"),document.querySelectorAll(".drag-hover-target").forEach(t=>{t.classList.remove("drag-hover-target")})}async function vn(e,n){let t=se();const i=fn(e,t);if(!i){console.error("Item not found:",e);return}const{item:o,parent:r}=i;let a=null,s=ma(n);if(s&&(a=co(s,t)),!a){const c=fn(n,t);c&&c.item&&c.item.type==="folder"&&(a=c.item,s=a.fullPath)}if(!a){console.error("Target folder not found:",n);return}const l=o.fullPath&&o.fullPath.includes("C://Desktop");if(delete r[e],l){const c="icon-"+e;fe[c]&&delete fe[c]}a.contents||(a.contents={}),a.contents[e]=o,s&&!/^[A-Z]:\/\/$/.test(s)&&(t.folders[s]||(t.folders[s]={}),Object.keys(t.folders[s]).length===0&&Object.assign(t.folders[s],a),t.folders[s][e]=o),!s&&a.fullPath&&(s=a.fullPath),s?(o.fullPath=s+"/"+o.name,o.slug&&gt(o.slug,o.fullPath)):console.warn("Could not determine full path for target folder",a),await xe(t),await Q(),at(),(s&&s.includes("Desktop")||o.fullPath&&o.fullPath.includes("Desktop"))&&he()}async function Kn(e,n){let t=se();const i=fn(e,t);if(!i){console.error("Item not found:",e);return}const{item:o,parent:r}=i,a=o.fullPath&&o.fullPath.includes("C://Desktop");if(delete r[e],a){const s="icon-"+e;typeof fe<"u"&&fe[s]&&delete fe[s]}t.folders[n]||(t.folders[n]={}),t.folders[n][e]=o,o.fullPath=n+"/"+o.name,o.slug&&gt(o.slug,o.fullPath),await xe(t),await Q(),at(),(n.includes("Desktop")||a)&&he()}async function da(){const e=document.querySelector(".file-explorer-window");if(!e)return;const n=e.getAttribute("data-current-path"),t=Array.from(e.querySelectorAll("ul > li"));let i=se(),o=co(n,i);if(!o||!o.contents)return;let r={};t.forEach(a=>{const s=a.getAttribute("data-item-id");o.contents[s]&&(r[s]=o.contents[s])}),o.contents=r,await xe(i),await Q()}function fn(e,n){for(const t in n.folders){const i=n.folders[t];if(i[e])return{item:i[e],parent:i};if(i.contents&&i.contents[e])return{item:i.contents[e],parent:i.contents}}return null}function xn(e){const n=se();for(const t in n.folders){const i=n.folders[t];if(i[e])return i[e];if(i.contents&&i.contents[e])return i.contents[e]}return null}function ua(e){const n=se();for(const t in n.folders){const i=n.folders[t];if(i[e]||i.contents&&i.contents[e])return t}return""}function jo(e){const n=e.dataTransfer.types.includes("application/x-compost-item"),t=e.dataTransfer.types.includes("application/x-non-compostable");this.getAttribute("data-item-id")==="compostbin"&&t||(n||e.dataTransfer.types.includes("text/plain"))&&(e.preventDefault(),e.dataTransfer.dropEffect="move",this.classList.add("dragover"))}function Uo(e){this.classList.remove("dragover")}async function Yo(e){e.preventDefault(),e.stopPropagation(),this.classList.remove("dragover");const n=e.dataTransfer.getData("text/plain"),t=this.getAttribute("data-item-id"),i=e.dataTransfer.getData("application/x-compost-item")==="true";if(n&&t&&n!==t)if(i){const o=xn(t);o&&o.type==="folder"&&await kn(n,o.fullPath)}else if(t==="compostbin"){const o=ua(n);await Ct(n,o)}else await vn(n,t)}function Go(e){e.dataTransfer.types.includes("text/plain")&&(e.preventDefault(),e.dataTransfer.dropEffect="move",this.classList.add("dragover"))}function Ko(e){this.contains(e.relatedTarget)||this.classList.remove("dragover")}async function Xo(e){e.preventDefault(),e.stopPropagation(),this.classList.remove("dragover");const n=e.dataTransfer.getData("text/plain"),t=this.getAttribute("data-current-path"),i=e.dataTransfer.getData("application/x-compost-item")==="true";if(n&&t){if(i){await kn(n,t);return}const o=xn(n);if(o){const r=o.fullPath;if(r&&r.startsWith(t))return;r&&r.includes("C://Desktop")?await Kn(n,t):await Kn(n,t)}}}Pe();async function kn(e,n){const t=se(),o=(t.folders["C://Desktop"]||{}).compostbin;if(!o||!o.contents||!o.contents[e]){console.error("Item not found in compost bin:",e);return}const r=o.contents[e];delete o.contents[e];let a;if(n==="C://Desktop")t.folders["C://Desktop"]||(t.folders["C://Desktop"]={}),a=t.folders["C://Desktop"];else{const l=co(n,t);if(!l){console.error("Target folder not found:",n);return}a=l}r.fullPath=n+"/"+r.id,r.slug&&(br(r.slug),gt(r.slug,r.fullPath)),a[e]=r,await xe(t),await Q(),at(),he();const s=document.getElementById("compost-bin");if(s){const l=s.querySelector("#compost-bin-content");l&&(Xt(l),lo(s))}}function pa(){const e=document.getElementById("desktop");e&&(e.addEventListener("dragover",n=>{const t=n.dataTransfer.types.includes("application/x-compost-item"),i=n.dataTransfer.types.includes("text/plain");(t||i)&&(n.preventDefault(),n.dataTransfer.dropEffect="move",e.classList.add("drag-hover-target"))}),e.addEventListener("dragleave",n=>{e.contains(n.relatedTarget)||e.classList.remove("drag-hover-target")}),e.addEventListener("drop",async n=>{n.preventDefault(),e.classList.remove("drag-hover-target");const t=n.dataTransfer.getData("application/x-compost-item")==="true",i=n.dataTransfer.getData("text/plain");i&&(t?await kn(i,"C://Desktop"):await fa(i))}))}async function fa(e){const n=se(),t=fn(e,n);if(!t){console.error("Item not found:",e);return}const{item:i,parent:o}=t;i.fullPath&&i.fullPath==="C://Desktop/"+i.id||(delete o[e],n.folders["C://Desktop"]||(n.folders["C://Desktop"]={}),n.folders["C://Desktop"][e]=i,i.fullPath="C://Desktop/"+i.id,i.slug&&gt(i.slug,i.fullPath),await xe(n),await Q(),at(),he())}function ma(e){const n=se();for(const t in n.folders){const i=n.folders[t];if(i.id===e)return t;if(i.contents&&i.contents[e]&&i.contents[e].type==="folder")return i.contents[e].fullPath||t+"/"+i.contents[e].name}return""}function co(e,n){return n||(n=se()),n.folders[e]?n.folders[e]:null}let ue={isActive:!1,selectedIcon:null,cutIcon:null,moveStep:20,gridStep:112};function vt(e){const n=se();for(const t in n.folders){const i=n.folders[t];if(i[e])return i[e];if(i.contents&&i.contents[e])return i.contents[e]}return null}function He(e,n="polite"){let t=document.getElementById("sr-announcements");t||(t=document.createElement("div"),t.id="sr-announcements",t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),t.className="sr-only",document.body.appendChild(t)),t.textContent=e,setTimeout(()=>{t.textContent=""},1e3)}function En(e){const t=document.getElementById("desktop").getBoundingClientRect(),i=e.getBoundingClientRect();let o=parseInt(e.style.left)||0,r=parseInt(e.style.top)||0;o=Math.max(0,Math.min(o,t.width-i.width)),r=Math.max(0,Math.min(r,t.height-i.height-40)),e.style.left=o+"px",e.style.top=r+"px"}function ga(e,n=96,t=128,i=16){const a=n+i,s=t+i,c=document.getElementById("desktop").getBoundingClientRect(),d=c.width-n,p=c.height-t-40;let m=16,u=16;for(;m<=d;){for(;u<=p;){const f={left:m,top:u,right:m+n,bottom:u+t};let g=!1;for(const w of e){const b={left:w.left,top:w.top,right:w.left+w.width,bottom:w.top+w.height};if(!(f.right<=b.left||f.left>=b.right||f.bottom<=b.top||f.top>=b.bottom)){g=!0;break}}if(!g)return{left:m,top:u};u+=s}u=16,m+=a}return{left:16,top:16}}function xi(e,n,t){document.querySelectorAll(".desktop-folder-icon").forEach(c=>{c.classList.remove("dragover")}),document.querySelectorAll(".file-explorer-window").forEach(c=>{c.classList.remove("dragover")});const i=document.getElementById("compost-bin-content");i&&i.classList.remove("bg-blue-50");const o=t.style.visibility;t.style.visibility="hidden";const r=document.elementFromPoint(e,n),a=r?r.closest(".desktop-folder-icon[data-item-id]"):null,s=r?r.closest(".file-explorer-window"):null,l=r?r.closest("#compost-bin-content"):null;if(t.style.visibility=o,a&&a!==t){const c=a.getAttribute("data-item-id"),d=vt(c),p=t.dataset.isCompostable==="true";if(c==="compostbin"&&!p)return;(d&&d.type==="folder"||c==="compostbin")&&a.classList.add("dragover")}else s?s.classList.add("dragover"):l&&t.dataset.isCompostable==="true"&&l.classList.add("bg-blue-50")}function Sn(e){let n=!1,t,i,o=5,r=0;e.addEventListener("pointerdown",function(a){if(!a.isPrimary||ue.isActive)return;a.preventDefault(),n=!1,t=a.clientX,i=a.clientY,r=Date.now();const s=e.getBoundingClientRect(),l=a.clientX-s.left,c=a.clientY-s.top,d=a.pointerType==="touch";function p(u){if(!u.isPrimary)return;const f=Math.sqrt(Math.pow(u.clientX-t,2)+Math.pow(u.clientY-i,2));if(!n&&f>o){n=!0,e.classList.add("dragging");const g=e.getBoundingClientRect();document.body.appendChild(e),e.style.position="fixed",e.style.left=g.left+"px",e.style.top=g.top+"px",e.style.zIndex="99999",console.log("Drag started. Reparented to body. zIndex:",e.style.zIndex);const w=e.getAttribute("data-item-id"),b=vt(w);let C=!0;b&&b.type==="app"&&(b.isCustomApp&&b.customAppData?C=String(b.customAppData.compostable)==="true":C=!1),e.dataset.isCompostable=String(C),d&&(e.classList.add("touch-dragging"),navigator.vibrate&&navigator.vibrate(50)),document.querySelectorAll(".desktop-folder-icon[data-item-id]").forEach(h=>{const _=vt(h.getAttribute("data-item-id")),N=h.getAttribute("data-item-id");N==="compostbin"&&!C||(_&&_.type==="folder"||N==="compostbin")&&h!==e&&h.classList.add("drag-hover-target")}),document.body.style.overflow="hidden",He("Drag started. Move to reposition or drop on a folder.")}if(n){let g=u.clientX-l,w=u.clientY-c;const C=document.getElementById("desktop").getBoundingClientRect(),h=e.getBoundingClientRect();g=Math.max(C.left,Math.min(g,C.right-h.width)),w=Math.max(C.top,Math.min(w,C.bottom-h.height-40)),e.style.left=g+"px",e.style.top=w+"px",xi(u.clientX,u.clientY,e)}}async function m(u){if(!u.isPrimary)return;if(document.removeEventListener("pointermove",p),document.removeEventListener("pointerup",m),document.removeEventListener("pointercancel",m),n){const g=document.getElementById("desktop-icons");g.appendChild(e);const w=g.getBoundingClientRect(),b=parseFloat(e.style.left),C=parseFloat(e.style.top);e.style.position="absolute",e.style.left=b-w.left+"px",e.style.top=C-w.top+"px",e.style.zIndex="",e.classList.remove("dragging"),console.log("Drag ended. Reparented to desktop-icons.");const h=e.style.visibility;e.style.visibility="hidden";const _=document.elementFromPoint(u.clientX,u.clientY);e.style.visibility=h;const N=_?_.closest(".desktop-folder-icon[data-item-id]"):null,j=_?_.closest(".file-explorer-window"):null,A=_?_.closest("#compost-bin-content"):null;if(N&&N!==e){const M=N.getAttribute("data-item-id"),O=vt(M),H=e.getAttribute("data-item-id");if(H!==M){if(M==="compostbin"){await Ct(H,"C://Desktop");return}else if(O&&O.type==="folder"){await vn(H,M);return}}}else if(j){const M=e.getAttribute("data-item-id"),O=j.getAttribute("data-current-path");if(O&&M){await Kn(M,O);return}}else if(A){const M=e.getAttribute("data-item-id");if(e.dataset.isCompostable==="true"){await Ct(M,"C://Desktop");return}}En(e),fe[e.id]={left:e.style.left,top:e.style.top},Q()}document.querySelectorAll(".drag-hover-target").forEach(g=>{g.classList.remove("drag-hover-target")}),document.querySelectorAll(".desktop-folder-icon").forEach(g=>{g.classList.remove("dragover")}),document.querySelectorAll(".file-explorer-window").forEach(g=>{g.classList.remove("dragover")});const f=document.getElementById("compost-bin-content");f&&f.classList.remove("bg-blue-50"),document.body.style.overflow="",n=!1}document.addEventListener("pointermove",p),document.addEventListener("pointerup",m),document.addEventListener("pointercancel",m)}),e.addEventListener("click",function(a){const s=Date.now()-r;!n&&s>100&&(document.querySelectorAll(".draggable-icon").forEach(l=>l.classList.remove("bg-gray-50")),e.classList.add("bg-gray-50"))})}function ha(){const e=document.getElementById("bgColorInput").value,n=document.getElementById("bgImageValue").value,t=document.getElementById("clockSecondsInput").checked;be.bgColor=e,be.bgImage=n,be.clockSeconds=t,ki(),Q()}function ki(){const e=document.getElementById("desktop"),t=document.getElementById("windows-container")||e;be.bgColor&&(t.style.backgroundColor=be.bgColor,e&&(e.style.backgroundColor=be.bgColor)),be.bgImage?(t.style.backgroundImage=`url(${be.bgImage})`,t.style.backgroundSize="cover",t.style.backgroundRepeat="no-repeat",t.style.backgroundPosition="center"):t.style.backgroundImage="none"}function ya(){const e=be.bgImage?"Custom Image Selected":"None";return`
    <div class="space-y-4">
      <div>
        <label for="bgColorInput" class="block text-sm font-medium">Desktop Background Color:</label>
        <input id="bgColorInput" type="color" value="${be.bgColor}" class="border mt-1" aria-describedby="bgColorHelp" />
        <p id="bgColorHelp" class="text-xs text-gray-600 mt-1">Choose a color for your desktop background</p>
      </div>
      <div>
        <label class="block text-sm font-medium">Background Image:</label>
        <div class="flex items-center gap-2 mt-1">
            <span id="bgImageName" class="text-sm text-gray-800 border px-2 py-1 bg-gray-50 flex-grow truncate">${e}</span>
            <button id="bg-image-select-btn" class="bg-gray-200 border-t-2 border-l-2 border-gray-300 px-2 py-1 text-sm active:border-t-black active:border-l-black active:border-b-white active:border-r-white">Select...</button>
            <button id="bg-image-clear-btn" class="bg-gray-200 border-t-2 border-l-2 border-gray-300 px-2 py-1 text-sm active:border-t-black active:border-l-black active:border-b-white active:border-r-white">Clear</button>
        </div>
        <p class="text-xs text-gray-600 mt-1">Select an image from your computer to use as wallpaper</p>
        <input type="hidden" id="bgImageValue" value="${be.bgImage||""}">
      </div>
      <div>
        <label for="clockSecondsInput" class="block text-sm font-medium">Show Seconds on Clock:</label>
        <input id="clockSecondsInput" type="checkbox" ${be.clockSeconds?"checked":""} class="mt-1" aria-describedby="clockSecondsHelp" />
        <p id="clockSecondsHelp" class="text-xs text-gray-600 mt-1">Display seconds in the taskbar clock</p>
      </div>
      <button id="settings-apply-button"
              class="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2"
              aria-label="Apply desktop settings changes">
        <span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Apply</span>
      </button>
    </div>
  `}function Ei(){try{new Audio("audio/youve_got_mail.mp3").play().catch(i=>console.log("Audio playback prevented:",i))}catch(t){console.log("Could not play audio:",t)}if(window.location.href.includes("reddit.com")){if(document.getElementById("mailbox-error"))return;ae("‚ö†Ô∏è Error",'<div class="text-center p-4"><p class="mb-4">Mail Box is not available in Reddit context.</p><button id="error-ok-btn" class="bg-gray-200 border-t-2 border-l-2 border-gray-300 h-8" aria-label="Close error dialog" title="Close this error message"><span class="border-b-2 border-r-2 border-black block h-full w-full py-1 px-3 leading-6">OK</span></button></div>',!1,"mailbox-error",!1,!1,{type:"integer",width:300,height:150},"Default"),setTimeout(()=>{const t=document.getElementById("error-ok-btn");t&&t.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),le("mailbox-error")})},100);return}const n=ae("Mail Box","",!1,"mailbox",!1,!1,{type:"integer",width:600,height:400},"App",null,"white");Xn(n)}function Xn(e){if(!e)return;const n=e.querySelector(".p-2");if(!n)return;n.innerHTML="",n.classList.add("flex","flex-col","h-full");const t=document.createElement("div");t.className="flex-1 flex overflow-hidden",n.appendChild(t);const i=document.createElement("div");i.id="mailbox-list",i.className="w-1/3 border-r border-gray-300 flex flex-col overflow-y-auto",t.appendChild(i);const o=document.createElement("button");o.id="compose-btn",o.className="p-2 border-b border-gray-300 text-blue-500 hover:bg-gray-100",o.textContent="Compose",o.setAttribute("aria-label","Compose new email"),o.setAttribute("title","Create and send a new email message"),i.appendChild(o);const r=document.createElement("div");r.id="mailbox-detail",r.className="flex-1 p-2 overflow-y-auto",t.appendChild(r);const a=document.createElement("div");a.id="placeholder",a.className="text-gray-500",a.textContent="Select a message to view",r.appendChild(a);function s(m){let u="",f="";try{const g=new URL(m,window.location.origin),w=g.searchParams.get("response-content-disposition");if(w){const C=w.match(/filename\\*?=(?:UTF-8'')?("?)([^";]+)\\1/i);C&&C[2]&&(u=decodeURIComponent(C[2]))}u||(u=g.pathname.split("/").pop());const b=g.searchParams.get("response-content-type");b&&(f=b.split("/").pop()),!f&&u&&u.includes(".")&&(f=u.split(".").pop())}catch{const b=m.split("/").pop().split("?")[0];u=b,b.includes(".")&&(f=b.split(".").pop())}return{name:u||"attachment",ext:(f||"").toLowerCase()}}function l(m){return m.map(u=>{const f={};return["file_1","file_2","file_3"].forEach(g=>{if(u[g]){const w=u[g],b=s(w);f[g]={name:b.name,url:w,ext:b.ext}}}),{id:u.id,email:u.email||u.name||"Unknown",title:u.subject||"No Subject",mail:u.message||"",phone:u.phone||"",company:u.company||"",timestamp:u.created_at||null,public:!1,files:f}})}function c(){try{for(;i.children.length>1;)i.removeChild(i.lastChild);fetch(`${Ue}${oi}`).then(m=>{if(!m.ok)throw new Error("Failed to fetch submissions");return m.json()}).then(m=>{l(m.data).forEach(f=>{const g=document.createElement("div");g.className="p-2 border-b border-gray-300 hover:bg-gray-200 cursor-pointer truncate",g.textContent=f.title||f.email,g.addEventListener("click",()=>d(f)),i.appendChild(g)})}).catch(m=>{console.error("Error loading messages:",m);const u=document.createElement("div");u.className="p-2 text-red-500 text-sm",u.textContent="Failed to load messages",i.appendChild(u)})}catch(m){console.error("Error loading messages:",m)}}function d(m){for(;r.firstChild;)r.removeChild(r.firstChild);const u=document.createElement("div");u.className="mb-4 border-b border-gray-200 pb-2";const f=(w,b)=>{const C=document.createElement("div");C.className="mb-1";const h=document.createElement("strong");return h.textContent=w+": ",C.append(h,document.createTextNode(b||"")),C};u.appendChild(f("From",m.email)),u.appendChild(f("Title",m.title||"(No Title)")),m.phone&&u.appendChild(f("Phone",m.phone)),m.company&&u.appendChild(f("Company",m.company)),m.timestamp&&u.appendChild(f("Date",new Date(m.timestamp).toLocaleString()));const g=document.createElement("div");if(g.className="mb-2 whitespace-pre-wrap font-sans",g.textContent=m.mail,r.append(u,g),m.files&&Object.keys(m.files).length){const w=document.createElement("div");w.className="mt-4 border-t border-gray-200 pt-2";const b=document.createElement("strong");b.textContent="Attachments:",w.appendChild(b);const C=document.createElement("div");C.className="flex flex-col gap-2 mt-2",Object.values(m.files).forEach(h=>{const _=h.url||h.contents;if(!_)return;const N=document.createElement("div");N.className="border p-2 rounded bg-gray-50";let j=h.ext;if(j||(j=_.split(".").pop().toLowerCase().split("?")[0]),["jpg","jpeg","png","gif","webp","svg"].includes(j)){const M=document.createElement("img");M.src=_,M.alt=h.name,M.className="max-w-full h-auto max-h-96 object-contain block mb-1",N.appendChild(M)}else if(["mp3","wav","ogg"].includes(j)){const M=document.createElement("audio");M.controls=!0,M.src=_,M.className="w-full mb-1",N.appendChild(M)}else if(["mp4","webm"].includes(j)){const M=document.createElement("video");M.controls=!0,M.src=_,M.className="max-w-full h-auto max-h-96 mb-1",N.appendChild(M)}const A=document.createElement("a");A.href=_,A.className="text-blue-500 hover:underline text-sm break-all",A.textContent=h.name,A.target="_blank",N.appendChild(A),C.appendChild(N)}),w.appendChild(C),r.appendChild(w)}}function p(){const u=ae("New Mail","",!1,"compose-mail",!1,!1,{type:"integer",width:400,height:600},"App",null,"white").querySelector(".p-2");u.classList.add("p-4");const f=document.createElement("form");f.id="compose-form",f.className="flex flex-col space-y-4",u.appendChild(f);const g=(I,B)=>{const D=document.createElement("div"),E=document.createElement("label");return E.className="block text-sm font-medium text-gray-700",E.textContent=I,D.append(E,B),D},w=document.createElement("input");w.type="email",w.name="from",w.required=!0,w.id="from-email",w.setAttribute("aria-label","Your email address"),w.setAttribute("aria-describedby","from-help"),w.className="mt-1 block w-full border border-gray-300 rounded p-2",f.appendChild(g("Your Email",w));const b=document.createElement("input");b.type="text",b.name="to",b.value="Nostalgia OS Team",b.readOnly=!0,b.id="to-email",b.setAttribute("aria-label","Recipient"),b.className="mt-1 block w-full border border-gray-300 rounded p-2 bg-gray-100",f.appendChild(g("To",b));const C=document.createElement("input");C.type="text",C.name="subject",C.id="email-subject",C.setAttribute("aria-label","Email subject line (optional)"),C.className="mt-1 block w-full border border-gray-300 rounded p-2",f.appendChild(g("Mail Title (optional)",C));const h=document.createElement("textarea");h.name="message",h.required=!0,h.id="email-message",h.setAttribute("aria-label","Email message content"),h.className="mt-1 block w-full border border-gray-300 rounded p-2",f.appendChild(g("Your Mail",h));const _=document.createElement("input");_.type="tel",_.name="phone",_.id="phone-number",_.setAttribute("aria-label","Phone number (optional)"),_.className="mt-1 block w-full border border-gray-300 rounded p-2",f.appendChild(g("Phone (optional)",_));const N=document.createElement("input");N.type="text",N.name="company",N.id="company-name",N.setAttribute("aria-label","Company name (optional)"),N.className="mt-1 block w-full border border-gray-300 rounded p-2",f.appendChild(g("Company (optional)",N));const j=document.createElement("div");j.className="border-t border-gray-200 pt-2 mt-2",f.appendChild(j);const A=document.createElement("label");A.className="block text-sm font-medium text-gray-700 mb-1",A.textContent="Attachments (max 3)",j.appendChild(A);const M=document.createElement("input");M.type="file",M.name="file1",M.className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-2",j.appendChild(M);const O=document.createElement("input");O.type="file",O.name="file2",O.className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-2",j.appendChild(O);const H=document.createElement("input");H.type="file",H.name="file3",H.className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100",j.appendChild(H);const Z=document.createElement("div");Z.className="flex justify-end space-x-2",f.appendChild(Z);const X=document.createElement("button");X.type="button",X.id="cancel-compose",X.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2",X.innerHTML='<span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Cancel</span>',X.setAttribute("aria-label","Cancel mail composition"),X.setAttribute("title","Cancel and discard mail"),Z.appendChild(X);const S=document.createElement("button");S.type="submit",S.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2",S.innerHTML='<span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Submit</span>',S.setAttribute("aria-label","Submit mail"),S.setAttribute("title","Submit your mail"),Z.appendChild(S),f.addEventListener("submit",async I=>{I.preventDefault();const B=S.innerHTML;S.disabled=!0,S.innerHTML='<span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Sending...</span>';const D=new FormData(f),E=new FormData,F=D.get("subject")||"No Subject";E.append("creator_model[title]",`Contact: ${F}`),E.append("creator_model[feed_slug]","suggestions"),E.append("creator_model[model_type]","page");const V=(ee,re,te,ne=!1)=>{const ye=`creator_model[creator_fields_attributes][${ee}]`;E.append(`${ye}[html_input_label]`,re),ne?te instanceof File&&te.size>0&&E.append(`${ye}[file]`,te):E.append(`${ye}[string_content]`,te||"")};V(0,"name",D.get("from")),V(1,"email",D.get("from")),V(2,"phone",D.get("phone")),V(3,"company",D.get("company")),V(4,"subject",F),V(5,"message",D.get("message")),V(6,"file_1",D.get("file1"),!0),V(7,"file_2",D.get("file2"),!0),V(8,"file_3",D.get("file3"),!0);try{if((await fetch(`${Ue}${$r}`,{method:"POST",body:E})).ok)showDialogBox("Mail submitted successfully!","success"),c(),le("compose-mail");else throw new Error("Failed to submit form")}catch(ee){console.error(ee),showDialogBox("Error submitting mail.","error"),S.disabled=!1,S.innerHTML=B}}),X.addEventListener("click",()=>le("compose-mail"))}o.addEventListener("click",p),c()}let nn=null;function ba(){return nn||(nn=new Promise(e=>{if(window.YT&&window.YT.Player){e();return}const n=document.createElement("script");n.src="https://www.youtube.com/iframe_api";const t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(n,t),window.onYouTubeIframeAPIReady=()=>{e()}}),nn)}async function Si(){const e=ae("TubeStream",'<div class="p-2 h-full flex items-center justify-center">Loading...</div>',!1,"tubestream",!1,!1,{type:"integer",width:580,height:380},"default",null,"white");await Vn(e)}async function Vn(e){if(!e)return;const n=e.querySelector(".p-2");if(!n)return;if(!await va()){n.innerHTML=`<div style="display: flex; justify-content: center; align-items: center; height: 100%; flex-direction: column; text-align: center; padding: 20px; font-family: 'MS Sans Serif', sans-serif;">
      <p>Unable to connect to YouTube.</p>
      <p>You might be offline or there is a network error.</p>
    </div>`;return}let i=[];try{const o=await fetch(`${Ue}${ii}`);if(!o.ok)throw new Error("Network response was not ok");const r=await o.json();i=r.playlists||r.data}catch(o){console.warn("Error fetching playlist, using fallback:",o),i=xa.data}if(Array.isArray(i)&&(i=i.filter(o=>!o||typeof o!="object"||Object.keys(o).length===0?!1:o.type==="single"||o.type==="livestream"?!!(o.video_id||o.beginning_video_id):!!o.playlist_id)),!i||i.length===0){n.innerHTML='<div class="p-4 text-center">No content available.</div>';return}e.tubeStreamState={playlistData:i,currentIndex:0,player:null},await ba(),n.innerHTML="",n.style.padding="0",n.style.height="100%",n.style.overflow="hidden",Ci(e)}function Ci(e){const n=e.tubeStreamState;if(!n||!n.playlistData)return;const t=e.querySelector(".p-2");if(!t)return;if(n.player){try{typeof n.player.destroy=="function"&&n.player.destroy()}catch(d){console.warn("Error destroying player:",d)}n.player=null}t.innerHTML="";const i=`player-${Date.now()}-${Math.floor(Math.random()*1e3)}`;n.playerDivId=i;const o=document.createElement("div");o.id=i,t.appendChild(o);const r=n.playlistData[n.currentIndex];if(!r){console.warn("No data for current index",n.currentIndex);return}let a={autoplay:1,controls:1,rel:0,fs:1,enablejsapi:1};if(r.custom_parameters){const d=new URLSearchParams(r.custom_parameters.replace(/&amp;/g,"&"));for(const[p,m]of d)p!=="loop"&&(a[p]=m==="true"?1:m==="false"?0:m)}let s=null,l=null;r.type==="single"||r.type==="livestream"?s=r.video_id||r.beginning_video_id:(s=r.beginning_video_id,l=r.playlist_id);const c={height:"100%",width:"100%",playerVars:a,events:{onStateChange:d=>wa(d,e)}};l?(c.playerVars.listType="playlist",c.playerVars.list=l,s&&(c.videoId=s)):c.videoId=s,n.player=new YT.Player(i,c)}function wa(e,n){if(e.data===YT.PlayerState.ENDED){const t=n.tubeStreamState;if(!t)return;if(t.playlistData[t.currentIndex].type==="playlist"){const o=t.player;if(o&&typeof o.getPlaylist=="function"){const r=o.getPlaylist(),a=o.getPlaylistIndex();(!r||r.length===0||a===r.length-1)&&setTimeout(()=>Un(n),200)}else setTimeout(()=>Un(n),200)}else setTimeout(()=>Un(n),200)}}function Un(e){const n=e.tubeStreamState;n&&(n.currentIndex++,n.currentIndex>=n.playlistData.length&&(n.currentIndex=0),Ci(e))}function va(){return new Promise(e=>{const n=new Image;n.onload=()=>e(!0),n.onerror=()=>e(!1),n.src="https://img.youtube.com/vi/qhCsL1cx4Qc/default.jpg?"+new Date().getTime()})}const xa={data:[{slug:"111",type:"playlist",playlist_id:"PLfznZzH31A46XXPSw2dcb-gqhMXcBMOHV",beginning_video_id:"qhCsL1cx4Qc",custom_parameters:"autoplay=true&loop=false"}]};async function Ii(){const e=document.getElementById("watercolour");if(e){const o=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,a)=>getComputedStyle(a).zIndex>getComputedStyle(r).zIndex?a:r);e.style.zIndex=`${parseInt(o.style.zIndex)+1}`;return}const n=Mi();ae("Watercolour",n,!1,"watercolour",!1,!1,{type:"integer",width:700,height:440},"app",null,"white").setAttribute("data-disable-desktop-pan","true"),Li()}async function Li(e){await Ai()}function Mi(){return`
<div id="watercolour-container" style="background-color: #f3f4f6; position: relative; height: calc(100% - 0.25rem); margin-top: -0.5rem; margin: 0; padding: 0;">
  <!-- Top Menu Bar -->
  <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background-color: white; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); border-bottom: 1px solid #e5e7eb;">
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <!-- File Dropdown Menu -->
      <div style="position: relative;">
        <button id="fileMenuBtn" style="padding: 0.25rem 0.75rem; border-radius: 0.25rem; border: 1px solid #d1d5db; background-color: white; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'" onclick="toggleFileDropdown(event)">
          File
          <svg style="width: 0.75rem; height: 0.75rem; pointer-events: none;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div id="fileDropdown" style="position: absolute; left: 0; top: 100%; margin-top: 0.25rem; width: 10rem; background-color: white; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 50; display: none;">
          <button id="loadBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; border-bottom: 1px solid #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">Open...</button>
          <button id="newBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; border-bottom: 1px solid #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">New</button>
          <button id="saveAsBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; border-bottom: 1px solid #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">Save</button>
          <button id="exportBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">Export...</button>
        </div>
      </div>

      <button id="undoBtn" style="padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #d1d5db; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">
        <svg style="height: 1rem; width: 1rem; display: inline;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
          <path style="opacity: 0.4;" d="M97.6 97.6c87.5-87.5 229.3-87.5 316.8 0C458.1 141.3 480 198.7 480 256s-21.9 114.7-65.6 158.4c-87.5 87.5-229.3 87.5-316.8 0l45.3-45.3c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L97.6 97.6z" />
          <path d="M176 224l24-24L40 40 16 64l0 160H176z" />
        </svg>
        <span class="undo-redo-text">Undo</span>
      </button>
      <button id="redoBtn" style="padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #d1d5db; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">
        <svg style="height: 1rem; width: 1rem; display: inline;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
          <path style="opacity: 0.4;" d="M32 256c0 57.3 21.9 114.7 65.6 158.4c87.5 87.5 229.3 87.5 316.8 0l-45.3-45.3c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3s163.8-62.5 226.3 0c15.1-15.1 30.2-30.2 45.3-45.3c-87.5-87.5-229.3-87.5-316.8 0C53.9 141.3 32 198.7 32 256z" />
          <path d="M336 224l-24-24L472 40l24 24 0 160H336z" />
        </svg>
        <span class="undo-redo-text">Redo</span>
      </button>
    </div>
    <div id="status" style="font-size: 0.75rem; color: #6b7280;">
      Tool: Brush | x: 0, y: 0
    </div>
  </div>

  <!-- Main Content Area -->
  <div id="watercolour-main-content" style="display: flex; flex-direction: column;">
    <div id="watercolour-workspace" style="display: flex; flex: 1;">
    <!-- Left Toolbar -->
    <div style="width: 3rem; padding: 0.5rem; background-color: white; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; gap: 0.5rem;">
      <button data-tool="brush" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='#f3f4f6'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/brush.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Brush</span>
      </button>
      <button data-tool="line" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/line.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Line</span>
      </button>
      <button data-tool="rectangle" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/rectangle.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Rectangle</span>
      </button>
      <button data-tool="ellipse" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/ellipse.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Ellipse</span>
      </button>
      <button data-tool="eraser" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/eraser.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Eraser</span>
      </button>
      <button data-tool="fill" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/fill.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Fill</span>
      </button>
      <button data-tool="picker" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/picker.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Picker</span>
      </button>
    </div>

    <!-- Canvas Container -->
    <div style="flex: 1; position: relative;">
      <canvas id="watercolourCanvas" width="420" height="300" style="background: white; margin: 0.5rem; margin-bottom: 2rem; position: absolute; inset: 0; border: 1px solid #d1d5db;"></canvas>
    </div>

    <!-- Right Panel: Color Palette & Stroke Size (Desktop) -->
    <div id="watercolour-color-panel" class="watercolour-color-panel-desktop" style="width: 8rem; padding: 0.5rem; background-color: white; border-left: 1px solid #e5e7eb; display: flex; flex-direction: column; gap: 1rem;">
      <!-- Color Palette -->
      <div style="display: flex; flex-direction: column; gap: 0.5rem;">
        <div id="watercolour-color-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.25rem;">
          <!-- 16 predefined colors -->
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #000000;" data-color="#000000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #808080;" data-color="#808080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #800000;" data-color="#800000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FF0000;" data-color="#FF0000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #808000;" data-color="#808000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FFFF00;" data-color="#FFFF00"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #008000;" data-color="#008000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #00FF00;" data-color="#00FF00"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #008080;" data-color="#008080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #00FFFF;" data-color="#00FFFF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #000080;" data-color="#000080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #0000FF;" data-color="#0000FF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #800080;" data-color="#800080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FF00FF;" data-color="#FF00FF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FFFFFF;" data-color="#FFFFFF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #C0C0C0;" data-color="#C0C0C0"></div>
        </div>
        <input id="colorPicker" type="color" style="width: 100%;" />
      </div>
      <!-- Stroke Size -->
      <div>
        <label for="strokeSize" style="font-size: 0.875rem;">Size</label>
        <input id="strokeSize" type="range" min="1" max="50" value="5" style="width: 100%;" aria-label="Brush stroke size" title="Adjust brush stroke size" />
      </div>
    </div>
    </div>

    <!-- Bottom Panel: Color Palette & Stroke Size (Mobile) -->
    <div id="watercolour-color-panel-mobile" class="watercolour-color-panel-mobile" style="display: none; width: 100%; padding: 0.5rem; background-color: white; border-top: 1px solid #e5e7eb;">
      <div style="display: flex; gap: 1rem; align-items: center; justify-content: space-around;">
        <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 0.25rem; flex-shrink: 0;">
          <!-- 16 predefined colors -->
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #000000;" data-color="#000000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #808080;" data-color="#808080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #800000;" data-color="#800000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FF0000;" data-color="#FF0000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #808000;" data-color="#808000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FFFF00;" data-color="#FFFF00"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #008000;" data-color="#008000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #00FF00;" data-color="#00FF00"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #008080;" data-color="#008080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #00FFFF;" data-color="#00FFFF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #000080;" data-color="#000080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #0000FF;" data-color="#0000FF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #800080;" data-color="#800080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FF00FF;" data-color="#FF00FF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FFFFFF;" data-color="#FFFFFF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #C0C0C0;" data-color="#C0C0C0"></div>
        </div>
        <input id="colorPickerMobile" type="color" style="width: 3rem; height: 3rem; border: 1px solid #d1d5db; cursor: pointer;" />
        <div style="display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0;">
          <label for="strokeSizeMobile" style="font-size: 0.875rem; white-space: nowrap;">Size</label>
          <input id="strokeSizeMobile" type="range" min="1" max="50" value="5" style="min-width: 80px;" aria-label="Brush stroke size" title="Adjust brush stroke size" />
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden text input for Text Tool -->
  <input type="text" id="textInput" style="position: absolute; border: 1px solid #9ca3af; padding: 0.25rem; display: none; font-size: 16px; line-height: 1; color: #000;" />
</div>
`}async function Ai(){window.toggleFileDropdown=function(y){y.stopPropagation();const v=document.getElementById("fileDropdown");v&&(v.style.display=v.style.display==="none"?"block":"none")},document.addEventListener("click",function(y){const v=document.getElementById("fileDropdown"),x=document.getElementById("fileMenuBtn");v&&x&&!x.contains(y.target)&&!v.contains(y.target)&&(v.style.display="none")});const e=document.getElementById("watercolourCanvas"),n=e.getContext("2d",{willReadFrequently:!0});let t=null,i=!1,o="brush",r,a,s="#000000",l=5,c=null,d=null,p=null;const m=document.getElementById("textInput"),u=document.getElementById("strokeSize"),f=document.getElementById("strokeSizeMobile"),g=document.getElementById("colorPicker"),w=document.getElementById("colorPickerMobile");let b=[],C=[];const h=y=>{l=y,n.lineWidth=l,u&&(u.value=y),f&&(f.value=y),o==="text"&&m.style.display==="block"&&(m.style.fontSize=`${l*4}px`),Ee().catch(console.error)};u&&u.addEventListener("input",y=>h(y.target.value)),f&&f.addEventListener("input",y=>h(y.target.value));const _=y=>{s=y,n.strokeStyle=s,n.fillStyle=s,g&&(g.value=y),w&&(w.value=y),o==="text"&&m.style.display==="block"&&(m.style.color=s),Ee().catch(console.error)};g&&g.addEventListener("change",y=>_(y.target.value)),w&&w.addEventListener("change",y=>_(y.target.value)),window.addEventListener("resize",S),document.body.addEventListener("touchmove",y=>{i&&y.preventDefault()},{passive:!1}),document.addEventListener("wheel",y=>{i&&y.preventDefault()},{passive:!1}),document.querySelectorAll(".tool-btn").forEach(y=>{y.addEventListener("click",()=>{document.querySelectorAll(".tool-btn").forEach(v=>v.classList.remove("bg-gray-100")),y.classList.add("bg-gray-100"),o=y.getAttribute("data-tool"),e.style.cursor=`url("./image/watercolour-icons/resized_${o}.png"), auto`,Ee().catch(console.error)})}),document.querySelectorAll("[data-color]").forEach(y=>{y.addEventListener("click",()=>{_(y.getAttribute("data-color"))})});let N=0;const j=3;function A(){if(N++,N>j){M();return}const y=document.getElementById("fileMenuBtn"),v=document.getElementById("fileDropdown"),x=document.getElementById("saveAsBtn");if(y&&v&&x){O();return}setTimeout(A,200)}function M(){const y=document.getElementById("loadBtn"),v=document.getElementById("newBtn"),x=document.getElementById("exportBtn");if(!y||!v||!x){console.error("Could not find expected buttons");return}y.addEventListener("click",()=>{te()}),v.addEventListener("click",()=>{showDialogBox("Clear canvas? Unsaved work will be lost.","confirmation",()=>{const k=e.offsetWidth,$=e.offsetHeight;n.clearRect(0,0,k,$),n.fillStyle="white",n.fillRect(0,0,k,$),c=e.toDataURL(),H(),p=null})}),x.addEventListener("click",()=>{const k=document.createElement("a");k.download="drawing.png",k.href=e.toDataURL(),k.click()})}function O(){const y=document.getElementById("fileMenuBtn"),v=document.getElementById("fileDropdown"),x=document.getElementById("saveAsBtn"),k=document.getElementById("loadBtn"),$=document.getElementById("newBtn"),L=document.getElementById("exportBtn");y.addEventListener("click",U=>{U.stopPropagation(),v.classList.toggle("hidden")}),document.addEventListener("click",U=>{!y.contains(U.target)&&!v.contains(U.target)&&v.classList.add("hidden")}),v.addEventListener("click",()=>{v.classList.add("hidden")}),x.addEventListener("click",async()=>{await re()}),k.addEventListener("click",()=>{te()}),$.addEventListener("click",()=>{showDialogBox("Clear canvas? Unsaved work will be lost.","confirmation",()=>{const U=e.offsetWidth,Y=e.offsetHeight;n.clearRect(0,0,U,Y),n.fillStyle="white",n.fillRect(0,0,U,Y),c=e.toDataURL(),H()})}),L.addEventListener("click",()=>{const U=document.createElement("a");U.download="drawing.png",U.href=e.toDataURL(),U.click()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",A):A(),e.addEventListener("pointerdown",y=>{y.preventDefault();const v=X(y);if(r=v.x,a=v.y,o==="fill"){H(),E(v.x,v.y,s),c=e.toDataURL(),H();return}if(i=!0,o==="brush"||o==="eraser")n.beginPath(),n.moveTo(r,a);else if(["line","rectangle","ellipse"].includes(o))d=document.createElement("canvas"),d.width=e.width,d.height=e.height,d.getContext("2d").drawImage(e,0,0);else if(o==="text"){const x=X(y);if(m.style.display==="block"){B();return}const k=e.getBoundingClientRect();m.style.left=k.left+x.x+"px",m.style.top=k.top+x.y+"px",m.style.display="block",m.style.fontSize=`${l*4}px`,m.style.color=s,m.dataset.x=x.x,m.dataset.y=x.y,setTimeout(()=>{m.focus(),m.onblur=B},0),m.onkeydown=$=>{$.key==="Enter"&&B()}}}),e.addEventListener("pointermove",y=>{const v=X(y);if(I(v.x,v.y),!!i){if(y.preventDefault(),o==="brush")n.lineTo(v.x,v.y),n.stroke();else if(o==="eraser")n.strokeStyle="white",n.lineTo(v.x,v.y),n.stroke(),n.strokeStyle=s;else if(["line","rectangle","ellipse"].includes(o)){const x=e.offsetWidth,k=e.offsetHeight;n.clearRect(0,0,x,k),d&&n.drawImage(d,0,0,x,k),D(v.x,v.y)}}}),e.addEventListener("pointerup",y=>{const v=X(y);i&&["line","rectangle","ellipse"].includes(o)&&D(v.x,v.y,!0),i=!1,c=e.toDataURL(),H(),d=null}),e.addEventListener("click",y=>{const v=X(y);if(o==="picker"){const x=window.devicePixelRatio||1,k=n.getImageData(Math.floor(v.x*x),Math.floor(v.y*x),1,1).data;s=ee(k[0],k[1],k[2]),n.strokeStyle=s,n.fillStyle=s,document.getElementById("colorPicker").value=s,Ee().catch(console.error)}}),document.getElementById("undoBtn").addEventListener("click",()=>{if(b.length>1){const y=b.pop();C.push(y);const v=b[b.length-1];Z(v),c=v,Ee().catch(console.error)}}),document.getElementById("redoBtn").addEventListener("click",()=>{if(C.length){const y=C.pop();b.push(y),Z(y),c=y,Ee().catch(console.error)}});function H(){const y=e.toDataURL();b.push(y),c=y,C=[],Ee().catch(console.error)}function Z(y){const v=new Image;v.src=y,v.alt="Watercolour painting canvas state",v.onload=()=>{const x=e.offsetWidth,k=e.offsetHeight;n.clearRect(0,0,x,k),n.drawImage(v,0,0,x,k)}}function X(y){const v=e.getBoundingClientRect();return{x:y.clientX-v.left,y:y.clientY-v.top}}function S(){const y=window.devicePixelRatio||1,v=e.offsetWidth,x=e.offsetHeight;if(n.getImageData(0,0,e.width,e.height),e.width=v*y,e.height=x*y,e.style.width=v+"px",e.style.height=x+"px",n.setTransform(y,0,0,y,0,0),c){const k=new Image;k.src=c,k.alt="Saved watercolour painting for canvas restoration",k.onload=()=>{n.clearRect(0,0,v,x),n.drawImage(k,0,0,v,x)}}else n.fillStyle="white",n.fillRect(0,0,v,x)}function I(y,v){const x=document.getElementById("status");x.textContent=`Tool: ${o.charAt(0).toUpperCase()+o.slice(1)} | x: ${Math.floor(y)}, y: ${Math.floor(v)}`}function B(){const y=parseFloat(m.dataset.x),v=parseFloat(m.dataset.y),x=m.value;m.style.display="none",m.value="",m.onblur=null,n.fillStyle=s,n.font=`${l*4}px sans-serif`,n.textBaseline="top",n.fillText(x,y,v),H()}function D(y,v,x=!1){const k=r,$=a,L=y-r,U=v-a;n.lineWidth=l,n.strokeStyle=s,n.fillStyle=s,o==="line"?(n.beginPath(),n.moveTo(k,$),n.lineTo(y,v),n.stroke()):o==="rectangle"?n.strokeRect(k,$,L,U):o==="ellipse"&&(n.beginPath(),n.ellipse(k+L/2,$+U/2,Math.abs(L/2),Math.abs(U/2),0,0,Math.PI*2),n.stroke())}function E(y,v,x){const k=window.devicePixelRatio||1,$=e.width,L=e.height,U=n.getImageData(0,0,$,L),Y=U.data,q=V(x),ce=q.r,ge=q.g,Be=q.b,Le=Math.floor(y*k),Ge=Math.floor(v*k),We=(Ge*$+Le)*4,et=Y[We],lt=Y[We+1],qe=Y[We+2],Ke=Y[We+3];if(et===ce&&lt===ge&&qe===Be)return;const ht=[[Le,Ge]];for(;ht.length;){const[Re,Nn]=ht.pop();let Te=Nn;for(;Te>=0&&F(Y,Re,Te,$,et,lt,qe,Ke);)Te--;Te++;let tt=!1,ct=!1;for(;Te<L&&F(Y,Re,Te,$,et,lt,qe,Ke);){const dt=(Te*$+Re)*4;Y[dt]=ce,Y[dt+1]=ge,Y[dt+2]=Be,Y[dt+3]=255,Re>0&&(F(Y,Re-1,Te,$,et,lt,qe,Ke)?tt||(ht.push([Re-1,Te]),tt=!0):tt=!1),Re<$-1&&(F(Y,Re+1,Te,$,et,lt,qe,Ke)?ct||(ht.push([Re+1,Te]),ct=!0):ct=!1),Te++}}n.putImageData(U,0,0)}function F(y,v,x,k,$,L,U,Y){const q=(x*k+v)*4;return y[q]===$&&y[q+1]===L&&y[q+2]===U&&y[q+3]===Y}function V(y){y=y.replace(/^#/,"");let v=parseInt(y,16);return y.length===3?{r:(v>>8)*17,g:(v>>4&15)*17,b:(v&15)*17}:{r:v>>16&255,g:v>>8&255,b:v&255}}function ee(y,v,x){return"#"+((1<<24)+(y<<16)+(v<<8)+x).toString(16).slice(1)}async function re(){try{const y=e.toDataURL("image/png"),v=globalStorage,x=globalAddFileToFileSystem;if(!v){showDialogBox("Cannot access storage. Please ensure the main OS is loaded.","error");return}const k=Date.now(),$=`watercolour_drawing_${k}`;await v.setItem($,y),makeWin95Prompt("Enter a filename for your drawing:",`drawing_${k}.png`,async L=>{if(L){const U=L.endsWith(".png")?L:L+".png",Y=ye();if(x){const q=y.split(",")[1],ce=atob(q),ge=new Uint8Array(ce.length);for(let We=0;We<ce.length;We++)ge[We]=ce.charCodeAt(We);const Be=new Blob([ge],{type:"image/png"}),Le=new File([Be],U,{type:"image/png"}),Ge=await x(U,y,Y,"png",Le);p={name:U,path:Y,storageKey:$,data:y},refreshExplorerViews&&refreshExplorerViews(),Y==="C://Desktop"&&renderDesktopIcons&&renderDesktopIcons(),showDialogBox(`Drawing saved as "${U}" in ${Y}!`,"info")}else showDialogBox("File system not available. Drawing saved to storage only.","info")}else showDialogBox("Drawing saved to storage but not added to file system.","info")},()=>{showDialogBox("Drawing saved to storage but not added to file system.","info")})}catch(y){console.error("Error saving drawing:",y),showDialogBox("Error saving drawing: "+y.message,"error")}}function te(){if(openFileExplorerForImageSelection)openFileExplorerForImageSelection((y,v)=>{y&&ne(y,v)});else if(ae&&getExplorerWindowContent){window.watercolourLoadCallback=(v,x)=>{v&&ne(v,x)};const y=getExplorerWindowContent("C://Documents");ae("Select Image - File Explorer",y,!0,"explorer-watercolour-load",!1,!1,{type:"integer",width:600,height:500},"file-explorer"),showDialogBox("Select an image file from the file explorer to load it onto the canvas.","info")}else showDialogBox("File explorer not available. Please ensure the main OS is loaded.","error")}function ne(y,v=null){const x=new Image;x.alt="Image to be loaded onto watercolour canvas",x.onload=()=>{const k=e.offsetWidth,$=e.offsetHeight;n.clearRect(0,0,k,$),n.fillStyle="white",n.fillRect(0,0,k,$);const L=Math.min(k/x.width,$/x.height),U=x.width*L,Y=x.height*L,q=(k-U)/2,ce=($-Y)/2;n.drawImage(x,q,ce,U,Y),c=e.toDataURL(),H()},x.onerror=()=>{console.error("Error loading selected image."),showDialogBox("Error loading selected image.","error")},x.src=y,x.alt="User-selected image to import into watercolour canvas"}function ye(){if(parent&&parent.document){const y=parent.document.querySelectorAll(".file-explorer-window");if(y.length>0){const x=y[y.length-1].getAttribute("data-current-path");if(x)return x}}return"C://Documents"}async function Ee(){try{const y={currentTool:o,activeColor:s,strokeSize:l,canvasData:e.toDataURL(),currentFile:p,undoStack:b.slice(-10),redoStack:C.slice(-10)};await storage.setItem("watercolour_state",y)}catch(y){console.warn("Failed to save Watercolour state:",y);try{const v={currentTool:o,activeColor:s,strokeSize:l,canvasData:e.toDataURL(),currentFile:p,undoStack:b.slice(-10),redoStack:C.slice(-10)};storage.setItemSync("watercolour_state",v)}catch(v){console.error("Failed to save Watercolour state with fallback:",v)}}}async function we(){try{const y=await storage.getItem("watercolour_state");if(y)return y}catch(y){console.warn("Failed to load Watercolour state:",y);try{const v=storage.getItemSync("watercolour_state");if(v)return v}catch(v){console.warn("Failed to load Watercolour state with fallback:",v)}}return null}async function R(){t=await we(),t&&(o=t.currentTool||"brush",s=t.activeColor||"#000000",l=t.strokeSize||5,p=t.currentFile||null,b=t.undoStack||[],C=t.redoStack||[]);const y=window.devicePixelRatio||1,v=e.offsetWidth,x=e.offsetHeight;e.width=v*y,e.height=x*y,e.style.width=v+"px",e.style.height=x+"px",n.setTransform(y,0,0,y,0,0),u&&(u.value=l),g&&(g.value=s),n.strokeStyle=s,n.fillStyle=s,n.lineWidth=l,document.querySelectorAll(".tool-btn").forEach($=>{$.classList.remove("bg-gray-100"),$.getAttribute("data-tool")===o&&$.classList.add("bg-gray-100")});const k=t==null?void 0:t.canvasData;if(k){const $=new Image;$.alt="Saved watercolour canvas state for restoration",$.onload=function(){n.clearRect(0,0,v,x),n.drawImage($,0,0,v,x)},$.src=k}else n.fillStyle="white",n.fillRect(0,0,v,x),H()}await R()}function ka(e,n){const t={C:"Clear all",CE:"Clear entry","¬±":"Change sign","‚àö":"Square root","%":"Percent","1/x":"Reciprocal","=":"Equals","+":"Plus","-":"Minus","√ó":"Multiply","√∑":"Divide",".":"Decimal point"};return t[e]?t[e]:n==="number"?`Number ${e}`:n==="operator"?`Operator ${e}`:e}function Di(){const e=document.getElementById("calculator");if(e){const i=[...document.querySelectorAll("*")].filter(o=>getComputedStyle(o).zIndex>100&&getComputedStyle(o).zIndex<1e3).reduce((o,r)=>getComputedStyle(r).zIndex>getComputedStyle(o).zIndex?r:o);e.style.zIndex=`${parseInt(i.style.zIndex)+1}`;return}const n=ae("Calculator","",!1,"calculator",!1,!1,{type:"integer",width:250,height:360},"App",null,"gray-100");Bi(n).catch(t=>{console.error("Error initializing Calculator:",t)})}async function Bi(e){const n=e.querySelector(".p-2");n.className="p-4 bg-gray-100 h-full overflow-hidden",n.innerHTML="";let t=await Sa();t||(t={display:"0",previousValue:null,operation:null,waitingForOperand:!1});const i=document.createElement("div");i.className="flex flex-col h-full space-y-1 pb-6";const o=document.createElement("div");o.className="bg-white border-2 p-2 mb-2",o.style.borderTopColor="#808080",o.style.borderLeftColor="#808080",o.style.borderBottomColor="#ffffff",o.style.borderRightColor="#ffffff";const r=document.createElement("div");r.id="calc-display",r.className="text-right text-lg font-mono bg-white text-black min-h-6 px-1",r.textContent=t.display,o.appendChild(r);const a=document.createElement("div");a.className="grid grid-cols-4 gap-1 flex-1",[{text:"C",type:"clear",className:"col-span-2"},{text:"¬±",type:"sign"},{text:"/",type:"operator"},{text:"7",type:"number"},{text:"8",type:"number"},{text:"9",type:"number"},{text:"*",type:"operator"},{text:"4",type:"number"},{text:"5",type:"number"},{text:"6",type:"number"},{text:"-",type:"operator"},{text:"1",type:"number"},{text:"2",type:"number"},{text:"3",type:"number"},{text:"+",type:"operator"},{text:"0",type:"number",className:"col-span-2"},{text:".",type:"decimal"},{text:"=",type:"equals"}].forEach(u=>{const f=document.createElement("button");f.textContent=u.text,f.className=`bg-gray-200 border-2 hover:bg-gray-300 font-mono text-sm py-2 select-none ${u.className||""}`,f.style.borderTopColor="#ffffff",f.style.borderLeftColor="#ffffff",f.style.borderBottomColor="#808080",f.style.borderRightColor="#808080",f.style.transition="none";const g=ka(u.text,u.type);f.setAttribute("aria-label",g),f.setAttribute("title",g),f.addEventListener("mousedown",()=>{f.style.borderTopColor="#808080",f.style.borderLeftColor="#808080",f.style.borderBottomColor="#ffffff",f.style.borderRightColor="#ffffff",f.classList.add("bg-gray-300")}),f.addEventListener("mouseup",()=>{f.style.borderTopColor="#ffffff",f.style.borderLeftColor="#ffffff",f.style.borderBottomColor="#808080",f.style.borderRightColor="#808080",f.classList.remove("bg-gray-300")}),f.addEventListener("mouseleave",()=>{f.style.borderTopColor="#ffffff",f.style.borderLeftColor="#ffffff",f.style.borderBottomColor="#808080",f.style.borderRightColor="#808080",f.classList.remove("bg-gray-300")}),f.addEventListener("click",async()=>await c(u.text,u.type)),a.appendChild(f)}),i.appendChild(o),i.appendChild(a),n.appendChild(i);async function l(){r.textContent=t.display,await Ea(t)}async function c(u,f){switch(f){case"number":t.waitingForOperand?(t.display=u,t.waitingForOperand=!1):t.display=t.display==="0"?u:t.display+u;break;case"decimal":t.waitingForOperand?(t.display="0.",t.waitingForOperand=!1):t.display.indexOf(".")===-1&&(t.display+=".");break;case"clear":t.display="0",t.previousValue=null,t.operation=null,t.waitingForOperand=!1;break;case"sign":t.display!=="0"&&(t.display=t.display.charAt(0)==="-"?t.display.slice(1):"-"+t.display);break;case"operator":const g=parseFloat(t.display);if(t.previousValue===null)t.previousValue=g;else if(t.operation){const b=t.previousValue||0,C=d(b,g,t.operation);t.display=String(C),t.previousValue=C}t.waitingForOperand=!0,t.operation=u;break;case"equals":const w=parseFloat(t.display);if(t.previousValue!==null&&t.operation){const b=t.previousValue||0,C=d(b,w,t.operation);t.display=String(C),t.previousValue=null,t.operation=null,t.waitingForOperand=!0}break}await l()}function d(u,f,g){switch(g){case"+":return u+f;case"-":return u-f;case"*":return u*f;case"/":return f!==0?u/f:0;default:return f}}async function p(u){const f=u.key;/[0-9]/.test(f)?await c(f,"number"):["+","-","*","/"].includes(f)?await c(f,"operator"):f==="."?await c(f,"decimal"):f==="Enter"||f==="="?await c("=","equals"):f==="Escape"||f==="c"||f==="C"?await c("C","clear"):f==="Backspace"&&(t.display.length>1?t.display=t.display.slice(0,-1):t.display="0",await l())}document.addEventListener("keydown",p);const m=new MutationObserver(u=>{u.forEach(f=>{f.removedNodes.forEach(g=>{g.id==="calculator"&&(document.removeEventListener("keydown",p),m.disconnect())})})});m.observe(document.getElementById("windows-container"),{childList:!0})}async function Ea(e){try{await z.setItem("calculator_state",e)}catch(n){console.warn("Failed to save Calculator state:",n)}}async function Sa(){try{const e=await z.getItem("calculator_state");if(e)return e}catch(e){console.warn("Failed to load Calculator state:",e)}return null}function Ti(){const e=document.getElementById("solitaire");if(e){const i=[...document.querySelectorAll("*")].filter(o=>getComputedStyle(o).zIndex>100&&getComputedStyle(o).zIndex<1e3).reduce((o,r)=>getComputedStyle(r).zIndex>getComputedStyle(o).zIndex?r:o);e.style.zIndex=`${parseInt(i.style.zIndex)+1}`;return}const n=ae("Solitaire","",!1,"solitaire",!1,!1,{type:"integer",width:700,height:500},"App",null,"green");Fi(n).catch(console.error)}async function Fi(e){const n=e.querySelector(".p-2");n.className="bg-green-600 h-full overflow-hidden",n.style.backgroundImage="radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1) 0%, transparent 50%)",n.innerHTML="";let t=await Ca();t||(t={deck:[],waste:[],foundations:[[],[],[],[]],tableaus:[[],[],[],[],[],[],[]],score:0,moves:0,time:0,gameStarted:!1,selectedCard:null,selectedPile:null,dragElement:null,drawCount:1});let i=null,o=await z.getItem("solitaire-high-score")||0;const r=["‚ô†","‚ô£","‚ô•","‚ô¶"],a=["A","2","3","4","5","6","7","8","9","10","J","Q","K"],s={"‚ô†":"black","‚ô£":"black","‚ô•":"red","‚ô¶":"red"},l=document.createElement("div");l.className="flex flex-col h-full";const c=document.createElement("div");c.className="bg-gray-200 border-b border-gray-400 p-1 flex flex-wrap md:flex-nowrap items-center gap-2 md:gap-4";const d=document.createElement("button");d.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",d.textContent="Game",d.setAttribute("aria-label","Game menu options"),d.setAttribute("title","Access game options and settings");const p=document.createElement("button");p.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",p.textContent="New Game",p.setAttribute("aria-label","Start new solitaire game"),p.setAttribute("title","Start a new game of solitaire"),p.addEventListener("click",ne);const m=document.createElement("select");m.className="ml-2 text-sm border rounded p-1 bg-white";const u=document.createElement("option");u.value="1",u.text="Easy (Draw 1)";const f=document.createElement("option");f.value="3",f.text="Normal (Draw 3)",m.appendChild(u),m.appendChild(f),m.title="Select difficulty / draw count",m.value=t.drawCount?String(t.drawCount):"1",m.addEventListener("change",R=>{t.drawCount=parseInt(R.target.value,10),Xe(t).catch(console.error)});const g=document.createElement("div");g.className="text-xs md:text-sm font-mono ml-auto flex space-x-2 md:space-x-4",g.innerHTML=`<span>Score: <span id="score">0</span></span><span>High: <span id="high-score">${o}</span></span><span>Time: <span id="time">0:00</span></span>`,c.appendChild(p),c.appendChild(m),c.appendChild(g);const w=document.createElement("div");w.className="flex-1 p-2 md:p-4 relative overflow-scroll",w.id="solitaire-game-area";const b=document.createElement("div");b.className="lg:flex justify-between mb-6";const C=document.createElement("div");C.className="flex space-x-4 mb-4 lg:mb-0";const h=document.createElement("div");h.className="w-12 h-[4.5rem] md:w-16 md:h-24 border-2 border-gray-400 rounded bg-blue-800 flex items-center justify-center cursor-pointer",h.style.borderStyle="outset",h.id="deck-slot",h.addEventListener("click",Z);const _=document.createElement("div");_.className="w-12 h-[4.5rem] md:w-16 md:h-24 border-2 border-gray-400 rounded bg-green-700 relative",_.style.borderStyle="inset",_.id="waste-slot",C.appendChild(h),C.appendChild(_);const N=document.createElement("div");N.className="flex space-x-2";for(let R=0;R<4;R++){const y=document.createElement("div");y.className="w-12 h-[4.5rem] md:w-16 md:h-24 border-2 border-gray-400 rounded bg-green-700 relative",y.style.borderStyle="inset",y.id=`foundation-${R}`,y.dataset.foundationIndex=R,y.addEventListener("click",v=>void 0),N.appendChild(y)}b.appendChild(C),b.appendChild(N);const j=document.createElement("div");j.className="flex space-x-2";for(let R=0;R<7;R++){const y=document.createElement("div");y.className="w-12 min-h-[6rem] md:w-16 md:min-h-32 relative",y.id=`tableau-${R}`,y.dataset.tableauIndex=R,y.addEventListener("click",v=>void 0),j.appendChild(y)}w.appendChild(b),w.appendChild(j),l.appendChild(c),l.appendChild(w),n.appendChild(l);function A(R,y,v=!0){const x=document.createElement("div");if(x.className="card absolute w-12 h-[4.5rem] md:w-16 md:h-24 border border-gray-800 rounded bg-white cursor-pointer transition-all duration-200 text-[10px] md:text-xs",x.style.fontFamily="ui-serif, Georgia, 'Cambria', 'Times New Roman', Times, serif",x.style.userSelect="none",x.style.pointerEvents="auto",x.dataset.suit=R,x.dataset.value=y,x.dataset.faceUp=v,v){const k=s[R];x.style.color=k,x.innerHTML=`
        <div class="p-0.5 md:p-1 h-full flex flex-col justify-between leading-none">
          <div class="flex justify-between items-center">
            <span class="font-bold text-xs md:text-sm">${y}</span>
            <span class="text-sm md:text-lg">${R}</span>
          </div>
          <div class="text-center text-xl md:text-2xl">${R}</div>
          <div class="flex justify-between items-center rotate-180">
            <span class="font-bold text-xs md:text-sm">${y}</span>
            <span class="text-sm md:text-lg">${R}</span>
          </div>
        </div>
      `}else x.style.background="linear-gradient(45deg, #000080, #0000cd)",x.style.color="white",x.innerHTML=`
        <div class="w-full h-full flex items-center justify-center text-xs">
          <div class="text-center">‚ô†‚ô•‚ô¶‚ô£</div>
        </div>
      `;return x.addEventListener("mousedown",X),x.addEventListener("touchstart",X,{passive:!1}),x.addEventListener("dblclick",I),x}function M(){t.deck=[];for(const R of r)for(const y of a)t.deck.push({suit:R,value:y});for(let R=t.deck.length-1;R>0;R--){const y=Math.floor(Math.random()*(R+1));[t.deck[R],t.deck[y]]=[t.deck[y],t.deck[R]]}}function O(){t.waste=[],t.foundations=[[],[],[],[]],t.tableaus=[[],[],[],[],[],[],[]];for(let R=0;R<7;R++)for(let y=0;y<=R;y++){const v=t.deck.pop();v.faceUp=y===R,t.tableaus[R].push(v)}H(),Xe(t).catch(console.error)}function H(){document.querySelectorAll(".card").forEach(v=>v.remove());const R=document.getElementById("deck-slot");t.deck.length>0?(R.innerHTML="üÇ†",R.style.fontSize="40px",R.style.color="white"):(R.innerHTML="‚Üª",R.style.fontSize="24px",R.style.color="white");const y=document.getElementById("waste-slot");if(y.innerHTML="",t.waste.length>0){const v=t.waste[t.waste.length-1],x=A(v.suit,v.value,!0);x.classList.add("card"),x.style.position="absolute",x.style.top="0",x.style.left="0",y.appendChild(x)}for(let v=0;v<4;v++){const x=document.getElementById(`foundation-${v}`);x.innerHTML="";const k=r[v];if(x.innerHTML=`<div class="absolute inset-0 flex items-center justify-center text-4xl text-gray-500 opacity-30">${k}</div>`,t.foundations[v].length>0){const $=t.foundations[v][t.foundations[v].length-1],L=A($.suit,$.value,!0);L.classList.add("card"),L.style.position="absolute",L.style.top="0",L.style.left="0",x.appendChild(L)}}for(let v=0;v<7;v++){const x=document.getElementById(`tableau-${v}`);x.innerHTML="",t.tableaus[v].length===0&&(x.innerHTML='<div class="w-12 h-[4.5rem] md:w-16 md:h-24 border-2 border-gray-400 border-dashed rounded bg-green-700 opacity-50"></div>'),t.tableaus[v].forEach((k,$)=>{const L=A(k.suit,k.value,k.faceUp);L.classList.add("card"),L.style.position="absolute";const U=window.innerWidth<768?15:20;L.style.top=`${$*U}px`,L.style.left="0",L.style.zIndex=$+1,L.dataset.tableauIndex=v,L.dataset.cardIndex=$,x.appendChild(L)})}te()}function Z(){const R=t.drawCount||1;if(t.deck.length>0){for(let y=0;y<R&&t.deck.length!==0;y++){const v=t.deck.pop();v.faceUp=!0,t.waste.push(v)}t.moves++}else t.waste.length>0&&(t.deck=t.waste.reverse(),t.deck.forEach(y=>y.faceUp=!1),t.waste=[],t.moves++);H(),Xe(t).catch(console.error)}function X(R){let y=R.target;for(;y&&y!==document.body&&!(y.classList&&y.classList.contains("card"));)y=y.parentElement;if(!y||!y.classList.contains("card")||y.dataset.faceUp!=="true")return;R.preventDefault(),R.stopPropagation(),t.selectedCard=y,t.dragElement=y.cloneNode(!0),t.dragElement.style.position="fixed",t.dragElement.style.pointerEvents="none",t.dragElement.style.zIndex="1000",t.dragElement.style.transition="none",t.dragElement.style.left="0",t.dragElement.style.top="0";const v=R.type==="touchstart"?R.touches[0]:R,x=32,k=48;t.dragElement.style.transform=`translate3d(${v.clientX-x}px, ${v.clientY-k}px, 0) rotate(5deg)`,document.body.appendChild(t.dragElement),y.style.opacity="0.5";const $=document.body.style.touchAction;document.body.style.touchAction="none";let L=null;function U(q){q.cancelable&&q.preventDefault();const ce=q.type&&q.type.startsWith("touch")?q.touches[0]:q;t.dragElement&&(L&&cancelAnimationFrame(L),L=requestAnimationFrame(()=>{t.dragElement&&(t.dragElement.style.transform=`translate3d(${ce.clientX-x}px, ${ce.clientY-k}px, 0) rotate(5deg)`)}))}function Y(q){if(document.removeEventListener("mousemove",U),document.removeEventListener("mouseup",Y),document.removeEventListener("touchmove",U),document.removeEventListener("touchend",Y),L&&(cancelAnimationFrame(L),L=null),t.dragElement&&document.body.contains(t.dragElement)&&(document.body.removeChild(t.dragElement),t.dragElement=null),document.body.style.touchAction=$||"",t.selectedCard){t.selectedCard.style.opacity="1";const ce=q.type==="touchend"?q.changedTouches[0]:q,ge=document.elementFromPoint(ce.clientX,ce.clientY);S(ge),t.selectedCard=null}}document.addEventListener("mousemove",U),document.addEventListener("mouseup",Y),document.addEventListener("touchmove",U,{passive:!1}),document.addEventListener("touchend",Y)}function S(R){const y=t.selectedCard;if(!y||!R)return;let v=R,x=null,k=null;for(;v&&v!==document.body;){if(v.id&&v.id.startsWith("foundation-")){x=v,k="foundation";break}if(v.dataset&&v.dataset.tableauIndex!==void 0){x=v,k="tableau";break}if(v.classList&&v.classList.contains("card")&&v.dataset.tableauIndex!==void 0){x=v.parentElement,k="tableau";break}v=v.parentElement}if(x&&k==="foundation"){const $=parseInt(x.dataset.foundationIndex);B(y,$)&&E(y)}else if(x&&k==="tableau"){const $=parseInt(x.dataset.tableauIndex);D(y,$)&&F(y,$)}}function I(R){let y=R.target;for(;y&&!y.classList.contains("card");)y=y.parentElement;if(!(!y||y.dataset.faceUp!=="true")){for(let v=0;v<4;v++)if(B(y,v)){E(y);return}}}function B(R,y){const v=R.dataset.suit,x=R.dataset.value,k=t.foundations[y],$=r[y];if(v!==$){const L=r.indexOf(v);return L!==-1&&t.foundations[L].length===0?x==="A":!1}if(k.length===0)return x==="A";{const L=k[k.length-1],U=a.indexOf(L.value);return a.indexOf(x)===U+1}}function D(R,y){const v=R.dataset.suit,x=R.dataset.value,k=t.tableaus[y];if(k.length===0)return x==="K";const $=k[k.length-1];if(!$.faceUp)return!1;const L=s[$.suit],U=s[v],Y=a.indexOf($.value),q=a.indexOf(x);return L!==U&&q===Y-1}function E(R,y){const v=R.dataset.suit,x=r.indexOf(v);if(x===-1)return;V(R);const k={suit:v,value:R.dataset.value,faceUp:!0};t.foundations[x].push(k),t.moves++,t.score+=10,H(),Ee(),Xe(t).catch(console.error)}function F(R,y){const v=V(R,!0);t.tableaus[y].push(...v),t.moves++,H(),Xe(t).catch(console.error)}function V(R,y=!1){const v=R.dataset.suit,x=R.dataset.value;if(t.waste.length>0&&t.waste[t.waste.length-1].suit===v&&t.waste[t.waste.length-1].value===x)return[t.waste.pop()];for(let k=0;k<7;k++){const $=t.tableaus[k],L=$.findIndex(U=>U.suit===v&&U.value===x);if(L!==-1){const U=y?$.length-L:1,Y=$.splice(L,U);return $.length>0&&!$[$.length-1].faceUp&&($[$.length-1].faceUp=!0,t.score+=5,Xe(t).catch(console.error)),Y}}return[]}function ee(R,y){}function re(R,y){}function te(){if(document.getElementById("score").textContent=t.score,t.gameStarted){const R=Math.floor(t.time/60),y=t.time%60;document.getElementById("time").textContent=`${R}:${y.toString().padStart(2,"0")}`}}function ne(){t.score=0,t.moves=0,t.time=0,t.gameStarted=!0,i&&clearInterval(i),i=setInterval(()=>{t.time++,te(),Xe(t).catch(console.error)},1e3),M(),O(),Ia().catch(console.error)}function ye(){t.gameStarted&&(i=setInterval(()=>{t.time++,te(),Xe(t).catch(console.error)},1e3)),te(),H()}function Ee(){t.foundations.reduce((y,v)=>y+v.length,0)===52&&(i&&clearInterval(i),Xe(t).catch(console.error),t.score>o&&(o=t.score,z.setItemSync("solitaire-high-score",o),document.getElementById("high-score").textContent=o,window.isDevvit&&window.parent.postMessage({type:"setGameScore",data:{game:"solitaire",score:o}},"*")),setTimeout(()=>{La()},500))}const we=new MutationObserver(R=>{R.forEach(y=>{y.removedNodes.forEach(v=>{v.id==="solitaire"&&(i&&clearInterval(i),we.disconnect())})})});we.observe(document.getElementById("windows-container"),{childList:!0}),!t.gameStarted||t.deck.length===0?ne():ye()}async function Xe(e){try{const n={...e,selectedCard:null,selectedPile:null,dragElement:null};await z.setItem("solitaire_gameState",n)}catch(n){console.warn("Failed to save Solitaire game state:",n);try{const t={...e,selectedCard:null,selectedPile:null,dragElement:null};z.setItemSync("solitaire_gameState",t)}catch(t){console.error("Failed to save Solitaire game state with fallback:",t)}}}async function Ca(){try{const e=await z.getItem("solitaire_gameState");if(e){const n=e;return n.selectedCard=null,n.selectedPile=null,n.dragElement=null,n}}catch(e){console.warn("Failed to load Solitaire game state:",e);try{const n=z.getItemSync("solitaire_gameState");if(n){const t=n;return t.selectedCard=null,t.selectedPile=null,t.dragElement=null,t}}catch(n){console.warn("Failed to load Solitaire game state with fallback:",n)}}return null}async function Ia(){try{await z.removeItem("solitaire_gameState")}catch(e){console.warn("Failed to clear Solitaire game state:",e);try{z.removeItemSync("solitaire_gameState")}catch(n){console.error("Failed to clear Solitaire game state with fallback:",n)}}}function La(){const e=document.createElement("canvas");e.id="solitaire-win-canvas",Object.assign(e.style,{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",zIndex:9999,pointerEvents:"none"}),document.body.appendChild(e);const n=e.getContext("2d");e.width=window.innerWidth,e.height=window.innerHeight;const t=["‚ô†","‚ô•","‚ô£","‚ô¶"],i=["A","2","3","4","5","6","7","8","9","10","J","Q","K"],o={"‚ô†":"black","‚ô£":"black","‚ô•":"red","‚ô¶":"red"},r=[],a=.2,s=75,l=100,c=.02;let d=0,p,m=!0;const u=setInterval(()=>{if(d===52)return clearInterval(u);const g=t[d%4],w=i[Math.floor(d/4)];r.push({x:Math.random()*e.width,y:-50,vx:(Math.random()-.5)*4,vy:Math.random()*2,suit:g,value:w,color:o[g]}),d++},100);function f(){n.fillStyle=`rgba(10,100,10,${c})`,n.fillRect(0,0,e.width,e.height),r.forEach(g=>{g.vy+=a,g.x+=g.vx,g.y+=g.vy,g.y>e.height-l&&(g.y=e.height-l,g.vy*=-.7),n.fillStyle="white",n.fillRect(g.x,g.y,s,l),n.strokeStyle="#333",n.strokeRect(g.x,g.y,s,l),n.fillStyle=g.color,n.font="24px sans-serif",n.fillText(g.value+g.suit,g.x+10,g.y+30)}),m&&(p=requestAnimationFrame(f))}f(),setTimeout(()=>{m=!1,clearInterval(u),cancelAnimationFrame(p),document.body.removeChild(e),showDialogBox("Congratulations! You won!","confirmation")},8e3)}function Pi(){const e=document.getElementById("chess");if(e){const a=[...document.querySelectorAll("*")].filter(s=>getComputedStyle(s).zIndex>100&&getComputedStyle(s).zIndex<1e3).reduce((s,l)=>getComputedStyle(l).zIndex>getComputedStyle(s).zIndex?l:s);e.style.zIndex=`${parseInt(a.style.zIndex)+1}`;return}const n=window.innerWidth<600,t=n?Math.min(window.innerWidth-20,600):600,i=n?Math.min(window.innerHeight-60,690):690,o=ae("Guillotine Chess","",!1,"chess",!1,!1,{type:"integer",width:t,height:i},"App",null,"white");$i(o).catch(r=>{console.error("Error initializing Chess:",r)})}async function $i(e){const n=e.querySelector(".p-2");n.className="p-4 bg-white h-full overflow-hidden",n.innerHTML="";let t=await Ra();t||(t={board:Vo(),currentPlayer:"white",difficulty:"easy",gameOver:!1,winner:null,moveHistory:[],selectedSquare:null,possibleMoves:[],gameStarted:!0,enPassantTarget:null,halfMoveClock:0,fullMoveNumber:1});const i=document.createElement("div");i.className="flex flex-col h-full";const o=document.createElement("div");o.className="flex justify-between items-center mb-4 p-2 bg-gray-100 rounded",o.innerHTML=`
    <div class="flex items-center space-x-4">
      <span class="font-semibold">Difficulty: <span id="difficulty-dropdown-container"></span></span>
      <span class="font-semibold">Turn: <span class="text-${t.currentPlayer==="white"?"gray-800":"gray-600"}">${t.currentPlayer.charAt(0).toUpperCase()+t.currentPlayer.slice(1)}</span></span>
    </div>
    <div class="space-x-2" id="button-container">
    </div>
  `,i.appendChild(o);const a=Ha([{value:"easy",text:"Easy"},{value:"medium",text:"Medium"},{value:"hard",text:"Hard"}],t.difficulty,async f=>{t.difficulty=f,await gn(t)});a.id="difficulty-select",a.className+=" ml-1",o.querySelector("#difficulty-dropdown-container").appendChild(a);const s=_a("New Game");s.id="new-game-btn",o.querySelector("#button-container").appendChild(s);const l=document.createElement("div");l.className="flex-1 flex items-center justify-center";const c=document.createElement("div");c.id="chess-board",c.className="grid grid-cols-8 border-4 border-gray-800";const p=window.innerWidth<600?Math.min(window.innerWidth-60,480):480,m=p/8;c.style.width=`${p}px`,c.style.height=`${p}px`,c.style.gap="0";for(let f=0;f<8;f++)for(let g=0;g<8;g++){const w=document.createElement("div");w.className=`chess-square flex items-center justify-center cursor-pointer text-4xl font-bold select-none ${(f+g)%2===0?"bg-amber-100":"bg-amber-600"}`,w.style.width=`${m}px`,w.style.height=`${m}px`,w.dataset.row=f,w.dataset.col=g;const b=t.board[f][g];b&&(w.textContent=zi(b),w.style.color=b.color==="white"?"#000":"#444"),w.addEventListener("click",async()=>await Ma(f,g,t,e)),c.appendChild(w)}l.appendChild(c),i.appendChild(l);const u=document.createElement("div");u.id="status-bar",u.className="mt-4 p-2 text-center",t.gameOver?u.innerHTML=`<span class="text-lg font-bold text-green-600">Game Over! ${t.winner?t.winner.charAt(0).toUpperCase()+t.winner.slice(1)+" wins!":"Draw!"}</span>`:u.innerHTML='<span class="text-gray-600">Guillotine Chess: Capture the King to win! Kings can be captured like any other piece.</span>',i.appendChild(u),o.querySelector("#new-game-btn").addEventListener("click",async()=>{t.board=Vo(),t.currentPlayer="white",t.gameOver=!1,t.winner=null,t.moveHistory=[],t.selectedSquare=null,t.possibleMoves=[],await gn(t),uo(t,e)}),n.appendChild(i),mn(t),t.currentPlayer==="black"&&!t.gameOver&&setTimeout(async()=>await Ri(t,e),500)}function uo(e,n){const t=n.querySelector("#difficulty-select");t&&(t.value=e.difficulty);const i=n.querySelector(".text-gray-800, .text-gray-600");i&&i.parentElement&&i.parentElement.textContent.includes("Turn:")&&(i.textContent=e.currentPlayer.charAt(0).toUpperCase()+e.currentPlayer.slice(1),i.className=e.currentPlayer==="white"?"text-gray-800":"text-gray-600"),document.querySelectorAll(".chess-square").forEach(a=>{const s=parseInt(a.dataset.row),l=parseInt(a.dataset.col),c=e.board[s][l];c?(a.textContent=zi(c),a.style.color=c.color==="white"?"#000":"#444"):a.textContent=""});const r=n.querySelector("#status-bar");r&&(e.gameOver?r.innerHTML=`<span class="text-lg font-bold text-green-600">Game Over! ${e.winner?e.winner.charAt(0).toUpperCase()+e.winner.slice(1)+" wins!":"Draw!"}</span>`:r.innerHTML='<span class="text-gray-600">Guillotine Chess: Capture the King to win! Kings can be captured like any other piece.</span>'),e.selectedSquare=null,e.possibleMoves=[],mn(e),e.currentPlayer==="black"&&!e.gameOver&&setTimeout(async()=>await Ri(e,n),500)}function Vo(){const e=Array(8).fill(null).map(()=>Array(8).fill(null)),n=["rook","knight","bishop","queen","king","bishop","knight","rook"];for(let t=0;t<8;t++)e[0][t]={type:n[t],color:"black"},e[1][t]={type:"pawn",color:"black"};for(let t=0;t<8;t++)e[6][t]={type:"pawn",color:"white"},e[7][t]={type:n[t],color:"white"};return e}function zi(e){return{white:{king:"‚ôî",queen:"‚ôï",rook:"‚ôñ",bishop:"‚ôó",knight:"‚ôò",pawn:"‚ôô"},black:{king:"‚ôö",queen:"‚ôõ",rook:"‚ôú",bishop:"‚ôù",knight:"‚ôû",pawn:"‚ôü"}}[e.color][e.type]}async function Ma(e,n,t,i){if(t.gameOver||t.currentPlayer==="black")return;const o=t.board[e][n];if(t.selectedSquare){const[r,a]=t.selectedSquare;if(r===e&&a===n){t.selectedSquare=null,t.possibleMoves=[],mn(t);return}if(t.possibleMoves.some(s=>s.row===e&&s.col===n)){Vt(t,r,a,e,n),t.selectedSquare=null,t.possibleMoves=[],t.gameOver||(t.currentPlayer=t.currentPlayer==="white"?"black":"white"),await gn(t),qi(t)&&(t.gameOver=!0,t.winner=Ui(t),Yi(t)),uo(t,i);return}}o&&o.color===t.currentPlayer&&(t.selectedSquare=[e,n],t.possibleMoves=Ni(t,e,n),mn(t))}function mn(e){const n=document.querySelectorAll(".chess-square"),o=(window.innerWidth<600?Math.min(window.innerWidth-60,480):480)/8;n.forEach(r=>{const a=parseInt(r.dataset.row),s=parseInt(r.dataset.col);r.className=`chess-square flex items-center justify-center cursor-pointer text-4xl font-bold select-none ${(a+s)%2===0?"bg-amber-100":"bg-amber-600"}`,r.style.width=`${o}px`,r.style.height=`${o}px`,e.selectedSquare&&e.selectedSquare[0]===a&&e.selectedSquare[1]===s&&(r.className+=" bg-blue-300"),e.possibleMoves.some(l=>l.row===a&&l.col===s)&&(r.className+=" bg-green-300")})}function Ni(e,n,t){const i=e.board[n][t];if(!i)return[];const o=[];switch(i.type){case"pawn":o.push(...Da(e.board,n,t,i.color)),o.push(...Aa(e,n,t));break;case"rook":o.push(...po(e.board,n,t,i.color));break;case"knight":o.push(...Oi(e.board,n,t,i.color));break;case"bishop":o.push(...fo(e.board,n,t,i.color));break;case"queen":o.push(...Wi(e.board,n,t,i.color));break;case"king":o.push(...Ba(e.board,n,t,i.color));break}return o}function Aa(e,n,t){const i=e.board[n][t];if(i.type!=="pawn"||!e.enPassantTarget)return[];const o=[],r=i.color==="white"?-1:1,a=e.enPassantTarget.row,s=e.enPassantTarget.col;return n===a-r&&Math.abs(t-s)===1&&o.push({row:a,col:s}),o}function Da(e,n,t,i){const o=[],r=i==="white"?-1:1,a=i==="white"?6:1;rt(n+r,t)&&!e[n+r][t]&&(o.push({row:n+r,col:t}),n===a&&!e[n+2*r][t]&&o.push({row:n+2*r,col:t}));for(const s of[-1,1]){const l=n+r,c=t+s;rt(l,c)&&e[l][c]&&e[l][c].color!==i&&o.push({row:l,col:c})}return o}function po(e,n,t,i){const o=[],r=[[0,1],[0,-1],[1,0],[-1,0]];for(const[a,s]of r)for(let l=1;l<8;l++){const c=n+l*a,d=t+l*s;if(!rt(c,d))break;if(!e[c][d])o.push({row:c,col:d});else{e[c][d].color!==i&&o.push({row:c,col:d});break}}return o}function Oi(e,n,t,i){const o=[],r=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];for(const[a,s]of r){const l=n+a,c=t+s;rt(l,c)&&(!e[l][c]||e[l][c].color!==i)&&o.push({row:l,col:c})}return o}function fo(e,n,t,i){const o=[],r=[[1,1],[1,-1],[-1,1],[-1,-1]];for(const[a,s]of r)for(let l=1;l<8;l++){const c=n+l*a,d=t+l*s;if(!rt(c,d))break;if(!e[c][d])o.push({row:c,col:d});else{e[c][d].color!==i&&o.push({row:c,col:d});break}}return o}function Wi(e,n,t,i){return[...po(e,n,t,i),...fo(e,n,t,i)]}function Ba(e,n,t,i){const o=[],r=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const[a,s]of r){const l=n+a,c=t+s;rt(l,c)&&(!e[l][c]||e[l][c].color!==i)&&o.push({row:l,col:c})}return o}function rt(e,n){return e>=0&&e<8&&n>=0&&n<8}function Vt(e,n,t,i,o){const r=e.board[n][t],a=e.board[i][o];if(e.enPassantTarget=null,a&&a.type==="king"&&(e.gameOver=!0,e.winner=r.color),r.type==="pawn"&&t!==o&&!a){const s=r.color==="white"?i+1:i-1;e.board[s][o]=null}if(r.type==="pawn"&&Math.abs(i-n)===2){const s=r.color==="white"?i+1:i-1;e.enPassantTarget={row:s,col:o}}r.type==="pawn"&&(i===0||i===7)&&(r.type="queen"),r.type==="pawn"||a?e.halfMoveClock=0:e.halfMoveClock++,r.color==="black"&&e.fullMoveNumber++,e.board[i][o]=r,e.board[n][t]=null,e.moveHistory.push({from:{row:n,col:t},to:{row:i,col:o},piece:{...r},captured:a,enPassantTarget:e.enPassantTarget,halfMoveClock:e.halfMoveClock})}async function Ri(e,n){let t;switch(e.difficulty){case"easy":t=Ta(e,"black");break;case"medium":t=Zo(e,"black",2);break;case"hard":t=Zo(e,"black",3);break}t&&(Vt(e,t.from.row,t.from.col,t.to.row,t.to.col),e.gameOver||(e.currentPlayer="white"),qi(e)&&(e.gameOver=!0,e.winner=Ui(e),Yi(e)),await gn(e),uo(e,n))}function Ta(e,n){const t=Ut(e,n);return t.length>0?t[Math.floor(Math.random()*t.length)]:null}function Zo(e,n,t=2){const i=n,o=1e9;let r=null,a=-o;const s=Hi(e,Ut(e,n));for(const l of s){const c=mo(e);Vt(c,l.from.row,l.from.col,l.to.row,l.to.col),c.currentPlayer="white";const d=-_i(c,t-1,-o,o,"white",i);d>a&&(a=d,r=l)}return r}function _i(e,n,t,i,o,r){const s=mt(e.board,r),l=mt(e.board,"white");if(!s)return-1e9+(3-n);if(!l)return 1e9-(3-n);if(n===0)return Qo(e,r);const c=Ut(e,o);if(c.length===0)return(o===r?-1:1)*-10+Qo(e,r);let d=o===r?-1e9:1e9;const p=Hi(e,c);for(const m of p){const u=mo(e);Vt(u,m.from.row,m.from.col,m.to.row,m.to.col),u.currentPlayer=o==="white"?"black":"white";const f=_i(u,n-1,t,i,u.currentPlayer,r);if(o===r?(f>d&&(d=f),d>t&&(t=d)):(f<d&&(d=f),d<i&&(i=d)),t>=i)break}return d}function Ut(e,n){const t=[];for(let i=0;i<8;i++)for(let o=0;o<8;o++){const r=e.board[i][o];if(r&&r.color===n){const a=$a(e,i,o);for(const s of a)t.push({from:{row:i,col:o},to:{row:s.row,col:s.col}})}}return t}function Hi(e,n){const t=e.currentPlayer==="white"?"black":"white";return mt(e.board,t),n.sort((i,o)=>Jo(e,o)-Jo(e,i))}function Jo(e,n){const t=e.board[n.from.row][n.from.col],i=e.board[n.to.row][n.to.col];let o=0;i&&(o+=10*cn(i.type)-cn(t.type)*.1),t.type==="pawn"&&(o+=.2*(t.color==="white"?7-n.to.row:n.to.row)),(t.type==="knight"||t.type==="bishop")&&(o+=.3),n.to.row>=2&&n.to.row<=5&&n.to.col>=2&&n.to.col<=5&&(o+=.2);const r=mo(e);Vt(r,n.from.row,n.from.col,n.to.row,n.to.col),Ht(r,n.to.row,n.to.col,t.color)&&(o-=Math.min(1.5,cn(t.type)*.6));const s=t.color==="white"?"black":"white",l=mt(r.board,s);return l&&Ht(r,l.row,l.col,s)&&Ht(r,l.row,l.col,s),l&&ji(r,n.to.row,n.to.col,l.row,l.col)&&(o+=1),o}function mo(e){return{board:e.board.map(n=>n.map(t=>t?{...t}:null)),currentPlayer:e.currentPlayer,difficulty:e.difficulty,gameOver:e.gameOver,winner:e.winner,moveHistory:e.moveHistory?[...e.moveHistory]:[],selectedSquare:null,possibleMoves:[],gameStarted:e.gameStarted,enPassantTarget:e.enPassantTarget?{...e.enPassantTarget}:null,halfMoveClock:e.halfMoveClock,fullMoveNumber:e.fullMoveNumber}}function Qo(e,n){let t=0;for(let l=0;l<8;l++)for(let c=0;c<8;c++){const d=e.board[l][c];if(!d)continue;const p=cn(d.type),m=Fa(d,l,c),u=(d.color===n?1:-1)*(p+m);t+=u}const i=Ut(e,n).length,o="white",r=Ut(e,o).length;t+=.05*(i-r);const a=mt(e.board,n),s=mt(e.board,o);return a&&Ht(e,a.row,a.col,n)&&(t-=1.5),s&&Ht(e,s.row,s.col,o)&&(t+=1),t}function Fa(e,n,t){let i=0;return n>=2&&n<=5&&t>=2&&t<=5&&(i+=.2),e.type==="pawn"?i+=.05*(e.color==="white"?7-n:n):e.type==="knight"||e.type==="bishop"?i+=.1:(e.type==="rook"||e.type==="queen")&&(i+=.05),i}function cn(e){return{pawn:1,knight:3,bishop:3,rook:5,queen:9,king:100}[e]||0}function qi(e){if(e.gameOver)return!0;let n=!1,t=!1;for(let i=0;i<8;i++)for(let o=0;o<8;o++){const r=e.board[i][o];r&&r.type==="king"&&(r.color==="white"&&(n=!0),r.color==="black"&&(t=!0))}return n?t?!1:(e.gameOver=!0,e.winner="white",!0):(e.gameOver=!0,e.winner="black",!0)}function Pa(e,n){const t=mt(e.board,n);if(!t)return!1;const i=n==="white"?"black":"white";for(let o=0;o<8;o++)for(let r=0;r<8;r++){const a=e.board[o][r];if(a&&a.color===i&&Na(e.board,o,r).some(l=>l.row===t.row&&l.col===t.col))return!0}return!1}function mt(e,n){for(let t=0;t<8;t++)for(let i=0;i<8;i++){const o=e[t][i];if(o&&o.type==="king"&&o.color===n)return{row:t,col:i}}return null}function $a(e,n,t){if(!e.board[n][t])return[];const o=Ni(e,n,t),r=[];for(const a of o)za(e,n,t,a.row,a.col)&&r.push(a);return r}function za(e,n,t,i,o){const r=e.board.map(l=>l.map(c=>c?{...c}:null)),a=r[n][t];r[i][o],r[i][o]=a,r[n][t]=null;const s={...e,board:r};return!Pa(s,a.color)}function Ht(e,n,t,i){const o=i==="white"?"black":"white";for(let r=0;r<8;r++)for(let a=0;a<8;a++){const s=e.board[r][a];if(s&&s.color===o&&ji(e,r,a,n,t))return!0}return!1}function ji(e,n,t,i,o){const r=e.board[n][t];if(!r)return!1;const a=i-n,s=o-t,l=Math.abs(a),c=Math.abs(s);switch(r.type){case"pawn":const d=r.color==="white"?-1:1;return a===d&&c===1;case"rook":return a===0||s===0?Yn(e,n,t,i,o):!1;case"bishop":return l===c?Yn(e,n,t,i,o):!1;case"queen":return a===0||s===0||l===c?Yn(e,n,t,i,o):!1;case"knight":return l===2&&c===1||l===1&&c===2;case"king":return l<=1&&c<=1&&!(a===0&&s===0);default:return!1}}function Yn(e,n,t,i,o){const r=i>n?1:i<n?-1:0,a=o>t?1:o<t?-1:0;let s=n+r,l=t+a;for(;s!==i||l!==o;){if(e.board[s][l]!==null)return!1;s+=r,l+=a}return!0}function Na(e,n,t){const i=e[n][t];if(!i)return[];switch(i.type){case"pawn":return Oa(e,n,t,i.color);case"rook":return po(e,n,t,i.color);case"knight":return Oi(e,n,t,i.color);case"bishop":return fo(e,n,t,i.color);case"queen":return Wi(e,n,t,i.color);case"king":return Wa(e,n,t,i.color);default:return[]}}function Oa(e,n,t,i){const o=[],r=i==="white"?-1:1;for(const a of[-1,1]){const s=n+r,l=t+a;rt(s,l)&&o.push({row:s,col:l})}return o}function Wa(e,n,t,i){const o=[],r=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const[a,s]of r){const l=n+a,c=t+s;rt(l,c)&&o.push({row:l,col:c})}return o}function Ui(e){return e.winner}function Yi(e){!e||!e.winner||(e.winner==="white"?ie("Congratulations ‚Äî you captured the king. You win.","info"):e.winner==="black"&&ie("Your king was captured. You lose.","info"))}async function gn(e){try{await z.setItem("chessGameState",e)}catch(n){console.warn("Failed to save chess game state:",n)}}async function Ra(){try{const e=await z.getItem("chessGameState");return e||null}catch(e){return console.warn("Failed to load chess game state:",e),null}}function _a(e){const n=document.createElement("button");n.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2";const t=document.createElement("span");return t.className="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3",t.textContent=e,n.appendChild(t),n}function Ha(e,n=null,t=null){const i=document.createElement("select");return i.className="bg-white border-t-2 border-l-2 border-black border-b-2 border-r-2 border-gray-300 px-2 py-1",i.setAttribute("aria-label","Select game difficulty"),i.setAttribute("title","Choose the difficulty level for the chess game"),e.forEach(o=>{const r=document.createElement("option");typeof o=="string"?(r.value=o,r.textContent=o):(r.value=o.value,r.textContent=o.text||o.value),n!==null&&r.value===n&&(r.selected=!0),i.appendChild(r)}),t&&typeof t=="function"&&i.addEventListener("change",o=>t(o.target.value,o)),i}function Gi(){const e=document.getElementById("bombbroomer");if(e){const i=[...document.querySelectorAll("*")].filter(o=>getComputedStyle(o).zIndex>100&&getComputedStyle(o).zIndex<1e3).reduce((o,r)=>getComputedStyle(r).zIndex>getComputedStyle(o).zIndex?r:o);e.style.zIndex=`${parseInt(i.style.zIndex)+1}`;return}const n=ae("Bombbroomer","",!1,"bombbroomer",!1,!1,{type:"integer",width:400,height:490},"App",null,"gray");Ki(n).catch(t=>{console.error("Error initializing Bombbroomer:",t)})}async function Ki(e){const n=e.querySelector(".p-2");n.className="p-2 bg-gray-200 h-full overflow-hidden",n.innerHTML="";let t=await qa();t||(t={grid:[],gameStarted:!1,gameOver:!1,gameWon:!1,bombs:10,flaggedCount:0,rows:9,cols:9,firstClick:!0,timer:0,timerInterval:null});let i=await z.getItem("bombbroomer-best-time")||null;const o=document.createElement("div");o.className="flex flex-col h-full bg-gray-200 pb-4";const r=document.createElement("div");r.className="bg-gray-200 border-b-2 border-gray-400 p-1 flex items-center space-x-4",r.style.borderStyle="inset";const a=document.createElement("button");a.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",a.textContent="Game",a.setAttribute("aria-label","Game menu options"),a.setAttribute("title","Access game options and settings");const s=document.createElement("button");s.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",s.textContent="New Game",s.setAttribute("aria-label","Start new game"),s.setAttribute("title","Start a new minesweeper game"),s.addEventListener("click",async()=>await H()),r.appendChild(s);const l=document.createElement("div");l.className="bg-gray-200 border-2 border-gray-400 p-2 flex justify-between items-center",l.style.borderStyle="inset";const c=document.createElement("div");c.className="bg-black text-red-500 px-2 py-1 font-mono text-lg border-2 border-gray-500",c.style.borderStyle="inset",c.id="bomb-counter",c.textContent="010";const d=document.createElement("button");d.className="w-8 h-8 bg-gray-200 border-2 border-gray-400 text-lg hover:bg-gray-300",d.style.borderStyle="outset",d.id="face-button",d.textContent="üôÇ",d.setAttribute("aria-label","New game - Click to restart"),d.setAttribute("title","Click to start a new game"),d.addEventListener("click",async()=>await H());const p=document.createElement("div");p.className="bg-black text-red-500 px-2 py-1 font-mono text-lg border-2 border-gray-500",p.style.borderStyle="inset",p.id="timer-display",p.textContent="000";const m=document.createElement("div");m.className="bg-black text-red-500 px-2 py-1 font-mono text-lg border-2 border-gray-500",m.style.borderStyle="inset",m.id="best-time-display",m.textContent=i?i.toString().padStart(3,"0"):"---",l.appendChild(c),l.appendChild(d),l.appendChild(p),l.appendChild(m);const u=document.createElement("div");u.className="flex-1 p-4 flex items-center justify-center";const f=document.createElement("div");f.className="grid grid-cols-9 gap-0 border-2 border-gray-400 bg-gray-300",f.style.borderStyle="inset",f.id="game-grid",u.appendChild(f),o.appendChild(r),o.appendChild(l),o.appendChild(u),n.appendChild(o);function g(){t.grid=[],t.gameStarted=!1,t.gameOver=!1,t.gameWon=!1,t.flaggedCount=0,t.firstClick=!0,t.timer=0,t.timerInterval&&clearInterval(t.timerInterval);for(let S=0;S<t.rows;S++){t.grid[S]=[];for(let I=0;I<t.cols;I++)t.grid[S][I]={isBomb:!1,isRevealed:!1,isFlagged:!1,neighborCount:0}}O(),C()}function w(S,I){let B=0;for(;B<t.bombs;){const D=Math.floor(Math.random()*t.rows),E=Math.floor(Math.random()*t.cols);!t.grid[D][E].isBomb&&!(D===S&&E===I)&&(t.grid[D][E].isBomb=!0,B++)}for(let D=0;D<t.rows;D++)for(let E=0;E<t.cols;E++)t.grid[D][E].isBomb||(t.grid[D][E].neighborCount=b(D,E))}function b(S,I){let B=0;for(let D=Math.max(0,S-1);D<=Math.min(t.rows-1,S+1);D++)for(let E=Math.max(0,I-1);E<=Math.min(t.cols-1,I+1);E++)(D!==S||E!==I)&&t.grid[D][E].isBomb&&B++;return B}function C(){const S=document.getElementById("game-grid");S.innerHTML="";for(let I=0;I<t.rows;I++)for(let B=0;B<t.cols;B++){const D=document.createElement("button");D.className="w-8 h-8 border border-gray-500 bg-gray-200 text-sm font-bold flex items-center justify-center",D.style.borderStyle="outset",D.dataset.row=I,D.dataset.col=B,D.setAttribute("aria-label",`Cell row ${I+1}, column ${B+1}`),D.setAttribute("title",`Minesweeper cell at row ${I+1}, column ${B+1}`);const E=t.grid[I][B];if(E.isRevealed){if(D.style.borderStyle="inset",D.className=D.className.replace("bg-gray-200","bg-gray-300"),E.isBomb)D.textContent="üí£",D.style.backgroundColor=t.gameOver?"#ff0000":"#gray-300";else if(E.neighborCount>0){D.textContent=E.neighborCount;const F=["","#0000ff","#008000","#ff0000","#800080","#800000","#008080","#000000","#808080"];D.style.color=F[E.neighborCount]||"#000000"}}else E.isFlagged&&(D.textContent="üö©");D.addEventListener("click",async F=>await h(F,I,B)),D.addEventListener("contextmenu",async F=>await _(F,I,B)),S.appendChild(D)}}async function h(S,I,B){if(S.preventDefault(),t.gameOver||t.gameWon)return;const D=t.grid[I][B];D.isRevealed||D.isFlagged||(t.firstClick&&(w(I,B),t.firstClick=!1,t.gameStarted=!0,j()),D.isBomb?await A():(N(I,B),await M()),C(),await Wt(t))}async function _(S,I,B){if(S.preventDefault(),t.gameOver||t.gameWon)return;const D=t.grid[I][B];D.isRevealed||(D.isFlagged?(D.isFlagged=!1,t.flaggedCount--):(D.isFlagged=!0,t.flaggedCount++),O(),C(),await Wt(t))}function N(S,I){const B=t.grid[S][I];if(!(B.isRevealed||B.isFlagged)&&(B.isRevealed=!0,B.neighborCount===0))for(let D=Math.max(0,S-1);D<=Math.min(t.rows-1,S+1);D++)for(let E=Math.max(0,I-1);E<=Math.min(t.cols-1,I+1);E++)(D!==S||E!==I)&&N(D,E)}function j(){t.timerInterval=setInterval(async()=>{t.timer++,O(),await Wt(t)},1e3)}async function A(){t.gameOver=!0,t.timerInterval&&clearInterval(t.timerInterval);for(let S=0;S<t.rows;S++)for(let I=0;I<t.cols;I++)t.grid[S][I].isBomb&&(t.grid[S][I].isRevealed=!0);await Wt(t),document.getElementById("face-button").textContent="üòµ",setTimeout(()=>{showDialogBox("Game Over! Try again?","confirmation")},500)}async function M(){let S=0;for(let B=0;B<t.rows;B++)for(let D=0;D<t.cols;D++)t.grid[B][D].isRevealed&&!t.grid[B][D].isBomb&&S++;const I=t.rows*t.cols-t.bombs;S===I&&(t.gameWon=!0,t.timerInterval&&clearInterval(t.timerInterval),(i===null||t.timer<i)&&(i=t.timer,z.setItemSync("bombbroomer-best-time",i),document.getElementById("best-time-display").textContent=i.toString().padStart(3,"0"),window.isDevvit&&window.parent.postMessage({type:"setGameScore",data:{game:"bombbroomer",score:i}},"*")),await Wt(t),document.getElementById("face-button").textContent="üòé",setTimeout(()=>{showDialogBox("Congratulations! You won!","confirmation")},500))}function O(){const S=document.getElementById("bomb-counter"),I=document.getElementById("timer-display"),B=t.bombs-t.flaggedCount;S.textContent=B.toString().padStart(3,"0"),I.textContent=Math.min(t.timer,999).toString().padStart(3,"0")}async function H(){document.getElementById("face-button").textContent="üôÇ",g(),await ja()}function Z(){const S=document.getElementById("face-button");t.gameOver?S.textContent="üòµ":t.gameWon?S.textContent="üòé":S.textContent="üôÇ",t.gameStarted&&!t.gameOver&&!t.gameWon&&j(),O(),C()}const X=new MutationObserver(S=>{S.forEach(I=>{I.removedNodes.forEach(B=>{B.id==="bombbroomer"&&(t.timerInterval&&clearInterval(t.timerInterval),X.disconnect())})})});X.observe(document.getElementById("windows-container"),{childList:!0}),t.grid.length===0?H():Z()}async function Wt(e){try{const n={...e,timerInterval:null};await z.setItem("bombbroomer_gameState",n)}catch(n){console.warn("Failed to save Bombbroomer game state:",n)}}async function qa(){try{const e=await z.getItem("bombbroomer_gameState");if(e){const n=e;return n.timerInterval=null,n}}catch(e){console.warn("Failed to load Bombbroomer game state:",e)}return null}async function ja(){try{await z.removeItem("bombbroomer_gameState")}catch(e){console.warn("Failed to clear Bombbroomer game state:",e)}}function Xi(){const e=document.getElementById("mediaplayer");if(e){const i=[...document.querySelectorAll("*")].filter(o=>getComputedStyle(o).zIndex>100&&getComputedStyle(o).zIndex<1e3).reduce((o,r)=>getComputedStyle(r).zIndex>getComputedStyle(o).zIndex?r:o);e.style.zIndex=`${parseInt(i.style.zIndex)+1}`;return}const n=ae("Media Player","",!1,"mediaplayer",!1,!1,{type:"integer",width:500,height:400},"App",null,"gray");Vi(n).catch(console.error)}async function Vi(e){const n=e.querySelector(".p-2");n.className="p-2 bg-gray-200 h-full flex",n.innerHTML="";let t=await go();t?((!isFinite(t.volume)||t.volume<0||t.volume>1)&&(t.volume=.5),(!isFinite(t.currentTime)||t.currentTime<0)&&(t.currentTime=0),Number.isInteger(t.currentTrackIndex)||(t.currentTrackIndex=-1),Array.isArray(t.playlist)||(t.playlist=[])):t={currentTrackIndex:-1,currentTime:0,volume:.5,isPlaying:!1,playlist:[]};const i=document.createElement("div");i.className="w-1/2 bg-white border-2 border-gray-400 mr-2 flex flex-col",i.innerHTML=`
    <div class="bg-gray-300 border-b-2 border-gray-400 p-2 flex justify-between items-center">
      <div class="text-xs font-bold">Media Playlist:</div>
      <button id="add-song-btn" onclick="setTimeout(function(){toggleButtonActiveState('add-song-btn', 'Add Media')}, 1000);toggleButtonActiveState('add-song-btn', 'Adding media...');" class="bg-gray-200 border-t-2 border-l-2 border-gray-300"><span class="border-b-2 border-r-2 border-black block h-full w-full py-1 px-2 text-xs">Add</span></button>
      <input type="file" id="song-file-input" class="hidden" accept="audio/*,video/*">
    </div>
    <div id="playlist-container" class="flex-1 p-2 overflow-y-auto space-y-1">
      <div class="text-xs text-gray-500">Loading playlist...</div>
    </div>
  `;const o=document.createElement("div");o.className="w-1/2 flex flex-col";const r=document.createElement("div");r.id="media-container",r.className="w-full bg-black mb-2 flex items-center justify-center min-h-32",r.innerHTML=`
    <audio id="audio-player" class="w-full hidden"></audio>
    <video id="video-player" class="w-full max-h-48 hidden" controls></video>
    <div id="audio-placeholder" class="text-white text-2xl p-4 flex items-center justify-center" style="display: none;">üéµ üé∂ üéµ</div>
    <div id="media-placeholder" class="text-white text-sm p-4">No media selected</div>
  `,o.appendChild(r);const a=document.createElement("div");a.className="bg-gray-300 border-2 border-gray-400 p-3 mb-2";const s=document.createElement("div");s.className="text-center mb-2",s.innerHTML=`
    <div id="current-track-name" class="font-bold text-sm">Media Player</div>
    <div id="current-time" class="text-xs text-gray-600">Ready to play</div>
  `;const l=document.createElement("div");l.className="mb-3",l.innerHTML=`
    <div id="progress-container" class="w-full h-2 bg-gray-400 border border-gray-500 cursor-pointer">
      <div id="progress-bar" class="h-full bg-blue-500" style="width: 0%"></div>
    </div>
  `;const c=document.createElement("div");c.className="flex justify-center space-x-2 mb-2",c.innerHTML=`
    <button id="prev-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs" aria-label="Previous track" title="Play previous track">‚èÆ</button>
    <button id="play-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs" aria-label="Play" title="Play/pause current track">‚ñ∂</button>
    <button id="stop-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs" aria-label="Stop" title="Stop playback">‚èπ</button>
    <button id="next-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs" aria-label="Next track" title="Play next track">‚è≠</button>
  `;const d=document.createElement("div");d.className="flex items-center justify-center space-x-2",d.innerHTML=`
    <span class="text-xs">üîä</span>
    <input type="range" id="volume-control" min="0" max="1" step="0.01" value="0.5" class="w-20" aria-label="Volume control" title="Adjust playback volume">
    <span class="text-xs" id="volume-display">50%</span>
  `,a.appendChild(s),a.appendChild(l),a.appendChild(c),a.appendChild(d),o.appendChild(a),n.appendChild(i),n.appendChild(o);const p=n.querySelector("#audio-player"),m=n.querySelector("#video-player");let u=t.currentTrackIndex,f=t.playlist;const g=n.querySelector("#play-btn"),w=n.querySelector("#next-btn"),b=n.querySelector("#prev-btn"),C=n.querySelector("#stop-btn"),h=n.querySelector("#volume-control"),_=n.querySelector("#progress-bar"),N=n.querySelector("#progress-container"),j=n.querySelector("#add-song-btn"),A=n.querySelector("#song-file-input");let M;const O="media_player_db",H="songs";function Z(){const x=indexedDB.open(O,1);x.onerror=k=>{console.error("Database error: ",k.target.errorCode)},x.onupgradeneeded=k=>{M=k.target.result,M.createObjectStore(H,{keyPath:"id",autoIncrement:!0}).createIndex("name","name",{unique:!1})},x.onsuccess=k=>{M=k.target.result,S().catch(console.error)}}function X(x){const k=x.name.split(".").pop().toLowerCase();ci(x.name,"","C://Media",k,x).then($=>{$?S().catch(console.error):console.error("üéµ MEDIAPLAYER: Failed to add song to file system")}).catch($=>{console.error("üéµ MEDIAPLAYER: Error adding song to file system:",$)})}async function S(){f=[];try{const $=se().folders["C://Media"];if($){const U=Object.entries($).filter(([q,ce])=>q!=="contents"&&ce&&typeof ce=="object"&&ce.type).map(([q,ce])=>ce).map(async q=>{if(q.content_type&&["mp3","wav","audio","mp4","webm","avi","mov"].includes(q.content_type)){const ce=["mp4","webm","avi","mov"].includes(q.content_type),ge={name:q.name,file:q.file,id:q.id,isFileSystem:!0,source:"filesystem",isVideo:ce,contentType:q.content_type,type:q.file&&q.file.type?q.file.type:ce?"video/"+q.content_type:"audio/"+q.content_type};if(q.storageLocation==="indexeddb"&&!q.dataURL||!q.dataURL&&!q.file&&!q.path&&q.id&&q.id.startsWith("file-"))try{const Be=await storage.getItem(`file_data_${q.id}`);if(Be){q.dataURL=Be,ge.dataURL=Be;const Le=se();Le.folders["C://Media"]&&Le.folders["C://Media"][q.id]&&(Le.folders["C://Media"][q.id].dataURL=Be,Le.folders["C://Media"][q.id].tempObjectURL=null,setFileSystemState(Le))}else{console.warn("üéµ MEDIAPLAYER: No stored data found in IndexedDB for:",q.name,"File ID:",q.id);const Le=`file_data_${q.name}`,Ge=await storage.getItem(Le);Ge&&(q.dataURL=Ge,ge.dataURL=Ge)}}catch(Be){console.error("üéµ MEDIAPLAYER: Failed to load data from IndexedDB for:",q.name,Be)}return(q.isDefault||q.isSystemFile)&&q.path?(ge.path=q.path,ge.isDefault=q.isDefault,ge.isSystemFile=q.isSystemFile):q.dataURL||ge.dataURL?ge.dataURL=q.dataURL||ge.dataURL:q.file?ge.file=q.file:q.tempObjectURL?ge.tempObjectURL=q.tempObjectURL:ge.path=`media/${q.name}`,ge}return null});f=(await Promise.all(U)).filter(q=>q!==null)}}catch(k){console.error("Could not load songs from file system:",k)}f.some(k=>k.name==="too_many_screws_final.mp3")||f.unshift({name:"too_many_screws_final.mp3",path:"media/too_many_screws_final.mp3",isDefault:!0,id:"fallback-default-song",source:"fallback"}),I(),f.length>0&&(t.currentTrackIndex>=0&&t.currentTrackIndex<f.length?(B(t.currentTrackIndex),p.addEventListener("loadedmetadata",()=>{p.currentTime=t.currentTime||0},{once:!0})):B(0))}function I(){const x=n.querySelector("#playlist-container");x.innerHTML="",f.forEach((k,$)=>{const L=document.createElement("div");L.className="text-xs cursor-pointer hover:bg-gray-100 p-1 rounded";const U=k.name||k.id||"Unknown Track";k.name||console.warn("üéµ MEDIAPLAYER: Track missing name property, using fallback:",U,"Track:",k),L.textContent=U,L.dataset.index=$,L.addEventListener("click",()=>{B($),E()}),x.appendChild(L)})}function B(x){if(x<0||x>=f.length)return;u=x,t.currentTrackIndex=u;const k=f[x],$=k.type&&k.type.startsWith("video/")||k.contentType&&["mp4","webm","avi","mov"].includes(k.contentType)||k.isVideo===!0||k.file&&k.file.type&&k.file.type.startsWith("video/");p.style.display="none",m.style.display="none";const L=n.querySelector("#media-placeholder"),U=n.querySelector("#audio-placeholder");L&&(L.style.display="none"),U&&(U.style.display="none");const Y=$?m:p,q=$?p:m;if($?Y.style.display="block":U&&(U.style.display="flex"),q.pause(),q.currentTime=0,k.isDefault||k.path&&!k.file&&!k.dataURL)Y.src=k.path;else if(k.dataURL)Y.src=k.dataURL;else if(k.tempObjectURL)Y.src=k.tempObjectURL;else if(k.isFileSystem&&k.file){const ce=URL.createObjectURL(k.file);Y.src=ce}else if(k.file){const ce=URL.createObjectURL(k.file);Y.src=ce}else{console.error("Unable to load track - no valid source:",k);return}n.querySelector("#current-track-name").textContent=k.name||k.id||"Unknown Track",D(),Ve(t).catch(console.error)}function D(){n.querySelectorAll("#playlist-container > div").forEach((k,$)=>{$===u?k.classList.add("bg-blue-200"):k.classList.remove("bg-blue-200")})}function E(){const k=F().play();k!==void 0&&k.catch($=>{$.name==="AbortError"||console.error("Playback failed:",$)})}function F(){return m.style.display==="block"?m:p}function V(){const x=F();x.paused?E():x.pause()}function ee(){const x=F();x.pause(),x.currentTime=0}function re(){const x=(u+1)%f.length;B(x),E()}function te(){const x=(u-1+f.length)%f.length;B(x),E()}function ne(){const x=F();x.volume=h.value;const k=x===p?m:p;k.volume=h.value,t.volume=x.volume,n.querySelector("#volume-display").textContent=`${Math.round(h.value*100)}%`,Ve(t).catch(console.error)}function ye(){const x=F();if(x.duration){const k=x.currentTime/x.duration*100;_.style.width=`${k}%`;const $=L=>{const U=Math.floor(L/60),Y=Math.floor(L%60).toString().padStart(2,"0");return`${U}:${Y}`};n.querySelector("#current-time").textContent=`${$(x.currentTime)} / ${$(x.duration)}`}}function Ee(x){const k=F();if(!k.duration)return;const $=x.offsetX,L=N.offsetWidth;k.currentTime=$/L*k.duration}g.addEventListener("click",V),p.addEventListener("play",()=>g.textContent="‚è∏"),p.addEventListener("pause",()=>g.textContent="‚ñ∂"),p.addEventListener("ended",re),p.addEventListener("timeupdate",ye),p.addEventListener("volumechange",()=>{h.value=p.volume,ne()}),m.addEventListener("play",()=>g.textContent="‚è∏"),m.addEventListener("pause",()=>g.textContent="‚ñ∂"),m.addEventListener("ended",re),m.addEventListener("timeupdate",ye),m.addEventListener("volumechange",()=>{h.value=m.volume,ne()}),p.addEventListener("error",x=>{console.error("üéµ MEDIAPLAYER: Audio error:",x.target.error,"Source:",p.src)}),m.addEventListener("error",x=>{console.error("üéµ MEDIAPLAYER: Video error:",x.target.error,"Source:",m.src)}),p.addEventListener("loadstart",()=>{}),m.addEventListener("loadstart",()=>{}),C.addEventListener("click",ee),w.addEventListener("click",re),b.addEventListener("click",te),h.addEventListener("input",ne),N.addEventListener("click",Ee),j.addEventListener("click",()=>A.click()),A.addEventListener("change",x=>{const k=x.target.files[0];k&&X(k)});const we=isFinite(t.volume)&&t.volume>=0&&t.volume<=1?t.volume:.5;h.value=we,p.volume=we,m.volume=we,n.querySelector("#volume-display").textContent=`${Math.round(we*100)}%`,t.volume=we,p.addEventListener("timeupdate",()=>{p.style.display==="block"&&(t.currentTime=p.currentTime,Math.floor(p.currentTime)%5===0&&Ve(t).catch(console.error))}),p.addEventListener("play",()=>{p.style.display==="block"&&(t.isPlaying=!0,Ve(t).catch(console.error))}),p.addEventListener("pause",()=>{p.style.display==="block"&&(t.isPlaying=!1,Ve(t).catch(console.error))}),m.addEventListener("timeupdate",()=>{m.style.display==="block"&&(t.currentTime=m.currentTime,Math.floor(m.currentTime)%5===0&&Ve(t).catch(console.error))}),m.addEventListener("play",()=>{m.style.display==="block"&&(t.isPlaying=!0,Ve(t).catch(console.error))}),m.addEventListener("pause",()=>{m.style.display==="block"&&(t.isPlaying=!1,Ve(t).catch(console.error))}),Z(),ne(),t.currentTrackIndex>=0&&f.length>t.currentTrackIndex&&setTimeout(async()=>{await Zi()},500),window.refreshMediaPlayerPlaylist=function(){M&&S().catch(console.error)};const R=setInterval(()=>{try{const k=se().folders["C://Media"];if(k){const $=Object.values(k).filter(Y=>Y.content_type&&["mp3","wav","audio","mp4","webm","avi","mov"].includes(Y.content_type)).map(Y=>Y.name),L=f.filter(Y=>Y.source==="filesystem"||Y.isFileSystem).map(Y=>Y.name);$.filter(Y=>!L.includes(Y)).length>0&&S().catch(console.error)}}catch{}},1e4),y=e,v=y.remove;y.remove=function(){return clearInterval(R),window.refreshMediaPlayerPlaylist===window.refreshMediaPlayerPlaylist&&delete window.refreshMediaPlayerPlaylist,v.call(this)}}async function Zi(){const e=await go();if(!(!e||e.currentTrackIndex<0)&&playlist.length>e.currentTrackIndex){let t=function(){const i=getActivePlayer();e.currentTime>0&&(i.currentTime=e.currentTime),e.isPlaying&&safePlay()};var n=t;loadTrack(e.currentTrackIndex),audio.addEventListener("loadedmetadata",function i(){audio.style.display==="block"&&t(),audio.removeEventListener("loadedmetadata",i)}),video.addEventListener("loadedmetadata",function i(){video.style.display==="block"&&t(),video.removeEventListener("loadedmetadata",i)})}}async function Ve(e){try{await storage.setItem("mediaplayer_state",e)}catch(n){console.warn("Failed to save Media Player state:",n);try{storage.setItemSync("mediaplayer_state",e)}catch(t){console.error("Failed to save Media Player state with fallback:",t)}}}async function go(){try{const e=await storage.getItem("mediaplayer_state");if(e)return e}catch(e){console.warn("Failed to load Media Player state:",e);try{const n=storage.getItemSync("mediaplayer_state");if(n)return n}catch(n){console.warn("Failed to load Media Player state with fallback:",n)}}return null}async function Ua(){try{await storage.removeItem("mediaplayer_state")}catch(e){console.warn("Failed to clear Media Player state:",e);try{storage.removeItemSync("mediaplayer_state")}catch(n){console.error("Failed to clear Media Player state with fallback:",n)}}}class Ya{constructor(){this.shortcuts=new Map,this.customMappings=new Map,this.isInitialized=!1,this.preventDefaults=new Set,this.sequenceBuffer=[],this.sequenceTimer=null,this.shortcutMode=!1,this.sequenceMap={"g w":()=>typeof window.cycleWindows=="function"&&window.cycleWindows(),"g d":()=>typeof window.minimizeAllWindows=="function"&&window.minimizeAllWindows(),"g s":()=>typeof window.toggleStartMenu=="function"&&window.toggleStartMenu(),"w c":()=>typeof window.closeActiveWindow=="function"&&window.closeActiveWindow(),"w m":()=>typeof window.minimizeActiveWindow=="function"&&window.minimizeActiveWindow()},this.shortcutModeMap={c:()=>typeof window.closeActiveWindow=="function"&&window.closeActiveWindow(),m:()=>typeof window.minimizeActiveWindow=="function"&&window.minimizeActiveWindow(),x:()=>{var n;return typeof window.toggleFullScreen=="function"&&window.toggleFullScreen((n=window.getActiveWindowId)==null?void 0:n.call(window))},s:()=>typeof window.toggleStartMenu=="function"&&window.toggleStartMenu(),d:()=>typeof window.minimizeAllWindows=="function"&&window.minimizeAllWindows()},this.defaultShortcuts={"global.toggleStartMenu":{key:"Alt+S",description:"Open/Close Start Menu"},"global.cycleWindows":{key:"Alt+W",description:"Cycle open windows"},"global.minimizeActiveWindow":{key:"Alt+M",description:"Minimize active window"},"global.closeActiveWindow":{key:"Alt+Q",description:"Close active window"},"global.showDesktop":{key:"Alt+D",description:"Show desktop (minimize all)"},"fileExplorer.rename":{key:"Alt+R",description:"Rename selected file"},"global.escapeAction":{key:"Escape",description:"Close menus/dialogs"},"global.toggleShortcutMode":{key:"Alt+K",description:"Enter Shortcut Mode"},"desktop.activateIcon":{key:"Enter",description:"Activate selected desktop icon"},"desktop.moveUp":{key:"ArrowUp",description:"Move icon up"},"desktop.moveDown":{key:"ArrowDown",description:"Move icon down"},"desktop.moveLeft":{key:"ArrowLeft",description:"Move icon left"},"desktop.moveRight":{key:"ArrowRight",description:"Move icon right"},"desktop.fineMoveUp":{key:"Shift+ArrowUp",description:"Fine move icon up"},"desktop.fineMoveDown":{key:"Shift+ArrowDown",description:"Fine move icon down"},"desktop.fineMoveLeft":{key:"Shift+ArrowLeft",description:"Fine move icon left"},"desktop.fineMoveRight":{key:"Shift+ArrowRight",description:"Fine move icon right"},"startMenu.navigateDown":{key:"ArrowDown",description:"Navigate down in start menu"},"startMenu.navigateUp":{key:"ArrowUp",description:"Navigate up in start menu"},"startMenu.enterSubmenu":{key:"ArrowRight",description:"Enter submenu"},"startMenu.exitSubmenu":{key:"ArrowLeft",description:"Exit submenu"},"startMenu.activateItem":{key:"Enter",description:"Activate start menu item"},"startMenu.close":{key:"Escape",description:"Close start menu"}}}async initialize(){this.isInitialized||(await this.loadCustomMappings(),this.setupShortcuts(),this.setupGlobalKeyboardHandler(),this.isInitialized=!0,console.log("üéπ Keyboard service initialized with",this.shortcuts.size,"shortcuts"))}async loadCustomMappings(){var n;try{const i=(n=(await Ne()).folders["C://Documents"])==null?void 0:n["keyboard_config.json"];if(i&&i.content){const o=JSON.parse(i.content);this.customMappings=new Map(Object.entries(o.customMappings||{})),console.log("üìã Loaded",this.customMappings.size,"custom keyboard mappings")}}catch(t){console.warn("‚ö†Ô∏è Could not load keyboard config:",t)}}async saveCustomMappings(){try{const n=await Ne();n.folders["C://Documents"]||(n.folders["C://Documents"]={});const t={customMappings:Object.fromEntries(this.customMappings),timestamp:Date.now()};n.folders["C://Documents"]["keyboard_config.json"]={id:"keyboard_config.json",name:"keyboard_config.json",type:"file",content_type:"json",content:JSON.stringify(t,null,2),fullPath:"C://Documents/keyboard_config.json"},await Q(),console.log("üíæ Saved keyboard configuration")}catch(n){console.error("‚ùå Failed to save keyboard config:",n)}}setupShortcuts(){this.shortcuts.clear();for(const[n,t]of Object.entries(this.defaultShortcuts)){const i=this.customMappings.get(n);this.shortcuts.set(n,{...t,key:i||t.key,isCustom:!!i})}}setupGlobalKeyboardHandler(){document.removeEventListener("keydown",this.globalHandler),this.globalHandler=this.handleGlobalKeyboard.bind(this),document.addEventListener("keydown",this.globalHandler,!0)}handleGlobalKeyboard(n){const t=n.target,i=/input|textarea|select/i.test(t.tagName)||t.isContentEditable;if(/Mac|iPod|iPhone|iPad/.test(navigator.platform)&&n.metaKey)return;if(this.shortcutMode){if(n.key==="Escape"){this.shortcutMode=!1;return}if(!n.metaKey&&!n.ctrlKey&&!n.altKey){const s=n.key.toLowerCase(),l=this.shortcutModeMap[s];if(l){n.preventDefault(),l(),this.shortcutMode=!1;return}}}const r=this.getKeyCombo(n),a=this.getContext(n);for(const[s,l]of this.shortcuts.entries())if(this.matchesKeyCombo(r,l.key)&&this.isActionValidForContext(s,a)){n.preventDefault(),n.stopPropagation(),this.executeAction(s,n,a);return}if(!i&&!n.metaKey&&!n.ctrlKey&&!n.altKey&&n.key.length===1){this.sequenceBuffer.push(n.key.toLowerCase()),clearTimeout(this.sequenceTimer),this.sequenceTimer=setTimeout(()=>{this.sequenceBuffer=[]},650);const s=this.sequenceBuffer.join(" ");this.sequenceMap[s]?(n.preventDefault(),this.sequenceMap[s](),this.sequenceBuffer=[]):this.sequenceBuffer.length>2&&(this.sequenceBuffer=[])}}getKeyCombo(n){const t=[];n.ctrlKey&&t.push("Ctrl"),n.altKey&&t.push("Alt"),n.shiftKey&&t.push("Shift"),n.metaKey&&t.push("Meta");let i=n.key===" "?"Space":n.key;return n.altKey&&n.code&&n.code.startsWith("Key")&&(i=n.code.slice(3)),["Control","Alt","Shift","Meta"].includes(i)||t.push(i),t.join("+")}matchesKeyCombo(n,t){const i=o=>o.toLowerCase().replace(/\s+/g,"");return i(n)===i(t)}getContext(n){const t=n.target,i=[];return t.closest("#start-menu")&&i.push("startMenu"),t.closest("#context-menu")&&i.push("contextMenu"),t.closest(".file-explorer-window")&&i.push("fileExplorer"),t.closest(".draggable-icon")&&i.push("desktop"),t.closest("#window-tabs")&&i.push("taskbar"),t.closest('[role="dialog"]')&&i.push("window"),i.push("global"),i}isActionValidForContext(n,t){const i=n.split(".")[0];return t.includes(i)||i==="global"}async executeAction(n,t,i){console.log("üéπ Executing keyboard action:",n);try{switch(n){case"global.toggleStartMenu":typeof window.toggleStartMenu=="function"&&window.toggleStartMenu();break;case"global.toggleShortcutMode":this.shortcutMode=!this.shortcutMode,this.shortcutMode&&typeof window.showDialogBox=="function"&&window.showDialogBox("Shortcut Mode: c(close) m(minimize) x(max) s(start) d(desktop) Esc(cancel)","info");break;case"global.cycleWindows":typeof window.cycleWindows=="function"&&window.cycleWindows();break;case"global.closeActiveWindow":typeof window.closeActiveWindow=="function"&&window.closeActiveWindow();break;case"global.minimizeActiveWindow":typeof window.minimizeActiveWindow=="function"&&window.minimizeActiveWindow();break;case"global.showDesktop":typeof window.minimizeAllWindows=="function"&&window.minimizeAllWindows();break;case"global.escapeAction":this.handleGlobalEscape();break;case"desktop.activateIcon":case"desktop.activateIcon2":this.handleDesktopActivate(t);break;case"desktop.startDrag":this.handleDesktopStartDrag(t);break;case"desktop.cutIcon":this.handleDesktopCut(t);break;case"desktop.pasteIcon":this.handleDesktopPaste(t);break;case"desktop.escapeAction":this.handleDesktopEscape(t);break;case"desktop.moveUp":case"desktop.moveDown":case"desktop.moveLeft":case"desktop.moveRight":this.handleDesktopMove(t,n);break;case"desktop.fineMoveUp":case"desktop.fineMoveDown":case"desktop.fineMoveLeft":case"desktop.fineMoveRight":this.handleDesktopFineMove(t,n);break;case"startMenu.navigateDown":case"startMenu.navigateUp":case"startMenu.enterSubmenu":case"startMenu.exitSubmenu":case"startMenu.activateItem":case"startMenu.activateItem2":case"startMenu.close":case"startMenu.goToFirst":case"startMenu.goToLast":this.handleStartMenuAction(n,t);break;case"fileExplorer.rename":case"fileExplorer.delete":case"fileExplorer.open":case"fileExplorer.navigateDown":case"fileExplorer.navigateUp":case"fileExplorer.openContextMenu":case"fileExplorer.openContextMenu2":case"fileExplorer.openContextMenu3":this.handleFileExplorerAction(n,t);break;case"contextMenu.navigateDown":case"contextMenu.navigateUp":case"contextMenu.enterSubmenu":case"contextMenu.exitSubmenu":case"contextMenu.activateItem":case"contextMenu.activateItem2":case"contextMenu.close":this.handleContextMenuAction(n,t);break;case"window.minimize":case"window.maximize":case"window.close":this.handleWindowAction(n,t);break;case"taskbar.activateButton":case"taskbar.activateButton2":case"taskbar.mediaControl":case"taskbar.minimizeAll":this.handleTaskbarAction(n,t);break;default:console.warn("üéπ Unknown keyboard action:",n)}}catch(o){console.error("‚ùå Error executing keyboard action:",n,o)}}handleGlobalEscape(){const n=document.getElementById("start-menu"),t=document.getElementById("context-menu");if(n&&!n.classList.contains("hidden")){n.classList.add("hidden"),n.setAttribute("aria-hidden","true"),typeof window.updateStartMenuFocusability=="function"&&window.updateStartMenuFocusability(!1);const i=document.getElementById("start-button");i&&(i.setAttribute("aria-expanded","false"),i.focus())}t&&!t.classList.contains("hidden")&&t.classList.add("hidden")}handleDesktopActivate(n){const t=n.target.closest(".draggable-icon");t&&t.dispatchEvent(new MouseEvent("dblclick",{bubbles:!0}))}handleDesktopStartDrag(n){const t=n.target.closest(".draggable-icon");t&&typeof window.startKeyboardDrag=="function"&&window.startKeyboardDrag(t)}handleDesktopCut(n){const t=n.target.closest(".draggable-icon");t&&typeof window.cutIcon=="function"&&window.cutIcon(t)}handleDesktopPaste(n){typeof window.pasteIcon=="function"&&window.pasteIcon()}handleDesktopEscape(n){typeof window.endKeyboardDrag=="function"&&window.endKeyboardDrag(!1)}handleDesktopMove(n,t){const i=n.target.closest(".draggable-icon");if(!i)return;const o=t.split(".")[1].replace("move","").toLowerCase(),r={up:"ArrowUp",down:"ArrowDown",left:"ArrowLeft",right:"ArrowRight"};typeof window.moveIconWithKeyboard=="function"&&window.moveIconWithKeyboard(i,r[o])}handleDesktopFineMove(n,t){const i=n.target.closest(".draggable-icon");if(!i)return;const o=t.split(".")[1].replace("fineMove","").toLowerCase(),r=parseInt(i.style.left)||0,a=parseInt(i.style.top)||0,s=5;let l=r,c=a;switch(o){case"up":c=Math.max(16,a-s);break;case"down":c=a+s;break;case"left":l=Math.max(16,r-s);break;case"right":l=r+s;break}i.style.left=l+"px",i.style.top=c+"px",typeof window.constrainIconPosition=="function"&&window.constrainIconPosition(i),typeof window.desktopIconsState<"u"&&(window.desktopIconsState[i.id]={left:i.style.left,top:i.style.top}),typeof window.saveState=="function"&&window.saveState()}handleStartMenuAction(n,t){const i=n.split(".")[1],o=window.startMenuKeyboardNavState;o&&typeof o.handleAction=="function"&&o.handleAction(i,t)}handleFileExplorerAction(n,t){const i=n.split(".")[1];switch(i){case"rename":console.log("Rename functionality would trigger here");break;case"delete":console.log("Delete - Delete functionality would trigger here");break;case"open":const o=document.activeElement;o&&o.classList.contains("file-item")&&o.dispatchEvent(new MouseEvent("dblclick",{bubbles:!0}));break;case"navigateDown":case"navigateUp":const r=i==="navigateDown"?"down":"up",a=document.querySelector(".file-explorer-window:focus-within");a&&typeof window.navigateFileList=="function"&&window.navigateFileList(r,a);break;case"openContextMenu":case"openContextMenu2":case"openContextMenu3":const s=t.target,l=s.getBoundingClientRect(),c=new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,clientX:l.left+l.width/2,clientY:l.top+l.height/2,button:2});s.dispatchEvent(c);break}}handleContextMenuAction(n,t){const i=document.getElementById("context-menu");i&&typeof window.handleContextMenuNavigation=="function"&&window.handleContextMenuNavigation(t,i)}handleWindowAction(n,t){const i=n.split(".")[1],o=document.querySelector('[role="dialog"]:not([aria-hidden="true"])');if(!o)return;const r=o.id;switch(i){case"minimize":typeof window.minimizeWindow=="function"&&window.minimizeWindow(r);break;case"maximize":typeof window.toggleFullScreen=="function"&&window.toggleFullScreen(r);break;case"close":typeof window.closeWindow=="function"&&window.closeWindow(r);break}}handleTaskbarAction(n,t){switch(n.split(".")[1]){case"activateButton":case"activateButton2":const o=t.target.closest("button");o&&o.click();break;case"mediaControl":typeof window.toggleMediaPlayback=="function"&&window.toggleMediaPlayback();break;case"minimizeAll":typeof window.minimizeAllWindows=="function"&&window.minimizeAllWindows();break}}remapShortcut(n,t){if(!this.defaultShortcuts[n])throw new Error(`Unknown action: ${n}`);this.customMappings.set(n,t),this.setupShortcuts(),this.saveCustomMappings()}removeCustomMapping(n){this.customMappings.delete(n),this.setupShortcuts(),this.saveCustomMappings()}resetToDefaults(){this.customMappings.clear(),this.setupShortcuts(),this.saveCustomMappings()}getShortcuts(){return Array.from(this.shortcuts.entries()).map(([n,t])=>({id:n,...t}))}getShortcutsByContext(){const n={};for(const[t,i]of this.shortcuts.entries()){const o=t.split(".")[0];n[o]||(n[o]=[]),n[o].push({id:t,...i})}return n}}const De=new Ya;async function Ji(){console.log("üéπ Starting keyboard app launch...");try{await De.initialize(),console.log("üéπ Keyboard service initialized successfully");const e=document.getElementById("keyboard-app");if(e){console.log("üéπ Existing keyboard window found, bringing to front"),typeof window.bringToFront=="function"&&window.bringToFront(e);return}const n="keyboard-app",t=Ga();console.log("üéπ Creating keyboard app window..."),ae("Keyboard Shortcuts",t,!1,n,!1,!1,{type:"integer",width:800,height:600},"default"),console.log("üéπ Window created, initializing app..."),setTimeout(()=>Qi(n),100)}catch(e){console.error("‚ùå Failed to launch keyboard app:",e)}}function Ga(){return`
    <div class="keyboard-app h-full flex flex-col bg-gray-50">
      <div class="bg-gray-600 text-white p-3 flex items-center">
        <div class="w-8 h-8 bg-white bg-opacity-20 rounded mr-3 flex items-center justify-center">
          <span class="text-sm font-bold">‚å®Ô∏è</span>
        </div>
        <div>
          <h1 class="text-lg font-bold">Keyboard Shortcuts Manager</h1>
          <p class="text-sm opacity-90">Customize keyboard shortcuts for the entire system</p>
        </div>
      </div>

      <div class="flex-1 flex">
        <!-- Sidebar -->
        <div class="w-64 bg-white border-r border-gray-300 flex flex-col">
          <div class="p-3 border-b border-gray-200">
            <h2 class="font-bold text-gray-800">Categories</h2>
          </div>
          <div class="flex-1 overflow-y-auto">
            <div id="keyboard-categories" class="p-2 space-y-1">
              <!-- Categories will be populated here -->
            </div>
          </div>
          <div class="p-3 border-t border-gray-200 space-y-2">
            <div id="keyboard-reset-btn-container"></div>
            <div id="keyboard-export-btn-container"></div>
          </div>
        </div>

        <!-- Main content -->
        <div class="flex-1 flex flex-col">
          <div class="p-4 border-b border-gray-200 bg-gray-100">
            <div class="flex items-center justify-between">
              <div>
                <h2 id="keyboard-category-title" class="text-xl font-bold text-gray-800">Global Shortcuts</h2>
                <p id="keyboard-category-desc" class="text-sm text-gray-600">System-wide keyboard shortcuts</p>
              </div>
              <div class="flex items-center space-x-2">
                <input type="text" id="keyboard-search" placeholder="Search shortcuts..."
                       class="px-3 py-1 border border-gray-300 rounded text-sm">
                <div id="keyboard-help-btn-container"></div>
              </div>
            </div>
          </div>

          <div class="flex-1 overflow-y-auto p-4">
            <div id="keyboard-touch-banner" class="hidden mb-3 bg-blue-50 border border-blue-200 text-blue-800 rounded p-3 text-sm">
              <strong>Touch tips:</strong> Swipe the taskbar to switch windows, two-finger tap on the desktop to show the desktop, and two-finger swipe on a window title bar to minimize (down) or maximize (up).
            </div>
            <div id="keyboard-shortcuts-list">
              <!-- Shortcuts list will be populated here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Status bar -->
      <div class="bg-gray-200 border-t border-gray-300 px-4 py-2 text-sm text-gray-600">
        <div class="flex items-center justify-between">
          <span id="keyboard-status">Ready</span>
          <span id="keyboard-count">0 shortcuts loaded</span>
        </div>
      </div>
    </div>
  `}function Qi(e){const n=document.getElementById(e);if(!n){console.error("‚ùå Keyboard app window not found:",e);return}if(n.dataset.keyboardInitialized==="true"){const S=n.querySelector("#keyboard-categories");if(n.querySelector("#keyboard-shortcuts-list"),S&&S.children.length===0)n.dataset.keyboardInitialized="false";else return}console.log("üéπ Initializing keyboard app UI...");let t="global",i=null,o=null;const r="ontouchstart"in window||navigator.maxTouchPoints>0,a=document.getElementById("keyboard-touch-banner");r&&a&&a.classList.remove("hidden");const s={"global.toggleStartMenu":"Tap Start button","global.cycleWindows":"Swipe left/right on taskbar","global.minimizeActiveWindow":"Two-finger swipe down on window title bar","global.closeActiveWindow":"Tap the X button on the window title bar","global.showDesktop":"Two-finger tap on desktop","global.escapeAction":"Tap outside the menu/dialog","desktop.activateIcon":"Double-tap icon","desktop.moveUp":"Drag icon up","desktop.moveDown":"Drag icon down","desktop.moveLeft":"Drag icon left","desktop.moveRight":"Drag icon right","desktop.fineMoveUp":"Drag icon up (slowly)","desktop.fineMoveDown":"Drag icon down (slowly)","desktop.fineMoveLeft":"Drag icon left (slowly)","desktop.fineMoveRight":"Drag icon right (slowly)","startMenu.navigateDown":"Scroll and tap items","startMenu.navigateUp":"Scroll and tap items","startMenu.enterSubmenu":"Tap submenu","startMenu.exitSubmenu":"Tap Back or outside","startMenu.activateItem":"Tap item","startMenu.close":"Tap outside menu","fileExplorer.rename":"Long-press item ‚Üí Rename","contextMenu.navigateDown":"Scroll menu and tap","contextMenu.navigateUp":"Scroll menu and tap","contextMenu.enterSubmenu":"Tap submenu","contextMenu.exitSubmenu":"Tap outside menu","contextMenu.activateItem":"Tap menu item","contextMenu.close":"Tap outside menu","window.minimize":"Tap _ button or two-finger swipe down on title bar","window.maximize":"Tap ‚õ∂ button or two-finger swipe up on title bar","window.close":"Tap X button","taskbar.activateButton":"Tap taskbar button","taskbar.mediaControl":"Tap media control","taskbar.minimizeAll":"Tap Show Desktop or two-finger tap on desktop"};function l(S){return r&&s[S]||null}De.initialize().then(()=>{console.log("üéπ Keyboard service ready, populating UI..."),c(),d("global"),h("Keyboard service initialized")}).catch(S=>{console.error("‚ùå Failed to initialize keyboard service:",S),h("Failed to initialize keyboard service")});function c(){const S=De.getShortcutsByContext(),I=n.querySelector("#keyboard-categories"),B={global:"Global",desktop:"Desktop",startMenu:"Start Menu",fileExplorer:"File Explorer",contextMenu:"Context Menu",window:"Windows",taskbar:"Taskbar"},D={global:"image/html.webp",desktop:"image/desktop.webp",startMenu:"image/door-icon.webp",fileExplorer:"image/folder.webp",contextMenu:"image/doc.webp",window:"image/generic-window.webp",taskbar:"image/desktop.webp"};I.innerHTML="",Object.keys(S).forEach(E=>{const F=document.createElement("button");F.className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 text-sm flex items-center space-x-2";const V=document.createElement("img");V.src=D[E]||"image/file.webp",V.className="w-4 h-4",V.alt="";const ee=document.createElement("span");ee.textContent=B[E]||E,F.appendChild(V),F.appendChild(ee),F.onclick=()=>d(E),I.appendChild(F)})}function d(S){t=S;const I=De.getShortcutsByContext()[S]||[],B={global:"Global Shortcuts",desktop:"Desktop Shortcuts",startMenu:"Start Menu Navigation",fileExplorer:"File Explorer",contextMenu:"Context Menus",window:"Window Management",taskbar:"Taskbar Controls"},D={global:"System-wide keyboard shortcuts",desktop:"Desktop icon management and navigation",startMenu:"Start menu navigation and activation",fileExplorer:"File and folder operations",contextMenu:"Context menu navigation",window:"Window control operations",taskbar:"Taskbar button and control shortcuts"};n.querySelector("#keyboard-category-title").textContent=B[S]||S,n.querySelector("#keyboard-category-desc").textContent=D[S]||"",n.querySelectorAll("#keyboard-categories button").forEach(F=>{F.classList.remove("bg-gray-100","border-gray-300")});const E=Array.from(n.querySelectorAll("#keyboard-categories button")).find(F=>{const V=F.querySelector("span");return V&&V.textContent===(B[S]||S)});E&&E.classList.add("bg-gray-100","border-gray-300"),p(I),h(`Showing ${I.length} shortcuts in ${B[S]}`),n.querySelector("#keyboard-count").textContent=`${I.length} shortcuts`}function p(S){const I=n.querySelector("#keyboard-shortcuts-list");if(I.innerHTML="",S.length===0){I.innerHTML='<div class="text-center text-gray-500 py-8">No shortcuts in this category</div>';return}S.forEach(B=>{var te;const D=document.createElement("div");D.className="bg-white border border-gray-200 rounded-lg p-4 mb-3 hover:shadow-md transition-shadow";const E=B.isCustom,F=((te=De.defaultShortcuts[B.id])==null?void 0:te.key)||"",V=l(B.id);D.innerHTML=`
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="flex items-center space-x-2">
              <h3 class="font-medium text-gray-800">${B.description}</h3>
              ${E?'<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">Custom</span>':""}
            </div>
            <p class="text-sm text-gray-500 mt-1">Action: ${B.id}</p>
            ${E?`<p class="text-xs text-gray-400 mt-1">Default: ${F}</p>`:""}
            ${V?`<p class="text-xs text-blue-700 mt-2"><span class="bg-blue-50 border border-blue-200 rounded px-2 py-0.5">Touch: ${V}</span></p>`:""}
          </div>
          <div class="flex items-center space-x-2">
            <code class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">${B.key}</code>
            <div class="edit-shortcut-btn" data-shortcut-id="${B.id}"></div>
            ${E?`<div class="reset-shortcut-btn" data-shortcut-id="${B.id}"></div>`:""}
          </div>
        </div>
      `,I.appendChild(D);const ee=D.querySelector(".edit-shortcut-btn"),re=me("Edit");if(re.onclick=()=>m(B.id),ee.appendChild(re),E){const ne=D.querySelector(".reset-shortcut-btn"),ye=me("Reset");ye.onclick=()=>w(B.id),ne.appendChild(ye)}})}function m(S){i=S,o=null;const I=De.shortcuts.get(S),B=I?I.description:S,D="keyboard-capture-window",E=`
      <div class="p-4 bg-gray-100 h-full flex flex-col">
        <h3 class="text-lg font-bold mb-4">Remap Shortcut</h3>
        <p class="mb-4">Remapping: <strong>${B}</strong></p>
        <div class="flex-1 flex items-center justify-center">
          <div id="keyboard-capture-display" class="text-xl font-mono bg-white p-6 border-2 border-gray-400 text-center min-w-64" style="border-style: inset;">
            Press any key combination...
          </div>
        </div>
        <p class="text-sm text-gray-600 mb-4 text-center">
          Press the key combination you want to assign.<br>
          Press Escape to cancel.
        </p>
        <div class="flex justify-center space-x-2">
          <div id="keyboard-capture-cancel-btn"></div>
          <div id="keyboard-capture-save-btn"></div>
        </div>
      </div>
    `;ae("Capture Key Combination",E,!1,D,!1,!1,{type:"integer",width:400,height:250},"default"),setTimeout(()=>{const F=document.getElementById(D);if(!F)return;const V=F.querySelector("#keyboard-capture-cancel-btn"),ee=F.querySelector("#keyboard-capture-save-btn"),re=me("Cancel");re.onclick=()=>{f(),le(D)},V.appendChild(re);const te=me("Save");te.disabled=!0,te.onclick=()=>{g(),le(D)},ee.appendChild(te),document.addEventListener("keydown",u,!0),F.focus()},100)}function u(S){if(S.preventDefault(),S.stopPropagation(),S.key==="Escape"){f(),le("keyboard-capture-window");return}o=De.getKeyCombo(S);const I=document.getElementById("keyboard-capture-window");if(!I)return;const B=I.querySelector("#keyboard-capture-display"),D=I.querySelector("#keyboard-capture-save-btn");B.textContent=o;const E=D.querySelector("button");E&&(E.disabled=!1)}function f(){document.removeEventListener("keydown",u,!0),i=null,o=null}function g(){if(!(!i||!o)){try{De.remapShortcut(i,o),d(t),h(`Shortcut updated: ${i} ‚Üí ${o}`)}catch(S){h(`Error: ${S.message}`)}f()}}function w(S){De.removeCustomMapping(S),d(t),h(`Shortcut reset to default: ${S}`)}function b(){typeof window.showDialogBox=="function"?window.showDialogBox("Are you sure you want to reset all shortcuts to their defaults? This cannot be undone.","confirm",S=>{S&&(De.resetToDefaults(),d(t),h("All shortcuts reset to defaults"))}):confirm("Are you sure you want to reset all shortcuts to their defaults? This cannot be undone.")&&(De.resetToDefaults(),d(t),h("All shortcuts reset to defaults"))}function C(){const S={customMappings:Object.fromEntries(De.customMappings),timestamp:Date.now(),version:"1.0"},I=new Blob([JSON.stringify(S,null,2)],{type:"application/json"}),B=URL.createObjectURL(I),D=document.createElement("a");D.href=B,D.download="keyboard-shortcuts.json",D.click(),URL.revokeObjectURL(B),h("Settings exported successfully")}function h(S){n.querySelector("#keyboard-status").textContent=S}function _(S,I){n.querySelector("#keyboard-category-title").textContent=`Search Results for "${S}"`,n.querySelector("#keyboard-category-desc").textContent=`Found ${I.length} shortcuts across all categories`,n.querySelectorAll("#keyboard-categories button").forEach(B=>{B.classList.remove("bg-gray-100","border-gray-300")}),N(I),h(`${I.length} shortcuts found for "${S}"`),n.querySelector("#keyboard-count").textContent=`${I.length} shortcuts found`}function N(S){const I=n.querySelector("#keyboard-shortcuts-list");if(I.innerHTML="",S.length===0){I.innerHTML='<div class="text-center text-gray-500 py-8">No shortcuts found matching your search</div>';return}const B={};S.forEach(F=>{const V=F.id.split(".")[0];B[V]||(B[V]=[]),B[V].push(F)});const D={global:"Global",desktop:"Desktop",startMenu:"Start Menu",fileExplorer:"File Explorer",contextMenu:"Context Menu",window:"Windows",taskbar:"Taskbar"},E={global:"image/html.webp",desktop:"image/desktop.webp",startMenu:"image/door-icon.webp",fileExplorer:"image/folder.webp",contextMenu:"image/doc.webp",window:"image/generic-window.webp",taskbar:"image/desktop.webp"};Object.keys(B).forEach(F=>{const V=B[F],ee=document.createElement("div");ee.className="mb-2 mt-4 first:mt-0",ee.innerHTML=`
        <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wide border-b border-gray-200 pb-1 flex items-center space-x-2">
          <img src="${E[F]||"image/file.webp"}" class="w-4 h-4" alt="">
          <span>${D[F]||F} (${V.length})</span>
        </h3>
      `,I.appendChild(ee),V.forEach(re=>{var y;const te=document.createElement("div");te.className="bg-white border border-gray-200 rounded-lg p-4 mb-3 hover:shadow-md transition-shadow";const ne=re.isCustom,ye=((y=De.defaultShortcuts[re.id])==null?void 0:y.key)||"",Ee=l(re.id);te.innerHTML=`
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <div class="flex items-center space-x-2">
                <h3 class="font-medium text-gray-800">${re.description}</h3>
                ${ne?'<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">Custom</span>':""}
              </div>
              <p class="text-sm text-gray-500 mt-1">Action: ${re.id}</p>
              ${ne?`<p class="text-xs text-gray-400 mt-1">Default: ${ye}</p>`:""}
      ${Ee?`<p class="text-xs text-blue-700 mt-2"><span class="bg-blue-50 border border-blue-200 rounded px-2 py-0.5">Touch: ${Ee}</span></p>`:""}
            </div>
            <div class="flex items-center space-x-2">
              <code class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">${re.key}</code>
              <div class="edit-shortcut-btn" data-shortcut-id="${re.id}"></div>
              ${ne?`<div class="reset-shortcut-btn" data-shortcut-id="${re.id}"></div>`:""}
            </div>
          </div>
        `,I.appendChild(te);const we=te.querySelector(".edit-shortcut-btn"),R=me("Edit");if(R.onclick=()=>m(re.id),we.appendChild(R),ne){const v=te.querySelector(".reset-shortcut-btn"),x=me("Reset");x.onclick=()=>w(re.id),v.appendChild(x)}})})}function j(){n.querySelector("#keyboard-search").addEventListener("input",I=>{const B=I.target.value.toLowerCase();if(!B.trim()){d(t);return}const E=De.getShortcuts().filter(F=>F.description.toLowerCase().includes(B)||F.key.toLowerCase().includes(B)||F.id.toLowerCase().includes(B));_(B,E)})}const A=n.querySelector("#keyboard-reset-btn-container"),M=n.querySelector("#keyboard-export-btn-container"),O=n.querySelector("#keyboard-help-btn-container"),H=me("Reset All to Defaults");H.onclick=b,H.style.width="100%",A.appendChild(H);const Z=me("Export Settings");Z.onclick=C,Z.style.width="100%",M.appendChild(Z);const X=me("Help");X.onclick=()=>{typeof window.showDialogBox=="function"&&window.showDialogBox(`
        <h3>Keyboard Shortcuts Help</h3>
        <p><strong>Editing Shortcuts:</strong> Click "Edit" next to any shortcut to assign a new key combination.</p>
        <p><strong>Resetting:</strong> Use "Reset" to restore a shortcut to its default, or "Reset All" for everything.</p>
        <p><strong>Key Combinations:</strong> You can use Ctrl, Alt, Shift, and Meta (Windows/Cmd) keys with letters, numbers, and function keys.</p>
        <p><strong>Search:</strong> Use the search box to quickly find specific shortcuts.</p>
        <p><strong>Export:</strong> Save your custom shortcuts to a file for backup or sharing.</p>
  ${r?"<p><strong>Touch:</strong> Swipe the taskbar to switch windows; two-finger tap on the desktop to show the desktop; two-finger swipe on a window title bar to minimize (down) or maximize (up). Touch equivalents appear under each shortcut.</p>":""}
      `,"info")},O.appendChild(X),j(),n.dataset.keyboardInitialized="true"}typeof window<"u"&&(window.keyboardService=De,window.launchKeyboard=Ji,window.initializeKeyboardApp=Qi);function ho({windowId:e,container:n,overlayText:t="Paused",overlayZ:i=50}){if(!n)throw new Error("Pause controller: container required");const o=n.style.position;(!o||o==="static")&&(n.style.position="relative");const r=document.createElement("div");r.className="game-pause-overlay",Object.assign(r.style,{position:"absolute",inset:"0",display:"none",background:"rgba(0,0,0,0.55)",color:"white",fontFamily:"monospace",fontSize:"36px",fontWeight:"bold",alignItems:"center",justifyContent:"center",zIndex:String(i),pointerEvents:"none"}),r.textContent=t,n.appendChild(r);let a=!1,s=!1;function l(){const f=Array.from(document.querySelectorAll("#windows-container > div")).filter(g=>g.style.display!=="none"&&g.id!=="taskbar");return f.length?(f.sort((g,w)=>(parseInt(w.style.zIndex)||0)-(parseInt(g.style.zIndex)||0)),f[0].id||null):null}function c(){if(s)return;const f=document.hidden||l()!==e;f!==a&&(a=f,r.style.display=a?"flex":"none")}function d(){c()}document.addEventListener("visibilitychange",d);const p=document.getElementById("windows-container");let m=null;p&&"MutationObserver"in window&&(m=new MutationObserver(()=>{requestAnimationFrame(c)}),m.observe(p,{childList:!0,subtree:!1}));function u(){s=!0,document.removeEventListener("visibilitychange",d),m&&m.disconnect(),r&&r.parentElement===n&&r.remove()}return{get paused(){return a},overlay:r,recompute:c,destroy:u}}function er(){const e=document.getElementById("pong");if(e){ke(e);return}const n=window.innerWidth<600,t=n?Math.min(window.innerWidth-20,700):700,i=n?Math.min(window.innerHeight-60,500):500,o=ae("Pong","",!1,"pong",!1,!1,{type:"integer",width:t,height:i},"App",null,"black");yo(o).catch(console.error)}async function yo(e){if(!e&&(e=document.getElementById("pong"),!e))return;const n=e.querySelector(".p-2");n.className="p-2 bg-black h-full overflow-hidden flex flex-col",n.innerHTML="";const t=document.createElement("div");t.className="flex items-center justify-between text-white px-2 pb-2",t.style.fontFamily="monospace",t.innerHTML='<div>üôã Player</div><div id="pong-score">0 - 0</div><div>High: <span id="pong-high-score">0</span></div>';const i=document.createElement("div");i.className="flex-1 flex items-center justify-center";const o=document.createElement("canvas");o.id="pong-canvas",o.style.background="#000",o.style.border="2px inset #666";const r=window.innerWidth<600;o.width=r?Math.min(window.innerWidth-40,640):640,o.height=r?Math.min(window.innerHeight-150,360):360,i.appendChild(o);const a=document.createElement("div");a.className="text-xs text-gray-300 pt-2",a.textContent=r?"Drag on screen to move paddle.":"Controls: W/S or Up/Down to move paddle. Click canvas to focus.",n.appendChild(t),n.appendChild(i),n.appendChild(a);const s=o.getContext("2d");let l=0,c=0,d=0;d=await z.getItem("pong-high-score")||0;const p={paddleHeight:60,paddleWidth:8,playerY:(o.height-60)/2,aiY:(o.height-60)/2,ballX:o.width/2,ballY:o.height/2,ballVX:3,ballVY:2,ballRadius:6,upPressed:!1,downPressed:!1,running:!0,rafId:null},m=ho({windowId:"pong",container:i,overlayZ:10});function u(A=1){p.ballX=o.width/2,p.ballY=o.height/2,p.ballVX=3*A,p.ballVY=Math.random()*3-1.5}function f(){s.fillStyle="#000",s.fillRect(0,0,o.width,o.height),s.fillStyle="#444";for(let A=0;A<o.height;A+=20)s.fillRect(o.width/2-1,A+5,2,10);s.fillStyle="#fff",s.fillRect(20,p.playerY,p.paddleWidth,p.paddleHeight),s.fillRect(o.width-20-p.paddleWidth,p.aiY,p.paddleWidth,p.paddleHeight),s.beginPath(),s.arc(p.ballX,p.ballY,p.ballRadius,0,Math.PI*2),s.fill()}function g(A){p.upPressed&&(p.playerY-=6*A),p.downPressed&&(p.playerY+=6*A),p.playerY=Math.max(0,Math.min(o.height-p.paddleHeight,p.playerY));const M=p.aiY+p.paddleHeight/2;if(M<p.ballY-10&&(p.aiY+=3.2*A),M>p.ballY+10&&(p.aiY-=3.2*A),p.aiY=Math.max(0,Math.min(o.height-p.paddleHeight,p.aiY)),p.ballX+=p.ballVX*A,p.ballY+=p.ballVY*A,(p.ballY-p.ballRadius<=0||p.ballY+p.ballRadius>=o.height)&&(p.ballVY=-p.ballVY),p.ballX-p.ballRadius<=20+p.paddleWidth&&p.ballY>=p.playerY&&p.ballY<=p.playerY+p.paddleHeight){p.ballVX=-p.ballVX;const O=(p.ballY-(p.playerY+p.paddleHeight/2))/(p.paddleHeight/2);p.ballVY+=O*2,p.ballX=20+p.paddleWidth+p.ballRadius+1}if(p.ballX+p.ballRadius>=o.width-20-p.paddleWidth&&p.ballY>=p.aiY&&p.ballY<=p.aiY+p.paddleHeight){p.ballVX=-p.ballVX;const O=(p.ballY-(p.aiY+p.paddleHeight/2))/(p.paddleHeight/2);p.ballVY+=O*2,p.ballX=o.width-20-p.paddleWidth-p.ballRadius-1}p.ballX<0&&(c+=1,C(),u(1)),p.ballX>o.width&&(l+=1,l>d&&(d=l,z.setItemSync("pong-high-score",d),window.isDevvit&&window.parent.postMessage({type:"setGameScore",data:{game:"pong",score:d}},"*")),C(),u(-1))}let w=null;function b(A){if(!p.running)return;m.recompute(),w==null&&(w=A);const M=A-w;w=A;let O=M/(1e3/60);O>3&&(O=3),m.paused||(g(O),f()),p.rafId=requestAnimationFrame(b)}function C(){const A=document.getElementById("pong-score"),M=document.getElementById("pong-high-score");A&&(A.textContent=`${l} - ${c}`),M&&(M.textContent=String(d))}function h(A){(A.key==="w"||A.key==="W"||A.key==="ArrowUp")&&(p.upPressed=!0),(A.key==="s"||A.key==="S"||A.key==="ArrowDown")&&(p.downPressed=!0)}function _(A){(A.key==="w"||A.key==="W"||A.key==="ArrowUp")&&(p.upPressed=!1),(A.key==="s"||A.key==="S"||A.key==="ArrowDown")&&(p.downPressed=!1)}o.addEventListener("touchmove",A=>{if(A.preventDefault(),A.touches.length>0){const M=A.touches[0].clientY,O=o.getBoundingClientRect(),H=M-O.top;p.playerY=H-p.paddleHeight/2,p.playerY=Math.max(0,Math.min(o.height-p.paddleHeight,p.playerY))}},{passive:!1}),o.addEventListener("touchstart",A=>{A.preventDefault()},{passive:!1}),o.addEventListener("click",()=>o.focus()),o.setAttribute("tabindex","0"),o.style.outline="none",document.addEventListener("keydown",h),document.addEventListener("keyup",_);const N=new MutationObserver(A=>{A.forEach(M=>{M.removedNodes.forEach(O=>{O.id==="pong"&&(j(),N.disconnect())})})});N.observe(document.getElementById("windows-container"),{childList:!0});function j(){p.running=!1,p.rafId&&cancelAnimationFrame(p.rafId),document.removeEventListener("keydown",h),document.removeEventListener("keyup",_),m.destroy()}u(1),C(),p.rafId=requestAnimationFrame(b)}typeof window<"u"&&(window.initializePongUI=yo);function tr(){const e=document.getElementById("snake");if(e){ke(e);return}const n=window.innerWidth<600,t=n?Math.min(window.innerWidth-20,620):620,i=n?Math.min(window.innerHeight-60,520):520,o=ae("Snake","",!1,"snake",!1,!1,{type:"integer",width:t,height:i},"App",null,"black");bo(o).catch(console.error)}async function bo(e){if(!e&&(e=document.getElementById("snake"),!e))return;const n=e.querySelector(".p-2");n.className="p-2 bg-black h-full overflow-hidden flex flex-col items-center",n.innerHTML="";const t=document.createElement("div");t.className="w-full flex items-center justify-between text-white px-2 pb-2",t.style.fontFamily="monospace",t.innerHTML='<div>Score: <span id="snake-score">0</span></div><div id="snake-status">Playing</div><div>High: <span id="snake-high-score">0</span></div>';const i=document.createElement("div");i.className="flex-1 flex items-center justify-center w-full";const o=document.createElement("canvas");o.id="snake-canvas";const r=window.innerWidth<600;o.width=r?Math.min(window.innerWidth-40,560):560,o.height=r?Math.min(window.innerHeight-150,420):420,o.style.background="#000",o.style.border="2px inset #666",i.appendChild(o);const a=document.createElement("div");a.className="text-xs text-gray-300 pt-2",a.textContent=r?"Swipe to move. Tap R to restart.":"Controls: Arrow keys or W/A/S/D. Press R to restart.",n.appendChild(t),n.appendChild(i),n.appendChild(a);const s=o.getContext("2d"),l=20,c=Math.floor(o.width/l),d=Math.floor(o.height/l);let p=[{x:Math.floor(c/2),y:Math.floor(d/2)}],m={x:1,y:0},u=null,f=0,g=0,w=!0,b=8,C=0,h=null;const _=ho({windowId:"snake",container:i,overlayZ:10});g=await z.getItem("snake-high-score")||0;function N(){let E=!1;for(;!E;){const F=Math.floor(Math.random()*c),V=Math.floor(Math.random()*d);E=!p.some(ee=>ee.x===F&&ee.y===V),E&&(u={x:F,y:V})}}function j(){p=[{x:Math.floor(c/2),y:Math.floor(d/2)}],m={x:1,y:0},f=0,w=!0,b=8,N(),A()}function A(){const E=document.getElementById("snake-score"),F=document.getElementById("snake-status"),V=document.getElementById("snake-length"),ee=document.getElementById("snake-high-score");E&&(E.textContent=String(f)),F&&(F.textContent=w?"Playing":"Game Over"),V&&(V.textContent=String(p.length)),ee&&(ee.textContent=String(g))}function M(){s.fillStyle="#000",s.fillRect(0,0,o.width,o.height),u&&(s.fillStyle="#e3342f",s.fillRect(u.x*l,u.y*l,l,l));for(let E=0;E<p.length;E++){const F=p[E];s.fillStyle=E%2===0?"#7ed957":"#5aa83d",s.fillRect(F.x*l,F.y*l,l-1,l-1)}}function O(){if(!w)return;const E={x:p[0].x+m.x,y:p[0].y+m.y};if(E.x<0&&(E.x=c-1),E.x>=c&&(E.x=0),E.y<0&&(E.y=d-1),E.y>=d&&(E.y=0),p.some(F=>F.x===E.x&&F.y===E.y)){w=!1,A();return}p.unshift(E),u&&E.x===u.x&&E.y===u.y?(f+=1,f>g&&(g=f,z.setItemSync("snake-high-score",g),window.isDevvit&&window.parent.postMessage({type:"setGameScore",data:{game:"snake",score:g}},"*")),f%5===0&&(b=Math.min(20,b+1)),N()):p.pop(),A()}let H=0;function Z(E){C||(C=E),_.recompute();let F=E-C;F>1e3&&(F=1e3),C=E,_.paused||(H+=F);const V=1e3/b;let ee=!1;for(;H>=V;)O(),H-=V,ee=!0;ee&&!_.paused&&M(),h=requestAnimationFrame(Z)}function X(E){const F=E.key;(F==="ArrowUp"||F==="w"||F==="W")&&m.y===0&&(m={x:0,y:-1}),(F==="ArrowDown"||F==="s"||F==="S")&&m.y===0&&(m={x:0,y:1}),(F==="ArrowLeft"||F==="a"||F==="A")&&m.x===0&&(m={x:-1,y:0}),(F==="ArrowRight"||F==="d"||F==="D")&&m.x===0&&(m={x:1,y:0}),(F==="r"||F==="R")&&j()}let S=0,I=0;o.addEventListener("touchstart",E=>{S=E.touches[0].clientX,I=E.touches[0].clientY,E.preventDefault()},{passive:!1}),o.addEventListener("touchmove",E=>{E.preventDefault()},{passive:!1}),o.addEventListener("touchend",E=>{if(!w)return;const F=E.changedTouches[0].clientX,V=E.changedTouches[0].clientY,ee=F-S,re=V-I;Math.abs(ee)>Math.abs(re)?Math.abs(ee)>30&&(ee>0&&m.x===0?m={x:1,y:0}:ee<0&&m.x===0&&(m={x:-1,y:0})):Math.abs(re)>30&&(re>0&&m.y===0?m={x:0,y:1}:re<0&&m.y===0&&(m={x:0,y:-1}))},{passive:!1}),o.addEventListener("click",()=>o.focus()),o.setAttribute("tabindex","0"),o.style.outline="none",document.addEventListener("keydown",X);const B=new MutationObserver(E=>{E.forEach(F=>{F.removedNodes.forEach(V=>{V.id==="snake"&&(D(),B.disconnect())})})});B.observe(document.getElementById("windows-container"),{childList:!0});function D(){w=!1,h&&cancelAnimationFrame(h),document.removeEventListener("keydown",X),_.destroy()}j(),M(),h=requestAnimationFrame(Z)}typeof window<"u"&&(window.initializeSnakeUI=bo);function nr(){const e=document.getElementById("happyturd");if(e){ke(e);return}const n=window.innerWidth<600,t=n?Math.min(window.innerWidth-20,360):360,i=n?Math.min(window.innerHeight-60,640):640,o=ae("Happy Turd","",!1,"happyturd",!1,!1,{type:"integer",width:t,height:i},"App",null,"black");wo(o).catch(console.error)}async function wo(e){if(!e&&(e=document.getElementById("happyturd"),!e))return;const n=e.querySelector(".p-2");n.className="p-2 bg-black h-full overflow-hidden flex flex-col",n.innerHTML="";let t=await z.getItem("happyturd-difficulty")||"medium",i=re(t),o=await z.getItem("happyturd-theme")||"system";const r=document.createElement("div");r.className="flex items-center justify-between px-2 py-1 bg-gray-800 border-b border-gray-600",r.innerHTML=`
    <div class="flex items-center gap-2">
      <div class="relative">
        <button id="difficultyMenuBtn" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded border border-gray-600 flex items-center gap-1" onclick="toggleDifficultyDropdown(event)">
          Difficulty
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div id="difficultyDropdown" class="absolute left-0 top-full mt-1 w-32 bg-gray-700 border border-gray-600 rounded shadow-lg z-50 hidden">
          <button class="w-full text-left px-3 py-2 text-white hover:bg-gray-600 flex items-center justify-between text-sm" onclick="setDifficulty('easy')">
            <span>Easy</span>
            <span id="easy-check" class="text-green-400 ${t==="easy"?"":"hidden"}">‚úì</span>
          </button>
          <button class="w-full text-left px-3 py-2 text-white hover:bg-gray-600 flex items-center justify-between text-sm" onclick="setDifficulty('medium')">
            <span>Medium</span>
            <span id="medium-check" class="text-green-400 ${t==="medium"?"":"hidden"}">‚úì</span>
          </button>
          <button class="w-full text-left px-3 py-2 text-white hover:bg-gray-600 flex items-center justify-between text-sm" onclick="setDifficulty('hard')">
            <span>Hard</span>
            <span id="hard-check" class="text-green-400 ${t==="hard"?"":"hidden"}">‚úì</span>
          </button>
        </div>
      </div>
      <div class="relative">
        <button id="themeMenuBtn" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded border border-gray-600 flex items-center gap-1" onclick="toggleThemeDropdown(event)">
          Theme
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div id="themeDropdown" class="absolute left-0 top-full mt-1 w-32 bg-gray-700 border border-gray-600 rounded shadow-lg z-50 hidden">
          <button class="w-full text-left px-3 py-2 text-white hover:bg-gray-600 flex items-center justify-between text-sm" onclick="setTheme('system')">
            <span>System</span>
            <span id="system-check" class="text-green-400 ${o==="system"?"":"hidden"}">‚úì</span>
          </button>
          <button class="w-full text-left px-3 py-2 text-white hover:bg-gray-600 flex items-center justify-between text-sm" onclick="setTheme('light')">
            <span>Light</span>
            <span id="light-check" class="text-green-400 ${o==="light"?"":"hidden"}">‚úì</span>
          </button>
          <button class="w-full text-left px-3 py-2 text-white hover:bg-gray-600 flex items-center justify-between text-sm" onclick="setTheme('dark')">
            <span>Dark</span>
            <span id="dark-check" class="text-green-400 ${o==="dark"?"":"hidden"}">‚úì</span>
          </button>
        </div>
      </div>
    </div>
  `;const a=document.createElement("div");a.className="w-full flex items-center justify-between text-white px-2 pb-2",a.style.fontFamily="monospace",a.innerHTML='<div>Best: <span id="happyturd-best">0</span></div><div id="happyturd-score">0</div><div id="happyturd-status">Playing</div>';const s=document.createElement("div");s.className="flex-1 flex items-center justify-center w-full";const l=document.createElement("canvas");l.id="happyturd-canvas";const c=window.innerWidth<600;l.width=c?Math.min(window.innerWidth-40,320):320,l.height=c?Math.min(window.innerHeight-150,480):480,l.style.background="#87ceeb",l.style.border="2px inset #666",s.appendChild(l);const d=document.createElement("div");d.id="happyturd-intro",d.className="absolute inset-0 bg-black/70 flex flex-col items-center justify-center z-10",d.style.display="flex",d.style.fontFamily="monospace";const p=document.createElement("img");p.src="/image/happyturd.webp",p.alt="Happy Turd Logo",p.className="w-20 h-20 md:w-32 md:h-32 mb-4 md:mb-8 drop-shadow-lg";const m=document.createElement("h1");m.textContent="Happy Turd",m.className="text-white text-lg md:text-xl font-bold mb-2 md:mb-8 text-center drop-shadow-lg",m.style.fontFamily="monospace";const u=document.createElement("div");u.className="text-white text-xs md:text-sm mb-2 md:mb-8 text-left max-w-xs drop-shadow",u.style.fontFamily="monospace",u.innerHTML=`
    <p class="mb-4">Help the turd fly past the pipes!</p>
    <p class="mb-2">‚Ä¢ Click or press SPACE to flap</p>
    <p class="mb-2">‚Ä¢ Avoid the pipes</p>
    <p class="mb-2">‚Ä¢ Collect points by passing between the pipes</p>
    <p class="mb-4">‚Ä¢ Don't hit the ground, ceiling, or pipes</p>
  `;const f=document.createElement("button");f.textContent="Start Game",f.className=" px-4 md:px-8 py-1.5 md:py-3 bg-green-600 hover:bg-green-700 text-white text-xl font-bold rounded-lg border-2 border-green-400 transition-colors drop-shadow-lg",f.style.fontFamily="monospace",f.onclick=()=>et(),d.appendChild(p),d.appendChild(m),d.appendChild(u),d.appendChild(f);const g=document.createElement("div");g.id="happyturd-gameover",g.className="absolute inset-0 bg-black/20 flex flex-col items-center justify-center z-10",g.style.display="none",g.style.fontFamily="monospace",g.style.opacity="0",g.style.transition="opacity 200ms ease-in-out";const w=document.createElement("h1");w.textContent="Game Over",w.className="text-white text-3xl font-bold mb-6 text-center drop-shadow-lg",w.style.fontFamily="monospace";const b=document.createElement("div");b.className="text-white text-xl mb-4 text-center drop-shadow",b.style.fontFamily="monospace",b.innerHTML=`
    <p class="mb-2">Score: <span id="gameover-score" class="text-yellow-400 font-bold">0</span></p>
    <p class="mb-2">Best: <span id="gameover-best" class="text-green-400 font-bold">0</span></p>
    <p id="new-high-score" class="text-red-400 font-bold text-lg" style="display: none;">üéâ New High Score! üéâ</p>
  `;const C=document.createElement("button");C.textContent="Try Again",C.className="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold rounded-lg border-2 border-blue-400 transition-colors drop-shadow-lg mt-4",C.style.fontFamily="monospace",C.onclick=()=>lt(),g.appendChild(w),g.appendChild(b),g.appendChild(C),s.style.position="relative",s.appendChild(d),s.appendChild(g),n.appendChild(r),n.appendChild(a),n.appendChild(s);const h=l.getContext("2d");let _=0,N=0;const j=.45,A=-8.5;let M=0,O=60,H=l.height/2;const Z=28;let X="intro",S=0,I=0;const B=8,D=2;let E=[],F=!1;const V=120;let ee=0;N=await z.getItem("happyturd-best-score")||0;function re(W){switch(W){case"easy":return 260;case"medium":return 195;case"hard":return 130;default:return 195}}window.toggleDifficultyDropdown=function(W){W.stopPropagation(),document.getElementById("difficultyDropdown").classList.toggle("hidden")},window.setDifficulty=async function(W){t=W,i=re(W),document.getElementById("easy-check").classList.toggle("hidden",W!=="easy"),document.getElementById("medium-check").classList.toggle("hidden",W!=="medium"),document.getElementById("hard-check").classList.toggle("hidden",W!=="hard"),await z.setItem("happyturd-difficulty",W),document.getElementById("difficultyDropdown").classList.add("hidden"),qe()},document.addEventListener("click",function(W){const K=document.getElementById("difficultyDropdown"),G=document.getElementById("difficultyMenuBtn");K&&G&&!K.contains(W.target)&&!G.contains(W.target)&&K.classList.add("hidden")}),window.toggleThemeDropdown=function(W){W.stopPropagation(),document.getElementById("themeDropdown").classList.toggle("hidden")},window.setTheme=async function(W){o=W,document.getElementById("system-check").classList.toggle("hidden",W!=="system"),document.getElementById("light-check").classList.toggle("hidden",W!=="light"),document.getElementById("dark-check").classList.toggle("hidden",W!=="dark"),await z.setItem("happyturd-theme",W),document.getElementById("themeDropdown").classList.add("hidden"),$(),Y&&cancelAnimationFrame(Y),Y=requestAnimationFrame(ct)},document.addEventListener("click",function(W){const K=document.getElementById("themeDropdown"),G=document.getElementById("themeMenuBtn");K&&G&&!K.contains(W.target)&&!G.contains(W.target)&&K.classList.add("hidden")});const te=[],ne=52;let ye=0;const Ee=90;let we=[],R=[],y=[],v=[];const x=()=>o==="dark"?!0:o==="light"?!1:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;let k=[];const $=()=>{k=x()?Array.from({length:50},()=>({x:Math.random()*l.width,y:Math.random()*(l.height*.6),size:Math.random()*2+.5,brightness:Math.random()*.5+.5})):[]};$();const L={x:l.width*.8,y:50,size:35,rays:Array.from({length:12},(W,K)=>({angle:K/12*Math.PI*2,length:35*(.8+Math.random()*.4)}))};let U=!0,Y=null;const q=ho({windowId:"happyturd",container:s,overlayZ:30});function ce(){const W=40+Math.random()*(l.height-i-120);te.push({x:l.width,top:W,passed:!1})}function ge(){const W=20+Math.random()*100,K=20+Math.random()*30;we.push({x:l.width+Math.random()*200,y:W,size:K,puffs:Array.from({length:3+Math.floor(Math.random()*3)},()=>({x:(Math.random()-.5)*K,y:(Math.random()-.5)*K*.5,radius:K*(.3+Math.random()*.4)}))})}function Be(){const W=l.height,K=200+Math.random()*150,G=40+Math.random()*80;R.push({x:l.width+Math.random()*300,baseY:W,width:K,height:G,color:`hsl(${80+Math.random()*40}, ${30+Math.random()*20}%, ${30+Math.random()*30}%)`})}function Le(){const W=l.height-40,K=80+Math.random()*100,G=60+Math.random()*80;y.push({x:l.width+Math.random()*500,baseY:W,height:K,width:G,peaks:Array.from({length:2+Math.floor(Math.random()*3)},()=>({offset:(Math.random()-.5)*G*.8,height:.7+Math.random()*.3}))})}function Ge(){const W=50+Math.floor(Math.random()*10);for(let K=0;K<W;K++)v.push({x:Math.random()*l.width,height:15+Math.random()*10})}function We(W,K){E=[],F=!0,ee=V;const G=15+Math.floor(Math.random()*6);for(let P=0;P<G;P++){const de=Math.PI*2*P/G+(Math.random()-.5)*.5,pe=2+Math.random()*4,ve=3+Math.random()*5;E.push({x:W,y:K,vx:Math.cos(de)*pe,vy:Math.sin(de)*pe-Math.random()*2,size:ve,opacity:1,rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*.2})}}function et(){X="playing";const W=document.getElementById("happyturd-intro");W&&(W.style.display="none"),qe()}function lt(){const W=document.getElementById("happyturd-gameover");W&&(W.style.opacity="0",setTimeout(()=>{W.style.display="none"},200)),qe()}function qe(){_=0,M=0,H=l.height/2,te.length=0,ye=0,U=!0,X="playing",Ke();const W=document.getElementById("happyturd-gameover");W&&(W.style.opacity="0",setTimeout(()=>{W.style.display="none"},200)),E=[],F=!1,ee=0,we.length=0,R.length=0,y.length=0,v.length=0;for(let K=0;K<5;K++)ge();for(let K=0;K<3;K++)Be();for(let K=0;K<4;K++)Le();Ge()}function Ke(){const W=document.getElementById("happyturd-score"),K=document.getElementById("happyturd-status"),G=document.getElementById("happyturd-best");W&&(W.textContent=String(_)),K&&(X==="intro"?K.textContent="Ready":K.textContent=U?"Playing":"Game Over"),G&&(G.textContent=String(N))}function ht(W,K){S>0&&(h.font=`${Z*1}px serif`,h.textAlign="center",h.textBaseline="middle",h.save(),h.translate(W-Z*.4,K),h.scale(-1,1),h.fillText("ü™Ω",0,0),h.restore(),h.fillText("ü™Ω",W+Z*.4,K));const G=U?"üí©":"‚ò†Ô∏è";h.font=`${Z}px serif`,h.fillText(G,W,K+2)}function Re(){const W=x(),K=h.createLinearGradient(0,0,0,l.height);W?(K.addColorStop(0,"#000011"),K.addColorStop(1,"#000033")):(K.addColorStop(0,"#87ceeb"),K.addColorStop(1,"#4a90e2")),h.fillStyle=K,h.fillRect(0,0,l.width,l.height),W&&(h.fillStyle="rgba(255, 255, 255, 0.8)",k.forEach(P=>{h.beginPath(),h.arc(P.x,P.y,P.size,0,Math.PI*2),h.fill()})),W?(h.fillStyle="#E6E6E6",h.beginPath(),h.arc(L.x,L.y,L.size,0,Math.PI*2),h.fill(),h.fillStyle="#CCCCCC",h.beginPath(),h.arc(L.x-L.size*.2,L.y-L.size*.1,L.size*.15,0,Math.PI*2),h.fill(),h.beginPath(),h.arc(L.x+L.size*.3,L.y+L.size*.2,L.size*.1,0,Math.PI*2),h.fill(),h.fillStyle="#000",h.strokeStyle="#000",h.beginPath(),h.arc(L.x-L.size*.25,L.y-L.size*.15,L.size*.08,0,Math.PI*2),h.fill(),h.beginPath(),h.arc(L.x+L.size*.25,L.y-L.size*.15,L.size*.08,0,Math.PI*2),h.fill(),h.beginPath(),U?h.arc(L.x,L.y+L.size*.1,L.size*.3,0,Math.PI):h.arc(L.x,L.y+L.size*.25,L.size*.3,Math.PI,0),h.stroke()):(h.strokeStyle="#FFD700",h.lineWidth=2,h.beginPath(),L.rays.forEach(P=>{const de=L.x+Math.cos(P.angle)*P.length,pe=L.y+Math.sin(P.angle)*P.length;h.moveTo(L.x,L.y),h.lineTo(de,pe)}),h.stroke(),h.fillStyle="#FFFF00",h.beginPath(),h.arc(L.x,L.y,L.size,0,Math.PI*2),h.fill(),h.fillStyle="#000",h.beginPath(),h.arc(L.x-L.size*.3,L.y-L.size*.2,L.size*.1,0,Math.PI*2),h.fill(),h.beginPath(),h.arc(L.x+L.size*.3,L.y-L.size*.2,L.size*.1,0,Math.PI*2),h.fill(),h.beginPath(),U?h.arc(L.x,L.y+L.size*.1,L.size*.4,0,Math.PI):h.arc(L.x,L.y+L.size*.3,L.size*.4,Math.PI,0),h.stroke()),y.forEach(P=>{const de=h.createLinearGradient(0,P.baseY-P.height,0,P.baseY);de.addColorStop(0,"#444"),de.addColorStop(1,"#888"),h.fillStyle=de,h.beginPath(),h.moveTo(P.x,P.baseY),P.peaks.sort((pe,ve)=>pe.offset-ve.offset),P.peaks.forEach(pe=>{h.lineTo(P.x+P.width/2+pe.offset,P.baseY-P.height*pe.height)}),h.lineTo(P.x+P.width,P.baseY),h.closePath(),h.fill()}),R.forEach(P=>{const de=h.createLinearGradient(0,P.baseY-P.height,0,P.baseY);de.addColorStop(0,P.color.replace(/hsl\(([^,]+), ([^,]+)%, ([^%]+)%\)/,(pe,ve,_e,Me)=>`hsl(${ve}, ${_e}%, ${Math.max(60,parseInt(Me))}%)`)),de.addColorStop(1,P.color.replace(/hsl\(([^,]+), ([^,]+)%, ([^%]+)%\)/,(pe,ve,_e,Me)=>`hsl(${ve}, ${_e}%, ${Math.min(90,parseInt(Me)+20)}%)`)),h.fillStyle=de,h.beginPath(),h.ellipse(P.x+P.width/2,P.baseY,P.width/2,P.height,0,0,Math.PI*2),h.fill()}),h.fillStyle="rgba(255, 255, 255, 0.8)",we.forEach(P=>{P.puffs.forEach(de=>{h.beginPath(),h.arc(P.x+de.x,P.y+de.y,de.radius,0,Math.PI*2),h.fill()})});const G=h.createLinearGradient(0,l.height-40,0,l.height);G.addColorStop(0,"#A0522D"),G.addColorStop(1,"#654321"),h.fillStyle=G,h.fillRect(0,l.height-40,l.width,40),te.forEach(P=>{const de=h.createLinearGradient(P.x,0,P.x+ne,0);de.addColorStop(0,"#1a5d2e"),de.addColorStop(.3,"#2f9e44"),de.addColorStop(.7,"#2f9e44"),de.addColorStop(1,"#1a5d2e"),h.fillStyle=de,h.fillRect(P.x,0,ne,P.top);const pe=h.createLinearGradient(P.x,0,P.x+ne,0);pe.addColorStop(0,"#1a5d2e"),pe.addColorStop(.3,"#2f9e44"),pe.addColorStop(.7,"#2f9e44"),pe.addColorStop(1,"#1a5d2e"),h.fillStyle=pe,h.fillRect(P.x,P.top+i,ne,l.height-(P.top+i)-40);const ve=ne/2,_e=ve*.8,Me=ne*1.3,Ae=(Me-ne)/2,Ft=P.x+ne/2,On=Math.max(0,P.top-_e),nt=h.createLinearGradient(P.x-Ae,0,P.x-Ae+Me,0);nt.addColorStop(0,"#2a7a4a"),nt.addColorStop(.3,"#4ade80"),nt.addColorStop(.7,"#4ade80"),nt.addColorStop(1,"#2a7a4a"),h.fillStyle=nt,h.fillRect(P.x-Ae,On,Me,P.top-On);const Qt=Math.min(l.height-40,P.top+i+_e),yt=h.createLinearGradient(P.x-Ae,0,P.x-Ae+Me,0);yt.addColorStop(0,"#2a7a4a"),yt.addColorStop(.3,"#4ade80"),yt.addColorStop(.7,"#4ade80"),yt.addColorStop(1,"#2a7a4a"),h.fillStyle=yt,h.fillRect(P.x-Ae,P.top+i,Me,Qt-(P.top+i)),Math.min(l.height-40,P.top+i+_e);const Pt=h.createLinearGradient(P.x-Ae,0,P.x-Ae+Me,0);Pt.addColorStop(0,"#2a7a4a"),Pt.addColorStop(.4,"#4ade80"),Pt.addColorStop(.6,"#4ade80"),Pt.addColorStop(1,"#2a7a4a"),h.fillStyle=Pt;const $t=Ft,zt=P.top+i-Ae*.05,Wn=Me*.5,Do=ve*.5;h.beginPath(),h.moveTo($t-Wn,zt),h.quadraticCurveTo($t,zt-Do*1.1,$t+Wn,zt),h.quadraticCurveTo($t,zt+Do*.8,$t-Wn,zt),h.closePath(),h.fill(),h.fillStyle="#000",h.save(),h.beginPath(),h.rect(P.x-Ae,P.top+i-Ae*1.5,Me,_e*.6),h.beginPath();const Nt=Ft,Ot=P.top+i+Ae*.3,Rn=ve,Bo=ve*.15;h.moveTo(Nt-Rn,Ot),h.quadraticCurveTo(Nt,Ot-Bo*2.5,Nt+Rn,Ot),h.quadraticCurveTo(Nt,Ot+Bo*1.1,Nt-Rn,Ot),h.closePath(),h.fill(),h.restore()}),ht(O,H),F&&E.forEach(P=>{h.save(),h.globalAlpha=P.opacity,h.translate(P.x,P.y),h.rotate(P.rotation),h.fillStyle="#8B4513",h.beginPath(),h.ellipse(0,0,P.size,P.size*.6,0,0,Math.PI*2),h.fill(),h.strokeStyle="#654321",h.lineWidth=1,h.stroke(),h.restore()}),h.fillStyle="#83d683",v.forEach(P=>{const pe=P.height/100;h.beginPath(),h.moveTo(P.x,l.height),h.lineTo(P.x-4*pe,l.height-40-P.height*.7),h.lineTo(P.x+4*.5*pe,l.height-40-P.height*.9),h.lineTo(P.x+4*pe,l.height-40-P.height*.6),h.closePath(),h.fill()})}function Nn(){if(H+Z/2>=l.height-40||H-Z/2<=0)return!0;for(const W of te){const K=(ne*1.3-ne)/2,G=W.x-K,P=W.x+ne+K,de=W.top,pe=W.top+i;if(O+Z/2>G&&O-Z/2<P&&(H-Z/2<de||H+Z/2>pe))return!0;const ve=ne/2,_e=W.x+ne/2,Me=ve*.3,Ae=O-_e,Ft=H-W.top;if(Math.sqrt(Ae*Ae+Ft*Ft)<Z/2+Me)return!0;const nt=O-_e,Qt=H-(W.top+i);if(Math.sqrt(nt*nt+Qt*Qt)<Z/2+Me)return!0}return!1}function Te(W){if(!U)return;M+=j*W,H+=M*W,S>0&&(S-=W,S<0&&(S=0),S===0&&I>0&&(I--,I>0&&(S=B)));for(const G of te)G.x-=2.2*W,!G.passed&&G.x+ne<O&&(G.passed=!0,_+=1,Ke());for(;te.length&&te[0].x+ne<-10;)te.shift();ye+=W,ye>=Ee&&(ye-=Ee,ce()),we.forEach(G=>G.x-=.8*W),R.forEach(G=>G.x-=1.2*W),y.forEach(G=>G.x-=.6*W),v.forEach(G=>G.x-=1.8*W),we=we.filter(G=>G.x>-100),R=R.filter(G=>G.x>-200),y=y.filter(G=>G.x>-100),v=v.filter(G=>G.x>10);const K=G=>1-Math.pow(1-G,W);if(Math.random()<K(.005)&&ge(),Math.random()<K(.003)&&Be(),Math.random()<K(.004)&&Le(),Math.random()<K(.006))for(let G=0;G<2+Math.floor(Math.random()*3);G++)v.push({x:l.width+Math.random()*50,height:15+Math.random()*10});if(Nn()){U=!1;const G=_>N;N=Math.max(N,_),z.setItemSync("happyturd-best-score",N),Ke();const P=document.getElementById("gameover-score"),de=document.getElementById("gameover-best"),pe=document.getElementById("new-high-score");P&&(P.textContent=String(_)),de&&(de.textContent=String(N)),pe&&(pe.style.display=G?"block":"none");const ve=document.getElementById("happyturd-gameover");ve&&setTimeout(()=>{ve.style.display="flex",ve.offsetHeight,ve.style.opacity="1"},500),We(O,H)}}let tt=null;function ct(W){tt==null&&(tt=W);let K=W-tt;tt=W;let G=K/(1e3/60);G>3&&(G=3),q.recompute(),!q.paused&&X==="playing"&&Te(G),!q.paused&&F&&(E.forEach(P=>{P.vy+=j*.3*G,P.x+=P.vx*G,P.y+=P.vy*G,P.rotation+=P.rotationSpeed*G,P.opacity=ee/V}),ee-=G,ee<=0&&(F=!1,E=[])),Re(),Y=requestAnimationFrame(ct)}function dt(){if(X==="intro"){et();return}U&&(M=A,S=B,I=D)}function Mo(W){W.code==="Space"&&(W.preventDefault(),dt()),(W.key==="r"||W.key==="R")&&qe()}l.addEventListener("click",()=>dt()),l.setAttribute("tabindex","0"),l.style.outline="none",document.addEventListener("keydown",Mo);const Ao=new MutationObserver(W=>{W.forEach(K=>{K.removedNodes.forEach(G=>{G.id==="happyturd"&&(Br(),Ao.disconnect())})})});Ao.observe(document.getElementById("windows-container"),{childList:!0});function Br(){U=!1,Y&&cancelAnimationFrame(Y),document.removeEventListener("keydown",Mo),q.destroy()}Ke(),Y=requestAnimationFrame(ct)}typeof window<"u"&&(window.initializeHappyTurdUI=wo);let Ze=[];async function Cn(){try{const e=`${Ue}${zr}`;try{const i=await fetch(e,{method:"GET",signal:AbortSignal.timeout(5e3)});if(i.ok){const o=await i.json();return Ze=o.data||o.apps||[],Ze}}catch{}const n=await fetch("/custom_branding/custom_apps.json");if(!n.ok)return console.warn("No custom apps configuration found locally"),[];const t=await n.json();return Ze=t.apps||t.data||[],Ze}catch(e){return console.warn("‚ùå Failed to load custom apps:",e),[]}}function or(){return Ze}function Zt(e){return`custom-${e.title.replace(/[^a-z0-9-]/gi,"-").toLowerCase()}`}function Ka(e){return e&&(e.startsWith("http://")||e.startsWith("https://"))}function In(e){return e.app_icon?Ka(e.app_icon)?e.app_icon:`/custom_branding/${e.app_icon}`:"./image/file.webp"}function Ln(e){return Ze.find(n=>Zt(n)===e)}function vo(e){const n=Ln(e);if(!n){console.warn(`‚ùå Custom app not found: ${e}`);return}const t=Zt(n),i=document.getElementById("windows-container"),o=i==null?void 0:i.querySelector(`#${t}`);if(o){ke(o);return}const r=In(n),a=ae(n.title,"",!1,t,!1,n.compostable==="true"||n.compostable===!0,{type:"integer",width:800,height:600},"App",null,"white",null,r);ir(a,n).catch(console.warn)}function Xa(e,n){const t=e.replace(/\/\*[\s\S]*?\*\//g,"");let i="",o="",r=0;const a=[];for(let s=0;s<t.length;s++){const l=t[s];if(l==='"'||l==="'"){const c=l;for(o+=l,s++;s<t.length;){const d=t[s];if(o+=d,d===c&&t[s-1]!=="\\")break;s++}continue}if(l==="{"){const c=o.trim();if(c.startsWith("@")){const d=c.toLowerCase().includes("keyframes");a[r]=d,i+=o+"{"}else{if(a.some(p=>p))i+=o+"{";else{const p=c.split(",").map(m=>(m=m.trim(),m?m.startsWith("@")?m:m.includes("html")||m.includes("body")?m.replace(/html|body/g,n):`${n} ${m}`:"")).join(", ");i+=p+" {"}a[r]=!1}o="",r++}else l==="}"?(i+=o+"}",o="",r--,r>=0&&(a[r]=!1)):o+=l}return i+o}async function ir(e,n){if(!e){console.warn("Window element not found");return}const t=e.querySelector(".p-2");if(!t){console.warn("Content container not found in window");return}try{if(!n.html_content)throw new Error("No HTML content provided");t.className="overflow-auto h-full bg-white";const i=`${e.id}-content`;t.id=i;let o=n.html_content;o.includes('<link rel="stylesheet"')&&console.warn(`‚ö†Ô∏è Custom App "${n.title}" contains external stylesheets (<link>). These cannot be scoped and may affect the global OS styles.`),o=o.replace(/<style[^>]*>([\s\S]*?)<\/style>/gi,(a,s)=>(console.log(`üé® Scoping CSS for app: ${n.title}`),`<style>${Xa(s,`#${i}`)}</style>`)),t.innerHTML=o,t.querySelectorAll("script").forEach(a=>{const s=document.createElement("script");Array.from(a.attributes).forEach(l=>{s.setAttribute(l.name,l.value)}),s.textContent=a.textContent,a.parentNode.replaceChild(s,a)})}catch(i){console.warn("‚ùå Failed to load custom app content:",i),t.innerHTML=`
      <div class="flex items-center justify-center h-full">
        <div class="text-center">
          <p class="text-red-600 font-bold mb-2">Error Loading App</p>
          <p class="text-gray-600">${i.message}</p>
        </div>
      </div>
    `}}function rr(){return Ze.filter(e=>e.filepath).map(e=>{const n=Zt(e);let t=e.filepath;return t.endsWith("/")&&!t.endsWith("://")&&(t=t.slice(0,-1)),{id:n,name:e.title,type:"app",fullPath:`${t}/${n}`,content_type:"html",contents:{},icon:In(e),isCustomApp:!0,customAppData:e}})}function Yt(){return Ze.filter(t=>{const i=t.start_menu;return i==="true"||i===!0||i==="True"}).reduce((t,i)=>{const o=i.start_menu_location||"default";t[o]||(t[o]=[]);const r=Zt(i);return t[o].push({id:r,text:i.title,icon:In(i),type:"item",isCustomApp:!0,customAppData:i}),t},{})}function Va(){return Ze.filter(e=>e.open_on_pageload==="true"||e.open_on_pageload===!0).map(e=>Zt(e))}function It(e){return e.startsWith("custom-")&&Ln(e)!==void 0}async function xo(e){const n=Ln(e);if(!n)return;const t=document.getElementById(e);if(!t)return;const i=In(n);if(i&&!t.dataset.customAppIcon){t.dataset.customAppIcon=i;const o=document.getElementById("tab-"+e);if(o){const r=o.querySelector("img");if(r)r.src=i;else{const a=document.createElement("img");a.src=i,a.className="h-4 w-4 mr-2",a.alt="",o.insertBefore(a,o.firstChild)}}}await ir(t,n)}typeof window<"u"&&(window.loadCustomApps=Cn,window.getCustomApps=or,window.launchCustomApp=vo,window.isCustomApp=It,window.restoreCustomApp=xo);const Za=Object.freeze(Object.defineProperty({__proto__:null,getAutoOpenApps:Va,getCustomAppById:Ln,getCustomApps:or,getCustomAppsForFileSystem:rr,getCustomAppsForStartMenu:Yt,isCustomApp:It,launchCustomApp:vo,loadCustomApps:Cn,restoreCustomApp:xo},Symbol.toStringTag,{value:"Module"}));function qt(e){if(console.log(`üîç openApp called with id: ${e}`),It(e)){console.log(`‚úÖ Identified as custom app: ${e}`),vo(e);return}console.log("‚ö†Ô∏è Not a custom app, checking built-in apps...");const n=document.getElementById(e);if(n)if(e==="keyboard")console.log("üîç Skipping generic keyboard element, will handle in keyboard case");else{const i=[...document.querySelectorAll("*")].filter(o=>getComputedStyle(o).zIndex>100&&getComputedStyle(o).zIndex<1e3).reduce((o,r)=>getComputedStyle(r).zIndex>getComputedStyle(o).zIndex?r:o,n);n.style.zIndex=`${parseInt(getComputedStyle(i).zIndex)+1}`;return}if(console.log(`üîç Checking app cases for ${e}...`),(e==="mailbox"||e.includes("shortcut-mailboxapp"))&&Ei(),(e==="watercolour"||e.includes("shortcut-watercolourapp"))&&Ii(),(e==="calculator"||e.includes("shortcut-calcapp"))&&Di(),(e==="solitaire"||e.includes("shortcut-solapp"))&&Ti(),(e==="chess"||e.includes("shortcut-chessapp"))&&Pi(),(e==="bombbroomer"||e.includes("shortcut-bombapp"))&&Gi(),(e==="mediaplayer"||e.includes("shortcut-mediaapp"))&&Xi(),(e==="compostbin"||e.includes("shortcut-compostbinapp"))&&wi(),(e==="storage"||e.includes("shortcut-storageapp"))&&ur(),(e==="tubestream"||e.includes("shortcut-tubestreamapp"))&&Si(),(e==="pong"||e.includes("shortcut-pongapp"))&&er(),(e==="snake"||e.includes("shortcut-snakeapp"))&&tr(),(e==="happyturd"||e.includes("shortcut-happyturdapp"))&&nr(),e==="keyboard"){const t=document.getElementById("keyboard-app");if(t){console.log("üîç Keyboard app window already exists, bringing to front");const o=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,a)=>getComputedStyle(a).zIndex>getComputedStyle(r).zIndex?a:r,t);t.style.zIndex=`${parseInt(getComputedStyle(o).zIndex)+1}`;return}Ji().catch(console.error)}console.log("üîç Finished checking all cases")}function ar(e){let n=0;e.addEventListener("pointerdown",function(t){let i=new Date().getTime(),o=i-n;if(o<300&&o>0){let r=new Event("mobiledbltap");e.dispatchEvent(r)}n=i})}function Ja(){document.querySelectorAll("[onmobiledbltap]").forEach(e=>{ar(e),e.addEventListener("mobiledbltap",function(){let n=e.getAttribute("onmobiledbltap");if(n)try{const t=new CustomEvent("mobiledbltap-action",{detail:{action:n,element:e}});document.dispatchEvent(t)}catch(t){console.error(`Error dispatching event for: ${n}`,t)}})}),document.addEventListener("mobiledbltap-action",function(e){const{action:n,element:t}=e.detail,i=["openExplorerInNewWindow","openApp","openShortcut"],o=n.match(/^(\w+)\((.*)\)$/);if(o){const[,r,a]=o;if(i.includes(r))try{if(r==="openExplorerInNewWindow"&&window.openExplorerInNewWindow){const s=a.replace(/['"]/g,"");window.openExplorerInNewWindow(s)}else if(r==="openApp"&&window.openApp){const s=a.replace(/['"]/g,"");window.openApp(s)}else r==="openShortcut"&&window.openShortcut&&window.openShortcut(t)}catch(s){console.error(`Error executing safe action ${r}:`,s)}else console.warn(`Blocked potentially unsafe action: ${r}`)}else console.warn(`Invalid action format: ${n}`)})}function Qa(e){ue.isActive=!0,ue.selectedIcon=e,e.classList.add("dragging","keyboard-dragging"),e.style.zIndex="99999",is(e),He("Drag mode activated. Use arrow keys to move, Enter to drop, or Escape to cancel."),as()}function dn(e=!1){if(!ue.isActive||!ue.selectedIcon)return;const n=ue.selectedIcon;n.classList.remove("dragging","keyboard-dragging"),n.style.zIndex="",rs(),ss(),e?(En(n),fe[n.id]={left:n.style.left,top:n.style.top},Q(),He("Icon moved successfully.")):He("Drag operation cancelled."),ue.isActive=!1,ue.selectedIcon=null}function es(e,n){if(!ue.isActive)return;const t=parseInt(e.style.left)||0,i=parseInt(e.style.top)||0,o=ue.moveStep;let r=t,a=i;switch(n){case"ArrowUp":a=Math.max(16,i-o);break;case"ArrowDown":a=i+o;break;case"ArrowLeft":r=Math.max(16,t-o);break;case"ArrowRight":r=t+o;break}e.style.left=r+"px",e.style.top=a+"px",xi(r+48,a+48,e)}function ts(e){if(!ue.isActive)return;const n=parseInt(e.style.left)||0,t=parseInt(e.style.top)||0,i=ue.gridStep,o=16+Math.round((n-16)/i)*i,r=16+Math.round((t-16)/i)*i;e.style.left=Math.max(16,o)+"px",e.style.top=Math.max(16,r)+"px",He("Icon snapped to grid.")}function ns(e){ue.cutIcon&&ue.cutIcon.classList.remove("cut-icon"),ue.cutIcon=e,e.classList.add("cut-icon"),He("Icon cut. Navigate to destination and press Ctrl+V to paste.")}function os(){if(!ue.cutIcon){He("No icon to paste.");return}const e=document.activeElement,n=ue.cutIcon;if(e&&e.classList.contains("draggable-icon")){const t=e.getBoundingClientRect(),i=document.getElementById("desktop").getBoundingClientRect(),o=t.left-i.left+120,r=t.top-i.top;n.style.left=o+"px",n.style.top=r+"px",En(n),fe[n.id]={left:n.style.left,top:n.style.top},Q()}n.classList.remove("cut-icon"),ue.cutIcon=null,He("Icon pasted successfully.")}function is(e){document.querySelectorAll(".desktop-folder-icon[data-item-id]").forEach(n=>{const t=vt(n.getAttribute("data-item-id")),i=n.getAttribute("data-item-id");(t&&t.type==="folder"||i==="compostbin")&&n!==e&&n.classList.add("drag-hover-target")})}function rs(){document.querySelectorAll(".drag-hover-target").forEach(e=>{e.classList.remove("drag-hover-target")}),document.querySelectorAll(".desktop-folder-icon").forEach(e=>{e.classList.remove("dragover")})}function as(e){const n=document.createElement("div");n.id="keyboard-drag-indicator",n.className="fixed bottom-4 left-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50",n.innerHTML=`
    <div class="text-sm font-medium">Keyboard Drag Mode</div>
    <div class="text-xs">‚Üë‚Üì‚Üê‚Üí Move ‚Ä¢ Enter Drop ‚Ä¢ Esc Cancel ‚Ä¢ G Grid Snap</div>
  `,document.body.appendChild(n)}function ss(){const e=document.getElementById("keyboard-drag-indicator");e&&e.remove()}async function ls(e){if(!ue.isActive)return;const n=e.getBoundingClientRect(),t=n.left+n.width/2,i=n.top+n.height/2,o=document.elementFromPoint(t,i),r=o==null?void 0:o.closest(".desktop-folder-icon[data-item-id]");if(r&&r!==e){const a=e.getAttribute("data-item-id"),s=r.getAttribute("data-item-id"),l=vt(s);if(s==="compostbin"){await Ct(a,"C://Desktop"),He("Icon moved to compost bin."),dn(!0);return}else if(l&&l.type==="folder"){await vn(a,s),He(`Icon moved to ${l.name} folder.`),dn(!0);return}}dn(!0)}async function he(){const e=document.getElementById("desktop-icons");e.innerHTML="",document.getElementById("windows-container").querySelectorAll(".desktop-folder-icon").forEach(c=>{c.parentElement&&c.parentElement.classList.contains("draggable-icon")&&c.parentElement.remove()});let i=await Ne();if(!i||!i.folders||!i.folders["C://Desktop"]){if(typeof Qn=="function")await Qn(),i=await Ne();else if(console.warn("initializeAppState not available, using default fileSystemState"),typeof window.fileSystemState<"u"?i=window.fileSystemState:typeof ot<"u"?i=ot:(console.error("No fileSystemState available, creating minimal fallback structure"),i={folders:{"C://":{Documents:{id:"Documents",name:"Documents",type:"folder",fullPath:"C://Documents",contents:{}},Desktop:{id:"Desktop",name:"Desktop",type:"folder",fullPath:"C://Desktop",contents:{compostbin:{id:"compostbin",name:"Compost Bin",type:"app",fullPath:"C://Desktop/compostbin",content_type:"html",contents:{},icon:"./image/compost-bin.webp"}}},Media:{id:"Media",name:"Media",type:"folder",fullPath:"C://Media",contents:{}}},"A://":{},"D://":{}}}),typeof xe=="function")try{xe(i)}catch(c){console.warn("Failed to update global file system state:",c)}}if(!i||!i.folders||!i.folders["C://Desktop"]){console.error("File system structure is still invalid after initialization attempts:",i);return}const o=i.folders["C://Desktop"]||{};o||(i.folders["C://Desktop"]={});const r=[];Object.values(o).forEach(c=>{const d=document.createElement("div");d.id="icon-"+c.id,d.className="flex flex-col items-center cursor-pointer draggable-icon desktop-folder-icon z-10 h-32 truncate-ellipsis w-24 text-wrap absolute",d.setAttribute("role","button"),d.setAttribute("tabindex","0"),d.setAttribute("aria-label",`${c.name} - Double-click to open`);let p=c.type==="folder"?"image/folder.webp":"image/file.webp";c.icon?p=c.icon:c.icon_url&&(p=c.icon_url),d.setAttribute("data-item-id",c.id),d.setAttribute("data-current-path","C://Desktop");const m=()=>{c.type==="ugc-file"||c.type==="file"?_t(c.id,null):c.type==="app"?qt(c.id):c.type==="folder"?wt(c.id):c.type==="shortcut"&&ln(d)};if(c.type==="ugc-file"||c.type==="file"?(d.addEventListener("dblclick",u=>{u.stopPropagation(),_t(c.id,u)}),d.addEventListener("mobiledbltap",u=>{u.stopPropagation(),_t(c.id,u)})):c.type==="app"?(d.dataset.isVendorApplication=!0,c.isCustomApp&&c.customAppData&&(d.dataset.compostable=String(c.customAppData.compostable)),p=c.icon,d.addEventListener("dblclick",()=>qt(c.id)),d.addEventListener("mobiledbltap",()=>qt(c.id))):c.type==="folder"?(d.addEventListener("dblclick",()=>wt(c.id)),d.addEventListener("mobiledbltap",()=>wt(c.id))):c.type==="shortcut"&&(d.dataset.url=c.url,p=c.icon_url,d.addEventListener("dblclick",()=>ln(d)),d.addEventListener("mobiledbltap",()=>ln(d))),d.addEventListener("keydown",function(u){if(u.key==="Enter"||u.key===" ")ue.isActive&&ue.selectedIcon===d?(u.preventDefault(),ls(d)):ue.isActive||(u.preventDefault(),m());else if(u.key==="Escape")ue.isActive&&ue.selectedIcon===d&&(u.preventDefault(),dn(!1));else if(u.key==="d"&&u.ctrlKey)u.preventDefault(),Qa(d);else if(u.key==="x"&&u.ctrlKey)u.preventDefault(),ns(d);else if(u.key==="v"&&u.ctrlKey)u.preventDefault(),os();else if(u.key==="g"&&ue.isActive&&ue.selectedIcon===d)u.preventDefault(),ts(d);else if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(u.key)){if(ue.isActive&&ue.selectedIcon===d)u.preventDefault(),es(d,u.key);else if(u.shiftKey){u.preventDefault();const f=parseInt(d.style.left)||0,g=parseInt(d.style.top)||0,w=5;let b=f,C=g;switch(u.key){case"ArrowUp":C=Math.max(16,g-w);break;case"ArrowDown":C=g+w;break;case"ArrowLeft":b=Math.max(16,f-w);break;case"ArrowRight":b=f+w;break}d.style.left=b+"px",d.style.top=C+"px",En(d),fe[d.id]={left:d.style.left,top:d.style.top},Q(),He(`Icon moved to position ${b}, ${C}`)}}}),d.innerHTML=`
      <img src="${p}" alt="${c.name} icon" class="mb-1 p-1 h-16 w-16 desktop-folder-icon drop-shadow-md" />
      <span class="text-xs text-white max-w-20 text-center desktop-folder-icon truncate block" style="text-shadow: 1px 1px 2px black, 0 0 1em black, 0 0 0.2em black;">${c.name}</span>
    `,fe[d.id]){const u=fe[d.id];d.style.left=u.left,d.style.top=u.top,r.push({left:parseInt(u.left),top:parseInt(u.top),width:96,height:128})}else{const u=ga(r);d.style.left=u.left+"px",d.style.top=u.top+"px",r.push({left:u.left,top:u.top,width:96,height:128})}e.appendChild(d),Sn(d),ar(d)});let a=0,s=0;e.querySelectorAll(".draggable-icon").forEach(c=>{const d=parseInt(c.style.left)||0,p=parseInt(c.style.top)||0;a=Math.max(a,d+100),s=Math.max(s,p+140)}),e.style.minWidth="100%",e.style.minHeight="100%",e.style.width=Math.max(window.innerWidth-32,a)+"px",e.style.height=Math.max(window.innerHeight-80,s)+"px",typeof Pe=="function"&&Pe()}Ja();typeof window<"u"&&(window.renderDesktopIcons=he,window.makeIconDraggable=Sn,window.applyDesktopSettings=ki,pa());document.addEventListener("click",e=>{if(e.target.closest("#bg-image-select-btn")&&yi((n,t)=>{const i=document.getElementById("bgImageName"),o=document.getElementById("bgImageValue");i&&(i.textContent=t.name),o&&(o.value=n)}),e.target.closest("#bg-image-clear-btn")){const n=document.getElementById("bgImageName"),t=document.getElementById("bgImageValue");n&&(n.textContent="None"),t&&(t.value="")}});function ae(e,n,t=!1,i=null,o=!1,r=!1,a={type:"default"},s="default",l=null,c="white",d=null,p=null){let m=n;i||(i="window-"+Date.now()),s==="Settings"&&(m=ya()),s==="Explorer"&&(typeof getExplorerWindowContent=="function"?m=n||getExplorerWindowContent():m=n),s==="App"&&(m=n);let u="";a.type==="integer"?u=`width: ${a.width}px; height: ${a.height}px; max-width:100%;`:u="width: 100%; height: 100%;";const f=document.createElement("div");f.id=i,f.className="absolute border border-gray-500 shadow-lg overflow-auto z-20",f.style.cssText=u,f.style.minWidth="320px",f.style.minHeight="200px",p&&(f.dataset.customAppIcon=p),f.setAttribute("role","dialog"),f.setAttribute("aria-label",e),f.setAttribute("aria-modal","false"),o?(f.style.display="none",f.setAttribute("aria-hidden","true")):f.setAttribute("aria-hidden","false"),f.textContent="";const g=document.createElement("div");g.className="relative w-full h-[calc(100%-2.5rem)]";const w=document.createElement("div");w.className="bg-handlebar-blue sticky top-0 left-0 text-white px-2 py-1 flex justify-between items-center cursor-move",w.style.backgroundColor="#003f7f",w.setAttribute("role","banner");const b=document.createElement("span");b.textContent=e,b.className="window-title flex-1 truncate pr-2",b.style.maxWidth="calc(100% - 120px)",b.id=`${i}-title`;const C=document.createElement("div");C.className="my-1 flex-shrink-0",C.setAttribute("role","group"),C.setAttribute("aria-label","Window controls");const h=document.createElement("button");h.id=`minimizeWindow-${i}`,h.className="bg-yellow-500 h-6 w-6 text-white",h.textContent="_",h.setAttribute("aria-label",`Minimize ${e}`),h.setAttribute("title","Minimize window"),h.addEventListener("click",I=>{Je(i),I.stopPropagation()});const _=document.createElement("button");_.id=`toggleFullScreen-${i}`,_.className="bg-green-500 h-6 w-6 text-white ml-1",_.textContent="‚õ∂",_.setAttribute("aria-label",`Toggle fullscreen for ${e}`),_.setAttribute("title","Toggle fullscreen"),_.addEventListener("click",I=>{Et(i),I.stopPropagation()});const N=document.createElement("button");N.id=`closeWindow-${i}`,N.className="bg-red-500 h-6 w-6 text-white ml-1",N.textContent="X",N.setAttribute("aria-label",`Close ${e}`),N.setAttribute("title","Close window"),N.addEventListener("click",I=>{le(i),I.stopPropagation()}),C.append(h,_,N),w.append(b,C);const j=document.createElement("div");if(j.className=`p-2 bg-${c} h-full ${s==="editor"?"w-full":""} overflow-auto`,j.innerHTML=m,j.setAttribute("role","main"),j.setAttribute("aria-labelledby",`${i}-title`),s==="default"&&(j.setAttribute("role","textbox"),j.setAttribute("aria-label",`Editable content for ${e}`),j.addEventListener("input",()=>{typeof updateContent=="function"&&updateContent(i,j.innerHTML)})),s==="Explorer"&&setTimeout(()=>{typeof Pe=="function"&&Pe()},50),g.append(w,j),f.appendChild(g),d!=null)f.style.zIndex=d,parseInt(d)>Se&&Rt(parseInt(d));else{try{const I=document.getElementById("windows-container");if(I){let B=Se;const D=I.children;for(let E=0;E<D.length;E++){const F=parseInt(getComputedStyle(D[E]).zIndex)||0;F>B&&(B=F)}B>Se&&Rt(B)}}catch{}Rt(Se+1),f.style.zIndex=Se}f.addEventListener("click",function(){ke(f)},!0),document.getElementById("windows-container").appendChild(f);const A=document.createElement("div");A.id="tab-"+i,A.className="bg-gray-200 border border-gray-500 px-2 py-1 cursor-pointer flex items-center",A.setAttribute("role","tab"),A.setAttribute("aria-label",`${e} window tab`),A.setAttribute("aria-pressed",o?"false":"true"),A.setAttribute("tabindex","0");const M=io(i,e);if(M){const I=document.createElement("img");I.src=M,I.className="h-4 w-4 mr-2",I.alt="",A.appendChild(I);const B=document.createElement("span");B.textContent=e,A.appendChild(B)}else A.textContent=e;const O=function(){f.style.display==="none"?(ke(f),A.setAttribute("aria-pressed","true")):(Je(f.id),A.setAttribute("aria-pressed","false"))};A.onclick=O,A.addEventListener("keydown",function(I){(I.key==="Enter"||I.key===" ")&&(I.preventDefault(),O())}),A.addEventListener("contextmenu",function(I){I.preventDefault(),Xr(I,i,f)}),document.getElementById("window-tabs").appendChild(A);const H=J[i],Z=H?H.position:null,X=H?H.dimensions:a,S=H?H.fullScreen:!1;if(J[i]={id:i,title:e,content:m,isNav:t,isMinimized:o,dimensions:r&&H?X:a,windowType:s,position:Z,fullScreen:S,color:c,zIndex:parseInt(f.style.zIndex)||Se},t&&(Oe[e]=i),o||ke(f),a.type!=="default"){if(r&&Z&&(f.style.left=Z.left,f.style.top=Z.top),r&&X&&X.type==="integer"){const I=window.innerWidth,B=window.innerHeight-48,D=30,E=I-10,F=B-D-10,V=Math.max(320,Math.min(X.width,E)),ee=Math.max(200,Math.min(X.height,F));f.style.width=V+"px",f.style.height=ee+"px",J[i]&&(J[i].dimensions={type:"integer",width:V,height:ee})}if(!r||!Z)if(l){let I=parseInt(l.style.left,10)||0,B=parseInt(l.style.top,10)||0,D=I+30,E=B+30,F=window.innerWidth,V=window.innerHeight-40,ee=a.width,re=a.height;if(D+ee>F||E+re>V){D=0,E=0;const te=Array.from(document.querySelectorAll("#windows-container > div")).find(ne=>(parseInt(ne.style.left,10)||0)<=10&&(parseInt(ne.style.top,10)||0)<=10);te&&(D=(parseInt(te.style.left,10)||0)+30)}f.style.left=D+"px",f.style.top=E+"px"}else f.style.left="100px",f.style.top="100px";ui(f),pi(f)}r||Q();try{ro(f)}catch{}return r&&S&&setTimeout(()=>{Et(i)},10),f}let Ye=-1,Gt=!1;function Zn(){const e=Array.from(document.querySelectorAll("#windows-container > div")).filter(n=>n.style.display!=="none"&&n.id!=="taskbar");if(e.length!==0){if(e.length===1){ke(e[0]);return}e.sort((n,t)=>{const i=parseInt(n.style.zIndex)||0;return(parseInt(t.style.zIndex)||0)-i}),Gt?Ye=(Ye+1)%e.length:(cs(e),Gt=!0,Ye=0),ko(Ye)}}function cs(e){const n=document.getElementById("window-cycle-popup"),t=document.getElementById("window-cycle-list");if(!n||!t)return;t.innerHTML="",e.forEach((o,r)=>{var p;const a=((p=o.querySelector(".window-title"))==null?void 0:p.textContent)||"Unknown Window",s=o.id,l=io(s,a),c=document.createElement("div");if(c.className="flex flex-col items-center p-3 border-2 border-transparent rounded-lg min-w-16 cursor-pointer hover:bg-gray-100 transition-all duration-200",c.setAttribute("data-window-index",r),l){const m=document.createElement("img");m.src=l,m.className="h-8 w-8 mb-1",m.alt="",c.appendChild(m)}else{const m=document.createElement("div");m.className="h-8 w-8 mb-1 bg-gray-400 rounded flex items-center justify-center text-white text-sm",m.textContent=a.charAt(0),c.appendChild(m)}const d=document.createElement("span");d.className="text-xs text-center break-words max-w-16",d.textContent=a.length>10?a.substring(0,10)+"...":a,c.appendChild(d),c.addEventListener("click",()=>{Ye=r,sr(e[r])}),t.appendChild(c)});const i=o=>{t.contains(o.target)||(Lt(),n.removeEventListener("click",i))};n.addEventListener("click",i),n.classList.remove("hidden"),n.style.display="flex",ko(0)}function ko(e){const n=document.querySelectorAll("#window-cycle-list > div");n.forEach(t=>{t.classList.remove("border-blue-500","bg-blue-100"),t.classList.add("border-transparent"),t.style.transform="translateY(0)",t.style.boxShadow="none"}),n[e]&&(n[e].classList.remove("border-transparent"),n[e].classList.add("border-blue-500","bg-blue-100"),n[e].style.transform="translateY(-2px)",n[e].style.boxShadow="0 4px 8px rgba(59, 130, 246, 0.3)")}function sr(e){var o;if(!e)return;ke(e),e.focus();const n=document.getElementById("window-cycle-popup");n&&(n.classList.add("hidden"),n.style.display="none"),Gt=!1,Ye=-1;const t=((o=e.querySelector(".window-title"))==null?void 0:o.textContent)||"Unknown Window";let i=document.getElementById("window-cycle-announce");i||(i=document.createElement("div"),i.id="window-cycle-announce",i.className="sr-only",i.setAttribute("aria-live","polite"),i.setAttribute("aria-atomic","true"),document.body.appendChild(i)),i.textContent=`Switched to ${t}`}function Lt(){if(Gt){const e=Array.from(document.querySelectorAll("#windows-container > div")).filter(n=>n.style.display!=="none"&&n.id!=="taskbar");if(e.length>0){e.sort((t,i)=>{const o=parseInt(t.style.zIndex)||0;return(parseInt(i.style.zIndex)||0)-o});const n=e[Ye]||e[0];sr(n)}}}function ei(e){if(e==="left"){if(!Gt)try{Zn()}catch{}try{const n=document.querySelectorAll("#window-cycle-list > div");n.length&&(Ye=(Ye-1+n.length)%n.length,ko(Ye))}catch{}setTimeout(()=>{try{Lt()}catch{}},10)}else if(e==="right"){try{Zn()}catch{}setTimeout(()=>{try{Lt()}catch{}},10)}}function ie(e,n,t=null,i=null,o={}){const r=n==="confirmation"||n==="confirm",a=n==="prompt",s=(r||a?"promptWindow-":"dialogWindow-")+Date.now(),l=r&&(t||i);let c;if(a){const m=o.defaultValue||"";c=`
      <div class="flex flex-col p-4 h-full justify-between">
        <div class="mb-4">
          <p class="text-sm mb-3">${e}</p>
          <input type="text" id="${s}-input" value="${m.replace(/"/g,"&quot;")}" class="w-full px-2 py-1 border-2 border-gray-400 bg-white" style="border-top-color:#808080; border-left-color:#808080; border-bottom-color:#ffffff; border-right-color:#ffffff; border-style: inset;" aria-label="Text input for prompt dialog" title="Enter your response here" />
        </div>
        <div class="flex gap-2 justify-center">
          <button id="${s}-ok-button" class="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2"><span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">OK</span></button>
          <button id="${s}-cancel-button" class="bg-gray-200 border-t-2 border-l-2 border-gray-300"><span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Cancel</span></button>
        </div>
      </div>
    `}else l?c=`
      <div class="text-center p-4">
        <h2 class="text-lg mb-4">${e}</h2>
        <div class="flex gap-2 justify-center">
          <button id="${s}-ok-button" class="bg-gray-200 border-2 border-gray-400 px-4 py-2 hover:bg-gray-300" style="border-style: outset;">
            OK
          </button>
          <button id="${s}-cancel-button" class="bg-gray-200 border-2 border-gray-400 px-4 py-2 hover:bg-gray-300" style="border-style: outset;">
            Cancel
          </button>
        </div>
      </div>
    `:c=`
      <div class="text-center p-4">
        <h2 class="text-lg mb-4">${e}</h2>
        <button id="${s}-button" class="bg-gray-200 border-2 border-gray-400 px-4 py-2 hover:bg-gray-300" style="border-style: outset;">
          OK
        </button>
      </div>
    `;let d="‚ö†Ô∏è Information";a?(d="üí¨ Input Required",Gn(e,"polite")):r?(d=l?"‚ö†Ô∏è Confirmation":"‚úÖ Success",Gn(e,"polite")):n==="error"&&(d="‚ö†Ô∏è Error",new Audio("./audio/error-pop-up.mp3").play().catch(u=>console.log("Audio play failed",u)),Gn(e,"assertive"));const p=ae(d,c,!1,s,!1,!1,{type:"integer",width:350,height:180},"default");return ke(p),setTimeout(()=>{ke(p)},10),setTimeout(()=>{if(a){const m=document.getElementById(`${s}-ok-button`),u=document.getElementById(`${s}-cancel-button`),f=document.getElementById(`${s}-input`);f&&(setTimeout(()=>{f.focus(),f.select()},10),f.addEventListener("keydown",g=>{if(g.key==="Enter"){g.preventDefault();const w=f.value;le(s),t&&t(w)}else g.key==="Escape"&&(g.preventDefault(),le(s),i&&i(null))})),m&&m.addEventListener("click",()=>{const g=f?f.value:"";le(s),t&&t(g)}),u&&u.addEventListener("click",()=>{le(s),i&&i(null)})}else if(l){const m=document.getElementById(`${s}-ok-button`),u=document.getElementById(`${s}-cancel-button`);m&&m.addEventListener("click",()=>{le(s),t&&t()}),u&&u.addEventListener("click",()=>{le(s),i&&i()})}else{const m=document.getElementById(`${s}-button`);m&&m.addEventListener("click",()=>{le(s),t&&t()})}},100),p}function Gn(e,n="polite"){const t=document.getElementById(n==="assertive"?"sr-alerts":"sr-announcements");t&&(t.textContent=e,setTimeout(()=>{t.textContent=""},1e3))}typeof document<"u"&&document.addEventListener("click",e=>{e.target.closest("#settings-apply-button")&&(e.stopPropagation(),ie("Are you sure you want to apply these desktop settings changes?","confirmation",()=>{Qe("settings-apply-button","Applied!"),setTimeout(()=>{Qe("settings-apply-button","Apply")},1e3),ha(),ie("Your settings have successfully been saved!","info")}))});(function(){if(typeof window>"u"||window.__touchGesturesSetup||!("ontouchstart"in window||navigator.maxTouchPoints>0))return;window.__touchGesturesSetup=!0;function t(s,{threshold:l=50,onLeft:c,onRight:d}={}){if(!s)return;let p=0,m=0;s.addEventListener("touchstart",u=>{if(!u.touches||u.touches.length!==1)return;const f=u.touches[0];p=f.clientX,m=f.clientY},{passive:!0}),s.addEventListener("touchmove",u=>{!u.touches||u.touches.length},{passive:!0}),s.addEventListener("touchend",u=>{if(u.changedTouches&&u.changedTouches.length===1){const f=u.changedTouches[0],g=f.clientX-p,w=f.clientY-m;Math.abs(g)>Math.abs(w)&&Math.abs(g)>l&&(g<0&&typeof c=="function"&&c(u),g>0&&typeof d=="function"&&d(u))}},{passive:!0})}function i(s,{maxDuration:l=300,maxMove:c=15,onTap:d}={}){if(!s)return;let p=0,m=[];s.addEventListener("touchstart",u=>{u.touches.length===2?(p=Date.now(),m=Array.from(u.touches).map(f=>({x:f.clientX,y:f.clientY}))):(p=0,m=[])},{passive:!0}),s.addEventListener("touchend",u=>{if(!p)return;if(Date.now()-p>l){p=0;return}const g=u.changedTouches;if(!g||g.length<1){p=0;return}let w=!1;Array.from(g).forEach((b,C)=>{const h=m[C]||m[0];h&&Math.hypot(b.clientX-h.x,b.clientY-h.y)>c&&(w=!0)}),!w&&typeof d=="function"&&d(u),p=0,m=[]},{passive:!0})}function o({threshold:s=60}={}){let l=0,c=!1,d=null;document.addEventListener("touchstart",p=>{if(p.touches.length===2){const m=p.target.closest(".cursor-move");if(m){l=(p.touches[0].clientY+p.touches[1].clientY)/2,c=!0;const u=m.closest('[role="dialog"]');d=u?u.id:null}}},{passive:!0}),document.addEventListener("touchmove",p=>{},{passive:!0}),document.addEventListener("touchend",p=>{var w;if(!c)return;if(!p.target.closest(".cursor-move")){c=!1,d=null;return}const f=(((w=p.changedTouches[0])==null?void 0:w.clientY)??l)-l,g=d;c=!1,d=null,g&&(f>s?typeof Je=="function"&&Je(g):f<-s&&typeof Et=="function"&&Et(g))},{passive:!0})}const r=document.getElementById("window-tabs");t(r,{onLeft:()=>{ei("left")},onRight:()=>{ei("right")}});const a=document.getElementById("desktop-stage")||document.body;i(a,{onTap:()=>{try{typeof window.minimizeAllWindows=="function"&&window.minimizeAllWindows()}catch{}}}),o(),function(){let l=null,c=0,d=0,p=null;const m=500,u=12;function f(){l&&(clearTimeout(l),l=null)}document.body&&document.body.classList.add("no-context-menu"),document.addEventListener("touchstart",g=>{if(!g.touches||g.touches.length!==1){f();return}if(g.target.closest&&g.target.closest('input, textarea, [contenteditable="true"]')){f();return}const b=g.touches[0];c=b.clientX,d=b.clientY,p=g.target,f(),l=setTimeout(()=>{const C=document.elementFromPoint(c,d)||p||document.body,h=new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,view:window,clientX:c,clientY:d});C.dispatchEvent(h),navigator.vibrate&&navigator.vibrate(50),f()},m)},{passive:!0}),document.addEventListener("contextmenu",g=>{("ontouchstart"in window||navigator.maxTouchPoints>0)&&(g.target.closest('input, textarea, [contenteditable="true"]')||g.preventDefault())}),document.addEventListener("touchmove",g=>{if(!l||!g.touches||g.touches.length!==1)return;const w=g.touches[0];(Math.abs(w.clientX-c)>u||Math.abs(w.clientY-d)>u)&&f()},{passive:!0}),document.addEventListener("touchend",()=>{f()},{passive:!0}),document.addEventListener("touchcancel",()=>{f()},{passive:!0})}()})();function Mn(){const e=document.createElement("div");e.className="w-3xl fixed left-0 top-0 h-full w-full bg-gradient-to-b from-40% from-blue-500 to-cyan-500",e.id="splash-screen",e.style.zIndex="9000",e.innerHTML=`
  <div class="flex flex-col items-center justify-center h-full">
    <img id="splash-image" src="./image/logo.webp" alt="Startup" class="mb-4 max-w-48">
    <h1 class="sr-only">Doorways '25, a Nostalgia Inducing Operating System</h1>
    <div class="mx-auto w-72 text-sm pl-3 mb-2 bg-black py-1 border-2 border-lime-400 text-lime-300"><em>i hacked the mainframe credentials for u</em><br><span class="text-xs text-lime-500">sincerely, _N30_phreak_</span></div>
    <form id="splash-form" class="bg-gray-300 border border-gray-500 p-4 w-96">
      <div class="mb-2">
        <label class="block text-sm">Username</label>
        <input type="text" id="splash-username" value="admin" class="border px-1 py-1 w-full" readonly>
      </div>
      <div class="mb-2">
        <label class="block text-sm">Password</label>
        <input type="password" id="splash-password" value="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="border px-1 py-1 w-full" readonly>
      </div>
      <button id="splash-login" class="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2"><span class="border-b-2 border-r-2 border-black block h-full max-h-10 w-full py-1.5 px-3">Login</span></button>
    </form>
  </div>
`,document.body.appendChild(e);const n=new Audio("./audio/startup.mp3");n.id="splash-audio",document.getElementById("splash-login").addEventListener("click",function(t){n.play().catch(i=>console.log("Audio play failed",i)),t.preventDefault(),document.getElementById("splash-image").src="./image/icon.gif",n.currentTime=0,setTimeout(function(){e.remove()},3e3)})}async function lr(){const e=document.createElement("div");e.className="w-3xl fixed left-0 top-0 h-full w-full bg-gradient-to-b from-blue-500 to-cyan-500",e.id="splash-screen",e.style.zIndex="9999",e.innerHTML=`
  <div class="flex flex-col items-center justify-center h-full">
    <img id="splash-image" src="./image/logo.webp" alt="Startup" class="mb-4 max-w-48">
    <h2 class="text-4xl text-gray-900 font-bold mb-2">System Loading ...</h2>
  </div>
`,document.body.appendChild(e),setTimeout(function(){e.remove(),typeof window.showCustomScrollbars=="function"&&window.showCustomScrollbars()},1e3)}typeof window<"u"&&(window.showSplash=Mn,window.showOSLoading=lr);async function cr(){await z.setItem("explicitRestart",!0),Rr(),_r(),ai([]),li({clockSeconds:!1,bgColor:"#20b1b1",bgImage:""}),Mn()}async function dr(){await z.setItem("explicitRestart",!0);try{await Q()}catch(e){console.warn("Failed to save state before logout:",e)}Mn()}typeof window<"u"&&(window.restart=cr,window.logout=dr);function ur(){ae("Storage Manager",'<div id="storage-content" style="padding: 20px;">Loading storage information...</div>',!1,"storage-window",!1,!1,{type:"integer",width:600,height:500},"default"),setTimeout(hn,100)}async function hn(){const e=document.getElementById("storage-content");if(e)try{const n=await navigator.storage.estimate(),t=(n.quota/(1024*1024)).toFixed(2),i=(n.usage/(1024*1024)).toFixed(2),o=((n.quota-n.usage)/(1024*1024)).toFixed(2),r=(n.usage/n.quota*100).toFixed(1),a=await us(),s=`
      <div class="storage-manager">
        <h2 class="text-xl font-bold mb-4">Storage Information</h2>

        <!-- Storage Capacity -->
        <div class="mb-6 p-4 bg-gray-100 rounded">
          <h3 class="text-lg font-semibold mb-2">Storage Capacity</h3>
          <div class="mb-2">
            <div class="flex justify-between mb-1">
              <span>Used: ${i} MB</span>
              <span>Available: ${o} MB</span>
            </div>
            <div class="w-full bg-gray-300 rounded-full h-4">
              <div class="bg-blue-500 h-4 rounded-full" style="width: ${r}%"></div>
            </div>
            <div class="text-sm text-gray-600 mt-1">
              ${r}% of ${t} MB total capacity used
            </div>
          </div>
        </div>

        <!-- Data Categories -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-3">Data Categories</h3>
          <div class="grid grid-cols-2 gap-4">
            ${on("App Data",a.appData,"bg-blue-100")}
            ${on("Media Files",a.mediaData,"bg-green-100")}
            ${on("Files & Folders",a.fileData,"bg-yellow-100")}
            ${on("Miscellaneous",a.miscData,"bg-gray-100")}
          </div>
        </div>

        <!-- Detailed Breakdown -->
        <div class="mb-4">
          <h3 class="text-lg font-semibold mb-3">Detailed Breakdown</h3>
          <div class="bg-white border rounded p-3">
            ${ds(a)}
          </div>
        </div>

        <!-- Actions -->
        <div class="mt-6 flex gap-3">
          <div id="refresh-btn-container"></div>
          <div id="cleanup-btn-container"></div>
          <div id="restore-btn-container"></div>
        </div>
      </div>
    `;e.innerHTML=s;const l=await fr(),c=me("Refresh Data");c.onclick=Jt,document.getElementById("refresh-btn-container").appendChild(c);const d=me("Cleanup Options");d.onclick=pr,document.getElementById("cleanup-btn-container").appendChild(d);const p=me("Restore All Applications");p.onclick=ws,l.count===0?(p.disabled=!0,p.title="All applications are already in the Start menu",p.style.opacity="0.6",p.style.cursor="not-allowed"):p.title=`Restore ${l.count} missing applications to Start menu`,document.getElementById("restore-btn-container").appendChild(p)}catch(n){const t=document.createElement("div");t.className="text-red-500",t.textContent=`Error loading storage data: ${n.message}`,e.innerHTML="",e.appendChild(t)}}function on(e,n,t){const i=(n.totalSize/1024).toFixed(1);return`
    <div class="p-4 ${t} rounded">
      <h4 class="font-semibold">${e}</h4>
      <div class="text-2xl font-bold">${n.count}</div>
      <div class="text-sm text-gray-600">items (${i} KB)</div>
    </div>
  `}function ds(e){let n='<div class="space-y-2 text-sm">';return e.appData.breakdown.length>0&&(n+="<div><strong>App Data:</strong></div>",e.appData.breakdown.forEach(t=>{n+=`<div class="ml-4">‚Ä¢ ${t.name}: ${t.count} items</div>`})),e.mediaData.breakdown.length>0&&(n+='<div class="mt-3"><strong>Media Files:</strong></div>',e.mediaData.breakdown.forEach(t=>{const i=(t.size/1024).toFixed(1);n+=`<div class="ml-4">‚Ä¢ ${t.type}: ${t.count} files (${i} KB)</div>`})),e.fileData.breakdown.length>0&&(n+='<div class="mt-3"><strong>Files & Folders:</strong></div>',e.fileData.breakdown.forEach(t=>{n+=`<div class="ml-4">‚Ä¢ ${t.name}: ${t.count} items</div>`})),n+="</div>",n}async function us(){const e={appData:{count:0,totalSize:0,breakdown:[]},mediaData:{count:0,totalSize:0,breakdown:[]},fileData:{count:0,totalSize:0,breakdown:[]},miscData:{count:0,totalSize:0,breakdown:[]}};return await ps(e),await fs(e),e}async function ps(e){try{const t=await z.getItem("appState")||{},i=JSON.stringify(t).length;if(t.fileSystemState){const o=JSON.stringify(t.fileSystemState).length;e.fileData.totalSize+=o;const r=t.fileSystemState;r.folders&&Object.values(r.folders).forEach(a=>{Jn(a,e.fileData)})}if(t.windowStates){const o=JSON.stringify(t.windowStates).length;e.appData.totalSize+=o,e.appData.count+=Object.keys(t.windowStates).length,e.appData.breakdown.push({name:"Window States",count:Object.keys(t.windowStates).length})}if(t.desktopIconsState){const o=JSON.stringify(t.desktopIconsState).length;e.appData.totalSize+=o,e.appData.count+=Object.keys(t.desktopIconsState).length,e.appData.breakdown.push({name:"Desktop Icons",count:Object.keys(t.desktopIconsState).length})}if(t.desktopSettings){const o=JSON.stringify(t.desktopSettings).length;e.appData.totalSize+=o,e.appData.count+=1,e.appData.breakdown.push({name:"Desktop Settings",count:1})}}catch(n){console.error("Error analyzing storage:",n)}}function Jn(e,n){!e||typeof e!="object"||(e.type==="folder"?(n.count++,e.contents&&Object.values(e.contents).forEach(t=>{Jn(t,n)})):e.type==="ugc-file"?(n.count++,["mp3","mp4","jpg","jpeg","png","gif","webp","wav","webm"].includes(e.content_type)):Object.values(e).forEach(t=>{t&&typeof t=="object"&&Jn(t,n)}))}async function fs(e){try{const n=await indexedDB.databases();for(const t of n)t.name==="media_player_db"?await ms(e):(e.miscData.count+=1,e.miscData.breakdown.push({name:`Database: ${t.name}`,count:1}))}catch(n){console.error("Error analyzing IndexedDB:",n)}}async function ms(e){return new Promise((n,t)=>{const i=indexedDB.open("media_player_db");i.onsuccess=o=>{const r=o.target.result,l=r.transaction(["songs"],"readonly").objectStore("songs").getAll();l.onsuccess=()=>{const c=l.result,d={};c.forEach(p=>{const m=p.type||"unknown";d[m]||(d[m]={count:0,size:0}),d[m].count++,p.file&&p.file.size&&(d[m].size+=p.file.size,e.mediaData.totalSize+=p.file.size),e.mediaData.count++}),Object.entries(d).forEach(([p,m])=>{e.mediaData.breakdown.push({type:p.toUpperCase(),count:m.count,size:m.size})}),r.close(),n()},l.onerror=()=>{r.close(),t(l.error)}},i.onerror=()=>{t(i.error)}})}function Jt(){const e=document.getElementById("storage-content");e&&(e.innerHTML="Refreshing storage information...",setTimeout(hn,100))}function gs(e,n=null,t=null){const i=document.createElement("select");return i.className="bg-white border-t-2 border-l-2 border-black border-b-2 border-r-2 border-gray-300 px-2 py-1",i.setAttribute("aria-label","Select storage cleanup option"),i.setAttribute("title","Choose which type of data to clean up"),e.forEach(o=>{const r=document.createElement("option");typeof o=="string"?(r.value=o,r.textContent=o):(r.value=o.value,r.textContent=o.text||o.value),n!==null&&r.value===n&&(r.selected=!0),i.appendChild(r)}),t&&typeof t=="function"&&i.addEventListener("change",o=>t(o.target.value,o)),i}function pr(){const e=ae("Storage Cleanup",'<div id="cleanup-content" style="padding: 20px;">Loading cleanup options...</div>',!1,"storage-cleanup-window",!1,!1,{type:"integer",width:400,height:340},"default");setTimeout(()=>{const t=[...document.querySelectorAll("*")].filter(i=>getComputedStyle(i).zIndex>100&&getComputedStyle(i).zIndex<1e3).reduce((i,o)=>getComputedStyle(o).zIndex>getComputedStyle(i).zIndex?o:i);e.style.zIndex=`${parseInt(t.style.zIndex)+1}`},50),setTimeout(hs,100)}function hs(){const e=document.getElementById("cleanup-content");if(!e)return;const n=`
    <div class="cleanup-options">
      <h3 class="text-lg font-semibold mb-4">Storage Cleanup Options</h3>
      <p class="text-sm text-gray-600 mb-4">Choose what data to clear:</p>

      <div class="space-y-3">
        <div id="clear-media-btn-container"></div>
        <div id="clear-desktop-btn-container"></div>
        <div id="full-restart-btn-container"></div>
      </div>
    </div>
  `;e.innerHTML=n;const t=me("Clear Media Player Data");t.onclick=ys,t.className+=" w-full mb-2",document.getElementById("clear-media-btn-container").appendChild(t);const i=me("Reset Desktop Settings");i.onclick=bs,i.className+=" w-full mb-2",document.getElementById("clear-desktop-btn-container").appendChild(i);const o=me("Factory Reset");o.onclick=mr,o.className+=" w-full mb-2",o.style.backgroundColor="#ffcccc",document.getElementById("full-restart-btn-container").appendChild(o)}async function ys(){try{await new Promise((n,t)=>{const i=indexedDB.deleteDatabase("media_player_db");i.onsuccess=n,i.onerror=t});const e=getFileSystemStateSync();e.folders["C://Media"]&&(e.folders["C://Media"]={},setFileSystemState(e),saveState()),ie("Media player data cleared successfully!","info"),Jt()}catch(e){ie("Error clearing media player data: "+e.message,"error")}}async function bs(){const n=await z.getItem("appState")||{};n.desktopSettings={clockSeconds:!1,bgColor:"#20b1b1",bgImage:""},n.desktopIconsState={},n.startMenuOrder=[],await z.setItem("appState",n),ie("Desktop settings reset successfully!","info"),Jt()}async function fr(){try{const e=[{id:"mycomp",text:"My Computer",icon:"image/computer.webp"},{id:"mailboxapp",text:"Mail Box",icon:"image/mail.webp"},{id:"mediaapp",text:"Media Player",icon:"image/video.webp"},{id:"watercolourapp",text:"Watercolour",icon:"image/watercolour.webp"},{id:"letterpad",text:"LetterPad",icon:"image/file.webp"},{id:"calcapp",text:"Calculator",icon:"image/calculator.webp"},{id:"keyboard",text:"Keyboard",icon:"image/keyboard.webp"},{id:"sysset",text:"System Settings",icon:"image/gears.webp"},{id:"storageapp",text:"Storage Manager",icon:"image/drive_c.webp"},{id:"abtcomp",text:"About This Computer",icon:"image/info.webp"},{id:"solapp",text:"Solitaire",icon:"image/solitaire.webp"},{id:"chessapp",text:"Guillotine Chess",icon:"image/guillotine_chess.webp"},{id:"bombapp",text:"Bombbroomer",icon:"image/bombbroomer.webp"},{id:"pongapp",text:"Pong",icon:"image/pong.webp"},{id:"snakeapp",text:"Snake",icon:"image/snake.webp"},{id:"happyturdapp",text:"Happy Turd",icon:"image/happyturd.webp"}];let n=[];try{const o=await z.getItem("startMenuOrder");o&&Array.isArray(o)?n=o:n=typeof startMenuOrder<"u"?startMenuOrder:window.startMenuOrder||[]}catch{n=typeof startMenuOrder<"u"?startMenuOrder:window.startMenuOrder||[]}const t=new Set;n.forEach(o=>{typeof o=="string"?t.add(o):o&&o.type==="group"&&o.items&&o.items.forEach(r=>{r&&r.id&&t.add(r.id)})});const i=e.filter(o=>!t.has(o.id));return{count:i.length,apps:i}}catch(e){return console.error("Error checking for missing apps:",e),{count:0,apps:[]}}}async function ws(){try{const e=await fr();if(e.count===0){typeof ie=="function"?ie("All applications are already present in the Start menu.","info"):alert("All applications are already present in the Start menu.");return}const n=`This will restore ${e.count} missing applications to the Start menu:

${e.apps.map(t=>`‚Ä¢ ${t.text}`).join(`
`)}

Proceed?`;typeof ie=="function"?ie(n,"confirmation",async()=>{await ti(e.apps)}):confirm(n)&&await ti(e.apps)}catch(e){console.error("‚ùå Error in restoreAllApplications:",e),typeof ie=="function"?ie("Failed to restore applications: "+e.message,"error"):alert("Failed to restore applications: "+e.message)}}async function ti(e){try{let n=[];try{const i=await z.getItem("startMenuOrder");i&&Array.isArray(i)?n=[...i]:n=typeof startMenuOrder<"u"?[...startMenuOrder]:[...window.startMenuOrder||[]]}catch{n=typeof startMenuOrder<"u"?[...startMenuOrder]:[...window.startMenuOrder||[]]}const t={letterpad:"utilities-group",calcapp:"utilities-group",sysset:"utilities-group",storageapp:"utilities-group",abtcomp:"utilities-group",solapp:"games-group",chessapp:"games-group",bombapp:"games-group",pongapp:"games-group",snakeapp:"games-group"};e.forEach(i=>{const o=t[i.id];if(o){let r=!1;if(n=n.map(a=>typeof a=="object"&&a.type==="group"&&a.id===o?(r=!0,{...a,items:[...a.items||[],{id:i.id,text:i.text,icon:i.icon}]}):a),!r){const a=vs(o);if(a){a.items=[{id:i.id,text:i.text,icon:i.icon}];const s=n.findIndex(l=>l==="rstrtcomp");s!==-1?n.splice(s,0,a):n.push(a)}}}else{const r=n.findIndex(a=>a==="rstrtcomp");r!==-1?n.splice(r,0,i.id):n.push(i.id)}}),window.startMenuOrder=n,typeof startMenuOrder<"u"&&(startMenuOrder=n),await z.setItem("startMenuOrder",n),typeof saveState=="function"&&await saveState(),typeof generateStartMenuHTML=="function"?generateStartMenuHTML():typeof window.generateStartMenuHTML=="function"&&window.generateStartMenuHTML(),typeof safeInitializeStartMenuDragDrop=="function"?setTimeout(()=>{safeInitializeStartMenuDragDrop()},50):typeof window.safeInitializeStartMenuDragDrop=="function"&&setTimeout(()=>{window.safeInitializeStartMenuDragDrop()},50),typeof ie=="function"?ie(`Successfully restored ${e.length} applications to the Start menu.`,"info"):alert(`Successfully restored ${e.length} applications to the Start menu.`),setTimeout(()=>{Jt()},500)}catch(n){console.error("‚ùå Error performing app restore:",n),typeof ie=="function"?ie("Failed to restore applications: "+n.message,"error"):alert("Failed to restore applications: "+n.message)}}function vs(e){return{"utilities-group":{id:"utilities-group",text:"Utilities",type:"group",items:[]},"games-group":{id:"games-group",text:"Games",type:"group",items:[]}}[e]||null}function mr(){ie("This will completely wipe the entire hard drive and reset the system to factory defaults. All your files, settings, and data will be permanently deleted.","confirmation",()=>{confirm(`‚ö†Ô∏è FINAL WARNING ‚ö†Ô∏è

This will permanently delete EVERYTHING you have ever saved in this application:

‚Ä¢ All uploaded files and media
‚Ä¢ All documents and folders
‚Ä¢ All settings and customizations
‚Ä¢ All application data

This action cannot be undone!

Are you absolutely sure you want to proceed?`)&&xs()},()=>{})}function xs(){z.clearSync();const e=indexedDB.deleteDatabase("media_player_db");e.onsuccess=()=>{},e.onerror=n=>{console.error("Factory reset: Error clearing media player database:",n)},windowStates={},desktopIconsState={},startMenuOrder=[],desktopSettings={clockSeconds:!1,bgColor:"#20b1b1",bgImage:""},window.location.reload()}async function gr(e){await new Promise(t=>setTimeout(t,50));const n={"storage-window":()=>{typeof hn=="function"?setTimeout(hn,100):console.warn("loadStorageData function not available for storage window restoration")},calculator:()=>{const t=document.getElementById("calculator");if(t){const i=t.querySelector(".p-2");je(i)&&initializeCalculatorUI(t)}},mediaplayer:()=>{const t=document.getElementById("mediaplayer");if(t){const i=t.querySelector(".p-2");je(i)&&initializeMediaPlayerUI(t)}},bombbroomer:()=>{const t=document.getElementById("bombbroomer");if(t){const i=t.querySelector(".p-2");je(i)&&(typeof initializeBombbroomerUI=="function"?initializeBombbroomerUI(t):console.warn("initializeBombbroomerUI function not available"))}},solitaire:()=>{const t=document.getElementById("solitaire");if(t){const i=t.querySelector(".p-2");je(i)&&initializeSolitaireUI(t)}},chess:()=>{const t=document.getElementById("chess");if(t){const i=t.querySelector(".p-2");je(i)&&(typeof initializeChessUI=="function"?initializeChessUI(t):console.warn("initializeChessUI function not available"))}},"compost-bin":()=>{const t=document.getElementById("compost-bin");if(t){const i=t.querySelector(".p-2");if(i&&je(i)){i.innerHTML="",i.className="p-2 bg-gray-100 h-full flex flex-col";const o=document.createElement("div");o.className="h-full flex flex-col";const r=document.createElement("div");r.className="bg-gray-200 border-b border-gray-400 p-2 flex justify-between items-center";const a=document.createElement("div");a.className="text-sm";const c=(se().folders["C://Desktop"]||{}).compostbin,d=Object.keys((c==null?void 0:c.contents)||{}).length;a.textContent=`Compost Bin - ${d} item(s)`;const p=document.createElement("div");p.className="flex space-x-2";const m=document.createElement("button");m.className="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs",m.textContent="Empty Bin",typeof emptyCompostBin=="function"&&m.addEventListener("click",emptyCompostBin),p.appendChild(m),r.appendChild(a),r.appendChild(p);const u=document.createElement("div");u.className="flex-1 bg-white border border-gray-400 p-2 overflow-auto",u.id="compost-bin-content",typeof loadCompostBinContents=="function"?loadCompostBinContents(u):console.warn("üóëÔ∏è loadCompostBinContents function not available"),o.appendChild(r),o.appendChild(u),i.appendChild(o)}else{const o=t.querySelector("#compost-bin-content");o&&typeof loadCompostBinContents=="function"?(loadCompostBinContents(o),typeof updateCompostBinHeader=="function"&&updateCompostBinHeader(t)):console.warn("Compost bin content area not found or loadCompostBinContents not available")}}else console.warn("üóëÔ∏è Compost bin window not found during restoration")},snake:()=>{const t=document.getElementById("snake");if(t){const i=t.querySelector(".p-2");je(i)&&(typeof initializeSnakeUI=="function"?initializeSnakeUI(t):console.warn("initializeSnakeUI function not available for restoration"))}},pong:()=>{const t=document.getElementById("pong");if(t){const i=t.querySelector(".p-2");je(i)&&(typeof initializePongUI=="function"?initializePongUI(t):console.warn("initializePongUI function not available for restoration"))}},happyturd:()=>{const t=document.getElementById("happyturd");if(t){const i=t.querySelector(".p-2");je(i)&&(typeof initializeHappyTurdUI=="function"?initializeHappyTurdUI(t):console.warn("initializeHappyTurdUI function not available for restoration"))}},watercolour:()=>{const t=document.getElementById("watercolour");if(t){const i=t.querySelector(".p-2");je(i)?initializeWatercolourUI(t):typeof initializeWatercolour=="function"?initializeWatercolour():initializeWatercolourUI(t)}},"keyboard-app":()=>{document.getElementById("keyboard-app")&&(typeof window.initializeKeyboardApp=="function"?window.initializeKeyboardApp("keyboard-app"):console.warn("initializeKeyboardApp function not available for keyboard-app restoration"))},tubestream:()=>{const t=document.getElementById("tubestream");t&&typeof Vn=="function"&&Vn(t)},mailbox:()=>{const t=document.getElementById("mailbox");t&&typeof Xn=="function"&&Xn(t)},"explorer-window":()=>{const t=document.getElementById("explorer-window");t&&(typeof initializeFileExplorerUI=="function"?initializeFileExplorerUI(t):typeof restoreFileExplorerState=="function"&&setTimeout(restoreFileExplorerState,100))}};if(n[e])try{n[e]()}catch(t){console.warn(`Failed to initialize restored app ${e}:`,t)}else if(It(e))try{await xo(e)}catch(t){console.warn(`Failed to restore custom app ${e}:`,t)}else{const t=document.getElementById(e);if(t){const i=t.querySelector(".letterpad_editor");if(i)try{typeof initializeLetterPad=="function"?await initializeLetterPad(i):console.warn("initializeLetterPad function not available")}catch(o){console.warn(`Failed to initialize LetterPad editor in window ${e}:`,o)}}}}function je(e){if(!e)return!0;const n=e.innerHTML.trim();return!n||n.length<50&&!n.includes("button")&&!n.includes("canvas")&&!n.includes("input")?!0:!e.querySelector('button, canvas, input[type="text"], .game-board, #media-container, #game-grid, #calc-display, #compost-bin-content')}function ks(e,n){if(typeof n!="function"){console.warn(`Launch function not available for ${e}`);return}const t=document.getElementById(e);if(!t){console.warn(`Window ${e} not found for reinitialization`);return}try{const i=e+"-temp-"+Date.now();t.id=i,n();const o=document.getElementById(e);if(o&&o!==t){const r=t.querySelector(".p-2"),a=o.querySelector(".p-2");r&&a&&(r.innerHTML=a.innerHTML,r.className=a.className),o.remove();const s=document.getElementById("tab-"+e);s&&s.remove(),delete J[e]}t.id=e}catch(i){t&&t.id!==e&&(t.id=e),console.error(`Failed to reinitialize ${e}:`,i)}}async function Qn(){Fo(!0);try{await z.ensureReady()}catch(o){console.error("Failed to initialize storage:",o)}let e;try{e=await z.getItem("appState")}catch(o){console.error("Failed to load app state from storage:",o),e=null}let n=e;if(!n)try{const o=await fetch("custom-config.js",{method:"HEAD"}),r=o.headers.get("content-type");if(o.ok&&(!r||!r.includes("text/html")))try{const a=await fetch("custom_data/data.json"),s=a.headers.get("content-type");a.ok&&(!s||!s.includes("text/html"))&&(n=await a.json())}catch(a){console.warn("Failed to load custom_data/data.json despite custom-config.js presence",a)}if(!n)try{const a=await fetch("default_data/data.json"),s=a.headers.get("content-type");a.ok&&(!s||!s.includes("text/html"))&&(n=await a.json())}catch(a){a instanceof SyntaxError||console.warn("Failed to load default_data/data.json",a)}}catch(o){console.warn("Error checking for initial data",o)}n||(n={fileSystemState:{folders:{"C://":{}}}}),n.fileSystemState||(n.fileSystemState={folders:{"C://":{}}}),n.apiOverrides?Object.assign(Ce,n.apiOverrides):n.apiOverrides=Ce;try{let o=[],r=`${Ue}${_n}`;for(Ue.endsWith("/")&&_n.startsWith("/")&&(r=`${Ue}${_n.substring(1)}`);r;){const a=await fetch(r);if(!a.ok){console.warn(`API fetch failed: ${a.status} ${a.statusText}`);break}const s=await a.json();if(s.data&&Array.isArray(s.data)&&(o=o.concat(s.data)),s.links&&s.links.next){const l=s.links.next;if(l.startsWith("http"))r=l;else{const c=new URL(Ue);r=new URL(l,c).toString()}}else r=null}o.length>0&&(n.fileSystemState=Po(n.fileSystemState),Hr(o,n.fileSystemState),$o(n.fileSystemState))}catch(o){console.warn("Error fetching from API, falling back to local data:",o)}n.fileSystemState&&(n.fileSystemState=Po(n.fileSystemState),$o(n.fileSystemState)),xe(n.fileSystemState||ot),Or(n.windowStates||{}),Wr(n.desktopIconsState||{});const t={clockSeconds:!1,bgColor:"#20b1b1",bgImage:"",...n.desktopSettings||{}};li(t),Object.assign(Oe,n.navWindows||{}),Object.assign(Ce,n.apiOverrides||{deletedSlugs:[],movedSlugs:{}});let i=[];if(n.startMenuOrder&&Array.isArray(n.startMenuOrder))i=n.startMenuOrder;else try{const o=await z.getItem("startMenuOrder");o&&Array.isArray(o)&&(i=o)}catch{}ai(i),typeof window<"u"&&typeof window.applyDesktopSettings=="function"&&window.applyDesktopSettings(),n.apiOverrides=Ce;try{await z.setItem("appState",n)}catch(o){console.error("Failed to save loaded initial state:",o)}setTimeout(async()=>{const o=await Ne();if(o.folders["C://Media"]&&!Object.values(o.folders["C://Media"]).some(a=>a.name==="too_many_screws_final.mp3")){const a={id:"default-music-file",name:"too_many_screws_final.mp3",type:"ugc-file",fullPath:"C://Media/too_many_screws_final.mp3",content_type:"mp3",icon:"image/audio.webp",contents:"",file:null,isDefault:!0,path:"media/too_many_screws_final.mp3",isSystemFile:!0};o.folders["C://Media"]["default-music-file"]=a,xe(o),await Q()}},100),await hr(),Fo(!1)}async function Es(){const e=await z.getItem("fileSystemState");e&&xe(e)}async function Ss(){if(J&&Object.keys(J).length>0){Object.keys(J).forEach(n=>{(/^dialogWindow-/.test(n)||/^promptWindow-/.test(n))&&delete J[n]});const e=Object.entries(J).sort(([,n],[,t])=>(n.zIndex||0)-(t.zIndex||0));for(const[n,t]of e)createWindow(t.title,t.content,t.isNav,t.id,t.isMinimized,!0,t.dimensions,t.windowType,null,t.color||"white",t.zIndex),await gr(t.id);if(typeof window.initializeAllLetterPadEditors=="function")try{await window.initializeAllLetterPadEditors()}catch(n){console.warn("Error during global LetterPad initialization:",n)}}}async function Cs(){for(const e in fe){const n=document.getElementById(e);if(n){const t=fe[e];n.style.position="absolute",n.style.left=t.left,n.style.top=t.top}}}Es().then(()=>{}).catch(console.error);async function hr(){try{await Cn();const e=rr(),n=new Set(e.map(d=>d.id)),t=await Ne();if(!t||!t.folders||!t.folders["C://Desktop"]){console.error("‚ùå File system not properly initialized for custom apps");return}const i=t.folders["C://Desktop"].compostbin,o=i&&i.contents?i.contents:{},r=t.deletedCustomApps||[];let a=0,s=0,l=0,c=0;for(const d in t.folders){const p=t.folders[d];for(const m in p){const u=p[m];if(u&&typeof u=="object"&&u.isCustomApp&&!n.has(u.id)){delete p[m],c++;const f=document.getElementById(u.id);if(f){f.remove();const g=document.getElementById("tab-"+u.id);g&&g.remove()}J[u.id]&&delete J[u.id]}}}for(const d in o){const p=o[d];p&&p.isCustomApp&&!n.has(p.id)&&(delete o[d],c++)}if(t.deletedCustomApps){const d=t.deletedCustomApps.filter(p=>n.has(p));d.length!==t.deletedCustomApps.length&&(t.deletedCustomApps=d)}e.forEach(d=>{const p=d.fullPath.substring(0,d.fullPath.lastIndexOf("/")),m=t.folders[p];if(m){const u=m[d.id],f=o[d.id],g=r.includes(d.id);if(u){const w=d.customAppData,b=u.customAppData;JSON.stringify(w)!==JSON.stringify(b)&&(m[d.id]={...u,...d},s++)}else if(f)if(!(String(d.customAppData.compostable)==="true"||d.customAppData.compostable===!0))delete o[d.id],m[d.id]=d,l++;else{const b=d.customAppData,C=f.customAppData;JSON.stringify(b)!==JSON.stringify(C)&&(o[d.id]={...f,...d},s++)}else if(g){if(!(String(d.customAppData.compostable)==="true"||d.customAppData.compostable===!0)){const b=t.deletedCustomApps.indexOf(d.id);b>-1&&t.deletedCustomApps.splice(b,1),m[d.id]=d,l++}}else m[d.id]=d,a++}else console.error(`‚ùå Target folder not found in file system: ${p}`)}),(a>0||s>0||l>0||c>0)&&(xe(t),await Q(),typeof window.renderDesktopIcons=="function"&&window.renderDesktopIcons(),typeof window.restoreStartMenuOrder=="function"&&window.restoreStartMenuOrder())}catch(e){console.error("‚ùå Failed to integrate custom apps:",e)}}typeof window<"u"&&(window.integrateCustomApps=hr);function Is(){}async function Ls(){try{await Q()}catch(e){console.error("Failed to save state manually:",e)}}function Ms(e){gr(e)}function As(e){const n={calculator:typeof launchCalculator<"u"?launchCalculator:void 0,mediaplayer:typeof launchMediaPlayer<"u"?launchMediaPlayer:void 0,bombbroomer:typeof launchBombbroomer<"u"?launchBombbroomer:void 0,solitaire:typeof launchSolitaire<"u"?launchSolitaire:void 0};n[e]?ks(e,n[e]):console.warn(`No launch function found for ${e}`)}function Ds(){const e=document.getElementById("bombbroomer");e&&typeof initializeBombbroomerUI=="function"?initializeBombbroomerUI(e):console.warn("Bombbroomer window not found or function not available")}async function Bs(){try{if(await Q(),await z.getItem("appState")){const n=await navigator.storage.estimate();return!0}else return console.error("‚úó No data found after save"),!1}catch(e){return console.error("‚úó Data integrity test failed:",e),!1}}async function Ts(){try{const e=await z.getItem("appState"),n=await z.getItem("explicitRestart");return!!e}catch(e){return console.error("‚úó Session persistence test failed:",e),!1}}async function Fs(){await z.setItem("explicitRestart",!0)}typeof window<"u"&&(window.debugWindowStates=Is,window.forceSaveState=Ls,window.testAppRestoration=Ms,window.testAppReinitialization=As,window.testBombbroomerInit=Ds,window.testDataIntegrity=Bs,window.testSessionPersistence=Ts,window.simulateRestart=Fs);function yr(e){e&&(Ce.deletedSlugs.includes(e)||(Ce.deletedSlugs.push(e),Q()))}function br(e){if(!e)return;const n=Ce.deletedSlugs.indexOf(e);n>-1&&(Ce.deletedSlugs.splice(n,1),Q())}function gt(e,n){!e||!n||(console.log(`üìù Marking slug as moved: ${e} -> ${n}`),Ce.movedSlugs[e]=n,Q())}typeof window<"u"&&(window.markSlugAsDeleted=yr,window.unmarkSlugAsDeleted=br,window.markSlugAsMoved=gt);let jt=new Set,T={isDragging:!1,draggedElement:null,draggedFromGroup:null,placeholder:null,startY:0,startX:0,draggedItemData:null},wr=!1;function Ps(e){wr=e}function vr(){An();const e=document.getElementById("start-menu");if(!e)return console.warn("Start menu element not found"),!1;const n=e.querySelectorAll("ul > li:not(.group):not(#rstrtcomp)"),t=e.querySelectorAll(".submenu-item");return n.forEach(i=>{xr(i)}),t.forEach(i=>{So(i)}),$s(),!0}function Eo(){if(wr)return!0;const e=vr();return e&&Ps(!0),e}function $s(){const e=document.getElementById("start-menu");e&&(e.addEventListener("dragover",n=>{const t=n.target.closest(".group");if(t&&T.isDragging){const i=t.querySelector("[data-submenu-container]");i&&(i.classList.remove("hidden"),i.classList.add("block"))}}),e.addEventListener("dragleave",n=>{T.isDragging||e.querySelectorAll("[data-submenu-container]").forEach(i=>{i.classList.add("hidden"),i.classList.remove("block")})}),e.addEventListener("dragover",n=>{n.preventDefault(),e.classList.add("bg-indigo-50")}),e.addEventListener("dragleave",n=>{e.contains(n.relatedTarget)||e.classList.remove("bg-indigo-50")}),e.addEventListener("drop",n=>{n.preventDefault(),e.classList.remove("bg-indigo-50")}))}function So(e){e.addEventListener("pointerdown",t);function t(r){var d;if(r.button!==0)return;T.startY=r.clientY,T.startX=r.clientX,T.draggedElement=e,T.draggedFromGroup=e.getAttribute("data-parent-group");const a=((d=e.querySelector("img"))==null?void 0:d.src)||"",s=e.cloneNode(!0),l=s.querySelector(".start-menu-context-menu");l&&l.remove();const c=s.textContent.trim();T.draggedItemData={id:e.id,text:c,icon:a,parentGroup:T.draggedFromGroup},document.addEventListener("pointermove",i),document.addEventListener("pointerup",o),document.addEventListener("pointercancel",o),r.preventDefault()}function i(r){if(!r.isPrimary)return;const a=Math.sqrt(Math.pow(r.clientY-T.startY,2)+Math.pow(r.clientX-T.startX,2));!T.isDragging&&a>5&&(T.isDragging=!0,zs(e)),T.isDragging&&Ns(r)}function o(r){r.isPrimary&&(document.removeEventListener("pointermove",i),document.removeEventListener("pointerup",o),document.removeEventListener("pointercancel",o),T.isDragging&&Os(),kr())}}function xr(e){e.addEventListener("pointerdown",t);function t(r){r.button===0&&(T.startY=r.clientY,T.draggedElement=e,document.addEventListener("pointermove",i),document.addEventListener("pointerup",o),document.addEventListener("pointercancel",o),r.preventDefault())}function i(r){if(!r.isPrimary)return;const a=Math.abs(r.clientY-T.startY);!T.isDragging&&a>5&&(T.isDragging=!0,Ws(e)),T.isDragging&&Rs(r)}function o(r){r.isPrimary&&(document.removeEventListener("pointermove",i),document.removeEventListener("pointerup",o),document.removeEventListener("pointercancel",o),T.isDragging&&_s(),kr())}}function kr(){T.placeholder&&T.placeholder.remove(),T.draggedElement&&(T.draggedElement.classList.remove("opacity-50","cursor-grabbing"),T.draggedElement.classList.add("cursor-grab")),document.querySelectorAll(".start-menu-context-menu").forEach(e=>{e.style.display="none",e.classList.add("hidden")}),T.isDragging=!1,T.draggedElement=null,T.draggedFromGroup=null,T.placeholder=null,T.startY=0,T.startX=0,T.draggedItemData=null}function zs(e,n){document.querySelectorAll(".start-menu-context-menu").forEach(t=>{t.style.display="none",t.classList.add("hidden")}),e.classList.add("opacity-50","cursor-grabbing"),e.classList.remove("cursor-grab"),T.placeholder=document.createElement("li"),T.placeholder.className="submenu-placeholder h-8 bg-blue-100 border-2 border-dashed border-blue-500 rounded my-0.5 px-4 py-1",T.placeholder.innerHTML='<span class="text-yellow-600 text-sm"></span>',e.parentNode.insertBefore(T.placeholder,e.nextSibling)}function Ns(e){if(!T.placeholder||!T.draggedItemData)return;const n=document.getElementById("start-menu"),t=document.elementFromPoint(e.clientX,e.clientY),i=t==null?void 0:t.closest("[data-submenu-container]");t==null||t.closest(".submenu-item");const o=t==null?void 0:t.closest("ul > li:not(.group)");if(i){i.getAttribute("data-group-id");const r=Array.from(i.querySelectorAll(".submenu-item")).filter(l=>l!==T.draggedElement&&!l.classList.contains("submenu-placeholder"));let a=null,s=!0;for(let l=0;l<r.length;l++){const c=r[l],d=c.getBoundingClientRect(),p=d.top+d.height/2;if(e.clientY<p){a=c,s=!0;break}else l===r.length-1&&(a=c,s=!1)}a?s?i.insertBefore(T.placeholder,a):i.insertBefore(T.placeholder,a.nextSibling):i.appendChild(T.placeholder)}else if(o&&!o.classList.contains("group")){const r=n.querySelector("ul"),a=Array.from(r.children).filter(c=>c!==T.draggedElement&&!c.classList.contains("start-menu-placeholder")&&!c.classList.contains("group")&&c.id!=="rstrtcomp");T.placeholder.classList.contains("start-menu-placeholder")||(T.placeholder.className="start-menu-placeholder h-10 bg-indigo-100 border-2 border-dashed border-indigo-500 rounded my-0.5",T.placeholder.innerHTML="");let s=null,l=!0;for(let c=0;c<a.length;c++){const d=a[c],p=d.getBoundingClientRect(),m=p.top+p.height/2;if(e.clientY<m){s=d,l=!0;break}else c===a.length-1&&(s=d,l=!1)}if(s)l?r.insertBefore(T.placeholder,s):r.insertBefore(T.placeholder,s.nextSibling);else{const c=r.querySelector("#rstrtcomp");c&&r.insertBefore(T.placeholder,c)}}}function Os(e){if(!T.placeholder||!T.draggedElement||!T.draggedItemData)return;T.draggedElement.classList.remove("opacity-50","cursor-grabbing");const n=T.placeholder.parentNode,t=n.tagName==="UL"&&!n.hasAttribute("data-submenu-container"),i=n.getAttribute("data-group-id");if(t){T.draggedElement.remove();const o=document.createElement("li");o.id=T.draggedItemData.id,o.className="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center",o.innerHTML=`
      <img src="${T.draggedItemData.icon}" class="h-6 w-6 inline mr-2" alt="${T.draggedItemData.text}">
      ${T.draggedItemData.text}
    `,o.addEventListener("click",()=>Mt(o.id)),n.insertBefore(o,T.placeholder),T.placeholder.remove(),xr(o)}else if(i&&i!==T.draggedFromGroup){T.draggedElement.remove();const o=document.createElement("li");o.id=T.draggedItemData.id,o.className="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center submenu-item",o.setAttribute("data-submenu-item",""),o.setAttribute("data-parent-group",i),o.innerHTML=`
      <img src="${T.draggedItemData.icon}" class="h-6 w-6 inline mr-2" alt="${T.draggedItemData.text}">
      ${T.draggedItemData.text}
    `,o.addEventListener("click",()=>Mt(o.id)),n.insertBefore(o,T.placeholder),T.placeholder.remove(),So(o)}else T.draggedElement.classList.add("cursor-grab"),n.insertBefore(T.draggedElement,T.placeholder),T.placeholder.remove();setTimeout(async()=>{try{await Bt()}catch(o){console.error("Failed to save start menu order after drag:",o)}},10)}function Ws(e,n){document.querySelectorAll(".start-menu-context-menu").forEach(t=>{t.style.display="none",t.classList.add("hidden")}),e.classList.add("opacity-50","cursor-grabbing"),e.classList.remove("cursor-grab"),T.placeholder=document.createElement("li"),T.placeholder.className="start-menu-placeholder h-10 bg-indigo-100 border-2 border-dashed border-indigo-500 rounded my-0.5",e.parentNode.insertBefore(T.placeholder,e.nextSibling)}function Rs(e){if(!T.placeholder)return;const n=document.getElementById("start-menu"),t=document.elementFromPoint(e.clientX,e.clientY),i=t==null?void 0:t.closest("[data-submenu-container]");if(i&&T.draggedElement&&!T.draggedElement.classList.contains("submenu-item")){i.getAttribute("data-group-id");const l=Array.from(i.querySelectorAll(".submenu-item")).filter(p=>!p.classList.contains("submenu-placeholder"));T.placeholder.classList.contains("submenu-placeholder")||(T.placeholder.className="submenu-placeholder h-8 bg-blue-100 border-2 border-dashed border-blue-500 rounded my-0.5 px-4 py-1",T.placeholder.innerHTML='<span class="text-yellow-600 text-sm"></span>');let c=null,d=!0;for(let p=0;p<l.length;p++){const m=l[p],u=m.getBoundingClientRect(),f=u.top+u.height/2;if(e.clientY<f){c=m,d=!0;break}else p===l.length-1&&(c=m,d=!1)}c?d?i.insertBefore(T.placeholder,c):i.insertBefore(T.placeholder,c.nextSibling):i.appendChild(T.placeholder);return}const o=n.querySelector("ul"),r=Array.from(o.children).filter(l=>l!==T.draggedElement&&!l.classList.contains("start-menu-placeholder")&&!l.classList.contains("group")&&l.id!=="rstrtcomp");T.placeholder.classList.contains("start-menu-placeholder")||(T.placeholder.className="start-menu-placeholder h-10 bg-indigo-100 border-2 border-dashed border-indigo-500 rounded my-0.5",T.placeholder.innerHTML="");let a=null,s=!0;for(let l=0;l<r.length;l++){const c=r[l],d=c.getBoundingClientRect(),p=d.top+d.height/2;if(e.clientY<p){a=c,s=!0;break}else l===r.length-1&&(a=c,s=!1)}if(a)s?o.insertBefore(T.placeholder,a):o.insertBefore(T.placeholder,a.nextSibling);else{const l=o.querySelector("#rstrtcomp");l&&o.insertBefore(T.placeholder,l)}}function _s(e){var o;if(!T.placeholder||!T.draggedElement)return;T.draggedElement.classList.remove("opacity-50","cursor-grabbing");const n=T.placeholder.parentNode,t=n.hasAttribute("data-submenu-container"),i=n.getAttribute("data-group-id");if(t){const r=T.draggedElement.cloneNode(!0),a=r.querySelector(".start-menu-context-menu");a&&a.remove();const s={id:T.draggedElement.id,text:r.textContent.trim(),icon:((o=T.draggedElement.querySelector("img"))==null?void 0:o.src)||""};T.draggedElement.remove();const l=document.createElement("li");l.id=s.id,l.className="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center submenu-item",l.setAttribute("data-submenu-item",""),l.setAttribute("data-parent-group",i),l.innerHTML=`
      <img src="${s.icon}" class="h-6 w-6 inline mr-2" alt="${s.text}">
      ${s.text}
    `,l.addEventListener("click",()=>Mt(l.id)),n.insertBefore(l,T.placeholder),T.placeholder.remove(),So(l)}else T.draggedElement.classList.add("cursor-grab"),n.insertBefore(T.draggedElement,T.placeholder),T.placeholder.remove();setTimeout(async()=>{try{await Bt()}catch(r){console.error("Failed to save start menu order after drag:",r)}},10)}function Mt(e){if(console.log("üîç Start menu item clicked:",e),typeof toggleStartMenu=="function")toggleStartMenu();else{const n=document.getElementById("start-menu");if(n){n.classList.add("hidden"),n.setAttribute("aria-hidden","true"),typeof window.updateStartMenuFocusability=="function"&&window.updateStartMenuFocusability(!1);const t=document.getElementById("start-button");t&&t.setAttribute("aria-expanded","false")}}if(typeof It=="function"&&It(e)){typeof openApp=="function"&&openApp(e);return}else if(typeof window.isCustomApp=="function"&&window.isCustomApp(e)){typeof openApp=="function"&&openApp(e);return}switch(e){case"mycomp":typeof openExplorer=="function"&&openExplorer();break;case"abtcomp":typeof openAboutWindow=="function"&&openAboutWindow();break;case"sysset":typeof openNav=="function"&&openNav();break;case"storageapp":typeof openApp=="function"&&openApp("storage_manager");break;case"mailboxapp":typeof openApp=="function"&&openApp("mailbox");break;case"watercolourapp":typeof openApp=="function"&&openApp("watercolour");break;case"letterpad":typeof createNewFile=="function"&&(createNewFile("txt"),typeof openApp=="function"&&openApp("letterpad"));break;case"calcapp":typeof openApp=="function"&&openApp("calculator");break;case"keyboard":console.log("üîç Keyboard case triggered, calling openApp"),typeof openApp=="function"&&openApp("keyboard");break;case"solapp":typeof openApp=="function"&&openApp("solitaire");break;case"chessapp":typeof openApp=="function"&&openApp("chess");break;case"bombapp":typeof openApp=="function"&&openApp("bombbroomer");break;case"pongapp":typeof openApp=="function"&&openApp("pong");break;case"snakeapp":typeof openApp=="function"&&openApp("snake");break;case"happyturdapp":typeof openApp=="function"&&openApp("happyturd");break;case"mediaapp":typeof openApp=="function"&&openApp("mediaplayer");break;case"tubestreamapp":typeof openApp=="function"&&openApp("tube_stream");break;case"rstrtcomp":typeof restart=="function"&&restart();break;default:console.warn("Unknown start menu item clicked:",e)}}async function Hs(e){try{const n=await Ne();if(!n.folders["C://Desktop"]){console.error("Desktop folder not found"),typeof showDialogBox=="function"&&showDialogBox("Desktop folder not found","error");return}const t=`shortcut-${e.id}-${Date.now()}`;let i=e.icon||"image/file.webp";const o={id:t,name:e.text,type:"app",fullPath:`C://Desktop/${t}`,content_type:"html",contents:{},icon:i,isShortcut:!0,targetId:e.id};n.folders["C://Desktop"][t]=o,await xe(n),await Q(),typeof renderDesktopIcons=="function"?renderDesktopIcons():typeof window.renderDesktopIcons=="function"&&window.renderDesktopIcons()}catch(n){console.error("‚ùå Failed to create desktop shortcut:",n),typeof showDialogBox=="function"&&showDialogBox("Failed to create desktop shortcut","error")}}function qs(e,n,t){const i=`Are you sure you want to uninstall "${e.text}" from the Start menu?`;typeof showDialogBox=="function"?showDialogBox(i,"confirmation",()=>{ni(e,n,t)},()=>{}):confirm(i)&&ni(e,n,t)}async function ni(e,n,t){try{let i=[];try{const o=await z.getItem("startMenuOrder");o&&Array.isArray(o)?i=o:i=typeof startMenuOrder<"u"?startMenuOrder:window.startMenuOrder||[]}catch{i=typeof startMenuOrder<"u"?startMenuOrder:window.startMenuOrder||[]}if(n&&t){const o=i.map(r=>typeof r=="object"&&r.id===t?{...r,items:r.items.filter(a=>a!==e.id)}:r);window.startMenuOrder=o,typeof startMenuOrder<"u"&&(startMenuOrder=o),await z.setItem("startMenuOrder",o)}else{const o=i.filter(r=>typeof r=="string"?r!==e.id:!0);window.startMenuOrder=o,typeof startMenuOrder<"u"&&(startMenuOrder=o),await z.setItem("startMenuOrder",o)}typeof Q=="function"&&await Q(),An(),setTimeout(()=>{Eo()},50),typeof showDialogBox=="function"&&showDialogBox(`"${e.id}" has been uninstalled from the Start menu`,"info")}catch(i){console.error("‚ùå Failed to uninstall item:",i),typeof showDialogBox=="function"&&showDialogBox("Failed to uninstall item","error")}}function js(e,n,t,i){switch(e){case"open":Mt(n.id);break;case"shortcut":if(Hs(n),typeof toggleStartMenu=="function")toggleStartMenu();else{const o=document.getElementById("start-menu");o&&o.classList.add("hidden")}break;case"uninstall":if(qs(n,t,i),typeof toggleStartMenu=="function")toggleStartMenu();else{const o=document.getElementById("start-menu");o&&o.classList.add("hidden")}break}}function Er(e,n,t=!1,i=null){const r=!["mycomp","storageapp","sysset"].includes(n.id),a=document.createElement("div");a.className="start-menu-context-menu absolute hidden bg-gray-100 border-r border-t border-b border-gray-500 z-50 w-48",a.style.display="none";let s=`
    <div class="context-menu-item px-4 py-2 hover:bg-gray-50 cursor-pointer select-none flex items-center" data-action="open">
      Open
    </div>
    <div class="context-menu-item px-4 py-2 hover:bg-gray-50 cursor-pointer select-none flex items-center" data-action="shortcut">
      Create shortcut
    </div>`;r&&(s+=`
    <div class="context-menu-item px-4 py-2 hover:bg-gray-50 cursor-pointer select-none flex items-center text-red-600" data-action="uninstall">
      Uninstall
    </div>`),a.innerHTML=s,e.appendChild(a),a.addEventListener("click",u=>{var g;u.stopPropagation();const f=(g=u.target.closest(".context-menu-item"))==null?void 0:g.dataset.action;f&&(js(f,n,t,i),m(a))});let l;e.addEventListener("mouseenter",()=>{T.isDragging||(clearTimeout(l),l=setTimeout(()=>{e.matches(":hover")&&!T.isDragging&&p(a,e)},800))}),e.addEventListener("mouseleave",()=>{clearTimeout(l),setTimeout(()=>{a.matches(":hover")||m(a)},200)}),a.addEventListener("mouseleave",()=>{setTimeout(()=>{e.matches(":hover")||m(a)},200)});let c,d=!1;e.addEventListener("touchstart",u=>{T.isDragging||(d=!1,c=setTimeout(()=>{!d&&!T.isDragging&&p(a,e)},500))}),e.addEventListener("touchmove",()=>{d=!0,clearTimeout(c)}),e.addEventListener("touchend",()=>{clearTimeout(c)}),document.addEventListener("click",u=>{!a.contains(u.target)&&!e.contains(u.target)&&m(a)});function p(u,f){document.querySelectorAll(".start-menu-context-menu").forEach(b=>{b!==u&&(b.style.display="none",b.classList.add("hidden"))}),u.style.display="block",u.classList.remove("hidden");const g=f.getBoundingClientRect(),w=u.getBoundingClientRect();u.style.left=`${f.offsetWidth}px`,u.style.top="-1px",document.getElementById("start-menu").getBoundingClientRect(),g.right+w.width>window.innerWidth&&(u.style.left=`-${w.width+5}px`)}function m(u){u.style.display="none",u.classList.add("hidden")}}const Us=[{id:"mycomp",text:"My Computer",icon:"image/computer.webp",type:"item"},{id:"mailboxapp",text:"Mail Box",icon:"image/mail.webp",type:"item"},{id:"mediaapp",text:"Media Player",icon:"image/video.webp",type:"item"},{id:"tubestreamapp",text:"TubeStream",icon:"image/youtube.webp",type:"item"},{id:"watercolourapp",text:"Watercolour",icon:"image/watercolour.webp",type:"item"},{id:"utilities-group",text:"Utilities",type:"group",items:[{id:"letterpad",text:"LetterPad",icon:"image/file.webp"},{id:"calcapp",text:"Calculator",icon:"image/calculator.webp"},{id:"keyboard",text:"Keyboard",icon:"image/keyboard.webp"},{id:"sysset",text:"Desktop Settings",icon:"image/gears.webp"},{id:"storageapp",text:"Storage Manager",icon:"image/drive_c.webp"},{id:"abtcomp",text:"About This Computer",icon:"image/info.webp"}]},{id:"games-group",text:"Games",type:"group",items:[{id:"solapp",text:"Solitaire",icon:"image/solitaire.webp"},{id:"chessapp",text:"Guillotine Chess",icon:"image/guillotine_chess.webp"},{id:"bombapp",text:"Bombbroomer",icon:"image/bombbroomer.webp"},{id:"pongapp",text:"Pong",icon:"image/pong.webp"},{id:"snakeapp",text:"Snake",icon:"image/snake.webp"},{id:"happyturdapp",text:"Happy Turd",icon:"image/happyturd.webp"}]},{id:"rstrtcomp",text:"Restart",icon:"image/power.webp",type:"item",fixed:!0}];function eo(){document.querySelectorAll('#start-menu [role="menuitem"]').forEach(n=>{n.classList.remove("bg-gray-50","focus-visible","keyboard-focused"),n.setAttribute("tabindex","-1"),n.blur()}),window.startMenuKeyboardNavState&&window.startMenuKeyboardNavState.setKeyboardNavigating(!1)}function Ys(e,n=!1){const t=document.querySelectorAll('#start-menu [role="menuitem"]');if(t.forEach(i=>{i.classList.remove("bg-gray-50","focus-visible","keyboard-focused"),i.setAttribute("tabindex","-1"),i.hasAttribute("aria-haspopup")&&i.setAttribute("aria-expanded","false")}),document.querySelectorAll("[data-submenu-container]").forEach(i=>{i.classList.add("hidden"),i.classList.remove("block")}),t[e]){const i=t[e];if(i.classList.add("bg-gray-50","focus-visible","keyboard-focused"),i.setAttribute("tabindex","0"),i.focus(),n&&i.hasAttribute("data-submenu-trigger")){const o=i.nextElementSibling;o&&(o.classList.remove("hidden"),o.classList.add("block"),i.setAttribute("aria-expanded","true"))}if(i.hasAttribute("data-submenu-item")){const o=i.closest("[data-submenu-container]");if(o){o.classList.remove("hidden"),o.classList.add("block");const r=o.parentElement.querySelector("[data-submenu-trigger]");r&&r.setAttribute("aria-expanded","true")}}i.scrollIntoView({behavior:"smooth",block:"nearest"})}}function Sr(){let e=0,n=[],t=!1,i=!1;window.startMenuKeyboardNavState={isKeyboardNavigating:()=>i,setKeyboardNavigating:d=>{i=d}};function o(d,p=!1){i=!0,Ys(d,p)}document.addEventListener("keydown",function(d){const p=/Mac|iPod|iPhone|iPad/.test(navigator.platform);if((d.key==="Meta"||d.key==="OS")&&!p&&(d.preventDefault(),typeof toggleStartMenu=="function")){toggleStartMenu();const m=document.getElementById("start-menu");m&&!m.classList.contains("hidden")&&setTimeout(()=>{l(),o(0)},50)}});function r(){return n=Array.from(document.querySelectorAll('#start-menu [role="menuitem"]')),n}function a(){return n.filter(d=>!d.hasAttribute("data-submenu-item"))}function s(d){return n.filter(p=>p.hasAttribute("data-submenu-item")&&p.getAttribute("data-parent-group")===d)}function l(){r(),e=0,t=!1,n.length>0}const c=document.getElementById("start-button");c&&c.addEventListener("click",()=>{l()}),document.addEventListener("keydown",function(d){var m;const p=document.getElementById("start-menu");if(!(!p||p.classList.contains("hidden"))&&(r(),n.length!==0))switch(d.key){case"ArrowDown":if(d.preventDefault(),!i)i=!0,o(e);else if(t){const g=n[e],w=g.getAttribute("data-parent-group"),b=s(w),C=b.indexOf(g);if(C<b.length-1){const h=b[C+1];e=n.indexOf(h),o(e)}}else{const g=a(),w=n[e];if(w.hasAttribute("data-submenu-item")){t=!0;return}const b=g.indexOf(w);if(b<g.length-1){const C=g[b+1];e=n.indexOf(C),o(e)}}break;case"ArrowUp":if(d.preventDefault(),!i)i=!0,o(e);else if(t){const g=n[e],w=g.getAttribute("data-parent-group"),b=s(w),C=b.indexOf(g);if(C>0){const h=b[C-1];e=n.indexOf(h),o(e)}}else{const g=a(),w=n[e],b=g.indexOf(w);if(b>0){const C=g[b-1];e=n.indexOf(C),o(e)}}break;case"ArrowRight":d.preventDefault();const u=n[e];if(u.hasAttribute("data-submenu-trigger")){const g=u.nextElementSibling.getAttribute("data-group-id"),w=s(g);w.length>0&&(t=!0,e=n.indexOf(w[0]),o(e,!0))}break;case"ArrowLeft":d.preventDefault();const f=n[e];if(f.hasAttribute("data-submenu-item")){const g=f.getAttribute("data-parent-group"),w=(m=document.querySelector(`[data-submenu-container][data-group-id="${g}"]`))==null?void 0:m.previousElementSibling;w&&(t=!1,e=n.indexOf(w),o(e))}break;case"Enter":case" ":d.preventDefault(),n[e]&&n[e].click();break;case"Escape":d.preventDefault(),typeof toggleStartMenu=="function"&&toggleStartMenu();break;case"Tab":setTimeout(()=>{const g=document.activeElement,w=n.indexOf(g);w!==-1&&(e=w,i=!0,g.hasAttribute("data-submenu-item")?t=!0:t=!1)},0);break}}),r()}function An(){const e=document.getElementById("start-menu");if(!e){console.error("Start menu container not found");return}const n=typeof startMenuOrder<"u"?startMenuOrder:window.startMenuOrder||[];let t=[...Us];try{const o=typeof Yt=="function"?Yt():{};if(o.default&&o.default.length>0){const a=t.findIndex(l=>l.id==="utilities-group"),s=a>=0?a:t.length-1;t.splice(s,0,...o.default)}const r=new Set;Object.keys(o).forEach(a=>{if(a==="default")return;const s=o[a];if(s.length===0)return;const c={games:"games-group",utilities:"utilities-group"}[a.toLowerCase()];if(c){const d=t.find(p=>p.id===c);d&&d.items&&s.forEach(p=>{d.items.find(m=>m.id===p.id)||(d.items.push(p),r.add(p.id))})}})}catch(o){console.error("Failed to load custom apps for start menu:",o)}if(n&&n.length>0){const o=[],r=new Set;n.forEach(a=>{if(typeof a=="string"){const s=t.find(l=>l.id===a);s&&(o.push(s),r.add(s.id))}else if(typeof a=="object"&&a.type==="group"){const s=t.find(l=>l.id===a.id);if(s){const l={...s,items:[]};a.items&&Array.isArray(a.items)?(a.items.forEach(c=>{const d=s.items.find(p=>p.id===c);d&&l.items.push(d)}),s.items.forEach(c=>{a.items.includes(c.id)||l.items.push(c)})):l.items=s.items,o.push(l),r.add(s.id)}}}),t.forEach(a=>{!r.has(a.id)&&!a.fixed&&o.splice(o.length-1,0,a)}),t.forEach(a=>{if(a.fixed){const s=o.findIndex(l=>l.id===a.id);s>=0&&o.splice(s,1),o.push(a)}}),t=o}const i=document.createElement("ul");if(t.forEach(o=>{if(!jt.has(o.id)){if(o.type==="item"){const r=Gs(o);i.appendChild(r)}else if(o.type==="group"){const r=o.items.filter(a=>!jt.has(a.id));if(r.length>0){const a={...o,items:r},s=Ks(a);i.appendChild(s)}}}}),e.innerHTML="",e.appendChild(i),typeof window.updateStartMenuFocusability=="function"){const o=!e.classList.contains("hidden");window.updateStartMenuFocusability(o)}}function Gs(e){const n=document.createElement("li");return n.id=e.id,n.className=e.fixed?"px-4 py-2 hover:bg-gray-50 cursor-pointer flex items-center relative":"px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center relative",n.setAttribute("role","menuitem"),n.setAttribute("tabindex","-1"),n.setAttribute("aria-label",e.text),n.innerHTML=`
    <img src="${e.icon}" class="h-6 w-6 inline mr-2" alt="${e.text} icon">
    ${e.text}
  `,n.addEventListener("click",t=>{const i=n.querySelector(".start-menu-context-menu");i&&i.style.display!=="none"||Mt(e.id)}),n.addEventListener("mouseenter",()=>{var t;(t=window.startMenuKeyboardNavState)!=null&&t.isKeyboardNavigating()&&eo()}),e.fixed||Er(n,e,!1),n}function Ks(e){const n=document.createElement("li");n.className="group relative",n.setAttribute("data-group-id",e.id);let t="";e.items.forEach(a=>{t+=`
      <li id="${a.id}" class="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center submenu-item relative" data-submenu-item data-parent-group="${e.id}" role="menuitem" tabindex="-1" aria-label="${a.text}">
        <img src="${a.icon}" class="h-6 w-6 inline mr-2" alt="${a.text} icon">
        ${a.text}
      </li>
    `}),n.innerHTML=`
    <a href="#" data-submenu-trigger class="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center justify-between" role="menuitem" tabindex="-1" aria-label="${e.text}" aria-haspopup="true" aria-expanded="false">
      <div class="flex items-center">
        ${e.text}
      </div>
      <span class="md:rotate-0 text-xs">&#9654;</span>
    </a>
    <ul class="submenu hidden pl-4 bg-gray-100 md:pl-0 md:absolute md:left-full md:bottom-0 md:w-48 md:bg-white md:border md:border-gray-500 md:shadow-lg" data-submenu-container data-group-id="${e.id}" role="menu">
      ${t}
    </ul>
  `,n.querySelectorAll("ul li").forEach((a,s)=>{a.addEventListener("click",c=>{var d;((d=a.querySelector(".start-menu-context-menu"))==null?void 0:d.style.display)==="none"&&Mt(a.id)}),a.addEventListener("mouseenter",()=>{var c;(c=window.startMenuKeyboardNavState)!=null&&c.isKeyboardNavigating()&&eo()});const l=e.items[s];l&&Er(a,l,!0,e.id)});const o=n.querySelector("[data-submenu-trigger]"),r=n.querySelector("[data-submenu-container]");return o&&o.addEventListener("mouseenter",()=>{var a;(a=window.startMenuKeyboardNavState)!=null&&a.isKeyboardNavigating()&&eo()}),o&&r&&(window.matchMedia("(hover: hover)").matches?(n.addEventListener("mouseenter",()=>{T.isDragging||(r.classList.remove("hidden"),r.classList.add("block"))}),n.addEventListener("mouseleave",()=>{T.isDragging||(r.classList.add("hidden"),r.classList.remove("block"))})):o.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),r.classList.contains("hidden")?(document.querySelectorAll(".submenu").forEach(l=>{l!==r&&(l.classList.add("hidden"),l.classList.remove("block"))}),r.classList.remove("hidden"),r.classList.add("block")):(r.classList.add("hidden"),r.classList.remove("block"))})),n}async function Bt(){if(typeof window.isInitializing<"u"&&window.isInitializing)return;const n=document.getElementById("start-menu").querySelector("ul"),t=Array.from(n.children),i=[];if(t.forEach(o=>{if(o.id&&!o.classList.contains("group")&&o.id!=="rstrtcomp")i.push(o.id);else if(o.classList.contains("group")){const r=o.getAttribute("data-group-id"),a=o.querySelector("[data-submenu-container]");if(a){const l=Array.from(a.querySelectorAll(".submenu-item")).map(c=>c.id);i.push({type:"group",id:r,items:l})}}}),!i||i.length===0){console.warn("Refusing to save empty start menu order - likely a race condition");return}if(typeof window<"u"){window.startMenuOrder=i;try{typeof startMenuOrder<"u"&&(startMenuOrder=i)}catch{}}try{if(await z.setItem("startMenuOrder",i),typeof saveState=="function")await saveState();else{const o=await z.getItem("appState")||{};o.startMenuOrder=i,await z.setItem("appState",o)}try{const o=await z.getItem("startMenuOrder");(!o||o.length===0)&&console.warn("Verification failed: startMenuOrder is empty in storage")}catch(o){console.warn("Verification error:",o)}}catch(o){console.error("Failed to save start menu order:",o)}}function Xs(e){const n=typeof Yt=="function"?Yt():{};if(!e||e.length===0)return console.log("[START MENU MERGE] No saved order, using defaults"),e;const t=new Set;e.forEach(a=>{typeof a=="string"?t.add(a):a.type==="group"&&a.items&&a.items.forEach(s=>t.add(s))}),console.log("[START MENU MERGE] Existing IDs in saved order:",Array.from(t));const i=[];if(n.default&&n.default.length>0&&n.default.forEach(a=>{t.has(a.id)||i.push(a)}),Object.keys(n).forEach(a=>{if(a==="default")return;n[a].forEach(l=>{t.has(l.id)||(l._targetLocation=a,i.push(l))})}),i.length===0)return console.log("[START MENU MERGE] No new custom apps to add"),e;console.log("[START MENU MERGE] Adding",i.length,"new custom app(s)");const o=[...e],r={games:"games-group",utilities:"utilities-group"};return i.forEach(a=>{let s=!1;if(a._targetLocation){const l=r[a._targetLocation.toLowerCase()];if(l){const c=o.findIndex(d=>typeof d=="object"&&d.id===l);c>=0&&(o[c].items.push(a.id),s=!0)}}if(!s){const l=o.findIndex(c=>typeof c=="object"&&c.id==="utilities-group");if(l>=0)o.splice(l,0,a.id);else{const c=o.findIndex(d=>d==="rstrtcomp");c>=0?o.splice(c,0,a.id):o.push(a.id)}}}),console.log("[START MENU MERGE] Merge complete, new order has",o.length,"items"),o}async function Dn(){let e=[];try{const n=await z.getItem("startMenuOrder");if(n&&Array.isArray(n))e=n;else{const t=await z.getItem("appState");t&&t.startMenuOrder&&(e=t.startMenuOrder)}}catch(n){console.warn("‚ö† Failed to load from direct storage, using global variables:",n),e=typeof startMenuOrder<"u"?startMenuOrder:window.startMenuOrder||[]}e=Xs(e),typeof window<"u"&&(window.startMenuOrder=e);try{typeof startMenuOrder<"u"&&(startMenuOrder=e)}catch{}An(),setTimeout(()=>{Eo()},50)}async function Vs(){const e={mailbox:!1,tubestream:!1},n=async o=>{const r=new AbortController,a=setTimeout(()=>r.abort(),3e4);try{const s=await fetch(o,{method:"HEAD",signal:r.signal});return s.ok?!0:s.status===405||s.status===404?(await fetch(o,{method:"GET",signal:r.signal})).ok:!1}catch(s){return console.warn(`Probe failed for ${o}:`,s),!1}finally{clearTimeout(a)}},[t,i]=await Promise.all([n(`${Ue}${oi}`),n(`${Ue}${ii}`)]);return e.mailbox=t,e.tubestream=i,console.log("üîç API Probe Results:",e),e}async function Zs(){try{const e=await Vs();e.mailbox||jt.add("mailboxapp"),e.tubestream||jt.add("tubestreamapp"),jt.size>0&&An()}catch(e){console.error("Failed to initialize API probes:",e)}}async function yn(){await Cn(),Dn(),Zs(),Sr()}window.initializeStartMenu=yn;window.initializeStartMenuDragDrop=vr;window.safeInitializeStartMenuDragDrop=Eo;window.restoreStartMenuOrder=Dn;window.saveStartMenuOrder=Bt;window.debugStartMenuState=async function(){const e=document.getElementById("start-menu"),n=e==null?void 0:e.querySelector("ul"),t=Array.from((n==null?void 0:n.children)||[]).map(i=>{var a;const o=i.cloneNode(!0),r=o.querySelector(".start-menu-context-menu");return r&&r.remove(),{id:i.id,text:(a=o.textContent)==null?void 0:a.trim()}});console.log("Global startMenuOrder:",typeof startMenuOrder<"u"?startMenuOrder:"undefined"),console.log("Window startMenuOrder:",window.startMenuOrder);try{const i=await storage.getItem("appState");console.log("Storage appState:",i)}catch(i){console.error("Error reading from storage:",i)}console.log("DOM Order:",t)};window.testSaveStartMenu=function(){Bt().catch(e=>{console.error("Test save failed:",e)})};window.testBasicSave=async function(){if(window.startMenuOrder=["test1","test2","test3"],typeof window.saveState=="function")try{await window.saveState(),console.log("Basic save completed")}catch(e){console.error("Basic save failed:",e)}else console.error("‚ùå window.saveState not available")};window.testRealSave=async function(){await Bt()};window.testRestore=function(){Dn()};window.testFullStartMenuFlow=async function(){await window.debugStartMenuState(),yn(),await window.debugStartMenuState(),await window.testRealSave(),window.testRestore(),await window.debugStartMenuState()};window.testStartMenuSave=async function(){const e=["app-calculator","app-chess","app-mediaplayer"];console.warn("testStartMenuSave: saveStartMenuOrder reads from DOM, so passing arguments is ignored."),await Bt();const n=await storage.getItem("startMenuOrder"),t=await storage.getItem("appState");return{testOrder:e,directResult:n,appStateResult:t==null?void 0:t.startMenuOrder,globalResult:typeof startMenuOrder<"u"?startMenuOrder:null,windowResult:window.startMenuOrder}};window.testStartMenuRestore=async function(){var n;typeof window<"u"&&(window.startMenuOrder=[]);try{typeof startMenuOrder<"u"&&(startMenuOrder=[])}catch{console.warn("Could not clear global startMenuOrder")}return await Dn(),{globalResult:typeof startMenuOrder<"u"?startMenuOrder:null,windowResult:window.startMenuOrder,menuHTML:((n=document.getElementById("start-menu"))==null?void 0:n.innerHTML.substring(0,200))+"..."}};window.debugStorageContents=async function(){try{const e=await storage.getItem("appState"),n=await storage.getItem("startMenuOrder");return{appState:e,directStartMenu:n,globalStartMenu:typeof startMenuOrder<"u"?startMenuOrder:null,windowStartMenu:window.startMenuOrder}}catch(e){return console.error("‚ùå Error debugging storage:",e),{error:e.message}}};document.addEventListener("DOMContentLoaded",()=>{});function to(e){const n=document.getElementById("start-menu");if(!n)return;n.querySelectorAll('[role="menuitem"], a[data-submenu-trigger]').forEach(i=>{e?i.setAttribute("tabindex","-1"):(i.setAttribute("tabindex","-1"),i.blur())})}function Tt(){const e=document.getElementById("start-menu"),n=document.getElementById("start-button"),t=e.classList.contains("hidden");e.classList.toggle("hidden"),n.setAttribute("aria-expanded",t?"true":"false"),t?(e.setAttribute("aria-hidden","false"),to(!0),typeof ft=="function"&&ft()):(e.setAttribute("aria-hidden","true"),to(!1),!Object.values(J).some(o=>o.fullScreen)&&typeof ze=="function"&&ze()),Qe("start-button"),Js(),e.classList.contains("hidden")||setTimeout(()=>{typeof safeInitializeStartMenuDragDrop=="function"?safeInitializeStartMenuDragDrop():typeof initializeStartMenuDragDrop=="function"?initializeStartMenuDragDrop():console.warn("Start menu drag and drop initialization functions not available")},10)}function Bn(){for(const n in J)Je(n);document.querySelectorAll("#window-tabs > div").forEach(n=>{n.classList.remove("bg-gray-50")}),typeof ze=="function"&&ze();const e=document.getElementById("desktop-stage");e&&(e.style.overflow="scroll")}function Tn(e,n="",t={type:"default"},i="default"){if(Oe[e]){const o=document.getElementById(Oe[e]);if(o){ke(o);return}else delete Oe[e]}ae(e,n,!0,null,!1,!1,t,i)}function Fn(){const e=document.getElementById("clock"),n=new Date;let t=n.getHours(),i=n.getMinutes(),o=n.getSeconds();t=t<10?"0"+t:t,i=i<10?"0"+i:i,o=o<10?"0"+o:o;let a=typeof be<"u"&&be&&be.clockSeconds||!1?`${t}:${i}:${o}`:`${t}:${i}`;e.textContent=a}function Pn(){const e=$n();e&&(e.paused?e.play():e.pause(),Co())}function Co(){const e=$n(),n=document.getElementById("media-control");e?(n.textContent=e.paused?"‚ñ∂":"‚è∏",n.setAttribute("aria-label",e.paused?"Play media":"Pause media"),n.style.display="inline-block"):(n.textContent="",n.setAttribute("aria-label","No media playing"),n.style.display="none")}function $n(){if(kt){const e=document.getElementById(kt);if(e)return e.querySelector("video, audio")}return null}setInterval(Fn,1e3);Fn();document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelectorAll("[data-submenu-trigger]");window.innerWidth<1024&&e.forEach(t=>{const i=t.nextElementSibling,o=t.querySelector("span");t.addEventListener("click",r=>{r.preventDefault(),i.classList.contains("hidden")?(i.classList.remove("hidden"),i.classList.add("block"),o.classList.add("rotate-90")):(i.classList.remove("block"),i.classList.add("hidden"),o.classList.remove("rotate-90"))})})});document.getElementById("media-control").addEventListener("click",()=>{Pn()});document.getElementById("min-all-btn").addEventListener("click",()=>{Tt(),Bn()});document.getElementById("start-button").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),Tt()});document.getElementById("start-button").addEventListener("touchstart",e=>{e.preventDefault(),e.stopPropagation(),Tt()},{passive:!1});function Js(){const e=document.getElementById("start-button").querySelector("img");e.src.includes("image/door-closed.webp")?e.src=e.src.replace("door-closed","door-open"):e.src=e.src.replace("door-open","door-closed")}const Qs=Object.freeze(Object.defineProperty({__proto__:null,getActiveMediaElement:$n,minimizeAllWindows:Bn,openNav:Tn,toggleMediaPlayback:Pn,toggleStartMenu:Tt,updateClock:Fn,updateMediaControl:Co,updateStartMenuFocusability:to},Symbol.toStringTag,{value:"Module"}));async function pt(e){if(e.dataset.initialized==="true")return;e.dataset.initialized="true";try{await z.ensureReady()}catch(M){console.warn("Storage not ready, falling back to sync methods:",M)}const n=e.getAttribute("data-letterpad-editor-id"),t=`letterpad_${n}`;let i=null,o="sans";try{const M=await z.getItem(t);if(M)try{const O=M;i=O.content,o=O.font||"sans"}catch(O){console.error("Error accessing stored markdown data for editor "+n,O)}}catch(M){console.warn("Failed to load LetterPad content for editor "+n+", trying sync method:",M);try{const O=z.getItemSync(t);if(O){const H=O;i=H.content,o=H.font||"sans"}}catch(O){console.warn("Sync fallback also failed:",O)}}const r=document.createElement("div");r.className="flex flex-col h-full w-full border rounded p-2 bg-white";const a=document.createElement("div");a.className="flex flex-wrap gap-2 mb-2";const s=document.createElement("select");s.className="border rounded p-1",s.id="heading-selector",s.setAttribute("aria-label","Select text formatting style"),s.setAttribute("title","Choose the text style (paragraph, heading 1, etc.)"),[{value:"paragraph",text:"Paragraph"},{value:"h1",text:"Heading 1"},{value:"h2",text:"Heading 2"},{value:"h3",text:"Heading 3"}].forEach(M=>{const O=document.createElement("option");O.value=M.value,O.textContent=M.text,s.appendChild(O)}),a.appendChild(s);const c=document.createElement("select");c.className="border rounded p-1",c.id="font-selector",c.setAttribute("aria-label","Select font family"),c.setAttribute("title","Choose the font family for your text"),[{value:"sans",text:"Pixelify Sans"},{value:"serif",text:"Coral Pixels"},{value:"blackletter",text:"Jacquard 12"}].forEach(M=>{const O=document.createElement("option");O.value=M.value,O.textContent=M.text,c.appendChild(O)}),a.appendChild(c),c.value=o;const p=["font-sans","font-serif","font-blackletter"];function m(){p.forEach(M=>b.classList.remove(M)),b.classList.add(`font-${o}`)}function u(M){var te;A();const O=N.start,H=N.end;if(O===H)return;const Z=b.value,X=Z.substring(O,H),S=Z.substring(0,O),I=Z.substring(H),B=/^\[font=(sans|serif|blackletter)\]/,D="[/font]",E=`[font=${M}]`;let F=X;const V=B.test(X),ee=X.endsWith(D);if(V&&ee){F=F.replace(B,""),F=F.slice(0,F.length-D.length);const ne=(te=X.match(B))==null?void 0:te[1];if(ne&&ne!==M){const ye=`${E}${F}${D}`;b.value=S+ye+I,b.selectionStart=O+E.length,b.selectionEnd=O+E.length+F.length;return}else{b.value=S+F+I,b.selectionStart=O,b.selectionEnd=O+F.length;return}}const re=`${E}${F}${D}`;b.value=S+re+I,N.start=b.selectionStart=O+E.length,N.end=b.selectionEnd=O+E.length+F.length}const f=document.createElement("button");f.type="button",f.className="border rounded p-1 hover:bg-gray-200",f.textContent="Bold",f.setAttribute("aria-label","Apply bold formatting"),f.setAttribute("title","Make selected text bold"),a.appendChild(f);const g=document.createElement("button");g.type="button",g.className="border rounded p-1 hover:bg-gray-200",g.textContent="Italic",g.setAttribute("aria-label","Apply italic formatting"),g.setAttribute("title","Make selected text italic"),a.appendChild(g);const w=document.createElement("button");w.type="button",w.className="border rounded p-1 hover:bg-gray-200",w.textContent="Underline",w.setAttribute("aria-label","Apply underline formatting"),w.setAttribute("title","Underline selected text"),a.appendChild(w);const b=document.createElement("textarea");b.className="w-full h-full flex-1 min-h-0 border rounded p-2 resize-none",b.id="markdown-editor",b.setAttribute("aria-label","Markdown text editor"),b.setAttribute("placeholder","Type your text here using Markdown formatting..."),b.setAttribute("title","Enter your text with Markdown formatting"),m();const C=document.createElement("div");C.className="w-full h-full flex-1 min-h-0 border rounded p-2 overflow-auto";const h=document.createElement("button");h.type="button",h.className="border rounded p-1 hover:bg-gray-200 self-end",h.setAttribute("aria-label","Toggle between edit and preview mode"),h.setAttribute("title","Switch between editing and preview modes"),i?h.textContent="Edit":h.textContent="Save & Preview";const _=document.createElement("div");_.className="flex-1 min-h-0 flex flex-col",_.appendChild(b),_.appendChild(C),r.appendChild(a),r.appendChild(_),r.appendChild(h),e.appendChild(r),a.addEventListener("mousedown",M=>{M.target&&M.target.closest("button")&&M.preventDefault()}),c.addEventListener("mousedown",j),s.addEventListener("mousedown",j);let N={start:0,end:0};function j(){N.start=b.selectionStart,N.end=b.selectionEnd}function A(){b.focus(),b.selectionStart=N.start,b.selectionEnd=N.end}["keyup","mouseup","select","input"].forEach(M=>{b.addEventListener(M,j)}),f.addEventListener("click",function(M){M.preventDefault(),A(),no("**",b)}),g.addEventListener("click",function(M){M.preventDefault(),A(),no("*",b)}),w.addEventListener("click",function(M){M.preventDefault(),A();const O=b.selectionStart,H=b.selectionEnd,Z=b.value.substring(O,H),X=b.value.substring(0,O),S=b.value.substring(H);if(O!==H)if(Z.startsWith("<u>")&&Z.endsWith("</u>")){const I=Z.substring(3,Z.length-4);b.value=X+I+S,b.selectionStart=O,b.selectionEnd=H-7}else{const I=`<u>${Z}</u>`;b.value=X+I+S,b.selectionStart=O,b.selectionEnd=H+7}}),s.addEventListener("change",function(){const M=s.value;A();const O=N.start,H=b.value,Z=H.lastIndexOf(`
`,O-1)+1;let X="";M==="h1"?X="# ":M==="h2"?X="## ":M==="h3"?X="### ":X="";const S=H.indexOf(`
`,O),B=H.substring(Z,S===-1?H.length:S).replace(/^(#{1,6}\s)?/,X);b.value=H.substring(0,Z)+B+H.substring(S===-1?H.length:S)}),i?(b.value=i,C.innerHTML=un(i),b.classList.add("hidden"),a.classList.add("hidden"),h.classList.remove("hidden"),C.classList.remove("hidden")):C.classList.add("hidden"),h.addEventListener("click",async function(){if(b.classList.contains("hidden"))C.classList.add("hidden"),b.classList.remove("hidden"),a.classList.remove("hidden"),h.textContent="Preview & Save";else{const M=b.value;C.innerHTML=un(M);try{await z.setItem(t,{content:M,font:o})}catch(O){console.warn("Failed to save LetterPad content for editor "+n,O)}b.classList.add("hidden"),C.classList.remove("hidden"),h.textContent="Edit",a.classList.add("hidden")}}),c.addEventListener("change",function(){o=c.value,b.classList.contains("hidden")||(A(),u(o),C.classList.contains("hidden")||(C.innerHTML=un(b.value)))})}document.addEventListener("DOMContentLoaded",async function(){try{await z.ensureReady()}catch(t){console.warn("Storage not ready during LetterPad initialization:",t)}const e=document.querySelectorAll(".letterpad_editor");for(const t of e)try{await pt(t)}catch(i){console.error("Error initializing LetterPad editor during DOMContentLoaded:",i)}new MutationObserver(t=>{t.forEach(i=>{i.type==="childList"&&i.addedNodes.forEach(o=>{o.nodeType===Node.ELEMENT_NODE&&(o.classList.contains("letterpad_editor")&&pt(o).catch(r=>{console.error("Error initializing LetterPad editor:",r)}),o.querySelectorAll&&o.querySelectorAll(".letterpad_editor").forEach(r=>{pt(r).catch(a=>{console.error("Error initializing LetterPad editor:",a)})}))})})}).observe(document.body,{childList:!0,subtree:!0})});async function Cr(){const e=document.querySelectorAll('.letterpad_editor:not([data-initialized="true"])');for(const n of e)try{await pt(n)}catch(t){console.error("Error initializing LetterPad editor:",t)}}window.initializeAllLetterPadEditors=Cr;function no(e,n){const t=n.selectionStart,i=n.selectionEnd;if(t===i)return;const o=n.value.substring(t,i),r=n.value.substring(0,t),a=n.value.substring(i),s=e.length,l=o.startsWith(e),c=o.endsWith(e);let d,p=2*s;l&&c?(d=o.slice(s,-s),p=-p):d=e+o+e,n.value=r+d+a,setTimeout(()=>{n.focus(),n.selectionStart=t,n.selectionEnd=i+p},0)}function un(e){let n=e;const t=/\[font=(sans|serif|blackletter)\]([\s\S]+?)\[\/font\]/g;return n=n.replace(t,(r,a,s)=>`<span class="font-${a}">${s}</span>`),n=n.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),n=n.replace(/\*(.+?)\*/g,"<em>$1</em>"),n=n.replace(/###### (.*)/g,'<h6 class="mt-1 mb-2 text-2xl">$1</h6>'),n=n.replace(/##### (.*)/g,'<h5 class="mt-1 mb-2 text-3xl">$1</h5>'),n=n.replace(/#### (.*)/g,'<h4 class="mt-1 mb-2 text-4xl">$1</h4>'),n=n.replace(/### (.*)/g,'<h3 class="mt-1 mb-2 text-5xl">$1</h3>'),n=n.replace(/## (.*)/g,'<h2 class="mt-1 mb-2 text-6xl">$1</h2>'),n=n.replace(/# (.*)/g,'<h1 class="mt-1 mb-2 text-7xl">$1</h1>'),n=n.replace(/\n/g,"<br>"),qr(n,["strong","em","h1","h2","h3","h4","h5","h6","br","u","span"],["class"])}document.addEventListener("contextmenu",function(e){let n=e.target.closest(".draggable-icon, .file-item"),t=e.target.closest(".file-explorer-window"),i=e.target.closest("#explorer-window"),o=t||i,r=e.target.closest("#windows-container > div"),a=e.target.closest("#desktop-icons"),l=(e.target.id==="windows-container"||a)&&!r;if(!n&&!o&&!l)return;e.preventDefault();let c;if(t)c=t.getAttribute("data-current-path");else if(i){const d=i.querySelector(".file-explorer-window");c=(d==null?void 0:d.getAttribute("data-current-path"))||"C://"}else l?c="C://Desktop":c="C://";Ir(e,n,c)});document.addEventListener("click",function(){Fe()});function Ir(e,n,t){const i=document.getElementById("context-menu");i.replaceChildren(),i.style.zIndex=Se+100;const o=(g,w,b,C=!1)=>{const h=document.createElement("div");return h.className=`px-4 py-2 relative ${w?"text-gray-400":"hover:bg-gray-50 cursor-pointer"}`,C?h.innerHTML=`${g} <span class="float-right">‚ñ∂</span>`:h.textContent=g,!w&&b&&h.addEventListener("click",b),i.appendChild(h),h},r=(g,w)=>{const b=document.createElement("div");b.className="absolute left-full top-0 bg-white border border-gray-500 shadow-lg hidden min-w-32",b.style.zIndex=Se+101,w.forEach(({text:_,disabled:N,onclick:j})=>{const A=document.createElement("div");A.textContent=_,A.className=`px-4 py-2 ${N?"text-gray-400":"hover:bg-gray-50 cursor-pointer"}`,!N&&j&&A.addEventListener("click",M=>{Fe(),j(M)}),b.appendChild(A)}),g.appendChild(b);let C;const h=()=>{b.classList.remove("hidden"),b.style.left="100%",b.style.right="auto",b.style.top="0",b.style.bottom="auto";const _=b.getBoundingClientRect(),N=window.innerWidth,j=window.innerHeight;_.right>N&&(b.style.left="auto",b.style.right="100%"),_.bottom>j&&(b.style.top="auto",b.style.bottom="0")};g.addEventListener("mouseenter",()=>{clearTimeout(C),h()}),g.addEventListener("mouseleave",()=>{C=setTimeout(()=>{b.classList.add("hidden")},200)}),g.addEventListener("touchstart",_=>{b.contains(_.target)||(_.preventDefault(),b.classList.contains("hidden")?h():b.classList.add("hidden"))}),b.addEventListener("mouseenter",()=>{clearTimeout(C)}),b.addEventListener("mouseleave",()=>{C=setTimeout(()=>{b.classList.add("hidden")},200)})};if(n){n.classList.add("right-click-target");const g=n.getAttribute("data-is-vendor-application")==="true",w=n.getAttribute("data-item-id")==="compostbin",b=n.getAttribute("data-item-id");let C=!1;if(b&&!w){const h=se();if(h&&h.folders){const _=n.closest(".file-explorer-window");let N=t;_&&(N=_.getAttribute("data-current-path"));const j=h.folders[N];j&&j[b]&&(C=j[b].type==="folder")}}if(w)o("Empty Compost Bin",!1,h=>{h.stopPropagation(),Fe(),typeof emptyCompostBin=="function"&&emptyCompostBin()});else{C&&o("Open in new window",!1,N=>{N.stopPropagation(),Fe();const j=document.querySelector(".right-click-target");if(j){const A=j.getAttribute("data-item-id");A&&wt(A)}j.classList.remove("right-click-target")}),o("Edit Name",g,N=>el(N));const h=n.getAttribute("data-compostable")==="true";o("Send to Compost Bin",g&&!h,N=>tl(N)),o("New Folder",!0),o("New File",!0),o("New Shortcut",!0)}}else{o("New Folder",!1,w=>Lr(w,t));const g=o("New File",!1,null,!0);r(g,[{text:"LetterPad",disabled:!1,onclick:async w=>await il(w,t)},{text:"Image",disabled:!1,onclick:w=>rl(w,t)},{text:"Audio",disabled:!1,onclick:w=>al(w,t)},{text:"Video",disabled:!1,onclick:w=>sl(w,t)}]),o("New Shortcut",!1,w=>ol(w,t))}let a=e.clientY,s=e.clientX;i.style.visibility="hidden",i.classList.remove("hidden");const l=i.getBoundingClientRect(),c=window.innerWidth,d=window.innerHeight,p=window.innerWidth<=768,m=p?22:0,u=p?22:0,f=48;s+l.width>c-m&&(s=c-l.width-m-5),a+l.height>d-f-u&&(a=d-l.height-f-u-5),s<5&&(s=5),a<5&&(a=5),i.style.top=`${a}px`,i.style.left=`${s}px`,i.style.visibility="visible"}function Fe(){document.getElementById("context-menu").classList.add("hidden")}function el(e,n){e.stopPropagation(),Fe();const t=document.querySelector(".right-click-target");if(t.classList.remove("right-click-target"),!t){ie("No item selected.","error");return}const i=t.getAttribute("data-item-id"),o=t.closest(".file-explorer-window");let r;o?r=o.getAttribute("data-current-path"):r=t.getAttribute("data-current-path");let a=se();if(!a||!a.folders){console.error("File system state not properly initialized:",a),ie("File system not initialized. Please refresh the page.","error");return}let s={};const l=r.length===4;if(s=a.folders[r],!s){console.error("Folder contents not found for path:",r),ie("Folder contents not found.","error");return}if(!(i in s)){ie("Item not found.","error");return}let c=s[i];if(!c){ie("Item not found in file system.","error");return}const d=`window-${Date.now()}`,m=ae("Edit Item Name","",!1,d,!1,!1,{type:"integer",width:300,height:150},"Default").querySelector(".p-2");m.classList.add("p-4");const u=document.createElement("form");u.id="edit-name-form",u.className="flex flex-col space-y-4",m.appendChild(u);const f=document.createElement("input");f.type="text",f.name="newName",f.required=!0,f.value=c.name,f.id="rename-input",f.setAttribute("aria-label","Enter new file or folder name"),f.setAttribute("title","Type the new name for this item"),f.className="mt-1 block w-full border border-gray-300 rounded p-2",u.appendChild(bn("New Name",f));const g=document.createElement("div");g.className="flex justify-end space-x-2",u.appendChild(g);const w=me("Cancel"),b=me("Submit");w.id="cancel-edit-button",b.id="submit-edit-button",g.append(w,b),w.addEventListener("click",()=>le(d)),b.addEventListener("click",()=>Qe("submit-edit-button","Editing..."));const C=document.getElementById("edit-name-form");C.addEventListener("submit",function(_){_.preventDefault();const N=C.newName.value.trim();if(N&&N!==c.name){if(c.type==="folder"&&c.fullPath){let H=function(Z,X){if(a.folders[Z]){a.folders[X]=a.folders[Z],delete a.folders[Z];for(const S in a.folders[X]){const I=a.folders[X][S];if(I.type==="folder"&&I.fullPath&&I.fullPath.startsWith(Z)){const B=I.fullPath,D=I.fullPath.replace(Z,X);I.fullPath=D,a.folders[B]&&H(B,D)}}}};var j=H;const A=/^[A-Z]:\/\/$/;let M;A.test(r)?M=r+N:M=r+"/"+N;const O=c.fullPath;c.fullPath=M,H(O,M)}if(c.name=N,c.slug){const A=/^[A-Z]:\/\/$/;let M;A.test(r)?M=r+N:M=r+"/"+N,c.type!=="folder"&&(c.fullPath=M),gt(c.slug,M)}else if(c.type!=="folder"){const A=/^[A-Z]:\/\/$/;let M;A.test(r)?M=r+N:M=r+"/"+N,c.fullPath=M}r==="C://Desktop"?typeof he=="function"?he():console.error("renderDesktopIcons function not available"):typeof Ie=="function"?Ie(r):console.error("refreshAllExplorerWindows function not available"),setFileSystemState(a),Q().catch(A=>{console.error("Failed to save state after renaming:",A)}),setTimeout(()=>{r==="C://Desktop"&&typeof he=="function"?he():typeof Ie=="function"&&Ie(r)},100)}le(d)}),document.getElementById("cancel-edit-button").addEventListener("click",function(){le(d)})}function tl(e){e.stopPropagation(),Fe();const n=document.querySelector(".right-click-target");if(n&&n.classList.remove("right-click-target"),!n){ie("No file selected.","error");return}const t=n.getAttribute("data-item-id"),i=n.closest(".file-explorer-window"),o=i?i.getAttribute("data-current-path"):n.getAttribute("data-current-path");Ct(t,o)}function Lr(e,n){e.stopPropagation(),Fe();const t=n||"C://";so("Enter the name for the new folder:","New Folder",async i=>{(!i||!i.trim())&&(i="Untitled"),i=i.trim();let o=se();if(!o||!o.folders){console.error("File system state not properly initialized:",o),ie("File system not initialized. Please refresh the page.","error");return}const r="folder-"+Date.now(),a=/^[A-Z]:\/\/$/;let s=a.test(t)?t+i:t+"/"+i;const l={id:r,name:i,type:"folder",fullPath:s,contents:{}};let c;a.test(n)?(c=o.folders[n],c||(o.folders[n]={},c=o.folders[n])):n==="C://Desktop"?(o.folders["C://Desktop"]||(o.folders["C://Desktop"]={}),c=o.folders["C://Desktop"]):(c=o.folders[n],c||(console.warn("Parent folder contents not found, creating:",n),o.folders[n]={},c=o.folders[n])),c[r]=l,o.folders[s]={},await setFileSystemState(o);try{await Q(),n==="C://Desktop"?typeof he=="function"&&he():typeof Ie=="function"&&Ie(t)}catch(d){console.error("Failed to save state after creating folder:",d)}},()=>{})}function nl(e,n,t=null){e&&e.stopPropagation(),Fe();const i=n||"C://",o=`window-${Date.now()}`,a=ae("New File","",!1,o,!1,!1,{type:"integer",width:300,height:150},"Default").querySelector(".p-2");a.classList.add("p-4");const s=document.createElement("form");s.id="create-file-form",s.className="flex flex-col space-y-4",a.appendChild(s);const l=document.createElement("input");l.type="text",l.name="fileName",l.required=!0,l.value="New File.rtf",l.id="create-file-name",l.setAttribute("aria-label","Enter file name"),l.setAttribute("title","Enter the name for the new file"),l.className="mt-1 block w-full border border-gray-300 rounded p-2",s.appendChild(bn("File Name",l));const c=document.createElement("div");c.className="flex justify-end space-x-2",s.appendChild(c);const d=me("Cancel");d.id="cancel-file-button";const p=me("Submit");p.id="submit-file-button",c.append(d,p),d.addEventListener("click",m=>{m.preventDefault(),Qe("cancel-file-button","Cancelling..."),setTimeout(()=>le(o),100)}),s.addEventListener("submit",m=>{m.preventDefault(),Qe("submit-file-button","Submitting..."),setTimeout(()=>le(o),100);const u=l.value.trim()||"Untitled",f={id:`file-${Date.now()}`,name:u,type:"ugc-file",content:"",content_type:"markdown",icon_url:"image/doc.webp",description:""};zn(f,i)&&(n==="C://Desktop"?he():Ie(i),Q().catch(g=>{console.error("Failed to save state after creating file:",g)}),typeof t=="function"&&t(f.id,f))})}function ol(e,n){e.stopPropagation(),Fe();const t=`window-${Date.now()}`,o=ae("New Shortcut","",!1,t,!1,!1,{type:"integer",width:300,height:200},"Default").querySelector(".p-2");o.classList.add("p-4");const r=document.createElement("form");r.id="create-shortcut-form",r.className="flex flex-col space-y-4",o.appendChild(r);const a=document.createElement("input");a.type="text",a.name="shortcutName",a.placeholder="Example Website",a.id="shortcut-name",a.setAttribute("aria-label","Enter shortcut name"),a.setAttribute("title","Enter a display name for the shortcut"),a.className="mt-1 block w-full border border-gray-300 rounded p-2",r.appendChild(bn("Shortcut Name",a));const s=document.createElement("input");s.type="url",s.name="shortcutURL",s.required=!0,s.placeholder="https://example.com",s.id="shortcut-url",s.setAttribute("aria-label","Enter website URL"),s.setAttribute("title","Enter the full URL of the website"),s.className="mt-1 block w-full border border-gray-300 rounded p-2",r.appendChild(bn("Shortcut URL",s));const l=document.createElement("div");l.className="flex justify-end space-x-2";const c=me("Cancel");c.id="cancel-shortcut-button";const d=me("Submit");d.id="submit-shortcut-button",l.append(c,d),r.appendChild(l),c.addEventListener("click",()=>{e.preventDefault(),Qe("cancel-shortcut-button","Cancelling..."),setTimeout(()=>le(t),100)}),r.addEventListener("submit",async p=>{p.preventDefault(),Qe("submit-shortcut-button","Submitting..."),setTimeout(()=>le(t),100);const m=s.value.trim();if(!m)return;const u=a.value.trim()||m.replace(m.substring(15),"‚Ä¶"),f=`shortcut-${Date.now()}`;let g="https://www.google.com/s2/favicons?sz=64&domain=";try{g+=new URL(m).hostname}catch{g="image/doc.webp"}const w={id:f,name:u,type:"shortcut",url:m,icon_url:g,description:"",fullPath:n==="C://Desktop"?`C://Desktop/${u}`:`${n}/${u}`};if(!await zn(w,n)){console.error("Failed to save shortcut to filesystem");return}n==="C://Desktop"?setTimeout(async()=>{await he()},100):at(),Pe();try{await Q()}catch(C){console.error("Failed to save state after creating shortcut:",C)}})}async function il(e,n,t=null){e&&e.stopPropagation(),Fe();const i=n||"C://";so("Enter the name for the new LetterPad document:","New LetterPad.md",async o=>{(!o||!o.trim())&&(o="New LetterPad.md"),o=o.trim(),o.endsWith(".md")||(o=o+".md");const r=`file-${Date.now()}`,a="",s={id:r,name:o,type:"ugc-file",content:a,content_type:"markdown",icon_url:"image/doc.webp"};if(await zn(s,i)){try{await Q()}catch(l){console.error("Failed to save state after creating LetterPad:",l)}n==="C://Desktop"?he():Ie(i),ae(o,`<div class="letterpad_editor min-h-48 h-full w-full" data-letterpad-editor-id="${r}"></div>`,!1,r,!1,!1,{type:"integer",width:600,height:500},"editor"),setTimeout(()=>{const l=`letterpad_${r}`;z.setItemSync(l,{content:a});const c=document.querySelector(`[data-letterpad-editor-id="${r}"]`);c&&typeof pt=="function"&&pt(c)},100),typeof t=="function"&&t(s.id,s)}},()=>{})}function rl(e,n,t=null){e&&e.stopPropagation(),Fe();const i=n||"C://",o=document.createElement("input");o.type="file",o.accept="image/*",o.setAttribute("aria-label","Select image file to upload"),o.setAttribute("title","Choose an image file from your computer"),o.style.display="none",o.addEventListener("change",async r=>{const a=r.target.files[0];if(a){const l=a.size/1048576;if(l>25){ie(`Image file "${a.name}" is too large (${l.toFixed(2)}MB). Maximum allowed size is 25MB.`,"error"),document.body.removeChild(o);return}const c=a.name.split(".").pop().toLowerCase(),d=await Io(a.name,i,c,a);d&&typeof t=="function"&&t(d.id,d),n==="C://Desktop"?typeof he=="function"&&he():typeof Ie=="function"&&Ie(i)}document.body.removeChild(o)}),document.body.appendChild(o),o.click()}function al(e,n,t=null){e&&e.stopPropagation(),Fe();const i=n||"C://",o=document.createElement("input");o.type="file",o.accept="audio/*",o.style.display="none",o.setAttribute("aria-label","Select audio file to upload"),o.setAttribute("title","Choose an audio file from your computer"),o.addEventListener("change",async r=>{const a=r.target.files[0];if(a){const l=a.size/1048576;if(l>50){ie(`Audio file "${a.name}" is too large (${l.toFixed(2)}MB). Maximum allowed size is 50MB.`,"error"),document.body.removeChild(o);return}const c=a.name.split(".").pop().toLowerCase(),d=await Io(a.name,i,c,a);d&&typeof t=="function"&&t(d.id,d),n==="C://Desktop"?typeof he=="function"&&he():typeof Ie=="function"&&Ie(i)}document.body.removeChild(o)}),document.body.appendChild(o),o.click()}function sl(e,n,t=null){e&&e.stopPropagation(),Fe();const i=n||"C://",o=document.createElement("input");o.type="file",o.accept="video/*",o.style.display="none",o.setAttribute("aria-label","Select video file to upload"),o.setAttribute("title","Choose a video file from your computer"),o.addEventListener("change",async r=>{const a=r.target.files[0];if(a){const l=a.size/1048576;if(l>100){ie(`Video file "${a.name}" is too large (${l.toFixed(2)}MB). Maximum allowed size is 100MB.`,"error"),document.body.removeChild(o);return}const c=a.name.split(".").pop().toLowerCase(),d=await Io(a.name,i,c,a);d&&typeof t=="function"&&t(d.id,d),n==="C://Desktop"?typeof he=="function"&&he():typeof Ie=="function"&&Ie(i)}document.body.removeChild(o)}),document.body.appendChild(o),o.click()}function bn(e,n){const t=document.createElement("div"),i=document.createElement("label");return i.className="block text-sm font-medium text-gray-700",i.textContent=e,t.append(i,n),t}function Ie(e){const n=document.querySelectorAll(".file-explorer-window");let t=0;n.forEach((i,o)=>{if(i.getAttribute("data-current-path")===e)try{const a=st(e),s=document.createElement("div");s.innerHTML=a;const l=s.querySelector(".file-explorer-window");if(l){i.innerHTML=l.innerHTML,i.setAttribute("data-current-path",e);const c=i.closest(".window");c&&c.id&&it(c.id,a),t++}else console.warn(`Failed to get new explorer content for window ${o}`)}catch(a){console.error(`Error refreshing window ${o}:`,a)}}),setTimeout(()=>{typeof Pe=="function"&&Pe()},50)}window.refreshAllExplorerWindows=Ie;async function zn(e,n){const t=se();if(!t||!t.folders)return console.error("File system state not properly initialized:",t),ie("File system not initialized. Please refresh the page.","error"),!1;let i=t.folders[n];return i||(console.warn("Parent folder contents not found, creating:",n),t.folders[n]={},i=t.folders[n]),i[e.id]=e,await setFileSystemState(t),se().folders[n],!0}async function Io(e,n,t,i){const o=`file-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;let r="image/file.webp";["png","jpg","jpeg","gif","webp","avif"].includes(t)?r="image/image.webp":["mp4","webm","avi","mov"].includes(t)?r="image/video.webp":["mp3","wav","ogg"].includes(t)&&(r="image/audio.webp");const a={id:o,name:e,type:"ugc-file",content_type:t,icon_url:r,content:"",isLargeFile:!0,storageLocation:"indexeddb",file:null};if(!zn(a,n))return null;if(i&&["png","jpg","jpeg","gif","webp","avif","mp3","wav","ogg","mp4","webm","avi","mov"].includes(t)){const s=URL.createObjectURL(i),l=se(),c=l.folders[n];c&&c[o]&&(c[o].tempObjectURL=s,c[o].file=i,setFileSystemState(l));try{const d=await new Promise((f,g)=>{const w=new FileReader;w.onload=b=>f(b.target.result),w.onerror=g,w.readAsDataURL(i)}),p=d.length*.75/(1024*1024);await z.setItem(`file_data_${o}`,d);const m=se(),u=m.folders[n];u&&u[o]&&(u[o].isLargeFile=!0,u[o].storageLocation="indexeddb",u[o].content="",u[o].fileSizeInMB=p,u[o].actualSizeInMB=p,u[o].dataURL=d,u[o].file=null),setFileSystemState(m),await Q(),n==="C://Media"&&["mp3","wav","ogg","mp4","webm","avi","mov"].includes(t)&&typeof window.refreshMediaPlayerPlaylist=="function"&&setTimeout(()=>{window.refreshMediaPlayerPlaylist()},200)}catch(d){console.error("Failed to store binary file:",d);const p=se(),m=p.folders[n];m&&m[o]&&(m[o].isLargeFile=!0,m[o].storageLocation="failed",setFileSystemState(p)),ie(`File "${e}" could not be stored. Storage error: ${d.message}`,"error")}}else await Q();return a}async function ll(){const e=window.location.href.includes("reddit.com");let n="1.0.0";try{n=(await(await fetch("./package.json")).json()).version||"1.0.0"}catch(i){console.warn("Could not fetch version from package.json:",i)}const t=`
    <div class="p-4 gap-y-2 flex flex-col">
      <img src="./image/logo.webp" class="w-48 h-auto mx-auto mb-4" alt="Nostalgia OS startup logo">
      <h1 class="text-xl font-bold mb-2">About This Computer</h1>
      <p>Made by multimedia artist Ian McKenzie.</p>
      <p>More shenanigans @ ${e?"relentlesscurious.com":'<a href="https://www.relentlesscurious.com" target="_blank">relentlesscurious.com</a>'}</p>
      <p>Version: ${n}</p>
      <p>Copyright ¬© Ian Rand McKenzie, 2025</p>
      <p>This project must be purchased for use, but is open source and free for non-commercial use for those who contribute via code, security research, bug reporting, etc. ‚Äî contributors may do so on <a target="_blank" href="https://github.com/ianrandmckenzie/nostalgia_os">github.com/ianrandmckenzie/nostalgia_os</a></p>
    </div>
  `;ae("About This Computer",t,!1,null,!1,!1,{type:"integer",width:400,height:640},"default",null,"gray-200")}const Mr=`
<div class="max-w-4xl mx-auto text-black font-mono bg-gray-50 p-6 h-full overflow-auto">
  <h1 class="text-3xl font-bold text-black mb-6">Security Policy</h1>

  <div class="bg-gray-100 rounded-lg p-4 mb-6 border border-gray-700">
    <p class="text-lg text-black mb-4">
      At relentlessCurious, we take security seriously. This policy outlines our commitment to maintaining a secure environment for our users and provides guidelines for responsible disclosure of security vulnerabilities.
    </p>
  </div>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Reporting Security Vulnerabilities</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black mb-3">
        If you discover a security vulnerability in our systems, please report it responsibly by contacting our developer, Ian, at:
      </p>
      <div class="bg-gray-200 rounded p-3 border border-gray-600 mb-3">
        <p class="text-black font-mono">hey@relentlesscurious.com</p>
      </div>
      <p class="text-black mb-3">
        Please include the following information in your report:
      </p>
      <ul class="list-disc list-inside text-black space-y-1 ml-4">
        <li>Description of the vulnerability</li>
        <li>Steps to reproduce the issue</li>
        <li>Potential impact assessment</li>
        <li>Suggested remediation (if applicable)</li>
        <li>Your contact information for follow-up</li>
      </ul>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Response Timeline</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="bg-gray-200 rounded p-3 border border-gray-600">
          <h3 class="text-lg font-semibold text-black mb-2">Initial Response</h3>
          <p class="text-black">Within 48 hours of receiving your report</p>
        </div>
        <div class="bg-gray-200 rounded p-3 border border-gray-600">
          <h3 class="text-lg font-semibold text-black mb-2">Investigation</h3>
          <p class="text-black">Within 7 days for initial assessment</p>
        </div>
        <div class="bg-gray-200 rounded p-3 border border-gray-600">
          <h3 class="text-lg font-semibold text-black mb-2">Resolution</h3>
          <p class="text-black">Timeline varies based on severity</p>
        </div>
        <div class="bg-gray-200 rounded p-3 border border-gray-600">
          <h3 class="text-lg font-semibold text-black mb-2">Disclosure</h3>
          <p class="text-black">After fix is deployed and verified</p>
        </div>
      </div>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Scope</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <h3 class="text-lg font-semibold text-black mb-2">In Scope</h3>
      <ul class="list-disc list-inside text-black space-y-1 mb-3 ml-4">
        <li>relentlessCurious.com and all subdomains</li>
        <li>Web applications and APIs</li>
        <li>Smart contracts (when deployed)</li>
        <li>Infrastructure vulnerabilities</li>
        <li>Social engineering vulnerabilities</li>
      </ul>

      <h3 class="text-lg font-semibold text-black mb-2">Out of Scope</h3>
      <ul class="list-disc list-inside text-black space-y-1 ml-4">
        <li>Third-party services we don't control</li>
        <li>Social media accounts</li>
        <li>Physical security issues</li>
        <li>Denial of Service (DoS) attacks</li>
        <li>Spam or social engineering attacks</li>
      </ul>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Responsible Disclosure Guidelines</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black mb-3">We ask that security researchers:</p>
      <ul class="list-disc list-inside text-black space-y-1 ml-4">
        <li>Allow us reasonable time to investigate and address the issue before public disclosure</li>
        <li>Avoid accessing, modifying, or deleting user data</li>
        <li>Do not perform testing that could degrade or damage our systems</li>
        <li>Do not use social engineering, phishing, or physical attacks</li>
        <li>Make a good faith effort to avoid privacy violations and data destruction</li>
        <li>Contact us immediately if you inadvertently access sensitive data</li>
      </ul>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Security Measures</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black mb-3">Our security implementation includes:</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="space-y-2">
          <h3 class="text-lg font-semibold text-black">Web Security</h3>
          <ul class="list-disc list-inside text-black text-sm space-y-1 ml-4">
            <li>Content Security Policy (CSP)</li>
            <li>HTTP Strict Transport Security (HSTS)</li>
            <li>Input validation and sanitization</li>
          </ul>
        </div>
        <div class="space-y-2">
          <h3 class="text-lg font-semibold text-black">Data Protection</h3>
          <ul class="list-disc list-inside text-black text-sm space-y-1 ml-4">
            <li>Encryption in transit and at rest</li>
            <li>Regular security audits</li>
            <li>Access controls and monitoring</li>
            <li>Secure development practices</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Recognition</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black mb-3">
        We appreciate the security research community's efforts in keeping our platform secure. Researchers who responsibly disclose valid security vulnerabilities may be:
      </p>
      <ul class="list-disc list-inside text-black space-y-1 ml-4">
        <li>Acknowledged in our security advisory (with permission)</li>
        <li>Listed in our hall of fame</li>
        <li>Considered for our bug bounty program (when available)</li>
      </ul>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Legal Safe Harbor</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black">
        relentlessCurious will not pursue legal action against security researchers who:
      </p>
      <ul class="list-disc list-inside text-black space-y-1 mt-3 ml-4">
        <li>Follow our responsible disclosure policy</li>
        <li>Report vulnerabilities in good faith</li>
        <li>Do not violate any applicable laws</li>
        <li>Do not access, modify, or delete user data</li>
        <li>Do not disrupt our services</li>
      </ul>
    </div>
  </section>

  <footer class="mt-8 pt-6 border-t border-gray-700">
    <div class="text-center">
      <p class="text-black text-sm">
        Last updated: July 15, 2025
      </p>
      <p class="text-black text-sm mt-2">
        This policy is subject to change. Check back regularly for updates.
      </p>
    </div>
  </footer>
</div>
`,cl={"/security-policy":{title:"Security Policy",content:Mr,icon:"image/info.webp"}};function dl(){Tn("Security Policy",Mr,{type:"integer",width:800,height:600},"default")}function Lo(e){const n=cl[e];return n?(Tn(n.title,n.content,{type:"integer",width:800,height:600},"default"),!0):!1}function Ar(){const e=window.location.pathname;e==="/security-policy"&&setTimeout(()=>{Lo(e),window.history.replaceState({},"","/")},500)}window.addEventListener("popstate",function(e){const n=window.location.pathname;Lo(n)||console.log("No route found for:",n)});const ul=1180,pl=820;let bt,rn;function fl(){document.addEventListener("touchstart",e=>{var d;const n=e.target.closest(".cursor-move");if(!n)return;const t=n.closest("#windows-container > div");if(!t)return;const i=(d=window.windowStates)==null?void 0:d[t.id];if(i!=null&&i.fullScreen||e.touches.length!==1)return;const o=e.touches[0],r=t.getBoundingClientRect(),a=o.clientX-r.left,s=o.clientY-r.top;function l(p){if(p.touches.length!==1)return;const m=p.touches[0],u=bt?bt.scrollLeft:0,f=bt?bt.scrollTop:0;t.style.left=m.clientX+u-a+"px",t.style.top=m.clientY+f-s+"px",p.preventDefault()}function c(p){var u;window.removeEventListener("touchmove",l,{passive:!1}),window.removeEventListener("touchend",c);const m=(u=window.windowStates)==null?void 0:u[t.id];m&&(m.position={left:t.style.left,top:t.style.top},window.saveState&&window.saveState())}window.addEventListener("touchmove",l,{passive:!1}),window.addEventListener("touchend",c,{passive:!1})},{passive:!0})}function Dr(){bt=document.getElementById("desktop-stage"),rn=document.getElementById("windows-container"),!(!bt||!rn)&&(rn.style.minWidth=ul+"px",rn.style.minHeight=pl+"px",fl())}typeof window<"u"&&(window.initializeDesktopPan=Dr);async function ml(){const e=await z.getItem("appState"),t=`
    <div class="flex flex-col h-full p-4">
      <h2 class="text-lg font-bold mb-2">Developer Data Export</h2>
      <p class="mb-2 text-sm">Copy this JSON to create a default data set.</p>
      <textarea id="dev-data-export" class="flex-1 w-full p-2 border border-gray-400 font-mono text-xs mb-4" readonly>${JSON.stringify(e,null,2)}</textarea>
      <div class="flex justify-end space-x-2">
        <button id="copy-dev-data" class="px-4 py-2 bg-gray-200 border-2 border-gray-400 hover:bg-gray-300 active:border-gray-600">Copy to Clipboard</button>
        <button id="close-dev-data" class="px-4 py-2 bg-gray-200 border-2 border-gray-400 hover:bg-gray-300 active:border-gray-600">Close</button>
      </div>
    </div>
  `,i="dev-data-modal";ae("Developer Data",t,!1,i,!1,!0,{width:600,height:500}),setTimeout(()=>{const o=document.getElementById("copy-dev-data"),r=document.getElementById("close-dev-data"),a=document.getElementById("dev-data-export");o&&a&&o.addEventListener("click",()=>{a.select(),document.execCommand("copy"),o.textContent="Copied!",setTimeout(()=>o.textContent="Copy to Clipboard",2e3)}),r&&r.addEventListener("click",()=>{const s=document.getElementById(i);if(s)if(window.closeWindow)window.closeWindow(i);else{s.remove();const l=document.getElementById(`taskbar-${i}`);l&&l.remove()}})},100)}typeof window<"u"&&(window.showDevDataModal=ml);window.isDevvit=!1;const pn="1.0";lr();async function gl(){var n;await((n=z.ensureReady)==null?void 0:n.call(z))||Promise.resolve();let e=await z.getItem("version");if(e||await z.setItem("version",pn),e!==pn){const t=await z.getItem("explicitRestart");await z.removeItem("appState"),await z.removeItem("version"),await z.setItem("version",pn),t&&await z.setItem("explicitRestart",t)}}typeof window<"u"&&(window.version=pn,window.highestZ=Se,window.activeMediaWindow=kt,window.windowStates=J,window.desktopIconsState=fe,window.navWindows=Oe,window.desktopSettings=be,window.startMenuOrder=xt,window.fileFolderMapping=ri,window.createWindow=ae,window.minimizeWindow=Je,window.bringToFront=ke,window.closeWindow=le,window.toggleFullScreen=Et,window.showDialogBox=ie,window.getAppIcon=io,window.renderDesktopIcons=he,window.makeIconDraggable=Sn,window.toggleStartMenu=Tt,window.minimizeAllWindows=Bn,window.openNav=Tn,window.updateClock=Fn,window.toggleMediaPlayback=Pn,window.updateMediaControl=Co,window.getActiveMediaElement=$n,window.openApp=qt,window.openExplorer=Kt,window.openExplorerInNewWindow=wt,window.refreshExplorerViews=at,window.getExplorerWindowContent=st,window.getBreadcrumbsHtml=mi,window.openFile=_t,window.normalizePath=sn,window.getFolderIdByFullPath=Qr,window.findFolderObjectByFullPath=fi,window.findFolderFullPathById=wn,window.showContextMenu=Ir,window.hideContextMenu=Fe,window.createNewFolder=Lr,window.createNewFile=nl,window.refreshAllExplorerWindows=Ie,window.saveFileExplorerState=St,window.handleWatercolourImageSelection=ea,window.launchCompostBin=wi,window.loadCompostBinContents=Xt,window.emptyCompostBin=vi,window.launchStorageManager=ur,window.refreshStorageData=Jt,window.fullSystemRestart=mr,window.openCleanupWindow=pr,window.makeWin95Dropdown=gs,window.openAboutWindow=ll,window.launchCalculator=Di,window.initializeCalculatorUI=Bi,window.launchSolitaire=Ti,window.initializeSolitaireUI=Fi,window.launchChess=Pi,window.initializeChessUI=$i,window.launchBombbroomer=Gi,window.initializeBombbroomerUI=Ki,window.launchHappyTurd=nr,window.initializeHappyTurdUI=wo,window.launchPong=er,window.initializePongUI=yo,window.launchSnake=tr,window.initializeSnakeUI=bo,window.initializeLetterPad=pt,window.initializeAllLetterPadEditors=Cr,window.applyFormatting=no,window.convertMarkdownToHTML=un,window.launchMailbox=Ei,window.launchWatercolour=Ii,window.initializeWatercolourUI=Li,window.getWatercolourHTML=Mi,window.initializeWatercolour=Ai,window.launchTubeStream=Si,window.launchMediaPlayer=Xi,window.initializeMediaPlayerUI=Vi,window.restoreMediaPlayerSession=Zi,window.saveMediaPlayerState=Ve,window.loadMediaPlayerState=go,window.clearMediaPlayerState=Ua,window.initializeRouter=Ar,window.handleRoute=Lo,window.openSecurityPolicy=dl,window.restart=cr,window.logout=dr,window.storage=z);document.getElementById("desktop").addEventListener("click",function(e){e.target.closest(".draggable-icon")||document.querySelectorAll(".draggable-icon").forEach(n=>n.classList.remove("bg-gray-50"))});function hl(){const e=document.getElementById("media-control");e&&e.addEventListener("keydown",function(i){(i.key==="Enter"||i.key===" ")&&(i.preventDefault(),Pn())});const n=document.getElementById("start-button");n&&n.addEventListener("keydown",function(i){(i.key==="Enter"||i.key===" ")&&(i.preventDefault(),Tt())});const t=document.getElementById("min-all-btn");t&&t.addEventListener("keydown",function(i){(i.key==="Enter"||i.key===" ")&&(i.preventDefault(),Bn())}),document.addEventListener("keydown",function(i){if(i.key==="Escape"){const o=document.getElementById("start-menu"),r=document.getElementById("context-menu");if(o&&!o.classList.contains("hidden")){document.getElementById("start-button").setAttribute("aria-expanded","false"),o.classList.add("hidden"),o.setAttribute("aria-hidden","true");const{toggleButtonActiveState:s}=window;s&&s("start-button")}r&&!r.classList.contains("hidden")&&(r.classList.add("hidden"),r.setAttribute("aria-hidden","true"))}})}window.addEventListener("click",async function(e){const n=document.getElementById("start-menu"),t=document.getElementById("start-button");if(!n.contains(e.target)&&!t.contains(e.target)){if(!n.classList.contains("hidden")){const{toggleButtonActiveState:i}=await an(async()=>{const{toggleButtonActiveState:o}=await Promise.resolve().then(()=>bi);return{toggleButtonActiveState:o}},void 0);i("start-button")}n.classList.add("hidden"),n.setAttribute("aria-hidden","true"),t.setAttribute("aria-expanded","false")}});window.addEventListener("load",async function(){await gl();const{toggleButtonActiveState:e,makeWin95Button:n,makeWin95Prompt:t,openFileExplorerForImageSelection:i}=await an(async()=>{const{toggleButtonActiveState:l,makeWin95Button:c,makeWin95Prompt:d,openFileExplorerForImageSelection:p}=await Promise.resolve().then(()=>bi);return{toggleButtonActiveState:l,makeWin95Button:c,makeWin95Prompt:d,openFileExplorerForImageSelection:p}},void 0);window.toggleButtonActiveState=e,window.makeWin95Button=n,window.makeWin95Prompt=t,window.openFileExplorerForImageSelection=i;const o=await z.getItem("appState"),r=await z.getItem("explicitRestart");(!o||r)&&(Mn(),r&&await z.removeItem("explicitRestart")),await Qn(),await Ss(),await he(),await Cs();const{getAutoOpenApps:a}=await an(async()=>{const{getAutoOpenApps:l}=await Promise.resolve().then(()=>Za);return{getAutoOpenApps:l}},void 0),s=a();if(s&&s.length>0&&(console.log(`Opening ${s.length} custom app(s) on page load`),setTimeout(()=>{s.forEach(l=>{console.log(`Auto-opening: ${l}`),qt(l)})},500)),Dr(),di(),typeof yn=="function"){await yn();const{updateStartMenuFocusability:l}=await an(async()=>{const{updateStartMenuFocusability:d}=await Promise.resolve().then(()=>Qs);return{updateStartMenuFocusability:d}},void 0);window.updateStartMenuFocusability=l;const c=document.getElementById("start-menu");c&&c.classList.contains("hidden")&&l(!1)}else console.error("initializeStartMenu function not available");Ar(),hl(),document.querySelectorAll(".draggable-icon").forEach(l=>Sn(l))});document.addEventListener("keydown",function(e){if(e.altKey)switch(e.key){case"Tab":e.preventDefault(),Zn();break;case"F4":e.preventDefault(),No();break}if(e.key==="Escape"&&Lt(),e.key==="Enter"&&document.getElementById("window-cycle-popup")&&!document.getElementById("window-cycle-popup").classList.contains("hidden")&&(e.preventDefault(),Lt()),e.ctrlKey)switch(e.key){case"w":e.preventDefault(),No();break;case"m":e.preventDefault(),Kr();break}});document.addEventListener("keyup",function(e){if(e.key==="Alt"){const n=document.getElementById("window-cycle-popup");n&&!n.classList.contains("hidden")&&Lt()}});Sr();
