(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const gr="modulepreload",yr=function(e){return"/"+e},Eo={},$n=function(n,t,o){let i=Promise.resolve();if(t&&t.length>0){let a=function(d){return Promise.all(d.map(c=>Promise.resolve(c).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),l=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));i=a(t.map(d=>{if(d=yr(d),d in Eo)return;Eo[d]=!0;const c=d.endsWith(".css"),m=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${m}`))return;const u=document.createElement("link");if(u.rel=c?"stylesheet":gr,c||(u.as="script"),u.crossOrigin="",u.href=d,l&&u.setAttribute("nonce",l),document.head.appendChild(u),c)return new Promise((f,p)=>{u.addEventListener("load",f),u.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${d}`)))})}))}function r(a){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=a,window.dispatchEvent(s),!s.defaultPrevented)throw a}return i.then(a=>{for(const s of a||[])s.status==="rejected"&&r(s.reason);return n().catch(r)})},ln={development:{API_BASE_URL:"http://abc.localhost:3000/",SUGGESTIONS_LIST_PATH:"end_data/public/ananan",SUGGESTIONS_SUBMISSIONS_PATH:"end_data/public/kfjbwef",TUBE_STREAMS_PATH:"tube-streams.json"},production:{API_BASE_URL:"https://backend.failureunit.tv/",SUGGESTIONS_LIST_PATH:"end_data/public/suggestions",SUGGESTIONS_SUBMISSIONS_PATH:"end_data/public/submit-suggestion",TUBE_STREAMS_PATH:"tube-streams.json"},trusted_providers:[{domains:["s3.ca-central-1.amazonaws.com","www.failureunit.tv"],dev_domains:["localhost","*.localhost","abc.localhost:3000"],types:["img","audio","video"]},{domains:["backend.failureunit.tv"],dev_domains:["abc.localhost:3000"],types:["connect"]},{domains:["i.ytimg.com","img.youtube.com"],dev_domains:[],types:["img"]},{domains:["www.youtube.com"],dev_domains:[],types:["frame"]}],db_name:"FailureUnitTV",site_name:"FU TV",branding_images:"custom_branding",disable_devvit:!0},hr=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.hostname==="0.0.0.0",cn=hr?"development":"production",Dt=ln[cn].API_BASE_URL,Yo=ln[cn].SUGGESTIONS_LIST_PATH,br=ln[cn].SUGGESTIONS_SUBMISSIONS_PATH,Go=ln[cn].TUBE_STREAMS_PATH;class wr{constructor(n="NostalgiaOS",t=1){this.dbName=n,this.version=t,this.db=null,this.cache=new Map,this.initPromise=this.init()}async init(){return new Promise((n,t)=>{const o=indexedDB.open(this.dbName,this.version);o.onerror=()=>{console.error("IndexedDB error:",o.error),t(o.error)},o.onsuccess=async()=>{this.db=o.result,await this.populateCache(),n(this.db)},o.onupgradeneeded=i=>{const r=i.target.result;r.objectStoreNames.contains("storage")||r.createObjectStore("storage",{keyPath:"key"})}})}async populateCache(){try{if(!this.db)return;const t=this.db.transaction(["storage"],"readonly").objectStore("storage");return new Promise((o,i)=>{const r=t.getAll();r.onsuccess=()=>{r.result.forEach(s=>{this.cache.set(s.key,s.value)}),o()},r.onerror=()=>{console.warn("Failed to populate cache:",r.error),i(r.error)}})}catch(n){console.warn("Failed to populate cache:",n)}}async ensureDB(){return this.db||await this.initPromise,this.db}async setItem(n,t){const r=(await this.ensureDB()).transaction(["storage"],"readwrite").objectStore("storage"),a={key:n,value:t,timestamp:Date.now()};return this.cache.set(n,t),new Promise((s,l)=>{const d=r.put(a);d.onsuccess=()=>s(),d.onerror=()=>l(d.error)})}async getItem(n){const i=(await this.ensureDB()).transaction(["storage"],"readonly").objectStore("storage");return new Promise((r,a)=>{const s=i.get(n);s.onsuccess=()=>{const l=s.result;let d=l?l.value:null;this.cache.set(n,d),r(d)},s.onerror=()=>a(s.error)})}async removeItem(n){const i=(await this.ensureDB()).transaction(["storage"],"readwrite").objectStore("storage");return this.cache.delete(n),new Promise((r,a)=>{const s=i.delete(n);s.onsuccess=()=>r(),s.onerror=()=>a(s.error)})}async clear(){const o=(await this.ensureDB()).transaction(["storage"],"readwrite").objectStore("storage");return this.cache.clear(),new Promise((i,r)=>{const a=o.clear();a.onsuccess=()=>i(),a.onerror=()=>r(a.error)})}async getAllKeys(){const o=(await this.ensureDB()).transaction(["storage"],"readonly").objectStore("storage");return new Promise((i,r)=>{const a=o.getAllKeys();a.onsuccess=()=>i(a.result),a.onerror=()=>r(a.error)})}setItemSync(n,t){this.cache.set(n,t),this.setItemWithRetry(n,t,3).catch(o=>{console.warn("Failed to save to IndexedDB after retries:",o)})}async setItemWithRetry(n,t,o=3){let i;for(let r=0;r<o;r++)try{await this.setItem(n,t);return}catch(a){i=a,console.warn(`setItem retry ${r+1}/${o} failed:`,a),r<o-1&&await new Promise(s=>setTimeout(s,Math.pow(2,r)*100))}throw i}getItemSync(n){return this.cache.has(n)?this.cache.get(n):(this.getItem(n).catch(console.warn),null)}removeItemSync(n){this.cache.delete(n),this.removeItem(n).catch(console.error)}clearSync(){this.cache.clear(),this.clear().catch(console.error)}}const ze=new wr,B={async ensureReady(){return await ze.ensureDB(),ze.cache.size===0&&await ze.populateCache(),ze.db},async setItem(e,n){return await ze.setItem(e,n)},async getItem(e){return await ze.getItem(e)},async removeItem(e){return await ze.removeItem(e)},async clear(){return await ze.clear()},async getAllKeys(){return await ze.getAllKeys()},async preloadKeys(e){for(const n of e)try{await this.getItem(n)}catch(t){console.warn(`Failed to preload key ${n}:`,t)}},setItemSync(e,n){return ze.setItemSync(e,n)},getItemSync(e){return ze.getItemSync(e)},removeItemSync(e){return ze.removeItemSync(e)},clearSync(){return ze.clearSync()}};typeof window<"u"&&(window.globalStorage=B,window.storage=B);function vr(e,n=[],t=[]){const o=document.createElement("div");return o.innerHTML=e,o.querySelectorAll("*").forEach(r=>{if(!n.includes(r.tagName.toLowerCase())){r.remove();return}[...r.attributes].forEach(s=>{t.includes(s.name.toLowerCase())||r.removeAttribute(s.name)})}),o.innerHTML}async function xr(){try{const e=await B.getItem("appState");if(e&&e.fileSystemState)return e.fileSystemState}catch(e){console.warn("Failed to get file system state from IndexedDB:",e);try{const n=B.getItemSync("appState");if(n&&n.fileSystemState)return n.fileSystemState}catch(n){console.warn("Failed to get file system state with fallback:",n)}}return fileSystemState}async function Pn(e){e.folders&&Object.keys(e.folders).forEach(n=>{const t=e.folders[n];t&&typeof t=="object"&&Object.keys(t).filter(o=>{const i=t[o];return i&&i.type==="shortcut"})});try{const n=await B.getItem("appState")||{};n.fileSystemState=e,await B.setItem("appState",n),fileSystemState=e}catch(n){console.warn("Failed to set file system state in IndexedDB:",n);try{const t=B.getItemSync("appState")||{};t.fileSystemState=e,B.setItemSync("appState",t),fileSystemState=e}catch(t){console.error("Failed to set file system state with fallback:",t)}}}function ce(){try{const e=B.getItemSync("appState");if(e&&e.fileSystemState){const n=e.fileSystemState;return["C://","C://Desktop","C://Documents"].forEach(t=>{n.folders&&n.folders[t]&&Object.keys(n.folders[t]).filter(r=>{const a=n.folders[t][r];return a&&a.type==="shortcut"}).length>0}),n}}catch(e){console.warn("Failed to get file system state sync:",e)}return typeof window<"u"&&window.fileSystemState?window.fileSystemState:typeof fileSystemState<"u"?fileSystemState:(console.error("No file system state available anywhere!"),{folders:{"C://":{},"A://":{},"D://":{}}})}function Vn(e){e=normalizePath(e);const n=ce();if(n.initialized!==!0&&Sr(),e.substring(1,4)==="://"&&e.length===4)return n.folders[e]||{};const t=n.folders[e]||{},o={};for(const[i,r]of Object.entries(t))i!=="contents"&&r&&typeof r=="object"&&r.type&&(o[i]=r);return o}const kr={files:[]};function Sr(){try{const e=ce();if(!e.folders||!e.folders["C://"]){console.warn("File system structure not properly initialized for sync document fetch");return}const n=kr.files.map(o=>{const i=o.url.split(".").pop().toLowerCase();let r="image/file.webp";return["png","jpg","jpeg","gif"].includes(i)?r="image/image.webp":["mp4","webm"].includes(i)?r="image/video.webp":["mp3","wav"].includes(i)?r="image/audio.webp":i==="html"?r="image/html.webp":["md","txt"].includes(i)&&(r="image/doc.webp"),{id:o.id,name:o.url,type:"file",content:"",fullPath:`C://Documents/${o.id}`,content_type:i,icon_url:r,url:o.url}});e.folders["C://Documents"]||(e.folders["C://Documents"]={});const t={};n.forEach(o=>{t[o.id]=o}),e.folders["C://Documents"]={...e.folders["C://Documents"]||{},...t},e.initialized=!0;try{const o=B.getItemSync("appState")||{};o.fileSystemState=e,B.setItemSync("appState",o),fileSystemState=e}catch(o){console.warn("Failed to save file system state sync:",o),fileSystemState=e}}catch(e){console.error("Error loading documents sync:",e)}}document.addEventListener("dblclick",e=>{const n=e.target.closest("[data-open-file]");if(n){e.stopPropagation();const t=n.getAttribute("data-open-file");openFile(t,e)}});document.addEventListener("mobiledbltap",e=>{const n=e.target.closest("[data-open-file]");if(n){e.stopPropagation();const t=n.getAttribute("data-open-file");openFile(t,e)}});function jt(e){return/^[A-Z]:\/\/$/.test(e)?e:e.replace(/\/+$/,"")}function Er(e){if(/^[A-Z]:\/\/$/.test(e))return e;const n=ce();function t(o){for(const i in o){const r=o[i];if(r.type==="folder"){if(r.fullPath===e)return i;const a=n.folders[r.fullPath]||{},s=t(a);if(s)return s}}return null}for(const o in n.folders)if(/^[A-Z]:\/\/$/.test(o)){const i=t(n.folders[o]);if(i)return i}return null}function Ko(e,n=null){e=jt(e);const t=n||ce();if(/^[A-Z]:\/\/$/.test(e))return{id:e,name:e,fullPath:e,contents:t.folders[e]};function o(){for(const i in t.folders)if(/^[A-Z]:\/\/$/.test(i))for(const r in t.folders[i]){const a=t.folders[i][r];if(a.type==="folder"&&jt(a.fullPath)===e)return a}else for(const r in t.folders[i]){const a=t.folders[i][r];if(a.type==="folder"&&jt(a.fullPath)===e)return a}return null}return o()}function dn(e,n=!1){if(/^[A-Z]:\/\/$/.test(e))return e;const t=ce();function o(i,r=null){for(const a in i){const s=i[a];if(s.type==="folder"||n===!0){if(a===e)return s.fullPath;if(s.type==="folder"&&s.fullPath&&t.folders[s.fullPath]){const l=o(t.folders[s.fullPath],s.fullPath);if(l)return l}}}return null}for(const i in t.folders)if(/^[A-Z]:\/\/$/.test(i)){const r=o(t.folders[i],i);if(r)return r}return null}function Pt(e,n=!1){let t;if(/^[A-Z]:\/\//.test(e)?t=e:t=dn(e),!t){console.error("Folder not found for id/path:",e);return}const o=et(t);if(!n){let a=document.getElementById("explorer-window");if(a)return a.querySelector(".file-explorer-window").outerHTML=o,a.querySelector(".file-explorer-window").setAttribute("data-current-path",t),Je(a.id,o),setTimeout(Pe,100),setTimeout(async()=>{await ut()},150),a}const i=n?`explorer-window-${Date.now()}`:"explorer-window",r=se(t,o,!1,i,!1,!1,{type:"integer",width:600,height:400},"Explorer");return setTimeout(async()=>{await ut()},150),r}function dt(e){const n=`openExplorer_${e}`,t=Date.now();if(window.explorerDebounce&&window.explorerDebounce[n]){const o=window.explorerDebounce[n];if(t-o<500)return}return window.explorerDebounce||(window.explorerDebounce={}),window.explorerDebounce[n]=t,setTimeout(()=>{window.explorerDebounce&&window.explorerDebounce[n]===t&&delete window.explorerDebounce[n]},1e3),Pt(e,!0)}window.openExplorerInNewWindow=dt;function Qe(){document.querySelectorAll(".file-explorer-window").forEach(e=>{const n=e.getAttribute("data-current-path"),t=et(n),o=e.parentElement;o.innerHTML=t}),Pe()}function Vo(e){e=normalizePath(e);const n=e.match(/^([A-Z]:\/\/)(.*)/);if(!n)return e;const t=n[1],o=n[2];let i=`<span class="cursor-pointer hover:underline" data-path="${t}">${t}</span>`;if(!o)return i;let r=t;return o.split("/").filter(Boolean).forEach(a=>{r=r.endsWith("/")?r+a:`${r}/${a}`;const s=Ko(r),l=s?s.name:a;i+=` / <span class="cursor-pointer hover:underline" data-path="${s?s.id:r}">${l}</span>`}),i}function et(e="C://"){e=normalizePath(e);const n=Vn(e),t=['<ul class="pl-5">'];Object.values(n).forEach(r=>{const a=r.type==="folder";let s=a?"image/folder.webp":"image/file.webp";r.icon?s=r.icon:r.icon_url&&(s=r.icon_url);const l="cursor-pointer hover:bg-gray-50 file-item truncate"+(a?" folder-item":""),d=r.description?` (${r.description})`:"";if(a)t.push(`<li class="${l}" data-item-id="${r.id}" data-open-folder="${r.id}" title="${r.name}"><img src="${s}" class="inline h-4 w-4 mr-2" alt="${r.name} folder icon"> ${r.name}</li>`);else if(r.type==="shortcut")t.push(`<li class="${l}" data-item-id="${r.id}" data-open-shortcut="true" data-url="${r.url}" title="${r.name}${d}"><img src="${s}" class="inline h-4 w-4 mr-2" alt="${r.name} shortcut icon"> ${r.name}</li>`);else{const c=r.name||r.id||"Unknown File";r.name||console.warn("üîç EXPLORER: File missing name property, using fallback:",c,"Item:",r),t.push(`<li class="${l}" data-item-id="${r.id}" data-open-file="${r.id}" title="${c}${d}"><img src="${s}" class="inline h-4 w-4 mr-2" alt="${c} file icon"> ${c}</li>`)}}),t.push("</ul>");const o=["C://","A://","D://"].map(r=>`<li class="cursor-pointer border-b border-gray-200 hover:bg-gray-50 system-folder" data-open-drive="${r}"><img src="image/${r[0].toLowerCase()==="c"?"drive_c":r[0].toLowerCase()==="a"?"floppy":"cd"}.webp" class="inline h-4 w-4 mr-2" alt="${r} drive icon"> ${r}</li>`).join(""),i=Vo(e);return`
    <div class="file-explorer-window" data-current-path="${e}">
      <div class="flex">
        <!-- Left Sidebar -->
        <div id="file-sidebar" class="w-1/4 border-r p-2"><ul>${o}</ul></div>

        <!-- Main Content -->
        <div id="file-main" class="w-3/4 p-2 min-h-96">
          <div id="breadcrumbs" class="mb-2">Path: ${i}</div>
          <div id="files-area">
            ${t.join("")}
          </div>
        </div>
      </div>
    </div>
  `}document.addEventListener("click",e=>{const n=e.target.closest(".file-explorer-window");if(n&&n.getAttribute("data-image-selection-mode")==="true"){const t=e.target.closest("[data-open-file]");if(t){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const o=n.getAttribute("data-current-path"),i=Vn(o),r=Object.values(i).find(a=>a.id===t.dataset.openFile);if(r&&["png","jpg","jpeg","gif","webp","avif"].includes(r.content_type)){n.querySelectorAll("[data-open-file]").forEach(l=>{l.classList.remove("bg-blue-100","border-blue-300"),l.style.backgroundColor="",l.style.border=""}),t.classList.add("bg-blue-100","border-blue-300"),t.style.backgroundColor="#dbeafe",t.style.border="2px solid #93c5fd",t.style.borderRadius="4px";const s=document.getElementById("selected-image-name");if(s)if(s.textContent=`Selected: ${r.name}`,window.watercolourSelectedFile=r,typeof window.updateWatercolourImageSelectionButton=="function")window.updateWatercolourImageSelectionButton(!0);else{const l=document.getElementById("open-selected-image");l&&(l.disabled=!1)}else console.error("Selection UI elements not found",{selectedNameSpan:s})}else{const a=document.getElementById("selected-image-name");if(a)if(a.textContent="Please select an image file",typeof window.updateWatercolourImageSelectionButton=="function")window.updateWatercolourImageSelectionButton(!1);else{const s=document.getElementById("open-selected-image");s&&(s.disabled=!0)}}return}}},!0);document.addEventListener("dblclick",e=>{const n=e.target.closest("[data-open-folder],[data-open-file],[data-open-shortcut]");if(!n)return;const t=e.target.closest(".file-explorer-window");if(t&&t.getAttribute("data-image-selection-mode")==="true")return e.preventDefault(),e.stopPropagation(),!1;if(n.dataset.openFolder)if(t){const o=n.dataset.openFolder;let i;if(/^[A-Z]:\/\//.test(o)?i=o:i=dn(o),i){const r=et(i);t.outerHTML=r;const a=t.closest(".window");a&&a.id&&Je(a.id,r),setTimeout(Pe,100),setTimeout(async()=>{await ut()},150)}}else Pt(n.dataset.openFolder);else n.dataset.openFile?Lt(n.dataset.openFile,e):n.dataset.openShortcut&&Yt(n)});document.addEventListener("click",e=>{const n=e.target.closest("[data-open-drive]");if(n){const t=n.closest(".file-explorer-window");if(t){const o=n.dataset.openDrive,i=et(o);t.outerHTML=i;const r=t.closest(".window");r&&r.id&&Je(r.id,i),setTimeout(Pe,100),setTimeout(async()=>{await ut()},150)}else Pt(n.dataset.openDrive)}});document.addEventListener("click",e=>{const n=e.target.closest("[data-path]");if(n){e.stopPropagation();const t=n.closest(".file-explorer-window");if(t){let o=n.dataset.path;if(o&&!/^[A-Z]:\/\//.test(o)){const a=dn(o);a&&(o=a)}const i=et(o);t.outerHTML=i;const r=t.closest(".window");r&&r.id&&Je(r.id,i),setTimeout(Pe,100),setTimeout(async()=>{await ut()},150)}else Pt(n.dataset.path)}});async function Lt(e,n){const t=document.getElementById(e);if(t){const f=[...document.querySelectorAll("*")].filter(p=>getComputedStyle(p).zIndex>100&&getComputedStyle(p).zIndex<1e3).reduce((p,g)=>getComputedStyle(g).zIndex>getComputedStyle(p).zIndex?g:p);t.style.zIndex=`${parseInt(f.style.zIndex)+1}`;return}let o;const i=n.target===document.body,r=n.target.closest(".file-explorer-window");let a;i?a="C://Documents":r?a=r.getAttribute("data-current-path"):n.srcElement.classList.contains("desktop-folder-icon")&&(a="C://Desktop");const s=Vn(a);if(o=Object.values(s).find(u=>u.id===e),!o||typeof o=="string"){const u=`File ${typeof o=="string"?`"${o}"`:""}`;oe(`${u}not found.`,"error");return}let l="",d="default";if(o.type==="ugc-file")if(o.content_type==="text"||o.content_type==="txt")l=`<div id="file-content" style="padding:10px;">
        <div id="text-editor" contenteditable="true" style="padding:10px; overflow:auto;" role="textbox" aria-label="Text file editor" title="Edit the contents of this text file">${o.content||o.contents||"Empty file"}</div>
      </div>`,d="editor",setTimeout(()=>{const u=document.getElementById("text-editor");u&&u.addEventListener("input",function(){Je(o.id,this.innerHTML),o.content=this.innerHTML,X()})},100);else if(o.content_type==="markdown"||o.content_type==="md"){const u=`letterpad_${o.id}`;let f=o.content||o.contents||"";try{const p=await B.getItem(u);p&&p.content!==void 0&&(f=p.content)}catch(p){console.warn("Error checking existing storage for markdown file:",p)}await B.setItem(u,{content:f}),l=`<div id="file-content" style="padding:10px;">
        <div class="letterpad_editor min-h-48 h-full w-full" data-letterpad-editor-id="${o.id}"></div>
      </div>`,d="editor",setTimeout(async()=>{const p=document.querySelector(`[data-letterpad-editor-id="${o.id}"]`);p&&typeof initializeLetterPad=="function"&&await initializeLetterPad(p)},100)}else o.content_type==="html"?l=o.content||o.contents||'<p style="padding:10px;">Empty HTML file.</p>':["png","jpg","jpeg","gif","webp","avif"].includes(o.content_type)?o.dataURL?l=`<img src="${o.dataURL}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:o.isLargeFile&&o.storageLocation==="indexeddb"?(l='<div style="padding:10px; text-align:center;">Loading image...</div>',d="image",setTimeout(async()=>{try{const u=await B.getItem(`file_data_${o.id}`);if(u){const f=`<img src="${u}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`,p=document.getElementById(o.id);if(p){const g=p.querySelector(".p-2");g&&(g.innerHTML=f)}}else throw console.error("No image data found in IndexedDB for file:",o.id),new Error("Image data not found in storage")}catch(u){console.error("Error loading large image file:",u),console.error("File object details:",o);const f=document.getElementById(o.id);if(f){const p=f.querySelector(".p-2");p&&(p.innerHTML=`<p style="padding:10px;">Error loading image: ${u.message}</p>`)}}},100)):o.file&&o.file instanceof File?l=`<img src="${URL.createObjectURL(o.file)}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:o.isDefault||o.isSystemFile||o.path?l=`<img src="${o.path||`media/${o.name}`}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:l=`<p style="padding:10px;">Image file not found or invalid.<br>Debug: isLargeFile=${o.isLargeFile}, storage=${o.storageLocation}</p>`:["mp3","wav","ogg"].includes(o.content_type)?o.dataURL?l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
              <source src="${o.dataURL}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:o.isLargeFile&&o.storageLocation==="indexeddb"?(l='<div style="padding:10px; text-align:center;">Loading audio...</div>',d="audio",setTimeout(async()=>{try{const u=await B.getItem(`file_data_${o.id}`);if(u){const f=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
                <source src="${u}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>`,p=document.getElementById(o.id);if(p){const g=p.querySelector(".p-2");g&&(g.innerHTML=f)}}else throw new Error("Audio data not found in IndexedDB")}catch(u){console.error("Error loading large audio file:",u);const f=document.getElementById(o.id);if(f){const p=f.querySelector(".p-2");p&&(p.innerHTML=`<p style="padding:10px;">Error loading audio: ${u.message}</p>`)}}},100)):o.file&&o.file instanceof File?l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
              <source src="${URL.createObjectURL(o.file)}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:o.tempObjectURL?l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;"
                     onerror="console.error('üîç AUDIO: Audio element error:', event.target.error)">
              <source src="${o.tempObjectURL}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:o.isDefault||o.isSystemFile||o.path?l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
              <source src="${o.path||`media/${o.name}`}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:l='<p style="padding:10px;">Audio file not found or invalid.<br>Debug: Missing required properties for audio playback.</p>':["mp4","webm","avi","mov"].includes(o.content_type)?o.dataURL?l=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
            <source src="${o.dataURL}" type="video/mp4">
            Your browser does not support the video tag.
          </video>`:o.tempObjectURL?l=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;"
                     onerror="console.error('üîç VIDEO: Video element error:', event.target.error)">
            <source src="${o.tempObjectURL}" type="video/mp4">
            Your browser does not support the video tag.
          </video>`:o.isLargeFile&&o.storageLocation==="indexeddb"?(l='<div style="padding:10px; text-align:center;">Loading video...</div>',d="video",setTimeout(async()=>{try{const u=await B.getItem(`file_data_${o.id}`);if(u){const f=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
                <source src="${u}" type="video/mp4">
                Your browser does not support the video tag.
              </video>`,p=document.getElementById(o.id);if(p){const g=p.querySelector(".p-2");g&&(g.innerHTML=f)}}}catch(u){console.error("Error loading large video file:",u);const f=document.getElementById(o.id);if(f){const p=f.querySelector(".p-2");p&&(p.innerHTML=`<p style="padding:10px;">Error loading video: ${u.message}</p>`)}}},100)):o.file&&o.file instanceof File?l=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
            <source src="${URL.createObjectURL(o.file)}" type="video/mp4">
            Your browser does not support the video tag.
          </video>`:l='<p style="padding:10px;">Video file not found or invalid.</p>':l=`<p style="padding:10px;">${o.content||o.contents||"Empty file"}</p>`;else["image","jpg","jpeg","png","webp","avif","gif"].includes(o.content_type)?o.file?l=`<img src="${URL.createObjectURL(o.file)}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:l=`<img src="./media/${o.name}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:["video","mov","mp4","webm","avi"].includes(o.content_type)?l=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
            <source src="./media/${o.name}" type="video/mp4">
            Your browser does not support the video tag.
          </video>`:["audio","mp3","ogg","wav"].includes(o.content_type)?o.file?l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
              <source src="${URL.createObjectURL(o.file)}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:o.isDefault||o.isSystemFile||o.path?l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
              <source src="${o.path||`media/${o.name}`}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
              <source src="./media/${o.name}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:o.content_type==="html"?(l=o.contents?o.contents:'<p style="padding:10px;">Loading HTML file...</p>',o.contents||fetch(`./media/${o.name}`).then(u=>u.text()).then(u=>{const f=document.getElementById(o.id),p=f?f.querySelector(".p-2"):null;p&&(p.innerHTML=u),o.contents=u,X()}).catch(u=>{console.error("Error loading HTML file:",u);const f=document.getElementById(o.id),p=f?f.querySelector(".p-2"):null;p&&(p.innerHTML="<p>Error loading HTML file.</p>")})):o.content_type==="text"||o.content_type==="txt"?(l='<div id="file-content" style="padding:10px;">Loading file...</div>',fetch(`./media/${o.name}`).then(u=>u.text()).then(u=>{const f=document.getElementById(o.id),p=f?f.querySelector(".p-2"):null;p&&(p.innerHTML=`<div id="text-editor" contenteditable="true" style="padding:10px; overflow:auto;" role="textbox" aria-label="Text file editor" title="Edit the contents of this text file">${u}</div>`,document.getElementById("text-editor").addEventListener("input",function(){Je(o.id,this.innerHTML),o.type="ugc-file",o.content=this.innerHTML,X()})),o.content=u,X()}).catch(u=>{console.error("Error loading text file:",u);const f=document.getElementById(o.id),p=f?f.querySelector(".p-2"):null;p&&(p.innerHTML="<p>Error loading file.</p>")}),d="editor"):o.content_type==="markdown"||o.content_type==="md"?(l='<div id="file-content" style="padding:10px;">Loading file...</div>',fetch(`./media/${o.name}`).then(u=>u.text()).then(u=>{const f=document.getElementById(o.id),p=f?f.querySelector(".p-2"):null;p&&(p.innerHTML=`<div class="letterpad_editor min-h-48 h-full w-full" data-letterpad-editor-id="${o.id}"></div>`),X()}).catch(u=>{console.error("Error loading markdown file:",u);const f=document.getElementById(o.id),p=f?f.querySelector(".p-2"):null;p&&(p.innerHTML="<p>Error loading file.</p>")}),d="editor"):l=`<p style="padding:10px;">Content of ${o.name}</p>`;let c=null;n&&(c=n.target.closest("#windows-container > div"));let m=se(o.name,l,!1,o.id,!1,!1,{type:"integer",width:420,height:350},d,c);if(o.content_type==="image"){let u=m.querySelector("img");u&&(u.onload=function(){let f=u.naturalWidth+20,p=u.naturalHeight+60;m.style.width=f+"px",m.style.height=p+"px",re[m.id].dimensions={type:"integer",width:f,height:p},X()})}else if(o.content_type==="video"){let u=m.querySelector("video");u&&(u.onloadedmetadata=function(){let f=u.videoWidth+20,p=u.videoHeight+60;m.style.width=f+"px",m.style.height=p+"px",re[m.id].dimensions={type:"integer",width:f,height:p},X()})}}function Yt(e){if(!e)return;const n=e.getAttribute("data-url");n&&window.open(n,"_blank")}function Cr(e){if(!e||!window.watercolourImageSelectionCallback)return!1;if(!["png","jpg","jpeg","gif","webp","avif"].includes(e.content_type))return alert("Please select an image file (.png, .jpg, .jpeg, .gif, .webp)"),!1;let n=null;if(e.dataURL){n=e.dataURL;const t={name:e.name,path:Mn(),data:n,storageKey:e.storageLocation==="indexeddb"?`file_data_${e.id}`:null};return window.watercolourImageSelectionCallback(n,t),le("explorer-image-select"),window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null,!0}else{if(e.isLargeFile&&e.storageLocation==="indexeddb")return B.getItem(`file_data_${e.id}`).then(t=>{if(t){const o={name:e.name,path:Mn(),data:t,storageKey:`file_data_${e.id}`};window.watercolourImageSelectionCallback(t,o),le("explorer-image-select"),window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null}else alert("Could not load image data.")}).catch(t=>{console.error("Error loading image:",t),alert("Error loading image: "+t.message)}),!0;if(e.file&&e.file instanceof File){const t=new FileReader;return t.onload=o=>{const i={name:e.name,path:Mn(),data:o.target.result,storageKey:null};window.watercolourImageSelectionCallback(o.target.result,i),le("explorer-image-select"),window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null},t.readAsDataURL(e.file),!0}}return alert("Could not load the selected image."),!1}function Mn(){const e=document.querySelectorAll(".file-explorer-window");return e.length>0&&e[e.length-1].getAttribute("data-current-path")||"C://Documents"}async function ut(){try{const e=document.getElementById("explorer-window");if(e){const n=e.querySelector(".file-explorer-window");if(n){const o={currentPath:n.getAttribute("data-current-path")||"C://",timestamp:Date.now()};await B.setItem("fileExplorerState",o)}}}catch(e){console.warn("Failed to save file explorer state:",e);try{const n=document.getElementById("explorer-window");if(n){const t=n.querySelector(".file-explorer-window");if(t){const i={currentPath:t.getAttribute("data-current-path")||"C://",timestamp:Date.now()};B.setItemSync("fileExplorerState",i)}}}catch(n){console.error("Failed to save file explorer state with fallback:",n)}}}async function Ir(){try{const e=await B.getItem("fileExplorerState");if(e)return e}catch(e){console.warn("Failed to load file explorer state:",e);try{const n=B.getItemSync("fileExplorerState");if(n)return n}catch(n){console.warn("Failed to load file explorer state with fallback:",n)}}return{currentPath:"C://",timestamp:0}}function Lr(e){setTimeout(async()=>{await Xo()},50)}async function Xo(){const e=await Ir(),n=document.getElementById("explorer-window");if(n&&e.currentPath){const t=et(e.currentPath),o=n.querySelector(".file-explorer-window");o?(o.outerHTML=t,setTimeout(()=>{Pe(),Qe()},100)):console.warn("‚ö†Ô∏è Could not find .file-explorer-window element")}else console.warn("‚ö†Ô∏è No explorer window found or no current path in state")}typeof window<"u"&&(window.initializeFileExplorerUI=Lr,window.restoreFileExplorerState=Xo);function qt(e){e.addEventListener("keydown",function(n){if(n.key==="ContextMenu"||n.shiftKey&&n.key==="F10"||n.ctrlKey&&n.key===" "){n.preventDefault();const t=e.getBoundingClientRect(),o=new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,clientX:t.left+t.width/2,clientY:t.top+t.height/2,button:2});e.dispatchEvent(o),setTimeout(()=>{const i=document.getElementById("context-menu");i&&!i.classList.contains("hidden")&&Mr(i)},10)}})}function Mr(e){if(!e)return;e.setAttribute("role","menu"),e.setAttribute("aria-label","Context menu");const n=Array.from(e.children).filter(t=>t.classList.contains("cursor-pointer")&&!t.classList.contains("text-gray-400"));n.forEach((t,o)=>{t.setAttribute("role","menuitem"),t.setAttribute("tabindex",o===0?"0":"-1"),t.addEventListener("keydown",function(r){(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),t.click())}),t.addEventListener("mouseenter",function(){n.forEach(r=>{r.classList.remove("bg-gray-50"),r.style.backgroundColor=""}),t.classList.add("bg-gray-50"),t.style.backgroundColor="#f9fafb"}),t.addEventListener("mouseleave",function(){document.activeElement!==t&&(t.classList.remove("bg-gray-50"),t.style.backgroundColor="")});const i=t.querySelector("div.absolute");i&&(t.setAttribute("aria-haspopup","true"),t.setAttribute("aria-expanded","false"),i.setAttribute("role","menu"),i.setAttribute("aria-label","Submenu"),Array.from(i.children).filter(a=>a.classList.contains("cursor-pointer")).forEach((a,s)=>{a.setAttribute("role","menuitem"),a.setAttribute("tabindex","-1"),a.addEventListener("keydown",function(l){(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),a.click())})}))}),n.length>0&&setTimeout(()=>{n[0].focus(),n[0].classList.add("bg-gray-50"),n[0].style.backgroundColor="#f9fafb"},50)}function Co(){document.addEventListener("keydown",function(r){const a=document.getElementById("context-menu");if(a&&!a.classList.contains("hidden")){e(r,a);return}const l=document.querySelector(".file-explorer-window:focus-within");if(l){const d=document.activeElement;switch(r.key){case"F2":r.preventDefault(),console.log("F2 - Rename functionality would trigger here");break;case"Delete":r.preventDefault(),console.log("Delete - Delete functionality would trigger here");break;case"Enter":r.preventDefault(),d&&d.classList.contains("file-item")&&d.dispatchEvent(new MouseEvent("dblclick",{bubbles:!0}));break;case"ArrowDown":case"ArrowUp":r.preventDefault(),o(r.key==="ArrowDown"?"down":"up",l);break}}});function e(r,a){const s=Array.from(a.children).filter(d=>!d.classList.contains("text-gray-400")&&d.classList.contains("cursor-pointer"));if(s.length===0)return;let l=-1;for(let d=0;d<s.length;d++)if(s[d].classList.contains("bg-gray-50")||s[d].matches(":focus")){l=d;break}switch(r.key){case"ArrowDown":r.preventDefault(),r.stopPropagation(),l=l===-1?0:(l+1)%s.length,n(s,l);break;case"ArrowUp":r.preventDefault(),r.stopPropagation(),l=l===-1?s.length-1:(l-1+s.length)%s.length,n(s,l);break;case"ArrowRight":if(r.preventDefault(),r.stopPropagation(),l>=0&&s[l]){const c=s[l].querySelector("div.absolute");if(c){c.classList.remove("hidden");const m=Array.from(c.children).filter(u=>u.classList.contains("cursor-pointer"));m.length>0&&t(m,0)}}break;case"ArrowLeft":r.preventDefault(),r.stopPropagation();const d=a.querySelector("div.absolute:not(.hidden)");d&&(d.classList.add("hidden"),l>=0&&s[l]&&n(s,l));break;case"Enter":case" ":r.preventDefault(),r.stopPropagation(),l>=0&&s[l]&&s[l].click();break;case"Escape":r.preventDefault(),r.stopPropagation(),typeof hideContextMenu=="function"?hideContextMenu():a.classList.add("hidden");break}}function n(r,a){r.forEach(s=>{s.classList.remove("bg-gray-50"),s.style.backgroundColor=""}),r[a]&&(r[a].classList.add("bg-gray-50"),r[a].style.backgroundColor="#f9fafb",r[a].focus())}function t(r,a){r.forEach(s=>{s.classList.remove("bg-gray-50"),s.style.backgroundColor=""}),r[a]&&(r[a].classList.add("bg-gray-50"),r[a].style.backgroundColor="#f9fafb",r[a].focus())}function o(r,a){const s=Array.from(a.querySelectorAll(".file-item, .folder-item")),l=document.activeElement;let d=s.indexOf(l);if(d===-1&&s.length>0){s[0].focus();return}let c;r==="down"?c=(d+1)%s.length:c=(d-1+s.length)%s.length,s[c]&&s[c].focus()}new MutationObserver(function(r){r.forEach(function(a){a.addedNodes.forEach(function(s){var l,d;if(s.nodeType===Node.ELEMENT_NODE){const c=(l=s.querySelectorAll)==null?void 0:l.call(s,".file-item, .folder-item, .draggable-icon");c==null||c.forEach(u=>{qt(u),u.hasAttribute("tabindex")||u.setAttribute("tabindex","0")});const m=(d=s.querySelectorAll)==null?void 0:d.call(s,".file-explorer-window");m==null||m.forEach(u=>{qt(u),u.hasAttribute("tabindex")||u.setAttribute("tabindex","0")})}})})}).observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll(".file-item, .folder-item, .draggable-icon").forEach(r=>{qt(r),r.hasAttribute("tabindex")||r.setAttribute("tabindex","0")}),document.querySelectorAll(".file-explorer-window").forEach(r=>{qt(r),r.hasAttribute("tabindex")||r.setAttribute("tabindex","0")})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Co):Co();function Ke(e,n=null){let t;typeof e!="string"?t=e:t=document.getElementById(e),t.classList.toggle("bg-gray-50"),t.classList.toggle("bg-gray-200"),t.classList.toggle("border-gray-300"),t.classList.toggle("border-black");const o=t.querySelector("span");o.classList.toggle("border-gray-300"),o.classList.toggle("border-black");const i=t.querySelector("img");i&&(i.classList.toggle("border-gray-300"),i.classList.toggle("border-black")),n&&(o.innerHTML=n)}function Ar(e){if(!e)return!0;try{return new URL(e,location.href).origin===location.origin}catch{return!1}}function Zo(){document.getElementById("error-overlay").classList.remove("hidden"),document.getElementById("error-overlay").style.zIndex="9999";function e(n){location.reload()}document.addEventListener("keydown",e,{once:!0})}window.onerror=function(e,n,t,o,i){Ar(n)&&Zo()};window.addEventListener("unhandledrejection",function(e){Zo()});function Dr(e){if(window.watercolourImageSelectionCallback=e,window.watercolourSelectedFile=null,typeof getExplorerWindowContent=="function"&&typeof createWindow=="function"){const t=getExplorerWindowContent("C://Documents").replace(/<div id="file-sidebar"[\s\S]*?<\/ul><\/div>/g,"").replace(/<div id="breadcrumbs"[\s\S]*?<\/div>/g,""),o=createWindow("Select Image - File Explorer",t,!0,"explorer-image-select",!1,!1,{type:"integer",width:600,height:550},"file-explorer");bringToFront(o),setTimeout(()=>{if(o){const i=o.querySelector(".file-explorer-window");i?i.setAttribute("data-image-selection-mode","true"):console.error("Could not find .file-explorer-window div!");const r=o.querySelector(".p-2");if(r){const a=document.createElement("div");a.className="bg-blue-100 border border-blue-300 text-blue-800 px-3 py-2 rounded mb-3 text-sm",a.innerHTML='<strong>Select an image:</strong> Click any image file (.png, .jpg, .jpeg, .gif, .webp) to select it, then click "Open Selected Image".',r.insertBefore(a,r.firstChild);const s=document.createElement("div");s.className="-mt-2 p-3 bg-gray-50 border-t border-gray-200 flex items-center justify-between",s.id="watercolour-selection-ui";const l=document.createElement("div");l.className="flex gap-2";const d=de("Cancel");d.id="cancel-selection";const c=de("Open");c.id="open-selected-image",c.disabled=!0,c.style.opacity="0.5",c.style.cursor="not-allowed",l.appendChild(d),l.appendChild(c),s.innerHTML=`
            <div>
              <span id="selected-image-name" class="text-sm text-gray-600">No image selected</span>
            </div>
          `,s.appendChild(l),r.appendChild(s),d.addEventListener("click",()=>{window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null,closeWindow("explorer-image-select")}),c.addEventListener("click",()=>{const m=window.watercolourSelectedFile;m&&window.watercolourImageSelectionCallback&&!c.disabled&&handleWatercolourImageSelection(m)}),window.updateWatercolourImageSelectionButton=function(m){m?(c.disabled=!1,c.style.opacity="1",c.style.cursor="pointer"):(c.disabled=!0,c.style.opacity="0.5",c.style.cursor="not-allowed")}}}else console.error("Explorer window not found!")},100)}else showDialogBox("File explorer functionality not available.","error")}function de(e){const n=document.createElement("button");n.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2";const t=document.createElement("span");return t.className="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3",t.textContent=e,n.appendChild(t),n.setAttribute("aria-label",e),n.setAttribute("title",e),n}function Xn(e,n="",t=null,o=null){return showDialogBox(e,"prompt",t,o,{defaultValue:n})}const Jo=Object.freeze(Object.defineProperty({__proto__:null,makeWin95Button:de,makeWin95Prompt:Xn,openFileExplorerForImageSelection:Dr,toggleButtonActiveState:Ke},Symbol.toStringTag,{value:"Module"}));function Qo(){const e=document.getElementById("compost-bin");if(e){Ie(e);return}const t=se("Compost Bin","",!1,"compost-bin",!1,!1,{type:"integer",width:600,height:400},"App",null,"gray").querySelector(".p-2");t.className="p-2 bg-gray-100 h-full flex flex-col";const o=document.createElement("div");o.className="h-full flex flex-col";const i=document.createElement("div");i.className="bg-gray-200 border-b border-gray-400 p-2 flex justify-between items-center";const r=document.createElement("div");r.className="text-sm";const l=(ce().folders["C://Desktop"]||{}).compostbin,d=Object.keys((l==null?void 0:l.contents)||{}).length;r.textContent=`Compost Bin - ${d} item(s)`;const c=document.createElement("div");c.className="flex space-x-2";const m=document.createElement("button");m.className="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs",m.textContent="Empty Bin",m.setAttribute("aria-label","Empty all items from compost bin"),m.setAttribute("title","Permanently delete all items in the compost bin"),m.addEventListener("click",ti),c.appendChild(m),i.appendChild(r),i.appendChild(c);const u=document.createElement("div");u.className="flex-1 bg-white border border-gray-400 p-2 overflow-auto",u.id="compost-bin-content",un(u),o.appendChild(i),o.appendChild(u),t.appendChild(o)}function un(e){const o=(ce().folders["C://Desktop"]||{}).compostbin,i=(o==null?void 0:o.contents)||{};if(e.innerHTML="",Object.keys(i).length===0){const a=document.createElement("div");a.className="text-center text-gray-500 mt-8",a.textContent="The Compost Bin is empty",e.appendChild(a);return}const r=document.createElement("div");r.className="grid grid-cols-6 gap-4 p-2",Object.values(i).forEach(a=>{const s=Br(a);r.appendChild(s)}),e.appendChild(r)}function Br(e){const n=document.createElement("div");n.className="flex flex-col items-center p-2 hover:bg-blue-100 cursor-pointer",n.draggable=!0,n.setAttribute("data-item-id",e.id);const t=document.createElement("img");t.className="w-8 h-8 mb-1",t.src=e.icon||Tr(e.type),t.alt=e.name;const o=document.createElement("div");return o.className="text-xs text-center text-gray-700 break-words max-w-16",o.textContent=e.name,n.appendChild(t),n.appendChild(o),n.addEventListener("dragstart",i=>{i.dataTransfer.setData("text/plain",e.id),i.dataTransfer.setData("application/x-compost-item","true"),i.dataTransfer.effectAllowed="move"}),n}async function ei(e,n){const t=ce();if(e==="compostbin"){oe("Cannot move the Compost Bin to itself!","error");return}let o=null,i=null;if(i=t.folders["C://Desktop"]||{},i&&i[e]){o=i[e];const a=(t.folders["C://Desktop"]||{}).compostbin;if(!a){console.error("Compost bin not found in unified structure"),oe("Compost Bin not found!","error");return}a.contents||(a.contents={}),o.originalPath=n,a.contents[e]=o,delete i[e];{const l="icon-"+e;ge[l]&&delete ge[l]}await ke(t),X(),Qe(),be();const s=document.getElementById("compost-bin");if(s){const l=s.querySelector("#compost-bin-content");l&&(un(l),ni(s))}}}function ti(){const e=ce(),t=(e.folders["C://Desktop"]||{}).compostbin;if(!t){oe("Compost Bin not found!","error");return}const o=Object.keys(t.contents||{}).length;if(o===0){oe("The Compost Bin is already empty.","info");return}const i=`window-${Date.now()}`,r=se("Empty Compost Bin","",!1,i,!1,!1,{type:"integer",width:320,height:140},"Default"),a=r.querySelector(".p-2");a.classList.add("p-4","flex","flex-col","justify-between","h-full");const s=document.createElement("p");s.textContent=`Are you sure you want to permanently delete all ${o} item(s) in the Compost Bin?`,a.appendChild(s);const l=document.createElement("div");l.className="flex justify-end space-x-2",a.appendChild(l);const d=document.createElement("button");d.className="px-4 py-2 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200",d.textContent="Cancel",d.setAttribute("aria-label","Cancel empty bin operation"),d.setAttribute("title","Cancel and keep items in compost bin");const c=document.createElement("button");c.className="px-4 py-2 bg-red-500 border-2 border-red-600 hover:bg-red-400 text-white",c.textContent="Empty Bin",c.setAttribute("aria-label","Confirm empty bin operation"),c.setAttribute("title","Permanently delete all items in compost bin"),l.append(d,c),d.addEventListener("click",()=>le(i)),c.addEventListener("click",async()=>{const m=Object.keys(t.contents||{});t.contents={},m.forEach(f=>{const p="icon-"+f;ge[p]&&delete ge[p]}),await ke(e),X();const u=document.getElementById("compost-bin");if(u){const f=u.querySelector("#compost-bin-content");f&&(un(f),ni(u))}le(i),oe(`${o} item(s) permanently deleted from Compost Bin`,"info")}),Ie(r)}function ni(e){const n=e.querySelector(".bg-gray-200");if(n){const t=n.querySelector(".text-sm");if(t){const r=(ce().folders["C://Desktop"]||{}).compostbin,a=Object.keys((r==null?void 0:r.contents)||{}).length;t.textContent=`Compost Bin - ${a} item(s)`}}}function Tr(e){switch(e){case"folder":return"./image/folder.webp";case"ugc-file":return"./image/doc.webp";case"app":return"./image/computer.webp";default:return"./image/file.webp"}}function oi(){try{new Audio("audio/youve_got_mail.mp3").play().catch(o=>console.log("Audio playback prevented:",o))}catch(t){console.log("Could not play audio:",t)}if(window.location.href.includes("reddit.com")){if(document.getElementById("mailbox-error"))return;se("‚ö†Ô∏è Error",'<div class="text-center p-4"><p class="mb-4">Mail Box is not available in Reddit context.</p><button id="error-ok-btn" class="bg-gray-200 border-t-2 border-l-2 border-gray-300 h-8" aria-label="Close error dialog" title="Close this error message"><span class="border-b-2 border-r-2 border-black block h-full w-full py-1 px-3 leading-6">OK</span></button></div>',!1,"mailbox-error",!1,!1,{type:"integer",width:300,height:150},"Default"),setTimeout(()=>{const t=document.getElementById("error-ok-btn");t&&t.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),le("mailbox-error")})},100);return}const n=se("Mail Box","",!1,"mailbox",!1,!1,{type:"integer",width:600,height:400},"App",null,"white");zn(n)}function zn(e){if(!e)return;const n=e.querySelector(".p-2");if(!n)return;n.innerHTML="",n.classList.add("flex","flex-col","h-full");const t=document.createElement("div");t.className="flex-1 flex overflow-hidden",n.appendChild(t);const o=document.createElement("div");o.id="mailbox-list",o.className="w-1/3 border-r border-gray-300 flex flex-col overflow-y-auto",t.appendChild(o);const i=document.createElement("button");i.id="compose-btn",i.className="p-2 border-b border-gray-300 text-blue-500 hover:bg-gray-100",i.textContent="Compose",i.setAttribute("aria-label","Compose new email"),i.setAttribute("title","Create and send a new email message"),o.appendChild(i);const r=document.createElement("div");r.id="mailbox-detail",r.className="flex-1 p-2 overflow-y-auto",t.appendChild(r);const a=document.createElement("div");a.id="placeholder",a.className="text-gray-500",a.textContent="Select a message to view",r.appendChild(a);function s(m){return m.map(u=>{const f={};return["file_1","file_2","file_3"].forEach(p=>{if(u[p]){const g=u[p];let k="attachment";try{k=g.split("/").pop().split("?")[0]}catch{k=p}f[p]={name:k,url:g}}}),{id:u.id,email:u.email||u.name||"Unknown",title:u.subject||"No Subject",mail:u.message||"",phone:u.phone||"",company:u.company||"",timestamp:u.created_at||null,public:!1,files:f}})}function l(){try{for(;o.children.length>1;)o.removeChild(o.lastChild);fetch(`${Dt}${Yo}`).then(m=>{if(!m.ok)throw new Error("Failed to fetch submissions");return m.json()}).then(m=>{s(m.data).forEach(f=>{const p=document.createElement("div");p.className="p-2 border-b border-gray-300 hover:bg-gray-200 cursor-pointer truncate",p.textContent=f.title||f.email,p.addEventListener("click",()=>d(f)),o.appendChild(p)})}).catch(m=>{console.error("Error loading messages:",m);const u=document.createElement("div");u.className="p-2 text-red-500 text-sm",u.textContent="Failed to load messages",o.appendChild(u)})}catch(m){console.error("Error loading messages:",m)}}function d(m){for(;r.firstChild;)r.removeChild(r.firstChild);const u=document.createElement("div");u.className="mb-4 border-b border-gray-200 pb-2";const f=(g,k)=>{const v=document.createElement("div");v.className="mb-1";const y=document.createElement("strong");return y.textContent=g+": ",v.append(y,document.createTextNode(k||"")),v};u.appendChild(f("From",m.email)),u.appendChild(f("Title",m.title||"(No Title)")),m.phone&&u.appendChild(f("Phone",m.phone)),m.company&&u.appendChild(f("Company",m.company)),m.timestamp&&u.appendChild(f("Date",new Date(m.timestamp).toLocaleString()));const p=document.createElement("div");if(p.className="mb-2 whitespace-pre-wrap font-sans",p.textContent=m.mail,r.append(u,p),m.files&&Object.keys(m.files).length){const g=document.createElement("div");g.className="mt-4 border-t border-gray-200 pt-2";const k=document.createElement("strong");k.textContent="Attachments:",g.appendChild(k);const v=document.createElement("div");v.className="flex flex-col gap-2 mt-2",Object.values(m.files).forEach(y=>{const P=y.url||y.contents;if(!P)return;const j=document.createElement("div");j.className="border p-2 rounded bg-gray-50";const K=P.split(".").pop().toLowerCase().split("?")[0];if(["jpg","jpeg","png","gif","webp","svg"].includes(K)){const q=document.createElement("img");q.src=P,q.alt=y.name,q.className="max-w-full h-auto max-h-96 object-contain block mb-1",j.appendChild(q)}else if(["mp3","wav","ogg"].includes(K)){const q=document.createElement("audio");q.controls=!0,q.src=P,q.className="w-full mb-1",j.appendChild(q)}else if(["mp4","webm"].includes(K)){const q=document.createElement("video");q.controls=!0,q.src=P,q.className="max-w-full h-auto max-h-96 mb-1",j.appendChild(q)}const T=document.createElement("a");T.href=P,T.className="text-blue-500 hover:underline text-sm break-all",T.textContent=y.name,T.target="_blank",j.appendChild(T),v.appendChild(j)}),g.appendChild(v),r.appendChild(g)}}function c(){const u=se("New Mail","",!1,"compose-mail",!1,!1,{type:"integer",width:400,height:600},"App",null,"white").querySelector(".p-2");u.classList.add("p-4");const f=document.createElement("form");f.id="compose-form",f.className="flex flex-col space-y-4",u.appendChild(f);const p=(z,R)=>{const _=document.createElement("div"),Z=document.createElement("label");return Z.className="block text-sm font-medium text-gray-700",Z.textContent=z,_.append(Z,R),_},g=document.createElement("input");g.type="email",g.name="from",g.required=!0,g.id="from-email",g.setAttribute("aria-label","Your email address"),g.setAttribute("aria-describedby","from-help"),g.className="mt-1 block w-full border border-gray-300 rounded p-2",f.appendChild(p("Your Email",g));const k=document.createElement("input");k.type="text",k.name="to",k.value="Nostalgia OS Team",k.readOnly=!0,k.id="to-email",k.setAttribute("aria-label","Recipient"),k.className="mt-1 block w-full border border-gray-300 rounded p-2 bg-gray-100",f.appendChild(p("To",k));const v=document.createElement("input");v.type="text",v.name="subject",v.id="email-subject",v.setAttribute("aria-label","Email subject line (optional)"),v.className="mt-1 block w-full border border-gray-300 rounded p-2",f.appendChild(p("Mail Title (optional)",v));const y=document.createElement("textarea");y.name="message",y.required=!0,y.id="email-message",y.setAttribute("aria-label","Email message content"),y.className="mt-1 block w-full border border-gray-300 rounded p-2",f.appendChild(p("Your Mail",y));const P=document.createElement("input");P.type="tel",P.name="phone",P.id="phone-number",P.setAttribute("aria-label","Phone number (optional)"),P.className="mt-1 block w-full border border-gray-300 rounded p-2",f.appendChild(p("Phone (optional)",P));const j=document.createElement("input");j.type="text",j.name="company",j.id="company-name",j.setAttribute("aria-label","Company name (optional)"),j.className="mt-1 block w-full border border-gray-300 rounded p-2",f.appendChild(p("Company (optional)",j));const K=document.createElement("div");K.className="flex justify-end space-x-2",f.appendChild(K);const T=document.createElement("button");T.type="button",T.id="cancel-compose",T.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2",T.innerHTML='<span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Cancel</span>',T.setAttribute("aria-label","Cancel mail composition"),T.setAttribute("title","Cancel and discard mail"),K.appendChild(T);const q=document.createElement("button");q.type="submit",q.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2",q.innerHTML='<span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Submit</span>',q.setAttribute("aria-label","Submit mail"),q.setAttribute("title","Submit your mail"),K.appendChild(q),f.addEventListener("submit",z=>{z.preventDefault();const R=new FormData(f),_={email:R.get("from"),title:R.get("subject")||"No Subject",mail:R.get("message"),phone:R.get("phone")||"",company:R.get("company")||""},Z={creator_model:{title:`Contact: ${_.title}`,feed_slug:"suggestions",model_type:"page",creator_fields_attributes:{0:{html_input_label:"name",string_content:_.email},1:{html_input_label:"email",string_content:_.email},2:{html_input_label:"phone",string_content:_.phone},3:{html_input_label:"company",string_content:_.company},4:{html_input_label:"subject",string_content:_.title},5:{html_input_label:"message",string_content:_.mail}}}};fetch(`${Dt}${br}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Z)}).then(J=>{if(J.ok)showDialogBox("Mail submitted successfully!","success"),l(),le("compose-mail");else throw new Error("Failed to submit form")}).catch(()=>showDialogBox("Error submitting mail.","error"))}),T.addEventListener("click",()=>le("compose-mail"))}i.addEventListener("click",c),l()}let _t=null;function Fr(){return _t||(_t=new Promise(e=>{if(window.YT&&window.YT.Player){e();return}const n=document.createElement("script");n.src="https://www.youtube.com/iframe_api";const t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(n,t),window.onYouTubeIframeAPIReady=()=>{e()}}),_t)}async function ii(){const e=se("TubeStream",'<div class="p-2 h-full flex items-center justify-center">Loading...</div>',!1,"tubestream",!1,!1,{type:"integer",width:580,height:380},"default",null,"white");await Nn(e)}async function Nn(e){if(!e)return;const n=e.querySelector(".p-2");if(!n)return;if(!await Pr()){n.innerHTML=`<div style="display: flex; justify-content: center; align-items: center; height: 100%; flex-direction: column; text-align: center; padding: 20px; font-family: 'MS Sans Serif', sans-serif;">
      <p>Unable to connect to YouTube.</p>
      <p>You might be offline or there is a network error.</p>
    </div>`;return}let o=[];try{const a=await fetch(`${Dt}${Go}`);if(!a.ok)throw new Error("Network response was not ok");o=(await a.json()).playlists}catch(a){console.warn("Error fetching playlist, using fallback:",a),o=zr.playlists}if(!o||o.length===0){n.innerHTML='<div class="p-4 text-center">No content available.</div>';return}e.tubeStreamState={playlistData:o,currentIndex:0,player:null},await Fr(),n.innerHTML="",n.style.padding="0",n.style.height="100%",n.style.overflow="hidden";const i=`player-${Date.now()}-${Math.floor(Math.random()*1e3)}`,r=document.createElement("div");r.id=i,n.appendChild(r),ri(e)}function ri(e){const n=e.tubeStreamState;if(!n||!n.playlistData)return;const t=n.playlistData[n.currentIndex];let o={autoplay:1,controls:1,rel:0,fs:1,enablejsapi:1};if(t.custom_parameters){const a=new URLSearchParams(t.custom_parameters.replace(/&amp;/g,"&"));for(const[s,l]of a)s!=="loop"&&(o[s]=l==="true"?1:l==="false"?0:l)}let i=null,r=null;if(t.type==="single"||t.type==="livestream"?i=t.video_id:(i=t.beginning_video_id,r=t.playlist_id),n.player&&typeof n.player.loadVideoById=="function")r?n.player.loadPlaylist({list:r,listType:"playlist",index:0,startSeconds:0}):n.player.loadVideoById(i);else{const a={height:"100%",width:"100%",playerVars:o,events:{onStateChange:s=>$r(s,e)}};r?(a.playerVars.listType="playlist",a.playerVars.list=r,i&&(a.videoId=i)):a.videoId=i,n.player=new YT.Player(e.querySelector("div").id,a)}}function $r(e,n){if(e.data===YT.PlayerState.ENDED){const t=n.tubeStreamState;if(t.playlistData[t.currentIndex].type==="playlist"){const i=t.player;if(i&&i.getPlaylist){const r=i.getPlaylist(),a=i.getPlaylistIndex();r&&a===r.length-1&&An(n)}else An(n)}else An(n)}}function An(e){const n=e.tubeStreamState;n.currentIndex++,n.currentIndex>=n.playlistData.length&&(n.currentIndex=0),ri(e)}function Pr(){return new Promise(e=>{const n=new Image;n.onload=()=>e(!0),n.onerror=()=>e(!1),n.src="https://img.youtube.com/vi/qhCsL1cx4Qc/default.jpg?"+new Date().getTime()})}const zr={playlists:[{id:"111",type:"playlist",name:"FUTV STREAM TEST",description:"This is a test of our public broadcast system. Please stand by.",playlist_id:"PLfznZzH31A46XXPSw2dcb-gqhMXcBMOHV",beginning_video_id:"qhCsL1cx4Qc",custom_parameters:"autoplay=true&loop=false"}]};async function ai(){const e=document.getElementById("watercolour");if(e){const i=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,a)=>getComputedStyle(a).zIndex>getComputedStyle(r).zIndex?a:r);e.style.zIndex=`${parseInt(i.style.zIndex)+1}`;return}const n=li();se("Watercolour",n,!1,"watercolour",!1,!1,{type:"integer",width:700,height:440},"app",null,"white").setAttribute("data-disable-desktop-pan","true"),si()}async function si(e){await ci()}function li(){return`
<div id="watercolour-container" style="background-color: #f3f4f6; position: relative; height: calc(100% - 0.25rem); margin-top: -0.5rem; margin: 0; padding: 0;">
  <!-- Top Menu Bar -->
  <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background-color: white; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); border-bottom: 1px solid #e5e7eb;">
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <!-- File Dropdown Menu -->
      <div style="position: relative;">
        <button id="fileMenuBtn" style="padding: 0.25rem 0.75rem; border-radius: 0.25rem; border: 1px solid #d1d5db; background-color: white; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'" onclick="toggleFileDropdown(event)">
          File
          <svg style="width: 0.75rem; height: 0.75rem; pointer-events: none;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div id="fileDropdown" style="position: absolute; left: 0; top: 100%; margin-top: 0.25rem; width: 10rem; background-color: white; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 50; display: none;">
          <button id="loadBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; border-bottom: 1px solid #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">Open...</button>
          <button id="newBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; border-bottom: 1px solid #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">New</button>
          <button id="saveAsBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; border-bottom: 1px solid #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">Save</button>
          <button id="exportBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">Export...</button>
        </div>
      </div>

      <button id="undoBtn" style="padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #d1d5db; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">
        <svg style="height: 1rem; width: 1rem; display: inline;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
          <path style="opacity: 0.4;" d="M97.6 97.6c87.5-87.5 229.3-87.5 316.8 0C458.1 141.3 480 198.7 480 256s-21.9 114.7-65.6 158.4c-87.5 87.5-229.3 87.5-316.8 0l45.3-45.3c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L97.6 97.6z" />
          <path d="M176 224l24-24L40 40 16 64l0 160H176z" />
        </svg>
        Undo
      </button>
      <button id="redoBtn" style="padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #d1d5db; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">
        <svg style="height: 1rem; width: 1rem; display: inline;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
          <path style="opacity: 0.4;" d="M32 256c0 57.3 21.9 114.7 65.6 158.4c87.5 87.5 229.3 87.5 316.8 0l-45.3-45.3c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3s163.8-62.5 226.3 0c15.1-15.1 30.2-30.2 45.3-45.3c-87.5-87.5-229.3-87.5-316.8 0C53.9 141.3 32 198.7 32 256z" />
          <path d="M336 224l-24-24L472 40l24 24 0 160H336z" />
        </svg>
        Redo
      </button>
    </div>
    <div id="status" style="font-size: 0.75rem; color: #6b7280;">
      Tool: Brush | x: 0, y: 0
    </div>
  </div>

  <!-- Main Content Area -->
  <div style="display: flex;">
    <!-- Left Toolbar -->
    <div style="width: 3rem; padding: 0.5rem; background-color: white; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; gap: 0.5rem;">
      <button data-tool="brush" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='#f3f4f6'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/brush.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Brush</span>
      </button>
      <button data-tool="line" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/line.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Line</span>
      </button>
      <button data-tool="rectangle" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/rectangle.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Rectangle</span>
      </button>
      <button data-tool="ellipse" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/ellipse.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Ellipse</span>
      </button>
      <button data-tool="eraser" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/eraser.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Eraser</span>
      </button>
      <button data-tool="fill" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/fill.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Fill</span>
      </button>
      <button data-tool="picker" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/picker.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Picker</span>
      </button>
    </div>

    <!-- Canvas Container -->
    <div style="flex: 1; position: relative;">
      <canvas id="watercolourCanvas" width="420" height="300" style="background: white; margin: 0.5rem; margin-bottom: 2rem; position: absolute; inset: 0; border: 1px solid #d1d5db;"></canvas>
    </div>

    <!-- Right Panel: Color Palette & Stroke Size -->
    <div style="width: 8rem; padding: 0.5rem; background-color: white; border-left: 1px solid #e5e7eb; display: flex; flex-direction: column; gap: 1rem;">
      <!-- Color Palette -->
      <div style="display: flex; flex-direction: column; gap: 0.5rem;">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.25rem;">
          <!-- 16 predefined colors -->
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #000000;" data-color="#000000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #808080;" data-color="#808080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #800000;" data-color="#800000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FF0000;" data-color="#FF0000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #808000;" data-color="#808000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FFFF00;" data-color="#FFFF00"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #008000;" data-color="#008000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #00FF00;" data-color="#00FF00"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #008080;" data-color="#008080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #00FFFF;" data-color="#00FFFF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #000080;" data-color="#000080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #0000FF;" data-color="#0000FF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #800080;" data-color="#800080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FF00FF;" data-color="#FF00FF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FFFFFF;" data-color="#FFFFFF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #C0C0C0;" data-color="#C0C0C0"></div>
        </div>
        <input id="colorPicker" type="color" style="width: 100%;" />
      </div>
      <!-- Stroke Size -->
      <div>
        <label for="strokeSize" style="font-size: 0.875rem;">Size</label>
        <input id="strokeSize" type="range" min="1" max="50" value="5" style="width: 100%;" aria-label="Brush stroke size" title="Adjust brush stroke size" />
      </div>
    </div>
  </div>

  <!-- Hidden text input for Text Tool -->
  <input type="text" id="textInput" style="position: absolute; border: 1px solid #9ca3af; padding: 0.25rem; display: none; font-size: 16px; line-height: 1; color: #000;" />
</div>
`}async function ci(){window.toggleFileDropdown=function(C){C.stopPropagation();const M=document.getElementById("fileDropdown");M&&(M.style.display=M.style.display==="none"?"block":"none")},document.addEventListener("click",function(C){const M=document.getElementById("fileDropdown"),O=document.getElementById("fileMenuBtn");M&&O&&!O.contains(C.target)&&!M.contains(C.target)&&(M.style.display="none")});const e=document.getElementById("watercolourCanvas"),n=e.getContext("2d",{willReadFrequently:!0});let t=null,o=!1,i="brush",r,a,s="#000000",l=5,d=null,c=null,m=null;const u=document.getElementById("textInput"),f=document.getElementById("strokeSize"),p=document.getElementById("colorPicker");let g=[],k=[];f.addEventListener("input",C=>{l=C.target.value,n.lineWidth=l,i==="text"&&u.style.display==="block"&&(u.style.fontSize=`${l*4}px`),Q().catch(console.error)}),p.addEventListener("change",C=>{s=C.target.value,n.strokeStyle=s,n.fillStyle=s,i==="text"&&u.style.display==="block"&&(u.style.color=s),Q().catch(console.error)}),window.addEventListener("resize",R),document.body.addEventListener("touchmove",C=>{o&&C.preventDefault()},{passive:!1}),document.addEventListener("wheel",C=>{o&&C.preventDefault()},{passive:!1}),document.querySelectorAll(".tool-btn").forEach(C=>{C.addEventListener("click",()=>{document.querySelectorAll(".tool-btn").forEach(M=>M.classList.remove("bg-gray-100")),C.classList.add("bg-gray-100"),i=C.getAttribute("data-tool"),e.style.cursor=`url("./image/watercolour-icons/resized_${i}.png"), auto`,Q().catch(console.error)})}),document.getElementById("strokeSize").addEventListener("input",C=>{l=C.target.value,n.lineWidth=l}),document.getElementById("colorPicker").addEventListener("change",C=>{s=C.target.value,n.strokeStyle=s,n.fillStyle=s}),document.querySelectorAll("[data-color]").forEach(C=>{C.addEventListener("click",()=>{s=C.getAttribute("data-color"),n.strokeStyle=s,n.fillStyle=s,document.getElementById("colorPicker").value=s,Q().catch(console.error)})});let v=0;const y=3;function P(){if(v++,v>y){j();return}const C=document.getElementById("fileMenuBtn"),M=document.getElementById("fileDropdown"),O=document.getElementById("saveAsBtn");if(C&&M&&O){K();return}setTimeout(P,200)}function j(){const C=document.getElementById("loadBtn"),M=document.getElementById("newBtn"),O=document.getElementById("exportBtn");if(!C||!M||!O){console.error("Could not find expected buttons");return}C.addEventListener("click",()=>{Y()}),M.addEventListener("click",()=>{showDialogBox("Clear canvas? Unsaved work will be lost.","confirmation",()=>{const S=e.offsetWidth,E=e.offsetHeight;n.clearRect(0,0,S,E),n.fillStyle="white",n.fillRect(0,0,S,E),d=e.toDataURL(),T(),m=null})}),O.addEventListener("click",()=>{const S=document.createElement("a");S.download="drawing.png",S.href=e.toDataURL(),S.click()})}function K(){const C=document.getElementById("fileMenuBtn"),M=document.getElementById("fileDropdown"),O=document.getElementById("saveAsBtn"),S=document.getElementById("loadBtn"),E=document.getElementById("newBtn"),$=document.getElementById("exportBtn");C.addEventListener("click",w=>{w.stopPropagation(),M.classList.toggle("hidden")}),document.addEventListener("click",w=>{!C.contains(w.target)&&!M.contains(w.target)&&M.classList.add("hidden")}),M.addEventListener("click",()=>{M.classList.add("hidden")}),O.addEventListener("click",async()=>{await W()}),S.addEventListener("click",()=>{Y()}),E.addEventListener("click",()=>{showDialogBox("Clear canvas? Unsaved work will be lost.","confirmation",()=>{const w=e.offsetWidth,L=e.offsetHeight;n.clearRect(0,0,w,L),n.fillStyle="white",n.fillRect(0,0,w,L),d=e.toDataURL(),T()})}),$.addEventListener("click",()=>{const w=document.createElement("a");w.download="drawing.png",w.href=e.toDataURL(),w.click()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",P):P(),e.addEventListener("pointerdown",C=>{C.preventDefault();const M=z(C);if(r=M.x,a=M.y,i==="fill"){T(),b(M.x,M.y,s),d=e.toDataURL(),T();return}if(o=!0,i==="brush"||i==="eraser")n.beginPath(),n.moveTo(r,a);else if(["line","rectangle","ellipse"].includes(i))c=document.createElement("canvas"),c.width=e.width,c.height=e.height,c.getContext("2d").drawImage(e,0,0);else if(i==="text"){const O=z(C);if(u.style.display==="block"){Z();return}const S=e.getBoundingClientRect();u.style.left=S.left+O.x+"px",u.style.top=S.top+O.y+"px",u.style.display="block",u.style.fontSize=`${l*4}px`,u.style.color=s,u.dataset.x=O.x,u.dataset.y=O.y,setTimeout(()=>{u.focus(),u.onblur=Z},0),u.onkeydown=E=>{E.key==="Enter"&&Z()}}}),e.addEventListener("pointermove",C=>{const M=z(C);if(_(M.x,M.y),!!o){if(C.preventDefault(),i==="brush")n.lineTo(M.x,M.y),n.stroke();else if(i==="eraser")n.strokeStyle="white",n.lineTo(M.x,M.y),n.stroke(),n.strokeStyle=s;else if(["line","rectangle","ellipse"].includes(i)){const O=e.offsetWidth,S=e.offsetHeight;n.clearRect(0,0,O,S),c&&n.drawImage(c,0,0,O,S),J(M.x,M.y)}}}),e.addEventListener("pointerup",C=>{const M=z(C);o&&["line","rectangle","ellipse"].includes(i)&&J(M.x,M.y,!0),o=!1,d=e.toDataURL(),T(),c=null}),e.addEventListener("click",C=>{const M=z(C);if(i==="picker"){const O=window.devicePixelRatio||1,S=n.getImageData(Math.floor(M.x*O),Math.floor(M.y*O),1,1).data;s=A(S[0],S[1],S[2]),n.strokeStyle=s,n.fillStyle=s,document.getElementById("colorPicker").value=s,Q().catch(console.error)}}),document.getElementById("undoBtn").addEventListener("click",()=>{if(g.length>1){const C=g.pop();k.push(C);const M=g[g.length-1];q(M),d=M,Q().catch(console.error)}}),document.getElementById("redoBtn").addEventListener("click",()=>{if(k.length){const C=k.pop();g.push(C),q(C),d=C,Q().catch(console.error)}});function T(){const C=e.toDataURL();g.push(C),d=C,k=[],Q().catch(console.error)}function q(C){const M=new Image;M.src=C,M.alt="Watercolour painting canvas state",M.onload=()=>{const O=e.offsetWidth,S=e.offsetHeight;n.clearRect(0,0,O,S),n.drawImage(M,0,0,O,S)}}function z(C){const M=e.getBoundingClientRect();return{x:C.clientX-M.left,y:C.clientY-M.top}}function R(){const C=window.devicePixelRatio||1,M=e.offsetWidth,O=e.offsetHeight;if(n.getImageData(0,0,e.width,e.height),e.width=M*C,e.height=O*C,e.style.width=M+"px",e.style.height=O+"px",n.setTransform(C,0,0,C,0,0),d){const S=new Image;S.src=d,S.alt="Saved watercolour painting for canvas restoration",S.onload=()=>{n.clearRect(0,0,M,O),n.drawImage(S,0,0,M,O)}}else n.fillStyle="white",n.fillRect(0,0,M,O)}function _(C,M){const O=document.getElementById("status");O.textContent=`Tool: ${i.charAt(0).toUpperCase()+i.slice(1)} | x: ${Math.floor(C)}, y: ${Math.floor(M)}`}function Z(){const C=parseFloat(u.dataset.x),M=parseFloat(u.dataset.y),O=u.value;u.style.display="none",u.value="",u.onblur=null,n.fillStyle=s,n.font=`${l*4}px sans-serif`,n.textBaseline="top",n.fillText(O,C,M),T()}function J(C,M,O=!1){const S=r,E=a,$=C-r,w=M-a;n.lineWidth=l,n.strokeStyle=s,n.fillStyle=s,i==="line"?(n.beginPath(),n.moveTo(S,E),n.lineTo(C,M),n.stroke()):i==="rectangle"?n.strokeRect(S,E,$,w):i==="ellipse"&&(n.beginPath(),n.ellipse(S+$/2,E+w/2,Math.abs($/2),Math.abs(w/2),0,0,Math.PI*2),n.stroke())}function b(C,M,O){const S=window.devicePixelRatio||1,E=e.width,$=e.height,w=n.getImageData(0,0,E,$),L=w.data,I=x(O),U=I.r,ne=I.g,te=I.b,H=Math.floor(C*S),ye=Math.floor(M*S),fe=(ye*E+H)*4,Le=L[fe],Me=L[fe+1],Oe=L[fe+2],tt=L[fe+3];if(Le===U&&Me===ne&&Oe===te)return;const rt=[[H,ye]];for(;rt.length;){const[Te,at]=rt.pop();let Fe=at;for(;Fe>=0&&h(L,Te,Fe,E,Le,Me,Oe,tt);)Fe--;Fe++;let yt=!1,ht=!1;for(;Fe<$&&h(L,Te,Fe,E,Le,Me,Oe,tt);){const st=(Fe*E+Te)*4;L[st]=U,L[st+1]=ne,L[st+2]=te,L[st+3]=255,Te>0&&(h(L,Te-1,Fe,E,Le,Me,Oe,tt)?yt||(rt.push([Te-1,Fe]),yt=!0):yt=!1),Te<E-1&&(h(L,Te+1,Fe,E,Le,Me,Oe,tt)?ht||(rt.push([Te+1,Fe]),ht=!0):ht=!1),Fe++}}n.putImageData(w,0,0)}function h(C,M,O,S,E,$,w,L){const I=(O*S+M)*4;return C[I]===E&&C[I+1]===$&&C[I+2]===w&&C[I+3]===L}function x(C){C=C.replace(/^#/,"");let M=parseInt(C,16);return C.length===3?{r:(M>>8)*17,g:(M>>4&15)*17,b:(M&15)*17}:{r:M>>16&255,g:M>>8&255,b:M&255}}function A(C,M,O){return"#"+((1<<24)+(C<<16)+(M<<8)+O).toString(16).slice(1)}async function W(){try{const C=e.toDataURL("image/png"),M=globalStorage,O=globalAddFileToFileSystem;if(!M){showDialogBox("Cannot access storage. Please ensure the main OS is loaded.","error");return}const S=Date.now(),E=`watercolour_drawing_${S}`;await M.setItem(E,C),makeWin95Prompt("Enter a filename for your drawing:",`drawing_${S}.png`,async $=>{if($){const w=$.endsWith(".png")?$:$+".png",L=we();if(O){const I=C.split(",")[1],U=atob(I),ne=new Uint8Array(U.length);for(let fe=0;fe<U.length;fe++)ne[fe]=U.charCodeAt(fe);const te=new Blob([ne],{type:"image/png"}),H=new File([te],w,{type:"image/png"}),ye=await O(w,C,L,"png",H);m={name:w,path:L,storageKey:E,data:C},refreshExplorerViews&&refreshExplorerViews(),L==="C://Desktop"&&renderDesktopIcons&&renderDesktopIcons(),showDialogBox(`Drawing saved as "${w}" in ${L}!`,"info")}else showDialogBox("File system not available. Drawing saved to storage only.","info")}else showDialogBox("Drawing saved to storage but not added to file system.","info")},()=>{showDialogBox("Drawing saved to storage but not added to file system.","info")})}catch(C){console.error("Error saving drawing:",C),showDialogBox("Error saving drawing: "+C.message,"error")}}function Y(){if(openFileExplorerForImageSelection)openFileExplorerForImageSelection((C,M)=>{C&&ie(C,M)});else if(se&&getExplorerWindowContent){window.watercolourLoadCallback=(M,O)=>{M&&ie(M,O)};const C=getExplorerWindowContent("C://Documents");se("Select Image - File Explorer",C,!0,"explorer-watercolour-load",!1,!1,{type:"integer",width:600,height:500},"file-explorer"),showDialogBox("Select an image file from the file explorer to load it onto the canvas.","info")}else showDialogBox("File explorer not available. Please ensure the main OS is loaded.","error")}function ie(C,M=null){const O=new Image;O.alt="Image to be loaded onto watercolour canvas",O.onload=()=>{const S=e.offsetWidth,E=e.offsetHeight;n.clearRect(0,0,S,E),n.fillStyle="white",n.fillRect(0,0,S,E);const $=Math.min(S/O.width,E/O.height),w=O.width*$,L=O.height*$,I=(S-w)/2,U=(E-L)/2;n.drawImage(O,I,U,w,L),d=e.toDataURL(),T()},O.onerror=()=>{console.error("Error loading selected image."),showDialogBox("Error loading selected image.","error")},O.src=C,O.alt="User-selected image to import into watercolour canvas"}function we(){if(parent&&parent.document){const C=parent.document.querySelectorAll(".file-explorer-window");if(C.length>0){const O=C[C.length-1].getAttribute("data-current-path");if(O)return O}}return"C://Documents"}async function Q(){try{const C={currentTool:i,activeColor:s,strokeSize:l,canvasData:e.toDataURL(),currentFile:m,undoStack:g.slice(-10),redoStack:k.slice(-10)};await storage.setItem("watercolour_state",C)}catch(C){console.warn("Failed to save Watercolour state:",C);try{const M={currentTool:i,activeColor:s,strokeSize:l,canvasData:e.toDataURL(),currentFile:m,undoStack:g.slice(-10),redoStack:k.slice(-10)};storage.setItemSync("watercolour_state",M)}catch(M){console.error("Failed to save Watercolour state with fallback:",M)}}}async function ee(){try{const C=await storage.getItem("watercolour_state");if(C)return C}catch(C){console.warn("Failed to load Watercolour state:",C);try{const M=storage.getItemSync("watercolour_state");if(M)return M}catch(M){console.warn("Failed to load Watercolour state with fallback:",M)}}return null}async function he(){t=await ee(),t&&(i=t.currentTool||"brush",s=t.activeColor||"#000000",l=t.strokeSize||5,m=t.currentFile||null,g=t.undoStack||[],k=t.redoStack||[]);const C=window.devicePixelRatio||1,M=e.offsetWidth,O=e.offsetHeight;e.width=M*C,e.height=O*C,e.style.width=M+"px",e.style.height=O+"px",n.setTransform(C,0,0,C,0,0),f&&(f.value=l),p&&(p.value=s),n.strokeStyle=s,n.fillStyle=s,n.lineWidth=l,document.querySelectorAll(".tool-btn").forEach(E=>{E.classList.remove("bg-gray-100"),E.getAttribute("data-tool")===i&&E.classList.add("bg-gray-100")});const S=t==null?void 0:t.canvasData;if(S){const E=new Image;E.alt="Saved watercolour canvas state for restoration",E.onload=function(){n.clearRect(0,0,M,O),n.drawImage(E,0,0,M,O)},E.src=S}else n.fillStyle="white",n.fillRect(0,0,M,O),T()}await he()}function Nr(e,n){const t={C:"Clear all",CE:"Clear entry","¬±":"Change sign","‚àö":"Square root","%":"Percent","1/x":"Reciprocal","=":"Equals","+":"Plus","-":"Minus","√ó":"Multiply","√∑":"Divide",".":"Decimal point"};return t[e]?t[e]:n==="number"?`Number ${e}`:n==="operator"?`Operator ${e}`:e}function di(){const e=document.getElementById("calculator");if(e){const o=[...document.querySelectorAll("*")].filter(i=>getComputedStyle(i).zIndex>100&&getComputedStyle(i).zIndex<1e3).reduce((i,r)=>getComputedStyle(r).zIndex>getComputedStyle(i).zIndex?r:i);e.style.zIndex=`${parseInt(o.style.zIndex)+1}`;return}const n=se("Calculator","",!1,"calculator",!1,!1,{type:"integer",width:250,height:360},"App",null,"gray-100");ui(n).catch(t=>{console.error("Error initializing Calculator:",t)})}async function ui(e){const n=e.querySelector(".p-2");n.className="p-4 bg-gray-100 h-full overflow-hidden",n.innerHTML="";let t=await Rr();t||(t={display:"0",previousValue:null,operation:null,waitingForOperand:!1});const o=document.createElement("div");o.className="flex flex-col h-full space-y-1 pb-6";const i=document.createElement("div");i.className="bg-white border-2 p-2 mb-2",i.style.borderTopColor="#808080",i.style.borderLeftColor="#808080",i.style.borderBottomColor="#ffffff",i.style.borderRightColor="#ffffff";const r=document.createElement("div");r.id="calc-display",r.className="text-right text-lg font-mono bg-white text-black min-h-6 px-1",r.textContent=t.display,i.appendChild(r);const a=document.createElement("div");a.className="grid grid-cols-4 gap-1 flex-1",[{text:"C",type:"clear",className:"col-span-2"},{text:"¬±",type:"sign"},{text:"/",type:"operator"},{text:"7",type:"number"},{text:"8",type:"number"},{text:"9",type:"number"},{text:"*",type:"operator"},{text:"4",type:"number"},{text:"5",type:"number"},{text:"6",type:"number"},{text:"-",type:"operator"},{text:"1",type:"number"},{text:"2",type:"number"},{text:"3",type:"number"},{text:"+",type:"operator"},{text:"0",type:"number",className:"col-span-2"},{text:".",type:"decimal"},{text:"=",type:"equals"}].forEach(f=>{const p=document.createElement("button");p.textContent=f.text,p.className=`bg-gray-200 border-2 hover:bg-gray-300 font-mono text-sm py-2 select-none ${f.className||""}`,p.style.borderTopColor="#ffffff",p.style.borderLeftColor="#ffffff",p.style.borderBottomColor="#808080",p.style.borderRightColor="#808080",p.style.transition="none";const g=Nr(f.text,f.type);p.setAttribute("aria-label",g),p.setAttribute("title",g),p.addEventListener("mousedown",()=>{p.style.borderTopColor="#808080",p.style.borderLeftColor="#808080",p.style.borderBottomColor="#ffffff",p.style.borderRightColor="#ffffff",p.classList.add("bg-gray-300")}),p.addEventListener("mouseup",()=>{p.style.borderTopColor="#ffffff",p.style.borderLeftColor="#ffffff",p.style.borderBottomColor="#808080",p.style.borderRightColor="#808080",p.classList.remove("bg-gray-300")}),p.addEventListener("mouseleave",()=>{p.style.borderTopColor="#ffffff",p.style.borderLeftColor="#ffffff",p.style.borderBottomColor="#808080",p.style.borderRightColor="#808080",p.classList.remove("bg-gray-300")}),p.addEventListener("click",async()=>await d(f.text,f.type)),a.appendChild(p)}),o.appendChild(i),o.appendChild(a),n.appendChild(o);async function l(){r.textContent=t.display,await Wr(t)}async function d(f,p){switch(p){case"number":t.waitingForOperand?(t.display=f,t.waitingForOperand=!1):t.display=t.display==="0"?f:t.display+f;break;case"decimal":t.waitingForOperand?(t.display="0.",t.waitingForOperand=!1):t.display.indexOf(".")===-1&&(t.display+=".");break;case"clear":t.display="0",t.previousValue=null,t.operation=null,t.waitingForOperand=!1;break;case"sign":t.display!=="0"&&(t.display=t.display.charAt(0)==="-"?t.display.slice(1):"-"+t.display);break;case"operator":const g=parseFloat(t.display);if(t.previousValue===null)t.previousValue=g;else if(t.operation){const v=t.previousValue||0,y=c(v,g,t.operation);t.display=String(y),t.previousValue=y}t.waitingForOperand=!0,t.operation=f;break;case"equals":const k=parseFloat(t.display);if(t.previousValue!==null&&t.operation){const v=t.previousValue||0,y=c(v,k,t.operation);t.display=String(y),t.previousValue=null,t.operation=null,t.waitingForOperand=!0}break}await l()}function c(f,p,g){switch(g){case"+":return f+p;case"-":return f-p;case"*":return f*p;case"/":return p!==0?f/p:0;default:return p}}async function m(f){const p=f.key;/[0-9]/.test(p)?await d(p,"number"):["+","-","*","/"].includes(p)?await d(p,"operator"):p==="."?await d(p,"decimal"):p==="Enter"||p==="="?await d("=","equals"):p==="Escape"||p==="c"||p==="C"?await d("C","clear"):p==="Backspace"&&(t.display.length>1?t.display=t.display.slice(0,-1):t.display="0",await l())}document.addEventListener("keydown",m);const u=new MutationObserver(f=>{f.forEach(p=>{p.removedNodes.forEach(g=>{g.id==="calculator"&&(document.removeEventListener("keydown",m),u.disconnect())})})});u.observe(document.getElementById("windows-container"),{childList:!0})}async function Wr(e){try{await B.setItem("calculator_state",e)}catch(n){console.warn("Failed to save Calculator state:",n)}}async function Rr(){try{const e=await B.getItem("calculator_state");if(e)return e}catch(e){console.warn("Failed to load Calculator state:",e)}return null}function pi(){const e=document.getElementById("solitaire");if(e){const o=[...document.querySelectorAll("*")].filter(i=>getComputedStyle(i).zIndex>100&&getComputedStyle(i).zIndex<1e3).reduce((i,r)=>getComputedStyle(r).zIndex>getComputedStyle(i).zIndex?r:i);e.style.zIndex=`${parseInt(o.style.zIndex)+1}`;return}const n=se("Solitaire","",!1,"solitaire",!1,!1,{type:"integer",width:700,height:500},"App",null,"green");fi(n).catch(console.error)}async function fi(e){const n=e.querySelector(".p-2");n.className="p-2 bg-green-600 h-full overflow-hidden",n.style.backgroundImage="radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1) 0%, transparent 50%)",n.innerHTML="";let t=await Or();t||(t={deck:[],waste:[],foundations:[[],[],[],[]],tableaus:[[],[],[],[],[],[],[]],score:0,moves:0,time:0,gameStarted:!1,selectedCard:null,selectedPile:null,dragElement:null,drawCount:1});let o=null,i=await B.getItem("solitaire-high-score")||0;const r=["‚ô†","‚ô£","‚ô•","‚ô¶"],a=["A","2","3","4","5","6","7","8","9","10","J","Q","K"],s={"‚ô†":"black","‚ô£":"black","‚ô•":"red","‚ô¶":"red"},l=document.createElement("div");l.className="flex flex-col h-full";const d=document.createElement("div");d.className="bg-gray-200 border-b border-gray-400 p-1 flex items-center space-x-4";const c=document.createElement("button");c.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",c.textContent="Game",c.setAttribute("aria-label","Game menu options"),c.setAttribute("title","Access game options and settings");const m=document.createElement("button");m.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",m.textContent="New Game",m.setAttribute("aria-label","Start new solitaire game"),m.setAttribute("title","Start a new game of solitaire"),m.addEventListener("click",he);const u=document.createElement("select");u.className="ml-2 text-sm border rounded p-1 bg-white";const f=document.createElement("option");f.value="1",f.text="Easy (Draw 1)";const p=document.createElement("option");p.value="3",p.text="Normal (Draw 3)",u.appendChild(f),u.appendChild(p),u.title="Select difficulty / draw count",u.value=t.drawCount?String(t.drawCount):"1",u.addEventListener("change",S=>{t.drawCount=parseInt(S.target.value,10),Ye(t).catch(console.error)});const g=document.createElement("div");g.className="text-sm font-mono ml-auto flex space-x-4",g.innerHTML=`<span>Score: <span id="score">0</span></span><span>High: <span id="high-score">${i}</span></span><span>Time: <span id="time">0:00</span></span>`,d.appendChild(m),d.appendChild(u),d.appendChild(g);const k=document.createElement("div");k.className="flex-1 p-4 relative overflow-scroll",k.id="solitaire-game-area";const v=document.createElement("div");v.className="lg:flex justify-between mb-6";const y=document.createElement("div");y.className="flex space-x-4 mb-4 lg:mb-0";const P=document.createElement("div");P.className="w-16 h-24 border-2 border-gray-400 rounded bg-blue-800 flex items-center justify-center cursor-pointer",P.style.borderStyle="outset",P.id="deck-slot",P.addEventListener("click",Z);const j=document.createElement("div");j.className="w-16 h-24 border-2 border-gray-400 rounded bg-green-700 relative",j.style.borderStyle="inset",j.id="waste-slot",y.appendChild(P),y.appendChild(j);const K=document.createElement("div");K.className="flex space-x-2";for(let S=0;S<4;S++){const E=document.createElement("div");E.className="w-16 h-24 border-2 border-gray-400 rounded bg-green-700 relative",E.style.borderStyle="inset",E.id=`foundation-${S}`,E.dataset.foundationIndex=S,E.addEventListener("click",$=>void 0),K.appendChild(E)}v.appendChild(y),v.appendChild(K);const T=document.createElement("div");T.className="flex space-x-2";for(let S=0;S<7;S++){const E=document.createElement("div");E.className="w-16 min-h-32 relative",E.id=`tableau-${S}`,E.dataset.tableauIndex=S,E.addEventListener("click",$=>void 0),T.appendChild(E)}k.appendChild(v),k.appendChild(T),l.appendChild(d),l.appendChild(k),n.appendChild(l);function q(S,E,$=!0){const w=document.createElement("div");if(w.className="card absolute w-16 h-24 border border-gray-800 rounded bg-white cursor-pointer transition-all duration-200",w.style.fontSize="10px",w.style.fontFamily="ui-serif, Georgia, 'Cambria', 'Times New Roman', Times, serif",w.style.userSelect="none",w.style.pointerEvents="auto",w.dataset.suit=S,w.dataset.value=E,w.dataset.faceUp=$,$){const L=s[S];w.style.color=L,w.innerHTML=`
        <div class="p-1 h-full flex flex-col justify-between">
          <div class="flex justify-between">
            <span class="font-bold">${E}</span>
            <span class="text-lg">${S}</span>
          </div>
          <div class="text-center text-2xl">${S}</div>
          <div class="flex justify-between rotate-180">
            <span class="font-bold">${E}</span>
            <span class="text-lg">${S}</span>
          </div>
        </div>
      `}else w.style.background="linear-gradient(45deg, #000080, #0000cd)",w.style.color="white",w.innerHTML=`
        <div class="w-full h-full flex items-center justify-center text-xs">
          <div class="text-center">‚ô†‚ô•‚ô¶‚ô£</div>
        </div>
      `;return w.addEventListener("mousedown",J),w.addEventListener("touchstart",J,{passive:!1}),w.addEventListener("dblclick",h),w}function z(){t.deck=[];for(const S of r)for(const E of a)t.deck.push({suit:S,value:E});for(let S=t.deck.length-1;S>0;S--){const E=Math.floor(Math.random()*(S+1));[t.deck[S],t.deck[E]]=[t.deck[E],t.deck[S]]}}function R(){t.waste=[],t.foundations=[[],[],[],[]],t.tableaus=[[],[],[],[],[],[],[]];for(let S=0;S<7;S++)for(let E=0;E<=S;E++){const $=t.deck.pop();$.faceUp=E===S,t.tableaus[S].push($)}_(),Ye(t).catch(console.error)}function _(){document.querySelectorAll(".card").forEach($=>$.remove());const S=document.getElementById("deck-slot");t.deck.length>0?(S.innerHTML="üÇ†",S.style.fontSize="40px",S.style.color="white"):(S.innerHTML="‚Üª",S.style.fontSize="24px",S.style.color="white");const E=document.getElementById("waste-slot");if(E.innerHTML="",t.waste.length>0){const $=t.waste[t.waste.length-1],w=q($.suit,$.value,!0);w.classList.add("card"),w.style.position="absolute",w.style.top="0",w.style.left="0",E.appendChild(w)}for(let $=0;$<4;$++){const w=document.getElementById(`foundation-${$}`);w.innerHTML="";const L=r[$];if(w.innerHTML=`<div class="absolute inset-0 flex items-center justify-center text-4xl text-gray-500 opacity-30">${L}</div>`,t.foundations[$].length>0){const I=t.foundations[$][t.foundations[$].length-1],U=q(I.suit,I.value,!0);U.classList.add("card"),U.style.position="absolute",U.style.top="0",U.style.left="0",w.appendChild(U)}}for(let $=0;$<7;$++){const w=document.getElementById(`tableau-${$}`);w.innerHTML="",t.tableaus[$].length===0&&(w.innerHTML='<div class="w-16 h-24 border-2 border-gray-400 border-dashed rounded bg-green-700 opacity-50"></div>'),t.tableaus[$].forEach((L,I)=>{const U=q(L.suit,L.value,L.faceUp);U.classList.add("card"),U.style.position="absolute",U.style.top=`${I*20}px`,U.style.left="0",U.style.zIndex=I+1,U.dataset.tableauIndex=$,U.dataset.cardIndex=I,w.appendChild(U)})}ee()}function Z(){const S=t.drawCount||1;if(t.deck.length>0){for(let E=0;E<S&&t.deck.length!==0;E++){const $=t.deck.pop();$.faceUp=!0,t.waste.push($)}t.moves++}else t.waste.length>0&&(t.deck=t.waste.reverse(),t.deck.forEach(E=>E.faceUp=!1),t.waste=[],t.moves++);_(),Ye(t).catch(console.error)}function J(S){let E=S.target;for(;E&&E!==document.body&&!(E.classList&&E.classList.contains("card"));)E=E.parentElement;if(!E||!E.classList.contains("card")||E.dataset.faceUp!=="true")return;S.preventDefault(),S.stopPropagation(),t.selectedCard=E,t.dragElement=E.cloneNode(!0),t.dragElement.style.position="fixed",t.dragElement.style.pointerEvents="none",t.dragElement.style.zIndex="1000",t.dragElement.style.transition="none",t.dragElement.style.left="0",t.dragElement.style.top="0";const $=S.type==="touchstart"?S.touches[0]:S,w=32,L=48;t.dragElement.style.transform=`translate3d(${$.clientX-w}px, ${$.clientY-L}px, 0) rotate(5deg)`,document.body.appendChild(t.dragElement),E.style.opacity="0.5";const I=document.body.style.touchAction;document.body.style.touchAction="none";let U=null;function ne(H){H.cancelable&&H.preventDefault();const ye=H.type&&H.type.startsWith("touch")?H.touches[0]:H;t.dragElement&&(U&&cancelAnimationFrame(U),U=requestAnimationFrame(()=>{t.dragElement&&(t.dragElement.style.transform=`translate3d(${ye.clientX-w}px, ${ye.clientY-L}px, 0) rotate(5deg)`)}))}function te(H){if(document.removeEventListener("mousemove",ne),document.removeEventListener("mouseup",te),document.removeEventListener("touchmove",ne),document.removeEventListener("touchend",te),U&&(cancelAnimationFrame(U),U=null),t.dragElement&&document.body.contains(t.dragElement)&&(document.body.removeChild(t.dragElement),t.dragElement=null),document.body.style.touchAction=I||"",t.selectedCard){t.selectedCard.style.opacity="1";const ye=H.type==="touchend"?H.changedTouches[0]:H,fe=document.elementFromPoint(ye.clientX,ye.clientY);b(fe),t.selectedCard=null}}document.addEventListener("mousemove",ne),document.addEventListener("mouseup",te),document.addEventListener("touchmove",ne,{passive:!1}),document.addEventListener("touchend",te)}function b(S){const E=t.selectedCard;if(!E||!S)return;let $=S,w=null,L=null;for(;$&&$!==document.body;){if($.id&&$.id.startsWith("foundation-")){w=$,L="foundation";break}if($.dataset&&$.dataset.tableauIndex!==void 0){w=$,L="tableau";break}if($.classList&&$.classList.contains("card")&&$.dataset.tableauIndex!==void 0){w=$.parentElement,L="tableau";break}$=$.parentElement}if(w&&L==="foundation"){const I=parseInt(w.dataset.foundationIndex);x(E,I)&&W(E)}else if(w&&L==="tableau"){const I=parseInt(w.dataset.tableauIndex);A(E,I)&&Y(E,I)}}function h(S){let E=S.target;for(;E&&!E.classList.contains("card");)E=E.parentElement;if(!(!E||E.dataset.faceUp!=="true")){for(let $=0;$<4;$++)if(x(E,$)){W(E);return}}}function x(S,E){const $=S.dataset.suit,w=S.dataset.value,L=t.foundations[E],I=r[E];if($!==I){const U=r.indexOf($);return U!==-1&&t.foundations[U].length===0?w==="A":!1}if(L.length===0)return w==="A";{const U=L[L.length-1],ne=a.indexOf(U.value);return a.indexOf(w)===ne+1}}function A(S,E){const $=S.dataset.suit,w=S.dataset.value,L=t.tableaus[E];if(L.length===0)return w==="K";const I=L[L.length-1];if(!I.faceUp)return!1;const U=s[I.suit],ne=s[$],te=a.indexOf(I.value),H=a.indexOf(w);return U!==ne&&H===te-1}function W(S,E){const $=S.dataset.suit,w=r.indexOf($);if(w===-1)return;ie(S);const L={suit:$,value:S.dataset.value,faceUp:!0};t.foundations[w].push(L),t.moves++,t.score+=10,_(),M(),Ye(t).catch(console.error)}function Y(S,E){const $=ie(S,!0);t.tableaus[E].push(...$),t.moves++,_(),Ye(t).catch(console.error)}function ie(S,E=!1){const $=S.dataset.suit,w=S.dataset.value;if(t.waste.length>0&&t.waste[t.waste.length-1].suit===$&&t.waste[t.waste.length-1].value===w)return[t.waste.pop()];for(let L=0;L<7;L++){const I=t.tableaus[L],U=I.findIndex(ne=>ne.suit===$&&ne.value===w);if(U!==-1){const ne=E?I.length-U:1,te=I.splice(U,ne);return I.length>0&&!I[I.length-1].faceUp&&(I[I.length-1].faceUp=!0,t.score+=5,Ye(t).catch(console.error)),te}}return[]}function we(S,E){}function Q(S,E){}function ee(){if(document.getElementById("score").textContent=t.score,t.gameStarted){const S=Math.floor(t.time/60),E=t.time%60;document.getElementById("time").textContent=`${S}:${E.toString().padStart(2,"0")}`}}function he(){t.score=0,t.moves=0,t.time=0,t.gameStarted=!0,o&&clearInterval(o),o=setInterval(()=>{t.time++,ee(),Ye(t).catch(console.error)},1e3),z(),R(),qr().catch(console.error)}function C(){t.gameStarted&&(o=setInterval(()=>{t.time++,ee(),Ye(t).catch(console.error)},1e3)),ee(),_()}function M(){t.foundations.reduce((E,$)=>E+$.length,0)===52&&(o&&clearInterval(o),Ye(t).catch(console.error),t.score>i&&(i=t.score,B.setItemSync("solitaire-high-score",i),document.getElementById("high-score").textContent=i,window.isDevvit&&window.parent.postMessage({type:"setGameScore",data:{game:"solitaire",score:i}},"*")),setTimeout(()=>{_r()},500))}const O=new MutationObserver(S=>{S.forEach(E=>{E.removedNodes.forEach($=>{$.id==="solitaire"&&(o&&clearInterval(o),O.disconnect())})})});O.observe(document.getElementById("windows-container"),{childList:!0}),!t.gameStarted||t.deck.length===0?he():C()}async function Ye(e){try{const n={...e,selectedCard:null,selectedPile:null,dragElement:null};await B.setItem("solitaire_gameState",n)}catch(n){console.warn("Failed to save Solitaire game state:",n);try{const t={...e,selectedCard:null,selectedPile:null,dragElement:null};B.setItemSync("solitaire_gameState",t)}catch(t){console.error("Failed to save Solitaire game state with fallback:",t)}}}async function Or(){try{const e=await B.getItem("solitaire_gameState");if(e){const n=e;return n.selectedCard=null,n.selectedPile=null,n.dragElement=null,n}}catch(e){console.warn("Failed to load Solitaire game state:",e);try{const n=B.getItemSync("solitaire_gameState");if(n){const t=n;return t.selectedCard=null,t.selectedPile=null,t.dragElement=null,t}}catch(n){console.warn("Failed to load Solitaire game state with fallback:",n)}}return null}async function qr(){try{await B.removeItem("solitaire_gameState")}catch(e){console.warn("Failed to clear Solitaire game state:",e);try{B.removeItemSync("solitaire_gameState")}catch(n){console.error("Failed to clear Solitaire game state with fallback:",n)}}}function _r(){const e=document.createElement("canvas");e.id="solitaire-win-canvas",Object.assign(e.style,{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",zIndex:9999,pointerEvents:"none"}),document.body.appendChild(e);const n=e.getContext("2d");e.width=window.innerWidth,e.height=window.innerHeight;const t=["‚ô†","‚ô•","‚ô£","‚ô¶"],o=["A","2","3","4","5","6","7","8","9","10","J","Q","K"],i={"‚ô†":"black","‚ô£":"black","‚ô•":"red","‚ô¶":"red"},r=[],a=.2,s=75,l=100,d=.02;let c=0,m,u=!0;const f=setInterval(()=>{if(c===52)return clearInterval(f);const g=t[c%4],k=o[Math.floor(c/4)];r.push({x:Math.random()*e.width,y:-50,vx:(Math.random()-.5)*4,vy:Math.random()*2,suit:g,value:k,color:i[g]}),c++},100);function p(){n.fillStyle=`rgba(10,100,10,${d})`,n.fillRect(0,0,e.width,e.height),r.forEach(g=>{g.vy+=a,g.x+=g.vx,g.y+=g.vy,g.y>e.height-l&&(g.y=e.height-l,g.vy*=-.7),n.fillStyle="white",n.fillRect(g.x,g.y,s,l),n.strokeStyle="#333",n.strokeRect(g.x,g.y,s,l),n.fillStyle=g.color,n.font="24px sans-serif",n.fillText(g.value+g.suit,g.x+10,g.y+30)}),u&&(m=requestAnimationFrame(p))}p(),setTimeout(()=>{u=!1,clearInterval(f),cancelAnimationFrame(m),document.body.removeChild(e),showDialogBox("Congratulations! You won!","confirmation")},8e3)}function mi(){const e=document.getElementById("chess");if(e){const o=[...document.querySelectorAll("*")].filter(i=>getComputedStyle(i).zIndex>100&&getComputedStyle(i).zIndex<1e3).reduce((i,r)=>getComputedStyle(r).zIndex>getComputedStyle(i).zIndex?r:i);e.style.zIndex=`${parseInt(o.style.zIndex)+1}`;return}const n=se("Guillotine Chess","",!1,"chess",!1,!1,{type:"integer",width:600,height:690},"App",null,"white");gi(n).catch(t=>{console.error("Error initializing Chess:",t)})}async function gi(e){const n=e.querySelector(".p-2");n.className="p-4 bg-white h-full overflow-hidden",n.innerHTML="";let t=await ta();t||(t={board:Io(),currentPlayer:"white",difficulty:"easy",gameOver:!1,winner:null,moveHistory:[],selectedSquare:null,possibleMoves:[],gameStarted:!0,enPassantTarget:null,halfMoveClock:0,fullMoveNumber:1});const o=document.createElement("div");o.className="flex flex-col h-full";const i=document.createElement("div");i.className="flex justify-between items-center mb-4 p-2 bg-gray-100 rounded",i.innerHTML=`
    <div class="flex items-center space-x-4">
      <span class="font-semibold">Difficulty: <span id="difficulty-dropdown-container"></span></span>
      <span class="font-semibold">Turn: <span class="text-${t.currentPlayer==="white"?"gray-800":"gray-600"}">${t.currentPlayer.charAt(0).toUpperCase()+t.currentPlayer.slice(1)}</span></span>
    </div>
    <div class="space-x-2" id="button-container">
    </div>
  `,o.appendChild(i);const a=oa([{value:"easy",text:"Easy"},{value:"medium",text:"Medium"},{value:"hard",text:"Hard"}],t.difficulty,async m=>{t.difficulty=m,await Qt(t)});a.id="difficulty-select",a.className+=" ml-1",i.querySelector("#difficulty-dropdown-container").appendChild(a);const s=na("New Game");s.id="new-game-btn",i.querySelector("#button-container").appendChild(s);const l=document.createElement("div");l.className="flex-1 flex items-center justify-center";const d=document.createElement("div");d.id="chess-board",d.className="grid grid-cols-8 border-4 border-gray-800",d.style.width="480px",d.style.height="480px",d.style.gap="0";for(let m=0;m<8;m++)for(let u=0;u<8;u++){const f=document.createElement("div");f.className=`chess-square flex items-center justify-center cursor-pointer text-4xl font-bold select-none ${(m+u)%2===0?"bg-amber-100":"bg-amber-600"}`,f.style.width="60px",f.style.height="60px",f.dataset.row=m,f.dataset.col=u;const p=t.board[m][u];p&&(f.textContent=yi(p),f.style.color=p.color==="white"?"#000":"#444"),f.addEventListener("click",async()=>await Hr(m,u,t,e)),d.appendChild(f)}l.appendChild(d),o.appendChild(l);const c=document.createElement("div");c.id="status-bar",c.className="mt-4 p-2 text-center",t.gameOver?c.innerHTML=`<span class="text-lg font-bold text-green-600">Game Over! ${t.winner?t.winner.charAt(0).toUpperCase()+t.winner.slice(1)+" wins!":"Draw!"}</span>`:c.innerHTML='<span class="text-gray-600">Guillotine Chess: Capture the King to win! Kings can be captured like any other piece.</span>',o.appendChild(c),i.querySelector("#new-game-btn").addEventListener("click",async()=>{t.board=Io(),t.currentPlayer="white",t.gameOver=!1,t.winner=null,t.moveHistory=[],t.selectedSquare=null,t.possibleMoves=[],await Qt(t),Zn(t,e)}),n.appendChild(o),Jt(t),t.currentPlayer==="black"&&!t.gameOver&&setTimeout(async()=>await vi(t,e),500)}function Zn(e,n){const t=n.querySelector("#difficulty-select");t&&(t.value=e.difficulty);const o=n.querySelector(".text-gray-800, .text-gray-600");o&&o.parentElement&&o.parentElement.textContent.includes("Turn:")&&(o.textContent=e.currentPlayer.charAt(0).toUpperCase()+e.currentPlayer.slice(1),o.className=e.currentPlayer==="white"?"text-gray-800":"text-gray-600"),document.querySelectorAll(".chess-square").forEach(a=>{const s=parseInt(a.dataset.row),l=parseInt(a.dataset.col),d=e.board[s][l];d?(a.textContent=yi(d),a.style.color=d.color==="white"?"#000":"#444"):a.textContent=""});const r=n.querySelector("#status-bar");r&&(e.gameOver?r.innerHTML=`<span class="text-lg font-bold text-green-600">Game Over! ${e.winner?e.winner.charAt(0).toUpperCase()+e.winner.slice(1)+" wins!":"Draw!"}</span>`:r.innerHTML='<span class="text-gray-600">Guillotine Chess: Capture the King to win! Kings can be captured like any other piece.</span>'),e.selectedSquare=null,e.possibleMoves=[],Jt(e),e.currentPlayer==="black"&&!e.gameOver&&setTimeout(async()=>await vi(e,n),500)}function Io(){const e=Array(8).fill(null).map(()=>Array(8).fill(null)),n=["rook","knight","bishop","queen","king","bishop","knight","rook"];for(let t=0;t<8;t++)e[0][t]={type:n[t],color:"black"},e[1][t]={type:"pawn",color:"black"};for(let t=0;t<8;t++)e[6][t]={type:"pawn",color:"white"},e[7][t]={type:n[t],color:"white"};return e}function yi(e){return{white:{king:"‚ôî",queen:"‚ôï",rook:"‚ôñ",bishop:"‚ôó",knight:"‚ôò",pawn:"‚ôô"},black:{king:"‚ôö",queen:"‚ôõ",rook:"‚ôú",bishop:"‚ôù",knight:"‚ôû",pawn:"‚ôü"}}[e.color][e.type]}async function Hr(e,n,t,o){if(t.gameOver||t.currentPlayer==="black")return;const i=t.board[e][n];if(t.selectedSquare){const[r,a]=t.selectedSquare;if(r===e&&a===n){t.selectedSquare=null,t.possibleMoves=[],Jt(t);return}if(t.possibleMoves.some(s=>s.row===e&&s.col===n)){zt(t,r,a,e,n),t.selectedSquare=null,t.possibleMoves=[],t.gameOver||(t.currentPlayer=t.currentPlayer==="white"?"black":"white"),await Qt(t),Si(t)&&(t.gameOver=!0,t.winner=Ci(t),Ii(t)),Zn(t,o);return}}i&&i.color===t.currentPlayer&&(t.selectedSquare=[e,n],t.possibleMoves=hi(t,e,n),Jt(t))}function Jt(e){document.querySelectorAll(".chess-square").forEach(t=>{const o=parseInt(t.dataset.row),i=parseInt(t.dataset.col);t.className=`chess-square flex items-center justify-center cursor-pointer text-4xl font-bold select-none ${(o+i)%2===0?"bg-amber-100":"bg-amber-600"}`,t.style.width="60px",t.style.height="60px",e.selectedSquare&&e.selectedSquare[0]===o&&e.selectedSquare[1]===i&&(t.className+=" bg-blue-300"),e.possibleMoves.some(r=>r.row===o&&r.col===i)&&(t.className+=" bg-green-300")})}function hi(e,n,t){const o=e.board[n][t];if(!o)return[];const i=[];switch(o.type){case"pawn":i.push(...jr(e.board,n,t,o.color)),i.push(...Ur(e,n,t));break;case"rook":i.push(...Jn(e.board,n,t,o.color));break;case"knight":i.push(...bi(e.board,n,t,o.color));break;case"bishop":i.push(...Qn(e.board,n,t,o.color));break;case"queen":i.push(...wi(e.board,n,t,o.color));break;case"king":i.push(...Yr(e.board,n,t,o.color));break}return i}function Ur(e,n,t){const o=e.board[n][t];if(o.type!=="pawn"||!e.enPassantTarget)return[];const i=[],r=o.color==="white"?-1:1,a=e.enPassantTarget.row,s=e.enPassantTarget.col;return n===a-r&&Math.abs(t-s)===1&&i.push({row:a,col:s}),i}function jr(e,n,t,o){const i=[],r=o==="white"?-1:1,a=o==="white"?6:1;Xe(n+r,t)&&!e[n+r][t]&&(i.push({row:n+r,col:t}),n===a&&!e[n+2*r][t]&&i.push({row:n+2*r,col:t}));for(const s of[-1,1]){const l=n+r,d=t+s;Xe(l,d)&&e[l][d]&&e[l][d].color!==o&&i.push({row:l,col:d})}return i}function Jn(e,n,t,o){const i=[],r=[[0,1],[0,-1],[1,0],[-1,0]];for(const[a,s]of r)for(let l=1;l<8;l++){const d=n+l*a,c=t+l*s;if(!Xe(d,c))break;if(!e[d][c])i.push({row:d,col:c});else{e[d][c].color!==o&&i.push({row:d,col:c});break}}return i}function bi(e,n,t,o){const i=[],r=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];for(const[a,s]of r){const l=n+a,d=t+s;Xe(l,d)&&(!e[l][d]||e[l][d].color!==o)&&i.push({row:l,col:d})}return i}function Qn(e,n,t,o){const i=[],r=[[1,1],[1,-1],[-1,1],[-1,-1]];for(const[a,s]of r)for(let l=1;l<8;l++){const d=n+l*a,c=t+l*s;if(!Xe(d,c))break;if(!e[d][c])i.push({row:d,col:c});else{e[d][c].color!==o&&i.push({row:d,col:c});break}}return i}function wi(e,n,t,o){return[...Jn(e,n,t,o),...Qn(e,n,t,o)]}function Yr(e,n,t,o){const i=[],r=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const[a,s]of r){const l=n+a,d=t+s;Xe(l,d)&&(!e[l][d]||e[l][d].color!==o)&&i.push({row:l,col:d})}return i}function Xe(e,n){return e>=0&&e<8&&n>=0&&n<8}function zt(e,n,t,o,i){const r=e.board[n][t],a=e.board[o][i];if(e.enPassantTarget=null,a&&a.type==="king"&&(e.gameOver=!0,e.winner=r.color),r.type==="pawn"&&t!==i&&!a){const s=r.color==="white"?o+1:o-1;e.board[s][i]=null}if(r.type==="pawn"&&Math.abs(o-n)===2){const s=r.color==="white"?o+1:o-1;e.enPassantTarget={row:s,col:i}}r.type==="pawn"&&(o===0||o===7)&&(r.type="queen"),r.type==="pawn"||a?e.halfMoveClock=0:e.halfMoveClock++,r.color==="black"&&e.fullMoveNumber++,e.board[o][i]=r,e.board[n][t]=null,e.moveHistory.push({from:{row:n,col:t},to:{row:o,col:i},piece:{...r},captured:a,enPassantTarget:e.enPassantTarget,halfMoveClock:e.halfMoveClock})}async function vi(e,n){let t;switch(e.difficulty){case"easy":t=Gr(e,"black");break;case"medium":t=Lo(e,"black",2);break;case"hard":t=Lo(e,"black",3);break}t&&(zt(e,t.from.row,t.from.col,t.to.row,t.to.col),e.gameOver||(e.currentPlayer="white"),Si(e)&&(e.gameOver=!0,e.winner=Ci(e),Ii(e)),await Qt(e),Zn(e,n))}function Gr(e,n){const t=Bt(e,n);return t.length>0?t[Math.floor(Math.random()*t.length)]:null}function Lo(e,n,t=2){const o=n,i=1e9;let r=null,a=-i;const s=ki(e,Bt(e,n));for(const l of s){const d=eo(e);zt(d,l.from.row,l.from.col,l.to.row,l.to.col),d.currentPlayer="white";const c=-xi(d,t-1,-i,i,"white",o);c>a&&(a=c,r=l)}return r}function xi(e,n,t,o,i,r){const s=it(e.board,r),l=it(e.board,"white");if(!s)return-1e9+(3-n);if(!l)return 1e9-(3-n);if(n===0)return Ao(e,r);const d=Bt(e,i);if(d.length===0)return(i===r?-1:1)*-10+Ao(e,r);let c=i===r?-1e9:1e9;const m=ki(e,d);for(const u of m){const f=eo(e);zt(f,u.from.row,u.from.col,u.to.row,u.to.col),f.currentPlayer=i==="white"?"black":"white";const p=xi(f,n-1,t,o,f.currentPlayer,r);if(i===r?(p>c&&(c=p),c>t&&(t=c)):(p<c&&(c=p),c<o&&(o=c)),t>=o)break}return c}function Bt(e,n){const t=[];for(let o=0;o<8;o++)for(let i=0;i<8;i++){const r=e.board[o][i];if(r&&r.color===n){const a=Xr(e,o,i);for(const s of a)t.push({from:{row:o,col:i},to:{row:s.row,col:s.col}})}}return t}function ki(e,n){const t=e.currentPlayer==="white"?"black":"white";return it(e.board,t),n.sort((o,i)=>Mo(e,i)-Mo(e,o))}function Mo(e,n){const t=e.board[n.from.row][n.from.col],o=e.board[n.to.row][n.to.col];let i=0;o&&(i+=10*Gt(o.type)-Gt(t.type)*.1),t.type==="pawn"&&(i+=.2*(t.color==="white"?7-n.to.row:n.to.row)),(t.type==="knight"||t.type==="bishop")&&(i+=.3),n.to.row>=2&&n.to.row<=5&&n.to.col>=2&&n.to.col<=5&&(i+=.2);const r=eo(e);zt(r,n.from.row,n.from.col,n.to.row,n.to.col),Mt(r,n.to.row,n.to.col,t.color)&&(i-=Math.min(1.5,Gt(t.type)*.6));const s=t.color==="white"?"black":"white",l=it(r.board,s);return l&&Mt(r,l.row,l.col,s)&&Mt(r,l.row,l.col,s),l&&Ei(r,n.to.row,n.to.col,l.row,l.col)&&(i+=1),i}function eo(e){return{board:e.board.map(n=>n.map(t=>t?{...t}:null)),currentPlayer:e.currentPlayer,difficulty:e.difficulty,gameOver:e.gameOver,winner:e.winner,moveHistory:e.moveHistory?[...e.moveHistory]:[],selectedSquare:null,possibleMoves:[],gameStarted:e.gameStarted,enPassantTarget:e.enPassantTarget?{...e.enPassantTarget}:null,halfMoveClock:e.halfMoveClock,fullMoveNumber:e.fullMoveNumber}}function Ao(e,n){let t=0;for(let l=0;l<8;l++)for(let d=0;d<8;d++){const c=e.board[l][d];if(!c)continue;const m=Gt(c.type),u=Kr(c,l,d),f=(c.color===n?1:-1)*(m+u);t+=f}const o=Bt(e,n).length,i="white",r=Bt(e,i).length;t+=.05*(o-r);const a=it(e.board,n),s=it(e.board,i);return a&&Mt(e,a.row,a.col,n)&&(t-=1.5),s&&Mt(e,s.row,s.col,i)&&(t+=1),t}function Kr(e,n,t){let o=0;return n>=2&&n<=5&&t>=2&&t<=5&&(o+=.2),e.type==="pawn"?o+=.05*(e.color==="white"?7-n:n):e.type==="knight"||e.type==="bishop"?o+=.1:(e.type==="rook"||e.type==="queen")&&(o+=.05),o}function Gt(e){return{pawn:1,knight:3,bishop:3,rook:5,queen:9,king:100}[e]||0}function Si(e){if(e.gameOver)return!0;let n=!1,t=!1;for(let o=0;o<8;o++)for(let i=0;i<8;i++){const r=e.board[o][i];r&&r.type==="king"&&(r.color==="white"&&(n=!0),r.color==="black"&&(t=!0))}return n?t?!1:(e.gameOver=!0,e.winner="white",!0):(e.gameOver=!0,e.winner="black",!0)}function Vr(e,n){const t=it(e.board,n);if(!t)return!1;const o=n==="white"?"black":"white";for(let i=0;i<8;i++)for(let r=0;r<8;r++){const a=e.board[i][r];if(a&&a.color===o&&Jr(e.board,i,r).some(l=>l.row===t.row&&l.col===t.col))return!0}return!1}function it(e,n){for(let t=0;t<8;t++)for(let o=0;o<8;o++){const i=e[t][o];if(i&&i.type==="king"&&i.color===n)return{row:t,col:o}}return null}function Xr(e,n,t){if(!e.board[n][t])return[];const i=hi(e,n,t),r=[];for(const a of i)Zr(e,n,t,a.row,a.col)&&r.push(a);return r}function Zr(e,n,t,o,i){const r=e.board.map(l=>l.map(d=>d?{...d}:null)),a=r[n][t];r[o][i],r[o][i]=a,r[n][t]=null;const s={...e,board:r};return!Vr(s,a.color)}function Mt(e,n,t,o){const i=o==="white"?"black":"white";for(let r=0;r<8;r++)for(let a=0;a<8;a++){const s=e.board[r][a];if(s&&s.color===i&&Ei(e,r,a,n,t))return!0}return!1}function Ei(e,n,t,o,i){const r=e.board[n][t];if(!r)return!1;const a=o-n,s=i-t,l=Math.abs(a),d=Math.abs(s);switch(r.type){case"pawn":const c=r.color==="white"?-1:1;return a===c&&d===1;case"rook":return a===0||s===0?Dn(e,n,t,o,i):!1;case"bishop":return l===d?Dn(e,n,t,o,i):!1;case"queen":return a===0||s===0||l===d?Dn(e,n,t,o,i):!1;case"knight":return l===2&&d===1||l===1&&d===2;case"king":return l<=1&&d<=1&&!(a===0&&s===0);default:return!1}}function Dn(e,n,t,o,i){const r=o>n?1:o<n?-1:0,a=i>t?1:i<t?-1:0;let s=n+r,l=t+a;for(;s!==o||l!==i;){if(e.board[s][l]!==null)return!1;s+=r,l+=a}return!0}function Jr(e,n,t){const o=e[n][t];if(!o)return[];switch(o.type){case"pawn":return Qr(e,n,t,o.color);case"rook":return Jn(e,n,t,o.color);case"knight":return bi(e,n,t,o.color);case"bishop":return Qn(e,n,t,o.color);case"queen":return wi(e,n,t,o.color);case"king":return ea(e,n,t,o.color);default:return[]}}function Qr(e,n,t,o){const i=[],r=o==="white"?-1:1;for(const a of[-1,1]){const s=n+r,l=t+a;Xe(s,l)&&i.push({row:s,col:l})}return i}function ea(e,n,t,o){const i=[],r=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const[a,s]of r){const l=n+a,d=t+s;Xe(l,d)&&i.push({row:l,col:d})}return i}function Ci(e){return e.winner}function Ii(e){!e||!e.winner||(e.winner==="white"?oe("Congratulations ‚Äî you captured the king. You win.","info"):e.winner==="black"&&oe("Your king was captured. You lose.","info"))}async function Qt(e){try{await B.setItem("chessGameState",e)}catch(n){console.warn("Failed to save chess game state:",n)}}async function ta(){try{const e=await B.getItem("chessGameState");return e||null}catch(e){return console.warn("Failed to load chess game state:",e),null}}function na(e){const n=document.createElement("button");n.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2";const t=document.createElement("span");return t.className="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3",t.textContent=e,n.appendChild(t),n}function oa(e,n=null,t=null){const o=document.createElement("select");return o.className="bg-white border-t-2 border-l-2 border-black border-b-2 border-r-2 border-gray-300 px-2 py-1",o.setAttribute("aria-label","Select game difficulty"),o.setAttribute("title","Choose the difficulty level for the chess game"),e.forEach(i=>{const r=document.createElement("option");typeof i=="string"?(r.value=i,r.textContent=i):(r.value=i.value,r.textContent=i.text||i.value),n!==null&&r.value===n&&(r.selected=!0),o.appendChild(r)}),t&&typeof t=="function"&&o.addEventListener("change",i=>t(i.target.value,i)),o}function Li(){const e=document.getElementById("bombbroomer");if(e){const o=[...document.querySelectorAll("*")].filter(i=>getComputedStyle(i).zIndex>100&&getComputedStyle(i).zIndex<1e3).reduce((i,r)=>getComputedStyle(r).zIndex>getComputedStyle(i).zIndex?r:i);e.style.zIndex=`${parseInt(o.style.zIndex)+1}`;return}const n=se("Bombbroomer","",!1,"bombbroomer",!1,!1,{type:"integer",width:400,height:490},"App",null,"gray");Mi(n).catch(t=>{console.error("Error initializing Bombbroomer:",t)})}async function Mi(e){const n=e.querySelector(".p-2");n.className="p-2 bg-gray-200 h-full overflow-hidden",n.innerHTML="";let t=await ia();t||(t={grid:[],gameStarted:!1,gameOver:!1,gameWon:!1,bombs:10,flaggedCount:0,rows:9,cols:9,firstClick:!0,timer:0,timerInterval:null});let o=await B.getItem("bombbroomer-best-time")||null;const i=document.createElement("div");i.className="flex flex-col h-full bg-gray-200 pb-4";const r=document.createElement("div");r.className="bg-gray-200 border-b-2 border-gray-400 p-1 flex items-center space-x-4",r.style.borderStyle="inset";const a=document.createElement("button");a.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",a.textContent="Game",a.setAttribute("aria-label","Game menu options"),a.setAttribute("title","Access game options and settings");const s=document.createElement("button");s.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",s.textContent="New Game",s.setAttribute("aria-label","Start new game"),s.setAttribute("title","Start a new minesweeper game"),s.addEventListener("click",async()=>await _()),r.appendChild(s);const l=document.createElement("div");l.className="bg-gray-200 border-2 border-gray-400 p-2 flex justify-between items-center",l.style.borderStyle="inset";const d=document.createElement("div");d.className="bg-black text-red-500 px-2 py-1 font-mono text-lg border-2 border-gray-500",d.style.borderStyle="inset",d.id="bomb-counter",d.textContent="010";const c=document.createElement("button");c.className="w-8 h-8 bg-gray-200 border-2 border-gray-400 text-lg hover:bg-gray-300",c.style.borderStyle="outset",c.id="face-button",c.textContent="üôÇ",c.setAttribute("aria-label","New game - Click to restart"),c.setAttribute("title","Click to start a new game"),c.addEventListener("click",async()=>await _());const m=document.createElement("div");m.className="bg-black text-red-500 px-2 py-1 font-mono text-lg border-2 border-gray-500",m.style.borderStyle="inset",m.id="timer-display",m.textContent="000";const u=document.createElement("div");u.className="bg-black text-red-500 px-2 py-1 font-mono text-lg border-2 border-gray-500",u.style.borderStyle="inset",u.id="best-time-display",u.textContent=o?o.toString().padStart(3,"0"):"---",l.appendChild(d),l.appendChild(c),l.appendChild(m),l.appendChild(u);const f=document.createElement("div");f.className="flex-1 p-4 flex items-center justify-center";const p=document.createElement("div");p.className="grid grid-cols-9 gap-0 border-2 border-gray-400 bg-gray-300",p.style.borderStyle="inset",p.id="game-grid",f.appendChild(p),i.appendChild(r),i.appendChild(l),i.appendChild(f),n.appendChild(i);function g(){t.grid=[],t.gameStarted=!1,t.gameOver=!1,t.gameWon=!1,t.flaggedCount=0,t.firstClick=!0,t.timer=0,t.timerInterval&&clearInterval(t.timerInterval);for(let b=0;b<t.rows;b++){t.grid[b]=[];for(let h=0;h<t.cols;h++)t.grid[b][h]={isBomb:!1,isRevealed:!1,isFlagged:!1,neighborCount:0}}R(),y()}function k(b,h){let x=0;for(;x<t.bombs;){const A=Math.floor(Math.random()*t.rows),W=Math.floor(Math.random()*t.cols);!t.grid[A][W].isBomb&&!(A===b&&W===h)&&(t.grid[A][W].isBomb=!0,x++)}for(let A=0;A<t.rows;A++)for(let W=0;W<t.cols;W++)t.grid[A][W].isBomb||(t.grid[A][W].neighborCount=v(A,W))}function v(b,h){let x=0;for(let A=Math.max(0,b-1);A<=Math.min(t.rows-1,b+1);A++)for(let W=Math.max(0,h-1);W<=Math.min(t.cols-1,h+1);W++)(A!==b||W!==h)&&t.grid[A][W].isBomb&&x++;return x}function y(){const b=document.getElementById("game-grid");b.innerHTML="";for(let h=0;h<t.rows;h++)for(let x=0;x<t.cols;x++){const A=document.createElement("button");A.className="w-8 h-8 border border-gray-500 bg-gray-200 text-sm font-bold flex items-center justify-center",A.style.borderStyle="outset",A.dataset.row=h,A.dataset.col=x,A.setAttribute("aria-label",`Cell row ${h+1}, column ${x+1}`),A.setAttribute("title",`Minesweeper cell at row ${h+1}, column ${x+1}`);const W=t.grid[h][x];if(W.isRevealed){if(A.style.borderStyle="inset",A.className=A.className.replace("bg-gray-200","bg-gray-300"),W.isBomb)A.textContent="üí£",A.style.backgroundColor=t.gameOver?"#ff0000":"#gray-300";else if(W.neighborCount>0){A.textContent=W.neighborCount;const Y=["","#0000ff","#008000","#ff0000","#800080","#800000","#008080","#000000","#808080"];A.style.color=Y[W.neighborCount]||"#000000"}}else W.isFlagged&&(A.textContent="üö©");A.addEventListener("click",async Y=>await P(Y,h,x)),A.addEventListener("contextmenu",async Y=>await j(Y,h,x)),b.appendChild(A)}}async function P(b,h,x){if(b.preventDefault(),t.gameOver||t.gameWon)return;const A=t.grid[h][x];A.isRevealed||A.isFlagged||(t.firstClick&&(k(h,x),t.firstClick=!1,t.gameStarted=!0,T()),A.isBomb?await q():(K(h,x),await z()),y(),await Et(t))}async function j(b,h,x){if(b.preventDefault(),t.gameOver||t.gameWon)return;const A=t.grid[h][x];A.isRevealed||(A.isFlagged?(A.isFlagged=!1,t.flaggedCount--):(A.isFlagged=!0,t.flaggedCount++),R(),y(),await Et(t))}function K(b,h){const x=t.grid[b][h];if(!(x.isRevealed||x.isFlagged)&&(x.isRevealed=!0,x.neighborCount===0))for(let A=Math.max(0,b-1);A<=Math.min(t.rows-1,b+1);A++)for(let W=Math.max(0,h-1);W<=Math.min(t.cols-1,h+1);W++)(A!==b||W!==h)&&K(A,W)}function T(){t.timerInterval=setInterval(async()=>{t.timer++,R(),await Et(t)},1e3)}async function q(){t.gameOver=!0,t.timerInterval&&clearInterval(t.timerInterval);for(let b=0;b<t.rows;b++)for(let h=0;h<t.cols;h++)t.grid[b][h].isBomb&&(t.grid[b][h].isRevealed=!0);await Et(t),document.getElementById("face-button").textContent="üòµ",setTimeout(()=>{showDialogBox("Game Over! Try again?","confirmation")},500)}async function z(){let b=0;for(let x=0;x<t.rows;x++)for(let A=0;A<t.cols;A++)t.grid[x][A].isRevealed&&!t.grid[x][A].isBomb&&b++;const h=t.rows*t.cols-t.bombs;b===h&&(t.gameWon=!0,t.timerInterval&&clearInterval(t.timerInterval),(o===null||t.timer<o)&&(o=t.timer,B.setItemSync("bombbroomer-best-time",o),document.getElementById("best-time-display").textContent=o.toString().padStart(3,"0"),window.isDevvit&&window.parent.postMessage({type:"setGameScore",data:{game:"bombbroomer",score:o}},"*")),await Et(t),document.getElementById("face-button").textContent="üòé",setTimeout(()=>{showDialogBox("Congratulations! You won!","confirmation")},500))}function R(){const b=document.getElementById("bomb-counter"),h=document.getElementById("timer-display"),x=t.bombs-t.flaggedCount;b.textContent=x.toString().padStart(3,"0"),h.textContent=Math.min(t.timer,999).toString().padStart(3,"0")}async function _(){document.getElementById("face-button").textContent="üôÇ",g(),await ra()}function Z(){const b=document.getElementById("face-button");t.gameOver?b.textContent="üòµ":t.gameWon?b.textContent="üòé":b.textContent="üôÇ",t.gameStarted&&!t.gameOver&&!t.gameWon&&T(),R(),y()}const J=new MutationObserver(b=>{b.forEach(h=>{h.removedNodes.forEach(x=>{x.id==="bombbroomer"&&(t.timerInterval&&clearInterval(t.timerInterval),J.disconnect())})})});J.observe(document.getElementById("windows-container"),{childList:!0}),t.grid.length===0?_():Z()}async function Et(e){try{const n={...e,timerInterval:null};await B.setItem("bombbroomer_gameState",n)}catch(n){console.warn("Failed to save Bombbroomer game state:",n)}}async function ia(){try{const e=await B.getItem("bombbroomer_gameState");if(e){const n=e;return n.timerInterval=null,n}}catch(e){console.warn("Failed to load Bombbroomer game state:",e)}return null}async function ra(){try{await B.removeItem("bombbroomer_gameState")}catch(e){console.warn("Failed to clear Bombbroomer game state:",e)}}function Ai(){const e=document.getElementById("mediaplayer");if(e){const o=[...document.querySelectorAll("*")].filter(i=>getComputedStyle(i).zIndex>100&&getComputedStyle(i).zIndex<1e3).reduce((i,r)=>getComputedStyle(r).zIndex>getComputedStyle(i).zIndex?r:i);e.style.zIndex=`${parseInt(o.style.zIndex)+1}`;return}const n=se("Media Player","",!1,"mediaplayer",!1,!1,{type:"integer",width:500,height:400},"App",null,"gray");Di(n).catch(console.error)}async function Di(e){const n=e.querySelector(".p-2");n.className="p-2 bg-gray-200 h-full flex",n.innerHTML="";let t=await to();t?((!isFinite(t.volume)||t.volume<0||t.volume>1)&&(t.volume=.5),(!isFinite(t.currentTime)||t.currentTime<0)&&(t.currentTime=0),Number.isInteger(t.currentTrackIndex)||(t.currentTrackIndex=-1),Array.isArray(t.playlist)||(t.playlist=[])):t={currentTrackIndex:-1,currentTime:0,volume:.5,isPlaying:!1,playlist:[]};const o=document.createElement("div");o.className="w-1/2 bg-white border-2 border-gray-400 mr-2 flex flex-col",o.innerHTML=`
    <div class="bg-gray-300 border-b-2 border-gray-400 p-2 flex justify-between items-center">
      <div class="text-xs font-bold">Media Playlist:</div>
      <button id="add-song-btn" onclick="setTimeout(function(){toggleButtonActiveState('add-song-btn', 'Add Media')}, 1000);toggleButtonActiveState('add-song-btn', 'Adding media...');" class="bg-gray-200 border-t-2 border-l-2 border-gray-300"><span class="border-b-2 border-r-2 border-black block h-full w-full py-1 px-2 text-xs">Add</span></button>
      <input type="file" id="song-file-input" class="hidden" accept="audio/*,video/*">
    </div>
    <div id="playlist-container" class="flex-1 p-2 overflow-y-auto space-y-1">
      <div class="text-xs text-gray-500">Loading playlist...</div>
    </div>
  `;const i=document.createElement("div");i.className="w-1/2 flex flex-col";const r=document.createElement("div");r.id="media-container",r.className="w-full bg-black mb-2 flex items-center justify-center min-h-32",r.innerHTML=`
    <audio id="audio-player" class="w-full hidden"></audio>
    <video id="video-player" class="w-full max-h-48 hidden" controls></video>
    <div id="audio-placeholder" class="text-white text-2xl p-4 flex items-center justify-center" style="display: none;">üéµ üé∂ üéµ</div>
    <div id="media-placeholder" class="text-white text-sm p-4">No media selected</div>
  `,i.appendChild(r);const a=document.createElement("div");a.className="bg-gray-300 border-2 border-gray-400 p-3 mb-2";const s=document.createElement("div");s.className="text-center mb-2",s.innerHTML=`
    <div id="current-track-name" class="font-bold text-sm">Media Player</div>
    <div id="current-time" class="text-xs text-gray-600">Ready to play</div>
  `;const l=document.createElement("div");l.className="mb-3",l.innerHTML=`
    <div id="progress-container" class="w-full h-2 bg-gray-400 border border-gray-500 cursor-pointer">
      <div id="progress-bar" class="h-full bg-blue-500" style="width: 0%"></div>
    </div>
  `;const d=document.createElement("div");d.className="flex justify-center space-x-2 mb-2",d.innerHTML=`
    <button id="prev-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs" aria-label="Previous track" title="Play previous track">‚èÆ</button>
    <button id="play-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs" aria-label="Play" title="Play/pause current track">‚ñ∂</button>
    <button id="stop-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs" aria-label="Stop" title="Stop playback">‚èπ</button>
    <button id="next-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs" aria-label="Next track" title="Play next track">‚è≠</button>
  `;const c=document.createElement("div");c.className="flex items-center justify-center space-x-2",c.innerHTML=`
    <span class="text-xs">üîä</span>
    <input type="range" id="volume-control" min="0" max="1" step="0.01" value="0.5" class="w-20" aria-label="Volume control" title="Adjust playback volume">
    <span class="text-xs" id="volume-display">50%</span>
  `,a.appendChild(s),a.appendChild(l),a.appendChild(d),a.appendChild(c),i.appendChild(a),n.appendChild(o),n.appendChild(i);const m=n.querySelector("#audio-player"),u=n.querySelector("#video-player");let f=t.currentTrackIndex,p=t.playlist;const g=n.querySelector("#play-btn"),k=n.querySelector("#next-btn"),v=n.querySelector("#prev-btn"),y=n.querySelector("#stop-btn"),P=n.querySelector("#volume-control"),j=n.querySelector("#progress-bar"),K=n.querySelector("#progress-container"),T=n.querySelector("#add-song-btn"),q=n.querySelector("#song-file-input");let z;const R="media_player_db",_="songs";function Z(){const w=indexedDB.open(R,1);w.onerror=L=>{console.error("Database error: ",L.target.errorCode)},w.onupgradeneeded=L=>{z=L.target.result,z.createObjectStore(_,{keyPath:"id",autoIncrement:!0}).createIndex("name","name",{unique:!1})},w.onsuccess=L=>{z=L.target.result,b().catch(console.error)}}function J(w){const L=w.name.split(".").pop().toLowerCase();fo(w.name,"","C://Media",L,w).then(I=>{I?b().catch(console.error):console.error("üéµ MEDIAPLAYER: Failed to add song to file system")}).catch(I=>{console.error("üéµ MEDIAPLAYER: Error adding song to file system:",I)})}async function b(){p=[];try{const I=ce().folders["C://Media"];if(I){const ne=Object.entries(I).filter(([H,ye])=>H!=="contents"&&ye&&typeof ye=="object"&&ye.type).map(([H,ye])=>ye).map(async H=>{if(H.content_type&&["mp3","wav","audio","mp4","webm","avi","mov"].includes(H.content_type)){const ye=["mp4","webm","avi","mov"].includes(H.content_type),fe={name:H.name,file:H.file,id:H.id,isFileSystem:!0,source:"filesystem",isVideo:ye,contentType:H.content_type,type:H.file&&H.file.type?H.file.type:ye?"video/"+H.content_type:"audio/"+H.content_type};if(H.storageLocation==="indexeddb"&&!H.dataURL||!H.dataURL&&!H.file&&!H.path&&H.id&&H.id.startsWith("file-"))try{const Le=await storage.getItem(`file_data_${H.id}`);if(Le){H.dataURL=Le,fe.dataURL=Le;const Me=ce();Me.folders["C://Media"]&&Me.folders["C://Media"][H.id]&&(Me.folders["C://Media"][H.id].dataURL=Le,Me.folders["C://Media"][H.id].tempObjectURL=null,setFileSystemState(Me))}else{console.warn("üéµ MEDIAPLAYER: No stored data found in IndexedDB for:",H.name,"File ID:",H.id);const Me=`file_data_${H.name}`,Oe=await storage.getItem(Me);Oe&&(H.dataURL=Oe,fe.dataURL=Oe)}}catch(Le){console.error("üéµ MEDIAPLAYER: Failed to load data from IndexedDB for:",H.name,Le)}return(H.isDefault||H.isSystemFile)&&H.path?(fe.path=H.path,fe.isDefault=H.isDefault,fe.isSystemFile=H.isSystemFile):H.dataURL||fe.dataURL?fe.dataURL=H.dataURL||fe.dataURL:H.file?fe.file=H.file:H.tempObjectURL?fe.tempObjectURL=H.tempObjectURL:fe.path=`media/${H.name}`,fe}return null});p=(await Promise.all(ne)).filter(H=>H!==null)}}catch(L){console.error("Could not load songs from file system:",L)}p.some(L=>L.name==="too_many_screws_final.mp3")||p.unshift({name:"too_many_screws_final.mp3",path:"media/too_many_screws_final.mp3",isDefault:!0,id:"fallback-default-song",source:"fallback"}),h(),p.length>0&&(t.currentTrackIndex>=0&&t.currentTrackIndex<p.length?(x(t.currentTrackIndex),m.addEventListener("loadedmetadata",()=>{m.currentTime=t.currentTime||0},{once:!0})):x(0))}function h(){const w=n.querySelector("#playlist-container");w.innerHTML="",p.forEach((L,I)=>{const U=document.createElement("div");U.className="text-xs cursor-pointer hover:bg-gray-100 p-1 rounded";const ne=L.name||L.id||"Unknown Track";L.name||console.warn("üéµ MEDIAPLAYER: Track missing name property, using fallback:",ne,"Track:",L),U.textContent=ne,U.dataset.index=I,U.addEventListener("click",()=>{x(I),W()}),w.appendChild(U)})}function x(w){if(w<0||w>=p.length)return;f=w,t.currentTrackIndex=f;const L=p[w],I=L.type&&L.type.startsWith("video/")||L.contentType&&["mp4","webm","avi","mov"].includes(L.contentType)||L.isVideo===!0||L.file&&L.file.type&&L.file.type.startsWith("video/");m.style.display="none",u.style.display="none";const U=n.querySelector("#media-placeholder"),ne=n.querySelector("#audio-placeholder");U&&(U.style.display="none"),ne&&(ne.style.display="none");const te=I?u:m,H=I?m:u;if(I?te.style.display="block":ne&&(ne.style.display="flex"),H.pause(),H.currentTime=0,L.isDefault||L.path&&!L.file&&!L.dataURL)te.src=L.path;else if(L.dataURL)te.src=L.dataURL;else if(L.tempObjectURL)te.src=L.tempObjectURL;else if(L.isFileSystem&&L.file){const ye=URL.createObjectURL(L.file);te.src=ye}else if(L.file){const ye=URL.createObjectURL(L.file);te.src=ye}else{console.error("Unable to load track - no valid source:",L);return}n.querySelector("#current-track-name").textContent=L.name||L.id||"Unknown Track",A(),Ge(t).catch(console.error)}function A(){n.querySelectorAll("#playlist-container > div").forEach((L,I)=>{I===f?L.classList.add("bg-blue-200"):L.classList.remove("bg-blue-200")})}function W(){const L=Y().play();L!==void 0&&L.catch(I=>{I.name==="AbortError"||console.error("Playback failed:",I)})}function Y(){return u.style.display==="block"?u:m}function ie(){const w=Y();w.paused?W():w.pause()}function we(){const w=Y();w.pause(),w.currentTime=0}function Q(){const w=(f+1)%p.length;x(w),W()}function ee(){const w=(f-1+p.length)%p.length;x(w),W()}function he(){const w=Y();w.volume=P.value;const L=w===m?u:m;L.volume=P.value,t.volume=w.volume,n.querySelector("#volume-display").textContent=`${Math.round(P.value*100)}%`,Ge(t).catch(console.error)}function C(){const w=Y();if(w.duration){const L=w.currentTime/w.duration*100;j.style.width=`${L}%`;const I=U=>{const ne=Math.floor(U/60),te=Math.floor(U%60).toString().padStart(2,"0");return`${ne}:${te}`};n.querySelector("#current-time").textContent=`${I(w.currentTime)} / ${I(w.duration)}`}}function M(w){const L=Y();if(!L.duration)return;const I=w.offsetX,U=K.offsetWidth;L.currentTime=I/U*L.duration}g.addEventListener("click",ie),m.addEventListener("play",()=>g.textContent="‚è∏"),m.addEventListener("pause",()=>g.textContent="‚ñ∂"),m.addEventListener("ended",Q),m.addEventListener("timeupdate",C),m.addEventListener("volumechange",()=>{P.value=m.volume,he()}),u.addEventListener("play",()=>g.textContent="‚è∏"),u.addEventListener("pause",()=>g.textContent="‚ñ∂"),u.addEventListener("ended",Q),u.addEventListener("timeupdate",C),u.addEventListener("volumechange",()=>{P.value=u.volume,he()}),m.addEventListener("error",w=>{console.error("üéµ MEDIAPLAYER: Audio error:",w.target.error,"Source:",m.src)}),u.addEventListener("error",w=>{console.error("üéµ MEDIAPLAYER: Video error:",w.target.error,"Source:",u.src)}),m.addEventListener("loadstart",()=>{}),u.addEventListener("loadstart",()=>{}),y.addEventListener("click",we),k.addEventListener("click",Q),v.addEventListener("click",ee),P.addEventListener("input",he),K.addEventListener("click",M),T.addEventListener("click",()=>q.click()),q.addEventListener("change",w=>{const L=w.target.files[0];L&&J(L)});const O=isFinite(t.volume)&&t.volume>=0&&t.volume<=1?t.volume:.5;P.value=O,m.volume=O,u.volume=O,n.querySelector("#volume-display").textContent=`${Math.round(O*100)}%`,t.volume=O,m.addEventListener("timeupdate",()=>{m.style.display==="block"&&(t.currentTime=m.currentTime,Math.floor(m.currentTime)%5===0&&Ge(t).catch(console.error))}),m.addEventListener("play",()=>{m.style.display==="block"&&(t.isPlaying=!0,Ge(t).catch(console.error))}),m.addEventListener("pause",()=>{m.style.display==="block"&&(t.isPlaying=!1,Ge(t).catch(console.error))}),u.addEventListener("timeupdate",()=>{u.style.display==="block"&&(t.currentTime=u.currentTime,Math.floor(u.currentTime)%5===0&&Ge(t).catch(console.error))}),u.addEventListener("play",()=>{u.style.display==="block"&&(t.isPlaying=!0,Ge(t).catch(console.error))}),u.addEventListener("pause",()=>{u.style.display==="block"&&(t.isPlaying=!1,Ge(t).catch(console.error))}),Z(),he(),t.currentTrackIndex>=0&&p.length>t.currentTrackIndex&&setTimeout(async()=>{await Bi()},500),window.refreshMediaPlayerPlaylist=function(){z&&b().catch(console.error)};const S=setInterval(()=>{try{const L=ce().folders["C://Media"];if(L){const I=Object.values(L).filter(te=>te.content_type&&["mp3","wav","audio","mp4","webm","avi","mov"].includes(te.content_type)).map(te=>te.name),U=p.filter(te=>te.source==="filesystem"||te.isFileSystem).map(te=>te.name);I.filter(te=>!U.includes(te)).length>0&&b().catch(console.error)}}catch{}},1e4),E=e,$=E.remove;E.remove=function(){return clearInterval(S),window.refreshMediaPlayerPlaylist===window.refreshMediaPlayerPlaylist&&delete window.refreshMediaPlayerPlaylist,$.call(this)}}async function Bi(){const e=await to();if(!(!e||e.currentTrackIndex<0)&&playlist.length>e.currentTrackIndex){let t=function(){const o=getActivePlayer();e.currentTime>0&&(o.currentTime=e.currentTime),e.isPlaying&&safePlay()};var n=t;loadTrack(e.currentTrackIndex),audio.addEventListener("loadedmetadata",function o(){audio.style.display==="block"&&t(),audio.removeEventListener("loadedmetadata",o)}),video.addEventListener("loadedmetadata",function o(){video.style.display==="block"&&t(),video.removeEventListener("loadedmetadata",o)})}}async function Ge(e){try{await storage.setItem("mediaplayer_state",e)}catch(n){console.warn("Failed to save Media Player state:",n);try{storage.setItemSync("mediaplayer_state",e)}catch(t){console.error("Failed to save Media Player state with fallback:",t)}}}async function to(){try{const e=await storage.getItem("mediaplayer_state");if(e)return e}catch(e){console.warn("Failed to load Media Player state:",e);try{const n=storage.getItemSync("mediaplayer_state");if(n)return n}catch(n){console.warn("Failed to load Media Player state with fallback:",n)}}return null}async function aa(){try{await storage.removeItem("mediaplayer_state")}catch(e){console.warn("Failed to clear Media Player state:",e);try{storage.removeItemSync("mediaplayer_state")}catch(n){console.error("Failed to clear Media Player state with fallback:",n)}}}class sa{constructor(){this.shortcuts=new Map,this.customMappings=new Map,this.isInitialized=!1,this.preventDefaults=new Set,this.sequenceBuffer=[],this.sequenceTimer=null,this.shortcutMode=!1,this.sequenceMap={"g w":()=>typeof window.cycleWindows=="function"&&window.cycleWindows(),"g d":()=>typeof window.minimizeAllWindows=="function"&&window.minimizeAllWindows(),"g s":()=>typeof window.toggleStartMenu=="function"&&window.toggleStartMenu(),"w c":()=>typeof window.closeActiveWindow=="function"&&window.closeActiveWindow(),"w m":()=>typeof window.minimizeActiveWindow=="function"&&window.minimizeActiveWindow()},this.shortcutModeMap={c:()=>typeof window.closeActiveWindow=="function"&&window.closeActiveWindow(),m:()=>typeof window.minimizeActiveWindow=="function"&&window.minimizeActiveWindow(),x:()=>{var n;return typeof window.toggleFullScreen=="function"&&window.toggleFullScreen((n=window.getActiveWindowId)==null?void 0:n.call(window))},s:()=>typeof window.toggleStartMenu=="function"&&window.toggleStartMenu(),d:()=>typeof window.minimizeAllWindows=="function"&&window.minimizeAllWindows()},this.defaultShortcuts={"global.toggleStartMenu":{key:"Alt+S",description:"Open/Close Start Menu"},"global.cycleWindows":{key:"Alt+W",description:"Cycle open windows"},"global.minimizeActiveWindow":{key:"Alt+M",description:"Minimize active window"},"global.closeActiveWindow":{key:"Alt+Q",description:"Close active window"},"global.showDesktop":{key:"Alt+D",description:"Show desktop (minimize all)"},"fileExplorer.rename":{key:"Alt+R",description:"Rename selected file"},"global.escapeAction":{key:"Escape",description:"Close menus/dialogs"},"global.toggleShortcutMode":{key:"Alt+K",description:"Enter Shortcut Mode"},"desktop.activateIcon":{key:"Enter",description:"Activate selected desktop icon"},"desktop.moveUp":{key:"ArrowUp",description:"Move icon up"},"desktop.moveDown":{key:"ArrowDown",description:"Move icon down"},"desktop.moveLeft":{key:"ArrowLeft",description:"Move icon left"},"desktop.moveRight":{key:"ArrowRight",description:"Move icon right"},"desktop.fineMoveUp":{key:"Shift+ArrowUp",description:"Fine move icon up"},"desktop.fineMoveDown":{key:"Shift+ArrowDown",description:"Fine move icon down"},"desktop.fineMoveLeft":{key:"Shift+ArrowLeft",description:"Fine move icon left"},"desktop.fineMoveRight":{key:"Shift+ArrowRight",description:"Fine move icon right"},"startMenu.navigateDown":{key:"ArrowDown",description:"Navigate down in start menu"},"startMenu.navigateUp":{key:"ArrowUp",description:"Navigate up in start menu"},"startMenu.enterSubmenu":{key:"ArrowRight",description:"Enter submenu"},"startMenu.exitSubmenu":{key:"ArrowLeft",description:"Exit submenu"},"startMenu.activateItem":{key:"Enter",description:"Activate start menu item"},"startMenu.close":{key:"Escape",description:"Close start menu"}}}async initialize(){this.isInitialized||(await this.loadCustomMappings(),this.setupShortcuts(),this.setupGlobalKeyboardHandler(),this.isInitialized=!0,console.log("üéπ Keyboard service initialized with",this.shortcuts.size,"shortcuts"))}async loadCustomMappings(){var n;try{const o=(n=(await Re()).folders["C://Documents"])==null?void 0:n["keyboard_config.json"];if(o&&o.content){const i=JSON.parse(o.content);this.customMappings=new Map(Object.entries(i.customMappings||{})),console.log("üìã Loaded",this.customMappings.size,"custom keyboard mappings")}}catch(t){console.warn("‚ö†Ô∏è Could not load keyboard config:",t)}}async saveCustomMappings(){try{const n=await Re();n.folders["C://Documents"]||(n.folders["C://Documents"]={});const t={customMappings:Object.fromEntries(this.customMappings),timestamp:Date.now()};n.folders["C://Documents"]["keyboard_config.json"]={id:"keyboard_config.json",name:"keyboard_config.json",type:"file",content_type:"json",content:JSON.stringify(t,null,2),fullPath:"C://Documents/keyboard_config.json"},await X(),console.log("üíæ Saved keyboard configuration")}catch(n){console.error("‚ùå Failed to save keyboard config:",n)}}setupShortcuts(){this.shortcuts.clear();for(const[n,t]of Object.entries(this.defaultShortcuts)){const o=this.customMappings.get(n);this.shortcuts.set(n,{...t,key:o||t.key,isCustom:!!o})}}setupGlobalKeyboardHandler(){document.removeEventListener("keydown",this.globalHandler),this.globalHandler=this.handleGlobalKeyboard.bind(this),document.addEventListener("keydown",this.globalHandler,!0)}handleGlobalKeyboard(n){const t=n.target,o=/input|textarea|select/i.test(t.tagName)||t.isContentEditable;if(this.shortcutMode){if(n.key==="Escape"){this.shortcutMode=!1;return}if(!n.metaKey&&!n.ctrlKey&&!n.altKey){const a=n.key.toLowerCase(),s=this.shortcutModeMap[a];if(s){n.preventDefault(),s(),this.shortcutMode=!1;return}}}const i=this.getKeyCombo(n),r=this.getContext(n);for(const[a,s]of this.shortcuts.entries())if(this.matchesKeyCombo(i,s.key)&&this.isActionValidForContext(a,r)){n.preventDefault(),n.stopPropagation(),this.executeAction(a,n,r);return}if(!o&&!n.metaKey&&!n.ctrlKey&&!n.altKey&&n.key.length===1){this.sequenceBuffer.push(n.key.toLowerCase()),clearTimeout(this.sequenceTimer),this.sequenceTimer=setTimeout(()=>{this.sequenceBuffer=[]},650);const a=this.sequenceBuffer.join(" ");this.sequenceMap[a]?(n.preventDefault(),this.sequenceMap[a](),this.sequenceBuffer=[]):this.sequenceBuffer.length>2&&(this.sequenceBuffer=[])}}getKeyCombo(n){const t=[];n.ctrlKey&&t.push("Ctrl"),n.altKey&&t.push("Alt"),n.shiftKey&&t.push("Shift"),n.metaKey&&t.push("Meta");let o=n.key===" "?"Space":n.key;return n.altKey&&n.code&&n.code.startsWith("Key")&&(o=n.code.slice(3)),["Control","Alt","Shift","Meta"].includes(o)||t.push(o),t.join("+")}matchesKeyCombo(n,t){const o=i=>i.toLowerCase().replace(/\s+/g,"");return o(n)===o(t)}getContext(n){const t=n.target,o=[];return t.closest("#start-menu")&&o.push("startMenu"),t.closest("#context-menu")&&o.push("contextMenu"),t.closest(".file-explorer-window")&&o.push("fileExplorer"),t.closest(".draggable-icon")&&o.push("desktop"),t.closest("#window-tabs")&&o.push("taskbar"),t.closest('[role="dialog"]')&&o.push("window"),o.push("global"),o}isActionValidForContext(n,t){const o=n.split(".")[0];return t.includes(o)||o==="global"}async executeAction(n,t,o){console.log("üéπ Executing keyboard action:",n);try{switch(n){case"global.toggleStartMenu":typeof window.toggleStartMenu=="function"&&window.toggleStartMenu();break;case"global.toggleShortcutMode":this.shortcutMode=!this.shortcutMode,this.shortcutMode&&typeof window.showDialogBox=="function"&&window.showDialogBox("Shortcut Mode: c(close) m(minimize) x(max) s(start) d(desktop) Esc(cancel)","info");break;case"global.cycleWindows":typeof window.cycleWindows=="function"&&window.cycleWindows();break;case"global.closeActiveWindow":typeof window.closeActiveWindow=="function"&&window.closeActiveWindow();break;case"global.minimizeActiveWindow":typeof window.minimizeActiveWindow=="function"&&window.minimizeActiveWindow();break;case"global.showDesktop":typeof window.minimizeAllWindows=="function"&&window.minimizeAllWindows();break;case"global.escapeAction":this.handleGlobalEscape();break;case"desktop.activateIcon":case"desktop.activateIcon2":this.handleDesktopActivate(t);break;case"desktop.startDrag":this.handleDesktopStartDrag(t);break;case"desktop.cutIcon":this.handleDesktopCut(t);break;case"desktop.pasteIcon":this.handleDesktopPaste(t);break;case"desktop.escapeAction":this.handleDesktopEscape(t);break;case"desktop.moveUp":case"desktop.moveDown":case"desktop.moveLeft":case"desktop.moveRight":this.handleDesktopMove(t,n);break;case"desktop.fineMoveUp":case"desktop.fineMoveDown":case"desktop.fineMoveLeft":case"desktop.fineMoveRight":this.handleDesktopFineMove(t,n);break;case"startMenu.navigateDown":case"startMenu.navigateUp":case"startMenu.enterSubmenu":case"startMenu.exitSubmenu":case"startMenu.activateItem":case"startMenu.activateItem2":case"startMenu.close":case"startMenu.goToFirst":case"startMenu.goToLast":this.handleStartMenuAction(n,t);break;case"fileExplorer.rename":case"fileExplorer.delete":case"fileExplorer.open":case"fileExplorer.navigateDown":case"fileExplorer.navigateUp":case"fileExplorer.openContextMenu":case"fileExplorer.openContextMenu2":case"fileExplorer.openContextMenu3":this.handleFileExplorerAction(n,t);break;case"contextMenu.navigateDown":case"contextMenu.navigateUp":case"contextMenu.enterSubmenu":case"contextMenu.exitSubmenu":case"contextMenu.activateItem":case"contextMenu.activateItem2":case"contextMenu.close":this.handleContextMenuAction(n,t);break;case"window.minimize":case"window.maximize":case"window.close":this.handleWindowAction(n,t);break;case"taskbar.activateButton":case"taskbar.activateButton2":case"taskbar.mediaControl":case"taskbar.minimizeAll":this.handleTaskbarAction(n,t);break;default:console.warn("üéπ Unknown keyboard action:",n)}}catch(i){console.error("‚ùå Error executing keyboard action:",n,i)}}handleGlobalEscape(){const n=document.getElementById("start-menu"),t=document.getElementById("context-menu");if(n&&!n.classList.contains("hidden")){n.classList.add("hidden"),n.setAttribute("aria-hidden","true"),typeof window.updateStartMenuFocusability=="function"&&window.updateStartMenuFocusability(!1);const o=document.getElementById("start-button");o&&(o.setAttribute("aria-expanded","false"),o.focus())}t&&!t.classList.contains("hidden")&&t.classList.add("hidden")}handleDesktopActivate(n){const t=n.target.closest(".draggable-icon");t&&t.dispatchEvent(new MouseEvent("dblclick",{bubbles:!0}))}handleDesktopStartDrag(n){const t=n.target.closest(".draggable-icon");t&&typeof window.startKeyboardDrag=="function"&&window.startKeyboardDrag(t)}handleDesktopCut(n){const t=n.target.closest(".draggable-icon");t&&typeof window.cutIcon=="function"&&window.cutIcon(t)}handleDesktopPaste(n){typeof window.pasteIcon=="function"&&window.pasteIcon()}handleDesktopEscape(n){typeof window.endKeyboardDrag=="function"&&window.endKeyboardDrag(!1)}handleDesktopMove(n,t){const o=n.target.closest(".draggable-icon");if(!o)return;const i=t.split(".")[1].replace("move","").toLowerCase(),r={up:"ArrowUp",down:"ArrowDown",left:"ArrowLeft",right:"ArrowRight"};typeof window.moveIconWithKeyboard=="function"&&window.moveIconWithKeyboard(o,r[i])}handleDesktopFineMove(n,t){const o=n.target.closest(".draggable-icon");if(!o)return;const i=t.split(".")[1].replace("fineMove","").toLowerCase(),r=parseInt(o.style.left)||0,a=parseInt(o.style.top)||0,s=5;let l=r,d=a;switch(i){case"up":d=Math.max(16,a-s);break;case"down":d=a+s;break;case"left":l=Math.max(16,r-s);break;case"right":l=r+s;break}o.style.left=l+"px",o.style.top=d+"px",typeof window.constrainIconPosition=="function"&&window.constrainIconPosition(o),typeof window.desktopIconsState<"u"&&(window.desktopIconsState[o.id]={left:o.style.left,top:o.style.top}),typeof window.saveState=="function"&&window.saveState()}handleStartMenuAction(n,t){const o=n.split(".")[1],i=window.startMenuKeyboardNavState;i&&typeof i.handleAction=="function"&&i.handleAction(o,t)}handleFileExplorerAction(n,t){const o=n.split(".")[1];switch(o){case"rename":console.log("Rename functionality would trigger here");break;case"delete":console.log("Delete - Delete functionality would trigger here");break;case"open":const i=document.activeElement;i&&i.classList.contains("file-item")&&i.dispatchEvent(new MouseEvent("dblclick",{bubbles:!0}));break;case"navigateDown":case"navigateUp":const r=o==="navigateDown"?"down":"up",a=document.querySelector(".file-explorer-window:focus-within");a&&typeof window.navigateFileList=="function"&&window.navigateFileList(r,a);break;case"openContextMenu":case"openContextMenu2":case"openContextMenu3":const s=t.target,l=s.getBoundingClientRect(),d=new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,clientX:l.left+l.width/2,clientY:l.top+l.height/2,button:2});s.dispatchEvent(d);break}}handleContextMenuAction(n,t){const o=document.getElementById("context-menu");o&&typeof window.handleContextMenuNavigation=="function"&&window.handleContextMenuNavigation(t,o)}handleWindowAction(n,t){const o=n.split(".")[1],i=document.querySelector('[role="dialog"]:not([aria-hidden="true"])');if(!i)return;const r=i.id;switch(o){case"minimize":typeof window.minimizeWindow=="function"&&window.minimizeWindow(r);break;case"maximize":typeof window.toggleFullScreen=="function"&&window.toggleFullScreen(r);break;case"close":typeof window.closeWindow=="function"&&window.closeWindow(r);break}}handleTaskbarAction(n,t){switch(n.split(".")[1]){case"activateButton":case"activateButton2":const i=t.target.closest("button");i&&i.click();break;case"mediaControl":typeof window.toggleMediaPlayback=="function"&&window.toggleMediaPlayback();break;case"minimizeAll":typeof window.minimizeAllWindows=="function"&&window.minimizeAllWindows();break}}remapShortcut(n,t){if(!this.defaultShortcuts[n])throw new Error(`Unknown action: ${n}`);this.customMappings.set(n,t),this.setupShortcuts(),this.saveCustomMappings()}removeCustomMapping(n){this.customMappings.delete(n),this.setupShortcuts(),this.saveCustomMappings()}resetToDefaults(){this.customMappings.clear(),this.setupShortcuts(),this.saveCustomMappings()}getShortcuts(){return Array.from(this.shortcuts.entries()).map(([n,t])=>({id:n,...t}))}getShortcutsByContext(){const n={};for(const[t,o]of this.shortcuts.entries()){const i=t.split(".")[0];n[i]||(n[i]=[]),n[i].push({id:t,...o})}return n}}const Be=new sa;async function Ti(){console.log("üéπ Starting keyboard app launch...");try{await Be.initialize(),console.log("üéπ Keyboard service initialized successfully");const e=document.getElementById("keyboard-app");if(e){console.log("üéπ Existing keyboard window found, bringing to front"),typeof window.bringToFront=="function"&&window.bringToFront(e);return}const n="keyboard-app",t=la();console.log("üéπ Creating keyboard app window..."),se("Keyboard Shortcuts",t,!1,n,!1,!1,{type:"integer",width:800,height:600},"default"),console.log("üéπ Window created, initializing app..."),setTimeout(()=>Fi(n),100)}catch(e){console.error("‚ùå Failed to launch keyboard app:",e)}}function la(){return`
    <div class="keyboard-app h-full flex flex-col bg-gray-50">
      <div class="bg-gray-600 text-white p-3 flex items-center">
        <div class="w-8 h-8 bg-white bg-opacity-20 rounded mr-3 flex items-center justify-center">
          <span class="text-sm font-bold">‚å®Ô∏è</span>
        </div>
        <div>
          <h1 class="text-lg font-bold">Keyboard Shortcuts Manager</h1>
          <p class="text-sm opacity-90">Customize keyboard shortcuts for the entire system</p>
        </div>
      </div>

      <div class="flex-1 flex">
        <!-- Sidebar -->
        <div class="w-64 bg-white border-r border-gray-300 flex flex-col">
          <div class="p-3 border-b border-gray-200">
            <h2 class="font-bold text-gray-800">Categories</h2>
          </div>
          <div class="flex-1 overflow-y-auto">
            <div id="keyboard-categories" class="p-2 space-y-1">
              <!-- Categories will be populated here -->
            </div>
          </div>
          <div class="p-3 border-t border-gray-200 space-y-2">
            <div id="keyboard-reset-btn-container"></div>
            <div id="keyboard-export-btn-container"></div>
          </div>
        </div>

        <!-- Main content -->
        <div class="flex-1 flex flex-col">
          <div class="p-4 border-b border-gray-200 bg-gray-100">
            <div class="flex items-center justify-between">
              <div>
                <h2 id="keyboard-category-title" class="text-xl font-bold text-gray-800">Global Shortcuts</h2>
                <p id="keyboard-category-desc" class="text-sm text-gray-600">System-wide keyboard shortcuts</p>
              </div>
              <div class="flex items-center space-x-2">
                <input type="text" id="keyboard-search" placeholder="Search shortcuts..."
                       class="px-3 py-1 border border-gray-300 rounded text-sm">
                <div id="keyboard-help-btn-container"></div>
              </div>
            </div>
          </div>

          <div class="flex-1 overflow-y-auto p-4">
            <div id="keyboard-touch-banner" class="hidden mb-3 bg-blue-50 border border-blue-200 text-blue-800 rounded p-3 text-sm">
              <strong>Touch tips:</strong> Swipe the taskbar to switch windows, two-finger tap on the desktop to show the desktop, and two-finger swipe on a window title bar to minimize (down) or maximize (up).
            </div>
            <div id="keyboard-shortcuts-list">
              <!-- Shortcuts list will be populated here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Status bar -->
      <div class="bg-gray-200 border-t border-gray-300 px-4 py-2 text-sm text-gray-600">
        <div class="flex items-center justify-between">
          <span id="keyboard-status">Ready</span>
          <span id="keyboard-count">0 shortcuts loaded</span>
        </div>
      </div>
    </div>
  `}function Fi(e){const n=document.getElementById(e);if(!n){console.error("‚ùå Keyboard app window not found:",e);return}if(n.dataset.keyboardInitialized==="true"){const b=n.querySelector("#keyboard-categories");if(n.querySelector("#keyboard-shortcuts-list"),b&&b.children.length===0)n.dataset.keyboardInitialized="false";else return}console.log("üéπ Initializing keyboard app UI...");let t="global",o=null,i=null;const r="ontouchstart"in window||navigator.maxTouchPoints>0,a=document.getElementById("keyboard-touch-banner");r&&a&&a.classList.remove("hidden");const s={"global.toggleStartMenu":"Tap Start button","global.cycleWindows":"Swipe left/right on taskbar","global.minimizeActiveWindow":"Two-finger swipe down on window title bar","global.closeActiveWindow":"Tap the X button on the window title bar","global.showDesktop":"Two-finger tap on desktop","global.escapeAction":"Tap outside the menu/dialog","desktop.activateIcon":"Double-tap icon","desktop.moveUp":"Drag icon up","desktop.moveDown":"Drag icon down","desktop.moveLeft":"Drag icon left","desktop.moveRight":"Drag icon right","desktop.fineMoveUp":"Drag icon up (slowly)","desktop.fineMoveDown":"Drag icon down (slowly)","desktop.fineMoveLeft":"Drag icon left (slowly)","desktop.fineMoveRight":"Drag icon right (slowly)","startMenu.navigateDown":"Scroll and tap items","startMenu.navigateUp":"Scroll and tap items","startMenu.enterSubmenu":"Tap submenu","startMenu.exitSubmenu":"Tap Back or outside","startMenu.activateItem":"Tap item","startMenu.close":"Tap outside menu","fileExplorer.rename":"Long-press item ‚Üí Rename","contextMenu.navigateDown":"Scroll menu and tap","contextMenu.navigateUp":"Scroll menu and tap","contextMenu.enterSubmenu":"Tap submenu","contextMenu.exitSubmenu":"Tap outside menu","contextMenu.activateItem":"Tap menu item","contextMenu.close":"Tap outside menu","window.minimize":"Tap _ button or two-finger swipe down on title bar","window.maximize":"Tap ‚õ∂ button or two-finger swipe up on title bar","window.close":"Tap X button","taskbar.activateButton":"Tap taskbar button","taskbar.mediaControl":"Tap media control","taskbar.minimizeAll":"Tap Show Desktop or two-finger tap on desktop"};function l(b){return r&&s[b]||null}Be.initialize().then(()=>{console.log("üéπ Keyboard service ready, populating UI..."),d(),c("global"),P("Keyboard service initialized")}).catch(b=>{console.error("‚ùå Failed to initialize keyboard service:",b),P("Failed to initialize keyboard service")});function d(){const b=Be.getShortcutsByContext(),h=n.querySelector("#keyboard-categories"),x={global:"Global",desktop:"Desktop",startMenu:"Start Menu",fileExplorer:"File Explorer",contextMenu:"Context Menu",window:"Windows",taskbar:"Taskbar"},A={global:"image/html.webp",desktop:"image/desktop.webp",startMenu:"image/door-icon.webp",fileExplorer:"image/folder.webp",contextMenu:"image/doc.webp",window:"image/generic-window.webp",taskbar:"image/desktop.webp"};h.innerHTML="",Object.keys(b).forEach(W=>{const Y=document.createElement("button");Y.className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 text-sm flex items-center space-x-2";const ie=document.createElement("img");ie.src=A[W]||"image/file.webp",ie.className="w-4 h-4",ie.alt="";const we=document.createElement("span");we.textContent=x[W]||W,Y.appendChild(ie),Y.appendChild(we),Y.onclick=()=>c(W),h.appendChild(Y)})}function c(b){t=b;const h=Be.getShortcutsByContext()[b]||[],x={global:"Global Shortcuts",desktop:"Desktop Shortcuts",startMenu:"Start Menu Navigation",fileExplorer:"File Explorer",contextMenu:"Context Menus",window:"Window Management",taskbar:"Taskbar Controls"},A={global:"System-wide keyboard shortcuts",desktop:"Desktop icon management and navigation",startMenu:"Start menu navigation and activation",fileExplorer:"File and folder operations",contextMenu:"Context menu navigation",window:"Window control operations",taskbar:"Taskbar button and control shortcuts"};n.querySelector("#keyboard-category-title").textContent=x[b]||b,n.querySelector("#keyboard-category-desc").textContent=A[b]||"",n.querySelectorAll("#keyboard-categories button").forEach(Y=>{Y.classList.remove("bg-gray-100","border-gray-300")});const W=Array.from(n.querySelectorAll("#keyboard-categories button")).find(Y=>{const ie=Y.querySelector("span");return ie&&ie.textContent===(x[b]||b)});W&&W.classList.add("bg-gray-100","border-gray-300"),m(h),P(`Showing ${h.length} shortcuts in ${x[b]}`),n.querySelector("#keyboard-count").textContent=`${h.length} shortcuts`}function m(b){const h=n.querySelector("#keyboard-shortcuts-list");if(h.innerHTML="",b.length===0){h.innerHTML='<div class="text-center text-gray-500 py-8">No shortcuts in this category</div>';return}b.forEach(x=>{var ee;const A=document.createElement("div");A.className="bg-white border border-gray-200 rounded-lg p-4 mb-3 hover:shadow-md transition-shadow";const W=x.isCustom,Y=((ee=Be.defaultShortcuts[x.id])==null?void 0:ee.key)||"",ie=l(x.id);A.innerHTML=`
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="flex items-center space-x-2">
              <h3 class="font-medium text-gray-800">${x.description}</h3>
              ${W?'<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">Custom</span>':""}
            </div>
            <p class="text-sm text-gray-500 mt-1">Action: ${x.id}</p>
            ${W?`<p class="text-xs text-gray-400 mt-1">Default: ${Y}</p>`:""}
            ${ie?`<p class="text-xs text-blue-700 mt-2"><span class="bg-blue-50 border border-blue-200 rounded px-2 py-0.5">Touch: ${ie}</span></p>`:""}
          </div>
          <div class="flex items-center space-x-2">
            <code class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">${x.key}</code>
            <div class="edit-shortcut-btn" data-shortcut-id="${x.id}"></div>
            ${W?`<div class="reset-shortcut-btn" data-shortcut-id="${x.id}"></div>`:""}
          </div>
        </div>
      `,h.appendChild(A);const we=A.querySelector(".edit-shortcut-btn"),Q=de("Edit");if(Q.onclick=()=>u(x.id),we.appendChild(Q),W){const he=A.querySelector(".reset-shortcut-btn"),C=de("Reset");C.onclick=()=>k(x.id),he.appendChild(C)}})}function u(b){o=b,i=null;const h=Be.shortcuts.get(b),x=h?h.description:b,A="keyboard-capture-window",W=`
      <div class="p-4 bg-gray-100 h-full flex flex-col">
        <h3 class="text-lg font-bold mb-4">Remap Shortcut</h3>
        <p class="mb-4">Remapping: <strong>${x}</strong></p>
        <div class="flex-1 flex items-center justify-center">
          <div id="keyboard-capture-display" class="text-xl font-mono bg-white p-6 border-2 border-gray-400 text-center min-w-64" style="border-style: inset;">
            Press any key combination...
          </div>
        </div>
        <p class="text-sm text-gray-600 mb-4 text-center">
          Press the key combination you want to assign.<br>
          Press Escape to cancel.
        </p>
        <div class="flex justify-center space-x-2">
          <div id="keyboard-capture-cancel-btn"></div>
          <div id="keyboard-capture-save-btn"></div>
        </div>
      </div>
    `;se("Capture Key Combination",W,!1,A,!1,!1,{type:"integer",width:400,height:250},"default"),setTimeout(()=>{const Y=document.getElementById(A);if(!Y)return;const ie=Y.querySelector("#keyboard-capture-cancel-btn"),we=Y.querySelector("#keyboard-capture-save-btn"),Q=de("Cancel");Q.onclick=()=>{p(),le(A)},ie.appendChild(Q);const ee=de("Save");ee.disabled=!0,ee.onclick=()=>{g(),le(A)},we.appendChild(ee),document.addEventListener("keydown",f,!0),Y.focus()},100)}function f(b){if(b.preventDefault(),b.stopPropagation(),b.key==="Escape"){p(),le("keyboard-capture-window");return}i=Be.getKeyCombo(b);const h=document.getElementById("keyboard-capture-window");if(!h)return;const x=h.querySelector("#keyboard-capture-display"),A=h.querySelector("#keyboard-capture-save-btn");x.textContent=i;const W=A.querySelector("button");W&&(W.disabled=!1)}function p(){document.removeEventListener("keydown",f,!0),o=null,i=null}function g(){if(!(!o||!i)){try{Be.remapShortcut(o,i),c(t),P(`Shortcut updated: ${o} ‚Üí ${i}`)}catch(b){P(`Error: ${b.message}`)}p()}}function k(b){Be.removeCustomMapping(b),c(t),P(`Shortcut reset to default: ${b}`)}function v(){typeof window.showDialogBox=="function"?window.showDialogBox("Are you sure you want to reset all shortcuts to their defaults? This cannot be undone.","confirm",b=>{b&&(Be.resetToDefaults(),c(t),P("All shortcuts reset to defaults"))}):confirm("Are you sure you want to reset all shortcuts to their defaults? This cannot be undone.")&&(Be.resetToDefaults(),c(t),P("All shortcuts reset to defaults"))}function y(){const b={customMappings:Object.fromEntries(Be.customMappings),timestamp:Date.now(),version:"1.0"},h=new Blob([JSON.stringify(b,null,2)],{type:"application/json"}),x=URL.createObjectURL(h),A=document.createElement("a");A.href=x,A.download="keyboard-shortcuts.json",A.click(),URL.revokeObjectURL(x),P("Settings exported successfully")}function P(b){n.querySelector("#keyboard-status").textContent=b}function j(b,h){n.querySelector("#keyboard-category-title").textContent=`Search Results for "${b}"`,n.querySelector("#keyboard-category-desc").textContent=`Found ${h.length} shortcuts across all categories`,n.querySelectorAll("#keyboard-categories button").forEach(x=>{x.classList.remove("bg-gray-100","border-gray-300")}),K(h),P(`${h.length} shortcuts found for "${b}"`),n.querySelector("#keyboard-count").textContent=`${h.length} shortcuts found`}function K(b){const h=n.querySelector("#keyboard-shortcuts-list");if(h.innerHTML="",b.length===0){h.innerHTML='<div class="text-center text-gray-500 py-8">No shortcuts found matching your search</div>';return}const x={};b.forEach(Y=>{const ie=Y.id.split(".")[0];x[ie]||(x[ie]=[]),x[ie].push(Y)});const A={global:"Global",desktop:"Desktop",startMenu:"Start Menu",fileExplorer:"File Explorer",contextMenu:"Context Menu",window:"Windows",taskbar:"Taskbar"},W={global:"image/html.webp",desktop:"image/desktop.webp",startMenu:"image/door-icon.webp",fileExplorer:"image/folder.webp",contextMenu:"image/doc.webp",window:"image/generic-window.webp",taskbar:"image/desktop.webp"};Object.keys(x).forEach(Y=>{const ie=x[Y],we=document.createElement("div");we.className="mb-2 mt-4 first:mt-0",we.innerHTML=`
        <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wide border-b border-gray-200 pb-1 flex items-center space-x-2">
          <img src="${W[Y]||"image/file.webp"}" class="w-4 h-4" alt="">
          <span>${A[Y]||Y} (${ie.length})</span>
        </h3>
      `,h.appendChild(we),ie.forEach(Q=>{var E;const ee=document.createElement("div");ee.className="bg-white border border-gray-200 rounded-lg p-4 mb-3 hover:shadow-md transition-shadow";const he=Q.isCustom,C=((E=Be.defaultShortcuts[Q.id])==null?void 0:E.key)||"",M=l(Q.id);ee.innerHTML=`
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <div class="flex items-center space-x-2">
                <h3 class="font-medium text-gray-800">${Q.description}</h3>
                ${he?'<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">Custom</span>':""}
              </div>
              <p class="text-sm text-gray-500 mt-1">Action: ${Q.id}</p>
              ${he?`<p class="text-xs text-gray-400 mt-1">Default: ${C}</p>`:""}
      ${M?`<p class="text-xs text-blue-700 mt-2"><span class="bg-blue-50 border border-blue-200 rounded px-2 py-0.5">Touch: ${M}</span></p>`:""}
            </div>
            <div class="flex items-center space-x-2">
              <code class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">${Q.key}</code>
              <div class="edit-shortcut-btn" data-shortcut-id="${Q.id}"></div>
              ${he?`<div class="reset-shortcut-btn" data-shortcut-id="${Q.id}"></div>`:""}
            </div>
          </div>
        `,h.appendChild(ee);const O=ee.querySelector(".edit-shortcut-btn"),S=de("Edit");if(S.onclick=()=>u(Q.id),O.appendChild(S),he){const $=ee.querySelector(".reset-shortcut-btn"),w=de("Reset");w.onclick=()=>k(Q.id),$.appendChild(w)}})})}function T(){n.querySelector("#keyboard-search").addEventListener("input",h=>{const x=h.target.value.toLowerCase();if(!x.trim()){c(t);return}const W=Be.getShortcuts().filter(Y=>Y.description.toLowerCase().includes(x)||Y.key.toLowerCase().includes(x)||Y.id.toLowerCase().includes(x));j(x,W)})}const q=n.querySelector("#keyboard-reset-btn-container"),z=n.querySelector("#keyboard-export-btn-container"),R=n.querySelector("#keyboard-help-btn-container"),_=de("Reset All to Defaults");_.onclick=v,_.style.width="100%",q.appendChild(_);const Z=de("Export Settings");Z.onclick=y,Z.style.width="100%",z.appendChild(Z);const J=de("Help");J.onclick=()=>{typeof window.showDialogBox=="function"&&window.showDialogBox(`
        <h3>Keyboard Shortcuts Help</h3>
        <p><strong>Editing Shortcuts:</strong> Click "Edit" next to any shortcut to assign a new key combination.</p>
        <p><strong>Resetting:</strong> Use "Reset" to restore a shortcut to its default, or "Reset All" for everything.</p>
        <p><strong>Key Combinations:</strong> You can use Ctrl, Alt, Shift, and Meta (Windows/Cmd) keys with letters, numbers, and function keys.</p>
        <p><strong>Search:</strong> Use the search box to quickly find specific shortcuts.</p>
        <p><strong>Export:</strong> Save your custom shortcuts to a file for backup or sharing.</p>
  ${r?"<p><strong>Touch:</strong> Swipe the taskbar to switch windows; two-finger tap on the desktop to show the desktop; two-finger swipe on a window title bar to minimize (down) or maximize (up). Touch equivalents appear under each shortcut.</p>":""}
      `,"info")},R.appendChild(J),T(),n.dataset.keyboardInitialized="true"}typeof window<"u"&&(window.keyboardService=Be,window.launchKeyboard=Ti,window.initializeKeyboardApp=Fi);function no({windowId:e,container:n,overlayText:t="Paused",overlayZ:o=50}){if(!n)throw new Error("Pause controller: container required");const i=n.style.position;(!i||i==="static")&&(n.style.position="relative");const r=document.createElement("div");r.className="game-pause-overlay",Object.assign(r.style,{position:"absolute",inset:"0",display:"none",background:"rgba(0,0,0,0.55)",color:"white",fontFamily:"monospace",fontSize:"36px",fontWeight:"bold",alignItems:"center",justifyContent:"center",zIndex:String(o),pointerEvents:"none"}),r.textContent=t,n.appendChild(r);let a=!1,s=!1;function l(){const p=Array.from(document.querySelectorAll("#windows-container > div")).filter(g=>g.style.display!=="none"&&g.id!=="taskbar");return p.length?(p.sort((g,k)=>(parseInt(k.style.zIndex)||0)-(parseInt(g.style.zIndex)||0)),p[0].id||null):null}function d(){if(s)return;const p=document.hidden||l()!==e;p!==a&&(a=p,r.style.display=a?"flex":"none")}function c(){d()}document.addEventListener("visibilitychange",c);const m=document.getElementById("windows-container");let u=null;m&&"MutationObserver"in window&&(u=new MutationObserver(()=>{requestAnimationFrame(d)}),u.observe(m,{childList:!0,subtree:!1}));function f(){s=!0,document.removeEventListener("visibilitychange",c),u&&u.disconnect(),r&&r.parentElement===n&&r.remove()}return{get paused(){return a},overlay:r,recompute:d,destroy:f}}function $i(){const e=document.getElementById("pong");if(e){Ie(e);return}const n=se("Pong","",!1,"pong",!1,!1,{type:"integer",width:700,height:500},"App",null,"black");oo(n).catch(console.error)}async function oo(e){if(!e&&(e=document.getElementById("pong"),!e))return;const n=e.querySelector(".p-2");n.className="p-2 bg-black h-full overflow-hidden flex flex-col",n.innerHTML="";const t=document.createElement("div");t.className="flex items-center justify-between text-white px-2 pb-2",t.style.fontFamily="monospace",t.innerHTML='<div>üôã Player</div><div id="pong-score">0 - 0</div><div>High: <span id="pong-high-score">0</span></div>';const o=document.createElement("div");o.className="flex-1 flex items-center justify-center";const i=document.createElement("canvas");i.id="pong-canvas",i.style.background="#000",i.style.border="2px inset #666",i.width=640,i.height=360,o.appendChild(i);const r=document.createElement("div");r.className="text-xs text-gray-300 pt-2",r.textContent="Controls: W/S or Up/Down to move paddle. Click canvas to focus.",n.appendChild(t),n.appendChild(o),n.appendChild(r);const a=i.getContext("2d");let s=0,l=0,d=0;d=await B.getItem("pong-high-score")||0;const c={paddleHeight:60,paddleWidth:8,playerY:(i.height-60)/2,aiY:(i.height-60)/2,ballX:i.width/2,ballY:i.height/2,ballVX:3,ballVY:2,ballRadius:6,upPressed:!1,downPressed:!1,running:!0,rafId:null},m=no({windowId:"pong",container:o,overlayZ:10});function u(T=1){c.ballX=i.width/2,c.ballY=i.height/2,c.ballVX=3*T,c.ballVY=Math.random()*3-1.5}function f(){a.fillStyle="#000",a.fillRect(0,0,i.width,i.height),a.fillStyle="#444";for(let T=0;T<i.height;T+=20)a.fillRect(i.width/2-1,T+5,2,10);a.fillStyle="#fff",a.fillRect(20,c.playerY,c.paddleWidth,c.paddleHeight),a.fillRect(i.width-20-c.paddleWidth,c.aiY,c.paddleWidth,c.paddleHeight),a.beginPath(),a.arc(c.ballX,c.ballY,c.ballRadius,0,Math.PI*2),a.fill()}function p(T){c.upPressed&&(c.playerY-=6*T),c.downPressed&&(c.playerY+=6*T),c.playerY=Math.max(0,Math.min(i.height-c.paddleHeight,c.playerY));const q=c.aiY+c.paddleHeight/2;if(q<c.ballY-10&&(c.aiY+=3.2*T),q>c.ballY+10&&(c.aiY-=3.2*T),c.aiY=Math.max(0,Math.min(i.height-c.paddleHeight,c.aiY)),c.ballX+=c.ballVX*T,c.ballY+=c.ballVY*T,(c.ballY-c.ballRadius<=0||c.ballY+c.ballRadius>=i.height)&&(c.ballVY=-c.ballVY),c.ballX-c.ballRadius<=20+c.paddleWidth&&c.ballY>=c.playerY&&c.ballY<=c.playerY+c.paddleHeight){c.ballVX=-c.ballVX;const z=(c.ballY-(c.playerY+c.paddleHeight/2))/(c.paddleHeight/2);c.ballVY+=z*2,c.ballX=20+c.paddleWidth+c.ballRadius+1}if(c.ballX+c.ballRadius>=i.width-20-c.paddleWidth&&c.ballY>=c.aiY&&c.ballY<=c.aiY+c.paddleHeight){c.ballVX=-c.ballVX;const z=(c.ballY-(c.aiY+c.paddleHeight/2))/(c.paddleHeight/2);c.ballVY+=z*2,c.ballX=i.width-20-c.paddleWidth-c.ballRadius-1}c.ballX<0&&(l+=1,v(),u(1)),c.ballX>i.width&&(s+=1,s>d&&(d=s,B.setItemSync("pong-high-score",d),window.isDevvit&&window.parent.postMessage({type:"setGameScore",data:{game:"pong",score:d}},"*")),v(),u(-1))}let g=null;function k(T){if(!c.running)return;m.recompute(),g==null&&(g=T);const q=T-g;g=T;let z=q/(1e3/60);z>3&&(z=3),m.paused||(p(z),f()),c.rafId=requestAnimationFrame(k)}function v(){const T=document.getElementById("pong-score"),q=document.getElementById("pong-high-score");T&&(T.textContent=`${s} - ${l}`),q&&(q.textContent=String(d))}function y(T){(T.key==="w"||T.key==="W"||T.key==="ArrowUp")&&(c.upPressed=!0),(T.key==="s"||T.key==="S"||T.key==="ArrowDown")&&(c.downPressed=!0)}function P(T){(T.key==="w"||T.key==="W"||T.key==="ArrowUp")&&(c.upPressed=!1),(T.key==="s"||T.key==="S"||T.key==="ArrowDown")&&(c.downPressed=!1)}i.addEventListener("click",()=>i.focus()),i.setAttribute("tabindex","0"),i.style.outline="none",document.addEventListener("keydown",y),document.addEventListener("keyup",P);const j=new MutationObserver(T=>{T.forEach(q=>{q.removedNodes.forEach(z=>{z.id==="pong"&&(K(),j.disconnect())})})});j.observe(document.getElementById("windows-container"),{childList:!0});function K(){c.running=!1,c.rafId&&cancelAnimationFrame(c.rafId),document.removeEventListener("keydown",y),document.removeEventListener("keyup",P),m.destroy()}u(1),v(),c.rafId=requestAnimationFrame(k)}typeof window<"u"&&(window.initializePongUI=oo);function Pi(){const e=document.getElementById("snake");if(e){Ie(e);return}const n=se("Snake","",!1,"snake",!1,!1,{type:"integer",width:620,height:520},"App",null,"black");io(n).catch(console.error)}async function io(e){if(!e&&(e=document.getElementById("snake"),!e))return;const n=e.querySelector(".p-2");n.className="p-2 bg-black h-full overflow-hidden flex flex-col items-center",n.innerHTML="";const t=document.createElement("div");t.className="w-full flex items-center justify-between text-white px-2 pb-2",t.style.fontFamily="monospace",t.innerHTML='<div>Score: <span id="snake-score">0</span></div><div id="snake-status">Playing</div><div>High: <span id="snake-high-score">0</span></div>';const o=document.createElement("div");o.className="flex-1 flex items-center justify-center w-full";const i=document.createElement("canvas");i.id="snake-canvas",i.width=560,i.height=420,i.style.background="#000",i.style.border="2px inset #666",o.appendChild(i);const r=document.createElement("div");r.className="text-xs text-gray-300 pt-2",r.textContent="Controls: Arrow keys or W/A/S/D. Press R to restart.",n.appendChild(t),n.appendChild(o),n.appendChild(r);const a=i.getContext("2d"),s=20,l=Math.floor(i.width/s),d=Math.floor(i.height/s);let c=[{x:Math.floor(l/2),y:Math.floor(d/2)}],m={x:1,y:0},u=null,f=0,p=0,g=!0,k=8,v=0,y=null;const P=no({windowId:"snake",container:o,overlayZ:10});p=await B.getItem("snake-high-score")||0;function j(){let h=!1;for(;!h;){const x=Math.floor(Math.random()*l),A=Math.floor(Math.random()*d);h=!c.some(W=>W.x===x&&W.y===A),h&&(u={x,y:A})}}function K(){c=[{x:Math.floor(l/2),y:Math.floor(d/2)}],m={x:1,y:0},f=0,g=!0,k=8,j(),T()}function T(){const h=document.getElementById("snake-score"),x=document.getElementById("snake-status"),A=document.getElementById("snake-length"),W=document.getElementById("snake-high-score");h&&(h.textContent=String(f)),x&&(x.textContent=g?"Playing":"Game Over"),A&&(A.textContent=String(c.length)),W&&(W.textContent=String(p))}function q(){a.fillStyle="#000",a.fillRect(0,0,i.width,i.height),u&&(a.fillStyle="#e3342f",a.fillRect(u.x*s,u.y*s,s,s));for(let h=0;h<c.length;h++){const x=c[h];a.fillStyle=h%2===0?"#7ed957":"#5aa83d",a.fillRect(x.x*s,x.y*s,s-1,s-1)}}function z(){if(!g)return;const h={x:c[0].x+m.x,y:c[0].y+m.y};if(h.x<0&&(h.x=l-1),h.x>=l&&(h.x=0),h.y<0&&(h.y=d-1),h.y>=d&&(h.y=0),c.some(x=>x.x===h.x&&x.y===h.y)){g=!1,T();return}c.unshift(h),u&&h.x===u.x&&h.y===u.y?(f+=1,f>p&&(p=f,B.setItemSync("snake-high-score",p),window.isDevvit&&window.parent.postMessage({type:"setGameScore",data:{game:"snake",score:p}},"*")),f%5===0&&(k=Math.min(20,k+1)),j()):c.pop(),T()}let R=0;function _(h){v||(v=h),P.recompute();let x=h-v;x>1e3&&(x=1e3),v=h,P.paused||(R+=x);const A=1e3/k;let W=!1;for(;R>=A;)z(),R-=A,W=!0;W&&!P.paused&&q(),y=requestAnimationFrame(_)}function Z(h){const x=h.key;(x==="ArrowUp"||x==="w"||x==="W")&&m.y===0&&(m={x:0,y:-1}),(x==="ArrowDown"||x==="s"||x==="S")&&m.y===0&&(m={x:0,y:1}),(x==="ArrowLeft"||x==="a"||x==="A")&&m.x===0&&(m={x:-1,y:0}),(x==="ArrowRight"||x==="d"||x==="D")&&m.x===0&&(m={x:1,y:0}),(x==="r"||x==="R")&&K()}i.addEventListener("click",()=>i.focus()),i.setAttribute("tabindex","0"),i.style.outline="none",document.addEventListener("keydown",Z);const J=new MutationObserver(h=>{h.forEach(x=>{x.removedNodes.forEach(A=>{A.id==="snake"&&(b(),J.disconnect())})})});J.observe(document.getElementById("windows-container"),{childList:!0});function b(){g=!1,y&&cancelAnimationFrame(y),document.removeEventListener("keydown",Z),P.destroy()}K(),q(),y=requestAnimationFrame(_)}typeof window<"u"&&(window.initializeSnakeUI=io);function zi(){const e=document.getElementById("happyturd");if(e){Ie(e);return}const n=se("Happy Turd","",!1,"happyturd",!1,!1,{type:"integer",width:360,height:640},"App",null,"black");ro(n).catch(console.error)}async function ro(e){if(!e&&(e=document.getElementById("happyturd"),!e))return;const n=e.querySelector(".p-2");n.className="p-2 bg-black h-full overflow-hidden flex flex-col",n.innerHTML="";let t=await B.getItem("happyturd-difficulty")||"medium",o=we(t),i=await B.getItem("happyturd-theme")||"system";const r=document.createElement("div");r.className="flex items-center justify-between px-2 py-1 bg-gray-800 border-b border-gray-600",r.innerHTML=`
    <div class="flex items-center gap-2">
      <div class="relative">
        <button id="difficultyMenuBtn" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded border border-gray-600 flex items-center gap-1" onclick="toggleDifficultyDropdown(event)">
          Difficulty
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div id="difficultyDropdown" class="absolute left-0 top-full mt-1 w-32 bg-gray-700 border border-gray-600 rounded shadow-lg z-50 hidden">
          <button class="w-full text-left px-3 py-2 text-white hover:bg-gray-600 flex items-center justify-between text-sm" onclick="setDifficulty('easy')">
            <span>Easy</span>
            <span id="easy-check" class="text-green-400 ${t==="easy"?"":"hidden"}">‚úì</span>
          </button>
          <button class="w-full text-left px-3 py-2 text-white hover:bg-gray-600 flex items-center justify-between text-sm" onclick="setDifficulty('medium')">
            <span>Medium</span>
            <span id="medium-check" class="text-green-400 ${t==="medium"?"":"hidden"}">‚úì</span>
          </button>
          <button class="w-full text-left px-3 py-2 text-white hover:bg-gray-600 flex items-center justify-between text-sm" onclick="setDifficulty('hard')">
            <span>Hard</span>
            <span id="hard-check" class="text-green-400 ${t==="hard"?"":"hidden"}">‚úì</span>
          </button>
        </div>
      </div>
      <div class="relative">
        <button id="themeMenuBtn" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded border border-gray-600 flex items-center gap-1" onclick="toggleThemeDropdown(event)">
          Theme
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div id="themeDropdown" class="absolute left-0 top-full mt-1 w-32 bg-gray-700 border border-gray-600 rounded shadow-lg z-50 hidden">
          <button class="w-full text-left px-3 py-2 text-white hover:bg-gray-600 flex items-center justify-between text-sm" onclick="setTheme('system')">
            <span>System</span>
            <span id="system-check" class="text-green-400 ${i==="system"?"":"hidden"}">‚úì</span>
          </button>
          <button class="w-full text-left px-3 py-2 text-white hover:bg-gray-600 flex items-center justify-between text-sm" onclick="setTheme('light')">
            <span>Light</span>
            <span id="light-check" class="text-green-400 ${i==="light"?"":"hidden"}">‚úì</span>
          </button>
          <button class="w-full text-left px-3 py-2 text-white hover:bg-gray-600 flex items-center justify-between text-sm" onclick="setTheme('dark')">
            <span>Dark</span>
            <span id="dark-check" class="text-green-400 ${i==="dark"?"":"hidden"}">‚úì</span>
          </button>
        </div>
      </div>
    </div>
  `;const a=document.createElement("div");a.className="w-full flex items-center justify-between text-white px-2 pb-2",a.style.fontFamily="monospace",a.innerHTML='<div>Best: <span id="happyturd-best">0</span></div><div id="happyturd-score">0</div><div id="happyturd-status">Playing</div>';const s=document.createElement("div");s.className="flex-1 flex items-center justify-center w-full";const l=document.createElement("canvas");l.id="happyturd-canvas",l.width=320,l.height=480,l.style.background="#87ceeb",l.style.border="2px inset #666",s.appendChild(l);const d=document.createElement("div");d.id="happyturd-intro",d.className="absolute inset-0 bg-black/70 flex flex-col items-center justify-center z-10",d.style.display="flex",d.style.fontFamily="monospace";const c=document.createElement("img");c.src="/image/happyturd.webp",c.alt="Happy Turd Logo",c.className="w-32 h-32 mb-8 drop-shadow-lg";const m=document.createElement("h1");m.textContent="Happy Turd",m.className="text-white text-lg md:text-xl font-bold mb-2 md:mb-8 text-center drop-shadow-lg",m.style.fontFamily="monospace";const u=document.createElement("div");u.className="text-white text-xs md:text-sm mb-2 md:mb-8 text-left max-w-xs drop-shadow",u.style.fontFamily="monospace",u.innerHTML=`
    <p class="mb-4">Help the turd fly past the pipes!</p>
    <p class="mb-2">‚Ä¢ Click or press SPACE to flap</p>
    <p class="mb-2">‚Ä¢ Avoid the pipes</p>
    <p class="mb-2">‚Ä¢ Collect points by passing between the pipes</p>
    <p class="mb-4">‚Ä¢ Don't hit the ground, ceiling, or pipes</p>
  `;const f=document.createElement("button");f.textContent="Start Game",f.className=" px-4 md:px-8 py-1.5 md:py-3 bg-green-600 hover:bg-green-700 text-white text-xl font-bold rounded-lg border-2 border-green-400 transition-colors drop-shadow-lg",f.style.fontFamily="monospace",f.onclick=()=>tt(),d.appendChild(c),d.appendChild(m),d.appendChild(u),d.appendChild(f);const p=document.createElement("div");p.id="happyturd-gameover",p.className="absolute inset-0 bg-black/20 flex flex-col items-center justify-center z-10",p.style.display="none",p.style.fontFamily="monospace",p.style.opacity="0",p.style.transition="opacity 200ms ease-in-out";const g=document.createElement("h1");g.textContent="Game Over",g.className="text-white text-3xl font-bold mb-6 text-center drop-shadow-lg",g.style.fontFamily="monospace";const k=document.createElement("div");k.className="text-white text-xl mb-4 text-center drop-shadow",k.style.fontFamily="monospace",k.innerHTML=`
    <p class="mb-2">Score: <span id="gameover-score" class="text-yellow-400 font-bold">0</span></p>
    <p class="mb-2">Best: <span id="gameover-best" class="text-green-400 font-bold">0</span></p>
    <p id="new-high-score" class="text-red-400 font-bold text-lg" style="display: none;">üéâ New High Score! üéâ</p>
  `;const v=document.createElement("button");v.textContent="Try Again",v.className="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold rounded-lg border-2 border-blue-400 transition-colors drop-shadow-lg mt-4",v.style.fontFamily="monospace",v.onclick=()=>rt(),p.appendChild(g),p.appendChild(k),p.appendChild(v),s.style.position="relative",s.appendChild(d),s.appendChild(p),n.appendChild(r),n.appendChild(a),n.appendChild(s);const y=l.getContext("2d");let P=0,j=0;const K=.45,T=-8.5;let q=0,z=60,R=l.height/2;const _=28;let Z="intro",J=0,b=0;const h=8,x=2;let A=[],W=!1;const Y=120;let ie=0;j=await B.getItem("happyturd-best-score")||0;function we(N){switch(N){case"easy":return 260;case"medium":return 195;case"hard":return 130;default:return 195}}window.toggleDifficultyDropdown=function(N){N.stopPropagation(),document.getElementById("difficultyDropdown").classList.toggle("hidden")},window.setDifficulty=async function(N){t=N,o=we(N),document.getElementById("easy-check").classList.toggle("hidden",N!=="easy"),document.getElementById("medium-check").classList.toggle("hidden",N!=="medium"),document.getElementById("hard-check").classList.toggle("hidden",N!=="hard"),await B.setItem("happyturd-difficulty",N),document.getElementById("difficultyDropdown").classList.add("hidden"),Te()},document.addEventListener("click",function(N){const V=document.getElementById("difficultyDropdown"),G=document.getElementById("difficultyMenuBtn");V&&G&&!V.contains(N.target)&&!G.contains(N.target)&&V.classList.add("hidden")}),window.toggleThemeDropdown=function(N){N.stopPropagation(),document.getElementById("themeDropdown").classList.toggle("hidden")},window.setTheme=async function(N){i=N,document.getElementById("system-check").classList.toggle("hidden",N!=="system"),document.getElementById("light-check").classList.toggle("hidden",N!=="light"),document.getElementById("dark-check").classList.toggle("hidden",N!=="dark"),await B.setItem("happyturd-theme",N),document.getElementById("themeDropdown").classList.add("hidden"),L(),ne&&cancelAnimationFrame(ne),ne=requestAnimationFrame(En)},document.addEventListener("click",function(N){const V=document.getElementById("themeDropdown"),G=document.getElementById("themeMenuBtn");V&&G&&!V.contains(N.target)&&!G.contains(N.target)&&V.classList.add("hidden")});const Q=[],ee=52;let he=0;const C=90;let M=[],O=[],S=[],E=[];const $=()=>i==="dark"?!0:i==="light"?!1:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;let w=[];const L=()=>{w=$()?Array.from({length:50},()=>({x:Math.random()*l.width,y:Math.random()*(l.height*.6),size:Math.random()*2+.5,brightness:Math.random()*.5+.5})):[]};L();const I={x:l.width*.8,y:50,size:35,rays:Array.from({length:12},(N,V)=>({angle:V/12*Math.PI*2,length:35*(.8+Math.random()*.4)}))};let U=!0,ne=null;const te=no({windowId:"happyturd",container:s,overlayZ:30});function H(){const N=40+Math.random()*(l.height-o-120);Q.push({x:l.width,top:N,passed:!1})}function ye(){const N=20+Math.random()*100,V=20+Math.random()*30;M.push({x:l.width+Math.random()*200,y:N,size:V,puffs:Array.from({length:3+Math.floor(Math.random()*3)},()=>({x:(Math.random()-.5)*V,y:(Math.random()-.5)*V*.5,radius:V*(.3+Math.random()*.4)}))})}function fe(){const N=l.height,V=200+Math.random()*150,G=40+Math.random()*80;O.push({x:l.width+Math.random()*300,baseY:N,width:V,height:G,color:`hsl(${80+Math.random()*40}, ${30+Math.random()*20}%, ${30+Math.random()*30}%)`})}function Le(){const N=l.height-40,V=80+Math.random()*100,G=60+Math.random()*80;S.push({x:l.width+Math.random()*500,baseY:N,height:V,width:G,peaks:Array.from({length:2+Math.floor(Math.random()*3)},()=>({offset:(Math.random()-.5)*G*.8,height:.7+Math.random()*.3}))})}function Me(){const N=50+Math.floor(Math.random()*10);for(let V=0;V<N;V++)E.push({x:Math.random()*l.width,height:15+Math.random()*10})}function Oe(N,V){A=[],W=!0,ie=Y;const G=15+Math.floor(Math.random()*6);for(let F=0;F<G;F++){const ue=Math.PI*2*F/G+(Math.random()-.5)*.5,me=2+Math.random()*4,xe=3+Math.random()*5;A.push({x:N,y:V,vx:Math.cos(ue)*me,vy:Math.sin(ue)*me-Math.random()*2,size:xe,opacity:1,rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*.2})}}function tt(){Z="playing";const N=document.getElementById("happyturd-intro");N&&(N.style.display="none"),Te()}function rt(){const N=document.getElementById("happyturd-gameover");N&&(N.style.opacity="0",setTimeout(()=>{N.style.display="none"},200)),Te()}function Te(){P=0,q=0,R=l.height/2,Q.length=0,he=0,U=!0,Z="playing",at();const N=document.getElementById("happyturd-gameover");N&&(N.style.opacity="0",setTimeout(()=>{N.style.display="none"},200)),A=[],W=!1,ie=0,M.length=0,O.length=0,S.length=0,E.length=0;for(let V=0;V<5;V++)ye();for(let V=0;V<3;V++)fe();for(let V=0;V<4;V++)Le();Me()}function at(){const N=document.getElementById("happyturd-score"),V=document.getElementById("happyturd-status"),G=document.getElementById("happyturd-best");N&&(N.textContent=String(P)),V&&(Z==="intro"?V.textContent="Ready":V.textContent=U?"Playing":"Game Over"),G&&(G.textContent=String(j))}function Fe(N,V){J>0&&(y.font=`${_*1}px serif`,y.textAlign="center",y.textBaseline="middle",y.save(),y.translate(N-_*.4,V),y.scale(-1,1),y.fillText("ü™Ω",0,0),y.restore(),y.fillText("ü™Ω",N+_*.4,V));const G=U?"üí©":"‚ò†Ô∏è";y.font=`${_}px serif`,y.fillText(G,N,V+2)}function yt(){const N=$(),V=y.createLinearGradient(0,0,0,l.height);N?(V.addColorStop(0,"#000011"),V.addColorStop(1,"#000033")):(V.addColorStop(0,"#87ceeb"),V.addColorStop(1,"#4a90e2")),y.fillStyle=V,y.fillRect(0,0,l.width,l.height),N&&(y.fillStyle="rgba(255, 255, 255, 0.8)",w.forEach(F=>{y.beginPath(),y.arc(F.x,F.y,F.size,0,Math.PI*2),y.fill()})),N?(y.fillStyle="#E6E6E6",y.beginPath(),y.arc(I.x,I.y,I.size,0,Math.PI*2),y.fill(),y.fillStyle="#CCCCCC",y.beginPath(),y.arc(I.x-I.size*.2,I.y-I.size*.1,I.size*.15,0,Math.PI*2),y.fill(),y.beginPath(),y.arc(I.x+I.size*.3,I.y+I.size*.2,I.size*.1,0,Math.PI*2),y.fill(),y.fillStyle="#000",y.strokeStyle="#000",y.beginPath(),y.arc(I.x-I.size*.25,I.y-I.size*.15,I.size*.08,0,Math.PI*2),y.fill(),y.beginPath(),y.arc(I.x+I.size*.25,I.y-I.size*.15,I.size*.08,0,Math.PI*2),y.fill(),y.beginPath(),U?y.arc(I.x,I.y+I.size*.1,I.size*.3,0,Math.PI):y.arc(I.x,I.y+I.size*.25,I.size*.3,Math.PI,0),y.stroke()):(y.strokeStyle="#FFD700",y.lineWidth=2,y.beginPath(),I.rays.forEach(F=>{const ue=I.x+Math.cos(F.angle)*F.length,me=I.y+Math.sin(F.angle)*F.length;y.moveTo(I.x,I.y),y.lineTo(ue,me)}),y.stroke(),y.fillStyle="#FFFF00",y.beginPath(),y.arc(I.x,I.y,I.size,0,Math.PI*2),y.fill(),y.fillStyle="#000",y.beginPath(),y.arc(I.x-I.size*.3,I.y-I.size*.2,I.size*.1,0,Math.PI*2),y.fill(),y.beginPath(),y.arc(I.x+I.size*.3,I.y-I.size*.2,I.size*.1,0,Math.PI*2),y.fill(),y.beginPath(),U?y.arc(I.x,I.y+I.size*.1,I.size*.4,0,Math.PI):y.arc(I.x,I.y+I.size*.3,I.size*.4,Math.PI,0),y.stroke()),S.forEach(F=>{const ue=y.createLinearGradient(0,F.baseY-F.height,0,F.baseY);ue.addColorStop(0,"#444"),ue.addColorStop(1,"#888"),y.fillStyle=ue,y.beginPath(),y.moveTo(F.x,F.baseY),F.peaks.sort((me,xe)=>me.offset-xe.offset),F.peaks.forEach(me=>{y.lineTo(F.x+F.width/2+me.offset,F.baseY-F.height*me.height)}),y.lineTo(F.x+F.width,F.baseY),y.closePath(),y.fill()}),O.forEach(F=>{const ue=y.createLinearGradient(0,F.baseY-F.height,0,F.baseY);ue.addColorStop(0,F.color.replace(/hsl\(([^,]+), ([^,]+)%, ([^%]+)%\)/,(me,xe,qe,Ae)=>`hsl(${xe}, ${qe}%, ${Math.max(60,parseInt(Ae))}%)`)),ue.addColorStop(1,F.color.replace(/hsl\(([^,]+), ([^,]+)%, ([^%]+)%\)/,(me,xe,qe,Ae)=>`hsl(${xe}, ${qe}%, ${Math.min(90,parseInt(Ae)+20)}%)`)),y.fillStyle=ue,y.beginPath(),y.ellipse(F.x+F.width/2,F.baseY,F.width/2,F.height,0,0,Math.PI*2),y.fill()}),y.fillStyle="rgba(255, 255, 255, 0.8)",M.forEach(F=>{F.puffs.forEach(ue=>{y.beginPath(),y.arc(F.x+ue.x,F.y+ue.y,ue.radius,0,Math.PI*2),y.fill()})});const G=y.createLinearGradient(0,l.height-40,0,l.height);G.addColorStop(0,"#A0522D"),G.addColorStop(1,"#654321"),y.fillStyle=G,y.fillRect(0,l.height-40,l.width,40),Q.forEach(F=>{const ue=y.createLinearGradient(F.x,0,F.x+ee,0);ue.addColorStop(0,"#1a5d2e"),ue.addColorStop(.3,"#2f9e44"),ue.addColorStop(.7,"#2f9e44"),ue.addColorStop(1,"#1a5d2e"),y.fillStyle=ue,y.fillRect(F.x,0,ee,F.top);const me=y.createLinearGradient(F.x,0,F.x+ee,0);me.addColorStop(0,"#1a5d2e"),me.addColorStop(.3,"#2f9e44"),me.addColorStop(.7,"#2f9e44"),me.addColorStop(1,"#1a5d2e"),y.fillStyle=me,y.fillRect(F.x,F.top+o,ee,l.height-(F.top+o)-40);const xe=ee/2,qe=xe*.8,Ae=ee*1.3,De=(Ae-ee)/2,bt=F.x+ee/2,Cn=Math.max(0,F.top-qe),Ve=y.createLinearGradient(F.x-De,0,F.x-De+Ae,0);Ve.addColorStop(0,"#2a7a4a"),Ve.addColorStop(.3,"#4ade80"),Ve.addColorStop(.7,"#4ade80"),Ve.addColorStop(1,"#2a7a4a"),y.fillStyle=Ve,y.fillRect(F.x-De,Cn,Ae,F.top-Cn);const Ot=Math.min(l.height-40,F.top+o+qe),lt=y.createLinearGradient(F.x-De,0,F.x-De+Ae,0);lt.addColorStop(0,"#2a7a4a"),lt.addColorStop(.3,"#4ade80"),lt.addColorStop(.7,"#4ade80"),lt.addColorStop(1,"#2a7a4a"),y.fillStyle=lt,y.fillRect(F.x-De,F.top+o,Ae,Ot-(F.top+o)),Math.min(l.height-40,F.top+o+qe);const wt=y.createLinearGradient(F.x-De,0,F.x-De+Ae,0);wt.addColorStop(0,"#2a7a4a"),wt.addColorStop(.4,"#4ade80"),wt.addColorStop(.6,"#4ade80"),wt.addColorStop(1,"#2a7a4a"),y.fillStyle=wt;const vt=bt,xt=F.top+o-De*.05,In=Ae*.5,ko=xe*.5;y.beginPath(),y.moveTo(vt-In,xt),y.quadraticCurveTo(vt,xt-ko*1.1,vt+In,xt),y.quadraticCurveTo(vt,xt+ko*.8,vt-In,xt),y.closePath(),y.fill(),y.fillStyle="#000",y.save(),y.beginPath(),y.rect(F.x-De,F.top+o-De*1.5,Ae,qe*.6),y.beginPath();const kt=bt,St=F.top+o+De*.3,Ln=xe,So=xe*.15;y.moveTo(kt-Ln,St),y.quadraticCurveTo(kt,St-So*2.5,kt+Ln,St),y.quadraticCurveTo(kt,St+So*1.1,kt-Ln,St),y.closePath(),y.fill(),y.restore()}),Fe(z,R),W&&A.forEach(F=>{y.save(),y.globalAlpha=F.opacity,y.translate(F.x,F.y),y.rotate(F.rotation),y.fillStyle="#8B4513",y.beginPath(),y.ellipse(0,0,F.size,F.size*.6,0,0,Math.PI*2),y.fill(),y.strokeStyle="#654321",y.lineWidth=1,y.stroke(),y.restore()}),y.fillStyle="#83d683",E.forEach(F=>{const me=F.height/100;y.beginPath(),y.moveTo(F.x,l.height),y.lineTo(F.x-4*me,l.height-40-F.height*.7),y.lineTo(F.x+4*.5*me,l.height-40-F.height*.9),y.lineTo(F.x+4*me,l.height-40-F.height*.6),y.closePath(),y.fill()})}function ht(){if(R+_/2>=l.height-40||R-_/2<=0)return!0;for(const N of Q){const V=(ee*1.3-ee)/2,G=N.x-V,F=N.x+ee+V,ue=N.top,me=N.top+o;if(z+_/2>G&&z-_/2<F&&(R-_/2<ue||R+_/2>me))return!0;const xe=ee/2,qe=N.x+ee/2,Ae=xe*.3,De=z-qe,bt=R-N.top;if(Math.sqrt(De*De+bt*bt)<_/2+Ae)return!0;const Ve=z-qe,Ot=R-(N.top+o);if(Math.sqrt(Ve*Ve+Ot*Ot)<_/2+Ae)return!0}return!1}function st(N){if(!U)return;q+=K*N,R+=q*N,J>0&&(J-=N,J<0&&(J=0),J===0&&b>0&&(b--,b>0&&(J=h)));for(const G of Q)G.x-=2.2*N,!G.passed&&G.x+ee<z&&(G.passed=!0,P+=1,at());for(;Q.length&&Q[0].x+ee<-10;)Q.shift();he+=N,he>=C&&(he-=C,H()),M.forEach(G=>G.x-=.8*N),O.forEach(G=>G.x-=1.2*N),S.forEach(G=>G.x-=.6*N),E.forEach(G=>G.x-=1.8*N),M=M.filter(G=>G.x>-100),O=O.filter(G=>G.x>-200),S=S.filter(G=>G.x>-100),E=E.filter(G=>G.x>10);const V=G=>1-Math.pow(1-G,N);if(Math.random()<V(.005)&&ye(),Math.random()<V(.003)&&fe(),Math.random()<V(.004)&&Le(),Math.random()<V(.006))for(let G=0;G<2+Math.floor(Math.random()*3);G++)E.push({x:l.width+Math.random()*50,height:15+Math.random()*10});if(ht()){U=!1;const G=P>j;j=Math.max(j,P),B.setItemSync("happyturd-best-score",j),at();const F=document.getElementById("gameover-score"),ue=document.getElementById("gameover-best"),me=document.getElementById("new-high-score");F&&(F.textContent=String(P)),ue&&(ue.textContent=String(j)),me&&(me.style.display=G?"block":"none");const xe=document.getElementById("happyturd-gameover");xe&&setTimeout(()=>{xe.style.display="flex",xe.offsetHeight,xe.style.opacity="1"},500),Oe(z,R)}}let Rt=null;function En(N){Rt==null&&(Rt=N);let V=N-Rt;Rt=N;let G=V/(1e3/60);G>3&&(G=3),te.recompute(),!te.paused&&Z==="playing"&&st(G),!te.paused&&W&&(A.forEach(F=>{F.vy+=K*.3*G,F.x+=F.vx*G,F.y+=F.vy*G,F.rotation+=F.rotationSpeed*G,F.opacity=ie/Y}),ie-=G,ie<=0&&(W=!1,A=[])),yt(),ne=requestAnimationFrame(En)}function wo(){if(Z==="intro"){tt();return}U&&(q=T,J=h,b=x)}function vo(N){N.code==="Space"&&(N.preventDefault(),wo()),(N.key==="r"||N.key==="R")&&Te()}l.addEventListener("click",()=>wo()),l.setAttribute("tabindex","0"),l.style.outline="none",document.addEventListener("keydown",vo);const xo=new MutationObserver(N=>{N.forEach(V=>{V.removedNodes.forEach(G=>{G.id==="happyturd"&&(mr(),xo.disconnect())})})});xo.observe(document.getElementById("windows-container"),{childList:!0});function mr(){U=!1,ne&&cancelAnimationFrame(ne),document.removeEventListener("keydown",vo),te.destroy()}at(),ne=requestAnimationFrame(En)}typeof window<"u"&&(window.initializeHappyTurdUI=ro);let It=!1;function Ni(){se("OS Update",'<div id="os-update-content" style="padding: 20px;">Loading update information...</div>',!1,"os-update-window",!1,!1,{type:"integer",width:600,height:500},"default"),setTimeout(ao,100)}async function ao(){const e=document.getElementById("os-update-content");if(e){if(It){e.innerHTML='<p class="text-yellow-600">An update is already in progress...</p>';return}try{const n=await fetch("./api/system_manifest.json");if(!n.ok)throw new Error("Failed to fetch system manifest");const t=await n.json(),o=await B.getItem("installedVersions")||{systemVersion:"0.0.0",files:{},apps:{}},i=[],r=[],a=[],s=[];for(const l of t.defaultFiles){const d=o.files[l.id];d?Do(l.version,d)>0&&a.push(l):i.push(l)}for(const l of t.apps){const d=o.apps[l.id];d?Do(l.version,d)>0&&s.push(l):r.push(l)}ca(t,o,i,r,a,s)}catch(n){console.error("Error checking for updates:",n),e.innerHTML=`
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        <strong>Error:</strong> Failed to check for updates. Please try again later.
        <br><small>${n.message}</small>
      </div>
    `}}}function ca(e,n,t,o,i,r){const a=document.getElementById("os-update-content");if(!a)return;const s=t.length>0||o.length>0||i.length>0||r.length>0;let l=`
    <div class="os-update-info">
      <h2 class="text-xl font-bold mb-4">System Update Check</h2>

      <div class="mb-6 p-4 bg-gray-100 rounded">
        <h3 class="text-lg font-semibold mb-2">Current System</h3>
        <p><strong>System Version:</strong> ${n.systemVersion||"0.0.0"}</p>
        <p><strong>Latest Version:</strong> ${e.version}</p>
        <p><strong>Installed Files:</strong> ${Object.keys(n.files).length}</p>
        <p><strong>Installed Apps:</strong> ${Object.keys(n.apps).length}</p>
      </div>
  `;s?(l+=`
      <div class="mb-6 p-4 bg-blue-100 border border-blue-400 rounded">
        <h3 class="text-lg font-semibold mb-2">‚ú® Updates Available!</h3>
    `,t.length>0&&(l+=`
        <div class="mb-3">
          <h4 class="font-semibold">New Default Files (${t.length}):</h4>
          <ul class="list-disc list-inside ml-4">
            ${t.map(m=>`<li>${m.name} (v${m.version}) - ${m.description}</li>`).join("")}
          </ul>
        </div>
      `),i.length>0&&(l+=`
        <div class="mb-3">
          <h4 class="font-semibold">Updated Files (${i.length}):</h4>
          <ul class="list-disc list-inside ml-4">
            ${i.map(m=>`<li>${m.name} (v${m.version})</li>`).join("")}
          </ul>
        </div>
      `),o.length>0&&(l+=`
        <div class="mb-3">
          <h4 class="font-semibold">New Applications (${o.length}):</h4>
          <ul class="list-disc list-inside ml-4">
            ${o.map(m=>`<li>${m.name} (v${m.version})</li>`).join("")}
          </ul>
        </div>
      `),r.length>0&&(l+=`
        <div class="mb-3">
          <h4 class="font-semibold">Updated Applications (${r.length}):</h4>
          <ul class="list-disc list-inside ml-4">
            ${r.map(m=>`<li>${m.name} (v${m.version})</li>`).join("")}
          </ul>
        </div>
      `),l+=`
        <p class="mt-3 text-sm text-gray-700">
          <strong>Note:</strong> Installing updates will add new files to your system.
          Your existing files and data will not be modified or deleted.
        </p>
      </div>
    `,l+=`
      <div class="mb-4">
        <div id="install-update-btn-container"></div>
      </div>
    `):l+=`
      <div class="mb-6 p-4 bg-green-100 border border-green-400 rounded">
        <h3 class="text-lg font-semibold">‚úì System is up to date!</h3>
        <p class="mt-2">You have the latest version of all files and applications.</p>
      </div>
    `,l+=`
    <div class="mt-6 flex gap-3">
      <div id="refresh-btn-container"></div>
    </div>
  </div>
  `,a.innerHTML=l;const d=de("Check Again");d.onclick=ao;const c=document.getElementById("refresh-btn-container");if(c&&c.appendChild(d),s){const m=de("Install Updates");m.onclick=()=>da(e,t,o,i,r);const u=document.getElementById("install-update-btn-container");u&&u.appendChild(m)}}async function da(e,n,t,o,i){const r=document.getElementById("os-update-content");if(!r||It)return;It=!0,r.innerHTML=`
    <div class="text-center py-8">
      <h2 class="text-xl font-bold mb-4">Installing Updates...</h2>
      <div class="mb-4">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"></div>
      </div>
      <p class="text-gray-600">Please wait while we install the updates.</p>
      <div id="install-progress" class="mt-4 text-sm text-left max-w-md mx-auto"></div>
    </div>
  `;const a=document.getElementById("install-progress"),s=l=>{a&&(a.innerHTML+=`<p class="text-gray-700">${l}</p>`,a.scrollTop=a.scrollHeight)};try{const l=await B.getItem("installedVersions")||{systemVersion:"0.0.0",files:{},apps:{}},d=[...n,...o];if(d.length>0){s(`Installing ${d.length} file(s)...`);for(const m of d)try{await ua(m),l.files[m.id]=m.version,s(`‚úì Installed: ${m.name}`)}catch(u){s(`‚úó Failed to install ${m.name}: ${u.message}`),console.error("Error installing file:",m,u)}}const c=[...t,...i];if(c.length>0){s(`Registering ${c.length} app(s)...`);for(const m of c)l.apps[m.id]=m.version,s(`‚úì Registered: ${m.name}`)}l.systemVersion=e.version,await B.setItem("installedVersions",l),s("‚úì All updates installed successfully!"),setTimeout(()=>{r.innerHTML=`
        <div class="text-center py-8">
          <h2 class="text-xl font-bold mb-4 text-green-600">‚úì Updates Installed Successfully!</h2>
          <p class="mb-4">The following updates have been installed:</p>
          <div class="text-left max-w-md mx-auto mb-6">
            ${d.length>0?`<p>‚Ä¢ ${d.length} file(s) added</p>`:""}
            ${c.length>0?`<p>‚Ä¢ ${c.length} app(s) registered</p>`:""}
          </div>
          <p class="text-sm text-gray-600 mb-4">
            Check your Documents and Media folders to see the new files!
          </p>
          <div id="close-btn-container"></div>
        </div>
      `;const m=de("Close");m.onclick=()=>{const f=document.getElementById("os-update-window");f&&f.remove()};const u=document.getElementById("close-btn-container");u&&u.appendChild(m),It=!1},1e3)}catch(l){console.error("Error installing updates:",l),r.innerHTML=`
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
        <strong>Error:</strong> Failed to install updates.
        <br><small>${l.message}</small>
      </div>
    `,It=!1}}async function ua(e){try{const n=await fetch(`./${e.path}`);if(!n.ok)throw new Error(`Failed to fetch file: ${e.path}`);const t=await xr(),o=t.folders[e.targetFolder];if(!o)throw new Error(`Target folder not found: ${e.targetFolder}`);const i=Object.values(o).find(l=>l.id===e.id||l.name===e.name);if(i){i.version=e.version,i.description=e.description,await Pn(t),await X();return}const r=["md","txt","html"].includes(e.contentType);let a,s;if(r){const l=await n.text();s={id:e.id,name:e.name,type:"ugc-file",fullPath:`${e.targetFolder}/${e.id}`,content_type:e.contentType,icon:e.icon,contents:l,version:e.version,description:e.description,isDefault:!0,isSystemFile:!0}}else{const l=await n.blob(),d=await pa(l);await B.setItem(`file_data_${e.id}`,d),s={id:e.id,name:e.name,type:"ugc-file",fullPath:`${e.targetFolder}/${e.id}`,content_type:e.contentType,icon:e.icon,contents:"",version:e.version,description:e.description,isDefault:!0,isSystemFile:!0,isLargeFile:!0,storageLocation:"indexeddb",dataURL:d}}o[e.id]=s,await Pn(t),await X()}catch(n){throw console.error("Error installing default file:",e,n),n}}function pa(e){return new Promise((n,t)=>{const o=new FileReader;o.onload=()=>n(o.result),o.onerror=t,o.readAsDataURL(e)})}function Do(e,n){const t=e.split(".").map(Number),o=n.split(".").map(Number);for(let i=0;i<Math.max(t.length,o.length);i++){const r=t[i]||0,a=o[i]||0;if(r>a)return 1;if(r<a)return-1}return 0}function Wn(){ao()}function Kt(e){const n=document.getElementById(e);if(n)if(e==="keyboard")console.log("üîç Skipping generic keyboard element, will handle in keyboard case");else{const o=[...document.querySelectorAll("*")].filter(i=>getComputedStyle(i).zIndex>100&&getComputedStyle(i).zIndex<1e3).reduce((i,r)=>getComputedStyle(r).zIndex>getComputedStyle(i).zIndex?r:i,n);n.style.zIndex=`${parseInt(getComputedStyle(o).zIndex)+1}`;return}if(console.log(`üîç Checking app cases for ${e}...`),(e==="mailbox"||e.includes("shortcut-mailboxapp"))&&oi(),(e==="watercolour"||e.includes("shortcut-watercolourapp"))&&ai(),(e==="calculator"||e.includes("shortcut-calcapp"))&&di(),(e==="solitaire"||e.includes("shortcut-solapp"))&&pi(),(e==="chess"||e.includes("shortcut-chessapp"))&&mi(),(e==="bombbroomer"||e.includes("shortcut-bombapp"))&&Li(),(e==="mediaplayer"||e.includes("shortcut-mediaapp"))&&Ai(),(e==="compostbin"||e.includes("shortcut-compostbinapp"))&&Qo(),(e==="storage"||e.includes("shortcut-storageapp"))&&Ki(),(e==="tubestream"||e.includes("shortcut-tubestreamapp"))&&ii(),(e==="osupdate"||e.includes("shortcut-osupdateapp"))&&Ni(),(e==="pong"||e.includes("shortcut-pongapp"))&&$i(),(e==="snake"||e.includes("shortcut-snakeapp"))&&Pi(),(e==="happyturd"||e.includes("shortcut-happyturdapp"))&&zi(),e==="keyboard"){const t=document.getElementById("keyboard-app");if(t){console.log("üîç Keyboard app window already exists, bringing to front");const i=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,a)=>getComputedStyle(a).zIndex>getComputedStyle(r).zIndex?a:r,t);t.style.zIndex=`${parseInt(getComputedStyle(i).zIndex)+1}`;return}Ti().catch(console.error)}console.log("üîç Finished checking all cases")}let pe={isActive:!1,selectedIcon:null,cutIcon:null,moveStep:20,gridStep:112};function fa(e){pe.isActive=!0,pe.selectedIcon=e,e.classList.add("dragging","keyboard-dragging"),e.style.zIndex="1000",ba(e),_e("Drag mode activated. Use arrow keys to move, Enter to drop, or Escape to cancel."),va()}function Vt(e=!1){if(!pe.isActive||!pe.selectedIcon)return;const n=pe.selectedIcon;n.classList.remove("dragging","keyboard-dragging"),n.style.zIndex="",wa(),xa(),e?(Tt(n),ge[n.id]={left:n.style.left,top:n.style.top},X(),_e("Icon moved successfully.")):_e("Drag operation cancelled."),pe.isActive=!1,pe.selectedIcon=null}function ma(e,n){if(!pe.isActive)return;const t=parseInt(e.style.left)||0,o=parseInt(e.style.top)||0,i=pe.moveStep;let r=t,a=o;switch(n){case"ArrowUp":a=Math.max(16,o-i);break;case"ArrowDown":a=o+i;break;case"ArrowLeft":r=Math.max(16,t-i);break;case"ArrowRight":r=t+i;break}e.style.left=r+"px",e.style.top=a+"px",Oi(e,r+48,a+48)}function ga(e){if(!pe.isActive)return;const n=parseInt(e.style.left)||0,t=parseInt(e.style.top)||0,o=pe.gridStep,i=16+Math.round((n-16)/o)*o,r=16+Math.round((t-16)/o)*o;e.style.left=Math.max(16,i)+"px",e.style.top=Math.max(16,r)+"px",_e("Icon snapped to grid.")}function ya(e){pe.cutIcon&&pe.cutIcon.classList.remove("cut-icon"),pe.cutIcon=e,e.classList.add("cut-icon"),_e("Icon cut. Navigate to destination and press Ctrl+V to paste.")}function ha(){if(!pe.cutIcon){_e("No icon to paste.");return}const e=document.activeElement,n=pe.cutIcon;if(e&&e.classList.contains("draggable-icon")){const t=e.getBoundingClientRect(),o=document.getElementById("desktop").getBoundingClientRect(),i=t.left-o.left+120,r=t.top-o.top;n.style.left=i+"px",n.style.top=r+"px",Tt(n),ge[n.id]={left:n.style.left,top:n.style.top},X()}n.classList.remove("cut-icon"),pe.cutIcon=null,_e("Icon pasted successfully.")}function ba(e){document.querySelectorAll(".desktop-folder-icon[data-item-id]").forEach(n=>{const t=Ft(n.getAttribute("data-item-id")),o=n.getAttribute("data-item-id");(t&&t.type==="folder"||o==="compostbin")&&n!==e&&n.classList.add("drag-hover-target")})}function wa(){document.querySelectorAll(".drag-hover-target").forEach(e=>{e.classList.remove("drag-hover-target")}),document.querySelectorAll(".desktop-folder-icon").forEach(e=>{e.classList.remove("dragover")})}function va(e){const n=document.createElement("div");n.id="keyboard-drag-indicator",n.className="fixed bottom-4 left-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50",n.innerHTML=`
    <div class="text-sm font-medium">Keyboard Drag Mode</div>
    <div class="text-xs">‚Üë‚Üì‚Üê‚Üí Move ‚Ä¢ Enter Drop ‚Ä¢ Esc Cancel ‚Ä¢ G Grid Snap</div>
  `,document.body.appendChild(n)}function xa(){const e=document.getElementById("keyboard-drag-indicator");e&&e.remove()}function _e(e,n="polite"){let t=document.getElementById("sr-announcements");t||(t=document.createElement("div"),t.id="sr-announcements",t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),t.className="sr-only",document.body.appendChild(t)),t.textContent=e,setTimeout(()=>{t.textContent=""},1e3)}async function ka(e){if(!pe.isActive)return;const n=e.getBoundingClientRect(),t=n.left+n.width/2,o=n.top+n.height/2,i=document.elementFromPoint(t,o),r=i==null?void 0:i.closest(".desktop-folder-icon[data-item-id]");if(r&&r!==e){const a=e.getAttribute("data-item-id"),s=r.getAttribute("data-item-id"),l=Ft(s);if(s==="compostbin"){await ei(a,"C://Desktop"),_e("Icon moved to compost bin."),Vt(!0);return}else if(l&&l.type==="folder"){await fn(a,s),_e(`Icon moved to ${l.name} folder.`),Vt(!0);return}}Vt(!0)}function pn(e){let n=!1,t,o,i=5,r=0;e.addEventListener("pointerdown",function(a){if(!a.isPrimary||pe.isActive)return;a.preventDefault(),n=!1,t=a.clientX,o=a.clientY,r=Date.now();const s=e.getBoundingClientRect(),l=a.clientX-s.left,d=a.clientY-s.top,c=a.pointerType==="touch";function m(f){if(!f.isPrimary)return;const p=Math.sqrt(Math.pow(f.clientX-t,2)+Math.pow(f.clientY-o,2));!n&&p>i&&(n=!0,e.classList.add("dragging"),c&&(e.classList.add("touch-dragging"),navigator.vibrate&&navigator.vibrate(50)),e.style.zIndex="1000",document.querySelectorAll(".desktop-folder-icon[data-item-id]").forEach(g=>{const k=Ft(g.getAttribute("data-item-id")),v=g.getAttribute("data-item-id");(k&&k.type==="folder"||v==="compostbin")&&g!==e&&g.classList.add("drag-hover-target")}),document.body.style.overflow="hidden",_e("Drag started. Move to reposition or drop on a folder.")),n&&(e.style.left=f.clientX-l+"px",e.style.top=f.clientY-d+"px",e.style.position="absolute",Tt(e),Oi(f.clientX,f.clientY,e))}async function u(f){if(f.isPrimary){if(document.removeEventListener("pointermove",m),document.removeEventListener("pointerup",u),document.removeEventListener("pointercancel",u),n){e.style.zIndex="",e.classList.remove("dragging");const p=e.style.pointerEvents;e.style.pointerEvents="none";const g=document.elementFromPoint(f.clientX,f.clientY);e.style.pointerEvents=p;const k=g?g.closest(".desktop-folder-icon[data-item-id]"):null,v=g?g.closest(".file-explorer-window"):null;if(k&&k!==e){const y=k.getAttribute("data-item-id"),P=Ft(y),j=e.getAttribute("data-item-id");if(j!==y){if(y==="compostbin"){await ei(j,"C://Desktop");return}else if(P&&P.type==="folder"){await fn(j,y);return}}}else if(v){const y=e.getAttribute("data-item-id"),P=v.getAttribute("data-current-path");if(P&&y){await Rn(y,P);return}}Tt(e),ge[e.id]={left:e.style.left,top:e.style.top},X()}document.querySelectorAll(".drag-hover-target").forEach(p=>{p.classList.remove("drag-hover-target")}),document.querySelectorAll(".desktop-folder-icon").forEach(p=>{p.classList.remove("dragover")}),document.querySelectorAll(".file-explorer-window").forEach(p=>{p.classList.remove("dragover")}),document.body.style.overflow="",n=!1}}document.addEventListener("pointermove",m),document.addEventListener("pointerup",u),document.addEventListener("pointercancel",u)}),e.addEventListener("click",function(a){const s=Date.now()-r;!n&&s>100&&(document.querySelectorAll(".draggable-icon").forEach(l=>l.classList.remove("bg-gray-50")),e.classList.add("bg-gray-50"))})}function Sa(){const e=document.getElementById("bgColorInput").value,n=document.getElementById("bgImageInput").value.trim(),t=document.getElementById("clockSecondsInput").checked;ve.bgColor=e,ve.bgImage=n,ve.clockSeconds=t,Wi(),X()}async function be(){const e=document.getElementById("desktop-icons");e.innerHTML="",document.getElementById("windows-container").querySelectorAll(".desktop-folder-icon").forEach(a=>{a.parentElement&&a.parentElement.classList.contains("draggable-icon")&&a.parentElement.remove()});let o=await Re();if(!o||!o.folders||!o.folders["C://Desktop"]){if(typeof _n=="function")await _n(),o=await Re();else if(console.warn("initializeAppState not available, using default fileSystemState"),typeof window.fileSystemState<"u"?o=window.fileSystemState:typeof je<"u"?o=je:(console.error("No fileSystemState available, creating minimal fallback structure"),o={folders:{"C://":{Documents:{id:"Documents",name:"Documents",type:"folder",fullPath:"C://Documents",contents:{}},Desktop:{id:"Desktop",name:"Desktop",type:"folder",fullPath:"C://Desktop",contents:{compostbin:{id:"compostbin",name:"Compost Bin",type:"app",fullPath:"C://Desktop/compostbin",content_type:"html",contents:{},icon:"./image/compost-bin.webp"}}},Media:{id:"Media",name:"Media",type:"folder",fullPath:"C://Media",contents:{}}},"A://":{},"D://":{}}}),typeof ke=="function")try{ke(o)}catch(a){console.warn("Failed to update global file system state:",a)}}if(!o||!o.folders||!o.folders["C://Desktop"]){console.error("File system structure is still invalid after initialization attempts:",o);return}const i=o.folders["C://Desktop"]||{};i||(o.folders["C://Desktop"]={});const r=[];Object.values(i).forEach(a=>{const s=document.createElement("div");s.id="icon-"+a.id,s.className="flex flex-col items-center cursor-pointer draggable-icon desktop-folder-icon z-10 h-32 truncate-ellipsis w-24 text-wrap absolute",s.setAttribute("role","button"),s.setAttribute("tabindex","0"),s.setAttribute("aria-label",`${a.name} - Double-click to open`);let l=a.type==="folder"?"image/folder.webp":"image/file.webp";a.icon?l=a.icon:a.icon_url&&(l=a.icon_url),s.setAttribute("data-item-id",a.id),s.setAttribute("data-current-path","C://Desktop");const d=()=>{a.type==="ugc-file"||a.type==="file"?Lt(a.id,null):a.type==="app"?Kt(a.id):a.type==="folder"?dt(a.id):a.type==="shortcut"&&Yt(s)};if(a.type==="ugc-file"||a.type==="file"?(s.addEventListener("dblclick",c=>{c.stopPropagation(),Lt(a.id,c)}),s.addEventListener("mobiledbltap",c=>{c.stopPropagation(),Lt(a.id,c)})):a.type==="app"?(s.dataset.isVendorApplication=!0,l=a.icon,s.addEventListener("dblclick",()=>Kt(a.id)),s.addEventListener("mobiledbltap",()=>Kt(a.id))):a.type==="folder"?(s.addEventListener("dblclick",()=>dt(a.id)),s.addEventListener("mobiledbltap",()=>dt(a.id))):a.type==="shortcut"&&(s.dataset.url=a.url,l=a.icon_url,s.addEventListener("dblclick",()=>Yt(s)),s.addEventListener("mobiledbltap",()=>Yt(s))),s.addEventListener("keydown",function(c){if(c.key==="Enter"||c.key===" ")pe.isActive&&pe.selectedIcon===s?(c.preventDefault(),ka(s)):pe.isActive||(c.preventDefault(),d());else if(c.key==="Escape")pe.isActive&&pe.selectedIcon===s&&(c.preventDefault(),Vt(!1));else if(c.key==="d"&&(c.ctrlKey||c.metaKey))c.preventDefault(),fa(s);else if(c.key==="x"&&(c.ctrlKey||c.metaKey))c.preventDefault(),ya(s);else if(c.key==="v"&&(c.ctrlKey||c.metaKey))c.preventDefault(),ha();else if(c.key==="g"&&pe.isActive&&pe.selectedIcon===s)c.preventDefault(),ga(s);else if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(c.key)){if(pe.isActive&&pe.selectedIcon===s)c.preventDefault(),ma(s,c.key);else if(c.shiftKey){c.preventDefault();const m=parseInt(s.style.left)||0,u=parseInt(s.style.top)||0,f=5;let p=m,g=u;switch(c.key){case"ArrowUp":g=Math.max(16,u-f);break;case"ArrowDown":g=u+f;break;case"ArrowLeft":p=Math.max(16,m-f);break;case"ArrowRight":p=m+f;break}s.style.left=p+"px",s.style.top=g+"px",Tt(s),ge[s.id]={left:s.style.left,top:s.style.top},X(),_e(`Icon moved to position ${p}, ${g}`)}}}),s.innerHTML=`
      <img src="${l}" alt="${a.name} icon" class="mb-1 p-1 h-16 w-16 desktop-folder-icon" />
      <span class="text-xs text-black max-w-20 text-center desktop-folder-icon truncate block">${a.name}</span>
    `,ge[s.id]){const c=ge[s.id];s.style.left=c.left,s.style.top=c.top,r.push({left:parseInt(c.left),top:parseInt(c.top),width:96,height:128})}else{const c=Ca(r);s.style.left=c.left+"px",s.style.top=c.top+"px",r.push({left:c.left,top:c.top,width:96,height:128})}e.appendChild(s),pn(s),Ri(s)}),typeof Pe=="function"&&Pe()}function Wi(){const e=document.getElementById("desktop");ve.bgColor&&(e.style.backgroundColor=ve.bgColor),ve.bgImage?(e.style.backgroundImage=`url(${ve.bgImage})`,e.style.backgroundSize="cover",e.style.backgroundRepeat="no-repeat"):e.style.backgroundImage="none"}function Ea(){return`
    <div class="space-y-4">
      <div>
        <label for="bgColorInput" class="block text-sm font-medium">Desktop Background Color:</label>
        <input id="bgColorInput" type="color" value="${ve.bgColor}" class="border mt-1" aria-describedby="bgColorHelp" />
        <p id="bgColorHelp" class="text-xs text-gray-600 mt-1">Choose a color for your desktop background</p>
      </div>
      <div>
        <label for="bgImageInput" class="block text-sm font-medium">Background Image URL:</label>
        <input id="bgImageInput" type="text" placeholder="Enter image URL" value="${ve.bgImage}" class="border w-full mt-1" aria-describedby="bgImageHelp" />
        <p id="bgImageHelp" class="text-xs text-gray-600 mt-1">Enter a URL to display an image as your desktop background</p>
      </div>
      <div>
        <label for="clockSecondsInput" class="block text-sm font-medium">Show Seconds on Clock:</label>
        <input id="clockSecondsInput" type="checkbox" ${ve.clockSeconds?"checked":""} class="mt-1" aria-describedby="clockSecondsHelp" />
        <p id="clockSecondsHelp" class="text-xs text-gray-600 mt-1">Display seconds in the taskbar clock</p>
      </div>
      <button id="settings-apply-button"
              class="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2"
              aria-label="Apply desktop settings changes">
        <span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Apply</span>
      </button>
    </div>
  `}function Ca(e,n=96,t=128,o=16){const a=n+o,s=t+o,d=document.getElementById("desktop").getBoundingClientRect(),c=d.width-n,m=d.height-t-40;let u=16,f=16;for(;u<=c;){for(;f<=m;){const p={left:u,top:f,right:u+n,bottom:f+t};let g=!1;for(const k of e){const v={left:k.left,top:k.top,right:k.left+k.width,bottom:k.top+k.height};if(!(p.right<=v.left||p.left>=v.right||p.bottom<=v.top||p.top>=v.bottom)){g=!0;break}}if(!g)return{left:u,top:f};f+=s}f=16,u+=a}return{left:16,top:16}}function Tt(e){const t=document.getElementById("desktop").getBoundingClientRect(),o=e.getBoundingClientRect();let i=parseInt(e.style.left)||0,r=parseInt(e.style.top)||0;i=Math.max(0,Math.min(i,t.width-o.width)),r=Math.max(0,Math.min(r,t.height-o.height-40)),e.style.left=i+"px",e.style.top=r+"px"}function Ft(e){const n=ce();for(const t in n.folders){const o=n.folders[t];if(o[e])return o[e];if(o.contents&&o.contents[e])return o.contents[e]}return null}function Ri(e){let n=0;e.addEventListener("pointerdown",function(t){let o=new Date().getTime(),i=o-n;if(i<300&&i>0){let r=new Event("mobiledbltap");e.dispatchEvent(r)}n=o})}document.querySelectorAll("[onmobiledbltap]").forEach(e=>{Ri(e),e.addEventListener("mobiledbltap",function(){let n=e.getAttribute("onmobiledbltap");if(n)try{const t=new CustomEvent("mobiledbltap-action",{detail:{action:n,element:e}});document.dispatchEvent(t)}catch(t){console.error(`Error dispatching event for: ${n}`,t)}})});document.addEventListener("mobiledbltap-action",function(e){const{action:n,element:t}=e.detail,o=["openExplorerInNewWindow","openApp","openShortcut"],i=n.match(/^(\w+)\((.*)\)$/);if(i){const[,r,a]=i;if(o.includes(r))try{if(r==="openExplorerInNewWindow"&&window.openExplorerInNewWindow){const s=a.replace(/['"]/g,"");window.openExplorerInNewWindow(s)}else if(r==="openApp"&&window.openApp){const s=a.replace(/['"]/g,"");window.openApp(s)}else r==="openShortcut"&&window.openShortcut&&window.openShortcut(t)}catch(s){console.error(`Error executing safe action ${r}:`,s)}else console.warn(`Blocked potentially unsafe action: ${r}`)}else console.warn(`Invalid action format: ${n}`)});function Oi(e,n,t){document.querySelectorAll(".desktop-folder-icon").forEach(s=>{s.classList.remove("dragover")}),document.querySelectorAll(".file-explorer-window").forEach(s=>{s.classList.remove("dragover")});const o=t.style.pointerEvents;t.style.pointerEvents="none";const i=document.elementFromPoint(e,n),r=i?i.closest(".desktop-folder-icon[data-item-id]"):null,a=i?i.closest(".file-explorer-window"):null;if(t.style.pointerEvents=o,r&&r!==t){const s=r.getAttribute("data-item-id"),l=Ft(s);(l&&l.type==="folder"||s==="compostbin")&&r.classList.add("dragover")}else a&&a.classList.add("dragover")}typeof window<"u"&&(window.renderDesktopIcons=be,window.makeIconDraggable=pn,window.applyDesktopSettings=Wi,La());function Pe(){requestAnimationFrame(()=>{document.querySelectorAll(".file-item").forEach(o=>{o.removeEventListener("dragstart",Bo),o.removeEventListener("dragover",To),o.removeEventListener("dragleave",Fo),o.removeEventListener("drop",$o),o.removeEventListener("dragend",Po),o.setAttribute("draggable",!0),o.addEventListener("dragstart",Bo),o.addEventListener("dragover",To),o.addEventListener("dragleave",Fo),o.addEventListener("drop",$o),o.addEventListener("dragend",Po)}),document.querySelectorAll(".file-explorer-window").forEach(o=>{o.removeEventListener("dragover",Ro),o.removeEventListener("dragleave",Oo),o.removeEventListener("drop",qo),o.addEventListener("dragover",Ro),o.addEventListener("dragleave",Oo),o.addEventListener("drop",qo)}),document.querySelectorAll(".desktop-folder-icon[data-item-id]").forEach(o=>{const i=o.getAttribute("data-item-id"),r=lo(i);(r&&r.type==="folder"||i==="compostbin")&&(o.removeEventListener("dragover",zo),o.removeEventListener("dragleave",No),o.removeEventListener("drop",Wo),o.addEventListener("dragover",zo),o.addEventListener("dragleave",No),o.addEventListener("drop",Wo))})})}function Bo(e){e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",this.getAttribute("data-item-id")),this.classList.add("dragging")}function To(e){(e.dataTransfer.types.includes("application/x-compost-item")||e.dataTransfer.types.includes("text/plain"))&&(e.preventDefault(),e.dataTransfer.dropEffect="move",this.classList.add("dragover"))}function Fo(e){this.classList.remove("dragover")}async function $o(e){e.stopPropagation(),this.classList.remove("dragover");const n=e.dataTransfer.getData("text/plain"),t=this.getAttribute("data-item-id"),o=e.dataTransfer.getData("application/x-compost-item")==="true";if(n===t)return;const i=document.querySelector(`[data-item-id="${n}"]`),r=this;if(o){if(r.classList.contains("folder-item")){const a=r.closest(".file-explorer-window"),s=a?a.getAttribute("data-current-path"):"C://",l=s==="C://"?s+t:s+"/"+t;await co(n,l)}return}if(r.classList.contains("folder-item"))await fn(n,t);else{const a=this.getBoundingClientRect(),s=e.clientY-a.top,l=this.parentElement;s<a.height/2?l.insertBefore(i,this):l.insertBefore(i,this.nextSibling),await Ia()}i&&i.classList.remove("dragging")}function Po(e){this.classList.remove("dragging"),document.querySelectorAll(".file-item").forEach(t=>t.classList.remove("dragover"));const n=document.getElementById("desktop");n&&n.classList.remove("drag-hover-target"),document.querySelectorAll(".drag-hover-target").forEach(t=>{t.classList.remove("drag-hover-target")})}async function fn(e,n){let t=ce();const o=so(e,t);if(!o){console.error("Item not found:",e);return}const{item:i,parent:r}=o,a=i.fullPath&&i.fullPath.includes("C://Desktop");if(delete r[e],a){const d="icon-"+e;ge[d]&&delete ge[d]}let s=findFolderFullPathById(n),l=findFolderObjectByFullPath(s,t);if(!l){console.error("Target folder not found:",n);return}l.contents||(l.contents={}),l.contents[e]=i,/^[A-Z]:\/\/$/.test(s)||(t.folders[s]||(t.folders[s]={}),t.folders[s][e]=i),i.fullPath=s+"/"+i.name,await ke(t),X(),Qe(),(s.includes("Desktop")||qi(e).includes("Desktop"))&&be()}async function Rn(e,n){let t=ce();const o=so(e,t);if(!o){console.error("Item not found:",e);return}const{item:i,parent:r}=o,a=i.fullPath&&i.fullPath.includes("C://Desktop");if(delete r[e],a){const s="icon-"+e;typeof ge<"u"&&ge[s]&&delete ge[s]}t.folders[n]||(t.folders[n]={}),t.folders[n][e]=i,i.fullPath=n+"/"+i.name,await ke(t),X(),Qe(),(n.includes("Desktop")||a)&&be()}async function Ia(){const e=document.querySelector(".file-explorer-window");if(!e)return;const n=e.getAttribute("data-current-path"),t=Array.from(e.querySelectorAll("ul > li"));let o=ce(),i=findFolderObjectByFullPath(n,o);if(!i||!i.contents)return;let r={};t.forEach(a=>{const s=a.getAttribute("data-item-id");i.contents[s]&&(r[s]=i.contents[s])}),i.contents=r,await ke(o),X()}function so(e,n){for(const t in n.folders){const o=n.folders[t];if(o[e])return{item:o[e],parent:o};if(o.contents&&o.contents[e])return{item:o.contents[e],parent:o.contents}}return null}function lo(e){const n=ce();for(const t in n.folders){const o=n.folders[t];if(o[e])return o[e];if(o.contents&&o.contents[e])return o.contents[e]}return null}function qi(e){const n=ce();for(const t in n.folders){const o=n.folders[t];if(o[e]||o.contents&&o.contents[e])return t}return""}function zo(e){(e.dataTransfer.types.includes("application/x-compost-item")||e.dataTransfer.types.includes("text/plain"))&&(e.preventDefault(),e.dataTransfer.dropEffect="move",this.classList.add("dragover"))}function No(e){this.classList.remove("dragover")}async function Wo(e){e.preventDefault(),e.stopPropagation(),this.classList.remove("dragover");const n=e.dataTransfer.getData("text/plain"),t=this.getAttribute("data-item-id"),o=e.dataTransfer.getData("application/x-compost-item")==="true";if(n&&t&&n!==t)if(o){const i=lo(t);i&&i.type==="folder"&&await co(n,i.fullPath)}else if(t==="compostbin"){const i=qi(n);await moveItemToCompostBin(n,i)}else await fn(n,t)}function Ro(e){e.dataTransfer.types.includes("text/plain")&&(e.preventDefault(),e.dataTransfer.dropEffect="move",this.classList.add("dragover"))}function Oo(e){this.contains(e.relatedTarget)||this.classList.remove("dragover")}async function qo(e){e.preventDefault(),e.stopPropagation(),this.classList.remove("dragover");const n=e.dataTransfer.getData("text/plain"),t=this.getAttribute("data-current-path");if(n&&t){const o=lo(n);if(o){const i=o.fullPath;if(i&&i.startsWith(t))return;i&&i.includes("C://Desktop")?await Rn(n,t):await Rn(n,t)}}}Pe();async function co(e,n){const t=ce(),i=(t.folders["C://Desktop"]||{}).compostbin;if(!i||!i.contents||!i.contents[e]){console.error("Item not found in compost bin:",e);return}const r=i.contents[e];delete i.contents[e];let a;if(n==="C://Desktop")t.folders["C://Desktop"]||(t.folders["C://Desktop"]={}),a=t.folders["C://Desktop"];else{const l=findFolderObjectByFullPath(n,t);if(!l){console.error("Target folder not found:",n);return}l.contents||(l.contents={}),a=l.contents}r.fullPath=n+"/"+r.id,a[e]=r,await ke(t),X(),Qe(),be();const s=document.getElementById("compost-bin");if(s){const l=s.querySelector("#compost-bin-content");l&&(loadCompostBinContents(l),updateCompostBinHeader(s))}}function La(){const e=document.getElementById("desktop");e&&(e.addEventListener("dragover",n=>{const t=n.dataTransfer.types.includes("application/x-compost-item"),o=n.dataTransfer.types.includes("text/plain");(t||o)&&(n.preventDefault(),n.dataTransfer.dropEffect="move",e.classList.add("drag-hover-target"))}),e.addEventListener("dragleave",n=>{e.contains(n.relatedTarget)||e.classList.remove("drag-hover-target")}),e.addEventListener("drop",async n=>{n.preventDefault(),e.classList.remove("drag-hover-target");const t=n.dataTransfer.getData("application/x-compost-item")==="true",o=n.dataTransfer.getData("text/plain");o&&(t?await co(o,"C://Desktop"):await Ma(o))}))}async function Ma(e){const n=ce(),t=so(e,n);if(!t){console.error("Item not found:",e);return}const{item:o,parent:i}=t;o.fullPath&&o.fullPath==="C://Desktop/"+o.id||(delete i[e],n.folders["C://Desktop"]||(n.folders["C://Desktop"]={}),n.folders["C://Desktop"][e]=o,o.fullPath="C://Desktop/"+o.id,await ke(n),X(),Qe(),be())}function uo(e,n){const t={calculator:"image/calculator.webp",mediaplayer:"image/video.webp",bombbroomer:"image/bombbroomer.webp",solitaire:"image/solitaire.webp",pong:"image/pong.webp",snake:"image/snake.webp",happyturd:"image/happyturd.webp",chess:"image/guillotine_chess.webp",mailbox:"image/mail.webp",watercolour:"image/watercolour.webp",compostbin:"image/compost-bin.webp",storage:"image/drive_c.webp","explorer-window":"image/computer.webp",tubestream:"image/youtube.webp"},o={Settings:"image/gears.webp","About This Computer":"image/info.webp","My Computer":"image/computer.webp","File Explorer":"image/computer.webp","Media Player":"image/video.webp",Calculator:"image/calculator.webp",Bombbroomer:"image/bombbroomer.webp",Solitaire:"image/solitaire.webp",Pong:"image/pong.webp",Snake:"image/snake.webp","Happy Turd":"image/happyturd.webp","Guillotine Chess":"image/guillotine_chess.webp",Chess:"image/guillotine_chess.webp","Mail Box":"image/mail.webp",Watercolour:"image/watercolour.webp","Compost Bin":"image/compost-bin.webp","Storage Manager":"image/drive_c.webp",TubeStream:"image/youtube.webp","Security Policy":"image/info.webp"};if(t[e])return t[e];if(o[n])return o[n];if(e&&e.includes("-")){const i=n.toLowerCase(),r=e.toLowerCase();if(i.match(/\.(jpg|jpeg|png|gif|webp|avif|bmp)$/i)||r.match(/\.(jpg|jpeg|png|gif|webp|avif|bmp)$/i))return"image/image.webp";if(i.match(/\.(mp4|webm|avi|mov|mkv)$/i)||r.match(/\.(mp4|webm|avi|mov|mkv)$/i))return"image/video.webp";if(i.match(/\.(mp3|wav|ogg|m4a|flac)$/i)||r.match(/\.(mp3|wav|ogg|m4a|flac)$/i))return"image/audio.webp";if(i.match(/\.(txt|md|doc|docx)$/i)||r.match(/\.(txt|md|doc|docx)$/i)||i.includes("letterpad"))return"image/file.webp";if(i.match(/\.(html|htm)$/i)||r.match(/\.(html|htm)$/i))return"image/html.webp"}return n.includes("LetterPad")||n.includes(".md")||n.includes(".txt")?"image/file.webp":n.includes(".jpg")||n.includes(".png")||n.includes(".gif")||n.includes(".webp")||n.includes(".jpeg")||n.includes(".bmp")||n.includes(".avif")?"image/image.webp":n.includes(".mp4")||n.includes(".webm")||n.includes(".avi")||n.includes(".mov")||n.includes(".mkv")?"image/video.webp":n.includes(".mp3")||n.includes(".wav")||n.includes(".ogg")||n.includes(".m4a")||n.includes(".flac")?"image/audio.webp":n.includes(".html")||n.includes(".htm")?"image/html.webp":null}function se(e,n,t=!1,o=null,i=!1,r=!1,a={type:"default"},s="default",l=null,d="white",c=null){let m=n;o||(o="window-"+Date.now()),s==="Settings"&&(m=Ea()),s==="Explorer"&&(m=n||getExplorerWindowContent()),s==="App"&&(m=n);let u="";a.type==="integer"?u=`width: ${a.width}px; height: ${a.height}px; max-width:100%;`:u="width: 100%; height: 100%;";const f=document.createElement("div");f.id=o,f.className="absolute border border-gray-500 shadow-lg overflow-auto z-20",f.style.cssText=u,f.style.minWidth="320px",f.style.minHeight="200px",f.setAttribute("role","dialog"),f.setAttribute("aria-label",e),f.setAttribute("aria-modal","false"),i?(f.style.display="none",f.setAttribute("aria-hidden","true")):f.setAttribute("aria-hidden","false"),f.textContent="";const p=document.createElement("div");p.className="relative w-full h-[calc(100%-2.5rem)]";const g=document.createElement("div");g.className="bg-handlebar-blue sticky top-0 left-0 text-white px-2 py-1 flex justify-between items-center cursor-move",g.style.backgroundColor="#003f7f",g.setAttribute("role","banner");const k=document.createElement("span");k.textContent=e,k.className="window-title flex-1 truncate pr-2",k.style.maxWidth="calc(100% - 120px)",k.id=`${o}-title`;const v=document.createElement("div");v.className="my-1 flex-shrink-0",v.setAttribute("role","group"),v.setAttribute("aria-label","Window controls");const y=document.createElement("button");y.id=`minimizeWindow-${o}`,y.className="bg-yellow-500 h-6 w-6 text-white",y.textContent="_",y.setAttribute("aria-label",`Minimize ${e}`),y.setAttribute("title","Minimize window"),y.addEventListener("click",b=>{Ze(o),b.stopPropagation()});const P=document.createElement("button");P.id=`toggleFullScreen-${o}`,P.className="bg-green-500 h-6 w-6 text-white ml-1",P.textContent="‚õ∂",P.setAttribute("aria-label",`Toggle fullscreen for ${e}`),P.setAttribute("title","Toggle fullscreen"),P.addEventListener("click",b=>{$t(o),b.stopPropagation()});const j=document.createElement("button");j.id=`closeWindow-${o}`,j.className="bg-red-500 h-6 w-6 text-white ml-1",j.textContent="X",j.setAttribute("aria-label",`Close ${e}`),j.setAttribute("title","Close window"),j.addEventListener("click",b=>{le(o),b.stopPropagation()}),v.append(y,P,j),g.append(k,v);const K=document.createElement("div");if(K.className=`p-2 bg-${d} h-full ${s==="editor"?"w-full":""} overflow-auto`,K.innerHTML=m,K.setAttribute("role","main"),K.setAttribute("aria-labelledby",`${o}-title`),s==="default"&&(K.setAttribute("role","textbox"),K.setAttribute("aria-label",`Editable content for ${e}`),K.addEventListener("input",()=>{updateContent(o,K.innerHTML)})),s==="Explorer"&&setTimeout(()=>{typeof Pe=="function"&&Pe()},50),p.append(g,K),f.appendChild(p),c!=null)f.style.zIndex=c,parseInt(c)>Se&&At(parseInt(c));else{try{const b=document.getElementById("windows-container");if(b){let h=Se;const x=b.children;for(let A=0;A<x.length;A++){const W=parseInt(getComputedStyle(x[A]).zIndex)||0;W>h&&(h=W)}h>Se&&At(h)}}catch{}At(Se+1),f.style.zIndex=Se}f.addEventListener("click",function(){Ie(f)},!0),document.getElementById("windows-container").appendChild(f);const T=document.createElement("div");T.id="tab-"+o,T.className="bg-gray-200 border border-gray-500 px-2 py-1 cursor-pointer flex items-center",T.setAttribute("role","tab"),T.setAttribute("aria-label",`${e} window tab`),T.setAttribute("aria-pressed",i?"false":"true"),T.setAttribute("tabindex","0");const q=uo(o,e);if(q){const b=document.createElement("img");b.src=q,b.className="h-4 w-4 mr-2",b.alt="",T.appendChild(b);const h=document.createElement("span");h.textContent=e,T.appendChild(h)}else T.textContent=e;const z=function(){f.style.display==="none"?(Ie(f),T.setAttribute("aria-pressed","true")):(Ze(f.id),T.setAttribute("aria-pressed","false"))};T.onclick=z,T.addEventListener("keydown",function(b){(b.key==="Enter"||b.key===" ")&&(b.preventDefault(),z())}),T.addEventListener("contextmenu",function(b){b.preventDefault(),Ba(b,o,f)}),document.getElementById("window-tabs").appendChild(T);const R=re[o],_=R?R.position:null,Z=R?R.dimensions:a,J=R?R.fullScreen:!1;if(re[o]={id:o,title:e,content:m,isNav:t,isMinimized:i,dimensions:r&&R?Z:a,windowType:s,position:_,fullScreen:J,color:d,zIndex:parseInt(f.style.zIndex)||Se},t&&(Ne[e]=o),i||Ie(f),a.type!=="default"){if(r&&_&&(f.style.left=_.left,f.style.top=_.top),r&&Z&&Z.type==="integer"&&(f.style.width=Z.width+"px",f.style.height=Z.height+"px"),!r||!_)if(l){let b=parseInt(l.style.left,10)||0,h=parseInt(l.style.top,10)||0,x=b+30,A=h+30,W=window.innerWidth,Y=window.innerHeight-40,ie=a.width,we=a.height;if(x+ie>W||A+we>Y){x=0,A=0;const Q=Array.from(document.querySelectorAll("#windows-container > div")).find(ee=>(parseInt(ee.style.left,10)||0)<=10&&(parseInt(ee.style.top,10)||0)<=10);Q&&(x=(parseInt(Q.style.left,10)||0)+30)}f.style.left=x+"px",f.style.top=A+"px"}else f.style.left="100px",f.style.top="100px";Hi(f),Ui(f)}r||X();try{ji(f)}catch{}return f}function Ze(e){const n=document.getElementById(e);if(n){n.style.display="none",n.setAttribute("aria-hidden","true"),re[e]&&(re[e].isMinimized=!0,X());const t=document.getElementById("tab-"+e);t&&(t.classList.remove("bg-gray-50"),t.setAttribute("aria-pressed","false"))}}function Ie(e){let n=!1;try{const o=document.getElementById("windows-container");if(o){let i=Se;const r=o.children;for(let a=0;a<r.length;a++){const s=parseInt(getComputedStyle(r[a]).zIndex)||0;s>i&&(i=s)}i>Se&&At(i)}}catch{}if(e.style.display==="none"){e.style.display="block",e.setAttribute("aria-hidden","false"),re[e.id]&&(re[e.id].isMinimized=!1,n=!0);const o=document.getElementById("tab-"+e.id);o&&o.setAttribute("aria-pressed","true")}At(Se+1),e.style.zIndex=Se,re[e.id]&&(re[e.id].zIndex=Se,n=!0),n&&X(),document.querySelectorAll("#window-tabs > div").forEach(o=>o.classList.remove("bg-gray-50"));const t=document.getElementById("tab-"+e.id);t&&t.classList.add("bg-gray-50"),e.querySelector("video, audio")&&(Qi(e.id),updateMediaControl())}let Ue=-1,en=!1;function On(){const e=Array.from(document.querySelectorAll("#windows-container > div")).filter(n=>n.style.display!=="none"&&n.id!=="taskbar");if(e.length!==0){if(e.length===1){Ie(e[0]);return}e.sort((n,t)=>{const o=parseInt(n.style.zIndex)||0;return(parseInt(t.style.zIndex)||0)-o}),en?Ue=(Ue+1)%e.length:(Aa(e),en=!0,Ue=0),po(Ue)}}function Aa(e){const n=document.getElementById("window-cycle-popup"),t=document.getElementById("window-cycle-list");if(!n||!t)return;t.innerHTML="",e.forEach((i,r)=>{var m;const a=((m=i.querySelector(".window-title"))==null?void 0:m.textContent)||"Unknown Window",s=i.id,l=uo(s,a),d=document.createElement("div");if(d.className="flex flex-col items-center p-3 border-2 border-transparent rounded-lg min-w-16 cursor-pointer hover:bg-gray-100 transition-all duration-200",d.setAttribute("data-window-index",r),l){const u=document.createElement("img");u.src=l,u.className="h-8 w-8 mb-1",u.alt="",d.appendChild(u)}else{const u=document.createElement("div");u.className="h-8 w-8 mb-1 bg-gray-400 rounded flex items-center justify-center text-white text-sm",u.textContent=a.charAt(0),d.appendChild(u)}const c=document.createElement("span");c.className="text-xs text-center break-words max-w-16",c.textContent=a.length>10?a.substring(0,10)+"...":a,d.appendChild(c),d.addEventListener("click",()=>{Ue=r,_i(e[r])}),t.appendChild(d)});const o=i=>{t.contains(i.target)||(pt(),n.removeEventListener("click",o))};n.addEventListener("click",o),n.classList.remove("hidden"),n.style.display="flex",po(0)}function po(e){const n=document.querySelectorAll("#window-cycle-list > div");n.forEach(t=>{t.classList.remove("border-blue-500","bg-blue-100"),t.classList.add("border-transparent"),t.style.transform="translateY(0)",t.style.boxShadow="none"}),n[e]&&(n[e].classList.remove("border-transparent"),n[e].classList.add("border-blue-500","bg-blue-100"),n[e].style.transform="translateY(-2px)",n[e].style.boxShadow="0 4px 8px rgba(59, 130, 246, 0.3)")}function _i(e){var i;if(!e)return;Ie(e),e.focus();const n=document.getElementById("window-cycle-popup");n&&(n.classList.add("hidden"),n.style.display="none"),en=!1,Ue=-1;const t=((i=e.querySelector(".window-title"))==null?void 0:i.textContent)||"Unknown Window";let o=document.getElementById("window-cycle-announce");o||(o=document.createElement("div"),o.id="window-cycle-announce",o.className="sr-only",o.setAttribute("aria-live","polite"),o.setAttribute("aria-atomic","true"),document.body.appendChild(o)),o.textContent=`Switched to ${t}`}function pt(){if(en){const e=Array.from(document.querySelectorAll("#windows-container > div")).filter(n=>n.style.display!=="none"&&n.id!=="taskbar");if(e.length>0){e.sort((t,o)=>{const i=parseInt(t.style.zIndex)||0;return(parseInt(o.style.zIndex)||0)-i});const n=e[Ue]||e[0];_i(n)}}}function _o(){var t;const e=Array.from(document.querySelectorAll("#windows-container > div")).filter(o=>o.style.display!=="none"&&o.id!=="taskbar");if(e.length===0)return;e.sort((o,i)=>{const r=parseInt(o.style.zIndex)||0;return(parseInt(i.style.zIndex)||0)-r});const n=e[0];if(n){le(n.id);const o=((t=n.querySelector(".window-title"))==null?void 0:t.textContent)||"Unknown Window";let i=document.getElementById("window-cycle-announce");i||(i=document.createElement("div"),i.id="window-cycle-announce",i.className="sr-only",i.setAttribute("aria-live","polite"),i.setAttribute("aria-atomic","true"),document.body.appendChild(i)),i.textContent=`Closed ${o}`}}function Da(){var t;const e=Array.from(document.querySelectorAll("#windows-container > div")).filter(o=>o.style.display!=="none"&&o.id!=="taskbar");if(e.length===0)return;e.sort((o,i)=>{const r=parseInt(o.style.zIndex)||0;return(parseInt(i.style.zIndex)||0)-r});const n=e[0];if(n){Ze(n.id);const o=((t=n.querySelector(".window-title"))==null?void 0:t.textContent)||"Unknown Window";let i=document.getElementById("window-cycle-announce");i||(i=document.createElement("div"),i.id="window-cycle-announce",i.className="sr-only",i.setAttribute("aria-live","polite"),i.setAttribute("aria-atomic","true"),document.body.appendChild(i)),i.textContent=`Minimized ${o}`}}function le(e){const n=document.getElementById(e);n&&n.remove();const t=document.getElementById("tab-"+e);t&&t.remove(),ft===e&&(Qi(null),updateMediaControl()),delete re[e];for(const o in Ne)if(Ne[o]===e){delete Ne[o];break}X()}function Hi(e){const n=e.querySelector(".cursor-move");n&&n.addEventListener("mousedown",function(t){t.preventDefault();const o=e.getBoundingClientRect(),i=t.clientX-o.left,r=t.clientY-o.top;let a=0,s=0;const l=document.getElementById("desktop-stage");if(l){const m=getComputedStyle(l).transform;if(m&&m!=="none"){const u=m.match(/matrix\(([^)]+)\)/);if(u&&u[1]){const f=u[1].split(",").map(p=>parseFloat(p.trim()));f.length===6&&(a=f[4],s=f[5])}}}function d(m){e.style.left=m.clientX-i-a+"px",e.style.top=m.clientY-r-s+"px"}function c(){document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",c),re[e.id]&&(re[e.id].position={left:e.style.left,top:e.style.top},X())}document.addEventListener("mousemove",d),document.addEventListener("mouseup",c),Ie(e)})}function Ui(e){const n=document.createElement("div");n.className="absolute bottom-0 right-0 w-6 h-6 cursor-se-resize",n.style.background="rgba(0,0,0,0.2)",n.style.zIndex="1100",n.style.pointerEvents="auto",n.style.borderTop="1px solid rgba(255,255,255,0.2)",n.style.borderLeft="1px solid rgba(255,255,255,0.05)",e.appendChild(n),n.addEventListener("mousedown",function(t){t.preventDefault(),t.stopPropagation();const o=t.clientX,i=t.clientY,r=parseInt(document.defaultView.getComputedStyle(e).width,10),a=parseInt(document.defaultView.getComputedStyle(e).height,10);function s(d){const c=Math.max(r+d.clientX-o,350),m=Math.max(a+d.clientY-i,200);e.style.width=c+"px",e.style.height=m+"px"}function l(){document.documentElement.removeEventListener("mousemove",s,!1),document.documentElement.removeEventListener("mouseup",l,!1),re[e.id].dimensions={type:"integer",width:parseInt(e.style.width),height:parseInt(e.style.height)},X()}document.documentElement.addEventListener("mousemove",s,!1),document.documentElement.addEventListener("mouseup",l,!1)})}function $t(e){const n=document.getElementById(e);if(!n)return;let t=re[e];t.fullScreen?(t.originalDimensions&&t.originalPosition?(n.style.left=t.originalPosition.left,n.style.top=t.originalPosition.top,n.style.width=t.originalDimensions.width+"px",n.style.height=t.originalDimensions.height+"px",t.dimensions=t.originalDimensions):(n.style.left="15%",n.style.top="15%",n.style.width="70vw",n.style.height="70vh",t.dimensions={type:"integer",width:window.innerWidth*.7,height:window.innerHeight*.7}),t.fullScreen=!1,Hi(n),Ui(n)):(t.originalDimensions=t.dimensions,t.originalPosition=t.position,n.style.left="0px",n.style.top="0px",n.style.width=window.innerWidth+"px",n.style.height=window.innerHeight-40+"px",t.dimensions={type:"default"},t.fullScreen=!0),X()}function oe(e,n,t=null,o=null,i={}){const r=n==="confirmation"||n==="confirm",a=n==="prompt",s=(r||a?"promptWindow-":"dialogWindow-")+Date.now(),l=r&&(t||o);let d;if(a){const u=i.defaultValue||"";d=`
      <div class="flex flex-col p-4 h-full justify-between">
        <div class="mb-4">
          <p class="text-sm mb-3">${e}</p>
          <input type="text" id="${s}-input" value="${u.replace(/"/g,"&quot;")}" class="w-full px-2 py-1 border-2 border-gray-400 bg-white" style="border-top-color:#808080; border-left-color:#808080; border-bottom-color:#ffffff; border-right-color:#ffffff; border-style: inset;" aria-label="Text input for prompt dialog" title="Enter your response here" />
        </div>
        <div class="flex gap-2 justify-center">
          <button id="${s}-ok-button" class="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2"><span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">OK</span></button>
          <button id="${s}-cancel-button" class="bg-gray-200 border-t-2 border-l-2 border-gray-300"><span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Cancel</span></button>
        </div>
      </div>
    `}else l?d=`
      <div class="text-center p-4">
        <h2 class="text-lg mb-4">${e}</h2>
        <div class="flex gap-2 justify-center">
          <button id="${s}-ok-button" class="bg-gray-200 border-2 border-gray-400 px-4 py-2 hover:bg-gray-300" style="border-style: outset;">
            OK
          </button>
          <button id="${s}-cancel-button" class="bg-gray-200 border-2 border-gray-400 px-4 py-2 hover:bg-gray-300" style="border-style: outset;">
            Cancel
          </button>
        </div>
      </div>
    `:d=`
      <div class="text-center p-4">
        <h2 class="text-lg mb-4">${e}</h2>
        <button id="${s}-button" class="bg-gray-200 border-2 border-gray-400 px-4 py-2 hover:bg-gray-300" style="border-style: outset;">
          OK
        </button>
      </div>
    `;let c="‚ö†Ô∏è Information";if(a)c="üí¨ Input Required",Bn(e,"polite");else if(r)c=l?"‚ö†Ô∏è Confirmation":"‚úÖ Success",Bn(e,"polite");else if(n==="error"){c="‚ö†Ô∏è Error";const u=document.getElementById("error-popup-audio");u&&u.play(),Bn(e,"assertive")}const m=se(c,d,!1,s,!1,!1,{type:"integer",width:350,height:180},"default");return Ie(m),setTimeout(()=>{Ie(m)},10),setTimeout(()=>{if(a){const u=document.getElementById(`${s}-ok-button`),f=document.getElementById(`${s}-cancel-button`),p=document.getElementById(`${s}-input`);p&&(setTimeout(()=>{p.focus(),p.select()},10),p.addEventListener("keydown",g=>{if(g.key==="Enter"){g.preventDefault();const k=p.value;le(s),t&&t(k)}else g.key==="Escape"&&(g.preventDefault(),le(s),o&&o(null))})),u&&u.addEventListener("click",()=>{const g=p?p.value:"";le(s),t&&t(g)}),f&&f.addEventListener("click",()=>{le(s),o&&o(null)})}else if(l){const u=document.getElementById(`${s}-ok-button`),f=document.getElementById(`${s}-cancel-button`);u&&u.addEventListener("click",()=>{le(s),t&&t()}),f&&f.addEventListener("click",()=>{le(s),o&&o()})}else{const u=document.getElementById(`${s}-button`);u&&u.addEventListener("click",()=>{le(s),t&&t()})}},100),m}function Bn(e,n="polite"){const t=document.getElementById(n==="assertive"?"sr-alerts":"sr-announcements");t.textContent=e,setTimeout(()=>{t.textContent=""},1e3)}document.addEventListener("click",e=>{e.target.closest("#settings-apply-button")&&(e.stopPropagation(),oe("Are you sure you want to apply these desktop settings changes?","confirmation",()=>{Ke("settings-apply-button","Applied!"),setTimeout(()=>{Ke("settings-apply-button","Apply")},1e3),Sa(),oe("Your settings have successfully been saved!","info")}))});function Ba(e,n,t){const o=document.getElementById("context-menu");o.replaceChildren(),o.style.zIndex=(Se||1e3)+100;const i=(m,u,f)=>{const p=document.createElement("div");return p.className="px-4 py-2 hover:bg-gray-50 cursor-pointer",p.textContent=m,f&&p.addEventListener("click",f),o.appendChild(p),p},r=t.style.display==="none",a=re[n]&&re[n].fullScreen;r?i("Restore",!1,()=>{Ie(t),hideContextMenu()}):i("Minimize",!1,()=>{Ze(n),hideContextMenu()}),a||i("Maximize",!1,()=>{$t(n),hideContextMenu()}),i("Close",!1,()=>{le(n),hideContextMenu()}),o.classList.remove("hidden");const s=o.getBoundingClientRect(),l=48;let d=e.pageX;d+s.width>window.innerWidth&&(d=window.innerWidth-s.width-10);let c=window.innerHeight-l-s.height-5;o.style.left=d+"px",o.style.top=c+"px",setTimeout(()=>{document.addEventListener("click",hideContextMenu,{once:!0})},0)}function ji(e){if(!e)return;const n=re[e.id];if(n&&n.fullScreen)return;const t=window.innerWidth,o=window.innerHeight-40,i=e.getBoundingClientRect();let r=!1;i.width>t&&(e.style.width=Math.max(350,t-10)+"px",n&&(n.dimensions={type:"integer",width:parseInt(e.style.width),height:parseInt(e.style.height||i.height)}),r=!0);let a=0,s=0;const l=document.getElementById("desktop-stage");if(l){const f=getComputedStyle(l).transform;if(f&&f!=="none"){const p=f.match(/matrix\(([^)]+)\)/);if(p){const g=p[1].split(",").map(k=>parseFloat(k.trim()));g.length===6&&(a=g[4],s=g[5])}}}const d=parseInt(e.style.left,10)||0,c=parseInt(e.style.top,10)||0;let m=d,u=c;d+i.width<-a+50&&(m=-a+20,r=!0),c+i.height<-s+50&&(u=-s+20,r=!0),d>-a+t-50&&(m=-a+t-i.width-20,r=!0),c>-s+o-50&&(u=-s+o-i.height-20,r=!0),e.style.left=m+"px",e.style.top=u+"px",r&&n&&(n.position={left:e.style.left,top:e.style.top},X())}let Tn=null;window.addEventListener("resize",()=>{Tn&&cancelAnimationFrame(Tn),Tn=requestAnimationFrame(()=>{document.querySelectorAll("#windows-container > div").forEach(e=>ji(e))})});(function(){if(typeof window>"u"||window.__touchGesturesSetup||!("ontouchstart"in window||navigator.maxTouchPoints>0))return;window.__touchGesturesSetup=!0;function t(s,{threshold:l=50,onLeft:d,onRight:c}={}){if(!s)return;let m=0,u=0;s.addEventListener("touchstart",f=>{if(!f.touches||f.touches.length!==1)return;const p=f.touches[0];m=p.clientX,u=p.clientY},{passive:!0}),s.addEventListener("touchmove",f=>{!f.touches||f.touches.length},{passive:!0}),s.addEventListener("touchend",f=>{if(f.changedTouches&&f.changedTouches.length===1){const p=f.changedTouches[0],g=p.clientX-m,k=p.clientY-u;Math.abs(g)>Math.abs(k)&&Math.abs(g)>l&&(g<0&&typeof d=="function"&&d(f),g>0&&typeof c=="function"&&c(f))}},{passive:!0})}function o(s,{maxDuration:l=300,maxMove:d=15,onTap:c}={}){if(!s)return;let m=0,u=[];s.addEventListener("touchstart",f=>{f.touches.length===2?(m=Date.now(),u=Array.from(f.touches).map(p=>({x:p.clientX,y:p.clientY}))):(m=0,u=[])},{passive:!0}),s.addEventListener("touchend",f=>{if(!m)return;if(Date.now()-m>l){m=0;return}const g=f.changedTouches;if(!g||g.length<1){m=0;return}let k=!1;Array.from(g).forEach((v,y)=>{const P=u[y]||u[0];P&&Math.hypot(v.clientX-P.x,v.clientY-P.y)>d&&(k=!0)}),!k&&typeof c=="function"&&c(f),m=0,u=[]},{passive:!0})}function i({threshold:s=60}={}){let l=0,d=!1,c=null;document.addEventListener("touchstart",m=>{if(m.touches.length===2){const u=m.target.closest(".cursor-move");if(u){l=(m.touches[0].clientY+m.touches[1].clientY)/2,d=!0;const f=u.closest('[role="dialog"]');c=f?f.id:null}}},{passive:!0}),document.addEventListener("touchmove",m=>{},{passive:!0}),document.addEventListener("touchend",m=>{var k;if(!d)return;if(!m.target.closest(".cursor-move")){d=!1,c=null;return}const p=(((k=m.changedTouches[0])==null?void 0:k.clientY)??l)-l,g=c;d=!1,c=null,g&&(p>s?typeof Ze=="function"&&Ze(g):p<-s&&typeof $t=="function"&&$t(g))},{passive:!0})}const r=document.getElementById("window-tabs");t(r,{onLeft:()=>{if(!window.__isWindowCycling)try{On()}catch{}try{const s=document.querySelectorAll("#window-cycle-list > div");s.length&&typeof window<"u"&&(Ue=(Ue-1+s.length)%s.length,po(Ue))}catch{}setTimeout(()=>{try{pt()}catch{}},10)},onRight:()=>{try{On()}catch{}setTimeout(()=>{try{pt()}catch{}},10)}});const a=document.getElementById("desktop-stage")||document.body;o(a,{onTap:()=>{try{typeof window.minimizeAllWindows=="function"&&window.minimizeAllWindows()}catch{}}}),i(),function(){let l=null,d=0,c=0,m=null;const u=500,f=12;function p(){l&&(clearTimeout(l),l=null)}document.addEventListener("touchstart",g=>{if(!g.touches||g.touches.length!==1){p();return}if(g.target.closest('input, textarea, [contenteditable="true"]')){p();return}const v=g.touches[0];d=v.clientX,c=v.clientY,m=g.target,p(),l=setTimeout(()=>{const y=document.elementFromPoint(d,c)||m||document.body,P=new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,clientX:d,clientY:c});y.dispatchEvent(P),p()},u)},{passive:!0}),document.addEventListener("touchmove",g=>{if(!l||!g.touches||g.touches.length!==1)return;const k=g.touches[0];(Math.abs(k.clientX-d)>f||Math.abs(k.clientY-c)>f)&&p()},{passive:!0}),document.addEventListener("touchend",()=>{p()},{passive:!0}),document.addEventListener("touchcancel",()=>{p()},{passive:!0})}()})();function mn(){const e=document.createElement("div");e.className="w-3xl fixed left-0 top-0 h-full w-full bg-gradient-to-b from-40% from-blue-500 to-cyan-500",e.id="splash-screen",e.style.zIndex="9000",e.innerHTML=`
  <div class="flex flex-col items-center justify-center h-full">
    <img id="splash-image" src="./image/logo.webp" alt="Startup" class="mb-4 max-w-48">
    <h1 class="sr-only">Doorways '25, a Nostalgia Inducing Operating System</h1>
    <div class="mx-auto w-72 text-sm pl-3 mb-2 bg-black py-1 border-2 border-lime-400 text-lime-300"><em>i hacked the mainframe credentials for u</em><br><span class="text-xs text-lime-500">sincerely, _N30_phreak_</span></div>
    <form id="splash-form" class="bg-gray-300 border border-gray-500 p-4 w-96">
      <div class="mb-2">
        <label class="block text-sm">Username</label>
        <input type="text" id="splash-username" value="admin" class="border px-1 py-1 w-full" readonly>
      </div>
      <div class="mb-2">
        <label class="block text-sm">Password</label>
        <input type="password" id="splash-password" value="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="border px-1 py-1 w-full" readonly>
      </div>
      <button id="splash-login" class="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2"><span class="border-b-2 border-r-2 border-black block h-full max-h-10 w-full py-1.5 px-3">Login</span></button>
    </form>
  </div>
`,document.body.appendChild(e);const n=document.getElementById("splash-audio");document.getElementById("splash-login").addEventListener("click",function(t){n.play(),t.preventDefault(),document.getElementById("splash-image").src="./image/icon.gif",n.currentTime=0,setTimeout(function(){e.remove()},3e3)})}async function Yi(){const e=document.createElement("div");e.className="w-3xl fixed left-0 top-0 h-full w-full bg-gradient-to-b from-blue-500 to-cyan-500",e.id="splash-screen",e.style.zIndex="9999",e.innerHTML=`
  <div class="flex flex-col items-center justify-center h-full">
    <img id="splash-image" src="./image/logo.webp" alt="Startup" class="mb-4 max-w-48">
    <h2 class="text-4xl text-gray-900 font-bold mb-2">System Loading ...</h2>
  </div>
`,document.body.appendChild(e);try{typeof rn=="function"&&await rn()}catch(n){console.warn("System update check failed:",n)}setTimeout(function(){e.remove()},1e3)}typeof window<"u"&&(window.showSplash=mn,window.showOSLoading=Yi);async function tn(){await B.setItem("explicitRestart",!0),Ya(),Ga(),Ua([]),ja({clockSeconds:!1,bgColor:"#20b1b1",bgImage:""}),mn()}async function Gi(){await B.setItem("explicitRestart",!0);try{await X()}catch(e){console.warn("Failed to save state before logout:",e)}mn()}typeof window<"u"&&(window.restart=tn,window.logout=Gi);function Ki(){se("Storage Manager",'<div id="storage-content" style="padding: 20px;">Loading storage information...</div>',!1,"storage-window",!1,!1,{type:"integer",width:600,height:500},"default"),setTimeout(nn,100)}async function nn(){const e=document.getElementById("storage-content");if(e)try{const n=await navigator.storage.estimate(),t=(n.quota/(1024*1024)).toFixed(2),o=(n.usage/(1024*1024)).toFixed(2),i=((n.quota-n.usage)/(1024*1024)).toFixed(2),r=(n.usage/n.quota*100).toFixed(1),a=await Fa(),s=`
      <div class="storage-manager">
        <h2 class="text-xl font-bold mb-4">Storage Information</h2>

        <!-- Storage Capacity -->
        <div class="mb-6 p-4 bg-gray-100 rounded">
          <h3 class="text-lg font-semibold mb-2">Storage Capacity</h3>
          <div class="mb-2">
            <div class="flex justify-between mb-1">
              <span>Used: ${o} MB</span>
              <span>Available: ${i} MB</span>
            </div>
            <div class="w-full bg-gray-300 rounded-full h-4">
              <div class="bg-blue-500 h-4 rounded-full" style="width: ${r}%"></div>
            </div>
            <div class="text-sm text-gray-600 mt-1">
              ${r}% of ${t} MB total capacity used
            </div>
          </div>
        </div>

        <!-- Data Categories -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-3">Data Categories</h3>
          <div class="grid grid-cols-2 gap-4">
            ${Ht("App Data",a.appData,"bg-blue-100")}
            ${Ht("Media Files",a.mediaData,"bg-green-100")}
            ${Ht("Files & Folders",a.fileData,"bg-yellow-100")}
            ${Ht("Miscellaneous",a.miscData,"bg-gray-100")}
          </div>
        </div>

        <!-- Detailed Breakdown -->
        <div class="mb-4">
          <h3 class="text-lg font-semibold mb-3">Detailed Breakdown</h3>
          <div class="bg-white border rounded p-3">
            ${Ta(a)}
          </div>
        </div>

        <!-- Actions -->
        <div class="mt-6 flex gap-3">
          <div id="refresh-btn-container"></div>
          <div id="cleanup-btn-container"></div>
          <div id="restore-btn-container"></div>
        </div>
      </div>
    `;e.innerHTML=s;const l=await Xi(),d=de("Refresh Data");d.onclick=Nt,document.getElementById("refresh-btn-container").appendChild(d);const c=de("Cleanup Options");c.onclick=Vi,document.getElementById("cleanup-btn-container").appendChild(c);const m=de("Restore All Applications");m.onclick=qa,l.count===0?(m.disabled=!0,m.title="All applications are already in the Start menu",m.style.opacity="0.6",m.style.cursor="not-allowed"):m.title=`Restore ${l.count} missing applications to Start menu`,document.getElementById("restore-btn-container").appendChild(m)}catch(n){const t=document.createElement("div");t.className="text-red-500",t.textContent=`Error loading storage data: ${n.message}`,e.innerHTML="",e.appendChild(t)}}function Ht(e,n,t){const o=(n.totalSize/1024).toFixed(1);return`
    <div class="p-4 ${t} rounded">
      <h4 class="font-semibold">${e}</h4>
      <div class="text-2xl font-bold">${n.count}</div>
      <div class="text-sm text-gray-600">items (${o} KB)</div>
    </div>
  `}function Ta(e){let n='<div class="space-y-2 text-sm">';return e.appData.breakdown.length>0&&(n+="<div><strong>App Data:</strong></div>",e.appData.breakdown.forEach(t=>{n+=`<div class="ml-4">‚Ä¢ ${t.name}: ${t.count} items</div>`})),e.mediaData.breakdown.length>0&&(n+='<div class="mt-3"><strong>Media Files:</strong></div>',e.mediaData.breakdown.forEach(t=>{const o=(t.size/1024).toFixed(1);n+=`<div class="ml-4">‚Ä¢ ${t.type}: ${t.count} files (${o} KB)</div>`})),e.fileData.breakdown.length>0&&(n+='<div class="mt-3"><strong>Files & Folders:</strong></div>',e.fileData.breakdown.forEach(t=>{n+=`<div class="ml-4">‚Ä¢ ${t.name}: ${t.count} items</div>`})),n+="</div>",n}async function Fa(){const e={appData:{count:0,totalSize:0,breakdown:[]},mediaData:{count:0,totalSize:0,breakdown:[]},fileData:{count:0,totalSize:0,breakdown:[]},miscData:{count:0,totalSize:0,breakdown:[]}};return await $a(e),await Pa(e),e}async function $a(e){try{const t=await B.getItem("appState")||{},o=JSON.stringify(t).length;if(t.fileSystemState){const i=JSON.stringify(t.fileSystemState).length;e.fileData.totalSize+=i;const r=t.fileSystemState;r.folders&&Object.values(r.folders).forEach(a=>{qn(a,e.fileData)})}if(t.windowStates){const i=JSON.stringify(t.windowStates).length;e.appData.totalSize+=i,e.appData.count+=Object.keys(t.windowStates).length,e.appData.breakdown.push({name:"Window States",count:Object.keys(t.windowStates).length})}if(t.desktopIconsState){const i=JSON.stringify(t.desktopIconsState).length;e.appData.totalSize+=i,e.appData.count+=Object.keys(t.desktopIconsState).length,e.appData.breakdown.push({name:"Desktop Icons",count:Object.keys(t.desktopIconsState).length})}if(t.desktopSettings){const i=JSON.stringify(t.desktopSettings).length;e.appData.totalSize+=i,e.appData.count+=1,e.appData.breakdown.push({name:"Desktop Settings",count:1})}}catch(n){console.error("Error analyzing storage:",n)}}function qn(e,n){!e||typeof e!="object"||(e.type==="folder"?(n.count++,e.contents&&Object.values(e.contents).forEach(t=>{qn(t,n)})):e.type==="ugc-file"?(n.count++,["mp3","mp4","jpg","jpeg","png","gif","webp","wav","webm"].includes(e.content_type)):Object.values(e).forEach(t=>{t&&typeof t=="object"&&qn(t,n)}))}async function Pa(e){try{const n=await indexedDB.databases();for(const t of n)t.name==="media_player_db"?await za(e):(e.miscData.count+=1,e.miscData.breakdown.push({name:`Database: ${t.name}`,count:1}))}catch(n){console.error("Error analyzing IndexedDB:",n)}}async function za(e){return new Promise((n,t)=>{const o=indexedDB.open("media_player_db");o.onsuccess=i=>{const r=i.target.result,l=r.transaction(["songs"],"readonly").objectStore("songs").getAll();l.onsuccess=()=>{const d=l.result,c={};d.forEach(m=>{const u=m.type||"unknown";c[u]||(c[u]={count:0,size:0}),c[u].count++,m.file&&m.file.size&&(c[u].size+=m.file.size,e.mediaData.totalSize+=m.file.size),e.mediaData.count++}),Object.entries(c).forEach(([m,u])=>{e.mediaData.breakdown.push({type:m.toUpperCase(),count:u.count,size:u.size})}),r.close(),n()},l.onerror=()=>{r.close(),t(l.error)}},o.onerror=()=>{t(o.error)}})}function Nt(){const e=document.getElementById("storage-content");e&&(e.innerHTML="Refreshing storage information...",setTimeout(nn,100))}function Na(e,n=null,t=null){const o=document.createElement("select");return o.className="bg-white border-t-2 border-l-2 border-black border-b-2 border-r-2 border-gray-300 px-2 py-1",o.setAttribute("aria-label","Select storage cleanup option"),o.setAttribute("title","Choose which type of data to clean up"),e.forEach(i=>{const r=document.createElement("option");typeof i=="string"?(r.value=i,r.textContent=i):(r.value=i.value,r.textContent=i.text||i.value),n!==null&&r.value===n&&(r.selected=!0),o.appendChild(r)}),t&&typeof t=="function"&&o.addEventListener("change",i=>t(i.target.value,i)),o}function Vi(){const e=se("Storage Cleanup",'<div id="cleanup-content" style="padding: 20px;">Loading cleanup options...</div>',!1,"storage-cleanup-window",!1,!1,{type:"integer",width:400,height:340},"default");setTimeout(()=>{const t=[...document.querySelectorAll("*")].filter(o=>getComputedStyle(o).zIndex>100&&getComputedStyle(o).zIndex<1e3).reduce((o,i)=>getComputedStyle(i).zIndex>getComputedStyle(o).zIndex?i:o);e.style.zIndex=`${parseInt(t.style.zIndex)+1}`},50),setTimeout(Wa,100)}function Wa(){const e=document.getElementById("cleanup-content");if(!e)return;const n=`
    <div class="cleanup-options">
      <h3 class="text-lg font-semibold mb-4">Storage Cleanup Options</h3>
      <p class="text-sm text-gray-600 mb-4">Choose what data to clear:</p>

      <div class="space-y-3">
        <div id="clear-media-btn-container"></div>
        <div id="clear-desktop-btn-container"></div>
        <div id="full-restart-btn-container"></div>
      </div>
    </div>
  `;e.innerHTML=n;const t=de("Clear Media Player Data");t.onclick=Ra,t.className+=" w-full mb-2",document.getElementById("clear-media-btn-container").appendChild(t);const o=de("Reset Desktop Settings");o.onclick=Oa,o.className+=" w-full mb-2",document.getElementById("clear-desktop-btn-container").appendChild(o);const i=de("Factory Reset");i.onclick=Zi,i.className+=" w-full mb-2",i.style.backgroundColor="#ffcccc",document.getElementById("full-restart-btn-container").appendChild(i)}async function Ra(){try{await new Promise((n,t)=>{const o=indexedDB.deleteDatabase("media_player_db");o.onsuccess=n,o.onerror=t});const e=getFileSystemStateSync();e.folders["C://Media"]&&(e.folders["C://Media"]={},setFileSystemState(e),saveState()),oe("Media player data cleared successfully!","info"),Nt()}catch(e){oe("Error clearing media player data: "+e.message,"error")}}async function Oa(){const n=await B.getItem("appState")||{};n.desktopSettings={clockSeconds:!1,bgColor:"#20b1b1",bgImage:""},n.desktopIconsState={},n.startMenuOrder=[],await B.setItem("appState",n),oe("Desktop settings reset successfully!","info"),Nt()}async function Xi(){try{const e=[{id:"mycomp",text:"My Computer",icon:"image/computer.webp"},{id:"mailboxapp",text:"Mail Box",icon:"image/mail.webp"},{id:"mediaapp",text:"Media Player",icon:"image/video.webp"},{id:"watercolourapp",text:"Watercolour",icon:"image/watercolour.webp"},{id:"letterpad",text:"LetterPad",icon:"image/file.webp"},{id:"calcapp",text:"Calculator",icon:"image/calculator.webp"},{id:"keyboard",text:"Keyboard",icon:"image/keyboard.webp"},{id:"sysset",text:"System Settings",icon:"image/gears.webp"},{id:"storageapp",text:"Storage Manager",icon:"image/drive_c.webp"},{id:"osupdateapp",text:"OS Update",icon:"image/power.webp"},{id:"abtcomp",text:"About This Computer",icon:"image/info.webp"},{id:"solapp",text:"Solitaire",icon:"image/solitaire.webp"},{id:"chessapp",text:"Guillotine Chess",icon:"image/guillotine_chess.webp"},{id:"bombapp",text:"Bombbroomer",icon:"image/bombbroomer.webp"},{id:"pongapp",text:"Pong",icon:"image/pong.webp"},{id:"snakeapp",text:"Snake",icon:"image/snake.webp"},{id:"happyturdapp",text:"Happy Turd",icon:"image/happyturd.webp"}];let n=[];try{const i=await B.getItem("startMenuOrder");i&&Array.isArray(i)?n=i:n=typeof startMenuOrder<"u"?startMenuOrder:window.startMenuOrder||[]}catch{n=typeof startMenuOrder<"u"?startMenuOrder:window.startMenuOrder||[]}const t=new Set;n.forEach(i=>{typeof i=="string"?t.add(i):i&&i.type==="group"&&i.items&&i.items.forEach(r=>{r&&r.id&&t.add(r.id)})});const o=e.filter(i=>!t.has(i.id));return{count:o.length,apps:o}}catch(e){return console.error("Error checking for missing apps:",e),{count:0,apps:[]}}}async function qa(){try{const e=await Xi();if(e.count===0){typeof oe=="function"?oe("All applications are already present in the Start menu.","info"):alert("All applications are already present in the Start menu.");return}const n=`This will restore ${e.count} missing applications to the Start menu:

${e.apps.map(t=>`‚Ä¢ ${t.text}`).join(`
`)}

Proceed?`;typeof oe=="function"?oe(n,"confirmation",async()=>{await Ho(e.apps)}):confirm(n)&&await Ho(e.apps)}catch(e){console.error("‚ùå Error in restoreAllApplications:",e),typeof oe=="function"?oe("Failed to restore applications: "+e.message,"error"):alert("Failed to restore applications: "+e.message)}}async function Ho(e){try{let n=[];try{const o=await B.getItem("startMenuOrder");o&&Array.isArray(o)?n=[...o]:n=typeof startMenuOrder<"u"?[...startMenuOrder]:[...window.startMenuOrder||[]]}catch{n=typeof startMenuOrder<"u"?[...startMenuOrder]:[...window.startMenuOrder||[]]}const t={letterpad:"utilities-group",calcapp:"utilities-group",sysset:"utilities-group",storageapp:"utilities-group",osupdateapp:"utilities-group",abtcomp:"utilities-group",solapp:"games-group",chessapp:"games-group",bombapp:"games-group",pongapp:"games-group",snakeapp:"games-group"};e.forEach(o=>{const i=t[o.id];if(i){let r=!1;if(n=n.map(a=>typeof a=="object"&&a.type==="group"&&a.id===i?(r=!0,{...a,items:[...a.items||[],{id:o.id,text:o.text,icon:o.icon}]}):a),!r){const a=_a(i);if(a){a.items=[{id:o.id,text:o.text,icon:o.icon}];const s=n.findIndex(l=>l==="rstrtcomp");s!==-1?n.splice(s,0,a):n.push(a)}}}else{const r=n.findIndex(a=>a==="rstrtcomp");r!==-1?n.splice(r,0,o.id):n.push(o.id)}}),window.startMenuOrder=n,typeof startMenuOrder<"u"&&(startMenuOrder=n),await B.setItem("startMenuOrder",n),typeof saveState=="function"&&await saveState(),typeof generateStartMenuHTML=="function"?generateStartMenuHTML():typeof window.generateStartMenuHTML=="function"&&window.generateStartMenuHTML(),typeof safeInitializeStartMenuDragDrop=="function"?setTimeout(()=>{safeInitializeStartMenuDragDrop()},50):typeof window.safeInitializeStartMenuDragDrop=="function"&&setTimeout(()=>{window.safeInitializeStartMenuDragDrop()},50),typeof oe=="function"?oe(`Successfully restored ${e.length} applications to the Start menu.`,"info"):alert(`Successfully restored ${e.length} applications to the Start menu.`),setTimeout(()=>{Nt()},500)}catch(n){console.error("‚ùå Error performing app restore:",n),typeof oe=="function"?oe("Failed to restore applications: "+n.message,"error"):alert("Failed to restore applications: "+n.message)}}function _a(e){return{"utilities-group":{id:"utilities-group",text:"Utilities",type:"group",items:[]},"games-group":{id:"games-group",text:"Games",type:"group",items:[]}}[e]||null}function Zi(){oe("This will completely wipe the entire hard drive and reset the system to factory defaults. All your files, settings, and data will be permanently deleted.","confirmation",()=>{confirm(`‚ö†Ô∏è FINAL WARNING ‚ö†Ô∏è

This will permanently delete EVERYTHING you have ever saved in this application:

‚Ä¢ All uploaded files and media
‚Ä¢ All documents and folders
‚Ä¢ All settings and customizations
‚Ä¢ All application data

This action cannot be undone!

Are you absolutely sure you want to proceed?`)&&Ha()},()=>{})}function Ha(){B.clearSync();const e=indexedDB.deleteDatabase("media_player_db");e.onsuccess=()=>{},e.onerror=n=>{console.error("Factory reset: Error clearing media player database:",n)},windowStates={},desktopIconsState={},startMenuOrder=[],desktopSettings={clockSeconds:!1,bgColor:"#20b1b1",bgImage:""},window.location.reload()}let je={folders:{"C://":{Documents:{id:"Documents",name:"Documents",type:"folder",fullPath:"C://Documents",contents:{}},Desktop:{id:"Desktop",name:"Desktop",type:"folder",fullPath:"C://Desktop",contents:{compostbin:{id:"compostbin",name:"Compost Bin",type:"app",fullPath:"C://Desktop/compostbin",content_type:"html",contents:{},icon:"./image/compost-bin.webp"}}},Media:{id:"Media",name:"Media",type:"folder",fullPath:"C://Media",contents:{}}},"A://":{"folder-34862398":{id:"folder-34862398",name:"example folder",type:"folder",fullPath:"A://folder-34862398",contents:{}}},"D://":{}}},re={},ge={},Ne={},ve={clockSeconds:!1,bgColor:"#20b1b1",bgImage:""},ae,Ji={},Se=100,ft=null;function Ua(e){ae=e,typeof window<"u"&&(window.startMenuOrder=e)}function At(e){Se=e,typeof window<"u"&&(window.highestZ=e)}function Qi(e){ft=e,typeof window<"u"&&(window.activeMediaWindow=e)}function ja(e){Object.assign(ve,e),typeof window<"u"&&(window.desktopSettings=ve)}function Ya(){Object.keys(re).forEach(e=>delete re[e]),typeof window<"u"&&(window.windowStates=re)}function Ga(){Object.keys(ge).forEach(e=>delete ge[e]),typeof window<"u"&&(window.desktopIconsState=ge)}typeof window<"u"&&(window.fileSystemState=je,window.windowStates=re,window.desktopIconsState=ge,window.navWindows=Ne,window.desktopSettings=ve,window.fileFolderMapping=Ji,window.highestZ=Se,window.activeMediaWindow=ft);let on=!1;typeof window<"u"&&(window.isInitializing=on);async function X(){if(on)return;const e=typeof ae<"u"?ae:window.startMenuOrder||[],n=Object.fromEntries(Object.entries(re).filter(([o])=>!/^dialogWindow-/.test(o)&&!/^promptWindow-/.test(o))),t={fileSystemState:je,windowStates:n,desktopIconsState:ge,desktopSettings:ve,navWindows:Ne,startMenuOrder:e};try{await B.setItem("appState",t);const o=Date.now(),i=await B.getItem("appState")}catch(o){console.warn("Failed to save state to IndexedDB:",o),B.setItemSync("appState",t)}}typeof window<"u"&&(window.saveState=X);function Re(){return je}function ke(e){je=e,typeof window<"u"&&(window.fileSystemState=e)}function Je(e,n){re[e]&&(re[e].content=n,X())}async function fo(e,n,t,o,i=null,r=!1){const a=await Re();if(!a||!a.folders){console.error("File system not initialized, creating basic structure");const g={folders:{"C://":{Documents:{id:"Documents",name:"Documents",type:"folder",fullPath:"C://Documents",contents:{}},Desktop:{id:"Desktop",name:"Desktop",type:"folder",fullPath:"C://Desktop",contents:{}},Media:{id:"Media",name:"Media",type:"folder",fullPath:"C://Media",contents:{}}},"A://":{},"D://":{}}};ke(g),a=g}const s=t.match(/^([A-Z]:\/\/)/);if(!s)return console.error("Invalid path format:",t),null;const l=s[1],d=t.replace(/^[A-Z]:\/\//,"").split("/").filter(g=>g);a.folders[l]||(console.error("Drive does not exist:",l),a.folders[l]={});let c=a.folders[l];if(d.length===0)c=a.folders[l];else if(c=a.folders[t],!c)return console.error("Target folder not found in unified structure:",t),console.error("Available folders:",Object.keys(a.folders)),null;const m=d.length===0;let u="image/file.webp";["png","jpg","jpeg","gif"].includes(o)?u="image/image.webp":["mp4","webm"].includes(o)?u="image/video.webp":["mp3","wav","audio"].includes(o)?u="image/audio.webp":o==="html"?u="image/html.webp":["md","txt"].includes(o)&&(u="image/doc.webp");const f=`file-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,p={id:f,name:e,type:"ugc-file",fullPath:m?`${t}${e}`:`${t}/${e}`,content_type:o,icon:u,contents:n||"",file:i||null};if(i&&["png","jpg","jpeg","gif","webp","avif","mp3","wav","ogg","mp4","webm","avi","mov"].includes(o)){p.isLargeFile=!0,p.storageLocation="indexeddb";const g=URL.createObjectURL(i);p.tempObjectURL=g;const k=new FileReader;k.onload=async function(v){const y=v.target.result,P=y.length*.75/(1024*1024);try{await B.setItem(`file_data_${f}`,y);const T=await Re();let q;m?q=T.folders[l][f]:q=T.folders[t][f],q?(q.isLargeFile=!0,q.storageLocation="indexeddb",q.dataURL=y):(console.error("üéµ ADDFILE: File entry not found after creation:",f),console.error("üéµ ADDFILE: Looking in:",m?l:t),console.error("üéµ ADDFILE: Available keys:",Object.keys(m?T.folders[l]||{}:T.folders[t]||{})))}catch(T){console.error("Failed to store file in IndexedDB:",T);const q=await Re();let z;m?z=q.folders[l][f]:z=q.folders[t][f],z&&(z.isLargeFile=!0,z.storageLocation="failed"),showDialogBox(`File "${e}" could not be stored (${P.toFixed(2)}MB). Storage error: ${T.message}`,"error")}const j=await Re();let K;m?K=j.folders[l][f]:K=j.folders[t][f],K?K.file=null:console.error("üéµ ADDFILE: Could not find file entry to remove File object:",f),ke(j);try{await X()}catch(T){console.error("Failed to save state after file storage:",T)}t==="C://Desktop"&&typeof renderDesktopIcons=="function"?renderDesktopIcons():typeof refreshAllExplorerWindows=="function"&&refreshAllExplorerWindows(t)},k.readAsDataURL(i)}if(c[f]=p,ke(a),!r&&(!i||!["png","jpg","jpeg","gif","webp","avif","mp3","wav","ogg","mp4","webm","avi","mov"].includes(o)))try{await X()}catch(g){console.error("Failed to save state after non-binary file:",g)}return t==="C://Desktop"?typeof renderDesktopIcons=="function"?renderDesktopIcons():typeof window.renderDesktopIcons=="function"?window.renderDesktopIcons():console.warn("renderDesktopIcons function not found"):typeof refreshAllExplorerWindows=="function"?refreshAllExplorerWindows(t):typeof window.refreshAllExplorerWindows=="function"?window.refreshAllExplorerWindows(t):console.warn("refreshAllExplorerWindows function not found"),t==="C://Media"&&["mp3","wav","ogg","audio","mp4","webm","avi","mov"].includes(o)&&typeof window.refreshMediaPlayerPlaylist=="function"&&setTimeout(()=>{window.refreshMediaPlayerPlaylist()},100),p}window.globalAddFileToFileSystem=fo;function Fn(e){if(e.folders||(e.folders={}),e.folders["C://"]&&typeof e.folders["C://"]=="object"){const o=e.folders["C://"];for(const[i,r]of Object.entries(o))if(r&&typeof r=="object"&&r.type==="folder"){const a=`C://${r.name||i}`;e.folders[a]||(e.folders[a]=r.contents||{},r.contents&&Object.values(r.contents).forEach(s=>{s.type==="folder"&&s.fullPath&&t(s.fullPath,s,e)}))}}const n=["C://Desktop","C://Documents","C://Media"];for(const o of n)e.folders[o]||(e.folders[o]={});function t(o,i,r){i.contents&&Object.keys(i.contents).length>0&&(r.folders[o]||(r.folders[o]={}),Object.assign(r.folders[o],i.contents),Object.values(i.contents).forEach(a=>{a.type==="folder"&&a.fullPath&&t(a.fullPath,a,r)}))}return e}async function _n(){on=!0,typeof window<"u"&&(window.isInitializing=!0);try{await B.ensureReady()}catch(n){console.error("Failed to initialize storage:",n)}let e;try{e=await B.getItem("appState")}catch(n){console.error("Failed to load app state from storage:",n),e=null}if(e){const n=e;if(n.fileSystemState&&typeof n.fileSystemState=="object"){const o=Fn(n.fileSystemState);ke(o)}else{console.warn("Invalid fileSystemState in saved data, using default");const o=Fn(je);ke(o)}re=n.windowStates&&typeof n.windowStates=="object"?n.windowStates:{},ge=n.desktopIconsState&&typeof n.desktopIconsState=="object"?n.desktopIconsState:{},Ne=n.navWindows&&typeof n.navWindows=="object"?n.navWindows:{};let t=[];try{const o=await B.getItem("startMenuOrder");o&&Array.isArray(o)?t=o:n.startMenuOrder&&Array.isArray(n.startMenuOrder)&&(t=n.startMenuOrder)}catch(o){console.warn("‚ö† Error loading from direct storage, using appState:",o),t=n.startMenuOrder&&Array.isArray(n.startMenuOrder)?n.startMenuOrder:[]}ae=t,typeof window<"u"&&(window.startMenuOrder=ae),ve={clockSeconds:!1,bgColor:"#20b1b1",bgImage:"",...n.desktopSettings||{}},typeof window<"u"&&typeof window.applyDesktopSettings=="function"&&window.applyDesktopSettings(),setTimeout(async()=>{const o=await Re();if(o&&o.folders&&o.folders["C://Media"]){const i=o.folders["C://Media"];if(i&&!Object.values(i).some(a=>a.name==="too_many_screws_final.mp3")){const a={id:"default-music-file",name:"too_many_screws_final.mp3",type:"ugc-file",fullPath:"C://Media/too_many_screws_final.mp3",content_type:"mp3",icon:"image/audio.webp",contents:"",file:null,isDefault:!0,path:"media/too_many_screws_final.mp3",isSystemFile:!0};o.folders["C://Media"]["default-music-file"]=a,ke(o),await X()}}await rn()},100)}else{ae=[],typeof window<"u"&&(window.startMenuOrder=ae);const t={fileSystemState:Fn(je),windowStates:re,desktopIconsState:ge,desktopSettings:ve,navWindows:Ne};try{await B.setItem("appState",t)}catch(o){console.error("Failed to save initial app state:",o)}setTimeout(async()=>{const o=await Re();if(o.folders["C://Media"]&&!Object.values(o.folders["C://Media"]).some(r=>r.name==="too_many_screws_final.mp3")){const r={id:"default-music-file",name:"too_many_screws_final.mp3",type:"ugc-file",fullPath:"C://Media/too_many_screws_final.mp3",content_type:"mp3",icon:"image/audio.webp",contents:"",file:null,isDefault:!0,path:"media/too_many_screws_final.mp3",isSystemFile:!0};o.folders["C://Media"]["default-music-file"]=r,ke(o),await X()}},100),await rn()}on=!1,typeof window<"u"&&(window.isInitializing=!1)}async function Ka(){const e=await B.getItem("fileSystemState");e&&(je=e)}async function Va(){if(re&&Object.keys(re).length>0){Object.keys(re).forEach(n=>{(/^dialogWindow-/.test(n)||/^promptWindow-/.test(n))&&delete re[n]});const e=Object.entries(re).sort(([,n],[,t])=>(n.zIndex||0)-(t.zIndex||0));for(const[n,t]of e)createWindow(t.title,t.content,t.isNav,t.id,t.isMinimized,!0,t.dimensions,t.windowType,null,t.color||"white",t.zIndex),await er(t.id);if(typeof window.initializeAllLetterPadEditors=="function")try{await window.initializeAllLetterPadEditors()}catch(n){console.warn("Error during global LetterPad initialization:",n)}}}async function er(e){await new Promise(t=>setTimeout(t,50));const n={"storage-window":()=>{typeof nn=="function"?setTimeout(nn,100):console.warn("loadStorageData function not available for storage window restoration")},calculator:()=>{const t=document.getElementById("calculator");if(t){const o=t.querySelector(".p-2");He(o)&&initializeCalculatorUI(t)}},mediaplayer:()=>{const t=document.getElementById("mediaplayer");if(t){const o=t.querySelector(".p-2");He(o)&&initializeMediaPlayerUI(t)}},bombbroomer:()=>{const t=document.getElementById("bombbroomer");if(t){const o=t.querySelector(".p-2");He(o)&&(typeof initializeBombbroomerUI=="function"?initializeBombbroomerUI(t):console.warn("initializeBombbroomerUI function not available"))}},solitaire:()=>{const t=document.getElementById("solitaire");if(t){const o=t.querySelector(".p-2");He(o)&&initializeSolitaireUI(t)}},chess:()=>{const t=document.getElementById("chess");if(t){const o=t.querySelector(".p-2");He(o)&&(typeof initializeChessUI=="function"?initializeChessUI(t):console.warn("initializeChessUI function not available"))}},"compost-bin":()=>{const t=document.getElementById("compost-bin");if(t){const o=t.querySelector(".p-2");if(o&&He(o)){o.innerHTML="",o.className="p-2 bg-gray-100 h-full flex flex-col";const i=document.createElement("div");i.className="h-full flex flex-col";const r=document.createElement("div");r.className="bg-gray-200 border-b border-gray-400 p-2 flex justify-between items-center";const a=document.createElement("div");a.className="text-sm";const d=(ce().folders["C://Desktop"]||{}).compostbin,c=Object.keys((d==null?void 0:d.contents)||{}).length;a.textContent=`Compost Bin - ${c} item(s)`;const m=document.createElement("div");m.className="flex space-x-2";const u=document.createElement("button");u.className="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs",u.textContent="Empty Bin",typeof emptyCompostBin=="function"&&u.addEventListener("click",emptyCompostBin),m.appendChild(u),r.appendChild(a),r.appendChild(m);const f=document.createElement("div");f.className="flex-1 bg-white border border-gray-400 p-2 overflow-auto",f.id="compost-bin-content",typeof loadCompostBinContents=="function"?loadCompostBinContents(f):console.warn("üóëÔ∏è loadCompostBinContents function not available"),i.appendChild(r),i.appendChild(f),o.appendChild(i)}else{const i=t.querySelector("#compost-bin-content");i&&typeof loadCompostBinContents=="function"?(loadCompostBinContents(i),typeof updateCompostBinHeader=="function"&&updateCompostBinHeader(t)):console.warn("Compost bin content area not found or loadCompostBinContents not available")}}else console.warn("üóëÔ∏è Compost bin window not found during restoration")},snake:()=>{const t=document.getElementById("snake");if(t){const o=t.querySelector(".p-2");He(o)&&(typeof initializeSnakeUI=="function"?initializeSnakeUI(t):console.warn("initializeSnakeUI function not available for restoration"))}},pong:()=>{const t=document.getElementById("pong");if(t){const o=t.querySelector(".p-2");He(o)&&(typeof initializePongUI=="function"?initializePongUI(t):console.warn("initializePongUI function not available for restoration"))}},happyturd:()=>{const t=document.getElementById("happyturd");if(t){const o=t.querySelector(".p-2");He(o)&&(typeof initializeHappyTurdUI=="function"?initializeHappyTurdUI(t):console.warn("initializeHappyTurdUI function not available for restoration"))}},watercolour:()=>{const t=document.getElementById("watercolour");if(t){const o=t.querySelector(".p-2");He(o)?initializeWatercolourUI(t):typeof initializeWatercolour=="function"?initializeWatercolour():initializeWatercolourUI(t)}},"keyboard-app":()=>{document.getElementById("keyboard-app")&&(typeof window.initializeKeyboardApp=="function"?window.initializeKeyboardApp("keyboard-app"):console.warn("initializeKeyboardApp function not available for keyboard-app restoration"))},tubestream:()=>{const t=document.getElementById("tubestream");t&&typeof Nn=="function"&&Nn(t)},mailbox:()=>{const t=document.getElementById("mailbox");t&&typeof zn=="function"&&zn(t)},"os-update-window":()=>{typeof Wn=="function"&&Wn()},"explorer-window":()=>{const t=document.getElementById("explorer-window");t&&(typeof initializeFileExplorerUI=="function"?initializeFileExplorerUI(t):typeof restoreFileExplorerState=="function"&&setTimeout(restoreFileExplorerState,100))}};if(n[e])try{n[e]()}catch(t){console.warn(`Failed to initialize restored app ${e}:`,t)}else{const t=document.getElementById(e);if(t){const o=t.querySelector(".letterpad_editor");if(o)try{typeof initializeLetterPad=="function"?await initializeLetterPad(o):console.warn("initializeLetterPad function not available")}catch(i){console.warn(`Failed to initialize LetterPad editor in window ${e}:`,i)}}}}function He(e){if(!e)return!0;const n=e.innerHTML.trim();return!n||n.length<50&&!n.includes("button")&&!n.includes("canvas")&&!n.includes("input")?!0:!e.querySelector('button, canvas, input[type="text"], .game-board, #media-container, #game-grid, #calc-display, #compost-bin-content')}function Xa(e,n){if(typeof n!="function"){console.warn(`Launch function not available for ${e}`);return}const t=document.getElementById(e);if(!t){console.warn(`Window ${e} not found for reinitialization`);return}try{const o=e+"-temp-"+Date.now();t.id=o,n();const i=document.getElementById(e);if(i&&i!==t){const r=t.querySelector(".p-2"),a=i.querySelector(".p-2");r&&a&&(r.innerHTML=a.innerHTML,r.className=a.className),i.remove();const s=document.getElementById("tab-"+e);s&&s.remove(),delete re[e]}t.id=e}catch(o){t&&t.id!==e&&(t.id=e),console.error(`Failed to reinitialize ${e}:`,o)}}function Za(){}async function Ja(){try{await X()}catch(e){console.error("Failed to save state manually:",e)}}function Qa(e){er(e)}function es(e){const n={calculator:launchCalculator,mediaplayer:launchMediaPlayer,bombbroomer:launchBombbroomer,solitaire:launchSolitaire};n[e]?Xa(e,n[e]):console.warn(`No launch function found for ${e}`)}function ts(){const e=document.getElementById("bombbroomer");e&&typeof initializeBombbroomerUI=="function"?initializeBombbroomerUI(e):console.warn("Bombbroomer window not found or function not available")}async function ns(){try{if(await X(),await B.getItem("appState")){const n=await navigator.storage.estimate();return!0}else return console.error("‚úó No data found after save"),!1}catch(e){return console.error("‚úó Data integrity test failed:",e),!1}}async function os(){try{const e=await B.getItem("appState"),n=await B.getItem("explicitRestart");return!!e}catch(e){return console.error("‚úó Session persistence test failed:",e),!1}}async function is(){await B.setItem("explicitRestart",!0)}typeof window<"u"&&(window.debugWindowStates=Za,window.forceSaveState=Ja,window.testAppRestoration=Qa,window.testAppReinitialization=es,window.testBombbroomerInit=ts,window.testDataIntegrity=ns,window.testSessionPersistence=os,window.simulateRestart=is,window.saveState=X,window.getFileSystemState=Re,window.setFileSystemState=ke,window.updateContent=Je);window.addEventListener("beforeunload",async e=>{try{const n={fileSystemState:je,windowStates:re,desktopIconsState:ge,desktopSettings:ve,navWindows:Ne};B.setItemSync("appState",n)}catch(n){console.error("Failed to save state during page unload:",n)}});setInterval(async()=>{try{await X()}catch(e){console.error("Failed to save periodic backup:",e)}},3e4);async function rs(){for(const e in ge){const n=document.getElementById(e);if(n){const t=ge[e];n.style.position="absolute",n.style.left=t.left,n.style.top=t.top}}}Ka().then(()=>{}).catch(console.error);let Ut=null;async function rn(){return Ut||(Ut=(async()=>{try{const e=await fetch("/api/system_manifest.json");if(!e.ok)throw new Error("Manifest fetch failed");const n=await e.json(),t=await B.getItem("systemVersion");if(!t||n.version!==t){console.log("System update detected:",t,"->",n.version);for(const i of n.defaultFiles){const a=(await Re()).folders[i.targetFolder];let s=null;if(a&&(s=Object.keys(a).find(l=>a[l].name===i.name)),s){const l=a[s];if(l.isSystemFile||!l.version||l.version!==i.version){if(["md","txt","html","json"].includes(i.contentType))try{const d=await fetch(i.path);d.ok&&(l.contents=await d.text())}catch{}i.path&&!["md","txt","html","json"].includes(i.contentType)&&(l.path=i.path),l.version=i.version,i.description&&(l.description=i.description),l.isSystemFile=!0}}else{let l="";if(["md","txt","html","json"].includes(i.contentType))try{const c=await fetch(i.path);c.ok&&(l=await c.text())}catch{console.warn("Failed to fetch content for",i.name)}const d=await fo(i.name,l,i.targetFolder,i.contentType,null,!0);d&&(i.path&&!["md","txt","html","json"].includes(i.contentType)&&(d.path=i.path),d.isSystemFile=!0,d.version=i.version,i.description&&(d.description=i.description))}}await B.setItem("systemVersion",n.version),await X()}}catch(e){console.warn("System manifest processing failed:",e)}finally{}})(),Ut)}async function as(){const e={mailbox:!1,tubestream:!1},n=async i=>{const r=new AbortController,a=setTimeout(()=>r.abort(),3e4);try{const s=await fetch(i,{method:"HEAD",signal:r.signal});return s.ok?!0:s.status===405||s.status===404?(await fetch(i,{method:"GET",signal:r.signal})).ok:!1}catch(s){return console.warn(`Probe failed for ${i}:`,s),!1}finally{clearTimeout(a)}},[t,o]=await Promise.all([n(`${Dt}${Yo}`),n(`${Dt}${Go}`)]);return e.mailbox=t,e.tubestream=o,console.log("üîç API Probe Results:",e),e}let ct=new Set;const Ct=[{id:"mycomp",text:"My Computer",icon:"image/computer.webp",type:"item"},{id:"mailboxapp",text:"Mail Box",icon:"image/mail.webp",type:"item"},{id:"mediaapp",text:"Media Player",icon:"image/video.webp",type:"item"},{id:"tubestreamapp",text:"TubeStream",icon:"image/youtube.webp",type:"item"},{id:"watercolourapp",text:"Watercolour",icon:"image/watercolour.webp",type:"item"},{id:"utilities-group",text:"Utilities",type:"group",items:[{id:"letterpad",text:"LetterPad",icon:"image/file.webp"},{id:"calcapp",text:"Calculator",icon:"image/calculator.webp"},{id:"keyboard",text:"Keyboard",icon:"image/keyboard.webp"},{id:"sysset",text:"System Settings",icon:"image/gears.webp"},{id:"storageapp",text:"Storage Manager",icon:"image/drive_c.webp"},{id:"osupdateapp",text:"OS Update",icon:"image/power.webp"},{id:"abtcomp",text:"About This Computer",icon:"image/info.webp"}]},{id:"games-group",text:"Games",type:"group",items:[{id:"solapp",text:"Solitaire",icon:"image/solitaire.webp"},{id:"chessapp",text:"Guillotine Chess",icon:"image/guillotine_chess.webp"},{id:"bombapp",text:"Bombbroomer",icon:"image/bombbroomer.webp"},{id:"pongapp",text:"Pong",icon:"image/pong.webp"},{id:"snakeapp",text:"Snake",icon:"image/snake.webp"},{id:"happyturdapp",text:"Happy Turd",icon:"image/happyturd.webp"}]},{id:"rstrtcomp",text:"Restart",icon:"image/power.webp",type:"item",fixed:!0}];let D={isDragging:!1,draggedElement:null,draggedFromGroup:null,placeholder:null,startY:0,startX:0,draggedItemData:null};function gn(){const e=document.getElementById("start-menu");if(!e){console.error("Start menu container not found");return}const n=typeof ae<"u"?ae:window.startMenuOrder||[];let t=[...Ct];if(n&&n.length>0){const i=[],r=new Set;n.forEach(a=>{if(typeof a=="string"){const s=Ct.find(l=>l.id===a);s&&(i.push(s),r.add(a))}else if(a&&a.type==="group"){let s=Ct.find(l=>l.type==="group"&&(l.id===a.id||l.text===a.name));if(s){const l={...s,items:a.items||s.items};i.push(l),r.add(s.id)}else i.push({id:a.id||`custom-group-${Date.now()}`,text:a.name,type:"group",items:a.items||[]})}}),Ct.forEach(a=>{!r.has(a.id)&&!a.fixed&&i.push(a)}),Ct.forEach(a=>{a.fixed&&i.push(a)}),t=i}const o=document.createElement("ul");if(t.forEach(i=>{if(!ct.has(i.id)){if(i.type==="item"){const r=ss(i);o.appendChild(r)}else if(i.type==="group"){const r=i.items.filter(a=>!ct.has(a.id));if(r.length>0){const a={...i,items:r},s=ls(a);o.appendChild(s)}}}}),e.innerHTML="",e.appendChild(o),typeof window.updateStartMenuFocusability=="function"){const i=!e.classList.contains("hidden");window.updateStartMenuFocusability(i)}}function ss(e){const n=document.createElement("li");return n.id=e.id,n.className=e.fixed?"px-4 py-2 hover:bg-gray-50 cursor-pointer flex items-center relative":"px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center relative",n.setAttribute("role","menuitem"),n.setAttribute("tabindex","-1"),n.setAttribute("aria-label",e.text),n.innerHTML=`
    <img src="${e.icon}" class="h-6 w-6 inline mr-2" alt="${e.text} icon">
    ${e.text}
  `,n.addEventListener("click",t=>{const o=n.querySelector(".start-menu-context-menu");o&&o.style.display!=="none"||mt(e.id)}),n.addEventListener("mouseenter",()=>{var t;(t=window.startMenuKeyboardNavState)!=null&&t.isKeyboardNavigating()&&Un()}),e.fixed||tr(n,e,!1),n}function ls(e){const n=document.createElement("li");n.className="group relative",n.setAttribute("data-group-id",e.id);let t="";e.items.forEach(a=>{t+=`
      <li id="${a.id}" class="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center submenu-item relative" data-submenu-item data-parent-group="${e.id}" role="menuitem" tabindex="-1" aria-label="${a.text}">
        <img src="${a.icon}" class="h-6 w-6 inline mr-2" alt="${a.text} icon">
        ${a.text}
      </li>
    `}),n.innerHTML=`
    <a href="#" data-submenu-trigger class="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center justify-between" role="menuitem" tabindex="-1" aria-label="${e.text}" aria-haspopup="true" aria-expanded="false">
      <div class="flex items-center">
        ${e.text}
      </div>
      <span class="md:rotate-0 text-xs">&#9654;</span>
    </a>
    <ul class="submenu hidden pl-4 bg-gray-100 md:pl-0 md:absolute md:left-full md:bottom-0 md:w-48 md:bg-white md:border md:border-gray-500 md:shadow-lg" data-submenu-container data-group-id="${e.id}" role="menu">
      ${t}
    </ul>
  `,n.querySelectorAll("ul li").forEach((a,s)=>{a.addEventListener("click",d=>{var c;((c=a.querySelector(".start-menu-context-menu"))==null?void 0:c.style.display)==="none"&&mt(a.id)}),a.addEventListener("mouseenter",()=>{var d;(d=window.startMenuKeyboardNavState)!=null&&d.isKeyboardNavigating()&&Un()});const l=e.items[s];l&&tr(a,l,!0,e.id)});const i=n.querySelector("[data-submenu-trigger]"),r=n.querySelector("[data-submenu-container]");if(i&&i.addEventListener("mouseenter",()=>{var a;(a=window.startMenuKeyboardNavState)!=null&&a.isKeyboardNavigating()&&Un()}),i&&r){let a;window.matchMedia("(hover: hover)").matches?(n.addEventListener("mouseenter",()=>{clearTimeout(a),r.classList.remove("hidden"),r.classList.add("block")}),n.addEventListener("mouseleave",()=>{a=setTimeout(()=>{r.classList.add("hidden"),r.classList.remove("block")},100)})):i.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation();const d=!r.classList.contains("hidden");document.querySelectorAll("[data-submenu-container]").forEach(c=>{c!==r&&(c.classList.add("hidden"),c.classList.remove("block"))}),d?(r.classList.add("hidden"),r.classList.remove("block")):(r.classList.remove("hidden"),r.classList.add("block"))})}return n}function mt(e){if(console.log("üîç Start menu item clicked:",e),D.isDragging){console.log("üîç Ignoring click - drag operation in progress");return}if(typeof toggleStartMenu=="function")toggleStartMenu();else{const n=document.getElementById("start-menu");if(n){n.classList.add("hidden"),n.setAttribute("aria-hidden","true"),typeof window.updateStartMenuFocusability=="function"&&window.updateStartMenuFocusability(!1);const t=document.getElementById("start-button");t&&t.setAttribute("aria-expanded","false")}}switch(e){case"mycomp":typeof openExplorer=="function"&&openExplorer("C://");break;case"abtcomp":typeof openAboutWindow=="function"&&openAboutWindow();break;case"sysset":typeof openNav=="function"&&openNav("Settings","",{type:"integer",width:600,height:400},"Settings");break;case"storageapp":typeof openApp=="function"&&openApp("storage");break;case"mailboxapp":typeof openApp=="function"&&openApp("mailbox");break;case"osupdateapp":typeof openApp=="function"&&openApp("osupdate");break;case"watercolourapp":typeof openApp=="function"&&openApp("watercolour");break;case"letterpad":typeof createNewFile=="function"&&createNewFile(null,"C://Documents",n=>{typeof openFile=="function"&&openFile(n,{target:document.body})});break;case"calcapp":typeof openApp=="function"&&openApp("calculator");break;case"keyboard":console.log("üîç Keyboard case triggered, calling openApp"),typeof openApp=="function"&&openApp("keyboard");break;case"solapp":typeof openApp=="function"&&openApp("solitaire");break;case"chessapp":typeof openApp=="function"&&openApp("chess");break;case"bombapp":typeof openApp=="function"&&openApp("bombbroomer");break;case"pongapp":typeof openApp=="function"&&openApp("pong");break;case"snakeapp":typeof openApp=="function"&&openApp("snake");break;case"happyturdapp":typeof openApp=="function"&&openApp("happyturd");break;case"mediaapp":typeof openApp=="function"&&openApp("mediaplayer");break;case"tubestreamapp":typeof openApp=="function"&&openApp("tubestream");break;case"rstrtcomp":typeof tn=="function"&&tn();break;default:console.warn("Unknown start menu item clicked:",e)}}function tr(e,n,t=!1,o=null){let i=!1;const a=!["mycomp","storageapp","sysset"].includes(n.id),s=document.createElement("div");s.className="start-menu-context-menu absolute hidden bg-gray-100 border-r border-t border-b border-gray-500 z-50 w-48",s.style.display="none";let l=`
    <div class="context-menu-item px-4 py-2 hover:bg-gray-50 cursor-pointer select-none flex items-center" data-action="open">
      Open
    </div>
    <div class="context-menu-item px-4 py-2 hover:bg-gray-50 cursor-pointer select-none flex items-center" data-action="shortcut">
      Create shortcut
    </div>`;a&&(l+=`
    <div class="context-menu-item px-4 py-2 hover:bg-gray-50 cursor-pointer select-none flex items-center text-red-600" data-action="uninstall">
      Uninstall
    </div>`),s.innerHTML=l,e.appendChild(s),s.addEventListener("click",p=>{var k;p.stopPropagation();const g=(k=p.target.closest(".context-menu-item"))==null?void 0:k.dataset.action;g&&(cs(g,n,t,o),f(s))});let d;e.addEventListener("mouseenter",()=>{D.isDragging||(clearTimeout(d),d=setTimeout(()=>{!i&&!D.isDragging&&u(s,e)},800))}),e.addEventListener("mouseleave",()=>{clearTimeout(d),setTimeout(()=>{s.matches(":hover")||f(s)},200)}),s.addEventListener("mouseleave",()=>{setTimeout(()=>{e.matches(":hover")||f(s)},200)});let c,m=!1;e.addEventListener("touchstart",p=>{D.isDragging||(m=!1,c=setTimeout(()=>{!m&&!i&&(p.preventDefault(),u(s,e))},500))}),e.addEventListener("touchmove",()=>{m=!0,clearTimeout(c)}),e.addEventListener("touchend",()=>{clearTimeout(c)}),document.addEventListener("click",p=>{!s.contains(p.target)&&!e.contains(p.target)&&f(s)});function u(p,g){document.querySelectorAll(".start-menu-context-menu").forEach(y=>{y!==p&&(y.style.display="none")}),p.style.display="block",p.classList.remove("hidden"),i=!0;const k=g.getBoundingClientRect(),v=p.getBoundingClientRect();p.style.left=`${g.offsetWidth}px`,p.style.top="-1px",document.getElementById("start-menu").getBoundingClientRect(),k.right+v.width>window.innerWidth&&(p.style.left=`-${v.width+5}px`)}function f(p){p.style.display="none",p.classList.add("hidden"),i=!1}}function cs(e,n,t,o){switch(e){case"open":mt(n.id);break;case"shortcut":if(ds(n),typeof toggleStartMenu=="function")toggleStartMenu();else{const i=document.getElementById("start-menu");if(i){i.classList.add("hidden"),i.setAttribute("aria-hidden","true");const r=document.getElementById("start-button");r&&r.setAttribute("aria-expanded","false")}}break;case"uninstall":if(us(n,t,o),typeof toggleStartMenu=="function")toggleStartMenu();else{const i=document.getElementById("start-menu");if(i){i.classList.add("hidden"),i.setAttribute("aria-hidden","true");const r=document.getElementById("start-button");r&&r.setAttribute("aria-expanded","false")}}break}}async function ds(e){try{const n=await getFileSystemState();if(!n.folders["C://Desktop"]){console.error("Desktop folder not found"),typeof showDialogBox=="function"&&showDialogBox("Desktop folder not found","error");return}const t=`shortcut-${e.id}-${Date.now()}`;let o=e.icon||"image/file.webp";const i={id:t,name:e.text,type:"app",fullPath:`C://Desktop/${t}`,content_type:"html",contents:{},icon:o,isShortcut:!0,targetId:e.id};n.folders["C://Desktop"][t]=i,await ke(n),await X(),typeof renderDesktopIcons=="function"?renderDesktopIcons():typeof window.renderDesktopIcons=="function"&&window.renderDesktopIcons()}catch(n){console.error("‚ùå Failed to create desktop shortcut:",n),typeof showDialogBox=="function"&&showDialogBox("Failed to create desktop shortcut","error")}}function us(e,n,t){const o=`Are you sure you want to uninstall "${e.text}" from the Start menu?`;typeof showDialogBox=="function"?showDialogBox(o,"confirmation",()=>{Uo(e,n,t)},()=>{}):confirm(o)&&Uo(e,n,t)}async function Uo(e,n,t){try{let o=[];try{const i=await B.getItem("startMenuOrder");i&&Array.isArray(i)?o=i:o=typeof ae<"u"?ae:window.startMenuOrder||[]}catch{o=typeof ae<"u"?ae:window.startMenuOrder||[]}if(n&&t){const i=o.map(r=>typeof r=="object"&&r.type==="group"&&r.id===t?{...r,items:r.items.filter(a=>a.id!==e.id)}:r);window.startMenuOrder=i,typeof ae<"u"&&(ae=i),await B.setItem("startMenuOrder",i)}else{const i=o.filter(r=>typeof r=="string"?r!==e.id:!0);window.startMenuOrder=i,typeof ae<"u"&&(ae=i),await B.setItem("startMenuOrder",i)}typeof X=="function"&&await X(),gn(),setTimeout(()=>{hn()},50),typeof showDialogBox=="function"&&showDialogBox(`"${e.id}" has been uninstalled from the Start menu`,"info")}catch(o){console.error("‚ùå Failed to uninstall item:",o),typeof showDialogBox=="function"&&showDialogBox("Failed to uninstall item","error")}}function nr(){gn();const e=document.getElementById("start-menu");if(!e)return console.warn("Start menu element not found"),!1;const n=e.querySelectorAll("ul > li:not(.group):not(#rstrtcomp)"),t=e.querySelectorAll(".submenu-item");return n.forEach(o=>{or(o)}),t.forEach(o=>{mo(o)}),ps(),!0}function ps(){const e=document.getElementById("start-menu");e&&(e.addEventListener("dragover",n=>{const t=n.target.closest(".group");if(t&&D.isDragging){const o=t.querySelector("[data-submenu-container]");o&&(o.classList.remove("hidden"),o.classList.add("block"))}}),e.addEventListener("dragleave",n=>{D.isDragging||e.querySelectorAll("[data-submenu-container]").forEach(o=>{o.classList.remove("block")})}))}function mo(e){e.addEventListener("pointerdown",t);function t(r){var c;if(r.button!==0)return;D.startY=r.clientY,D.startX=r.clientX,D.draggedElement=e,D.draggedFromGroup=e.getAttribute("data-parent-group");const a=((c=e.querySelector("img"))==null?void 0:c.src)||"",s=e.cloneNode(!0),l=s.querySelector(".start-menu-context-menu");l&&l.remove();const d=s.textContent.trim();D.draggedItemData={id:e.id,text:d,icon:a,parentGroup:D.draggedFromGroup},document.addEventListener("pointermove",o),document.addEventListener("pointerup",i),document.addEventListener("pointercancel",i),r.preventDefault()}function o(r){if(!r.isPrimary)return;const a=Math.sqrt(Math.pow(r.clientY-D.startY,2)+Math.pow(r.clientX-D.startX,2));!D.isDragging&&a>5&&(D.isDragging=!0,fs(e)),D.isDragging&&ms(r)}function i(r){r.isPrimary&&(document.removeEventListener("pointermove",o),document.removeEventListener("pointerup",i),document.removeEventListener("pointercancel",i),D.isDragging&&gs(),ir())}}function or(e){e.addEventListener("pointerdown",t);function t(r){r.button===0&&(D.startY=r.clientY,D.draggedElement=e,document.addEventListener("pointermove",o),document.addEventListener("pointerup",i),document.addEventListener("pointercancel",i),r.preventDefault())}function o(r){if(!r.isPrimary)return;const a=Math.abs(r.clientY-D.startY);!D.isDragging&&a>5&&(D.isDragging=!0,ys(e)),D.isDragging&&hs(r)}function i(r){r.isPrimary&&(document.removeEventListener("pointermove",o),document.removeEventListener("pointerup",i),document.removeEventListener("pointercancel",i),D.isDragging&&bs(),ir())}}function ir(){D.placeholder&&D.placeholder.remove(),D.draggedElement&&(D.draggedElement.classList.remove("opacity-50","cursor-grabbing"),D.draggedElement.classList.add("cursor-grab")),document.querySelectorAll(".start-menu-context-menu").forEach(e=>{e.style.display="none",e.classList.add("hidden")}),D.isDragging=!1,D.draggedElement=null,D.draggedFromGroup=null,D.placeholder=null,D.startY=0,D.startX=0,D.draggedItemData=null}function fs(e,n){document.querySelectorAll(".start-menu-context-menu").forEach(t=>{t.style.display="none",t.classList.add("hidden")}),e.classList.add("opacity-50","cursor-grabbing"),e.classList.remove("cursor-grab"),D.placeholder=document.createElement("li"),D.placeholder.className="submenu-placeholder h-8 bg-blue-100 border-2 border-dashed border-blue-500 rounded my-0.5 px-4 py-1",D.placeholder.innerHTML='<span class="text-yellow-600 text-sm"></span>',e.parentNode.insertBefore(D.placeholder,e.nextSibling)}function ms(e){if(!D.placeholder||!D.draggedItemData)return;const n=document.getElementById("start-menu"),t=document.elementFromPoint(e.clientX,e.clientY),o=t==null?void 0:t.closest("[data-submenu-container]");t==null||t.closest(".submenu-item");const i=t==null?void 0:t.closest("ul > li:not(.group)");if(o){o.getAttribute("data-group-id");const r=Array.from(o.querySelectorAll(".submenu-item")).filter(l=>l!==D.draggedElement&&!l.classList.contains("submenu-placeholder"));let a=null,s=!0;for(let l=0;l<r.length;l++){const d=r[l],c=d.getBoundingClientRect(),m=c.top+c.height/2;if(e.clientY<m){a=d,s=!0;break}else if(l===r.length-1){a=d,s=!1;break}}a?s?o.insertBefore(D.placeholder,a):o.insertBefore(D.placeholder,a.nextSibling):o.appendChild(D.placeholder)}else if(i&&!i.classList.contains("group")){const r=n.querySelector("ul"),a=Array.from(r.children).filter(d=>d!==D.draggedElement&&!d.classList.contains("start-menu-placeholder")&&!d.classList.contains("group")&&d.id!=="rstrtcomp");D.placeholder.classList.contains("start-menu-placeholder")||(D.placeholder.className="start-menu-placeholder h-10 bg-indigo-100 border-2 border-dashed border-indigo-500 rounded my-0.5",D.placeholder.innerHTML="");let s=null,l=!0;for(let d=0;d<a.length;d++){const c=a[d],m=c.getBoundingClientRect(),u=m.top+m.height/2;if(e.clientY<u){s=c,l=!0;break}else if(d===a.length-1){s=c,l=!1;break}}if(s)l?r.insertBefore(D.placeholder,s):r.insertBefore(D.placeholder,s.nextSibling);else{const d=r.querySelector("#rstrtcomp");d?r.insertBefore(D.placeholder,d):r.appendChild(D.placeholder)}}}function gs(e){if(!D.placeholder||!D.draggedElement||!D.draggedItemData)return;D.draggedElement.classList.remove("opacity-50","cursor-grabbing");const n=D.placeholder.parentNode,t=n.tagName==="UL"&&!n.hasAttribute("data-submenu-container"),o=n.getAttribute("data-group-id");if(t){D.draggedElement.remove();const i=document.createElement("li");i.id=D.draggedItemData.id,i.className="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center",i.innerHTML=`
      <img src="${D.draggedItemData.icon}" class="h-6 w-6 inline mr-2" alt="${D.draggedItemData.text}">
      ${D.draggedItemData.text}
    `,i.addEventListener("click",()=>mt(i.id)),n.insertBefore(i,D.placeholder),D.placeholder.remove(),or(i)}else if(o&&o!==D.draggedFromGroup){D.draggedElement.remove();const i=document.createElement("li");i.id=D.draggedItemData.id,i.className="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center submenu-item",i.setAttribute("data-submenu-item",""),i.setAttribute("data-parent-group",o),i.innerHTML=`
      <img src="${D.draggedItemData.icon}" class="h-6 w-6 inline mr-2" alt="${D.draggedItemData.text}">
      ${D.draggedItemData.text}
    `,i.addEventListener("click",()=>mt(i.id)),n.insertBefore(i,D.placeholder),D.placeholder.remove(),mo(i)}else o===D.draggedFromGroup&&(n.insertBefore(D.draggedElement,D.placeholder),D.placeholder.remove());setTimeout(async()=>{try{await gt()}catch(i){console.error("‚ùå Failed to save submenu changes:",i)}},10)}function ys(e,n){document.querySelectorAll(".start-menu-context-menu").forEach(t=>{t.style.display="none",t.classList.add("hidden")}),e.classList.add("opacity-50","cursor-grabbing"),e.classList.remove("cursor-grab"),D.placeholder=document.createElement("li"),D.placeholder.className="start-menu-placeholder h-10 bg-indigo-100 border-2 border-dashed border-indigo-500 rounded my-0.5",e.parentNode.insertBefore(D.placeholder,e.nextSibling)}function hs(e){if(!D.placeholder)return;const n=document.getElementById("start-menu"),t=document.elementFromPoint(e.clientX,e.clientY),o=t==null?void 0:t.closest("[data-submenu-container]");if(o&&D.draggedElement&&!D.draggedElement.classList.contains("submenu-item")){o.getAttribute("data-group-id");const l=Array.from(o.querySelectorAll(".submenu-item")).filter(m=>!m.classList.contains("submenu-placeholder"));D.placeholder.classList.contains("submenu-placeholder")||(D.placeholder.className="submenu-placeholder h-8 bg-blue-100 border-2 border-dashed border-blue-500 rounded my-0.5 px-4 py-1",D.placeholder.innerHTML='<span class="text-blue-600 text-sm"></span>');let d=null,c=!0;for(let m=0;m<l.length;m++){const u=l[m],f=u.getBoundingClientRect(),p=f.top+f.height/2;if(e.clientY<p){d=u,c=!0;break}else if(m===l.length-1){d=u,c=!1;break}}d?c?o.insertBefore(D.placeholder,d):o.insertBefore(D.placeholder,d.nextSibling):o.appendChild(D.placeholder);return}const i=n.querySelector("ul"),r=Array.from(i.children).filter(l=>l!==D.draggedElement&&!l.classList.contains("start-menu-placeholder")&&!l.classList.contains("group")&&l.id!=="rstrtcomp");D.placeholder.classList.contains("start-menu-placeholder")||(D.placeholder.className="start-menu-placeholder h-10 bg-indigo-100 border-2 border-dashed border-indigo-500 rounded my-0.5",D.placeholder.innerHTML="");let a=null,s=!0;for(let l=0;l<r.length;l++){const d=r[l],c=d.getBoundingClientRect(),m=c.top+c.height/2;if(e.clientY<m){a=d,s=!0;break}else if(l===r.length-1){a=d,s=!1;break}}if(a)s?i.insertBefore(D.placeholder,a):i.insertBefore(D.placeholder,a.nextSibling);else{const l=i.querySelector("#rstrtcomp");l&&i.insertBefore(D.placeholder,l)}}function bs(e){var i;if(!D.placeholder||!D.draggedElement)return;D.draggedElement.classList.remove("opacity-50","cursor-grabbing");const n=D.placeholder.parentNode,t=n.hasAttribute("data-submenu-container"),o=n.getAttribute("data-group-id");if(t){const r=D.draggedElement.cloneNode(!0),a=r.querySelector(".start-menu-context-menu");a&&a.remove();const s={id:D.draggedElement.id,text:r.textContent.trim(),icon:((i=D.draggedElement.querySelector("img"))==null?void 0:i.src)||""};D.draggedElement.remove();const l=document.createElement("li");l.id=s.id,l.className="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center submenu-item",l.setAttribute("data-submenu-item",""),l.setAttribute("data-parent-group",o),l.innerHTML=`
      <img src="${s.icon}" class="h-6 w-6 inline mr-2" alt="${s.text}">
      ${s.text}
    `,l.addEventListener("click",()=>mt(l.id)),n.insertBefore(l,D.placeholder),D.placeholder.remove(),mo(l)}else D.draggedElement.classList.add("cursor-grab"),n.insertBefore(D.draggedElement,D.placeholder),D.placeholder.remove();setTimeout(async()=>{try{await gt()}catch(r){console.error("‚ùå Failed to save start menu order:",r)}},10)}async function gt(){if(typeof window.isInitializing<"u"&&window.isInitializing)return;const n=document.getElementById("start-menu").querySelector("ul"),t=Array.from(n.children),o=[];if(t.forEach(i=>{if(i.id&&!i.classList.contains("group")&&i.id!=="rstrtcomp")o.push(i.id);else if(i.classList.contains("group")){const r=i.getAttribute("data-group-id"),a=i.querySelector("[data-submenu-trigger]"),s=i.querySelector("[data-submenu-container]");if(a&&s&&r){const l=a.cloneNode(!0),d=l.querySelector(".start-menu-context-menu");d&&d.remove();const c=l.textContent.trim(),m=Array.from(s.querySelectorAll(".submenu-item")).map(f=>{var k;const p=f.cloneNode(!0),g=p.querySelector(".start-menu-context-menu");return g&&g.remove(),{id:f.id,text:p.textContent.trim(),icon:((k=f.querySelector("img"))==null?void 0:k.src)||""}}),u={type:"group",id:r,name:c,items:m};o.push(u)}}}),!o||o.length===0){console.warn("Refusing to save empty start menu order - likely a race condition");return}if(typeof window<"u"){window.startMenuOrder=o;try{typeof ae<"u"&&(ae=o)}catch{}}try{await B.setItem("startMenuOrder",o),typeof X=="function"?await X():typeof window.saveState=="function"?await window.saveState():console.warn("‚ö† saveState function not available, only saved directly");try{const i=await B.getItem("startMenuOrder");JSON.stringify(i)===JSON.stringify(o)||console.warn("‚ö† Start menu order mismatch in direct storage after save")}catch(i){console.warn("Could not verify direct save:",i)}}catch(i){console.error("Failed to save start menu order:",i)}}async function yn(){let e=[];try{const n=await B.getItem("startMenuOrder");n&&Array.isArray(n)?e=n:e=typeof ae<"u"?ae:window.startMenuOrder||[]}catch(n){console.warn("‚ö† Failed to load from direct storage, using global variables:",n),e=typeof ae<"u"?ae:window.startMenuOrder||[]}typeof window<"u"&&(window.startMenuOrder=e);try{typeof ae<"u"&&(ae=e)}catch{}gn(),Hn=!1,setTimeout(()=>{hn()},50)}let Hn=!1;document.addEventListener("DOMContentLoaded",()=>{});function hn(){if(Hn)return!0;const e=nr();return e&&(Hn=!0),e}window.initializeStartMenuDragDrop=nr;window.safeInitializeStartMenuDragDrop=hn;window.restoreStartMenuOrder=yn;window.saveStartMenuOrder=gt;window.debugStartMenuState=async function(){const e=document.getElementById("start-menu"),n=e==null?void 0:e.querySelector("ul");Array.from((n==null?void 0:n.children)||[]).map(t=>{var r;const o=t.cloneNode(!0),i=o.querySelector(".start-menu-context-menu");return i&&i.remove(),{id:t.id,text:(r=o.textContent)==null?void 0:r.trim()}});try{const t=await B.getItem("appState")}catch(t){console.error("Error reading from storage:",t)}};window.testSaveStartMenu=function(){gt().catch(e=>{console.error("Test save failed:",e)})};window.testBasicSave=async function(){if(window.startMenuOrder=["test1","test2","test3"],typeof window.saveState=="function")try{await window.saveState();const e=await B.getItem("appState")}catch(e){console.error("‚ùå Basic save failed:",e)}else console.error("‚ùå window.saveState not available")};window.testRealSave=async function(){await gt()};window.testRestore=function(){yn()};async function ws(){try{const e=await as();e.mailbox||ct.add("mailboxapp"),e.tubestream||ct.add("tubestreamapp"),ct.size>0&&(console.log("üîç Hiding unavailable apps:",Array.from(ct)),gn(),setTimeout(()=>{hn()},50))}catch(e){console.error("Failed to initialize API probes:",e)}}function an(){yn(),ws()}window.initializeStartMenu=an;window.testFullStartMenuFlow=async function(){await debugStartMenuState(),an(),await debugStartMenuState(),await testRealSave(),testRestore(),await debugStartMenuState()};window.testStartMenuSave=async function(){const e=["app-calculator","app-chess","app-mediaplayer"];await gt();const n=await B.getItem("startMenuOrder"),t=await B.getItem("appState");return{testOrder:e,directResult:n,appStateResult:t==null?void 0:t.startMenuOrder,globalResult:typeof ae<"u"?ae:null,windowResult:window.startMenuOrder}};window.testStartMenuRestore=async function(){var n;typeof window<"u"&&(window.startMenuOrder=[]);try{typeof ae<"u"&&(ae=[])}catch{console.warn("Could not clear global startMenuOrder")}return await yn(),{globalResult:typeof ae<"u"?ae:null,windowResult:window.startMenuOrder,menuHTML:((n=document.getElementById("start-menu"))==null?void 0:n.innerHTML.substring(0,200))+"..."}};window.debugStorageContents=async function(){try{const e=await B.getItem("appState"),n=await B.getItem("startMenuOrder");return{appState:e,directStartMenu:n,globalStartMenu:typeof ae<"u"?ae:null,windowStartMenu:window.startMenuOrder}}catch(e){return console.error("‚ùå Error debugging storage:",e),{error:e.message}}};function Un(){document.querySelectorAll('#start-menu [role="menuitem"]').forEach(n=>{n.classList.remove("bg-gray-50","focus-visible","keyboard-focused"),n.setAttribute("tabindex","-1"),n.blur()}),window.startMenuKeyboardNavState&&window.startMenuKeyboardNavState.setKeyboardNavigating(!1)}function vs(e,n=!1){var o;const t=document.querySelectorAll('#start-menu [role="menuitem"]');if(t.forEach(i=>{i.classList.remove("bg-gray-50","focus-visible","keyboard-focused"),i.setAttribute("tabindex","-1"),i.hasAttribute("aria-haspopup")&&i.setAttribute("aria-expanded","false")}),document.querySelectorAll("[data-submenu-container]").forEach(i=>{i.classList.add("hidden"),i.classList.remove("block")}),t[e]){const i=t[e];if(i.classList.add("bg-gray-50","focus-visible","keyboard-focused"),i.setAttribute("tabindex","0"),i.focus(),n&&i.hasAttribute("data-submenu-trigger")){const r=i.closest("li"),a=r==null?void 0:r.querySelector("[data-submenu-container]");a&&(a.classList.remove("hidden"),a.classList.add("block"),i.setAttribute("aria-expanded","true"))}if(i.hasAttribute("data-submenu-item")){const r=i.getAttribute("data-parent-group");if(r){const a=document.querySelector(`[data-submenu-container][data-group-id="${r}"]`);if(a){a.classList.remove("hidden"),a.classList.add("block");const s=(o=a.closest("li"))==null?void 0:o.querySelector("[data-submenu-trigger]");s&&s.setAttribute("aria-expanded","true")}}}i.scrollIntoView({behavior:"smooth",block:"nearest"})}}function xs(){let e=0,n=[],t=!1,o=!1;window.startMenuKeyboardNavState={isKeyboardNavigating:()=>o,setKeyboardNavigating:c=>{o=c}};function i(c,m=!1){o=!0,vs(c,m)}document.addEventListener("keydown",function(c){if(c.key==="Meta"||c.key==="OS"){c.preventDefault();const m=document.getElementById("start-menu"),u=document.getElementById("start-button");m&&u&&(m.classList.contains("hidden")?(typeof toggleStartMenu=="function"?toggleStartMenu():(m.classList.remove("hidden"),m.setAttribute("aria-hidden","false"),u.setAttribute("aria-expanded","true"),typeof window.updateStartMenuFocusability=="function"&&window.updateStartMenuFocusability(!0)),setTimeout(l,10)):(typeof toggleStartMenu=="function"?toggleStartMenu():(m.classList.add("hidden"),m.setAttribute("aria-hidden","true"),u.setAttribute("aria-expanded","false"),typeof window.updateStartMenuFocusability=="function"&&window.updateStartMenuFocusability(!1)),u.focus()))}});function r(){return n=Array.from(document.querySelectorAll('#start-menu [role="menuitem"]')),n}function a(){return n.filter(c=>!c.hasAttribute("data-submenu-item"))}function s(c){return n.filter(m=>m.hasAttribute("data-submenu-item")&&m.getAttribute("data-parent-group")===c)}function l(){r(),e=0,t=!1,n.length>0&&i(e)}const d=document.getElementById("start-button");d&&d.addEventListener("click",()=>{setTimeout(l,10)}),document.addEventListener("keydown",function(c){const m=document.getElementById("start-menu");if(!(!m||m.classList.contains("hidden"))&&(r(),n.length!==0))switch(c.key){case"ArrowDown":if(c.preventDefault(),t){const u=n[e],f=u.getAttribute("data-parent-group"),p=s(f),k=(p.indexOf(u)+1)%p.length,v=p[k];e=n.indexOf(v)}else{const u=a(),f=n[e],g=(u.indexOf(f)+1)%u.length,k=u[g];e=n.indexOf(k)}i(e);break;case"ArrowUp":if(c.preventDefault(),t){const u=n[e],f=u.getAttribute("data-parent-group"),p=s(f),k=(p.indexOf(u)-1+p.length)%p.length,v=p[k];e=n.indexOf(v)}else{const u=a(),f=n[e],g=(u.indexOf(f)-1+u.length)%u.length,k=u[g];e=n.indexOf(k)}i(e);break;case"ArrowRight":if(c.preventDefault(),n[e]&&n[e].hasAttribute("data-submenu-trigger")&&n[e].classList.contains("focus-visible")){const u=n[e].closest("li"),f=u==null?void 0:u.querySelector("[data-submenu-container]"),p=f==null?void 0:f.querySelectorAll('[role="menuitem"]');if(p&&p.length>0){for(let g=0;g<n.length;g++)if(p[0]===n[g]){e=g,t=!0,i(e);break}}}break;case"ArrowLeft":if(c.preventDefault(),n[e]&&n[e].hasAttribute("data-submenu-item")){const u=n[e].getAttribute("data-parent-group");if(u)for(let f=0;f<n.length;f++){const p=n[f];if(p.hasAttribute("data-submenu-trigger")){const g=p.closest("li");if((g==null?void 0:g.getAttribute("data-group-id"))===u){e=f,t=!1,i(e,!1);break}}}}break;case"Enter":case" ":c.preventDefault(),n[e]&&n[e].click();break;case"Escape":c.preventDefault(),m&&(m.classList.add("hidden"),m.setAttribute("aria-hidden","true"),d&&(d.setAttribute("aria-expanded","false"),d.focus()));break;case"Home":if(c.preventDefault(),t){const f=n[e].getAttribute("data-parent-group"),p=s(f);if(p.length>0){const g=p[0];e=n.indexOf(g)}}else{const u=a();if(u.length>0){const f=u[0];e=n.indexOf(f)}}i(e);break;case"End":if(c.preventDefault(),t){const f=n[e].getAttribute("data-parent-group"),p=s(f);if(p.length>0){const g=p[p.length-1];e=n.indexOf(g)}}else{const u=a();if(u.length>0){const f=u[u.length-1];e=n.indexOf(f)}}i(e);break}}),r()}function jn(e){const n=document.getElementById("start-menu");if(!n)return;n.querySelectorAll('[role="menuitem"], a[data-submenu-trigger]').forEach(o=>{e?o.setAttribute("tabindex","-1"):(o.setAttribute("tabindex","-1"),o.blur())})}function Wt(){const e=document.getElementById("start-menu"),n=document.getElementById("start-button"),t=e.classList.contains("hidden");e.classList.toggle("hidden"),n.setAttribute("aria-expanded",t?"true":"false"),t?(e.setAttribute("aria-hidden","false"),jn(!0)):(e.setAttribute("aria-hidden","true"),jn(!1)),Ke("start-button"),ks(),e.classList.contains("hidden")||setTimeout(()=>{typeof safeInitializeStartMenuDragDrop=="function"?safeInitializeStartMenuDragDrop():typeof initializeStartMenuDragDrop=="function"?initializeStartMenuDragDrop():console.warn("Start menu drag and drop initialization functions not available")},10)}function bn(){for(const e in re)Ze(e);document.querySelectorAll("#window-tabs > div").forEach(e=>{e.classList.remove("bg-gray-50")})}function wn(e,n="",t={type:"default"},o="default"){if(Ne[e]){const i=document.getElementById(Ne[e]);if(i){Ie(i);return}else delete Ne[e]}se(e,n,!0,null,!1,!1,t,o)}function vn(){const e=document.getElementById("clock"),n=new Date;let t=n.getHours(),o=n.getMinutes(),i=n.getSeconds();t=t<10?"0"+t:t,o=o<10?"0"+o:o,i=i<10?"0"+i:i;let a=typeof ve<"u"&&ve&&ve.clockSeconds||!1?`${t}:${o}:${i}`:`${t}:${o}`;e.textContent=a}function xn(){const e=kn();e&&(e.paused?e.play():e.pause(),go())}function go(){const e=kn(),n=document.getElementById("media-control");e?(n.textContent=e.paused?"‚ñ∂":"‚è∏",n.setAttribute("aria-label",e.paused?"Play media":"Pause media"),n.style.display="inline-block"):(n.textContent="",n.setAttribute("aria-label","No media playing"),n.style.display="none")}function kn(){if(ft){const e=document.getElementById(ft);if(e)return e.querySelector("video, audio")}return null}setInterval(vn,1e3);vn();document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelectorAll("[data-submenu-trigger]");window.innerWidth<1024&&e.forEach(t=>{const o=t.nextElementSibling,i=t.querySelector("span");t.addEventListener("click",r=>{r.preventDefault(),o.classList.contains("hidden")?(o.classList.remove("hidden"),o.classList.add("block"),i.classList.add("rotate-90")):(o.classList.remove("block"),o.classList.add("hidden"),i.classList.remove("rotate-90"))})})});document.getElementById("media-control").addEventListener("click",()=>{xn()});document.getElementById("min-all-btn").addEventListener("click",()=>{Wt(),bn()});document.getElementById("start-button").addEventListener("click",()=>{Wt()});function ks(){const e=document.getElementById("start-button").querySelector("img");e.src.includes("image/door-closed.webp")?e.src=e.src.replace("door-closed","door-open"):e.src=e.src.replace("door-open","door-closed")}const Ss=Object.freeze(Object.defineProperty({__proto__:null,getActiveMediaElement:kn,minimizeAllWindows:bn,openNav:wn,toggleMediaPlayback:xn,toggleStartMenu:Wt,updateClock:vn,updateMediaControl:go,updateStartMenuFocusability:jn},Symbol.toStringTag,{value:"Module"}));async function nt(e){if(e.dataset.initialized==="true")return;e.dataset.initialized="true";try{await B.ensureReady()}catch(z){console.warn("Storage not ready, falling back to sync methods:",z)}const n=e.getAttribute("data-letterpad-editor-id"),t=`letterpad_${n}`;let o=null,i="sans";try{const z=await B.getItem(t);if(z)try{const R=z;o=R.content,i=R.font||"sans"}catch(R){console.error("Error accessing stored markdown data for editor "+n,R)}}catch(z){console.warn("Failed to load LetterPad content for editor "+n+", trying sync method:",z);try{const R=B.getItemSync(t);if(R){const _=R;o=_.content,i=_.font||"sans"}}catch(R){console.warn("Sync fallback also failed:",R)}}const r=document.createElement("div");r.className="flex flex-col h-full w-full border rounded p-2 bg-white";const a=document.createElement("div");a.className="flex flex-wrap gap-2 mb-2";const s=document.createElement("select");s.className="border rounded p-1",s.id="heading-selector",s.setAttribute("aria-label","Select text formatting style"),s.setAttribute("title","Choose the text style (paragraph, heading 1, etc.)"),[{value:"paragraph",text:"Paragraph"},{value:"h1",text:"Heading 1"},{value:"h2",text:"Heading 2"},{value:"h3",text:"Heading 3"}].forEach(z=>{const R=document.createElement("option");R.value=z.value,R.textContent=z.text,s.appendChild(R)}),a.appendChild(s);const d=document.createElement("select");d.className="border rounded p-1",d.id="font-selector",d.setAttribute("aria-label","Select font family"),d.setAttribute("title","Choose the font family for your text"),[{value:"sans",text:"Pixelify Sans"},{value:"serif",text:"Coral Pixels"},{value:"blackletter",text:"Jacquard 12"}].forEach(z=>{const R=document.createElement("option");R.value=z.value,R.textContent=z.text,d.appendChild(R)}),a.appendChild(d),d.value=i;const m=["font-sans","font-serif","font-blackletter"];function u(){m.forEach(z=>v.classList.remove(z)),v.classList.add(`font-${i}`)}function f(z){var ee;q();const R=K.start,_=K.end;if(R===_)return;const Z=v.value,J=Z.substring(R,_),b=Z.substring(0,R),h=Z.substring(_),x=/^\[font=(sans|serif|blackletter)\]/,A="[/font]",W=`[font=${z}]`;let Y=J;const ie=x.test(J),we=J.endsWith(A);if(ie&&we){Y=Y.replace(x,""),Y=Y.slice(0,Y.length-A.length);const he=(ee=J.match(x))==null?void 0:ee[1];if(he&&he!==z){const C=`${W}${Y}${A}`;v.value=b+C+h,v.selectionStart=R+W.length,v.selectionEnd=R+W.length+Y.length;return}else{v.value=b+Y+h,v.selectionStart=R,v.selectionEnd=R+Y.length;return}}const Q=`${W}${Y}${A}`;v.value=b+Q+h,K.start=v.selectionStart=R+W.length,K.end=v.selectionEnd=R+W.length+Y.length}const p=document.createElement("button");p.type="button",p.className="border rounded p-1 hover:bg-gray-200",p.textContent="Bold",p.setAttribute("aria-label","Apply bold formatting"),p.setAttribute("title","Make selected text bold"),a.appendChild(p);const g=document.createElement("button");g.type="button",g.className="border rounded p-1 hover:bg-gray-200",g.textContent="Italic",g.setAttribute("aria-label","Apply italic formatting"),g.setAttribute("title","Make selected text italic"),a.appendChild(g);const k=document.createElement("button");k.type="button",k.className="border rounded p-1 hover:bg-gray-200",k.textContent="Underline",k.setAttribute("aria-label","Apply underline formatting"),k.setAttribute("title","Underline selected text"),a.appendChild(k);const v=document.createElement("textarea");v.className="w-full h-full flex-1 min-h-0 border rounded p-2 resize-none",v.id="markdown-editor",v.setAttribute("aria-label","Markdown text editor"),v.setAttribute("placeholder","Type your text here using Markdown formatting..."),v.setAttribute("title","Enter your text with Markdown formatting"),u();const y=document.createElement("div");y.className="w-full h-full flex-1 min-h-0 border rounded p-2 overflow-auto";const P=document.createElement("button");P.type="button",P.className="border rounded p-1 hover:bg-gray-200 self-end",P.setAttribute("aria-label","Toggle between edit and preview mode"),P.setAttribute("title","Switch between editing and preview modes"),o?P.textContent="Edit":P.textContent="Save & Preview";const j=document.createElement("div");j.className="flex-1 min-h-0 flex flex-col",j.appendChild(v),j.appendChild(y),r.appendChild(a),r.appendChild(j),r.appendChild(P),e.appendChild(r),a.addEventListener("mousedown",z=>{z.target&&z.target.closest("button")&&z.preventDefault()}),d.addEventListener("mousedown",T),s.addEventListener("mousedown",T);let K={start:0,end:0};function T(){K.start=v.selectionStart,K.end=v.selectionEnd}function q(){v.focus(),v.selectionStart=K.start,v.selectionEnd=K.end}["keyup","mouseup","select","input"].forEach(z=>{v.addEventListener(z,T)}),p.addEventListener("click",function(z){z.preventDefault(),q(),Yn("**",v)}),g.addEventListener("click",function(z){z.preventDefault(),q(),Yn("*",v)}),k.addEventListener("click",function(z){z.preventDefault(),q();const R=v.selectionStart,_=v.selectionEnd,Z=v.value.substring(R,_),J=v.value.substring(0,R),b=v.value.substring(_);if(R!==_)if(Z.startsWith("<u>")&&Z.endsWith("</u>")){const h=Z.substring(3,Z.length-4);v.value=J+h+b,v.selectionStart=R,v.selectionEnd=_-7}else{const h=`<u>${Z}</u>`;v.value=J+h+b,v.selectionStart=R,v.selectionEnd=_+7}}),s.addEventListener("change",function(){const z=s.value;q();const R=K.start,_=v.value,Z=_.lastIndexOf(`
`,R-1)+1;let J="";z==="h1"?J="# ":z==="h2"?J="## ":z==="h3"?J="### ":J="";const b=_.indexOf(`
`,R),x=_.substring(Z,b===-1?_.length:b).replace(/^(#{1,6}\s)?/,J);v.value=_.substring(0,Z)+x+_.substring(b===-1?_.length:b)}),o?(v.value=o,y.innerHTML=Xt(o),v.classList.add("hidden"),a.classList.add("hidden"),P.classList.remove("hidden"),y.classList.remove("hidden")):y.classList.add("hidden"),P.addEventListener("click",async function(){if(v.classList.contains("hidden"))y.classList.add("hidden"),v.classList.remove("hidden"),a.classList.remove("hidden"),P.textContent="Preview & Save";else{const z=v.value;y.innerHTML=Xt(z);try{await B.setItem(t,{content:z,font:i})}catch(R){console.warn("Failed to save LetterPad content for editor "+n,R)}v.classList.add("hidden"),y.classList.remove("hidden"),P.textContent="Edit",a.classList.add("hidden")}}),d.addEventListener("change",function(){i=d.value,v.classList.contains("hidden")||(q(),f(i),y.classList.contains("hidden")||(y.innerHTML=Xt(v.value)))})}document.addEventListener("DOMContentLoaded",async function(){try{await B.ensureReady()}catch(t){console.warn("Storage not ready during LetterPad initialization:",t)}const e=document.querySelectorAll(".letterpad_editor");for(const t of e)try{await nt(t)}catch(o){console.error("Error initializing LetterPad editor during DOMContentLoaded:",o)}new MutationObserver(t=>{t.forEach(o=>{o.type==="childList"&&o.addedNodes.forEach(i=>{i.nodeType===Node.ELEMENT_NODE&&(i.classList.contains("letterpad_editor")&&nt(i).catch(r=>{console.error("Error initializing LetterPad editor:",r)}),i.querySelectorAll&&i.querySelectorAll(".letterpad_editor").forEach(r=>{nt(r).catch(a=>{console.error("Error initializing LetterPad editor:",a)})}))})})}).observe(document.body,{childList:!0,subtree:!0})});async function rr(){const e=document.querySelectorAll('.letterpad_editor:not([data-initialized="true"])');for(const n of e)try{await nt(n)}catch(t){console.error("Error initializing LetterPad editor:",t)}}window.initializeAllLetterPadEditors=rr;function Yn(e,n){const t=n.selectionStart,o=n.selectionEnd;if(t===o)return;const i=n.value.substring(t,o),r=n.value.substring(0,t),a=n.value.substring(o),s=e.length,l=i.startsWith(e),d=i.endsWith(e);let c,m=2*s;l&&d?(c=i.slice(s,-s),m=-m):c=e+i+e,n.value=r+c+a,setTimeout(()=>{n.focus(),n.selectionStart=t,n.selectionEnd=o+m},0)}function Xt(e){let n=e;const t=/\[font=(sans|serif|blackletter)\]([\s\S]+?)\[\/font\]/g;return n=n.replace(t,(r,a,s)=>`<span class="font-${a}">${s}</span>`),n=n.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),n=n.replace(/\*(.+?)\*/g,"<em>$1</em>"),n=n.replace(/###### (.*)/g,'<h6 class="mt-1 mb-2 text-2xl">$1</h6>'),n=n.replace(/##### (.*)/g,'<h5 class="mt-1 mb-2 text-3xl">$1</h5>'),n=n.replace(/#### (.*)/g,'<h4 class="mt-1 mb-2 text-4xl">$1</h4>'),n=n.replace(/### (.*)/g,'<h3 class="mt-1 mb-2 text-5xl">$1</h3>'),n=n.replace(/## (.*)/g,'<h2 class="mt-1 mb-2 text-6xl">$1</h2>'),n=n.replace(/# (.*)/g,'<h1 class="mt-1 mb-2 text-7xl">$1</h1>'),n=n.replace(/\n/g,"<br>"),vr(n,["strong","em","h1","h2","h3","h4","h5","h6","br","u","span"],["class"])}document.addEventListener("contextmenu",function(e){let n=e.target.closest(".draggable-icon, .file-item"),t=e.target.closest(".file-explorer-window"),o=e.target.closest("#explorer-window"),i=t||o,r=e.target.closest("#windows-container > div"),a=e.target.closest("#desktop-icons"),l=(e.target.id==="windows-container"||a)&&!r;if(!n&&!i&&!l)return;e.preventDefault();let d;if(t)d=t.getAttribute("data-current-path");else if(o){const c=o.querySelector(".file-explorer-window");d=(c==null?void 0:c.getAttribute("data-current-path"))||"C://"}else l?d="C://Desktop":d="C://";ar(e,n,d)});document.addEventListener("click",function(){$e()});function ar(e,n,t){const o=document.getElementById("context-menu");o.replaceChildren(),o.style.zIndex=Se+100;const i=(a,s,l,d=!1)=>{const c=document.createElement("div");return c.className=`px-4 py-2 relative ${s?"text-gray-400":"hover:bg-gray-50 cursor-pointer"}`,d?c.innerHTML=`${a} <span class="float-right">‚ñ∂</span>`:c.textContent=a,!s&&l&&c.addEventListener("click",l),o.appendChild(c),c},r=(a,s)=>{const l=document.createElement("div");l.className="absolute left-full top-0 bg-white border border-gray-500 shadow-lg hidden min-w-32",l.style.zIndex=Se+101,s.forEach(({text:c,disabled:m,onclick:u})=>{const f=document.createElement("div");f.textContent=c,f.className=`px-4 py-2 ${m?"text-gray-400":"hover:bg-gray-50 cursor-pointer"}`,!m&&u&&f.addEventListener("click",p=>{$e(),u(p)}),l.appendChild(f)}),a.appendChild(l);let d;a.addEventListener("mouseenter",()=>{clearTimeout(d),l.classList.remove("hidden")}),a.addEventListener("mouseleave",()=>{d=setTimeout(()=>{l.classList.add("hidden")},200)}),a.addEventListener("touchstart",c=>{c.preventDefault(),l.classList.contains("hidden")?l.classList.remove("hidden"):l.classList.add("hidden")}),l.addEventListener("mouseenter",()=>{clearTimeout(d)}),l.addEventListener("mouseleave",()=>{d=setTimeout(()=>{l.classList.add("hidden")},200)})};if(n){n.classList.add("right-click-target");const a=n.getAttribute("data-is-vendor-application")==="true",s=n.getAttribute("data-item-id")==="compostbin",l=n.getAttribute("data-item-id");let d=!1;if(l&&!s){const c=ce();if(c&&c.folders){const m=n.closest(".file-explorer-window");let u=t;m&&(u=m.getAttribute("data-current-path"));const f=c.folders[u];f&&f[l]&&(d=f[l].type==="folder")}}s?i("Empty Compost Bin",!1,c=>{c.stopPropagation(),$e(),typeof emptyCompostBin=="function"&&emptyCompostBin()}):(d&&i("Open in new window",!1,c=>{c.stopPropagation(),$e();const m=document.querySelector(".right-click-target");if(m){const u=m.getAttribute("data-item-id");u&&dt(u)}m.classList.remove("right-click-target")}),i("Edit Name",a,c=>Es(c)),i("Delete",a,c=>Cs(c)),i("New Folder",!0),i("New File",!0),i("New Shortcut",!0))}else{i("New Folder",!1,s=>sr(s,t));const a=i("New File",!1,null,!0);r(a,[{text:"LetterPad",disabled:!1,onclick:async s=>await Ms(s,t)},{text:"Image",disabled:!1,onclick:s=>As(s,t)},{text:"Audio",disabled:!1,onclick:s=>Ds(s,t)},{text:"Video",disabled:!1,onclick:s=>Bs(s,t)}]),i("New Shortcut",!1,s=>Ls(s,t))}o.style.top=`${e.clientY}px`,o.style.left=`${e.clientX}px`,o.classList.remove("hidden")}function $e(){document.getElementById("context-menu").classList.add("hidden")}function Es(e,n){e.stopPropagation(),$e();const t=document.querySelector(".right-click-target");if(t.classList.remove("right-click-target"),!t){oe("No item selected.","error");return}const o=t.getAttribute("data-item-id"),i=t.closest(".file-explorer-window");let r;i?r=i.getAttribute("data-current-path"):r=t.getAttribute("data-current-path");let a=ce();if(!a||!a.folders){console.error("File system state not properly initialized:",a),oe("File system not initialized. Please refresh the page.","error");return}let s={};const l=r.length===4;if(s=a.folders[r],!s){console.error("Folder contents not found for path:",r),oe("Folder contents not found.","error");return}if(!(o in s)){oe("Item not found.","error");return}let d=s[o];if(!d){oe("Item not found in file system.","error");return}const c=`window-${Date.now()}`,u=se("Edit Item Name","",!1,c,!1,!1,{type:"integer",width:300,height:150},"Default").querySelector(".p-2");u.classList.add("p-4");const f=document.createElement("form");f.id="edit-name-form",f.className="flex flex-col space-y-4",u.appendChild(f);const p=document.createElement("input");p.type="text",p.name="newName",p.required=!0,p.value=d.name,p.id="rename-input",p.setAttribute("aria-label","Enter new file or folder name"),p.setAttribute("title","Type the new name for this item"),p.className="mt-1 block w-full border border-gray-300 rounded p-2",f.appendChild(sn("New Name",p));const g=document.createElement("div");g.className="flex justify-end space-x-2",f.appendChild(g);const k=de("Cancel"),v=de("Submit");k.id="cancel-edit-button",v.id="submit-edit-button",g.append(k,v),k.addEventListener("click",()=>le(c)),v.addEventListener("click",()=>Ke("submit-edit-button","Editing..."));const y=document.getElementById("edit-name-form");y.addEventListener("submit",function(j){j.preventDefault();const K=y.newName.value.trim();if(K&&K!==d.name){if(d.type==="folder"&&d.fullPath){let _=function(Z,J){if(a.folders[Z]){a.folders[J]=a.folders[Z],delete a.folders[Z];for(const b in a.folders[J]){const h=a.folders[J][b];if(h.type==="folder"&&h.fullPath&&h.fullPath.startsWith(Z)){const x=h.fullPath,A=h.fullPath.replace(Z,J);h.fullPath=A,a.folders[x]&&_(x,A)}}}};var T=_;const q=/^[A-Z]:\/\/$/;let z;q.test(r)?z=r+K:z=r+"/"+K;const R=d.fullPath;d.fullPath=z,_(R,z)}d.name=K,r==="C://Desktop"?typeof be=="function"?be():console.error("renderDesktopIcons function not available"):typeof Ee=="function"?Ee(r):console.error("refreshAllExplorerWindows function not available"),setFileSystemState(a),X().catch(q=>{console.error("Failed to save state after renaming:",q)}),setTimeout(()=>{r==="C://Desktop"&&typeof be=="function"?be():typeof Ee=="function"&&Ee(r)},100)}le(c)}),document.getElementById("cancel-edit-button").addEventListener("click",function(){le(c)})}function Cs(e){e.stopPropagation(),$e();const n=document.querySelector(".right-click-target");if(n&&n.classList.remove("right-click-target"),!n){oe("No file selected.","error");return}const t=n.getAttribute("data-item-id"),o=n.closest(".file-explorer-window"),i=o?o.getAttribute("data-current-path"):n.getAttribute("data-current-path"),r=ce();if(!r||!r.folders){console.error("File system state not properly initialized:",r),oe("File system not initialized. Please refresh the page.","error");return}let a=r.folders[i];if(!a){console.error("Folder contents not found for path:",i),console.error("Available folders:",Object.keys(r.folders)),oe("Folder not found in file system.","error");return}if(!(t in a)){console.error("Item not found in folder:",t,"at path:",i),console.error("Available items:",Object.keys(a)),oe("Item not found.","error");return}const s=`window-${Date.now()}`,d=se("Delete File?","",!1,s,!1,!1,{type:"integer",width:320,height:140},"Default").querySelector(".p-2");d.classList.add("p-4","flex","flex-col","justify-between","h-full");const c=document.createElement("p");c.textContent="Are you sure you want to delete this file?",d.appendChild(c);const m=document.createElement("div");m.className="flex justify-end space-x-2",d.appendChild(m);const u=de("Cancel"),f=de("Delete");m.append(u,f),u.addEventListener("click",()=>le(s)),f.addEventListener("click",async()=>{const p=a[t],g=p&&p.content_type&&["mp3","wav","ogg","audio"].includes(p.content_type),k=i==="C://Media";if(i==="C://Desktop"){const v="icon-"+t;desktopIconsState[v]&&delete desktopIconsState[v]}delete a[t],r.folders[i]=a,await Pn(r),Ee(i),i==="C://Desktop"&&be(),g&&k&&typeof window.refreshMediaPlayerPlaylist=="function"&&setTimeout(()=>{window.refreshMediaPlayerPlaylist()},100),le(s)})}function sr(e,n){e.stopPropagation(),$e();const t=n||"C://";Xn("Enter the name for the new folder:","New Folder",async o=>{(!o||!o.trim())&&(o="Untitled"),o=o.trim();let i=ce();if(!i||!i.folders){console.error("File system state not properly initialized:",i),oe("File system not initialized. Please refresh the page.","error");return}const r="folder-"+Date.now(),a=/^[A-Z]:\/\/$/;let s=a.test(t)?t+o:t+"/"+o;const l={id:r,name:o,type:"folder",fullPath:s,contents:{}};let d;a.test(n)?(d=i.folders[n],d||(i.folders[n]={},d=i.folders[n])):n==="C://Desktop"?(i.folders["C://Desktop"]||(i.folders["C://Desktop"]={}),d=i.folders["C://Desktop"]):(d=i.folders[n],d||(console.warn("Parent folder contents not found, creating:",n),i.folders[n]={},d=i.folders[n])),d[r]=l,i.folders[s]={},await setFileSystemState(i);try{await X(),n==="C://Desktop"?typeof be=="function"&&be():typeof Ee=="function"&&Ee(t)}catch(c){console.error("Failed to save state after creating folder:",c)}},()=>{})}function Is(e,n,t=null){e&&e.stopPropagation(),$e();const o=n||"C://",i=`window-${Date.now()}`,a=se("New File","",!1,i,!1,!1,{type:"integer",width:300,height:150},"Default").querySelector(".p-2");a.classList.add("p-4");const s=document.createElement("form");s.id="create-file-form",s.className="flex flex-col space-y-4",a.appendChild(s);const l=document.createElement("input");l.type="text",l.name="fileName",l.required=!0,l.value="New File.rtf",l.id="create-file-name",l.setAttribute("aria-label","Enter file name"),l.setAttribute("title","Enter the name for the new file"),l.className="mt-1 block w-full border border-gray-300 rounded p-2",s.appendChild(sn("File Name",l));const d=document.createElement("div");d.className="flex justify-end space-x-2",s.appendChild(d);const c=de("Cancel");c.id="cancel-file-button";const m=de("Submit");m.id="submit-file-button",d.append(c,m),c.addEventListener("click",u=>{u.preventDefault(),Ke("cancel-file-button","Cancelling..."),setTimeout(()=>le(i),100)}),s.addEventListener("submit",u=>{u.preventDefault(),Ke("submit-file-button","Submitting..."),setTimeout(()=>le(i),100);const f=l.value.trim()||"Untitled",p={id:`file-${Date.now()}`,name:f,type:"ugc-file",content:"",content_type:"markdown",icon_url:"image/doc.webp",description:""};Sn(p,o)&&(n==="C://Desktop"?be():Ee(o),X().catch(g=>{console.error("Failed to save state after creating file:",g)}),typeof t=="function"&&t(p.id,p))})}function Ls(e,n){e.stopPropagation(),$e();const t=`window-${Date.now()}`,i=se("New Shortcut","",!1,t,!1,!1,{type:"integer",width:300,height:200},"Default").querySelector(".p-2");i.classList.add("p-4");const r=document.createElement("form");r.id="create-shortcut-form",r.className="flex flex-col space-y-4",i.appendChild(r);const a=document.createElement("input");a.type="text",a.name="shortcutName",a.placeholder="Example Website",a.id="shortcut-name",a.setAttribute("aria-label","Enter shortcut name"),a.setAttribute("title","Enter a display name for the shortcut"),a.className="mt-1 block w-full border border-gray-300 rounded p-2",r.appendChild(sn("Shortcut Name",a));const s=document.createElement("input");s.type="url",s.name="shortcutURL",s.required=!0,s.placeholder="https://example.com",s.id="shortcut-url",s.setAttribute("aria-label","Enter website URL"),s.setAttribute("title","Enter the full URL of the website"),s.className="mt-1 block w-full border border-gray-300 rounded p-2",r.appendChild(sn("Shortcut URL",s));const l=document.createElement("div");l.className="flex justify-end space-x-2";const d=de("Cancel");d.id="cancel-shortcut-button";const c=de("Submit");c.id="submit-shortcut-button",l.append(d,c),r.appendChild(l),d.addEventListener("click",()=>{e.preventDefault(),Ke("cancel-shortcut-button","Cancelling..."),setTimeout(()=>le(t),100)}),r.addEventListener("submit",async m=>{m.preventDefault(),Ke("submit-shortcut-button","Submitting..."),setTimeout(()=>le(t),100);const u=s.value.trim();if(!u)return;const f=a.value.trim()||u.replace(u.substring(15),"‚Ä¶"),p=`shortcut-${Date.now()}`;let g="https://www.google.com/s2/favicons?sz=64&domain=";try{g+=new URL(u).hostname}catch{g="image/doc.webp"}const k={id:p,name:f,type:"shortcut",url:u,icon_url:g,description:"",fullPath:n==="C://Desktop"?`C://Desktop/${f}`:`${n}/${f}`};if(!await Sn(k,n)){console.error("Failed to save shortcut to filesystem");return}n==="C://Desktop"?setTimeout(async()=>{await be()},100):Qe(),Pe();try{await X()}catch(y){console.error("Failed to save state after creating shortcut:",y)}})}async function Ms(e,n,t=null){e&&e.stopPropagation(),$e();const o=n||"C://";Xn("Enter the name for the new LetterPad document:","New LetterPad.md",async i=>{(!i||!i.trim())&&(i="New LetterPad.md"),i=i.trim(),i.endsWith(".md")||(i=i+".md");const r=`file-${Date.now()}`,a="",s={id:r,name:i,type:"ugc-file",content:a,content_type:"markdown",icon_url:"image/doc.webp"};if(await Sn(s,o)){try{await X()}catch(l){console.error("Failed to save state after creating LetterPad:",l)}n==="C://Desktop"?be():Ee(o),se(i,`<div class="letterpad_editor min-h-48 h-full w-full" data-letterpad-editor-id="${r}"></div>`,!1,r,!1,!1,{type:"integer",width:600,height:500},"editor"),setTimeout(()=>{const l=`letterpad_${r}`;B.setItemSync(l,{content:a});const d=document.querySelector(`[data-letterpad-editor-id="${r}"]`);d&&typeof nt=="function"&&nt(d)},100),typeof t=="function"&&t(s.id,s)}},()=>{})}function As(e,n,t=null){e&&e.stopPropagation(),$e();const o=n||"C://",i=document.createElement("input");i.type="file",i.accept="image/*",i.setAttribute("aria-label","Select image file to upload"),i.setAttribute("title","Choose an image file from your computer"),i.style.display="none",i.addEventListener("change",async r=>{const a=r.target.files[0];if(a){const l=a.size/1048576;if(l>25){oe(`Image file "${a.name}" is too large (${l.toFixed(2)}MB). Maximum allowed size is 25MB.`,"error"),document.body.removeChild(i);return}const d=a.name.split(".").pop().toLowerCase(),c=await yo(a.name,o,d,a);c&&typeof t=="function"&&t(c.id,c),n==="C://Desktop"?typeof be=="function"&&be():typeof Ee=="function"&&Ee(o)}document.body.removeChild(i)}),document.body.appendChild(i),i.click()}function Ds(e,n,t=null){e&&e.stopPropagation(),$e();const o=n||"C://",i=document.createElement("input");i.type="file",i.accept="audio/*",i.style.display="none",i.setAttribute("aria-label","Select audio file to upload"),i.setAttribute("title","Choose an audio file from your computer"),i.addEventListener("change",async r=>{const a=r.target.files[0];if(a){const l=a.size/1048576;if(l>50){oe(`Audio file "${a.name}" is too large (${l.toFixed(2)}MB). Maximum allowed size is 50MB.`,"error"),document.body.removeChild(i);return}const d=a.name.split(".").pop().toLowerCase(),c=await yo(a.name,o,d,a);c&&typeof t=="function"&&t(c.id,c),n==="C://Desktop"?typeof be=="function"&&be():typeof Ee=="function"&&Ee(o)}document.body.removeChild(i)}),document.body.appendChild(i),i.click()}function Bs(e,n,t=null){e&&e.stopPropagation(),$e();const o=n||"C://",i=document.createElement("input");i.type="file",i.accept="video/*",i.style.display="none",i.setAttribute("aria-label","Select video file to upload"),i.setAttribute("title","Choose a video file from your computer"),i.addEventListener("change",async r=>{const a=r.target.files[0];if(a){const l=a.size/1048576;if(l>100){oe(`Video file "${a.name}" is too large (${l.toFixed(2)}MB). Maximum allowed size is 100MB.`,"error"),document.body.removeChild(i);return}const d=a.name.split(".").pop().toLowerCase(),c=await yo(a.name,o,d,a);c&&typeof t=="function"&&t(c.id,c),n==="C://Desktop"?typeof be=="function"&&be():typeof Ee=="function"&&Ee(o)}document.body.removeChild(i)}),document.body.appendChild(i),i.click()}function sn(e,n){const t=document.createElement("div"),o=document.createElement("label");return o.className="block text-sm font-medium text-gray-700",o.textContent=e,t.append(o,n),t}function Ee(e){const n=document.querySelectorAll(".file-explorer-window");let t=0;n.forEach((o,i)=>{if(o.getAttribute("data-current-path")===e)try{const a=et(e),s=document.createElement("div");s.innerHTML=a;const l=s.querySelector(".file-explorer-window");if(l){o.innerHTML=l.innerHTML,o.setAttribute("data-current-path",e);const d=o.closest(".window");d&&d.id&&Je(d.id,a),t++}else console.warn(`Failed to get new explorer content for window ${i}`)}catch(a){console.error(`Error refreshing window ${i}:`,a)}}),setTimeout(()=>{typeof Pe=="function"&&Pe()},50)}window.refreshAllExplorerWindows=Ee;async function Sn(e,n){const t=ce();if(!t||!t.folders)return console.error("File system state not properly initialized:",t),oe("File system not initialized. Please refresh the page.","error"),!1;let o=t.folders[n];return o||(console.warn("Parent folder contents not found, creating:",n),t.folders[n]={},o=t.folders[n]),o[e.id]=e,await setFileSystemState(t),ce().folders[n],!0}async function yo(e,n,t,o){const i=`file-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;let r="image/file.webp";["png","jpg","jpeg","gif","webp","avif"].includes(t)?r="image/image.webp":["mp4","webm","avi","mov"].includes(t)?r="image/video.webp":["mp3","wav","ogg"].includes(t)&&(r="image/audio.webp");const a={id:i,name:e,type:"ugc-file",content_type:t,icon_url:r,content:"",isLargeFile:!0,storageLocation:"indexeddb",file:null};if(!Sn(a,n))return null;if(o&&["png","jpg","jpeg","gif","webp","avif","mp3","wav","ogg","mp4","webm","avi","mov"].includes(t)){const s=URL.createObjectURL(o),l=ce(),d=l.folders[n];d&&d[i]&&(d[i].tempObjectURL=s,d[i].file=o,setFileSystemState(l));try{const c=await new Promise((p,g)=>{const k=new FileReader;k.onload=v=>p(v.target.result),k.onerror=g,k.readAsDataURL(o)}),m=c.length*.75/(1024*1024);await B.setItem(`file_data_${i}`,c);const u=ce(),f=u.folders[n];f&&f[i]&&(f[i].isLargeFile=!0,f[i].storageLocation="indexeddb",f[i].content="",f[i].fileSizeInMB=m,f[i].actualSizeInMB=m,f[i].dataURL=c,f[i].file=null),setFileSystemState(u),await X(),n==="C://Media"&&["mp3","wav","ogg","mp4","webm","avi","mov"].includes(t)&&typeof window.refreshMediaPlayerPlaylist=="function"&&setTimeout(()=>{window.refreshMediaPlayerPlaylist()},200)}catch(c){console.error("Failed to store binary file:",c);const m=ce(),u=m.folders[n];u&&u[i]&&(u[i].isLargeFile=!0,u[i].storageLocation="failed",setFileSystemState(m)),oe(`File "${e}" could not be stored. Storage error: ${c.message}`,"error")}}else await X();return a}async function Ts(){const e=window.location.href.includes("reddit.com");let n="1.0.0";try{n=(await(await fetch("./package.json")).json()).version||"1.0.0"}catch(o){console.warn("Could not fetch version from package.json:",o)}const t=`
    <div class="p-4 gap-y-2 flex flex-col">
      <img src="./image/logo.webp" class="w-48 h-auto mx-auto mb-4" alt="Nostalgia OS startup logo">
      <h1 class="text-xl font-bold mb-2">About This Computer</h1>
      <p>Made by multimedia artist Ian McKenzie.</p>
      <p>More shenanigans @ ${e?"relentlesscurious.com":'<a href="https://www.relentlesscurious.com" target="_blank">relentlesscurious.com</a>'}</p>
      <p>Version: ${n}</p>
      <p>Copyright ¬© Ian Rand McKenzie, 2025</p>
      <p>This project must be purchased for use, but is open source and free for those who contribute via code, security research, bug reporting, etc. ‚Äî contributors may do so on <a target="_blank" href="https://github.com/ianrandmckenzie/nostalgia_os">github.com/ianrandmckenzie/nostalgia_os</a></p>
    </div>
  `;se("About This Computer",t,!1,null,!1,!1,{type:"integer",width:400,height:640},"default",null,"gray-200")}const lr=`
<div class="max-w-4xl mx-auto text-black font-mono bg-gray-50 p-6 h-full overflow-auto">
  <h1 class="text-3xl font-bold text-black mb-6">Security Policy</h1>

  <div class="bg-gray-100 rounded-lg p-4 mb-6 border border-gray-700">
    <p class="text-lg text-black mb-4">
      At relentlessCurious, we take security seriously. This policy outlines our commitment to maintaining a secure environment for our users and provides guidelines for responsible disclosure of security vulnerabilities.
    </p>
  </div>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Reporting Security Vulnerabilities</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black mb-3">
        If you discover a security vulnerability in our systems, please report it responsibly by contacting our developer, Ian, at:
      </p>
      <div class="bg-gray-200 rounded p-3 border border-gray-600 mb-3">
        <p class="text-black font-mono">hey@relentlesscurious.com</p>
      </div>
      <p class="text-black mb-3">
        Please include the following information in your report:
      </p>
      <ul class="list-disc list-inside text-black space-y-1 ml-4">
        <li>Description of the vulnerability</li>
        <li>Steps to reproduce the issue</li>
        <li>Potential impact assessment</li>
        <li>Suggested remediation (if applicable)</li>
        <li>Your contact information for follow-up</li>
      </ul>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Response Timeline</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="bg-gray-200 rounded p-3 border border-gray-600">
          <h3 class="text-lg font-semibold text-black mb-2">Initial Response</h3>
          <p class="text-black">Within 48 hours of receiving your report</p>
        </div>
        <div class="bg-gray-200 rounded p-3 border border-gray-600">
          <h3 class="text-lg font-semibold text-black mb-2">Investigation</h3>
          <p class="text-black">Within 7 days for initial assessment</p>
        </div>
        <div class="bg-gray-200 rounded p-3 border border-gray-600">
          <h3 class="text-lg font-semibold text-black mb-2">Resolution</h3>
          <p class="text-black">Timeline varies based on severity</p>
        </div>
        <div class="bg-gray-200 rounded p-3 border border-gray-600">
          <h3 class="text-lg font-semibold text-black mb-2">Disclosure</h3>
          <p class="text-black">After fix is deployed and verified</p>
        </div>
      </div>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Scope</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <h3 class="text-lg font-semibold text-black mb-2">In Scope</h3>
      <ul class="list-disc list-inside text-black space-y-1 mb-3 ml-4">
        <li>relentlessCurious.com and all subdomains</li>
        <li>Web applications and APIs</li>
        <li>Smart contracts (when deployed)</li>
        <li>Infrastructure vulnerabilities</li>
        <li>Social engineering vulnerabilities</li>
      </ul>

      <h3 class="text-lg font-semibold text-black mb-2">Out of Scope</h3>
      <ul class="list-disc list-inside text-black space-y-1 ml-4">
        <li>Third-party services we don't control</li>
        <li>Social media accounts</li>
        <li>Physical security issues</li>
        <li>Denial of Service (DoS) attacks</li>
        <li>Spam or social engineering attacks</li>
      </ul>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Responsible Disclosure Guidelines</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black mb-3">We ask that security researchers:</p>
      <ul class="list-disc list-inside text-black space-y-1 ml-4">
        <li>Allow us reasonable time to investigate and address the issue before public disclosure</li>
        <li>Avoid accessing, modifying, or deleting user data</li>
        <li>Do not perform testing that could degrade or damage our systems</li>
        <li>Do not use social engineering, phishing, or physical attacks</li>
        <li>Make a good faith effort to avoid privacy violations and data destruction</li>
        <li>Contact us immediately if you inadvertently access sensitive data</li>
      </ul>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Security Measures</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black mb-3">Our security implementation includes:</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="space-y-2">
          <h3 class="text-lg font-semibold text-black">Web Security</h3>
          <ul class="list-disc list-inside text-black text-sm space-y-1 ml-4">
            <li>Content Security Policy (CSP)</li>
            <li>HTTP Strict Transport Security (HSTS)</li>
            <li>Input validation and sanitization</li>
          </ul>
        </div>
        <div class="space-y-2">
          <h3 class="text-lg font-semibold text-black">Data Protection</h3>
          <ul class="list-disc list-inside text-black text-sm space-y-1 ml-4">
            <li>Encryption in transit and at rest</li>
            <li>Regular security audits</li>
            <li>Access controls and monitoring</li>
            <li>Secure development practices</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Recognition</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black mb-3">
        We appreciate the security research community's efforts in keeping our platform secure. Researchers who responsibly disclose valid security vulnerabilities may be:
      </p>
      <ul class="list-disc list-inside text-black space-y-1 ml-4">
        <li>Acknowledged in our security advisory (with permission)</li>
        <li>Listed in our hall of fame</li>
        <li>Considered for our bug bounty program (when available)</li>
      </ul>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Legal Safe Harbor</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black">
        relentlessCurious will not pursue legal action against security researchers who:
      </p>
      <ul class="list-disc list-inside text-black space-y-1 mt-3 ml-4">
        <li>Follow our responsible disclosure policy</li>
        <li>Report vulnerabilities in good faith</li>
        <li>Do not violate any applicable laws</li>
        <li>Do not access, modify, or delete user data</li>
        <li>Do not disrupt our services</li>
      </ul>
    </div>
  </section>

  <footer class="mt-8 pt-6 border-t border-gray-700">
    <div class="text-center">
      <p class="text-black text-sm">
        Last updated: July 15, 2025
      </p>
      <p class="text-black text-sm mt-2">
        This policy is subject to change. Check back regularly for updates.
      </p>
    </div>
  </footer>
</div>
`,Fs={"/security-policy":{title:"Security Policy",content:lr,icon:"image/info.webp"}};function $s(){wn("Security Policy",lr,{type:"integer",width:800,height:600},"default")}function ho(e){const n=Fs[e];return n?(wn(n.title,n.content,{type:"integer",width:800,height:600},"default"),!0):!1}function cr(){const e=window.location.pathname;e==="/security-policy"&&setTimeout(()=>{ho(e),window.history.replaceState({},"","/")},500)}window.addEventListener("popstate",function(e){const n=window.location.pathname;ho(n)||console.log("No route found for:",n)});const dr=1180,Gn=820;let Ce={x:0,y:0},ot=new Map,bo=!1,We;function Kn(){We&&(We.style.transform=`translate(${Ce.x}px, ${Ce.y}px)`)}function ur(){if(!We)return;const e=window.innerWidth,n=window.innerHeight-40,t=Math.max(dr,e),o=Math.max(Gn,n),i=0,r=0,a=Math.min(0,e-t),s=Math.min(0,n-o);Ce.x>i&&(Ce.x=i),Ce.y>r&&(Ce.y=r),Ce.x<a&&(Ce.x=a),Ce.y<s&&(Ce.y=s)}function Ps(e){if(We.contains(e.target)){for(const n of e.changedTouches)ot.set(n.identifier,{x:n.clientX,y:n.clientY});ot.size===2&&Array.from(e.touches).every(t=>{var a;const o=document.elementFromPoint(t.clientX,t.clientY);if(!o)return!1;const i=o.closest("#windows-container > div");if(!i)return!0;const r=(a=window.windowStates)==null?void 0:a[i.id];return!i.hasAttribute("data-disable-desktop-pan")&&(!r||!r.fullScreen)})&&(bo=!0,e.preventDefault())}}function zs(e){if(!bo)return;if(e.touches.length!==2)return pr();const n=Array.from(e.touches).map(d=>({x:d.clientX,y:d.clientY})),t=(n[0].x+n[1].x)/2,o=(n[0].y+n[1].y)/2,i=Array.from(ot.values());if(i.length<2)return;const r=(i[0].x+i[1].x)/2,a=(i[0].y+i[1].y)/2,s=t-r,l=o-a;Ce.x+=s,Ce.y+=l,ur(),Kn(),ot.clear();for(const d of e.touches)ot.set(d.identifier,{x:d.clientX,y:d.clientY});e.preventDefault()}function jo(e){for(const n of e.changedTouches)ot.delete(n.identifier);ot.size<2&&pr()}function pr(){bo=!1}function Ns(){document.addEventListener("touchstart",e=>{var c;const n=e.target.closest(".cursor-move");if(!n)return;const t=n.closest("#windows-container > div");if(!t)return;const o=(c=window.windowStates)==null?void 0:c[t.id];if(o!=null&&o.fullScreen||e.touches.length!==1)return;const i=e.touches[0],r=t.getBoundingClientRect(),a=i.clientX-r.left,s=i.clientY-r.top;function l(m){if(m.touches.length!==1)return;const u=m.touches[0],f=-Ce.x,p=-Ce.y;t.style.left=u.clientX+f-a+"px",t.style.top=u.clientY+p-s+"px",m.preventDefault()}function d(m){var f;window.removeEventListener("touchmove",l,{passive:!1}),window.removeEventListener("touchend",d);const u=(f=window.windowStates)==null?void 0:f[t.id];u&&(u.position={left:t.style.left,top:t.style.top},window.saveState&&window.saveState())}window.addEventListener("touchmove",l,{passive:!1}),window.addEventListener("touchend",d,{passive:!1})},{passive:!0})}function fr(){if(We=document.getElementById("desktop-stage"),document.getElementById("windows-container"),!We)return;We.style.minWidth=dr+"px",We.style.minHeight=Gn+"px";const e=window.innerHeight-40,n=Math.max(Gn,e);Ce.x=0,Ce.y=Math.min(0,e-n),Kn(),We.addEventListener("touchstart",Ps,{passive:!1}),We.addEventListener("touchmove",zs,{passive:!1}),We.addEventListener("touchend",jo,{passive:!1}),We.addEventListener("touchcancel",jo,{passive:!1}),Ns(),window.addEventListener("resize",()=>{ur(),Kn()})}typeof window<"u"&&(window.initializeDesktopPan=fr);window.isDevvit=!1;const Zt="1.0";Yi();async function Ws(){var n;await((n=B.ensureReady)==null?void 0:n.call(B))||Promise.resolve();let e=await B.getItem("version");if(e||await B.setItem("version",Zt),e!==Zt){const t=await B.getItem("explicitRestart");await B.removeItem("appState"),await B.removeItem("version"),await B.setItem("version",Zt),t&&await B.setItem("explicitRestart",t)}}typeof window<"u"&&(window.version=Zt,window.highestZ=Se,window.activeMediaWindow=ft,window.windowStates=re,window.desktopIconsState=ge,window.navWindows=Ne,window.desktopSettings=ve,window.startMenuOrder=ae,window.fileFolderMapping=Ji,window.createWindow=se,window.minimizeWindow=Ze,window.bringToFront=Ie,window.closeWindow=le,window.toggleFullScreen=$t,window.showDialogBox=oe,window.getAppIcon=uo,window.renderDesktopIcons=be,window.makeIconDraggable=pn,window.toggleStartMenu=Wt,window.minimizeAllWindows=bn,window.openNav=wn,window.updateClock=vn,window.toggleMediaPlayback=xn,window.updateMediaControl=go,window.getActiveMediaElement=kn,window.openApp=Kt,window.openExplorer=Pt,window.openExplorerInNewWindow=dt,window.refreshExplorerViews=Qe,window.getExplorerWindowContent=et,window.getBreadcrumbsHtml=Vo,window.openFile=Lt,window.normalizePath=jt,window.getFolderIdByFullPath=Er,window.findFolderObjectByFullPath=Ko,window.findFolderFullPathById=dn,window.showContextMenu=ar,window.hideContextMenu=$e,window.createNewFolder=sr,window.createNewFile=Is,window.refreshAllExplorerWindows=Ee,window.saveFileExplorerState=ut,window.handleWatercolourImageSelection=Cr,window.launchCompostBin=Qo,window.loadCompostBinContents=un,window.emptyCompostBin=ti,window.launchStorageManager=Ki,window.refreshStorageData=Nt,window.fullSystemRestart=Zi,window.openCleanupWindow=Vi,window.makeWin95Dropdown=Na,window.launchOSUpdate=Ni,window.refreshUpdateCheck=Wn,window.openAboutWindow=Ts,window.launchCalculator=di,window.initializeCalculatorUI=ui,window.launchSolitaire=pi,window.initializeSolitaireUI=fi,window.launchChess=mi,window.initializeChessUI=gi,window.launchBombbroomer=Li,window.initializeBombbroomerUI=Mi,window.launchHappyTurd=zi,window.initializeHappyTurdUI=ro,window.launchPong=$i,window.initializePongUI=oo,window.launchSnake=Pi,window.initializeSnakeUI=io,window.initializeLetterPad=nt,window.initializeAllLetterPadEditors=rr,window.applyFormatting=Yn,window.convertMarkdownToHTML=Xt,window.launchMailbox=oi,window.launchWatercolour=ai,window.initializeWatercolourUI=si,window.getWatercolourHTML=li,window.initializeWatercolour=ci,window.launchTubeStream=ii,window.launchMediaPlayer=Ai,window.initializeMediaPlayerUI=Di,window.restoreMediaPlayerSession=Bi,window.saveMediaPlayerState=Ge,window.loadMediaPlayerState=to,window.clearMediaPlayerState=aa,window.initializeRouter=cr,window.handleRoute=ho,window.openSecurityPolicy=$s,window.restart=tn,window.logout=Gi,window.storage=B);document.getElementById("desktop").addEventListener("click",function(e){e.target.closest(".draggable-icon")||document.querySelectorAll(".draggable-icon").forEach(n=>n.classList.remove("bg-gray-50"))});function Rs(){const e=document.getElementById("media-control");e&&e.addEventListener("keydown",function(o){(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),xn())});const n=document.getElementById("start-button");n&&n.addEventListener("keydown",function(o){(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),Wt())});const t=document.getElementById("min-all-btn");t&&t.addEventListener("keydown",function(o){(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),bn())}),document.addEventListener("keydown",function(o){if(o.key==="Escape"){const i=document.getElementById("start-menu"),r=document.getElementById("context-menu");if(i&&!i.classList.contains("hidden")){document.getElementById("start-button").setAttribute("aria-expanded","false"),i.classList.add("hidden"),i.setAttribute("aria-hidden","true");const{toggleButtonActiveState:s}=window;s&&s("start-button")}r&&!r.classList.contains("hidden")&&(r.classList.add("hidden"),r.setAttribute("aria-hidden","true"))}})}window.addEventListener("click",async function(e){const n=document.getElementById("start-menu"),t=document.getElementById("start-button");if(!n.contains(e.target)&&!t.contains(e.target)){if(!n.classList.contains("hidden")){const{toggleButtonActiveState:o}=await $n(async()=>{const{toggleButtonActiveState:i}=await Promise.resolve().then(()=>Jo);return{toggleButtonActiveState:i}},void 0);o("start-button")}n.classList.add("hidden"),n.setAttribute("aria-hidden","true"),t.setAttribute("aria-expanded","false")}});window.addEventListener("load",async function(){await Ws();const{toggleButtonActiveState:e,makeWin95Button:n,makeWin95Prompt:t,openFileExplorerForImageSelection:o}=await $n(async()=>{const{toggleButtonActiveState:a,makeWin95Button:s,makeWin95Prompt:l,openFileExplorerForImageSelection:d}=await Promise.resolve().then(()=>Jo);return{toggleButtonActiveState:a,makeWin95Button:s,makeWin95Prompt:l,openFileExplorerForImageSelection:d}},void 0);window.toggleButtonActiveState=e,window.makeWin95Button=n,window.makeWin95Prompt=t,window.openFileExplorerForImageSelection=o;const i=await B.getItem("appState"),r=await B.getItem("explicitRestart");if((!i||r)&&(mn(),r&&await B.removeItem("explicitRestart")),await _n(),await Va(),await be(),await rs(),fr(),typeof an=="function"){an();const{updateStartMenuFocusability:a}=await $n(async()=>{const{updateStartMenuFocusability:l}=await Promise.resolve().then(()=>Ss);return{updateStartMenuFocusability:l}},void 0);window.updateStartMenuFocusability=a;const s=document.getElementById("start-menu");s&&s.classList.contains("hidden")&&a(!1)}else console.error("initializeStartMenu function not available");cr(),Rs(),document.querySelectorAll(".draggable-icon").forEach(a=>pn(a))});document.addEventListener("keydown",function(e){if(e.altKey)switch(e.key){case"Tab":e.preventDefault(),On();break;case"F4":e.preventDefault(),_o();break}if(e.key==="Escape"&&pt(),e.key==="Enter"&&document.getElementById("window-cycle-popup")&&!document.getElementById("window-cycle-popup").classList.contains("hidden")&&(e.preventDefault(),pt()),e.ctrlKey||e.metaKey)switch(e.key){case"w":e.preventDefault(),_o();break;case"m":e.preventDefault(),Da();break}});document.addEventListener("keyup",function(e){if(e.key==="Alt"){const n=document.getElementById("window-cycle-popup");n&&!n.classList.contains("hidden")&&pt()}});xs();
