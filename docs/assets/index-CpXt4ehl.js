(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=t(r);fetch(r.href,i)}})();const Wo="modulepreload",Ro=function(e){return"/"+e},un={},Wt=function(n,t,o){let r=Promise.resolve();if(t&&t.length>0){let a=function(l){return Promise.all(l.map(f=>Promise.resolve(f).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),c=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));r=a(t.map(l=>{if(l=Ro(l),l in un)return;un[l]=!0;const f=l.endsWith(".css"),m=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${m}`))return;const u=document.createElement("link");if(u.rel=f?"stylesheet":Wo,f||(u.as="script"),u.crossOrigin="",u.href=l,c&&u.setAttribute("nonce",c),document.head.appendChild(u),f)return new Promise((p,d)=>{u.addEventListener("load",p),u.addEventListener("error",()=>d(new Error(`Unable to preload CSS for ${l}`)))})}))}function i(a){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=a,window.dispatchEvent(s),!s.defaultPrevented)throw a}return r.then(a=>{for(const s of a||[])s.status==="rejected"&&i(s.reason);return n().catch(i)})};class Oo{constructor(n="NostalgiaOS",t=1){this.dbName=n,this.version=t,this.db=null,this.cache=new Map,this.initPromise=this.init()}async init(){return new Promise((n,t)=>{const o=indexedDB.open(this.dbName,this.version);o.onerror=()=>{console.error("IndexedDB error:",o.error),t(o.error)},o.onsuccess=async()=>{this.db=o.result,await this.populateCache(),n(this.db)},o.onupgradeneeded=r=>{const i=r.target.result;i.objectStoreNames.contains("storage")||i.createObjectStore("storage",{keyPath:"key"})}})}async populateCache(){try{if(!this.db)return;const t=this.db.transaction(["storage"],"readonly").objectStore("storage");return new Promise((o,r)=>{const i=t.getAll();i.onsuccess=()=>{i.result.forEach(s=>{this.cache.set(s.key,s.value)}),o()},i.onerror=()=>{console.warn("Failed to populate cache:",i.error),r(i.error)}})}catch(n){console.warn("Failed to populate cache:",n)}}async ensureDB(){return this.db||await this.initPromise,this.db}async setItem(n,t){const i=(await this.ensureDB()).transaction(["storage"],"readwrite").objectStore("storage"),a={key:n,value:t,timestamp:Date.now()};return this.cache.set(n,t),new Promise((s,c)=>{const l=i.put(a);l.onsuccess=()=>s(),l.onerror=()=>c(l.error)})}async getItem(n){const r=(await this.ensureDB()).transaction(["storage"],"readonly").objectStore("storage");return new Promise((i,a)=>{const s=r.get(n);s.onsuccess=()=>{const c=s.result;let l=c?c.value:null;this.cache.set(n,l),i(l)},s.onerror=()=>a(s.error)})}async removeItem(n){const r=(await this.ensureDB()).transaction(["storage"],"readwrite").objectStore("storage");return this.cache.delete(n),new Promise((i,a)=>{const s=r.delete(n);s.onsuccess=()=>i(),s.onerror=()=>a(s.error)})}async clear(){const o=(await this.ensureDB()).transaction(["storage"],"readwrite").objectStore("storage");return this.cache.clear(),new Promise((r,i)=>{const a=o.clear();a.onsuccess=()=>r(),a.onerror=()=>i(a.error)})}async getAllKeys(){const o=(await this.ensureDB()).transaction(["storage"],"readonly").objectStore("storage");return new Promise((r,i)=>{const a=o.getAllKeys();a.onsuccess=()=>r(a.result),a.onerror=()=>i(a.error)})}setItemSync(n,t){this.cache.set(n,t),this.setItemWithRetry(n,t,3).catch(o=>{console.warn("Failed to save to IndexedDB after retries:",o)})}async setItemWithRetry(n,t,o=3){let r;for(let i=0;i<o;i++)try{await this.setItem(n,t);return}catch(a){r=a,console.warn(`setItem retry ${i+1}/${o} failed:`,a),i<o-1&&await new Promise(s=>setTimeout(s,Math.pow(2,i)*100))}throw r}getItemSync(n){return this.cache.has(n)?this.cache.get(n):(this.getItem(n).catch(console.warn),null)}removeItemSync(n){this.cache.delete(n),this.removeItem(n).catch(console.error)}clearSync(){this.cache.clear(),this.clear().catch(console.error)}}const we=new Oo,M={async ensureReady(){return await we.ensureDB(),we.cache.size===0&&await we.populateCache(),we.db},async setItem(e,n){return await we.setItem(e,n)},async getItem(e){return await we.getItem(e)},async removeItem(e){return await we.removeItem(e)},async clear(){return await we.clear()},async getAllKeys(){return await we.getAllKeys()},async preloadKeys(e){for(const n of e)try{await this.getItem(n)}catch(t){console.warn(`Failed to preload key ${n}:`,t)}},setItemSync(e,n){return we.setItemSync(e,n)},getItemSync(e){return we.getItemSync(e)},removeItemSync(e){return we.removeItemSync(e)},clearSync(){return we.clearSync()}};typeof window<"u"&&(window.globalStorage=M,window.storage=M);function qo(e,n=[],t=[]){const o=document.createElement("div");return o.innerHTML=e,o.querySelectorAll("*").forEach(i=>{if(!n.includes(i.tagName.toLowerCase())){i.remove();return}[...i.attributes].forEach(s=>{t.includes(s.name.toLowerCase())||i.removeAttribute(s.name)})}),o.innerHTML}async function _o(e){e.folders&&Object.keys(e.folders).forEach(n=>{const t=e.folders[n];t&&typeof t=="object"&&Object.keys(t).filter(o=>{const r=t[o];return r&&r.type==="shortcut"})});try{const n=await M.getItem("appState")||{};n.fileSystemState=e,await M.setItem("appState",n),fileSystemState=e}catch(n){console.warn("Failed to set file system state in IndexedDB:",n);try{const t=M.getItemSync("appState")||{};t.fileSystemState=e,M.setItemSync("appState",t),fileSystemState=e}catch(t){console.error("Failed to set file system state with fallback:",t)}}}function V(){try{const e=M.getItemSync("appState");if(e&&e.fileSystemState){const n=e.fileSystemState;return["C://","C://Desktop","C://Documents"].forEach(t=>{n.folders&&n.folders[t]&&Object.keys(n.folders[t]).filter(i=>{const a=n.folders[t][i];return a&&a.type==="shortcut"}).length>0}),n}}catch(e){console.warn("Failed to get file system state sync:",e)}return typeof window<"u"&&window.fileSystemState?window.fileSystemState:typeof fileSystemState<"u"?fileSystemState:(console.error("No file system state available anywhere!"),{folders:{"C://":{},"A://":{},"D://":{}}})}function Zt(e){e=normalizePath(e);const n=V();if(n.initialized!==!0&&Ho(),e.substring(1,4)==="://"&&e.length===4)return n.folders[e]||{};const t=n.folders[e]||{},o={};for(const[r,i]of Object.entries(t))r!=="contents"&&i&&typeof i=="object"&&i.type&&(o[r]=i);return o}const jo={files:[]};function Ho(){try{const e=V();if(!e.folders||!e.folders["C://"]){console.warn("File system structure not properly initialized for sync document fetch");return}const n=jo.files.map(o=>{const r=o.url.split(".").pop().toLowerCase();let i="image/file.webp";return["png","jpg","jpeg","gif"].includes(r)?i="image/image.webp":["mp4","webm"].includes(r)?i="image/video.webp":["mp3","wav"].includes(r)?i="image/audio.webp":r==="html"?i="image/html.webp":["md","txt"].includes(r)&&(i="image/doc.webp"),{id:o.id,name:o.url,type:"file",content:"",fullPath:`C://Documents/${o.id}`,content_type:r,icon_url:i,url:o.url}});e.folders["C://Documents"]||(e.folders["C://Documents"]={});const t={};n.forEach(o=>{t[o.id]=o}),e.folders["C://Documents"]=t,e.initialized=!0;try{const o=M.getItemSync("appState")||{};o.fileSystemState=e,M.setItemSync("appState",o),fileSystemState=e}catch(o){console.warn("Failed to save file system state sync:",o),fileSystemState=e}}catch(e){console.error("Error loading documents sync:",e)}}document.addEventListener("dblclick",e=>{const n=e.target.closest("[data-open-file]");if(n){e.stopPropagation();const t=n.getAttribute("data-open-file");openFile(t,e)}});document.addEventListener("mobiledbltap",e=>{const n=e.target.closest("[data-open-file]");if(n){e.stopPropagation();const t=n.getAttribute("data-open-file");openFile(t,e)}});function st(e){return/^[A-Z]:\/\/$/.test(e)?e:e.replace(/\/+$/,"")}function Uo(e){if(/^[A-Z]:\/\/$/.test(e))return e;const n=V();function t(o){for(const r in o){const i=o[r];if(i.type==="folder"){if(i.fullPath===e)return r;const a=n.folders[i.fullPath]||{},s=t(a);if(s)return s}}return null}for(const o in n.folders)if(/^[A-Z]:\/\/$/.test(o)){const r=t(n.folders[o]);if(r)return r}return null}function An(e,n=null){e=st(e);const t=n||V();if(/^[A-Z]:\/\/$/.test(e))return{id:e,name:e,fullPath:e,contents:t.folders[e]};function o(){for(const r in t.folders)if(/^[A-Z]:\/\/$/.test(r))for(const i in t.folders[r]){const a=t.folders[r][i];if(a.type==="folder"&&st(a.fullPath)===e)return a}else for(const i in t.folders[r]){const a=t.folders[r][i];if(a.type==="folder"&&st(a.fullPath)===e)return a}return null}return o()}function xt(e,n=!1){if(/^[A-Z]:\/\/$/.test(e))return e;const t=V();function o(r,i=null){for(const a in r){const s=r[a];if(s.type==="folder"||n===!0){if(a===e)return s.fullPath;if(s.type==="folder"&&s.fullPath&&t.folders[s.fullPath]){const c=o(t.folders[s.fullPath],s.fullPath);if(c)return c}}}return null}for(const r in t.folders)if(/^[A-Z]:\/\/$/.test(r)){const i=o(t.folders[r],r);if(i)return i}return null}function Qe(e,n=!1){let t;if(/^[A-Z]:\/\//.test(e)?t=e:t=xt(e),!t){console.error("Folder not found for id/path:",e);return}const o=Ne(t);if(!n){let a=document.getElementById("explorer-window");if(a)return a.querySelector(".file-explorer-window").outerHTML=o,a.querySelector(".file-explorer-window").setAttribute("data-current-path",t),Pe(a.id,o),setTimeout(be,100),setTimeout(async()=>{await _e()},150),a}const r=n?`explorer-window-${Date.now()}`:"explorer-window",i=Z(t,o,!1,r,!1,!1,{type:"integer",width:600,height:400},"Explorer");return setTimeout(async()=>{await _e()},150),i}function qe(e){const n=`openExplorer_${e}`,t=Date.now();if(window.explorerDebounce&&window.explorerDebounce[n]){const o=window.explorerDebounce[n];if(t-o<500)return}return window.explorerDebounce||(window.explorerDebounce={}),window.explorerDebounce[n]=t,setTimeout(()=>{window.explorerDebounce&&window.explorerDebounce[n]===t&&delete window.explorerDebounce[n]},1e3),Qe(e,!0)}window.openExplorerInNewWindow=qe;function ze(){document.querySelectorAll(".file-explorer-window").forEach(e=>{const n=e.getAttribute("data-current-path"),t=Ne(n),o=e.parentElement;o.innerHTML=t}),be()}function Dn(e){e=normalizePath(e);const n=e.match(/^([A-Z]:\/\/)(.*)/);if(!n)return e;const t=n[1],o=n[2];let r=`<span class="cursor-pointer hover:underline" data-path="${t}">${t}</span>`;if(!o)return r;let i=t;return o.split("/").filter(Boolean).forEach(a=>{i=i.endsWith("/")?i+a:`${i}/${a}`;const s=An(i),c=s?s.name:a;r+=` / <span class="cursor-pointer hover:underline" data-path="${s?s.id:i}">${c}</span>`}),r}function Ne(e="C://"){e=normalizePath(e);const n=Zt(e),t=['<ul class="pl-5">'];Object.values(n).forEach(i=>{const a=i.type==="folder";let s=a?"image/folder.webp":"image/file.webp";i.icon?s=i.icon:i.icon_url&&(s=i.icon_url);const c="cursor-pointer hover:bg-gray-50 file-item truncate"+(a?" folder-item":""),l=i.description?` (${i.description})`:"";if(a)t.push(`<li class="${c}" data-item-id="${i.id}" data-open-folder="${i.id}" title="${i.name}"><img src="${s}" class="inline h-4 w-4 mr-2" alt="${i.name} folder icon"> ${i.name}</li>`);else if(i.type==="shortcut")t.push(`<li class="${c}" data-item-id="${i.id}" data-open-shortcut="true" data-url="${i.url}" title="${i.name}${l}"><img src="${s}" class="inline h-4 w-4 mr-2" alt="${i.name} shortcut icon"> ${i.name}${l}</li>`);else{const f=i.name||i.id||"Unknown File";i.name||console.warn("🔍 EXPLORER: File missing name property, using fallback:",f,"Item:",i),t.push(`<li class="${c}" data-item-id="${i.id}" data-open-file="${i.id}" title="${f}${l}"><img src="${s}" class="inline h-4 w-4 mr-2" alt="${f} file icon"> ${f}${l}</li>`)}}),t.push("</ul>");const o=["C://","A://","D://"].map(i=>`<li class="cursor-pointer border-b border-gray-200 hover:bg-gray-50 system-folder" data-open-drive="${i}"><img src="image/${i[0].toLowerCase()==="c"?"drive_c":i[0].toLowerCase()==="a"?"floppy":"cd"}.webp" class="inline h-4 w-4 mr-2" alt="${i} drive icon"> ${i}</li>`).join(""),r=Dn(e);return`
    <div class="file-explorer-window" data-current-path="${e}">
      <div class="flex">
        <!-- Left Sidebar -->
        <div id="file-sidebar" class="w-1/4 border-r p-2"><ul>${o}</ul></div>

        <!-- Main Content -->
        <div id="file-main" class="w-3/4 p-2 min-h-96">
          <div id="breadcrumbs" class="mb-2">Path: ${r}</div>
          <div id="files-area">
            ${t.join("")}
          </div>
        </div>
      </div>
    </div>
  `}document.addEventListener("click",e=>{const n=e.target.closest(".file-explorer-window");if(n&&n.getAttribute("data-image-selection-mode")==="true"){const t=e.target.closest("[data-open-file]");if(t){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const o=n.getAttribute("data-current-path"),r=Zt(o),i=Object.values(r).find(a=>a.id===t.dataset.openFile);if(i&&["png","jpg","jpeg","gif","webp","avif"].includes(i.content_type)){n.querySelectorAll("[data-open-file]").forEach(c=>{c.classList.remove("bg-blue-100","border-blue-300"),c.style.backgroundColor="",c.style.border=""}),t.classList.add("bg-blue-100","border-blue-300"),t.style.backgroundColor="#dbeafe",t.style.border="2px solid #93c5fd",t.style.borderRadius="4px";const s=document.getElementById("selected-image-name");if(s)if(s.textContent=`Selected: ${i.name}`,window.watercolourSelectedFile=i,typeof window.updateWatercolourImageSelectionButton=="function")window.updateWatercolourImageSelectionButton(!0);else{const c=document.getElementById("open-selected-image");c&&(c.disabled=!1)}else console.error("Selection UI elements not found",{selectedNameSpan:s})}else{const a=document.getElementById("selected-image-name");if(a)if(a.textContent="Please select an image file",typeof window.updateWatercolourImageSelectionButton=="function")window.updateWatercolourImageSelectionButton(!1);else{const s=document.getElementById("open-selected-image");s&&(s.disabled=!0)}}return}}},!0);document.addEventListener("dblclick",e=>{const n=e.target.closest("[data-open-folder],[data-open-file],[data-open-shortcut]");if(!n)return;const t=e.target.closest(".file-explorer-window");if(t&&t.getAttribute("data-image-selection-mode")==="true")return e.preventDefault(),e.stopPropagation(),!1;if(n.dataset.openFolder)if(t){const o=n.dataset.openFolder;let r;if(/^[A-Z]:\/\//.test(o)?r=o:r=xt(o),r){const i=Ne(r);t.outerHTML=i;const a=t.closest(".window");a&&a.id&&Pe(a.id,i),setTimeout(be,100),setTimeout(async()=>{await _e()},150)}}else Qe(n.dataset.openFolder);else n.dataset.openFile?Ve(n.dataset.openFile,e):n.dataset.openShortcut&&lt(n)});document.addEventListener("click",e=>{const n=e.target.closest("[data-open-drive]");if(n){const t=n.closest(".file-explorer-window");if(t){const o=n.dataset.openDrive,r=Ne(o);t.outerHTML=r;const i=t.closest(".window");i&&i.id&&Pe(i.id,r),setTimeout(be,100),setTimeout(async()=>{await _e()},150)}else Qe(n.dataset.openDrive)}});document.addEventListener("click",e=>{const n=e.target.closest("[data-path]");if(n){e.stopPropagation();const t=n.closest(".file-explorer-window");if(t){let o=n.dataset.path;if(o&&!/^[A-Z]:\/\//.test(o)){const a=xt(o);a&&(o=a)}const r=Ne(o);t.outerHTML=r;const i=t.closest(".window");i&&i.id&&Pe(i.id,r),setTimeout(be,100),setTimeout(async()=>{await _e()},150)}else Qe(n.dataset.path)}});function Ve(e,n){const t=document.getElementById(e);if(t){const p=[...document.querySelectorAll("*")].filter(d=>getComputedStyle(d).zIndex>100&&getComputedStyle(d).zIndex<1e3).reduce((d,g)=>getComputedStyle(g).zIndex>getComputedStyle(d).zIndex?g:d);t.style.zIndex=`${parseInt(p.style.zIndex)+1}`;return}let o;const r=n.target===document.body,i=n.target.closest(".file-explorer-window");let a;r?a="C://Documents":i?a=i.getAttribute("data-current-path"):n.srcElement.classList.contains("desktop-folder-icon")&&(a="C://Desktop");const s=Zt(a);if(o=Object.values(s).find(u=>u.id===e),!o||typeof o=="string"){const u=`File ${typeof o=="string"?`"${o}"`:""}`;K(`${u}not found.`,"error");return}let c="",l="default";o.type==="ugc-file"?o.content_type==="text"||o.content_type==="txt"?(c=`<div id="file-content" style="padding:10px;">
        <div id="text-editor" contenteditable="true" style="padding:10px; overflow:auto;" role="textbox" aria-label="Text file editor" title="Edit the contents of this text file">${o.content||o.contents||"Empty file"}</div>
      </div>`,l="editor",setTimeout(()=>{const u=document.getElementById("text-editor");u&&u.addEventListener("input",function(){Pe(o.id,this.innerHTML),o.content=this.innerHTML,_()})},100)):o.content_type==="markdown"||o.content_type==="md"?(c=`<div id="file-content" style="padding:10px;">
        <div class="letterpad_editor min-h-48 h-full w-full" data-letterpad-editor-id="${o.id}"></div>
      </div>`,l="editor",setTimeout(async()=>{const u=`letterpad_${o.id}`;let p=o.content||o.contents||"";try{const d=await M.getItem(u);d&&d.content!==void 0&&(p=d.content),await M.setItem(u,{content:p});const g=document.querySelector(`[data-letterpad-editor-id="${o.id}"]`);g&&typeof initializeLetterPad=="function"&&await initializeLetterPad(g)}catch(d){console.warn("Failed to initialize LetterPad editor:",d);try{const g=M.getItemSync(u);g&&g.content!==void 0&&(p=g.content),M.setItemSync(u,{content:p});const v=document.querySelector(`[data-letterpad-editor-id="${o.id}"]`);v&&typeof initializeLetterPad=="function"&&await initializeLetterPad(v)}catch(g){console.error("Failed to initialize LetterPad editor with fallback:",g)}}},100)):o.content_type==="html"?c=o.content||o.contents||'<p style="padding:10px;">Empty HTML file.</p>':["png","jpg","jpeg","gif","webp","avif"].includes(o.content_type)?o.dataURL?c=`<img src="${o.dataURL}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:o.isLargeFile&&o.storageLocation==="indexeddb"?(c='<div style="padding:10px; text-align:center;">Loading image...</div>',l="image",setTimeout(async()=>{try{const u=await M.getItem(`file_data_${o.id}`);if(u){const p=`<img src="${u}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`,d=document.getElementById(o.id);if(d){const g=d.querySelector(".p-2");g&&(g.innerHTML=p)}}else throw console.error("No image data found in IndexedDB for file:",o.id),new Error("Image data not found in storage")}catch(u){console.error("Error loading large image file:",u),console.error("File object details:",o);const p=document.getElementById(o.id);if(p){const d=p.querySelector(".p-2");d&&(d.innerHTML=`<p style="padding:10px;">Error loading image: ${u.message}</p>`)}}},100)):o.file&&o.file instanceof File?c=`<img src="${URL.createObjectURL(o.file)}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:c=`<p style="padding:10px;">Image file not found or invalid.<br>Debug: isLargeFile=${o.isLargeFile}, storage=${o.storageLocation}</p>`:["mp3","wav","ogg"].includes(o.content_type)?o.dataURL?c=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
              <source src="${o.dataURL}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:o.isLargeFile&&o.storageLocation==="indexeddb"?(c='<div style="padding:10px; text-align:center;">Loading audio...</div>',l="audio",setTimeout(async()=>{try{const u=await M.getItem(`file_data_${o.id}`);if(u){const p=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
                <source src="${u}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>`,d=document.getElementById(o.id);if(d){const g=d.querySelector(".p-2");g&&(g.innerHTML=p)}}else throw new Error("Audio data not found in IndexedDB")}catch(u){console.error("Error loading large audio file:",u);const p=document.getElementById(o.id);if(p){const d=p.querySelector(".p-2");d&&(d.innerHTML=`<p style="padding:10px;">Error loading audio: ${u.message}</p>`)}}},100)):o.file&&o.file instanceof File?c=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
              <source src="${URL.createObjectURL(o.file)}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:o.tempObjectURL?c=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;"
                     onerror="console.error('🔍 AUDIO: Audio element error:', event.target.error)">
              <source src="${o.tempObjectURL}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:o.isDefault||o.isSystemFile||o.path?c=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
              <source src="${o.path||`media/${o.name}`}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:c='<p style="padding:10px;">Audio file not found or invalid.<br>Debug: Missing required properties for audio playback.</p>':["mp4","webm","avi","mov"].includes(o.content_type)?o.dataURL?c=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
            <source src="${o.dataURL}" type="video/mp4">
            Your browser does not support the video tag.
          </video>`:o.tempObjectURL?c=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;"
                     onerror="console.error('🔍 VIDEO: Video element error:', event.target.error)">
            <source src="${o.tempObjectURL}" type="video/mp4">
            Your browser does not support the video tag.
          </video>`:o.isLargeFile&&o.storageLocation==="indexeddb"?(c='<div style="padding:10px; text-align:center;">Loading video...</div>',l="video",setTimeout(async()=>{try{const u=await M.getItem(`file_data_${o.id}`);if(u){const p=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
                <source src="${u}" type="video/mp4">
                Your browser does not support the video tag.
              </video>`,d=document.getElementById(o.id);if(d){const g=d.querySelector(".p-2");g&&(g.innerHTML=p)}}}catch(u){console.error("Error loading large video file:",u);const p=document.getElementById(o.id);if(p){const d=p.querySelector(".p-2");d&&(d.innerHTML=`<p style="padding:10px;">Error loading video: ${u.message}</p>`)}}},100)):o.file&&o.file instanceof File?c=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
            <source src="${URL.createObjectURL(o.file)}" type="video/mp4">
            Your browser does not support the video tag.
          </video>`:c='<p style="padding:10px;">Video file not found or invalid.</p>':c=`<p style="padding:10px;">${o.content||o.contents||"Empty file"}</p>`:["image","jpg","jpeg","png","webp","avif","gif"].includes(o.content_type)?o.file?c=`<img src="${URL.createObjectURL(o.file)}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:c=`<img src="./media/${o.name}" alt="${o.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:["video","mov","mp4","webm","avi"].includes(o.content_type)?c=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
            <source src="./media/${o.name}" type="video/mp4">
            Your browser does not support the video tag.
          </video>`:["audio","mp3","ogg","wav"].includes(o.content_type)?o.file?c=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
              <source src="${URL.createObjectURL(o.file)}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:o.isDefault||o.isSystemFile||o.path?c=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
              <source src="${o.path||`media/${o.name}`}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:c=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
              <source src="./media/${o.name}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:o.content_type==="html"?(c=o.contents?o.contents:'<p style="padding:10px;">Loading HTML file...</p>',o.contents||fetch(`./media/${o.name}`).then(u=>u.text()).then(u=>{const p=document.getElementById(o.id),d=p?p.querySelector(".p-2"):null;d&&(d.innerHTML=u),o.contents=u,_()}).catch(u=>{console.error("Error loading HTML file:",u);const p=document.getElementById(o.id),d=p?p.querySelector(".p-2"):null;d&&(d.innerHTML="<p>Error loading HTML file.</p>")})):o.content_type==="text"||o.content_type==="txt"?(c='<div id="file-content" style="padding:10px;">Loading file...</div>',fetch(`./media/${o.name}`).then(u=>u.text()).then(u=>{const p=document.getElementById(o.id),d=p?p.querySelector(".p-2"):null;d&&(d.innerHTML=`<div id="text-editor" contenteditable="true" style="padding:10px; overflow:auto;" role="textbox" aria-label="Text file editor" title="Edit the contents of this text file">${u}</div>`,document.getElementById("text-editor").addEventListener("input",function(){Pe(o.id,this.innerHTML),o.type="ugc-file",o.content=this.innerHTML,_()})),o.content=u,_()}).catch(u=>{console.error("Error loading text file:",u);const p=document.getElementById(o.id),d=p?p.querySelector(".p-2"):null;d&&(d.innerHTML="<p>Error loading file.</p>")}),l="editor"):o.content_type==="markdown"||o.content_type==="md"?(c='<div id="file-content" style="padding:10px;">Loading file...</div>',fetch(`./media/${o.name}`).then(u=>u.text()).then(u=>{const p=document.getElementById(o.id),d=p?p.querySelector(".p-2"):null;d&&(d.innerHTML=`<div class="letterpad_editor min-h-48 h-full w-full" data-letterpad-editor-id="${o.id}"></div>`),_()}).catch(u=>{console.error("Error loading markdown file:",u);const p=document.getElementById(o.id),d=p?p.querySelector(".p-2"):null;d&&(d.innerHTML="<p>Error loading file.</p>")}),l="editor"):c=`<p style="padding:10px;">Content of ${o.name}</p>`;let f=null;n&&(f=n.target.closest("#windows-container > div"));let m=Z(o.name,c,!1,o.id,!1,!1,{type:"integer",width:420,height:350},l,f);if(o.content_type==="image"){let u=m.querySelector("img");u&&(u.onload=function(){let p=u.naturalWidth+20,d=u.naturalHeight+60;m.style.width=p+"px",m.style.height=d+"px",G[m.id].dimensions={type:"integer",width:p,height:d},_()})}else if(o.content_type==="video"){let u=m.querySelector("video");u&&(u.onloadedmetadata=function(){let p=u.videoWidth+20,d=u.videoHeight+60;m.style.width=p+"px",m.style.height=d+"px",G[m.id].dimensions={type:"integer",width:p,height:d},_()})}}function lt(e){if(!e)return;const n=e.getAttribute("data-url");n&&window.open(n,"_blank")}function Ko(e){if(!e||!window.watercolourImageSelectionCallback)return!1;if(!["png","jpg","jpeg","gif","webp","avif"].includes(e.content_type))return alert("Please select an image file (.png, .jpg, .jpeg, .gif, .webp)"),!1;let n=null;if(e.dataURL){n=e.dataURL;const t={name:e.name,path:zt(),data:n,storageKey:e.storageLocation==="indexeddb"?`file_data_${e.id}`:null};return window.watercolourImageSelectionCallback(n,t),ie("explorer-image-select"),window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null,!0}else{if(e.isLargeFile&&e.storageLocation==="indexeddb")return M.getItem(`file_data_${e.id}`).then(t=>{if(t){const o={name:e.name,path:zt(),data:t,storageKey:`file_data_${e.id}`};window.watercolourImageSelectionCallback(t,o),ie("explorer-image-select"),window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null}else alert("Could not load image data.")}).catch(t=>{console.error("Error loading image:",t),alert("Error loading image: "+t.message)}),!0;if(e.file&&e.file instanceof File){const t=new FileReader;return t.onload=o=>{const r={name:e.name,path:zt(),data:o.target.result,storageKey:null};window.watercolourImageSelectionCallback(o.target.result,r),ie("explorer-image-select"),window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null},t.readAsDataURL(e.file),!0}}return alert("Could not load the selected image."),!1}function zt(){const e=document.querySelectorAll(".file-explorer-window");return e.length>0&&e[e.length-1].getAttribute("data-current-path")||"C://Documents"}async function _e(){try{const e=document.getElementById("explorer-window");if(e){const n=e.querySelector(".file-explorer-window");if(n){const o={currentPath:n.getAttribute("data-current-path")||"C://",timestamp:Date.now()};await M.setItem("fileExplorerState",o)}}}catch(e){console.warn("Failed to save file explorer state:",e);try{const n=document.getElementById("explorer-window");if(n){const t=n.querySelector(".file-explorer-window");if(t){const r={currentPath:t.getAttribute("data-current-path")||"C://",timestamp:Date.now()};M.setItemSync("fileExplorerState",r)}}}catch(n){console.error("Failed to save file explorer state with fallback:",n)}}}async function Yo(){try{const e=await M.getItem("fileExplorerState");if(e)return e}catch(e){console.warn("Failed to load file explorer state:",e);try{const n=M.getItemSync("fileExplorerState");if(n)return n}catch(n){console.warn("Failed to load file explorer state with fallback:",n)}}return{currentPath:"C://",timestamp:0}}function Go(e){setTimeout(async()=>{await Bn()},50)}async function Bn(){const e=await Yo(),n=document.getElementById("explorer-window");if(n&&e.currentPath){const t=Ne(e.currentPath),o=n.querySelector(".file-explorer-window");o?(o.outerHTML=t,setTimeout(()=>{be(),ze()},100)):console.warn("⚠️ Could not find .file-explorer-window element")}else console.warn("⚠️ No explorer window found or no current path in state")}typeof window<"u"&&(window.initializeFileExplorerUI=Go,window.restoreFileExplorerState=Bn);function it(e){e.addEventListener("keydown",function(n){if(n.key==="ContextMenu"||n.shiftKey&&n.key==="F10"||n.ctrlKey&&n.key===" "){n.preventDefault();const t=e.getBoundingClientRect(),o=new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,clientX:t.left+t.width/2,clientY:t.top+t.height/2,button:2});e.dispatchEvent(o),setTimeout(()=>{const r=document.getElementById("context-menu");r&&!r.classList.contains("hidden")&&Zo(r)},10)}})}function Zo(e){if(!e)return;e.setAttribute("role","menu"),e.setAttribute("aria-label","Context menu");const n=Array.from(e.children).filter(t=>t.classList.contains("cursor-pointer")&&!t.classList.contains("text-gray-400"));n.forEach((t,o)=>{t.setAttribute("role","menuitem"),t.setAttribute("tabindex",o===0?"0":"-1"),t.addEventListener("keydown",function(i){(i.key==="Enter"||i.key===" ")&&(i.preventDefault(),t.click())}),t.addEventListener("mouseenter",function(){n.forEach(i=>{i.classList.remove("bg-gray-50"),i.style.backgroundColor=""}),t.classList.add("bg-gray-50"),t.style.backgroundColor="#f9fafb"}),t.addEventListener("mouseleave",function(){document.activeElement!==t&&(t.classList.remove("bg-gray-50"),t.style.backgroundColor="")});const r=t.querySelector("div.absolute");r&&(t.setAttribute("aria-haspopup","true"),t.setAttribute("aria-expanded","false"),r.setAttribute("role","menu"),r.setAttribute("aria-label","Submenu"),Array.from(r.children).filter(a=>a.classList.contains("cursor-pointer")).forEach((a,s)=>{a.setAttribute("role","menuitem"),a.setAttribute("tabindex","-1"),a.addEventListener("keydown",function(c){(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),a.click())})}))}),n.length>0&&setTimeout(()=>{n[0].focus(),n[0].classList.add("bg-gray-50"),n[0].style.backgroundColor="#f9fafb"},50)}function pn(){document.addEventListener("keydown",function(i){const a=document.getElementById("context-menu");if(a&&!a.classList.contains("hidden")){e(i,a);return}const c=document.querySelector(".file-explorer-window:focus-within");if(c){const l=document.activeElement;switch(i.key){case"F2":i.preventDefault(),console.log("F2 - Rename functionality would trigger here");break;case"Delete":i.preventDefault(),console.log("Delete - Delete functionality would trigger here");break;case"Enter":i.preventDefault(),l&&l.classList.contains("file-item")&&l.dispatchEvent(new MouseEvent("dblclick",{bubbles:!0}));break;case"ArrowDown":case"ArrowUp":i.preventDefault(),o(i.key==="ArrowDown"?"down":"up",c);break}}});function e(i,a){const s=Array.from(a.children).filter(l=>!l.classList.contains("text-gray-400")&&l.classList.contains("cursor-pointer"));if(s.length===0)return;let c=-1;for(let l=0;l<s.length;l++)if(s[l].classList.contains("bg-gray-50")||s[l].matches(":focus")){c=l;break}switch(i.key){case"ArrowDown":i.preventDefault(),i.stopPropagation(),c=c===-1?0:(c+1)%s.length,n(s,c);break;case"ArrowUp":i.preventDefault(),i.stopPropagation(),c=c===-1?s.length-1:(c-1+s.length)%s.length,n(s,c);break;case"ArrowRight":if(i.preventDefault(),i.stopPropagation(),c>=0&&s[c]){const f=s[c].querySelector("div.absolute");if(f){f.classList.remove("hidden");const m=Array.from(f.children).filter(u=>u.classList.contains("cursor-pointer"));m.length>0&&t(m,0)}}break;case"ArrowLeft":i.preventDefault(),i.stopPropagation();const l=a.querySelector("div.absolute:not(.hidden)");l&&(l.classList.add("hidden"),c>=0&&s[c]&&n(s,c));break;case"Enter":case" ":i.preventDefault(),i.stopPropagation(),c>=0&&s[c]&&s[c].click();break;case"Escape":i.preventDefault(),i.stopPropagation(),typeof hideContextMenu=="function"?hideContextMenu():a.classList.add("hidden");break}}function n(i,a){i.forEach(s=>{s.classList.remove("bg-gray-50"),s.style.backgroundColor=""}),i[a]&&(i[a].classList.add("bg-gray-50"),i[a].style.backgroundColor="#f9fafb",i[a].focus())}function t(i,a){i.forEach(s=>{s.classList.remove("bg-gray-50"),s.style.backgroundColor=""}),i[a]&&(i[a].classList.add("bg-gray-50"),i[a].style.backgroundColor="#f9fafb",i[a].focus())}function o(i,a){const s=Array.from(a.querySelectorAll(".file-item, .folder-item")),c=document.activeElement;let l=s.indexOf(c);if(l===-1&&s.length>0){s[0].focus();return}let f;i==="down"?f=(l+1)%s.length:f=(l-1+s.length)%s.length,s[f]&&s[f].focus()}new MutationObserver(function(i){i.forEach(function(a){a.addedNodes.forEach(function(s){var c,l;if(s.nodeType===Node.ELEMENT_NODE){const f=(c=s.querySelectorAll)==null?void 0:c.call(s,".file-item, .folder-item, .draggable-icon");f==null||f.forEach(u=>{it(u),u.hasAttribute("tabindex")||u.setAttribute("tabindex","0")});const m=(l=s.querySelectorAll)==null?void 0:l.call(s,".file-explorer-window");m==null||m.forEach(u=>{it(u),u.hasAttribute("tabindex")||u.setAttribute("tabindex","0")})}})})}).observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll(".file-item, .folder-item, .draggable-icon").forEach(i=>{it(i),i.hasAttribute("tabindex")||i.setAttribute("tabindex","0")}),document.querySelectorAll(".file-explorer-window").forEach(i=>{it(i),i.hasAttribute("tabindex")||i.setAttribute("tabindex","0")})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",pn):pn();function Fe(e,n=null){let t;typeof e!="string"?t=e:t=document.getElementById(e),t.classList.toggle("bg-gray-50"),t.classList.toggle("bg-gray-200"),t.classList.toggle("border-gray-300"),t.classList.toggle("border-black");const o=t.querySelector("span");o.classList.toggle("border-gray-300"),o.classList.toggle("border-black");const r=t.querySelector("img");r&&(r.classList.toggle("border-gray-300"),r.classList.toggle("border-black")),n&&(o.innerHTML=n)}function Vo(e){if(!e)return!0;try{return new URL(e,location.href).origin===location.origin}catch{return!1}}function Tn(){document.getElementById("error-overlay").classList.remove("hidden"),document.getElementById("error-overlay").style.zIndex="9999";function e(n){location.reload()}document.addEventListener("keydown",e,{once:!0})}window.onerror=function(e,n,t,o,r){Vo(n)&&Tn()};window.addEventListener("unhandledrejection",function(e){Tn()});function Xo(e){if(window.watercolourImageSelectionCallback=e,window.watercolourSelectedFile=null,typeof getExplorerWindowContent=="function"&&typeof createWindow=="function"){const t=getExplorerWindowContent("C://Documents").replace(/<div id="file-sidebar"[\s\S]*?<\/ul><\/div>/g,"").replace(/<div id="breadcrumbs"[\s\S]*?<\/div>/g,""),o=createWindow("Select Image - File Explorer",t,!0,"explorer-image-select",!1,!1,{type:"integer",width:600,height:550},"file-explorer");setTimeout(()=>{const r=[...document.querySelectorAll("*")].filter(i=>getComputedStyle(i).zIndex>100&&getComputedStyle(i).zIndex<1e3);if(r.length>0){const i=r.reduce((a,s)=>getComputedStyle(s).zIndex>getComputedStyle(a).zIndex?s:a);o.style.zIndex=`${parseInt(getComputedStyle(i).zIndex)+1}`}},50),setTimeout(()=>{if(o){const r=o.querySelector(".file-explorer-window");r?r.setAttribute("data-image-selection-mode","true"):console.error("Could not find .file-explorer-window div!");const i=o.querySelector(".p-2");if(i){const a=document.createElement("div");a.className="bg-blue-100 border border-blue-300 text-blue-800 px-3 py-2 rounded mb-3 text-sm",a.innerHTML='<strong>Select an image:</strong> Click any image file (.png, .jpg, .jpeg, .gif, .webp) to select it, then click "Open Selected Image".',i.insertBefore(a,i.firstChild);const s=document.createElement("div");s.className="-mt-2 p-3 bg-gray-50 border-t border-gray-200 flex items-center justify-between",s.id="watercolour-selection-ui";const c=document.createElement("div");c.className="flex gap-2";const l=Q("Cancel");l.id="cancel-selection";const f=Q("Open");f.id="open-selected-image",f.disabled=!0,f.style.opacity="0.5",f.style.cursor="not-allowed",c.appendChild(l),c.appendChild(f),s.innerHTML=`
            <div>
              <span id="selected-image-name" class="text-sm text-gray-600">No image selected</span>
            </div>
          `,s.appendChild(c),i.appendChild(s),l.addEventListener("click",()=>{window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null,closeWindow("explorer-image-select")}),f.addEventListener("click",()=>{const m=window.watercolourSelectedFile;m&&window.watercolourImageSelectionCallback&&!f.disabled&&handleWatercolourImageSelection(m)}),window.updateWatercolourImageSelectionButton=function(m){m?(f.disabled=!1,f.style.opacity="1",f.style.cursor="pointer"):(f.disabled=!0,f.style.opacity="0.5",f.style.cursor="not-allowed")}}}else console.error("Explorer window not found!")},100)}else showDialogBox("File explorer functionality not available.","error")}function Q(e){const n=document.createElement("button");n.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2";const t=document.createElement("span");return t.className="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3",t.textContent=e,n.appendChild(t),n.setAttribute("aria-label",e),n.setAttribute("title",e),n}function Vt(e,n="",t=null,o=null){const r="promptWindow-"+Date.now(),i=createWindow("💬 Input Required","",!1,r,!1,!1,{type:"integer",width:400,height:200},"default"),a=i.querySelector(".p-2");if(a){a.innerHTML="";const s=document.createElement("div");s.className="flex flex-col p-4 h-full justify-between";const c=document.createElement("div");c.className="mb-4",c.innerHTML=`<p class="text-sm mb-3">${e}</p>`;const l=document.createElement("input");l.type="text",l.id=`${r}-input`,l.value=n,l.className="w-full px-2 py-1 border-2 border-gray-400 bg-white",l.style.borderTopColor="#808080",l.style.borderLeftColor="#808080",l.style.borderBottomColor="#ffffff",l.style.borderRightColor="#ffffff",l.style.borderStyle="inset",l.setAttribute("aria-label","Text input for prompt dialog"),l.setAttribute("title","Enter your response here"),c.appendChild(l),s.appendChild(c);const f=document.createElement("div");f.className="flex gap-2 justify-center";const m=Q("OK");m.id=`${r}-ok-button`;const u=Q("Cancel");u.id=`${r}-cancel-button`,f.appendChild(m),f.appendChild(u),s.appendChild(f),a.appendChild(s),setTimeout(()=>{l.focus(),l.select()},100),setTimeout(()=>{m.addEventListener("click",()=>{const p=l.value;closeWindow(r),t&&t(p)}),u.addEventListener("click",()=>{closeWindow(r),o&&o(null)}),l.addEventListener("keydown",p=>{if(p.key==="Enter"){p.preventDefault();const d=l.value;closeWindow(r),t&&t(d)}else p.key==="Escape"&&(p.preventDefault(),closeWindow(r),o&&o(null))})},150)}return bringToFront(i),setTimeout(()=>{bringToFront(i)},10),i}const Fn=Object.freeze(Object.defineProperty({__proto__:null,makeWin95Button:Q,makeWin95Prompt:Vt,openFileExplorerForImageSelection:Xo,toggleButtonActiveState:Fe},Symbol.toStringTag,{value:"Module"}));function $n(){const e=document.getElementById("compost-bin");if(e){const d=[...document.querySelectorAll("*")].filter(g=>getComputedStyle(g).zIndex>100&&getComputedStyle(g).zIndex<1e3).reduce((g,v)=>getComputedStyle(v).zIndex>getComputedStyle(g).zIndex?v:g);e.style.zIndex=`${parseInt(d.style.zIndex)+1}`;return}const t=Z("Compost Bin","",!1,"compost-bin",!1,!1,{type:"integer",width:600,height:400},"App",null,"gray").querySelector(".p-2");t.className="p-2 bg-gray-100 h-full flex flex-col";const o=document.createElement("div");o.className="h-full flex flex-col";const r=document.createElement("div");r.className="bg-gray-200 border-b border-gray-400 p-2 flex justify-between items-center";const i=document.createElement("div");i.className="text-sm";const c=(V().folders["C://Desktop"]||{}).compostbin,l=Object.keys((c==null?void 0:c.contents)||{}).length;i.textContent=`Compost Bin - ${l} item(s)`;const f=document.createElement("div");f.className="flex space-x-2";const m=document.createElement("button");m.className="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs",m.textContent="Empty Bin",m.setAttribute("aria-label","Empty all items from compost bin"),m.setAttribute("title","Permanently delete all items in the compost bin"),m.addEventListener("click",zn),f.appendChild(m),r.appendChild(i),r.appendChild(f);const u=document.createElement("div");u.className="flex-1 bg-white border border-gray-400 p-2 overflow-auto",u.id="compost-bin-content",kt(u),o.appendChild(r),o.appendChild(u),t.appendChild(o)}function kt(e){const o=(V().folders["C://Desktop"]||{}).compostbin,r=(o==null?void 0:o.contents)||{};if(e.innerHTML="",Object.keys(r).length===0){const a=document.createElement("div");a.className="text-center text-gray-500 mt-8",a.textContent="The Compost Bin is empty",e.appendChild(a);return}const i=document.createElement("div");i.className="grid grid-cols-6 gap-4 p-2",Object.values(r).forEach(a=>{const s=Jo(a);i.appendChild(s)}),e.appendChild(i)}function Jo(e){const n=document.createElement("div");n.className="flex flex-col items-center p-2 hover:bg-blue-100 cursor-pointer",n.draggable=!0,n.setAttribute("data-item-id",e.id);const t=document.createElement("img");t.className="w-8 h-8 mb-1",t.src=e.icon||Qo(e.type),t.alt=e.name;const o=document.createElement("div");return o.className="text-xs text-center text-gray-700 break-words max-w-16",o.textContent=e.name,n.appendChild(t),n.appendChild(o),n.addEventListener("dragstart",r=>{r.dataTransfer.setData("text/plain",e.id),r.dataTransfer.setData("application/x-compost-item","true"),r.dataTransfer.effectAllowed="move"}),n}async function Pn(e,n){const t=V();if(e==="compostbin"){K("Cannot move the Compost Bin to itself!","error");return}let o=null,r=null;if(r=t.folders["C://Desktop"]||{},r&&r[e]){o=r[e];const a=(t.folders["C://Desktop"]||{}).compostbin;if(!a){console.error("Compost bin not found in unified structure"),K("Compost Bin not found!","error");return}a.contents||(a.contents={}),o.originalPath=n,a.contents[e]=o,delete r[e];{const c="icon-"+e;ne[c]&&delete ne[c]}await ue(t),_(),ze(),ae();const s=document.getElementById("compost-bin");if(s){const c=s.querySelector("#compost-bin-content");c&&(kt(c),Nn(s))}}}function zn(){const e=V(),t=(e.folders["C://Desktop"]||{}).compostbin;if(!t){K("Compost Bin not found!","error");return}const o=Object.keys(t.contents||{}).length;if(o===0){K("The Compost Bin is already empty.","info");return}const r=`window-${Date.now()}`,a=Z("Empty Compost Bin","",!1,r,!1,!1,{type:"integer",width:320,height:140},"Default").querySelector(".p-2");a.classList.add("p-4","flex","flex-col","justify-between","h-full");const s=document.createElement("p");s.textContent=`Are you sure you want to permanently delete all ${o} item(s) in the Compost Bin?`,a.appendChild(s);const c=document.createElement("div");c.className="flex justify-end space-x-2",a.appendChild(c);const l=document.createElement("button");l.className="px-4 py-2 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200",l.textContent="Cancel",l.setAttribute("aria-label","Cancel empty bin operation"),l.setAttribute("title","Cancel and keep items in compost bin");const f=document.createElement("button");f.className="px-4 py-2 bg-red-500 border-2 border-red-600 hover:bg-red-400 text-white",f.textContent="Empty Bin",f.setAttribute("aria-label","Confirm empty bin operation"),f.setAttribute("title","Permanently delete all items in compost bin"),c.append(l,f),l.addEventListener("click",()=>closeWindow(r)),f.addEventListener("click",async()=>{const m=Object.keys(t.contents||{});t.contents={},m.forEach(p=>{const d="icon-"+p;ne[d]&&delete ne[d]}),await ue(e),_();const u=document.getElementById("compost-bin");if(u){const p=u.querySelector("#compost-bin-content");p&&(kt(p),Nn(u))}closeWindow(r),K(`${o} item(s) permanently deleted from Compost Bin`,"info")})}function Nn(e){const n=e.querySelector(".bg-gray-200");if(n){const t=n.querySelector(".text-sm");if(t){const i=(V().folders["C://Desktop"]||{}).compostbin,a=Object.keys((i==null?void 0:i.contents)||{}).length;t.textContent=`Compost Bin - ${a} item(s)`}}}function Qo(e){switch(e){case"folder":return"./image/folder.webp";case"ugc-file":return"./image/doc.webp";case"app":return"./image/computer.webp";default:return"./image/file.webp"}}function Wn(){if(window.location.href.includes("reddit.com")){if(document.getElementById("mailbox-error"))return;Z("⚠️ Error",'<div class="text-center p-4"><p class="mb-4">Mail app is not available in Reddit context.</p><button id="error-ok-btn" class="bg-gray-200 border-t-2 border-l-2 border-gray-300 h-8" aria-label="Close error dialog" title="Close this error message"><span class="border-b-2 border-r-2 border-black block h-full w-full py-1 px-3 leading-6">OK</span></button></div>',!1,"mailbox-error",!1,!1,{type:"integer",width:300,height:150},"Default"),setTimeout(()=>{const u=document.getElementById("error-ok-btn");u&&u.addEventListener("click",p=>{p.preventDefault(),p.stopPropagation(),ie("mailbox-error")})},100);return}const t=Z("Mailbox","",!1,"mailbox",!1,!1,{type:"integer",width:600,height:400},"App",null,"white").querySelector(".p-2");t.classList.add("flex","flex-col","h-full");const o=document.createElement("div");o.className="flex-1 flex overflow-hidden",t.appendChild(o);const r=document.createElement("div");r.id="mailbox-list",r.className="w-1/3 border-r border-gray-300 flex flex-col overflow-y-auto",o.appendChild(r);const i=document.createElement("button");i.id="compose-btn",i.className="p-2 border-b border-gray-300 text-blue-500 hover:bg-gray-100",i.textContent="Compose",i.setAttribute("aria-label","Compose new email"),i.setAttribute("title","Create and send a new email message"),r.appendChild(i);const a=document.createElement("div");a.id="mailbox-detail",a.className="flex-1 p-2 overflow-y-auto",o.appendChild(a);const s=document.createElement("div");s.id="placeholder",s.className="text-gray-500",s.textContent="Select a message to view",a.appendChild(s);function c(u){const p={};return u.forEach(d=>{const g=d.creator_model_id;p[g]||(p[g]={id:g,fields:{},created_at:d.created_at,updated_at:d.updated_at}),p[g].fields[d.html_input_label]={content:d.string_content||"",fieldId:d.id}}),Object.values(p).map(d=>{var g,v,x,F;return{id:d.id,email:((g=d.fields.email)==null?void 0:g.content)||((v=d.fields.name)==null?void 0:v.content)||"Unknown",textarea:((x=d.fields.message)==null?void 0:x.content)||"",subject:((F=d.fields.subject)==null?void 0:F.content)||"No Subject",public:!1,files:{}}})}function l(){try{for(;r.children.length>1;)r.removeChild(r.lastChild);fetch("https://endpoints.relentlesscurious.com/end_data/public/contact-form-data").then(u=>{if(!u.ok)throw new Error("Failed to fetch submissions");return u.json()}).then(u=>{c(u.data).forEach(d=>{const g=document.createElement("div");g.className="p-2 border-b border-gray-300 hover:bg-gray-200 cursor-pointer truncate",g.textContent=d.subject||d.email,g.addEventListener("click",()=>f(d)),r.appendChild(g)})}).catch(u=>{console.error("Error loading messages:",u);const p=document.createElement("div");p.className="p-2 text-red-500 text-sm",p.textContent="Failed to load messages",r.appendChild(p)})}catch(u){console.error("Error loading messages:",u)}}function f(u){for(;a.firstChild;)a.removeChild(a.firstChild);const p=document.createElement("div");p.className="mb-2";const d=document.createElement("div"),g=document.createElement("strong");g.textContent="From: ",d.append(g,document.createTextNode(u.email)),p.appendChild(d);const v=document.createElement("div"),x=document.createElement("strong");x.textContent="Subject: ",v.append(x,document.createTextNode(u.subject||"(No Subject)")),p.appendChild(v);const F=document.createElement("div");if(F.className="mb-2 whitespace-pre-wrap",F.textContent=u.textarea,a.append(p,F),u.files&&Object.keys(u.files).length){const I=document.createElement("div");I.className="mt-2";const R=document.createElement("strong");R.textContent="Attachments:",I.appendChild(R);const W=document.createElement("ul");W.className="list-disc list-inside",Object.values(u.files).forEach(P=>{const j=document.createElement("li"),H=document.createElement("a");H.href=P.url||P.contents||"#",H.className="text-blue-500 hover:underline",H.textContent=P.name,H.target="_blank",j.appendChild(H),W.appendChild(j)}),I.appendChild(W),a.appendChild(I)}}function m(){const p=Z("Compose Message","",!1,"Compose Message",!1,!1,{type:"integer",width:400,height:600},"App",null,"white").querySelector(".p-2");p.classList.add("p-4");const d=document.createElement("form");d.id="compose-form",d.className="flex flex-col space-y-4",p.appendChild(d);const g=($,N)=>{const h=document.createElement("div"),k=document.createElement("label");return k.className="block text-sm font-medium text-gray-700",k.textContent=$,h.append(k,N),h},v=document.createElement("input");v.type="email",v.name="from",v.required=!0,v.id="from-email",v.setAttribute("aria-label","Your email address"),v.setAttribute("aria-describedby","from-help"),v.className="mt-1 block w-full border border-gray-300 rounded p-2",d.appendChild(g("From",v));const x=document.createElement("input");x.type="email",x.name="to",x.value="person@example.com",x.readOnly=!0,x.id="to-email",x.setAttribute("aria-label","Recipient email address"),x.className="mt-1 block w-full border border-gray-300 rounded p-2 bg-gray-100",d.appendChild(g("To",x));const F=document.createElement("input");F.type="text",F.name="subject",F.id="email-subject",F.setAttribute("aria-label","Email subject line (optional)"),F.className="mt-1 block w-full border border-gray-300 rounded p-2",d.appendChild(g("Subject (optional)",F));const I=document.createElement("textarea");I.name="message",I.required=!0,I.id="email-message",I.setAttribute("aria-label","Email message content"),I.className="mt-1 block w-full border border-gray-300 rounded p-2",d.appendChild(g("Message",I));const R=document.createElement("input");R.type="tel",R.name="phone",R.id="phone-number",R.setAttribute("aria-label","Phone number (optional)"),R.className="mt-1 block w-full border border-gray-300 rounded p-2",d.appendChild(g("Phone (optional)",R));const W=document.createElement("input");W.type="text",W.name="company",W.id="company-name",W.setAttribute("aria-label","Company name (optional)"),W.className="mt-1 block w-full border border-gray-300 rounded p-2",d.appendChild(g("Company (optional)",W));const P=document.createElement("div");P.className="flex justify-end space-x-2",d.appendChild(P);const j=document.createElement("button");j.type="button",j.id="cancel-compose",j.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2",j.innerHTML='<span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Cancel</span>',j.setAttribute("aria-label","Cancel email composition"),j.setAttribute("title","Cancel and discard email"),P.appendChild(j);const H=document.createElement("button");H.type="submit",H.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2",H.innerHTML='<span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Send</span>',H.setAttribute("aria-label","Send email"),H.setAttribute("title","Send the composed email"),P.appendChild(H),d.addEventListener("submit",$=>{$.preventDefault();const N=new FormData(d),h={name:N.get("from"),email:N.get("from"),subject:N.get("subject")||"No Subject",message:N.get("message"),phone:N.get("phone")||"",company:N.get("company")||""},k={creator_model:{title:`Contact: ${h.subject}`,creator_fields_attributes:{0:{html_input_label:"name",string_content:h.name},1:{html_input_label:"email",string_content:h.email},2:{html_input_label:"phone",string_content:h.phone},3:{html_input_label:"company",string_content:h.company},4:{html_input_label:"subject",string_content:h.subject},5:{html_input_label:"message",string_content:h.message}}}};fetch("https://endpoints.relentlesscurious.com/end_data/public/contact-form-create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(k)}).then(C=>{if(C.ok)showDialogBox("Message sent successfully!","success"),l(),ie("Compose Message");else throw new Error("Failed to submit form")}).catch(()=>showDialogBox("Error sending message.","error"))}),j.addEventListener("click",()=>ie("Compose Message"))}i.addEventListener("click",m),l()}async function Rn(){const n=`<iframe width="560" height="315" style="margin:0 auto;" src="${await On()}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>`;Z("TubeStream",n,!1,"tubestream",!1,!1,{type:"integer",width:580,height:380},"default",null,"white")}async function On(){const e="https://www.youtube.com/embed";try{const n=er.playlists[0],t=n.beginning_video_id,o=n.playlist_id,r=n.custom_parameters;return`${e}/${t}?list=${o}&${r}`}catch(n){return console.error("Error loading stream:",n),"https://www.youtube.com/embed/b6ZhmHfnklQ?autoplay=true"}}const er={playlists:[{id:"111",name:"Psytrance Mix",description:"Example usage #1",playlist_id:"PL7SZQy1OjmvdHsvEG1e8H305y3SxaIzxY",beginning_video_id:"b6ZhmHfnklQ",custom_parameters:"autoplay=true&loop=false"},{id:"222",name:"Skits",description:"Example usage #2",playlist_id:"PLfznZzH31A448eZ2rWURNfkmRGC0lsCaA",beginning_video_id:"24ny5EJr-hQ",custom_parameters:"autoplay=true&loop=true"},{id:"333",name:"Studio Shows",description:"Example usage #3",playlist_id:"PLfznZzH31A46GppLOHadmvL3I8H7ied2d",beginning_video_id:"J5a029oRpDA",custom_parameters:"autoplay=true&loop=false"}]};async function qn(){const e=document.getElementById("watercolour");if(e){const o=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,i)=>getComputedStyle(i).zIndex>getComputedStyle(r).zIndex?i:r);e.style.zIndex=`${parseInt(o.style.zIndex)+1}`;return}const n=jn();Z("Watercolour",n,!1,"watercolour",!1,!1,{type:"integer",width:700,height:440},"app",null,"white"),_n()}async function _n(e){await Hn()}function jn(){return`
<div id="watercolour-container" style="background-color: #f3f4f6; position: relative; height: calc(100% - 0.25rem); margin-top: -0.5rem; margin: 0; padding: 0;">
  <!-- Top Menu Bar -->
  <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background-color: white; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); border-bottom: 1px solid #e5e7eb;">
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <!-- File Dropdown Menu -->
      <div style="position: relative;">
        <button id="fileMenuBtn" style="padding: 0.25rem 0.75rem; border-radius: 0.25rem; border: 1px solid #d1d5db; background-color: white; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'" onclick="toggleFileDropdown(event)">
          File
          <svg style="width: 0.75rem; height: 0.75rem; pointer-events: none;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div id="fileDropdown" style="position: absolute; left: 0; top: 100%; margin-top: 0.25rem; width: 10rem; background-color: white; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 50; display: none;">
          <button id="loadBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; border-bottom: 1px solid #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">Open...</button>
          <button id="newBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; border-bottom: 1px solid #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">New</button>
          <button id="saveAsBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; border-bottom: 1px solid #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">Save</button>
          <button id="exportBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">Export...</button>
        </div>
      </div>

      <button id="undoBtn" style="padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #d1d5db; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">
        <svg style="height: 1rem; width: 1rem; display: inline;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
          <path style="opacity: 0.4;" d="M97.6 97.6c87.5-87.5 229.3-87.5 316.8 0C458.1 141.3 480 198.7 480 256s-21.9 114.7-65.6 158.4c-87.5 87.5-229.3 87.5-316.8 0l45.3-45.3c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L97.6 97.6z" />
          <path d="M176 224l24-24L40 40 16 64l0 160H176z" />
        </svg>
        Undo
      </button>
      <button id="redoBtn" style="padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #d1d5db; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">
        <svg style="height: 1rem; width: 1rem; display: inline;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
          <path style="opacity: 0.4;" d="M32 256c0 57.3 21.9 114.7 65.6 158.4c87.5 87.5 229.3 87.5 316.8 0l-45.3-45.3c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3s163.8-62.5 226.3 0c15.1-15.1 30.2-30.2 45.3-45.3c-87.5-87.5-229.3-87.5-316.8 0C53.9 141.3 32 198.7 32 256z" />
          <path d="M336 224l-24-24L472 40l24 24 0 160H336z" />
        </svg>
        Redo
      </button>
    </div>
    <div id="status" style="font-size: 0.75rem; color: #6b7280;">
      Tool: Brush | x: 0, y: 0
    </div>
  </div>

  <!-- Main Content Area -->
  <div style="display: flex;">
    <!-- Left Toolbar -->
    <div style="width: 3rem; padding: 0.5rem; background-color: white; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; gap: 0.5rem;">
      <button data-tool="brush" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='#f3f4f6'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/brush.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Brush</span>
      </button>
      <button data-tool="line" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/line.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Line</span>
      </button>
      <button data-tool="rectangle" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/rectangle.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Rectangle</span>
      </button>
      <button data-tool="ellipse" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/ellipse.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Ellipse</span>
      </button>
      <button data-tool="eraser" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/eraser.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Eraser</span>
      </button>
      <button data-tool="fill" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/fill.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Fill</span>
      </button>
      <button data-tool="picker" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./image/watercolour-icons/picker.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Picker</span>
      </button>
    </div>

    <!-- Canvas Container -->
    <div style="flex: 1; position: relative;">
      <canvas id="watercolourCanvas" width="420" height="300" style="background: white; margin: 0.5rem; margin-bottom: 2rem; position: absolute; inset: 0; border: 1px solid #d1d5db;"></canvas>
    </div>

    <!-- Right Panel: Color Palette & Stroke Size -->
    <div style="width: 8rem; padding: 0.5rem; background-color: white; border-left: 1px solid #e5e7eb; display: flex; flex-direction: column; gap: 1rem;">
      <!-- Color Palette -->
      <div style="display: flex; flex-direction: column; gap: 0.5rem;">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.25rem;">
          <!-- 16 predefined colors -->
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #000000;" data-color="#000000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #808080;" data-color="#808080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #800000;" data-color="#800000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FF0000;" data-color="#FF0000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #808000;" data-color="#808000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FFFF00;" data-color="#FFFF00"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #008000;" data-color="#008000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #00FF00;" data-color="#00FF00"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #008080;" data-color="#008080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #00FFFF;" data-color="#00FFFF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #000080;" data-color="#000080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #0000FF;" data-color="#0000FF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #800080;" data-color="#800080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FF00FF;" data-color="#FF00FF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FFFFFF;" data-color="#FFFFFF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #C0C0C0;" data-color="#C0C0C0"></div>
        </div>
        <input id="colorPicker" type="color" style="width: 100%;" />
      </div>
      <!-- Stroke Size -->
      <div>
        <label for="strokeSize" style="font-size: 0.875rem;">Size</label>
        <input id="strokeSize" type="range" min="1" max="50" value="5" style="width: 100%;" aria-label="Brush stroke size" title="Adjust brush stroke size" />
      </div>
    </div>
  </div>

  <!-- Hidden text input for Text Tool -->
  <input type="text" id="textInput" style="position: absolute; border: 1px solid #9ca3af; padding: 0.25rem; display: none; font-size: 16px; line-height: 1; color: #000;" />
</div>
`}async function Hn(){window.toggleFileDropdown=function(y){y.stopPropagation();const b=document.getElementById("fileDropdown");b&&(b.style.display=b.style.display==="none"?"block":"none")},document.addEventListener("click",function(y){const b=document.getElementById("fileDropdown"),w=document.getElementById("fileMenuBtn");b&&w&&!w.contains(y.target)&&!b.contains(y.target)&&(b.style.display="none")});const e=document.getElementById("watercolourCanvas"),n=e.getContext("2d",{willReadFrequently:!0});let t=null,o=!1,r="brush",i,a,s="#000000",c=5,l=null,f=null,m=null;const u=document.getElementById("textInput"),p=document.getElementById("strokeSize"),d=document.getElementById("colorPicker");let g=[],v=[];p.addEventListener("input",y=>{c=y.target.value,n.lineWidth=c,r==="text"&&u.style.display==="block"&&(u.style.fontSize=`${c*4}px`),ce().catch(console.error)}),d.addEventListener("change",y=>{s=y.target.value,n.strokeStyle=s,n.fillStyle=s,r==="text"&&u.style.display==="block"&&(u.style.color=s),ce().catch(console.error)}),window.addEventListener("resize",$),document.body.addEventListener("touchmove",y=>{o&&y.preventDefault()},{passive:!1}),document.addEventListener("wheel",y=>{o&&y.preventDefault()},{passive:!1}),document.querySelectorAll(".tool-btn").forEach(y=>{y.addEventListener("click",()=>{document.querySelectorAll(".tool-btn").forEach(b=>b.classList.remove("bg-gray-100")),y.classList.add("bg-gray-100"),r=y.getAttribute("data-tool"),e.style.cursor=`url("./image/watercolour-icons/resized_${r}.png"), auto`,ce().catch(console.error)})}),document.getElementById("strokeSize").addEventListener("input",y=>{c=y.target.value,n.lineWidth=c}),document.getElementById("colorPicker").addEventListener("change",y=>{s=y.target.value,n.strokeStyle=s,n.fillStyle=s}),document.querySelectorAll("[data-color]").forEach(y=>{y.addEventListener("click",()=>{s=y.getAttribute("data-color"),n.strokeStyle=s,n.fillStyle=s,document.getElementById("colorPicker").value=s,ce().catch(console.error)})});let x=0;const F=3;function I(){if(x++,x>F){R();return}const y=document.getElementById("fileMenuBtn"),b=document.getElementById("fileDropdown"),w=document.getElementById("saveAsBtn");if(y&&b&&w){W();return}setTimeout(I,200)}function R(){const y=document.getElementById("loadBtn"),b=document.getElementById("newBtn"),w=document.getElementById("exportBtn");if(!y||!b||!w){console.error("Could not find expected buttons");return}y.addEventListener("click",()=>{J()}),b.addEventListener("click",()=>{showDialogBox("Clear canvas? Unsaved work will be lost.","confirmation",()=>{const B=e.offsetWidth,T=e.offsetHeight;n.clearRect(0,0,B,T),n.fillStyle="white",n.fillRect(0,0,B,T),l=e.toDataURL(),P(),m=null})}),w.addEventListener("click",()=>{const B=document.createElement("a");B.download="drawing.png",B.href=e.toDataURL(),B.click()})}function W(){const y=document.getElementById("fileMenuBtn"),b=document.getElementById("fileDropdown"),w=document.getElementById("saveAsBtn"),B=document.getElementById("loadBtn"),T=document.getElementById("newBtn"),O=document.getElementById("exportBtn");y.addEventListener("click",A=>{A.stopPropagation(),b.classList.toggle("hidden")}),document.addEventListener("click",A=>{!y.contains(A.target)&&!b.contains(A.target)&&b.classList.add("hidden")}),b.addEventListener("click",()=>{b.classList.add("hidden")}),w.addEventListener("click",async()=>{await oe()}),B.addEventListener("click",()=>{J()}),T.addEventListener("click",()=>{showDialogBox("Clear canvas? Unsaved work will be lost.","confirmation",()=>{const A=e.offsetWidth,L=e.offsetHeight;n.clearRect(0,0,A,L),n.fillStyle="white",n.fillRect(0,0,A,L),l=e.toDataURL(),P()})}),O.addEventListener("click",()=>{const A=document.createElement("a");A.download="drawing.png",A.href=e.toDataURL(),A.click()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",I):I(),e.addEventListener("pointerdown",y=>{y.preventDefault();const b=H(y);if(i=b.x,a=b.y,r==="fill"){P(),C(b.x,b.y,s),l=e.toDataURL(),P();return}if(o=!0,r==="brush"||r==="eraser")n.beginPath(),n.moveTo(i,a);else if(["line","rectangle","ellipse"].includes(r))f=document.createElement("canvas"),f.width=e.width,f.height=e.height,f.getContext("2d").drawImage(e,0,0);else if(r==="text"){const w=H(y);if(u.style.display==="block"){h();return}const B=e.getBoundingClientRect();u.style.left=B.left+w.x+"px",u.style.top=B.top+w.y+"px",u.style.display="block",u.style.fontSize=`${c*4}px`,u.style.color=s,u.dataset.x=w.x,u.dataset.y=w.y,setTimeout(()=>{u.focus(),u.onblur=h},0),u.onkeydown=T=>{T.key==="Enter"&&h()}}}),e.addEventListener("pointermove",y=>{const b=H(y);if(N(b.x,b.y),!!o){if(y.preventDefault(),r==="brush")n.lineTo(b.x,b.y),n.stroke();else if(r==="eraser")n.strokeStyle="white",n.lineTo(b.x,b.y),n.stroke(),n.strokeStyle=s;else if(["line","rectangle","ellipse"].includes(r)){const w=e.offsetWidth,B=e.offsetHeight;n.clearRect(0,0,w,B),f&&n.drawImage(f,0,0,w,B),k(b.x,b.y)}}}),e.addEventListener("pointerup",y=>{const b=H(y);o&&["line","rectangle","ellipse"].includes(r)&&k(b.x,b.y,!0),o=!1,l=e.toDataURL(),P(),f=null}),e.addEventListener("click",y=>{const b=H(y);if(r==="picker"){const w=window.devicePixelRatio||1,B=n.getImageData(Math.floor(b.x*w),Math.floor(b.y*w),1,1).data;s=X(B[0],B[1],B[2]),n.strokeStyle=s,n.fillStyle=s,document.getElementById("colorPicker").value=s,ce().catch(console.error)}}),document.getElementById("undoBtn").addEventListener("click",()=>{if(g.length>1){const y=g.pop();v.push(y);const b=g[g.length-1];j(b),l=b,ce().catch(console.error)}}),document.getElementById("redoBtn").addEventListener("click",()=>{if(v.length){const y=v.pop();g.push(y),j(y),l=y,ce().catch(console.error)}});function P(){const y=e.toDataURL();g.push(y),l=y,v=[],ce().catch(console.error)}function j(y){const b=new Image;b.src=y,b.alt="Watercolour painting canvas state",b.onload=()=>{const w=e.offsetWidth,B=e.offsetHeight;n.clearRect(0,0,w,B),n.drawImage(b,0,0,w,B)}}function H(y){const b=e.getBoundingClientRect();return{x:y.clientX-b.left,y:y.clientY-b.top}}function $(){const y=window.devicePixelRatio||1,b=e.offsetWidth,w=e.offsetHeight;if(n.getImageData(0,0,e.width,e.height),e.width=b*y,e.height=w*y,e.style.width=b+"px",e.style.height=w+"px",n.setTransform(y,0,0,y,0,0),l){const B=new Image;B.src=l,B.alt="Saved watercolour painting for canvas restoration",B.onload=()=>{n.clearRect(0,0,b,w),n.drawImage(B,0,0,b,w)}}else n.fillStyle="white",n.fillRect(0,0,b,w)}function N(y,b){const w=document.getElementById("status");w.textContent=`Tool: ${r.charAt(0).toUpperCase()+r.slice(1)} | x: ${Math.floor(y)}, y: ${Math.floor(b)}`}function h(){const y=parseFloat(u.dataset.x),b=parseFloat(u.dataset.y),w=u.value;u.style.display="none",u.value="",u.onblur=null,n.fillStyle=s,n.font=`${c*4}px sans-serif`,n.textBaseline="top",n.fillText(w,y,b),P()}function k(y,b,w=!1){const B=i,T=a,O=y-i,A=b-a;n.lineWidth=c,n.strokeStyle=s,n.fillStyle=s,r==="line"?(n.beginPath(),n.moveTo(B,T),n.lineTo(y,b),n.stroke()):r==="rectangle"?n.strokeRect(B,T,O,A):r==="ellipse"&&(n.beginPath(),n.ellipse(B+O/2,T+A/2,Math.abs(O/2),Math.abs(A/2),0,0,Math.PI*2),n.stroke())}function C(y,b,w){const B=window.devicePixelRatio||1,T=e.width,O=e.height,A=n.getImageData(0,0,T,O),L=A.data,U=z(w),re=U.r,de=U.g,te=U.b,q=Math.floor(y*B),me=Math.floor(b*B),se=(me*T+q)*4,Se=L[se],he=L[se+1],De=L[se+2],nt=L[se+3];if(Se===re&&he===de&&De===te)return;const ot=[[q,me]];for(;ot.length;){const[Be,No]=ot.pop();let Ee=No;for(;Ee>=0&&E(L,Be,Ee,T,Se,he,De,nt);)Ee--;Ee++;let $t=!1,Pt=!1;for(;Ee<O&&E(L,Be,Ee,T,Se,he,De,nt);){const rt=(Ee*T+Be)*4;L[rt]=re,L[rt+1]=de,L[rt+2]=te,L[rt+3]=255,Be>0&&(E(L,Be-1,Ee,T,Se,he,De,nt)?$t||(ot.push([Be-1,Ee]),$t=!0):$t=!1),Be<T-1&&(E(L,Be+1,Ee,T,Se,he,De,nt)?Pt||(ot.push([Be+1,Ee]),Pt=!0):Pt=!1),Ee++}}n.putImageData(A,0,0)}function E(y,b,w,B,T,O,A,L){const U=(w*B+b)*4;return y[U]===T&&y[U+1]===O&&y[U+2]===A&&y[U+3]===L}function z(y){y=y.replace(/^#/,"");let b=parseInt(y,16);return y.length===3?{r:(b>>8)*17,g:(b>>4&15)*17,b:(b&15)*17}:{r:b>>16&255,g:b>>8&255,b:b&255}}function X(y,b,w){return"#"+((1<<24)+(y<<16)+(b<<8)+w).toString(16).slice(1)}async function oe(){try{const y=e.toDataURL("image/png"),b=globalStorage,w=globalAddFileToFileSystem;if(!b){showDialogBox("Cannot access storage. Please ensure the main OS is loaded.","error");return}const B=Date.now(),T=`watercolour_drawing_${B}`;await b.setItem(T,y),makeWin95Prompt("Enter a filename for your drawing:",`drawing_${B}.png`,async O=>{if(O){const A=O.endsWith(".png")?O:O+".png",L=Ae();if(w){const U=y.split(",")[1],re=atob(U),de=new Uint8Array(re.length);for(let se=0;se<re.length;se++)de[se]=re.charCodeAt(se);const te=new Blob([de],{type:"image/png"}),q=new File([te],A,{type:"image/png"}),me=await w(A,y,L,"png",q);m={name:A,path:L,storageKey:T,data:y},refreshExplorerViews&&refreshExplorerViews(),L==="C://Desktop"&&renderDesktopIcons&&renderDesktopIcons(),showDialogBox(`Drawing saved as "${A}" in ${L}!`,"info")}else showDialogBox("File system not available. Drawing saved to storage only.","info")}else showDialogBox("Drawing saved to storage but not added to file system.","info")},()=>{showDialogBox("Drawing saved to storage but not added to file system.","info")})}catch(y){console.error("Error saving drawing:",y),showDialogBox("Error saving drawing: "+y.message,"error")}}function J(){if(openFileExplorerForImageSelection)openFileExplorerForImageSelection((y,b)=>{y&&pe(y,b)});else if(Z&&getExplorerWindowContent){window.watercolourLoadCallback=(b,w)=>{b&&pe(b,w)};const y=getExplorerWindowContent("C://Documents");Z("Select Image - File Explorer",y,!0,"explorer-watercolour-load",!1,!1,{type:"integer",width:600,height:500},"file-explorer"),showDialogBox("Select an image file from the file explorer to load it onto the canvas.","info")}else showDialogBox("File explorer not available. Please ensure the main OS is loaded.","error")}function pe(y,b=null){const w=new Image;w.alt="Image to be loaded onto watercolour canvas",w.onload=()=>{const B=e.offsetWidth,T=e.offsetHeight;n.clearRect(0,0,B,T),n.fillStyle="white",n.fillRect(0,0,B,T);const O=Math.min(B/w.width,T/w.height),A=w.width*O,L=w.height*O,U=(B-A)/2,re=(T-L)/2;n.drawImage(w,U,re,A,L),l=e.toDataURL(),P()},w.onerror=()=>{console.error("Error loading selected image."),showDialogBox("Error loading selected image.","error")},w.src=y,w.alt="User-selected image to import into watercolour canvas"}function Ae(){if(parent&&parent.document){const y=parent.document.querySelectorAll(".file-explorer-window");if(y.length>0){const w=y[y.length-1].getAttribute("data-current-path");if(w)return w}}return"C://Documents"}async function ce(){try{const y={currentTool:r,activeColor:s,strokeSize:c,canvasData:e.toDataURL(),currentFile:m,undoStack:g.slice(-10),redoStack:v.slice(-10)};await storage.setItem("watercolour_state",y)}catch(y){console.warn("Failed to save Watercolour state:",y);try{const b={currentTool:r,activeColor:s,strokeSize:c,canvasData:e.toDataURL(),currentFile:m,undoStack:g.slice(-10),redoStack:v.slice(-10)};storage.setItemSync("watercolour_state",b)}catch(b){console.error("Failed to save Watercolour state with fallback:",b)}}}async function ke(){try{const y=await storage.getItem("watercolour_state");if(y)return y}catch(y){console.warn("Failed to load Watercolour state:",y);try{const b=storage.getItemSync("watercolour_state");if(b)return b}catch(b){console.warn("Failed to load Watercolour state with fallback:",b)}}return null}async function D(){t=await ke(),t&&(r=t.currentTool||"brush",s=t.activeColor||"#000000",c=t.strokeSize||5,m=t.currentFile||null,g=t.undoStack||[],v=t.redoStack||[]);const y=window.devicePixelRatio||1,b=e.offsetWidth,w=e.offsetHeight;e.width=b*y,e.height=w*y,e.style.width=b+"px",e.style.height=w+"px",n.setTransform(y,0,0,y,0,0),p&&(p.value=c),d&&(d.value=s),n.strokeStyle=s,n.fillStyle=s,n.lineWidth=c,document.querySelectorAll(".tool-btn").forEach(T=>{T.classList.remove("bg-gray-100"),T.getAttribute("data-tool")===r&&T.classList.add("bg-gray-100")});const B=t==null?void 0:t.canvasData;if(B){const T=new Image;T.alt="Saved watercolour canvas state for restoration",T.onload=function(){n.clearRect(0,0,b,w),n.drawImage(T,0,0,b,w)},T.src=B}else n.fillStyle="white",n.fillRect(0,0,b,w),P()}await D()}function tr(e,n){const t={C:"Clear all",CE:"Clear entry","±":"Change sign","√":"Square root","%":"Percent","1/x":"Reciprocal","=":"Equals","+":"Plus","-":"Minus","×":"Multiply","÷":"Divide",".":"Decimal point"};return t[e]?t[e]:n==="number"?`Number ${e}`:n==="operator"?`Operator ${e}`:e}function Un(){const e=document.getElementById("calculator");if(e){const o=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,i)=>getComputedStyle(i).zIndex>getComputedStyle(r).zIndex?i:r);e.style.zIndex=`${parseInt(o.style.zIndex)+1}`;return}const n=Z("Calculator","",!1,"calculator",!1,!1,{type:"integer",width:250,height:360},"App",null,"gray-100");Kn(n).catch(t=>{console.error("Error initializing Calculator:",t)})}async function Kn(e){const n=e.querySelector(".p-2");n.className="p-4 bg-gray-100 h-full overflow-hidden",n.innerHTML="";let t=await or();t||(t={display:"0",previousValue:null,operation:null,waitingForOperand:!1});const o=document.createElement("div");o.className="flex flex-col h-full space-y-1 pb-6";const r=document.createElement("div");r.className="bg-white border-2 p-2 mb-2",r.style.borderTopColor="#808080",r.style.borderLeftColor="#808080",r.style.borderBottomColor="#ffffff",r.style.borderRightColor="#ffffff";const i=document.createElement("div");i.id="calc-display",i.className="text-right text-lg font-mono bg-white text-black min-h-6 px-1",i.textContent=t.display,r.appendChild(i);const a=document.createElement("div");a.className="grid grid-cols-4 gap-1 flex-1",[{text:"C",type:"clear",className:"col-span-2"},{text:"±",type:"sign"},{text:"/",type:"operator"},{text:"7",type:"number"},{text:"8",type:"number"},{text:"9",type:"number"},{text:"*",type:"operator"},{text:"4",type:"number"},{text:"5",type:"number"},{text:"6",type:"number"},{text:"-",type:"operator"},{text:"1",type:"number"},{text:"2",type:"number"},{text:"3",type:"number"},{text:"+",type:"operator"},{text:"0",type:"number",className:"col-span-2"},{text:".",type:"decimal"},{text:"=",type:"equals"}].forEach(p=>{const d=document.createElement("button");d.textContent=p.text,d.className=`bg-gray-200 border-2 hover:bg-gray-300 font-mono text-sm py-2 select-none ${p.className||""}`,d.style.borderTopColor="#ffffff",d.style.borderLeftColor="#ffffff",d.style.borderBottomColor="#808080",d.style.borderRightColor="#808080",d.style.transition="none";const g=tr(p.text,p.type);d.setAttribute("aria-label",g),d.setAttribute("title",g),d.addEventListener("mousedown",()=>{d.style.borderTopColor="#808080",d.style.borderLeftColor="#808080",d.style.borderBottomColor="#ffffff",d.style.borderRightColor="#ffffff",d.classList.add("bg-gray-300")}),d.addEventListener("mouseup",()=>{d.style.borderTopColor="#ffffff",d.style.borderLeftColor="#ffffff",d.style.borderBottomColor="#808080",d.style.borderRightColor="#808080",d.classList.remove("bg-gray-300")}),d.addEventListener("mouseleave",()=>{d.style.borderTopColor="#ffffff",d.style.borderLeftColor="#ffffff",d.style.borderBottomColor="#808080",d.style.borderRightColor="#808080",d.classList.remove("bg-gray-300")}),d.addEventListener("click",async()=>await l(p.text,p.type)),a.appendChild(d)}),o.appendChild(r),o.appendChild(a),n.appendChild(o);async function c(){i.textContent=t.display,await nr(t)}async function l(p,d){switch(d){case"number":t.waitingForOperand?(t.display=p,t.waitingForOperand=!1):t.display=t.display==="0"?p:t.display+p;break;case"decimal":t.waitingForOperand?(t.display="0.",t.waitingForOperand=!1):t.display.indexOf(".")===-1&&(t.display+=".");break;case"clear":t.display="0",t.previousValue=null,t.operation=null,t.waitingForOperand=!1;break;case"sign":t.display!=="0"&&(t.display=t.display.charAt(0)==="-"?t.display.slice(1):"-"+t.display);break;case"operator":const g=parseFloat(t.display);if(t.previousValue===null)t.previousValue=g;else if(t.operation){const x=t.previousValue||0,F=f(x,g,t.operation);t.display=String(F),t.previousValue=F}t.waitingForOperand=!0,t.operation=p;break;case"equals":const v=parseFloat(t.display);if(t.previousValue!==null&&t.operation){const x=t.previousValue||0,F=f(x,v,t.operation);t.display=String(F),t.previousValue=null,t.operation=null,t.waitingForOperand=!0}break}await c()}function f(p,d,g){switch(g){case"+":return p+d;case"-":return p-d;case"*":return p*d;case"/":return d!==0?p/d:0;default:return d}}async function m(p){const d=p.key;/[0-9]/.test(d)?await l(d,"number"):["+","-","*","/"].includes(d)?await l(d,"operator"):d==="."?await l(d,"decimal"):d==="Enter"||d==="="?await l("=","equals"):d==="Escape"||d==="c"||d==="C"?await l("C","clear"):d==="Backspace"&&(t.display.length>1?t.display=t.display.slice(0,-1):t.display="0",await c())}document.addEventListener("keydown",m);const u=new MutationObserver(p=>{p.forEach(d=>{d.removedNodes.forEach(g=>{g.id==="calculator"&&(document.removeEventListener("keydown",m),u.disconnect())})})});u.observe(document.getElementById("windows-container"),{childList:!0})}async function nr(e){try{await M.setItem("calculator_state",e)}catch(n){console.warn("Failed to save Calculator state:",n)}}async function or(){try{const e=await M.getItem("calculator_state");if(e)return e}catch(e){console.warn("Failed to load Calculator state:",e)}return null}function Yn(){const e=document.getElementById("solitaire");if(e){const o=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,i)=>getComputedStyle(i).zIndex>getComputedStyle(r).zIndex?i:r);e.style.zIndex=`${parseInt(o.style.zIndex)+1}`;return}const n=Z("Solitaire","",!1,"solitaire",!1,!1,{type:"integer",width:700,height:500},"App",null,"green");Gn(n).catch(console.error)}async function Gn(e){const n=e.querySelector(".p-2");n.className="p-2 bg-green-600 h-full overflow-hidden",n.style.backgroundImage="radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1) 0%, transparent 50%)",n.innerHTML="";let t=await rr();t||(t={deck:[],waste:[],foundations:[[],[],[],[]],tableaus:[[],[],[],[],[],[],[]],score:0,moves:0,time:0,gameStarted:!1,selectedCard:null,selectedPile:null,dragElement:null});let o=null;const r=["♠","♣","♥","♦"],i=["A","2","3","4","5","6","7","8","9","10","J","Q","K"],a={"♠":"black","♣":"black","♥":"red","♦":"red"},s=document.createElement("div");s.className="flex flex-col h-full";const c=document.createElement("div");c.className="bg-gray-200 border-b border-gray-400 p-1 flex items-center space-x-4";const l=document.createElement("button");l.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",l.textContent="Game",l.setAttribute("aria-label","Game menu options"),l.setAttribute("title","Access game options and settings");const f=document.createElement("button");f.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",f.textContent="New Game",f.setAttribute("aria-label","Start new solitaire game"),f.setAttribute("title","Start a new game of solitaire"),f.addEventListener("click",pe);const m=document.createElement("div");m.className="text-sm font-mono ml-auto flex space-x-4",m.innerHTML='<span>Score: <span id="score">0</span></span><span>Time: <span id="time">0:00</span></span>',c.appendChild(f),c.appendChild(m);const u=document.createElement("div");u.className="flex-1 p-4 relative overflow-scroll",u.id="solitaire-game-area";const p=document.createElement("div");p.className="lg:flex justify-between mb-6";const d=document.createElement("div");d.className="flex space-x-4 mb-4 lg:mb-0";const g=document.createElement("div");g.className="w-16 h-24 border-2 border-gray-400 rounded bg-blue-800 flex items-center justify-center cursor-pointer",g.style.borderStyle="outset",g.id="deck-slot",g.addEventListener("click",j);const v=document.createElement("div");v.className="w-16 h-24 border-2 border-gray-400 rounded bg-green-700 relative",v.style.borderStyle="inset",v.id="waste-slot",d.appendChild(g),d.appendChild(v);const x=document.createElement("div");x.className="flex space-x-2";for(let D=0;D<4;D++){const y=document.createElement("div");y.className="w-16 h-24 border-2 border-gray-400 rounded bg-green-700 relative",y.style.borderStyle="inset",y.id=`foundation-${D}`,y.dataset.foundationIndex=D,y.addEventListener("click",b=>void 0),x.appendChild(y)}p.appendChild(d),p.appendChild(x);const F=document.createElement("div");F.className="flex space-x-2";for(let D=0;D<7;D++){const y=document.createElement("div");y.className="w-16 min-h-32 relative",y.id=`tableau-${D}`,y.dataset.tableauIndex=D,y.addEventListener("click",b=>void 0),F.appendChild(y)}u.appendChild(p),u.appendChild(F),s.appendChild(c),s.appendChild(u),n.appendChild(s);function I(D,y,b=!0){const w=document.createElement("div");if(w.className="card absolute w-16 h-24 border border-gray-800 rounded bg-white cursor-pointer transition-all duration-200",w.style.fontSize="10px",w.style.userSelect="none",w.style.pointerEvents="auto",w.dataset.suit=D,w.dataset.value=y,w.dataset.faceUp=b,b){const B=a[D];w.style.color=B,w.innerHTML=`
        <div class="p-1 h-full flex flex-col justify-between">
          <div class="flex justify-between">
            <span class="font-bold">${y}</span>
            <span class="text-lg">${D}</span>
          </div>
          <div class="text-center text-2xl">${D}</div>
          <div class="flex justify-between rotate-180">
            <span class="font-bold">${y}</span>
            <span class="text-lg">${D}</span>
          </div>
        </div>
      `}else w.style.background="linear-gradient(45deg, #000080, #0000cd)",w.style.color="white",w.innerHTML=`
        <div class="w-full h-full flex items-center justify-center text-xs">
          <div class="text-center">♠♥♦♣</div>
        </div>
      `;return w.addEventListener("mousedown",H),w.addEventListener("touchstart",H,{passive:!1}),w.addEventListener("dblclick",N),w}function R(){t.deck=[];for(const D of r)for(const y of i)t.deck.push({suit:D,value:y});for(let D=t.deck.length-1;D>0;D--){const y=Math.floor(Math.random()*(D+1));[t.deck[D],t.deck[y]]=[t.deck[y],t.deck[D]]}}function W(){t.waste=[],t.foundations=[[],[],[],[]],t.tableaus=[[],[],[],[],[],[],[]];for(let D=0;D<7;D++)for(let y=0;y<=D;y++){const b=t.deck.pop();b.faceUp=y===D,t.tableaus[D].push(b)}P(),$e(t).catch(console.error)}function P(){document.querySelectorAll(".card").forEach(b=>b.remove());const D=document.getElementById("deck-slot");t.deck.length>0?(D.innerHTML="🂠",D.style.fontSize="40px",D.style.color="white"):(D.innerHTML="↻",D.style.fontSize="24px",D.style.color="white");const y=document.getElementById("waste-slot");if(y.innerHTML="",t.waste.length>0){const b=t.waste[t.waste.length-1],w=I(b.suit,b.value,!0);w.classList.add("card"),w.style.position="absolute",w.style.top="0",w.style.left="0",y.appendChild(w)}for(let b=0;b<4;b++){const w=document.getElementById(`foundation-${b}`);w.innerHTML="";const B=r[b];if(w.innerHTML=`<div class="absolute inset-0 flex items-center justify-center text-4xl text-gray-500 opacity-30">${B}</div>`,t.foundations[b].length>0){const T=t.foundations[b][t.foundations[b].length-1],O=I(T.suit,T.value,!0);O.classList.add("card"),O.style.position="absolute",O.style.top="0",O.style.left="0",w.appendChild(O)}}for(let b=0;b<7;b++){const w=document.getElementById(`tableau-${b}`);w.innerHTML="",t.tableaus[b].length===0&&(w.innerHTML='<div class="w-16 h-24 border-2 border-gray-400 border-dashed rounded bg-green-700 opacity-50"></div>'),t.tableaus[b].forEach((B,T)=>{const O=I(B.suit,B.value,B.faceUp);O.classList.add("card"),O.style.position="absolute",O.style.top=`${T*20}px`,O.style.left="0",O.style.zIndex=T+1,O.dataset.tableauIndex=b,O.dataset.cardIndex=T,w.appendChild(O)})}J()}function j(){if(t.deck.length>0){const D=t.deck.pop();D.faceUp=!0,t.waste.push(D),t.moves++}else t.waste.length>0&&(t.deck=t.waste.reverse(),t.deck.forEach(D=>D.faceUp=!1),t.waste=[],t.moves++);P(),$e(t).catch(console.error)}function H(D){let y=D.target;for(;y&&y!==document.body&&!(y.classList&&y.classList.contains("card"));)y=y.parentElement;if(!y||!y.classList.contains("card")||y.dataset.faceUp!=="true")return;D.preventDefault(),D.stopPropagation(),t.selectedCard=y,t.dragElement=y.cloneNode(!0),t.dragElement.style.position="fixed",t.dragElement.style.pointerEvents="none",t.dragElement.style.zIndex="1000",t.dragElement.style.transform="rotate(5deg)";const b=D.type==="touchstart"?D.touches[0]:D;t.dragElement.style.left=b.clientX-32+"px",t.dragElement.style.top=b.clientY-48+"px",document.body.appendChild(t.dragElement),y.style.opacity="0.5";function w(T){if(t.dragElement){const O=T.type==="touchmove"?T.touches[0]:T;t.dragElement.style.left=O.clientX-32+"px",t.dragElement.style.top=O.clientY-48+"px"}}function B(T){if(document.removeEventListener("mousemove",w),document.removeEventListener("mouseup",B),document.removeEventListener("touchmove",w),document.removeEventListener("touchend",B),t.dragElement&&(document.body.removeChild(t.dragElement),t.dragElement=null),t.selectedCard){t.selectedCard.style.opacity="1";const O=T.type==="touchend"?T.changedTouches[0]:T,A=document.elementFromPoint(O.clientX,O.clientY);$(A),t.selectedCard=null}}document.addEventListener("mousemove",w),document.addEventListener("mouseup",B),document.addEventListener("touchmove",w,{passive:!1}),document.addEventListener("touchend",B)}function $(D){const y=t.selectedCard;if(!y||!D)return;let b=D,w=null,B=null;for(;b&&b!==document.body;){if(b.id&&b.id.startsWith("foundation-")){w=b,B="foundation";break}if(b.dataset&&b.dataset.tableauIndex!==void 0){w=b,B="tableau";break}if(b.classList&&b.classList.contains("card")&&b.dataset.tableauIndex!==void 0){w=b.parentElement,B="tableau";break}b=b.parentElement}if(w&&B==="foundation"){const T=parseInt(w.dataset.foundationIndex);h(y,T)&&C(y)}else if(w&&B==="tableau"){const T=parseInt(w.dataset.tableauIndex);k(y,T)&&E(y,T)}}function N(D){let y=D.target;for(;y&&!y.classList.contains("card");)y=y.parentElement;if(!(!y||y.dataset.faceUp!=="true")){for(let b=0;b<4;b++)if(h(y,b)){C(y);return}}}function h(D,y){const b=D.dataset.suit,w=D.dataset.value,B=t.foundations[y],T=r[y];if(b!==T){const O=r.indexOf(b);return O!==-1&&t.foundations[O].length===0?w==="A":!1}if(B.length===0)return w==="A";{const O=B[B.length-1],A=i.indexOf(O.value);return i.indexOf(w)===A+1}}function k(D,y){const b=D.dataset.suit,w=D.dataset.value,B=t.tableaus[y];if(B.length===0)return w==="K";const T=B[B.length-1];if(!T.faceUp)return!1;const O=a[T.suit],A=a[b],L=i.indexOf(T.value),U=i.indexOf(w);return O!==A&&U===L-1}function C(D,y){const b=D.dataset.suit,w=r.indexOf(b);if(w===-1)return;z(D);const B={suit:b,value:D.dataset.value,faceUp:!0};t.foundations[w].push(B),t.moves++,t.score+=10,P(),ce(),$e(t).catch(console.error)}function E(D,y){const b=z(D,!0);t.tableaus[y].push(...b),t.moves++,P(),$e(t).catch(console.error)}function z(D,y=!1){const b=D.dataset.suit,w=D.dataset.value;if(t.waste.length>0&&t.waste[t.waste.length-1].suit===b&&t.waste[t.waste.length-1].value===w)return[t.waste.pop()];for(let B=0;B<7;B++){const T=t.tableaus[B],O=T.findIndex(A=>A.suit===b&&A.value===w);if(O!==-1){const A=y?T.length-O:1,L=T.splice(O,A);return T.length>0&&!T[T.length-1].faceUp&&(T[T.length-1].faceUp=!0,t.score+=5,$e(t).catch(console.error)),L}}return[]}function X(D,y){}function oe(D,y){}function J(){if(document.getElementById("score").textContent=t.score,t.gameStarted){const D=Math.floor(t.time/60),y=t.time%60;document.getElementById("time").textContent=`${D}:${y.toString().padStart(2,"0")}`}}function pe(){t.score=0,t.moves=0,t.time=0,t.gameStarted=!0,o&&clearInterval(o),o=setInterval(()=>{t.time++,J(),$e(t).catch(console.error)},1e3),R(),W(),ir().catch(console.error)}function Ae(){t.gameStarted&&(o=setInterval(()=>{t.time++,J(),$e(t).catch(console.error)},1e3)),J(),P()}function ce(){t.foundations.reduce((y,b)=>y+b.length,0)===52&&(o&&clearInterval(o),$e(t).catch(console.error),setTimeout(()=>{ar()},500))}const ke=new MutationObserver(D=>{D.forEach(y=>{y.removedNodes.forEach(b=>{b.id==="solitaire"&&(o&&clearInterval(o),ke.disconnect())})})});ke.observe(document.getElementById("windows-container"),{childList:!0}),!t.gameStarted||t.deck.length===0?pe():Ae()}async function $e(e){try{const n={...e,selectedCard:null,selectedPile:null,dragElement:null};await M.setItem("solitaire_gameState",n)}catch(n){console.warn("Failed to save Solitaire game state:",n);try{const t={...e,selectedCard:null,selectedPile:null,dragElement:null};M.setItemSync("solitaire_gameState",t)}catch(t){console.error("Failed to save Solitaire game state with fallback:",t)}}}async function rr(){try{const e=await M.getItem("solitaire_gameState");if(e){const n=e;return n.selectedCard=null,n.selectedPile=null,n.dragElement=null,n}}catch(e){console.warn("Failed to load Solitaire game state:",e);try{const n=M.getItemSync("solitaire_gameState");if(n){const t=n;return t.selectedCard=null,t.selectedPile=null,t.dragElement=null,t}}catch(n){console.warn("Failed to load Solitaire game state with fallback:",n)}}return null}async function ir(){try{await M.removeItem("solitaire_gameState")}catch(e){console.warn("Failed to clear Solitaire game state:",e);try{M.removeItemSync("solitaire_gameState")}catch(n){console.error("Failed to clear Solitaire game state with fallback:",n)}}}function ar(){const e=document.createElement("canvas");e.id="solitaire-win-canvas",Object.assign(e.style,{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",zIndex:9999,pointerEvents:"none"}),document.body.appendChild(e);const n=e.getContext("2d");e.width=window.innerWidth,e.height=window.innerHeight;const t=["♠","♥","♣","♦"],o=["A","2","3","4","5","6","7","8","9","10","J","Q","K"],r={"♠":"black","♣":"black","♥":"red","♦":"red"},i=[],a=.2,s=75,c=100,l=.02;let f=0,m,u=!0;const p=setInterval(()=>{if(f===52)return clearInterval(p);const g=t[f%4],v=o[Math.floor(f/4)];i.push({x:Math.random()*e.width,y:-50,vx:(Math.random()-.5)*4,vy:Math.random()*2,suit:g,value:v,color:r[g]}),f++},100);function d(){n.fillStyle=`rgba(10,100,10,${l})`,n.fillRect(0,0,e.width,e.height),i.forEach(g=>{g.vy+=a,g.x+=g.vx,g.y+=g.vy,g.y>e.height-c&&(g.y=e.height-c,g.vy*=-.7),n.fillStyle="white",n.fillRect(g.x,g.y,s,c),n.strokeStyle="#333",n.strokeRect(g.x,g.y,s,c),n.fillStyle=g.color,n.font="24px sans-serif",n.fillText(g.value+g.suit,g.x+10,g.y+30)}),u&&(m=requestAnimationFrame(d))}d(),setTimeout(()=>{u=!1,clearInterval(p),cancelAnimationFrame(m),document.body.removeChild(e),showDialogBox("Congratulations! You won!","confirmation")},8e3)}function Zn(){const e=document.getElementById("chess");if(e){const o=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,i)=>getComputedStyle(i).zIndex>getComputedStyle(r).zIndex?i:r);e.style.zIndex=`${parseInt(o.style.zIndex)+1}`;return}const n=Z("Guillotine Chess","",!1,"chess",!1,!1,{type:"integer",width:600,height:690},"App",null,"white");Vn(n).catch(t=>{console.error("Error initializing Chess:",t)})}async function Vn(e){const n=e.querySelector(".p-2");n.className="p-4 bg-white h-full overflow-hidden",n.innerHTML="";let t=await br();t||(t={board:fn(),currentPlayer:"white",difficulty:"easy",gameOver:!1,winner:null,moveHistory:[],selectedSquare:null,possibleMoves:[],gameStarted:!0,enPassantTarget:null,halfMoveClock:0,fullMoveNumber:1});const o=document.createElement("div");o.className="flex flex-col h-full";const r=document.createElement("div");r.className="flex justify-between items-center mb-4 p-2 bg-gray-100 rounded",r.innerHTML=`
    <div class="flex items-center space-x-4">
      <span class="font-semibold">Difficulty: <span id="difficulty-dropdown-container"></span></span>
      <span class="font-semibold">Turn: <span class="text-${t.currentPlayer==="white"?"gray-800":"gray-600"}">${t.currentPlayer.charAt(0).toUpperCase()+t.currentPlayer.slice(1)}</span></span>
    </div>
    <div class="space-x-2" id="button-container">
    </div>
  `,o.appendChild(r);const a=wr([{value:"easy",text:"Easy"},{value:"medium",text:"Medium"},{value:"hard",text:"Hard"}],t.difficulty,async m=>{t.difficulty=m,await ft(t)});a.id="difficulty-select",a.className+=" ml-1",r.querySelector("#difficulty-dropdown-container").appendChild(a);const s=hr("New Game");s.id="new-game-btn",r.querySelector("#button-container").appendChild(s);const c=document.createElement("div");c.className="flex-1 flex items-center justify-center";const l=document.createElement("div");l.id="chess-board",l.className="grid grid-cols-8 border-4 border-gray-800",l.style.width="480px",l.style.height="480px",l.style.gap="0";for(let m=0;m<8;m++)for(let u=0;u<8;u++){const p=document.createElement("div");p.className=`chess-square flex items-center justify-center cursor-pointer text-4xl font-bold select-none ${(m+u)%2===0?"bg-amber-100":"bg-amber-600"}`,p.style.width="60px",p.style.height="60px",p.dataset.row=m,p.dataset.col=u;const d=t.board[m][u];d&&(p.textContent=Xn(d),p.style.color=d.color==="white"?"#000":"#444"),p.addEventListener("click",async()=>await sr(m,u,t,e)),l.appendChild(p)}c.appendChild(l),o.appendChild(c);const f=document.createElement("div");f.id="status-bar",f.className="mt-4 p-2 text-center",t.gameOver?f.innerHTML=`<span class="text-lg font-bold text-green-600">Game Over! ${t.winner?t.winner.charAt(0).toUpperCase()+t.winner.slice(1)+" wins!":"Draw!"}</span>`:f.innerHTML='<span class="text-gray-600">Guillotine Chess: Capture the King to win! Kings can be captured like any other piece.</span>',o.appendChild(f),r.querySelector("#new-game-btn").addEventListener("click",async()=>{t.board=fn(),t.currentPlayer="white",t.gameOver=!1,t.winner=null,t.moveHistory=[],t.selectedSquare=null,t.possibleMoves=[],await ft(t),Xt(t,e)}),n.appendChild(o),pt(t),t.currentPlayer==="black"&&!t.gameOver&&setTimeout(async()=>await to(t,e),500)}function Xt(e,n){const t=n.querySelector("#difficulty-select");t&&(t.value=e.difficulty);const o=n.querySelector(".text-gray-800, .text-gray-600");o&&o.parentElement&&o.parentElement.textContent.includes("Turn:")&&(o.textContent=e.currentPlayer.charAt(0).toUpperCase()+e.currentPlayer.slice(1),o.className=e.currentPlayer==="white"?"text-gray-800":"text-gray-600"),document.querySelectorAll(".chess-square").forEach(a=>{const s=parseInt(a.dataset.row),c=parseInt(a.dataset.col),l=e.board[s][c];l?(a.textContent=Xn(l),a.style.color=l.color==="white"?"#000":"#444"):a.textContent=""});const i=n.querySelector("#status-bar");i&&(e.gameOver?i.innerHTML=`<span class="text-lg font-bold text-green-600">Game Over! ${e.winner?e.winner.charAt(0).toUpperCase()+e.winner.slice(1)+" wins!":"Draw!"}</span>`:i.innerHTML='<span class="text-gray-600">Guillotine Chess: Capture the King to win! Kings can be captured like any other piece.</span>'),e.selectedSquare=null,e.possibleMoves=[],pt(e),e.currentPlayer==="black"&&!e.gameOver&&setTimeout(async()=>await to(e,n),500)}function fn(){const e=Array(8).fill(null).map(()=>Array(8).fill(null)),n=["rook","knight","bishop","queen","king","bishop","knight","rook"];for(let t=0;t<8;t++)e[0][t]={type:n[t],color:"black"},e[1][t]={type:"pawn",color:"black"};for(let t=0;t<8;t++)e[6][t]={type:"pawn",color:"white"},e[7][t]={type:n[t],color:"white"};return e}function Xn(e){return{white:{king:"♔",queen:"♕",rook:"♖",bishop:"♗",knight:"♘",pawn:"♙"},black:{king:"♚",queen:"♛",rook:"♜",bishop:"♝",knight:"♞",pawn:"♟"}}[e.color][e.type]}async function sr(e,n,t,o){if(t.gameOver||t.currentPlayer==="black")return;const r=t.board[e][n];if(t.selectedSquare){const[i,a]=t.selectedSquare;if(i===e&&a===n){t.selectedSquare=null,t.possibleMoves=[],pt(t);return}if(t.possibleMoves.some(s=>s.row===e&&s.col===n)){eo(t,i,a,e,n),t.selectedSquare=null,t.possibleMoves=[],t.currentPlayer=t.currentPlayer==="white"?"black":"white",await ft(t),oo(t)&&(t.gameOver=!0,t.winner=ro(t)),Xt(t,o);return}}r&&r.color===t.currentPlayer&&(t.selectedSquare=[e,n],t.possibleMoves=St(t,e,n),pt(t))}function pt(e){document.querySelectorAll(".chess-square").forEach(t=>{const o=parseInt(t.dataset.row),r=parseInt(t.dataset.col);t.className=`chess-square flex items-center justify-center cursor-pointer text-4xl font-bold select-none ${(o+r)%2===0?"bg-amber-100":"bg-amber-600"}`,t.style.width="60px",t.style.height="60px",e.selectedSquare&&e.selectedSquare[0]===o&&e.selectedSquare[1]===r&&(t.className+=" bg-blue-300"),e.possibleMoves.some(i=>i.row===o&&i.col===r)&&(t.className+=" bg-green-300")})}function St(e,n,t){const o=e.board[n][t];if(!o)return[];const r=[];switch(o.type){case"pawn":r.push(...cr(e.board,n,t,o.color)),r.push(...lr(e,n,t));break;case"rook":r.push(...Jn(e.board,n,t,o.color));break;case"knight":r.push(...dr(e.board,n,t,o.color));break;case"bishop":r.push(...Qn(e.board,n,t,o.color));break;case"queen":r.push(...ur(e.board,n,t,o.color));break;case"king":r.push(...pr(e.board,n,t,o.color));break}return r}function lr(e,n,t){const o=e.board[n][t];if(o.type!=="pawn"||!e.enPassantTarget)return[];const r=[],i=o.color==="white"?-1:1,a=e.enPassantTarget.row,s=e.enPassantTarget.col;return n===a-i&&Math.abs(t-s)===1&&r.push({row:a,col:s}),r}function cr(e,n,t,o){const r=[],i=o==="white"?-1:1,a=o==="white"?6:1;je(n+i,t)&&!e[n+i][t]&&(r.push({row:n+i,col:t}),n===a&&!e[n+2*i][t]&&r.push({row:n+2*i,col:t}));for(const s of[-1,1]){const c=n+i,l=t+s;je(c,l)&&e[c][l]&&e[c][l].color!==o&&r.push({row:c,col:l})}return r}function Jn(e,n,t,o){const r=[],i=[[0,1],[0,-1],[1,0],[-1,0]];for(const[a,s]of i)for(let c=1;c<8;c++){const l=n+c*a,f=t+c*s;if(!je(l,f))break;if(!e[l][f])r.push({row:l,col:f});else{e[l][f].color!==o&&r.push({row:l,col:f});break}}return r}function dr(e,n,t,o){const r=[],i=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];for(const[a,s]of i){const c=n+a,l=t+s;je(c,l)&&(!e[c][l]||e[c][l].color!==o)&&r.push({row:c,col:l})}return r}function Qn(e,n,t,o){const r=[],i=[[1,1],[1,-1],[-1,1],[-1,-1]];for(const[a,s]of i)for(let c=1;c<8;c++){const l=n+c*a,f=t+c*s;if(!je(l,f))break;if(!e[l][f])r.push({row:l,col:f});else{e[l][f].color!==o&&r.push({row:l,col:f});break}}return r}function ur(e,n,t,o){return[...Jn(e,n,t,o),...Qn(e,n,t,o)]}function pr(e,n,t,o){const r=[],i=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const[a,s]of i){const c=n+a,l=t+s;je(c,l)&&(!e[c][l]||e[c][l].color!==o)&&r.push({row:c,col:l})}return r}function je(e,n){return e>=0&&e<8&&n>=0&&n<8}function eo(e,n,t,o,r){const i=e.board[n][t],a=e.board[o][r];if(e.enPassantTarget=null,a&&a.type==="king"&&(e.gameOver=!0,e.winner=i.color),i.type==="pawn"&&t!==r&&!a){const s=i.color==="white"?o+1:o-1;e.board[s][r]=null}if(i.type==="pawn"&&Math.abs(o-n)===2){const s=i.color==="white"?o+1:o-1;e.enPassantTarget={row:s,col:r}}i.type==="pawn"&&(o===0||o===7)&&(i.type="queen"),i.type==="pawn"||a?e.halfMoveClock=0:e.halfMoveClock++,i.color==="black"&&e.fullMoveNumber++,e.board[o][r]=i,e.board[n][t]=null,e.moveHistory.push({from:{row:n,col:t},to:{row:o,col:r},piece:{...i},captured:a,enPassantTarget:e.enPassantTarget,halfMoveClock:e.halfMoveClock})}async function to(e,n){let t;switch(e.difficulty){case"easy":t=fr(e.board,"black");break;case"medium":t=Rt(e.board,"black",1);break;case"hard":t=Rt(e.board,"black",2);break}t&&(eo(e,t.from.row,t.from.col,t.to.row,t.to.col),e.currentPlayer="white",oo(e)&&(e.gameOver=!0,e.winner=ro(e)),await ft(e),Xt(e,n))}function fr(e,n){const t=[];for(let o=0;o<8;o++)for(let r=0;r<8;r++){const i=e[o][r];if(i&&i.color===n){const s=St({board:e,enPassantTarget:null},o,r);for(const c of s)t.push({from:{row:o,col:r},to:c})}}return t.length>0?t[Math.floor(Math.random()*t.length)]:null}function Rt(e,n,t){const o=[];for(let r=0;r<8;r++)for(let i=0;i<8;i++){const a=e[r][i];if(a&&a.color===n){const c=St({board:e,enPassantTarget:null},r,i);for(const l of c)o.push({from:{row:r,col:i},to:l,score:mr(e,{row:r,col:i},l,n,t)})}}return o.length===0?null:(o.sort((r,i)=>i.score-r.score),o[0])}function mr(e,n,t,o,r){const i=e.map(l=>l.map(f=>f?{...f}:null)),a=i[n.row][n.col],s=i[t.row][t.col];i[t.row][t.col]=a,i[n.row][n.col]=null;let c=0;if(s&&(c+=no(s.type)),c+=gr(i,o),r>1){const f=Rt(i,o==="white"?"black":"white",r-1);f&&(c-=f.score)}return c}function no(e){return{pawn:1,knight:3,bishop:3,rook:5,queen:9,king:100}[e]||0}function gr(e,n){let t=0;for(let o=0;o<8;o++)for(let r=0;r<8;r++){const i=e[o][r];i&&i.color===n&&(t+=no(i.type),o>=3&&o<=4&&r>=3&&r<=4&&(t+=.1))}return t}function oo(e){if(e.gameOver)return!0;let n=!1,t=!1;for(let r=0;r<8;r++)for(let i=0;i<8;i++){const a=e.board[r][i];a&&a.type==="king"&&(a.color==="white"&&(n=!0),a.color==="black"&&(t=!0))}if(!n)return e.gameOver=!0,e.winner="black",!0;if(!t)return e.gameOver=!0,e.winner="white",!0;const o=e.currentPlayer;return!yr(e,o)||e.halfMoveClock>=100?(e.gameOver=!0,e.winner="draw",!0):!1}function yr(e,n){for(let t=0;t<8;t++)for(let o=0;o<8;o++){const r=e.board[t][o];if(r&&r.color===n&&St(e,t,o).length>0)return!0}return!1}function ro(e){return e.winner}async function ft(e){try{await M.setItem("chessGameState",e)}catch(n){console.warn("Failed to save chess game state:",n)}}async function br(){try{const e=await M.getItem("chessGameState");return e||null}catch(e){return console.warn("Failed to load chess game state:",e),null}}function hr(e){const n=document.createElement("button");n.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2";const t=document.createElement("span");return t.className="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3",t.textContent=e,n.appendChild(t),n}function wr(e,n=null,t=null){const o=document.createElement("select");return o.className="bg-white border-t-2 border-l-2 border-black border-b-2 border-r-2 border-gray-300 px-2 py-1",o.setAttribute("aria-label","Select game difficulty"),o.setAttribute("title","Choose the difficulty level for the chess game"),e.forEach(r=>{const i=document.createElement("option");typeof r=="string"?(i.value=r,i.textContent=r):(i.value=r.value,i.textContent=r.text||r.value),n!==null&&i.value===n&&(i.selected=!0),o.appendChild(i)}),t&&typeof t=="function"&&o.addEventListener("change",r=>t(r.target.value,r)),o}function io(){const e=document.getElementById("bombbroomer");if(e){const o=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,i)=>getComputedStyle(i).zIndex>getComputedStyle(r).zIndex?i:r);e.style.zIndex=`${parseInt(o.style.zIndex)+1}`;return}const n=Z("Bombbroomer","",!1,"bombbroomer",!1,!1,{type:"integer",width:400,height:490},"App",null,"gray");ao(n).catch(t=>{console.error("Error initializing Bombbroomer:",t)})}async function ao(e){const n=e.querySelector(".p-2");n.className="p-2 bg-gray-200 h-full overflow-hidden",n.innerHTML="";let t=await vr();t||(t={grid:[],gameStarted:!1,gameOver:!1,gameWon:!1,bombs:10,flaggedCount:0,rows:9,cols:9,firstClick:!0,timer:0,timerInterval:null});const o=document.createElement("div");o.className="flex flex-col h-full bg-gray-200 pb-4";const r=document.createElement("div");r.className="bg-gray-200 border-b-2 border-gray-400 p-1 flex items-center space-x-4",r.style.borderStyle="inset";const i=document.createElement("button");i.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",i.textContent="Game",i.setAttribute("aria-label","Game menu options"),i.setAttribute("title","Access game options and settings");const a=document.createElement("button");a.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",a.textContent="New Game",a.setAttribute("aria-label","Start new game"),a.setAttribute("title","Start a new minesweeper game"),a.addEventListener("click",async()=>await H()),r.appendChild(a);const s=document.createElement("div");s.className="bg-gray-200 border-2 border-gray-400 p-2 flex justify-between items-center",s.style.borderStyle="inset";const c=document.createElement("div");c.className="bg-black text-red-500 px-2 py-1 font-mono text-lg border-2 border-gray-500",c.style.borderStyle="inset",c.id="bomb-counter",c.textContent="010";const l=document.createElement("button");l.className="w-8 h-8 bg-gray-200 border-2 border-gray-400 text-lg hover:bg-gray-300",l.style.borderStyle="outset",l.id="face-button",l.textContent="🙂",l.setAttribute("aria-label","New game - Click to restart"),l.setAttribute("title","Click to start a new game"),l.addEventListener("click",async()=>await H());const f=document.createElement("div");f.className="bg-black text-red-500 px-2 py-1 font-mono text-lg border-2 border-gray-500",f.style.borderStyle="inset",f.id="timer-display",f.textContent="000",s.appendChild(c),s.appendChild(l),s.appendChild(f);const m=document.createElement("div");m.className="flex-1 p-4 flex items-center justify-center";const u=document.createElement("div");u.className="grid grid-cols-9 gap-0 border-2 border-gray-400 bg-gray-300",u.style.borderStyle="inset",u.id="game-grid",m.appendChild(u),o.appendChild(r),o.appendChild(s),o.appendChild(m),n.appendChild(o);function p(){t.grid=[],t.gameStarted=!1,t.gameOver=!1,t.gameWon=!1,t.flaggedCount=0,t.firstClick=!0,t.timer=0,t.timerInterval&&clearInterval(t.timerInterval);for(let h=0;h<t.rows;h++){t.grid[h]=[];for(let k=0;k<t.cols;k++)t.grid[h][k]={isBomb:!1,isRevealed:!1,isFlagged:!1,neighborCount:0}}j(),v()}function d(h,k){let C=0;for(;C<t.bombs;){const E=Math.floor(Math.random()*t.rows),z=Math.floor(Math.random()*t.cols);!t.grid[E][z].isBomb&&!(E===h&&z===k)&&(t.grid[E][z].isBomb=!0,C++)}for(let E=0;E<t.rows;E++)for(let z=0;z<t.cols;z++)t.grid[E][z].isBomb||(t.grid[E][z].neighborCount=g(E,z))}function g(h,k){let C=0;for(let E=Math.max(0,h-1);E<=Math.min(t.rows-1,h+1);E++)for(let z=Math.max(0,k-1);z<=Math.min(t.cols-1,k+1);z++)(E!==h||z!==k)&&t.grid[E][z].isBomb&&C++;return C}function v(){const h=document.getElementById("game-grid");h.innerHTML="";for(let k=0;k<t.rows;k++)for(let C=0;C<t.cols;C++){const E=document.createElement("button");E.className="w-8 h-8 border border-gray-500 bg-gray-200 text-sm font-bold flex items-center justify-center",E.style.borderStyle="outset",E.dataset.row=k,E.dataset.col=C,E.setAttribute("aria-label",`Cell row ${k+1}, column ${C+1}`),E.setAttribute("title",`Minesweeper cell at row ${k+1}, column ${C+1}`);const z=t.grid[k][C];if(z.isRevealed){if(E.style.borderStyle="inset",E.className=E.className.replace("bg-gray-200","bg-gray-300"),z.isBomb)E.textContent="💣",E.style.backgroundColor=t.gameOver?"#ff0000":"#gray-300";else if(z.neighborCount>0){E.textContent=z.neighborCount;const X=["","#0000ff","#008000","#ff0000","#800080","#800000","#008080","#000000","#808080"];E.style.color=X[z.neighborCount]||"#000000"}}else z.isFlagged&&(E.textContent="🚩");E.addEventListener("click",async X=>await x(X,k,C)),E.addEventListener("contextmenu",async X=>await F(X,k,C)),h.appendChild(E)}}async function x(h,k,C){if(h.preventDefault(),t.gameOver||t.gameWon)return;const E=t.grid[k][C];E.isRevealed||E.isFlagged||(t.firstClick&&(d(k,C),t.firstClick=!1,t.gameStarted=!0,R()),E.isBomb?await W():(I(k,C),await P()),v(),await Ge(t))}async function F(h,k,C){if(h.preventDefault(),t.gameOver||t.gameWon)return;const E=t.grid[k][C];E.isRevealed||(E.isFlagged?(E.isFlagged=!1,t.flaggedCount--):(E.isFlagged=!0,t.flaggedCount++),j(),v(),await Ge(t))}function I(h,k){const C=t.grid[h][k];if(!(C.isRevealed||C.isFlagged)&&(C.isRevealed=!0,C.neighborCount===0))for(let E=Math.max(0,h-1);E<=Math.min(t.rows-1,h+1);E++)for(let z=Math.max(0,k-1);z<=Math.min(t.cols-1,k+1);z++)(E!==h||z!==k)&&I(E,z)}function R(){t.timerInterval=setInterval(async()=>{t.timer++,j(),await Ge(t)},1e3)}async function W(){t.gameOver=!0,t.timerInterval&&clearInterval(t.timerInterval);for(let h=0;h<t.rows;h++)for(let k=0;k<t.cols;k++)t.grid[h][k].isBomb&&(t.grid[h][k].isRevealed=!0);await Ge(t),document.getElementById("face-button").textContent="😵",setTimeout(()=>{showDialogBox("Game Over! Try again?","confirmation")},500)}async function P(){let h=0;for(let C=0;C<t.rows;C++)for(let E=0;E<t.cols;E++)t.grid[C][E].isRevealed&&!t.grid[C][E].isBomb&&h++;const k=t.rows*t.cols-t.bombs;h===k&&(t.gameWon=!0,t.timerInterval&&clearInterval(t.timerInterval),await Ge(t),document.getElementById("face-button").textContent="😎",setTimeout(()=>{showDialogBox("Congratulations! You won!","confirmation")},500))}function j(){const h=document.getElementById("bomb-counter"),k=document.getElementById("timer-display"),C=t.bombs-t.flaggedCount;h.textContent=C.toString().padStart(3,"0"),k.textContent=Math.min(t.timer,999).toString().padStart(3,"0")}async function H(){document.getElementById("face-button").textContent="🙂",p(),await xr()}function $(){const h=document.getElementById("face-button");t.gameOver?h.textContent="😵":t.gameWon?h.textContent="😎":h.textContent="🙂",t.gameStarted&&!t.gameOver&&!t.gameWon&&R(),j(),v()}const N=new MutationObserver(h=>{h.forEach(k=>{k.removedNodes.forEach(C=>{C.id==="bombbroomer"&&(t.timerInterval&&clearInterval(t.timerInterval),N.disconnect())})})});N.observe(document.getElementById("windows-container"),{childList:!0}),t.grid.length===0?H():$()}async function Ge(e){try{const n={...e,timerInterval:null};await M.setItem("bombbroomer_gameState",n)}catch(n){console.warn("Failed to save Bombbroomer game state:",n)}}async function vr(){try{const e=await M.getItem("bombbroomer_gameState");if(e){const n=e;return n.timerInterval=null,n}}catch(e){console.warn("Failed to load Bombbroomer game state:",e)}return null}async function xr(){try{await M.removeItem("bombbroomer_gameState")}catch(e){console.warn("Failed to clear Bombbroomer game state:",e)}}function so(){const e=document.getElementById("mediaplayer");if(e){const o=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,i)=>getComputedStyle(i).zIndex>getComputedStyle(r).zIndex?i:r);e.style.zIndex=`${parseInt(o.style.zIndex)+1}`;return}const n=Z("Media Player","",!1,"mediaplayer",!1,!1,{type:"integer",width:500,height:400},"App",null,"gray");lo(n).catch(console.error)}async function lo(e){const n=e.querySelector(".p-2");n.className="p-2 bg-gray-200 h-full flex",n.innerHTML="";let t=await Jt();t?((!isFinite(t.volume)||t.volume<0||t.volume>1)&&(t.volume=.5),(!isFinite(t.currentTime)||t.currentTime<0)&&(t.currentTime=0),Number.isInteger(t.currentTrackIndex)||(t.currentTrackIndex=-1),Array.isArray(t.playlist)||(t.playlist=[])):t={currentTrackIndex:-1,currentTime:0,volume:.5,isPlaying:!1,playlist:[]};const o=document.createElement("div");o.className="w-1/2 bg-white border-2 border-gray-400 mr-2 flex flex-col",o.innerHTML=`
    <div class="bg-gray-300 border-b-2 border-gray-400 p-2 flex justify-between items-center">
      <div class="text-xs font-bold">Media Playlist:</div>
      <button id="add-song-btn" onclick="setTimeout(function(){toggleButtonActiveState('add-song-btn', 'Add Media')}, 1000);toggleButtonActiveState('add-song-btn', 'Adding media...');" class="bg-gray-200 border-t-2 border-l-2 border-gray-300"><span class="border-b-2 border-r-2 border-black block h-full w-full py-1 px-2 text-xs">Add</span></button>
      <input type="file" id="song-file-input" class="hidden" accept="audio/*,video/*">
    </div>
    <div id="playlist-container" class="flex-1 p-2 overflow-y-auto space-y-1">
      <div class="text-xs text-gray-500">Loading playlist...</div>
    </div>
  `;const r=document.createElement("div");r.className="w-1/2 flex flex-col";const i=document.createElement("div");i.id="media-container",i.className="w-full bg-black mb-2 flex items-center justify-center min-h-32",i.innerHTML=`
    <audio id="audio-player" class="w-full hidden"></audio>
    <video id="video-player" class="w-full max-h-48 hidden" controls></video>
    <div id="audio-placeholder" class="text-white text-2xl p-4 flex items-center justify-center" style="display: none;">🎵 🎶 🎵</div>
    <div id="media-placeholder" class="text-white text-sm p-4">No media selected</div>
  `,r.appendChild(i);const a=document.createElement("div");a.className="bg-gray-300 border-2 border-gray-400 p-3 mb-2";const s=document.createElement("div");s.className="text-center mb-2",s.innerHTML=`
    <div id="current-track-name" class="font-bold text-sm">Media Player</div>
    <div id="current-time" class="text-xs text-gray-600">Ready to play</div>
  `;const c=document.createElement("div");c.className="mb-3",c.innerHTML=`
    <div id="progress-container" class="w-full h-2 bg-gray-400 border border-gray-500 cursor-pointer">
      <div id="progress-bar" class="h-full bg-blue-500" style="width: 0%"></div>
    </div>
  `;const l=document.createElement("div");l.className="flex justify-center space-x-2 mb-2",l.innerHTML=`
    <button id="prev-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs" aria-label="Previous track" title="Play previous track">⏮</button>
    <button id="play-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs" aria-label="Play" title="Play/pause current track">▶</button>
    <button id="stop-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs" aria-label="Stop" title="Stop playback">⏹</button>
    <button id="next-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs" aria-label="Next track" title="Play next track">⏭</button>
  `;const f=document.createElement("div");f.className="flex items-center justify-center space-x-2",f.innerHTML=`
    <span class="text-xs">🔊</span>
    <input type="range" id="volume-control" min="0" max="1" step="0.01" value="0.5" class="w-20" aria-label="Volume control" title="Adjust playback volume">
    <span class="text-xs" id="volume-display">50%</span>
  `,a.appendChild(s),a.appendChild(c),a.appendChild(l),a.appendChild(f),r.appendChild(a),n.appendChild(o),n.appendChild(r);const m=n.querySelector("#audio-player"),u=n.querySelector("#video-player");let p=t.currentTrackIndex,d=t.playlist;const g=n.querySelector("#play-btn"),v=n.querySelector("#next-btn"),x=n.querySelector("#prev-btn"),F=n.querySelector("#stop-btn"),I=n.querySelector("#volume-control"),R=n.querySelector("#progress-bar"),W=n.querySelector("#progress-container"),P=n.querySelector("#add-song-btn"),j=n.querySelector("#song-file-input");let H;const $="media_player_db",N="songs";function h(){const A=indexedDB.open($,1);A.onerror=L=>{console.error("Database error: ",L.target.errorCode)},A.onupgradeneeded=L=>{H=L.target.result,H.createObjectStore(N,{keyPath:"id",autoIncrement:!0}).createIndex("name","name",{unique:!1})},A.onsuccess=L=>{H=L.target.result,C().catch(console.error)}}function k(A){const L=A.name.split(".").pop().toLowerCase();Io(A.name,"","C://Media",L,A).then(U=>{U?C().catch(console.error):console.error("🎵 MEDIAPLAYER: Failed to add song to file system")}).catch(U=>{console.error("🎵 MEDIAPLAYER: Error adding song to file system:",U)})}async function C(){d=[];try{const U=V().folders["C://Media"];if(U){const de=Object.entries(U).filter(([q,me])=>q!=="contents"&&me&&typeof me=="object"&&me.type).map(([q,me])=>me).map(async q=>{if(q.content_type&&["mp3","wav","audio","mp4","webm","avi","mov"].includes(q.content_type)){const me=["mp4","webm","avi","mov"].includes(q.content_type),se={name:q.name,file:q.file,id:q.id,isFileSystem:!0,source:"filesystem",isVideo:me,contentType:q.content_type,type:q.file&&q.file.type?q.file.type:me?"video/"+q.content_type:"audio/"+q.content_type};if(q.storageLocation==="indexeddb"&&!q.dataURL||!q.dataURL&&!q.file&&!q.path&&q.id&&q.id.startsWith("file-"))try{const Se=await storage.getItem(`file_data_${q.id}`);if(Se){q.dataURL=Se,se.dataURL=Se;const he=V();he.folders["C://Media"]&&he.folders["C://Media"][q.id]&&(he.folders["C://Media"][q.id].dataURL=Se,he.folders["C://Media"][q.id].tempObjectURL=null,setFileSystemState(he))}else{console.warn("🎵 MEDIAPLAYER: No stored data found in IndexedDB for:",q.name,"File ID:",q.id);const he=`file_data_${q.name}`,De=await storage.getItem(he);De&&(q.dataURL=De,se.dataURL=De)}}catch(Se){console.error("🎵 MEDIAPLAYER: Failed to load data from IndexedDB for:",q.name,Se)}return q.isDefault&&q.path?(se.path=q.path,se.isDefault=!0):q.dataURL||se.dataURL?se.dataURL=q.dataURL||se.dataURL:q.file?se.file=q.file:q.tempObjectURL?se.tempObjectURL=q.tempObjectURL:se.path=`media/${q.name}`,se}return null});d=(await Promise.all(de)).filter(q=>q!==null)}}catch(L){console.error("Could not load songs from file system:",L)}d.some(L=>L.name==="too_many_screws_final.mp3")||d.unshift({name:"too_many_screws_final.mp3",path:"media/too_many_screws_final.mp3",isDefault:!0,id:"fallback-default-song",source:"fallback"}),E(),d.length>0&&(t.currentTrackIndex>=0&&t.currentTrackIndex<d.length?(z(t.currentTrackIndex),m.addEventListener("loadedmetadata",()=>{m.currentTime=t.currentTime||0},{once:!0})):z(0))}function E(){const A=n.querySelector("#playlist-container");A.innerHTML="",d.forEach((L,U)=>{const re=document.createElement("div");re.className="text-xs cursor-pointer hover:bg-gray-100 p-1 rounded";const de=L.name||L.id||"Unknown Track";L.name||console.warn("🎵 MEDIAPLAYER: Track missing name property, using fallback:",de,"Track:",L),re.textContent=de,re.dataset.index=U,re.addEventListener("click",()=>{z(U),oe()}),A.appendChild(re)})}function z(A){if(A<0||A>=d.length)return;p=A,t.currentTrackIndex=p;const L=d[A],U=L.type&&L.type.startsWith("video/")||L.contentType&&["mp4","webm","avi","mov"].includes(L.contentType)||L.isVideo===!0||L.file&&L.file.type&&L.file.type.startsWith("video/");m.style.display="none",u.style.display="none";const re=n.querySelector("#media-placeholder"),de=n.querySelector("#audio-placeholder");re&&(re.style.display="none"),de&&(de.style.display="none");const te=U?u:m,q=U?m:u;if(U?te.style.display="block":de&&(de.style.display="flex"),q.pause(),q.currentTime=0,L.isDefault||L.path&&!L.file&&!L.dataURL)te.src=L.path;else if(L.dataURL)te.src=L.dataURL;else if(L.tempObjectURL)te.src=L.tempObjectURL;else if(L.isFileSystem&&L.file){const me=URL.createObjectURL(L.file);te.src=me}else if(L.file){const me=URL.createObjectURL(L.file);te.src=me}else{console.error("Unable to load track - no valid source:",L);return}n.querySelector("#current-track-name").textContent=L.name||L.id||"Unknown Track",X(),Te(t).catch(console.error)}function X(){n.querySelectorAll("#playlist-container > div").forEach((L,U)=>{U===p?L.classList.add("bg-blue-200"):L.classList.remove("bg-blue-200")})}function oe(){const L=J().play();L!==void 0&&L.catch(U=>{U.name==="AbortError"||console.error("Playback failed:",U)})}function J(){return u.style.display==="block"?u:m}function pe(){const A=J();A.paused?oe():A.pause()}function Ae(){const A=J();A.pause(),A.currentTime=0}function ce(){const A=(p+1)%d.length;z(A),oe()}function ke(){const A=(p-1+d.length)%d.length;z(A),oe()}function D(){const A=J();A.volume=I.value;const L=A===m?u:m;L.volume=I.value,t.volume=A.volume,n.querySelector("#volume-display").textContent=`${Math.round(I.value*100)}%`,Te(t).catch(console.error)}function y(){const A=J();if(A.duration){const L=A.currentTime/A.duration*100;R.style.width=`${L}%`;const U=re=>{const de=Math.floor(re/60),te=Math.floor(re%60).toString().padStart(2,"0");return`${de}:${te}`};n.querySelector("#current-time").textContent=`${U(A.currentTime)} / ${U(A.duration)}`}}function b(A){const L=J();if(!L.duration)return;const U=A.offsetX,re=W.offsetWidth;L.currentTime=U/re*L.duration}g.addEventListener("click",pe),m.addEventListener("play",()=>g.textContent="⏸"),m.addEventListener("pause",()=>g.textContent="▶"),m.addEventListener("ended",ce),m.addEventListener("timeupdate",y),m.addEventListener("volumechange",()=>{I.value=m.volume,D()}),u.addEventListener("play",()=>g.textContent="⏸"),u.addEventListener("pause",()=>g.textContent="▶"),u.addEventListener("ended",ce),u.addEventListener("timeupdate",y),u.addEventListener("volumechange",()=>{I.value=u.volume,D()}),m.addEventListener("error",A=>{console.error("🎵 MEDIAPLAYER: Audio error:",A.target.error,"Source:",m.src)}),u.addEventListener("error",A=>{console.error("🎵 MEDIAPLAYER: Video error:",A.target.error,"Source:",u.src)}),m.addEventListener("loadstart",()=>{}),u.addEventListener("loadstart",()=>{}),F.addEventListener("click",Ae),v.addEventListener("click",ce),x.addEventListener("click",ke),I.addEventListener("input",D),W.addEventListener("click",b),P.addEventListener("click",()=>j.click()),j.addEventListener("change",A=>{const L=A.target.files[0];L&&k(L)});const w=isFinite(t.volume)&&t.volume>=0&&t.volume<=1?t.volume:.5;I.value=w,m.volume=w,u.volume=w,n.querySelector("#volume-display").textContent=`${Math.round(w*100)}%`,t.volume=w,m.addEventListener("timeupdate",()=>{m.style.display==="block"&&(t.currentTime=m.currentTime,Math.floor(m.currentTime)%5===0&&Te(t).catch(console.error))}),m.addEventListener("play",()=>{m.style.display==="block"&&(t.isPlaying=!0,Te(t).catch(console.error))}),m.addEventListener("pause",()=>{m.style.display==="block"&&(t.isPlaying=!1,Te(t).catch(console.error))}),u.addEventListener("timeupdate",()=>{u.style.display==="block"&&(t.currentTime=u.currentTime,Math.floor(u.currentTime)%5===0&&Te(t).catch(console.error))}),u.addEventListener("play",()=>{u.style.display==="block"&&(t.isPlaying=!0,Te(t).catch(console.error))}),u.addEventListener("pause",()=>{u.style.display==="block"&&(t.isPlaying=!1,Te(t).catch(console.error))}),h(),D(),t.currentTrackIndex>=0&&d.length>t.currentTrackIndex&&setTimeout(async()=>{await co()},500),window.refreshMediaPlayerPlaylist=function(){H&&C().catch(console.error)};const B=setInterval(()=>{try{const L=V().folders["C://Media"];if(L){const U=Object.values(L).filter(te=>te.content_type&&["mp3","wav","audio","mp4","webm","avi","mov"].includes(te.content_type)).map(te=>te.name),re=d.filter(te=>te.source==="filesystem"||te.isFileSystem).map(te=>te.name);U.filter(te=>!re.includes(te)).length>0&&C().catch(console.error)}}catch{}},1e4),T=e,O=T.remove;T.remove=function(){return clearInterval(B),window.refreshMediaPlayerPlaylist===window.refreshMediaPlayerPlaylist&&delete window.refreshMediaPlayerPlaylist,O.call(this)}}async function co(){const e=await Jt();if(!(!e||e.currentTrackIndex<0)&&playlist.length>e.currentTrackIndex){let t=function(){const o=getActivePlayer();e.currentTime>0&&(o.currentTime=e.currentTime),e.isPlaying&&safePlay()};var n=t;loadTrack(e.currentTrackIndex),audio.addEventListener("loadedmetadata",function o(){audio.style.display==="block"&&t(),audio.removeEventListener("loadedmetadata",o)}),video.addEventListener("loadedmetadata",function o(){video.style.display==="block"&&t(),video.removeEventListener("loadedmetadata",o)})}}async function Te(e){try{await storage.setItem("mediaplayer_state",e)}catch(n){console.warn("Failed to save Media Player state:",n);try{storage.setItemSync("mediaplayer_state",e)}catch(t){console.error("Failed to save Media Player state with fallback:",t)}}}async function Jt(){try{const e=await storage.getItem("mediaplayer_state");if(e)return e}catch(e){console.warn("Failed to load Media Player state:",e);try{const n=storage.getItemSync("mediaplayer_state");if(n)return n}catch(n){console.warn("Failed to load Media Player state with fallback:",n)}}return null}async function kr(){try{await storage.removeItem("mediaplayer_state")}catch(e){console.warn("Failed to clear Media Player state:",e);try{storage.removeItemSync("mediaplayer_state")}catch(n){console.error("Failed to clear Media Player state with fallback:",n)}}}class Sr{constructor(){this.shortcuts=new Map,this.customMappings=new Map,this.isInitialized=!1,this.preventDefaults=new Set,this.defaultShortcuts={"global.toggleStartMenu":{key:"Meta",description:"Open/Close Start Menu"},"global.cycleWindows":{key:"Alt+Tab",description:"Cycle through open windows"},"global.closeActiveWindow":{key:"Alt+F4",description:"Close active window"},"global.closeActiveWindow2":{key:"Ctrl+W",description:"Close active window (alternative)"},"global.minimizeActiveWindow":{key:"Ctrl+M",description:"Minimize active window"},"global.escapeAction":{key:"Escape",description:"Close menus and dialogs"},"desktop.activateIcon":{key:"Enter",description:"Activate selected desktop icon"},"desktop.activateIcon2":{key:"Space",description:"Activate selected desktop icon (alternative)"},"desktop.startDrag":{key:"Ctrl+D",description:"Start drag mode for desktop icon"},"desktop.cutIcon":{key:"Ctrl+X",description:"Cut desktop icon"},"desktop.pasteIcon":{key:"Ctrl+V",description:"Paste desktop icon"},"desktop.snapToGrid":{key:"G",description:"Snap icon to grid (while dragging)"},"desktop.escapeAction":{key:"Escape",description:"Cancel drag operation"},"desktop.moveUp":{key:"ArrowUp",description:"Move icon up"},"desktop.moveDown":{key:"ArrowDown",description:"Move icon down"},"desktop.moveLeft":{key:"ArrowLeft",description:"Move icon left"},"desktop.moveRight":{key:"ArrowRight",description:"Move icon right"},"desktop.fineMoveUp":{key:"Shift+ArrowUp",description:"Fine move icon up"},"desktop.fineMoveDown":{key:"Shift+ArrowDown",description:"Fine move icon down"},"desktop.fineMoveLeft":{key:"Shift+ArrowLeft",description:"Fine move icon left"},"desktop.fineMoveRight":{key:"Shift+ArrowRight",description:"Fine move icon right"},"startMenu.navigateDown":{key:"ArrowDown",description:"Navigate down in start menu"},"startMenu.navigateUp":{key:"ArrowUp",description:"Navigate up in start menu"},"startMenu.enterSubmenu":{key:"ArrowRight",description:"Enter submenu"},"startMenu.exitSubmenu":{key:"ArrowLeft",description:"Exit submenu"},"startMenu.activateItem":{key:"Enter",description:"Activate start menu item"},"startMenu.activateItem2":{key:"Space",description:"Activate start menu item (alternative)"},"startMenu.close":{key:"Escape",description:"Close start menu"},"startMenu.goToFirst":{key:"Home",description:"Go to first menu item"},"startMenu.goToLast":{key:"End",description:"Go to last menu item"},"fileExplorer.rename":{key:"F2",description:"Rename selected file"},"fileExplorer.delete":{key:"Delete",description:"Delete selected file"},"fileExplorer.open":{key:"Enter",description:"Open selected file"},"fileExplorer.navigateDown":{key:"ArrowDown",description:"Navigate down in file list"},"fileExplorer.navigateUp":{key:"ArrowUp",description:"Navigate up in file list"},"fileExplorer.openContextMenu":{key:"ContextMenu",description:"Open context menu"},"fileExplorer.openContextMenu2":{key:"Shift+F10",description:"Open context menu (alternative)"},"fileExplorer.openContextMenu3":{key:"Ctrl+Space",description:"Open context menu (alternative 2)"},"contextMenu.navigateDown":{key:"ArrowDown",description:"Navigate down in context menu"},"contextMenu.navigateUp":{key:"ArrowUp",description:"Navigate up in context menu"},"contextMenu.enterSubmenu":{key:"ArrowRight",description:"Enter context submenu"},"contextMenu.exitSubmenu":{key:"ArrowLeft",description:"Exit context submenu"},"contextMenu.activateItem":{key:"Enter",description:"Activate context menu item"},"contextMenu.activateItem2":{key:"Space",description:"Activate context menu item (alternative)"},"contextMenu.close":{key:"Escape",description:"Close context menu"},"window.minimize":{key:"Alt+F9",description:"Minimize window"},"window.maximize":{key:"Alt+F10",description:"Maximize/restore window"},"window.close":{key:"Alt+F4",description:"Close window"},"taskbar.activateButton":{key:"Enter",description:"Activate taskbar button"},"taskbar.activateButton2":{key:"Space",description:"Activate taskbar button (alternative)"},"taskbar.mediaControl":{key:"Ctrl+Shift+M",description:"Toggle media playback"},"taskbar.minimizeAll":{key:"Ctrl+Shift+D",description:"Show desktop (minimize all)"}}}async initialize(){this.isInitialized||(await this.loadCustomMappings(),this.setupShortcuts(),this.setupGlobalKeyboardHandler(),this.isInitialized=!0,console.log("🎹 Keyboard service initialized with",this.shortcuts.size,"shortcuts"))}async loadCustomMappings(){var n;try{const o=(n=(await Ce()).folders["C://Documents"])==null?void 0:n["keyboard_config.json"];if(o&&o.content){const r=JSON.parse(o.content);this.customMappings=new Map(Object.entries(r.customMappings||{})),console.log("📋 Loaded",this.customMappings.size,"custom keyboard mappings")}}catch(t){console.warn("⚠️ Could not load keyboard config:",t)}}async saveCustomMappings(){try{const n=await Ce();n.folders["C://Documents"]||(n.folders["C://Documents"]={});const t={customMappings:Object.fromEntries(this.customMappings),timestamp:Date.now()};n.folders["C://Documents"]["keyboard_config.json"]={id:"keyboard_config.json",name:"keyboard_config.json",type:"file",content_type:"json",content:JSON.stringify(t,null,2),fullPath:"C://Documents/keyboard_config.json"},await _(),console.log("💾 Saved keyboard configuration")}catch(n){console.error("❌ Failed to save keyboard config:",n)}}setupShortcuts(){this.shortcuts.clear();for(const[n,t]of Object.entries(this.defaultShortcuts)){const o=this.customMappings.get(n);this.shortcuts.set(n,{...t,key:o||t.key,isCustom:!!o})}}setupGlobalKeyboardHandler(){document.removeEventListener("keydown",this.globalHandler),this.globalHandler=this.handleGlobalKeyboard.bind(this),document.addEventListener("keydown",this.globalHandler,!0)}handleGlobalKeyboard(n){const t=this.getKeyCombo(n),o=this.getContext(n);for(const[r,i]of this.shortcuts.entries())if(this.matchesKeyCombo(t,i.key)&&this.isActionValidForContext(r,o)){n.preventDefault(),n.stopPropagation(),this.executeAction(r,n,o);return}}getKeyCombo(n){const t=[];n.ctrlKey&&t.push("Ctrl"),n.altKey&&t.push("Alt"),n.shiftKey&&t.push("Shift"),n.metaKey&&t.push("Meta");let o=n.key;return o===" "&&(o="Space"),t.push(o),t.join("+")}matchesKeyCombo(n,t){const o=r=>r.toLowerCase().replace(/\s+/g,"");return o(n)===o(t)}getContext(n){const t=n.target,o=[];return t.closest("#start-menu")&&o.push("startMenu"),t.closest("#context-menu")&&o.push("contextMenu"),t.closest(".file-explorer-window")&&o.push("fileExplorer"),t.closest(".draggable-icon")&&o.push("desktop"),t.closest("#window-tabs")&&o.push("taskbar"),t.closest('[role="dialog"]')&&o.push("window"),o.push("global"),o}isActionValidForContext(n,t){const o=n.split(".")[0];return t.includes(o)||o==="global"}async executeAction(n,t,o){console.log("🎹 Executing keyboard action:",n);try{switch(n){case"global.toggleStartMenu":typeof window.toggleStartMenu=="function"&&window.toggleStartMenu();break;case"global.cycleWindows":typeof window.cycleWindows=="function"&&window.cycleWindows();break;case"global.closeActiveWindow":case"global.closeActiveWindow2":typeof window.closeActiveWindow=="function"&&window.closeActiveWindow();break;case"global.minimizeActiveWindow":typeof window.minimizeActiveWindow=="function"&&window.minimizeActiveWindow();break;case"global.escapeAction":this.handleGlobalEscape();break;case"desktop.activateIcon":case"desktop.activateIcon2":this.handleDesktopActivate(t);break;case"desktop.startDrag":this.handleDesktopStartDrag(t);break;case"desktop.cutIcon":this.handleDesktopCut(t);break;case"desktop.pasteIcon":this.handleDesktopPaste(t);break;case"desktop.escapeAction":this.handleDesktopEscape(t);break;case"desktop.moveUp":case"desktop.moveDown":case"desktop.moveLeft":case"desktop.moveRight":this.handleDesktopMove(t,n);break;case"desktop.fineMoveUp":case"desktop.fineMoveDown":case"desktop.fineMoveLeft":case"desktop.fineMoveRight":this.handleDesktopFineMove(t,n);break;case"startMenu.navigateDown":case"startMenu.navigateUp":case"startMenu.enterSubmenu":case"startMenu.exitSubmenu":case"startMenu.activateItem":case"startMenu.activateItem2":case"startMenu.close":case"startMenu.goToFirst":case"startMenu.goToLast":this.handleStartMenuAction(n,t);break;case"fileExplorer.rename":case"fileExplorer.delete":case"fileExplorer.open":case"fileExplorer.navigateDown":case"fileExplorer.navigateUp":case"fileExplorer.openContextMenu":case"fileExplorer.openContextMenu2":case"fileExplorer.openContextMenu3":this.handleFileExplorerAction(n,t);break;case"contextMenu.navigateDown":case"contextMenu.navigateUp":case"contextMenu.enterSubmenu":case"contextMenu.exitSubmenu":case"contextMenu.activateItem":case"contextMenu.activateItem2":case"contextMenu.close":this.handleContextMenuAction(n,t);break;case"window.minimize":case"window.maximize":case"window.close":this.handleWindowAction(n,t);break;case"taskbar.activateButton":case"taskbar.activateButton2":case"taskbar.mediaControl":case"taskbar.minimizeAll":this.handleTaskbarAction(n,t);break;default:console.warn("🎹 Unknown keyboard action:",n)}}catch(r){console.error("❌ Error executing keyboard action:",n,r)}}handleGlobalEscape(){const n=document.getElementById("start-menu"),t=document.getElementById("context-menu");if(n&&!n.classList.contains("hidden")){n.classList.add("hidden"),n.setAttribute("aria-hidden","true"),typeof window.updateStartMenuFocusability=="function"&&window.updateStartMenuFocusability(!1);const o=document.getElementById("start-button");o&&(o.setAttribute("aria-expanded","false"),o.focus())}t&&!t.classList.contains("hidden")&&t.classList.add("hidden")}handleDesktopActivate(n){const t=n.target.closest(".draggable-icon");t&&t.dispatchEvent(new MouseEvent("dblclick",{bubbles:!0}))}handleDesktopStartDrag(n){const t=n.target.closest(".draggable-icon");t&&typeof window.startKeyboardDrag=="function"&&window.startKeyboardDrag(t)}handleDesktopCut(n){const t=n.target.closest(".draggable-icon");t&&typeof window.cutIcon=="function"&&window.cutIcon(t)}handleDesktopPaste(n){typeof window.pasteIcon=="function"&&window.pasteIcon()}handleDesktopEscape(n){typeof window.endKeyboardDrag=="function"&&window.endKeyboardDrag(!1)}handleDesktopMove(n,t){const o=n.target.closest(".draggable-icon");if(!o)return;const r=t.split(".")[1].replace("move","").toLowerCase(),i={up:"ArrowUp",down:"ArrowDown",left:"ArrowLeft",right:"ArrowRight"};typeof window.moveIconWithKeyboard=="function"&&window.moveIconWithKeyboard(o,i[r])}handleDesktopFineMove(n,t){const o=n.target.closest(".draggable-icon");if(!o)return;const r=t.split(".")[1].replace("fineMove","").toLowerCase(),i=parseInt(o.style.left)||0,a=parseInt(o.style.top)||0,s=5;let c=i,l=a;switch(r){case"up":l=Math.max(16,a-s);break;case"down":l=a+s;break;case"left":c=Math.max(16,i-s);break;case"right":c=i+s;break}o.style.left=c+"px",o.style.top=l+"px",typeof window.constrainIconPosition=="function"&&window.constrainIconPosition(o),typeof window.desktopIconsState<"u"&&(window.desktopIconsState[o.id]={left:o.style.left,top:o.style.top}),typeof window.saveState=="function"&&window.saveState()}handleStartMenuAction(n,t){const o=n.split(".")[1],r=window.startMenuKeyboardNavState;r&&typeof r.handleAction=="function"&&r.handleAction(o,t)}handleFileExplorerAction(n,t){const o=n.split(".")[1];switch(o){case"rename":console.log("F2 - Rename functionality would trigger here");break;case"delete":console.log("Delete - Delete functionality would trigger here");break;case"open":const r=document.activeElement;r&&r.classList.contains("file-item")&&r.dispatchEvent(new MouseEvent("dblclick",{bubbles:!0}));break;case"navigateDown":case"navigateUp":const i=o==="navigateDown"?"down":"up",a=document.querySelector(".file-explorer-window:focus-within");a&&typeof window.navigateFileList=="function"&&window.navigateFileList(i,a);break;case"openContextMenu":case"openContextMenu2":case"openContextMenu3":const s=t.target,c=s.getBoundingClientRect(),l=new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,clientX:c.left+c.width/2,clientY:c.top+c.height/2,button:2});s.dispatchEvent(l);break}}handleContextMenuAction(n,t){const o=document.getElementById("context-menu");o&&typeof window.handleContextMenuNavigation=="function"&&window.handleContextMenuNavigation(t,o)}handleWindowAction(n,t){const o=n.split(".")[1],r=document.querySelector('[role="dialog"]:not([aria-hidden="true"])');if(!r)return;const i=r.id;switch(o){case"minimize":typeof window.minimizeWindow=="function"&&window.minimizeWindow(i);break;case"maximize":typeof window.toggleFullScreen=="function"&&window.toggleFullScreen(i);break;case"close":typeof window.closeWindow=="function"&&window.closeWindow(i);break}}handleTaskbarAction(n,t){switch(n.split(".")[1]){case"activateButton":case"activateButton2":const r=t.target.closest("button");r&&r.click();break;case"mediaControl":typeof window.toggleMediaPlayback=="function"&&window.toggleMediaPlayback();break;case"minimizeAll":typeof window.minimizeAllWindows=="function"&&window.minimizeAllWindows();break}}remapShortcut(n,t){if(!this.defaultShortcuts[n])throw new Error(`Unknown action: ${n}`);this.customMappings.set(n,t),this.setupShortcuts(),this.saveCustomMappings()}removeCustomMapping(n){this.customMappings.delete(n),this.setupShortcuts(),this.saveCustomMappings()}resetToDefaults(){this.customMappings.clear(),this.setupShortcuts(),this.saveCustomMappings()}getShortcuts(){return Array.from(this.shortcuts.entries()).map(([n,t])=>({id:n,...t}))}getShortcutsByContext(){const n={};for(const[t,o]of this.shortcuts.entries()){const r=t.split(".")[0];n[r]||(n[r]=[]),n[r].push({id:t,...o})}return n}}const ge=new Sr;async function Er(){console.log("🎹 Starting keyboard app launch...");try{await ge.initialize(),console.log("🎹 Keyboard service initialized successfully");const e=document.getElementById("keyboard-app");if(e){console.log("🎹 Existing keyboard window found, bringing to front"),typeof window.bringToFront=="function"&&window.bringToFront(e);return}const n="keyboard-app",t=Cr();console.log("🎹 Creating keyboard app window..."),Z("Keyboard Shortcuts",t,!1,n,!1,!1,{type:"integer",width:800,height:600},"default"),console.log("🎹 Window created, initializing app..."),setTimeout(()=>Ir(n),100)}catch(e){console.error("❌ Failed to launch keyboard app:",e)}}function Cr(){return`
    <div class="keyboard-app h-full flex flex-col bg-gray-50">
      <div class="bg-blue-600 text-white p-3 flex items-center">
        <div class="w-8 h-8 bg-white bg-opacity-20 rounded mr-3 flex items-center justify-center">
          <span class="text-sm font-bold">⌨️</span>
        </div>
        <div>
          <h1 class="text-lg font-bold">Keyboard Shortcuts Manager</h1>
          <p class="text-sm opacity-90">Customize keyboard shortcuts for the entire system</p>
        </div>
      </div>

      <div class="flex-1 flex">
        <!-- Sidebar -->
        <div class="w-64 bg-white border-r border-gray-300 flex flex-col">
          <div class="p-3 border-b border-gray-200">
            <h2 class="font-bold text-gray-800">Categories</h2>
          </div>
          <div class="flex-1 overflow-y-auto">
            <div id="keyboard-categories" class="p-2 space-y-1">
              <!-- Categories will be populated here -->
            </div>
          </div>
          <div class="p-3 border-t border-gray-200 space-y-2">
            <div id="keyboard-reset-btn-container"></div>
            <div id="keyboard-export-btn-container"></div>
          </div>
        </div>

        <!-- Main content -->
        <div class="flex-1 flex flex-col">
          <div class="p-4 border-b border-gray-200 bg-gray-100">
            <div class="flex items-center justify-between">
              <div>
                <h2 id="keyboard-category-title" class="text-xl font-bold text-gray-800">Global Shortcuts</h2>
                <p id="keyboard-category-desc" class="text-sm text-gray-600">System-wide keyboard shortcuts</p>
              </div>
              <div class="flex items-center space-x-2">
                <input type="text" id="keyboard-search" placeholder="Search shortcuts..."
                       class="px-3 py-1 border border-gray-300 rounded text-sm">
                <div id="keyboard-help-btn-container"></div>
              </div>
            </div>
          </div>

          <div class="flex-1 overflow-y-auto p-4">
            <div id="keyboard-shortcuts-list">
              <!-- Shortcuts list will be populated here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Status bar -->
      <div class="bg-gray-200 border-t border-gray-300 px-4 py-2 text-sm text-gray-600">
        <div class="flex items-center justify-between">
          <span id="keyboard-status">Ready</span>
          <span id="keyboard-count">0 shortcuts loaded</span>
        </div>
      </div>
    </div>
  `}function Ir(e){const n=document.getElementById(e);if(!n){console.error("❌ Keyboard app window not found:",e);return}console.log("🎹 Initializing keyboard app UI...");let t="global",o=null,r=null;ge.initialize().then(()=>{console.log("🎹 Keyboard service ready, populating UI..."),i(),a("global"),g("Keyboard service initialized")}).catch($=>{console.error("❌ Failed to initialize keyboard service:",$),g("Failed to initialize keyboard service")});function i(){const $=ge.getShortcutsByContext(),N=n.querySelector("#keyboard-categories"),h={global:"Global",desktop:"Desktop",startMenu:"Start Menu",fileExplorer:"File Explorer",contextMenu:"Context Menu",window:"Windows",taskbar:"Taskbar"},k={global:"image/html.webp",desktop:"image/desktop.webp",startMenu:"image/door-icon.webp",fileExplorer:"image/folder.webp",contextMenu:"image/doc.webp",window:"image/generic-window.webp",taskbar:"image/desktop.webp"};N.innerHTML="",Object.keys($).forEach(C=>{const E=document.createElement("button");E.className="w-full text-left px-3 py-2 rounded hover:bg-gray-100 text-sm flex items-center space-x-2";const z=document.createElement("img");z.src=k[C]||"image/file.webp",z.className="w-4 h-4",z.alt="";const X=document.createElement("span");X.textContent=h[C]||C,E.appendChild(z),E.appendChild(X),E.onclick=()=>a(C),N.appendChild(E)})}function a($){t=$;const N=ge.getShortcutsByContext()[$]||[],h={global:"Global Shortcuts",desktop:"Desktop Shortcuts",startMenu:"Start Menu Navigation",fileExplorer:"File Explorer",contextMenu:"Context Menus",window:"Window Management",taskbar:"Taskbar Controls"},k={global:"System-wide keyboard shortcuts",desktop:"Desktop icon management and navigation",startMenu:"Start menu navigation and activation",fileExplorer:"File and folder operations",contextMenu:"Context menu navigation",window:"Window control operations",taskbar:"Taskbar button and control shortcuts"};n.querySelector("#keyboard-category-title").textContent=h[$]||$,n.querySelector("#keyboard-category-desc").textContent=k[$]||"",n.querySelectorAll("#keyboard-categories button").forEach(E=>{E.classList.remove("bg-blue-100","border-blue-300")});const C=Array.from(n.querySelectorAll("#keyboard-categories button")).find(E=>{const z=E.querySelector("span");return z&&z.textContent===(h[$]||$)});C&&C.classList.add("bg-blue-100","border-blue-300"),s(N),g(`Showing ${N.length} shortcuts in ${h[$]}`),n.querySelector("#keyboard-count").textContent=`${N.length} shortcuts`}function s($){const N=n.querySelector("#keyboard-shortcuts-list");if(N.innerHTML="",$.length===0){N.innerHTML='<div class="text-center text-gray-500 py-8">No shortcuts in this category</div>';return}$.forEach(h=>{var oe;const k=document.createElement("div");k.className="bg-white border border-gray-200 rounded-lg p-4 mb-3 hover:shadow-md transition-shadow";const C=h.isCustom,E=((oe=ge.defaultShortcuts[h.id])==null?void 0:oe.key)||"";k.innerHTML=`
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="flex items-center space-x-2">
              <h3 class="font-medium text-gray-800">${h.description}</h3>
              ${C?'<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">Custom</span>':""}
            </div>
            <p class="text-sm text-gray-500 mt-1">Action: ${h.id}</p>
            ${C?`<p class="text-xs text-gray-400 mt-1">Default: ${E}</p>`:""}
          </div>
          <div class="flex items-center space-x-2">
            <code class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">${h.key}</code>
            <div class="edit-shortcut-btn" data-shortcut-id="${h.id}"></div>
            ${C?`<div class="reset-shortcut-btn" data-shortcut-id="${h.id}"></div>`:""}
          </div>
        </div>
      `,N.appendChild(k);const z=k.querySelector(".edit-shortcut-btn"),X=Q("Edit");if(X.onclick=()=>c(h.id),z.appendChild(X),C){const J=k.querySelector(".reset-shortcut-btn"),pe=Q("Reset");pe.onclick=()=>u(h.id),J.appendChild(pe)}})}function c($){o=$,r=null;const N=ge.shortcuts.get($),h=N?N.description:$,k="keyboard-capture-window",C=`
      <div class="p-4 bg-gray-100 h-full flex flex-col">
        <h3 class="text-lg font-bold mb-4">Remap Shortcut</h3>
        <p class="mb-4">Remapping: <strong>${h}</strong></p>
        <div class="flex-1 flex items-center justify-center">
          <div id="keyboard-capture-display" class="text-xl font-mono bg-white p-6 border-2 border-gray-400 text-center min-w-64" style="border-style: inset;">
            Press any key combination...
          </div>
        </div>
        <p class="text-sm text-gray-600 mb-4 text-center">
          Press the key combination you want to assign.<br>
          Press Escape to cancel.
        </p>
        <div class="flex justify-center space-x-2">
          <div id="keyboard-capture-cancel-btn"></div>
          <div id="keyboard-capture-save-btn"></div>
        </div>
      </div>
    `;Z("Capture Key Combination",C,!1,k,!1,!1,{type:"integer",width:400,height:250},"default"),setTimeout(()=>{const E=document.getElementById(k);if(!E)return;const z=E.querySelector("#keyboard-capture-cancel-btn"),X=E.querySelector("#keyboard-capture-save-btn"),oe=Q("Cancel");oe.onclick=()=>{f(),ie(k)},z.appendChild(oe);const J=Q("Save");J.disabled=!0,J.onclick=()=>{m(),ie(k)},X.appendChild(J),document.addEventListener("keydown",l,!0),E.focus()},100)}function l($){if($.preventDefault(),$.stopPropagation(),$.key==="Escape"){f(),ie("keyboard-capture-window");return}r=ge.getKeyCombo($);const N=document.getElementById("keyboard-capture-window");if(!N)return;const h=N.querySelector("#keyboard-capture-display"),k=N.querySelector("#keyboard-capture-save-btn");h.textContent=r;const C=k.querySelector("button");C&&(C.disabled=!1)}function f(){document.removeEventListener("keydown",l,!0),o=null,r=null}function m(){if(!(!o||!r)){try{ge.remapShortcut(o,r),a(t),g(`Shortcut updated: ${o} → ${r}`)}catch($){g(`Error: ${$.message}`)}f()}}function u($){ge.removeCustomMapping($),a(t),g(`Shortcut reset to default: ${$}`)}function p(){typeof window.showDialogBox=="function"?window.showDialogBox("Are you sure you want to reset all shortcuts to their defaults? This cannot be undone.","confirm",$=>{$&&(ge.resetToDefaults(),a(t),g("All shortcuts reset to defaults"))}):confirm("Are you sure you want to reset all shortcuts to their defaults? This cannot be undone.")&&(ge.resetToDefaults(),a(t),g("All shortcuts reset to defaults"))}function d(){const $={customMappings:Object.fromEntries(ge.customMappings),timestamp:Date.now(),version:"1.0"},N=new Blob([JSON.stringify($,null,2)],{type:"application/json"}),h=URL.createObjectURL(N),k=document.createElement("a");k.href=h,k.download="keyboard-shortcuts.json",k.click(),URL.revokeObjectURL(h),g("Settings exported successfully")}function g($){n.querySelector("#keyboard-status").textContent=$}function v($,N){n.querySelector("#keyboard-category-title").textContent=`Search Results for "${$}"`,n.querySelector("#keyboard-category-desc").textContent=`Found ${N.length} shortcuts across all categories`,n.querySelectorAll("#keyboard-categories button").forEach(h=>{h.classList.remove("bg-blue-100","border-blue-300")}),x(N),g(`${N.length} shortcuts found for "${$}"`),n.querySelector("#keyboard-count").textContent=`${N.length} shortcuts found`}function x($){const N=n.querySelector("#keyboard-shortcuts-list");if(N.innerHTML="",$.length===0){N.innerHTML='<div class="text-center text-gray-500 py-8">No shortcuts found matching your search</div>';return}const h={};$.forEach(E=>{const z=E.id.split(".")[0];h[z]||(h[z]=[]),h[z].push(E)});const k={global:"Global",desktop:"Desktop",startMenu:"Start Menu",fileExplorer:"File Explorer",contextMenu:"Context Menu",window:"Windows",taskbar:"Taskbar"},C={global:"image/html.webp",desktop:"image/desktop.webp",startMenu:"image/door-icon.webp",fileExplorer:"image/folder.webp",contextMenu:"image/doc.webp",window:"image/generic-window.webp",taskbar:"image/desktop.webp"};Object.keys(h).forEach(E=>{const z=h[E],X=document.createElement("div");X.className="mb-2 mt-4 first:mt-0",X.innerHTML=`
        <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wide border-b border-gray-200 pb-1 flex items-center space-x-2">
          <img src="${C[E]||"image/file.webp"}" class="w-4 h-4" alt="">
          <span>${k[E]||E} (${z.length})</span>
        </h3>
      `,N.appendChild(X),z.forEach(oe=>{var D;const J=document.createElement("div");J.className="bg-white border border-gray-200 rounded-lg p-4 mb-3 hover:shadow-md transition-shadow";const pe=oe.isCustom,Ae=((D=ge.defaultShortcuts[oe.id])==null?void 0:D.key)||"";J.innerHTML=`
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <div class="flex items-center space-x-2">
                <h3 class="font-medium text-gray-800">${oe.description}</h3>
                ${pe?'<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">Custom</span>':""}
              </div>
              <p class="text-sm text-gray-500 mt-1">Action: ${oe.id}</p>
              ${pe?`<p class="text-xs text-gray-400 mt-1">Default: ${Ae}</p>`:""}
            </div>
            <div class="flex items-center space-x-2">
              <code class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">${oe.key}</code>
              <div class="edit-shortcut-btn" data-shortcut-id="${oe.id}"></div>
              ${pe?`<div class="reset-shortcut-btn" data-shortcut-id="${oe.id}"></div>`:""}
            </div>
          </div>
        `,N.appendChild(J);const ce=J.querySelector(".edit-shortcut-btn"),ke=Q("Edit");if(ke.onclick=()=>c(oe.id),ce.appendChild(ke),pe){const y=J.querySelector(".reset-shortcut-btn"),b=Q("Reset");b.onclick=()=>u(oe.id),y.appendChild(b)}})})}function F(){n.querySelector("#keyboard-search").addEventListener("input",N=>{const h=N.target.value.toLowerCase();if(!h.trim()){a(t);return}const C=ge.getShortcuts().filter(E=>E.description.toLowerCase().includes(h)||E.key.toLowerCase().includes(h)||E.id.toLowerCase().includes(h));v(h,C)})}const I=n.querySelector("#keyboard-reset-btn-container"),R=n.querySelector("#keyboard-export-btn-container"),W=n.querySelector("#keyboard-help-btn-container"),P=Q("Reset All to Defaults");P.onclick=p,P.style.width="100%",I.appendChild(P);const j=Q("Export Settings");j.onclick=d,j.style.width="100%",R.appendChild(j);const H=Q("Help");H.onclick=()=>{typeof window.showDialogBox=="function"&&window.showDialogBox(`
        <h3>Keyboard Shortcuts Help</h3>
        <p><strong>Editing Shortcuts:</strong> Click "Edit" next to any shortcut to assign a new key combination.</p>
        <p><strong>Resetting:</strong> Use "Reset" to restore a shortcut to its default, or "Reset All" for everything.</p>
        <p><strong>Key Combinations:</strong> You can use Ctrl, Alt, Shift, and Meta (Windows/Cmd) keys with letters, numbers, and function keys.</p>
        <p><strong>Search:</strong> Use the search box to quickly find specific shortcuts.</p>
        <p><strong>Export:</strong> Save your custom shortcuts to a file for backup or sharing.</p>
      `,"info")},W.appendChild(H),F()}typeof window<"u"&&(window.keyboardService=ge);function Lr(){const e=document.getElementById("pong");if(e){const o=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,i)=>getComputedStyle(i).zIndex>getComputedStyle(r).zIndex?i:r);e.style.zIndex=`${parseInt(o.style.zIndex)+1}`;return}const n=Z("Pong","",!1,"pong",!1,!1,{type:"integer",width:700,height:500},"App",null,"black");Mr(n).catch(console.error)}async function Mr(e){const n=e.querySelector(".p-2");n.className="p-2 bg-black h-full overflow-hidden flex flex-col",n.innerHTML="";const t=document.createElement("div");t.className="flex items-center justify-between text-white px-2 pb-2",t.style.fontFamily="monospace",t.innerHTML='<div>🙋 Player</div><div id="pong-score">0 - 0</div><div>🤖 Computer</div>';const o=document.createElement("div");o.className="flex-1 flex items-center justify-center";const r=document.createElement("canvas");r.id="pong-canvas",r.style.background="#000",r.style.border="2px inset #666",r.width=640,r.height=360,o.appendChild(r);const i=document.createElement("div");i.className="text-xs text-gray-300 pt-2",i.textContent="Controls: W/S or Up/Down to move paddle. Click canvas to focus.",n.appendChild(t),n.appendChild(o),n.appendChild(i);const a=r.getContext("2d");let s=0,c=0;const l={paddleHeight:60,paddleWidth:8,playerY:(r.height-60)/2,aiY:(r.height-60)/2,ballX:r.width/2,ballY:r.height/2,ballVX:3,ballVY:2,ballRadius:6,upPressed:!1,downPressed:!1,running:!0,rafId:null};function f(I=1){l.ballX=r.width/2,l.ballY=r.height/2,l.ballVX=3*I,l.ballVY=Math.random()*3-1.5}function m(){a.fillStyle="#000",a.fillRect(0,0,r.width,r.height),a.fillStyle="#444";for(let I=0;I<r.height;I+=20)a.fillRect(r.width/2-1,I+5,2,10);a.fillStyle="#fff",a.fillRect(20,l.playerY,l.paddleWidth,l.paddleHeight),a.fillRect(r.width-20-l.paddleWidth,l.aiY,l.paddleWidth,l.paddleHeight),a.beginPath(),a.arc(l.ballX,l.ballY,l.ballRadius,0,Math.PI*2),a.fill()}function u(){l.upPressed&&(l.playerY-=6),l.downPressed&&(l.playerY+=6),l.playerY=Math.max(0,Math.min(r.height-l.paddleHeight,l.playerY));const I=l.aiY+l.paddleHeight/2;if(I<l.ballY-10&&(l.aiY+=3.2),I>l.ballY+10&&(l.aiY-=3.2),l.aiY=Math.max(0,Math.min(r.height-l.paddleHeight,l.aiY)),l.ballX+=l.ballVX,l.ballY+=l.ballVY,(l.ballY-l.ballRadius<=0||l.ballY+l.ballRadius>=r.height)&&(l.ballVY=-l.ballVY),l.ballX-l.ballRadius<=20+l.paddleWidth&&l.ballY>=l.playerY&&l.ballY<=l.playerY+l.paddleHeight){l.ballVX=-l.ballVX;const R=(l.ballY-(l.playerY+l.paddleHeight/2))/(l.paddleHeight/2);l.ballVY+=R*2,l.ballX=20+l.paddleWidth+l.ballRadius+1}if(l.ballX+l.ballRadius>=r.width-20-l.paddleWidth&&l.ballY>=l.aiY&&l.ballY<=l.aiY+l.paddleHeight){l.ballVX=-l.ballVX;const R=(l.ballY-(l.aiY+l.paddleHeight/2))/(l.paddleHeight/2);l.ballVY+=R*2,l.ballX=r.width-20-l.paddleWidth-l.ballRadius-1}l.ballX<0&&(c+=1,d(),f(1)),l.ballX>r.width&&(s+=1,d(),f(-1))}function p(){l.running&&(u(),m(),l.rafId=requestAnimationFrame(p))}function d(){const I=document.getElementById("pong-score");I&&(I.textContent=`${s} - ${c}`)}function g(I){(I.key==="w"||I.key==="W"||I.key==="ArrowUp")&&(l.upPressed=!0),(I.key==="s"||I.key==="S"||I.key==="ArrowDown")&&(l.downPressed=!0)}function v(I){(I.key==="w"||I.key==="W"||I.key==="ArrowUp")&&(l.upPressed=!1),(I.key==="s"||I.key==="S"||I.key==="ArrowDown")&&(l.downPressed=!1)}r.addEventListener("click",()=>r.focus()),r.setAttribute("tabindex","0"),r.style.outline="none",document.addEventListener("keydown",g),document.addEventListener("keyup",v);const x=new MutationObserver(I=>{I.forEach(R=>{R.removedNodes.forEach(W=>{W.id==="pong"&&(F(),x.disconnect())})})});x.observe(document.getElementById("windows-container"),{childList:!0});function F(){l.running=!1,l.rafId&&cancelAnimationFrame(l.rafId),document.removeEventListener("keydown",g),document.removeEventListener("keyup",v)}f(1),d(),l.rafId=requestAnimationFrame(p)}function Ar(){const e=document.getElementById("snake");if(e){const o=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,i)=>getComputedStyle(i).zIndex>getComputedStyle(r).zIndex?i:r);e.style.zIndex=`${parseInt(o.style.zIndex)+1}`;return}const n=Z("Snake","",!1,"snake",!1,!1,{type:"integer",width:620,height:520},"App",null,"black");Dr(n).catch(console.error)}async function Dr(e){const n=e.querySelector(".p-2");n.className="p-2 bg-black h-full overflow-hidden flex flex-col items-center",n.innerHTML="";const t=document.createElement("div");t.className="w-full flex items-center justify-between text-white px-2 pb-2",t.style.fontFamily="monospace",t.innerHTML='<div>Score: <span id="snake-score">0</span></div><div id="snake-status">Playing</div><div>Length: <span id="snake-length">0</span></div>';const o=document.createElement("div");o.className="flex-1 flex items-center justify-center w-full";const r=document.createElement("canvas");r.id="snake-canvas",r.width=560,r.height=420,r.style.background="#000",r.style.border="2px inset #666",o.appendChild(r);const i=document.createElement("div");i.className="text-xs text-gray-300 pt-2",i.textContent="Controls: Arrow keys or W/A/S/D. Press R to restart.",n.appendChild(t),n.appendChild(o),n.appendChild(i);const a=r.getContext("2d"),s=20,c=Math.floor(r.width/s),l=Math.floor(r.height/s);let f=[{x:Math.floor(c/2),y:Math.floor(l/2)}],m={x:1,y:0},u=null,p=0,d=!0,g=8,v=0,x=null;function F(){let h=!1;for(;!h;){const k=Math.floor(Math.random()*c),C=Math.floor(Math.random()*l);h=!f.some(E=>E.x===k&&E.y===C),h&&(u={x:k,y:C})}}function I(){f=[{x:Math.floor(c/2),y:Math.floor(l/2)}],m={x:1,y:0},p=0,d=!0,g=8,F(),R()}function R(){const h=document.getElementById("snake-score"),k=document.getElementById("snake-status"),C=document.getElementById("snake-length");h&&(h.textContent=String(p)),k&&(k.textContent=d?"Playing":"Game Over"),C&&(C.textContent=String(f.length))}function W(){a.fillStyle="#000",a.fillRect(0,0,r.width,r.height),u&&(a.fillStyle="#e3342f",a.fillRect(u.x*s,u.y*s,s,s)),a.fillStyle="#7ed957";for(let h=0;h<f.length;h++){const k=f[h];a.fillRect(k.x*s,k.y*s,s-1,s-1)}}function P(){if(!d)return;const h={x:f[0].x+m.x,y:f[0].y+m.y};if(h.x<0&&(h.x=c-1),h.x>=c&&(h.x=0),h.y<0&&(h.y=l-1),h.y>=l&&(h.y=0),f.some(k=>k.x===h.x&&k.y===h.y)){d=!1,R();return}f.unshift(h),u&&h.x===u.x&&h.y===u.y?(p+=1,p%5===0&&(g=Math.min(20,g+1)),F()):f.pop(),R()}function j(h){v||(v=h);const k=h-v,C=1e3/g;k>=C&&(P(),W(),v=h),x=requestAnimationFrame(j)}function H(h){const k=h.key;(k==="ArrowUp"||k==="w"||k==="W")&&m.y===0&&(m={x:0,y:-1}),(k==="ArrowDown"||k==="s"||k==="S")&&m.y===0&&(m={x:0,y:1}),(k==="ArrowLeft"||k==="a"||k==="A")&&m.x===0&&(m={x:-1,y:0}),(k==="ArrowRight"||k==="d"||k==="D")&&m.x===0&&(m={x:1,y:0}),(k==="r"||k==="R")&&I()}r.addEventListener("click",()=>r.focus()),r.setAttribute("tabindex","0"),r.style.outline="none",document.addEventListener("keydown",H);const $=new MutationObserver(h=>{h.forEach(k=>{k.removedNodes.forEach(C=>{C.id==="snake"&&(N(),$.disconnect())})})});$.observe(document.getElementById("windows-container"),{childList:!0});function N(){d=!1,x&&cancelAnimationFrame(x),document.removeEventListener("keydown",H)}I(),W(),x=requestAnimationFrame(j)}function ct(e){const n=document.getElementById(e);if(n)if(e==="keyboard")console.log("🔍 Skipping generic keyboard element, will handle in keyboard case");else{const o=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,i)=>getComputedStyle(i).zIndex>getComputedStyle(r).zIndex?i:r,n);n.style.zIndex=`${parseInt(getComputedStyle(o).zIndex)+1}`;return}if(console.log("🔍 Checking app cases..."),e==="mailbox"&&Wn(),e==="tubestream"&&Rn(),e==="watercolour"&&qn(),e==="calculator"&&Un(),e==="solitaire"&&Yn(),e==="chess"&&Zn(),e==="bombbroomer"&&io(),e==="mediaplayer"&&so(),e==="compostbin"&&$n(),e==="storage"&&vo(),e==="pong"&&Lr(),e==="snake"&&Ar(),e==="keyboard"){const t=document.getElementById("keyboard-app");if(t){console.log("🔍 Keyboard app window already exists, bringing to front");const r=[...document.querySelectorAll("*")].filter(i=>getComputedStyle(i).zIndex>100&&getComputedStyle(i).zIndex<1e3).reduce((i,a)=>getComputedStyle(a).zIndex>getComputedStyle(i).zIndex?a:i,t);t.style.zIndex=`${parseInt(getComputedStyle(r).zIndex)+1}`;return}Er().catch(console.error)}console.log("🔍 Finished checking all cases")}let ee={isActive:!1,selectedIcon:null,cutIcon:null,moveStep:20,gridStep:112};function Br(e){ee.isActive=!0,ee.selectedIcon=e,e.classList.add("dragging","keyboard-dragging"),e.style.zIndex="1000",zr(e),Le("Drag mode activated. Use arrow keys to move, Enter to drop, or Escape to cancel."),Wr()}function dt(e=!1){if(!ee.isActive||!ee.selectedIcon)return;const n=ee.selectedIcon;n.classList.remove("dragging","keyboard-dragging"),n.style.zIndex="",Nr(),Rr(),e?(Xe(n),ne[n.id]={left:n.style.left,top:n.style.top},_(),Le("Icon moved successfully.")):Le("Drag operation cancelled."),ee.isActive=!1,ee.selectedIcon=null}function Tr(e,n){if(!ee.isActive)return;const t=parseInt(e.style.left)||0,o=parseInt(e.style.top)||0,r=ee.moveStep;let i=t,a=o;switch(n){case"ArrowUp":a=Math.max(16,o-r);break;case"ArrowDown":a=o+r;break;case"ArrowLeft":i=Math.max(16,t-r);break;case"ArrowRight":i=t+r;break}e.style.left=i+"px",e.style.top=a+"px",fo(e,i+48,a+48)}function Fr(e){if(!ee.isActive)return;const n=parseInt(e.style.left)||0,t=parseInt(e.style.top)||0,o=ee.gridStep,r=16+Math.round((n-16)/o)*o,i=16+Math.round((t-16)/o)*o;e.style.left=Math.max(16,r)+"px",e.style.top=Math.max(16,i)+"px",Le("Icon snapped to grid.")}function $r(e){ee.cutIcon&&ee.cutIcon.classList.remove("cut-icon"),ee.cutIcon=e,e.classList.add("cut-icon"),Le("Icon cut. Navigate to destination and press Ctrl+V to paste.")}function Pr(){if(!ee.cutIcon){Le("No icon to paste.");return}const e=document.activeElement,n=ee.cutIcon;if(e&&e.classList.contains("draggable-icon")){const t=e.getBoundingClientRect(),o=document.getElementById("desktop").getBoundingClientRect(),r=t.left-o.left+120,i=t.top-o.top;n.style.left=r+"px",n.style.top=i+"px",Xe(n),ne[n.id]={left:n.style.left,top:n.style.top},_()}n.classList.remove("cut-icon"),ee.cutIcon=null,Le("Icon pasted successfully.")}function zr(e){document.querySelectorAll(".desktop-folder-icon[data-item-id]").forEach(n=>{const t=Je(n.getAttribute("data-item-id")),o=n.getAttribute("data-item-id");(t&&t.type==="folder"||o==="compostbin")&&n!==e&&n.classList.add("drag-hover-target")})}function Nr(){document.querySelectorAll(".drag-hover-target").forEach(e=>{e.classList.remove("drag-hover-target")}),document.querySelectorAll(".desktop-folder-icon").forEach(e=>{e.classList.remove("dragover")})}function Wr(e){const n=document.createElement("div");n.id="keyboard-drag-indicator",n.className="fixed bottom-4 left-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50",n.innerHTML=`
    <div class="text-sm font-medium">Keyboard Drag Mode</div>
    <div class="text-xs">↑↓←→ Move • Enter Drop • Esc Cancel • G Grid Snap</div>
  `,document.body.appendChild(n)}function Rr(){const e=document.getElementById("keyboard-drag-indicator");e&&e.remove()}function Le(e,n="polite"){let t=document.getElementById("sr-announcements");t||(t=document.createElement("div"),t.id="sr-announcements",t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),t.className="sr-only",document.body.appendChild(t)),t.textContent=e,setTimeout(()=>{t.textContent=""},1e3)}async function Or(e){if(!ee.isActive)return;const n=e.getBoundingClientRect(),t=n.left+n.width/2,o=n.top+n.height/2,r=document.elementFromPoint(t,o),i=r==null?void 0:r.closest(".desktop-folder-icon[data-item-id]");if(i&&i!==e){const a=e.getAttribute("data-item-id"),s=i.getAttribute("data-item-id"),c=Je(s);if(s==="compostbin"){await Pn(a,"C://Desktop"),Le("Icon moved to compost bin."),dt(!0);return}else if(c&&c.type==="folder"){await Ct(a,s),Le(`Icon moved to ${c.name} folder.`),dt(!0);return}}dt(!0)}function Et(e){let n=!1,t,o,r=5,i=0;e.addEventListener("pointerdown",function(a){if(!a.isPrimary||ee.isActive)return;a.preventDefault(),n=!1,t=a.clientX,o=a.clientY,i=Date.now();const s=e.getBoundingClientRect(),c=a.clientX-s.left,l=a.clientY-s.top,f=a.pointerType==="touch";function m(p){if(!p.isPrimary)return;const d=Math.sqrt(Math.pow(p.clientX-t,2)+Math.pow(p.clientY-o,2));!n&&d>r&&(n=!0,e.classList.add("dragging"),f&&(e.classList.add("touch-dragging"),navigator.vibrate&&navigator.vibrate(50)),e.style.zIndex="1000",document.querySelectorAll(".desktop-folder-icon[data-item-id]").forEach(g=>{const v=Je(g.getAttribute("data-item-id")),x=g.getAttribute("data-item-id");(v&&v.type==="folder"||x==="compostbin")&&g!==e&&g.classList.add("drag-hover-target")}),document.body.style.overflow="hidden",Le("Drag started. Move to reposition or drop on a folder.")),n&&(e.style.left=p.clientX-c+"px",e.style.top=p.clientY-l+"px",e.style.position="absolute",Xe(e),fo(p.clientX,p.clientY,e))}async function u(p){if(p.isPrimary){if(document.removeEventListener("pointermove",m),document.removeEventListener("pointerup",u),document.removeEventListener("pointercancel",u),n){e.style.zIndex="",e.classList.remove("dragging");const d=e.style.pointerEvents;e.style.pointerEvents="none";const g=document.elementFromPoint(p.clientX,p.clientY);e.style.pointerEvents=d;const v=g?g.closest(".desktop-folder-icon[data-item-id]"):null,x=g?g.closest(".file-explorer-window"):null;if(v&&v!==e){const F=v.getAttribute("data-item-id"),I=Je(F),R=e.getAttribute("data-item-id");if(R!==F){if(F==="compostbin"){await Pn(R,"C://Desktop");return}else if(I&&I.type==="folder"){await Ct(R,F);return}}}else if(x){const F=e.getAttribute("data-item-id"),I=x.getAttribute("data-current-path");if(I&&F){await Ot(F,I);return}}Xe(e),ne[e.id]={left:e.style.left,top:e.style.top},_()}document.querySelectorAll(".drag-hover-target").forEach(d=>{d.classList.remove("drag-hover-target")}),document.querySelectorAll(".desktop-folder-icon").forEach(d=>{d.classList.remove("dragover")}),document.querySelectorAll(".file-explorer-window").forEach(d=>{d.classList.remove("dragover")}),document.body.style.overflow="",n=!1}}document.addEventListener("pointermove",m),document.addEventListener("pointerup",u),document.addEventListener("pointercancel",u)}),e.addEventListener("click",function(a){const s=Date.now()-i;!n&&s>100&&(document.querySelectorAll(".draggable-icon").forEach(c=>c.classList.remove("bg-gray-50")),e.classList.add("bg-gray-50"))})}function qr(){const e=document.getElementById("bgColorInput").value,n=document.getElementById("bgImageInput").value.trim(),t=document.getElementById("clockSecondsInput").checked;le.bgColor=e,le.bgImage=n,le.clockSeconds=t,uo(),_()}async function ae(){const e=document.getElementById("desktop-icons");e.innerHTML="",document.getElementById("windows-container").querySelectorAll(".desktop-folder-icon").forEach(p=>{p.parentElement&&p.parentElement.classList.contains("draggable-icon")&&p.parentElement.remove()});let o=await Ce();if(!o||!o.folders||!o.folders["C://Desktop"]){if(typeof jt=="function")await jt(),o=await Ce();else if(console.warn("initializeAppState not available, using default fileSystemState"),typeof window.fileSystemState<"u"?o=window.fileSystemState:typeof Me<"u"?o=Me:(console.error("No fileSystemState available, creating minimal fallback structure"),o={folders:{"C://":{Documents:{id:"Documents",name:"Documents",type:"folder",fullPath:"C://Documents",contents:{}},Desktop:{id:"Desktop",name:"Desktop",type:"folder",fullPath:"C://Desktop",contents:{compostbin:{id:"compostbin",name:"Compost Bin",type:"app",fullPath:"C://Desktop/compostbin",content_type:"html",contents:{},icon:"./image/compost-bin.webp"}}},Media:{id:"Media",name:"Media",type:"folder",fullPath:"C://Media",contents:{}}},"A://":{},"D://":{}}}),typeof ue=="function")try{ue(o)}catch(p){console.warn("Failed to update global file system state:",p)}}if(!o||!o.folders||!o.folders["C://Desktop"]){console.error("File system structure is still invalid after initialization attempts:",o);return}const r=o.folders["C://Desktop"]||{};r||(o.folders["C://Desktop"]={});const i=96,a=128,s=16,c=16,l=16,f=window.innerHeight-80,m=Math.floor((f-l)/(a+s));let u=0;Object.values(r).forEach(p=>{const d=document.createElement("div");d.id="icon-"+p.id,d.className="flex flex-col items-center cursor-pointer draggable-icon desktop-folder-icon z-10 h-32 truncate-ellipsis w-24 text-wrap absolute",d.setAttribute("role","button"),d.setAttribute("tabindex","0"),d.setAttribute("aria-label",`${p.name} - Double-click to open`);let g=p.type==="folder"?"image/folder.webp":"image/file.webp";p.icon?g=p.icon:p.icon_url&&(g=p.icon_url),d.setAttribute("data-item-id",p.id),d.setAttribute("data-current-path","C://Desktop");const v=()=>{p.type==="ugc-file"||p.type==="file"?Ve(p.id,null):p.type==="app"?ct(p.id):p.type==="folder"?qe(p.id):p.type==="shortcut"&&lt(d)};if(p.type==="ugc-file"||p.type==="file"?(d.addEventListener("dblclick",x=>{x.stopPropagation(),Ve(p.id,x)}),d.addEventListener("mobiledbltap",x=>{x.stopPropagation(),Ve(p.id,x)})):p.type==="app"?(d.dataset.isVendorApplication=!0,g=p.icon,d.addEventListener("dblclick",()=>ct(p.id)),d.addEventListener("mobiledbltap",()=>ct(p.id))):p.type==="folder"?(d.addEventListener("dblclick",()=>qe(p.id)),d.addEventListener("mobiledbltap",()=>qe(p.id))):p.type==="shortcut"&&(d.dataset.url=p.url,g=p.icon_url,d.addEventListener("dblclick",()=>lt(d)),d.addEventListener("mobiledbltap",()=>lt(d))),d.addEventListener("keydown",function(x){if(x.key==="Enter"||x.key===" ")ee.isActive&&ee.selectedIcon===d?(x.preventDefault(),Or(d)):ee.isActive||(x.preventDefault(),v());else if(x.key==="Escape")ee.isActive&&ee.selectedIcon===d&&(x.preventDefault(),dt(!1));else if(x.key==="d"&&(x.ctrlKey||x.metaKey))x.preventDefault(),Br(d);else if(x.key==="x"&&(x.ctrlKey||x.metaKey))x.preventDefault(),$r(d);else if(x.key==="v"&&(x.ctrlKey||x.metaKey))x.preventDefault(),Pr();else if(x.key==="g"&&ee.isActive&&ee.selectedIcon===d)x.preventDefault(),Fr(d);else if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(x.key)){if(ee.isActive&&ee.selectedIcon===d)x.preventDefault(),Tr(d,x.key);else if(x.shiftKey){x.preventDefault();const F=parseInt(d.style.left)||0,I=parseInt(d.style.top)||0,R=5;let W=F,P=I;switch(x.key){case"ArrowUp":P=Math.max(16,I-R);break;case"ArrowDown":P=I+R;break;case"ArrowLeft":W=Math.max(16,F-R);break;case"ArrowRight":W=F+R;break}d.style.left=W+"px",d.style.top=P+"px",Xe(d),ne[d.id]={left:d.style.left,top:d.style.top},_(),Le(`Icon moved to position ${W}, ${P}`)}}}),d.innerHTML=`
      <img src="${g}" alt="${p.name} icon" class="mb-1 p-1 h-16 w-16 desktop-folder-icon" />
      <span class="text-xs text-black max-w-20 text-center desktop-folder-icon truncate block">${p.name}</span>
    `,ne[d.id]){const x=ne[d.id];d.style.left=x.left,d.style.top=x.top}else{const x=Math.floor(u/m),F=u%m,I=c+x*(i+s),R=l+F*(a+s);d.style.left=I+"px",d.style.top=R+"px",u++}e.appendChild(d),Et(d),po(d)}),typeof be=="function"&&be()}function uo(){const e=document.getElementById("desktop");le.bgColor&&(e.style.backgroundColor=le.bgColor),le.bgImage?(e.style.backgroundImage=`url(${le.bgImage})`,e.style.backgroundSize="cover",e.style.backgroundRepeat="no-repeat"):e.style.backgroundImage="none"}function _r(){return`
    <div class="space-y-4">
      <div>
        <label for="bgColorInput" class="block text-sm font-medium">Desktop Background Color:</label>
        <input id="bgColorInput" type="color" value="${le.bgColor}" class="border mt-1" aria-describedby="bgColorHelp" />
        <p id="bgColorHelp" class="text-xs text-gray-600 mt-1">Choose a color for your desktop background</p>
      </div>
      <div>
        <label for="bgImageInput" class="block text-sm font-medium">Background Image URL:</label>
        <input id="bgImageInput" type="text" placeholder="Enter image URL" value="${le.bgImage}" class="border w-full mt-1" aria-describedby="bgImageHelp" />
        <p id="bgImageHelp" class="text-xs text-gray-600 mt-1">Enter a URL to display an image as your desktop background</p>
      </div>
      <div>
        <label for="clockSecondsInput" class="block text-sm font-medium">Show Seconds on Clock:</label>
        <input id="clockSecondsInput" type="checkbox" ${le.clockSeconds?"checked":""} class="mt-1" aria-describedby="clockSecondsHelp" />
        <p id="clockSecondsHelp" class="text-xs text-gray-600 mt-1">Display seconds in the taskbar clock</p>
      </div>
      <button id="settings-apply-button"
              class="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2"
              aria-label="Apply desktop settings changes">
        <span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Apply</span>
      </button>
    </div>
  `}function Xe(e){const t=document.getElementById("desktop").getBoundingClientRect(),o=e.getBoundingClientRect();let r=parseInt(e.style.left)||0,i=parseInt(e.style.top)||0;r=Math.max(0,Math.min(r,t.width-o.width)),i=Math.max(0,Math.min(i,t.height-o.height-40)),e.style.left=r+"px",e.style.top=i+"px"}function Je(e){const n=V();for(const t in n.folders){const o=n.folders[t];if(o[e])return o[e];if(o.contents&&o.contents[e])return o.contents[e]}return null}function po(e){let n=0;e.addEventListener("pointerdown",function(t){let o=new Date().getTime(),r=o-n;if(r<300&&r>0){let i=new Event("mobiledbltap");e.dispatchEvent(i)}n=o})}document.querySelectorAll("[onmobiledbltap]").forEach(e=>{po(e),e.addEventListener("mobiledbltap",function(){let n=e.getAttribute("onmobiledbltap");if(n)try{const t=new CustomEvent("mobiledbltap-action",{detail:{action:n,element:e}});document.dispatchEvent(t)}catch(t){console.error(`Error dispatching event for: ${n}`,t)}})});document.addEventListener("mobiledbltap-action",function(e){const{action:n,element:t}=e.detail,o=["openExplorerInNewWindow","openApp","openShortcut"],r=n.match(/^(\w+)\((.*)\)$/);if(r){const[,i,a]=r;if(o.includes(i))try{if(i==="openExplorerInNewWindow"&&window.openExplorerInNewWindow){const s=a.replace(/['"]/g,"");window.openExplorerInNewWindow(s)}else if(i==="openApp"&&window.openApp){const s=a.replace(/['"]/g,"");window.openApp(s)}else i==="openShortcut"&&window.openShortcut&&window.openShortcut(t)}catch(s){console.error(`Error executing safe action ${i}:`,s)}else console.warn(`Blocked potentially unsafe action: ${i}`)}else console.warn(`Invalid action format: ${n}`)});function fo(e,n,t){document.querySelectorAll(".desktop-folder-icon").forEach(s=>{s.classList.remove("dragover")}),document.querySelectorAll(".file-explorer-window").forEach(s=>{s.classList.remove("dragover")});const o=t.style.pointerEvents;t.style.pointerEvents="none";const r=document.elementFromPoint(e,n),i=r?r.closest(".desktop-folder-icon[data-item-id]"):null,a=r?r.closest(".file-explorer-window"):null;if(t.style.pointerEvents=o,i&&i!==t){const s=i.getAttribute("data-item-id"),c=Je(s);(c&&c.type==="folder"||s==="compostbin")&&i.classList.add("dragover")}else a&&a.classList.add("dragover")}typeof window<"u"&&(window.renderDesktopIcons=ae,window.makeIconDraggable=Et,window.applyDesktopSettings=uo,Hr());function be(){requestAnimationFrame(()=>{document.querySelectorAll(".file-item").forEach(o=>{o.removeEventListener("dragstart",mn),o.removeEventListener("dragover",gn),o.removeEventListener("dragleave",yn),o.removeEventListener("drop",bn),o.removeEventListener("dragend",hn),o.setAttribute("draggable",!0),o.addEventListener("dragstart",mn),o.addEventListener("dragover",gn),o.addEventListener("dragleave",yn),o.addEventListener("drop",bn),o.addEventListener("dragend",hn)}),document.querySelectorAll(".file-explorer-window").forEach(o=>{o.removeEventListener("dragover",kn),o.removeEventListener("dragleave",Sn),o.removeEventListener("drop",En),o.addEventListener("dragover",kn),o.addEventListener("dragleave",Sn),o.addEventListener("drop",En)}),document.querySelectorAll(".desktop-folder-icon[data-item-id]").forEach(o=>{const r=o.getAttribute("data-item-id"),i=en(r);(i&&i.type==="folder"||r==="compostbin")&&(o.removeEventListener("dragover",wn),o.removeEventListener("dragleave",vn),o.removeEventListener("drop",xn),o.addEventListener("dragover",wn),o.addEventListener("dragleave",vn),o.addEventListener("drop",xn))})})}function mn(e){e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",this.getAttribute("data-item-id")),this.classList.add("dragging")}function gn(e){(e.dataTransfer.types.includes("application/x-compost-item")||e.dataTransfer.types.includes("text/plain"))&&(e.preventDefault(),e.dataTransfer.dropEffect="move",this.classList.add("dragover"))}function yn(e){this.classList.remove("dragover")}async function bn(e){e.stopPropagation(),this.classList.remove("dragover");const n=e.dataTransfer.getData("text/plain"),t=this.getAttribute("data-item-id"),o=e.dataTransfer.getData("application/x-compost-item")==="true";if(n===t)return;const r=document.querySelector(`[data-item-id="${n}"]`),i=this;if(o){if(i.classList.contains("folder-item")){const a=i.closest(".file-explorer-window"),s=a?a.getAttribute("data-current-path"):"C://",c=s==="C://"?s+t:s+"/"+t;await tn(n,c)}return}if(i.classList.contains("folder-item"))await Ct(n,t);else{const a=this.getBoundingClientRect(),s=e.clientY-a.top,c=this.parentElement;s<a.height/2?c.insertBefore(r,this):c.insertBefore(r,this.nextSibling),await jr()}r&&r.classList.remove("dragging")}function hn(e){this.classList.remove("dragging"),document.querySelectorAll(".file-item").forEach(t=>t.classList.remove("dragover"));const n=document.getElementById("desktop");n&&n.classList.remove("drag-hover-target"),document.querySelectorAll(".drag-hover-target").forEach(t=>{t.classList.remove("drag-hover-target")})}async function Ct(e,n){let t=V();const o=Qt(e,t);if(!o){console.error("Item not found:",e);return}const{item:r,parent:i}=o,a=r.fullPath&&r.fullPath.includes("C://Desktop");if(delete i[e],a){const l="icon-"+e;ne[l]&&delete ne[l]}let s=findFolderFullPathById(n),c=findFolderObjectByFullPath(s,t);if(!c){console.error("Target folder not found:",n);return}c.contents||(c.contents={}),c.contents[e]=r,/^[A-Z]:\/\/$/.test(s)||(t.folders[s]||(t.folders[s]={}),t.folders[s][e]=r),r.fullPath=s+"/"+r.name,await ue(t),_(),ze(),(s.includes("Desktop")||mo(e).includes("Desktop"))&&ae()}async function Ot(e,n){let t=V();const o=Qt(e,t);if(!o){console.error("Item not found:",e);return}const{item:r,parent:i}=o,a=r.fullPath&&r.fullPath.includes("C://Desktop");if(delete i[e],a){const s="icon-"+e;typeof ne<"u"&&ne[s]&&delete ne[s]}t.folders[n]||(t.folders[n]={}),t.folders[n][e]=r,r.fullPath=n+"/"+r.name,await ue(t),_(),ze(),(n.includes("Desktop")||a)&&ae()}async function jr(){const e=document.querySelector(".file-explorer-window");if(!e)return;const n=e.getAttribute("data-current-path"),t=Array.from(e.querySelectorAll("ul > li"));let o=V(),r=findFolderObjectByFullPath(n,o);if(!r||!r.contents)return;let i={};t.forEach(a=>{const s=a.getAttribute("data-item-id");r.contents[s]&&(i[s]=r.contents[s])}),r.contents=i,await ue(o),_()}function Qt(e,n){for(const t in n.folders){const o=n.folders[t];if(o[e])return{item:o[e],parent:o};if(o.contents&&o.contents[e])return{item:o.contents[e],parent:o.contents}}return null}function en(e){const n=V();for(const t in n.folders){const o=n.folders[t];if(o[e])return o[e];if(o.contents&&o.contents[e])return o.contents[e]}return null}function mo(e){const n=V();for(const t in n.folders){const o=n.folders[t];if(o[e]||o.contents&&o.contents[e])return t}return""}function wn(e){(e.dataTransfer.types.includes("application/x-compost-item")||e.dataTransfer.types.includes("text/plain"))&&(e.preventDefault(),e.dataTransfer.dropEffect="move",this.classList.add("dragover"))}function vn(e){this.classList.remove("dragover")}async function xn(e){e.preventDefault(),e.stopPropagation(),this.classList.remove("dragover");const n=e.dataTransfer.getData("text/plain"),t=this.getAttribute("data-item-id"),o=e.dataTransfer.getData("application/x-compost-item")==="true";if(n&&t&&n!==t)if(o){const r=en(t);r&&r.type==="folder"&&await tn(n,r.fullPath)}else if(t==="compostbin"){const r=mo(n);await moveItemToCompostBin(n,r)}else await Ct(n,t)}function kn(e){e.dataTransfer.types.includes("text/plain")&&(e.preventDefault(),e.dataTransfer.dropEffect="move",this.classList.add("dragover"))}function Sn(e){this.contains(e.relatedTarget)||this.classList.remove("dragover")}async function En(e){e.preventDefault(),e.stopPropagation(),this.classList.remove("dragover");const n=e.dataTransfer.getData("text/plain"),t=this.getAttribute("data-current-path");if(n&&t){const o=en(n);if(o){const r=o.fullPath;if(r&&r.startsWith(t))return;r&&r.includes("C://Desktop")?await Ot(n,t):await Ot(n,t)}}}be();async function tn(e,n){const t=V(),r=(t.folders["C://Desktop"]||{}).compostbin;if(!r||!r.contents||!r.contents[e]){console.error("Item not found in compost bin:",e);return}const i=r.contents[e];delete r.contents[e];let a;if(n==="C://Desktop")t.folders["C://Desktop"]||(t.folders["C://Desktop"]={}),a=t.folders["C://Desktop"];else{const c=findFolderObjectByFullPath(n,t);if(!c){console.error("Target folder not found:",n);return}c.contents||(c.contents={}),a=c.contents}i.fullPath=n+"/"+i.id,a[e]=i,await ue(t),_(),ze(),ae();const s=document.getElementById("compost-bin");if(s){const c=s.querySelector("#compost-bin-content");c&&(loadCompostBinContents(c),updateCompostBinHeader(s))}}function Hr(){const e=document.getElementById("desktop");e&&(e.addEventListener("dragover",n=>{const t=n.dataTransfer.types.includes("application/x-compost-item"),o=n.dataTransfer.types.includes("text/plain");(t||o)&&(n.preventDefault(),n.dataTransfer.dropEffect="move",e.classList.add("drag-hover-target"))}),e.addEventListener("dragleave",n=>{e.contains(n.relatedTarget)||e.classList.remove("drag-hover-target")}),e.addEventListener("drop",async n=>{n.preventDefault(),e.classList.remove("drag-hover-target");const t=n.dataTransfer.getData("application/x-compost-item")==="true",o=n.dataTransfer.getData("text/plain");o&&(t?await tn(o,"C://Desktop"):await Ur(o))}))}async function Ur(e){const n=V(),t=Qt(e,n);if(!t){console.error("Item not found:",e);return}const{item:o,parent:r}=t;o.fullPath&&o.fullPath==="C://Desktop/"+o.id||(delete r[e],n.folders["C://Desktop"]||(n.folders["C://Desktop"]={}),n.folders["C://Desktop"][e]=o,o.fullPath="C://Desktop/"+o.id,await ue(n),_(),ze(),ae())}function nn(e,n){const t={calculator:"image/calculator.webp",mediaplayer:"image/video.webp",bombbroomer:"image/bombbroomer.webp",solitaire:"image/solitaire.webp",pong:"image/pong.webp",snake:"image/snake.webp",chess:"image/guillotine_chess.webp",mailbox:"image/mail.webp",watercolour:"image/watercolour.webp",compostbin:"image/compost-bin.webp",storage:"image/drive_c.webp","explorer-window":"image/computer.webp",tubestream:"image/video.webp"},o={Settings:"image/gears.webp","About This Computer":"image/info.webp","My Computer":"image/computer.webp","File Explorer":"image/computer.webp","Media Player":"image/video.webp",Calculator:"image/calculator.webp",Bombbroomer:"image/bombbroomer.webp",Solitaire:"image/solitaire.webp","Guillotine Chess":"image/guillotine_chess.webp",Chess:"image/guillotine_chess.webp","Inpeek Mailbox":"image/mail.webp",Watercolour:"image/watercolour.webp","Compost Bin":"image/compost-bin.webp","Storage Manager":"image/drive_c.webp",TubeStream:"image/video.webp","Security Policy":"image/info.webp"};if(t[e])return t[e];if(o[n])return o[n];if(e&&e.includes("-")){const r=n.toLowerCase(),i=e.toLowerCase();if(r.match(/\.(jpg|jpeg|png|gif|webp|avif|bmp)$/i)||i.match(/\.(jpg|jpeg|png|gif|webp|avif|bmp)$/i))return"image/image.webp";if(r.match(/\.(mp4|webm|avi|mov|mkv)$/i)||i.match(/\.(mp4|webm|avi|mov|mkv)$/i))return"image/video.webp";if(r.match(/\.(mp3|wav|ogg|m4a|flac)$/i)||i.match(/\.(mp3|wav|ogg|m4a|flac)$/i))return"image/audio.webp";if(r.match(/\.(txt|md|doc|docx)$/i)||i.match(/\.(txt|md|doc|docx)$/i)||r.includes("letterpad"))return"image/file.webp";if(r.match(/\.(html|htm)$/i)||i.match(/\.(html|htm)$/i))return"image/html.webp"}return n.includes("LetterPad")||n.includes(".md")||n.includes(".txt")?"image/file.webp":n.includes(".jpg")||n.includes(".png")||n.includes(".gif")||n.includes(".webp")||n.includes(".jpeg")||n.includes(".bmp")||n.includes(".avif")?"image/image.webp":n.includes(".mp4")||n.includes(".webm")||n.includes(".avi")||n.includes(".mov")||n.includes(".mkv")?"image/video.webp":n.includes(".mp3")||n.includes(".wav")||n.includes(".ogg")||n.includes(".m4a")||n.includes(".flac")?"image/audio.webp":n.includes(".html")||n.includes(".htm")?"image/html.webp":null}function Z(e,n,t=!1,o=null,r=!1,i=!1,a={type:"default"},s="default",c=null,l="white",f=null){let m=n;o||(o="window-"+Date.now()),s==="Settings"&&(m=_r()),s==="Explorer"&&(m=n||getExplorerWindowContent()),s==="App"&&(m=n);let u="";a.type==="integer"?u=`width: ${a.width}px; height: ${a.height}px; max-width:100%; max-height:100%;`:u="width: 100%; height: 100%;";const p=document.createElement("div");p.id=o,p.className="absolute border border-gray-500 shadow-lg overflow-auto z-20",p.style.cssText=u,p.style.minWidth="350px",p.style.minHeight="240px",p.setAttribute("role","dialog"),p.setAttribute("aria-label",e),p.setAttribute("aria-modal","false"),r?(p.style.display="none",p.setAttribute("aria-hidden","true")):p.setAttribute("aria-hidden","false"),p.textContent="";const d=document.createElement("div");d.className="relative w-full h-[calc(100%-2.5rem)]";const g=document.createElement("div");g.className="bg-handlebar-blue sticky top-0 left-0 text-white px-2 py-1 flex justify-between items-center cursor-move",g.style.backgroundColor="#003f7f",g.setAttribute("role","banner");const v=document.createElement("span");v.textContent=e,v.className="window-title flex-1 truncate pr-2",v.style.maxWidth="calc(100% - 120px)",v.id=`${o}-title`;const x=document.createElement("div");x.className="my-1 flex-shrink-0",x.setAttribute("role","group"),x.setAttribute("aria-label","Window controls");const F=document.createElement("button");F.id=`minimizeWindow-${o}`,F.className="bg-yellow-500 h-6 w-6 text-white",F.textContent="_",F.setAttribute("aria-label",`Minimize ${e}`),F.setAttribute("title","Minimize window"),F.addEventListener("click",C=>{He(o),C.stopPropagation()});const I=document.createElement("button");I.id=`toggleFullScreen-${o}`,I.className="bg-green-500 h-6 w-6 text-white ml-1",I.textContent="⛶",I.setAttribute("aria-label",`Toggle fullscreen for ${e}`),I.setAttribute("title","Toggle fullscreen"),I.addEventListener("click",C=>{on(o),C.stopPropagation()});const R=document.createElement("button");R.id=`closeWindow-${o}`,R.className="bg-red-500 h-6 w-6 text-white ml-1",R.textContent="X",R.setAttribute("aria-label",`Close ${e}`),R.setAttribute("title","Close window"),R.addEventListener("click",C=>{ie(o),C.stopPropagation()}),x.append(F,I,R),g.append(v,x);const W=document.createElement("div");W.className=`p-2 bg-${l} h-full ${s==="editor"?"w-full":""} overflow-auto`,W.innerHTML=m,W.setAttribute("role","main"),W.setAttribute("aria-labelledby",`${o}-title`),s==="default"&&(W.contentEditable="true",W.setAttribute("role","textbox"),W.setAttribute("aria-label",`Editable content for ${e}`),W.addEventListener("input",()=>{updateContent(o,W.innerHTML)})),s==="Explorer"&&setTimeout(()=>{typeof be=="function"&&be()},50),d.append(g,W),p.appendChild(d),f!=null?(p.style.zIndex=f,parseInt(f)>ve&&_t(parseInt(f))):(_t(ve+1),p.style.zIndex=ve),p.addEventListener("click",function(){Ie(p)}),document.getElementById("windows-container").appendChild(p);const P=document.createElement("div");P.id="tab-"+o,P.className="bg-gray-200 border border-gray-500 px-2 py-1 cursor-pointer flex items-center",P.setAttribute("role","tab"),P.setAttribute("aria-label",`${e} window tab`),P.setAttribute("aria-pressed",r?"false":"true"),P.setAttribute("tabindex","0");const j=nn(o,e);if(j){const C=document.createElement("img");C.src=j,C.className="h-4 w-4 mr-2",C.alt="",P.appendChild(C);const E=document.createElement("span");E.textContent=e,P.appendChild(E)}else P.textContent=e;const H=function(){p.style.display==="none"?(Ie(p),P.setAttribute("aria-pressed","true")):(He(p.id),P.setAttribute("aria-pressed","false"))};P.onclick=H,P.addEventListener("keydown",function(C){(C.key==="Enter"||C.key===" ")&&(C.preventDefault(),H())}),P.addEventListener("contextmenu",function(C){C.preventDefault(),Zr(C,o,p)}),document.getElementById("window-tabs").appendChild(P);const $=G[o],N=$?$.position:null,h=$?$.dimensions:a,k=$?$.fullScreen:!1;if(G[o]={id:o,title:e,content:m,isNav:t,isMinimized:r,dimensions:i&&$?h:a,windowType:s,position:N,fullScreen:k,color:l,zIndex:parseInt(p.style.zIndex)||ve},t&&(xe[e]=o),r||Ie(p),a.type!=="default"){if(i&&N&&(p.style.left=N.left,p.style.top=N.top),i&&h&&h.type==="integer"&&(p.style.width=h.width+"px",p.style.height=h.height+"px"),!i||!N)if(c){let C=parseInt(c.style.left,10)||0,E=parseInt(c.style.top,10)||0,z=C+30,X=E+30,oe=window.innerWidth,J=window.innerHeight-40,pe=a.width,Ae=a.height;if(z+pe>oe||X+Ae>J){z=0,X=0;const ce=Array.from(document.querySelectorAll("#windows-container > div")).find(ke=>(parseInt(ke.style.left,10)||0)<=10&&(parseInt(ke.style.top,10)||0)<=10);ce&&(z=(parseInt(ce.style.left,10)||0)+30)}p.style.left=z+"px",p.style.top=X+"px"}else p.style.left="100px",p.style.top="100px";bo(p),ho(p)}return i||_(),p}function He(e){const n=document.getElementById(e);if(n){n.style.display="none",n.setAttribute("aria-hidden","true"),G[e]&&(G[e].isMinimized=!0,_());const t=document.getElementById("tab-"+e);t&&(t.classList.remove("bg-gray-50"),t.setAttribute("aria-pressed","false"))}}function Ie(e){let n=!1;if(e.style.display==="none"){e.style.display="block",e.setAttribute("aria-hidden","false"),G[e.id]&&(G[e.id].isMinimized=!1,n=!0);const o=document.getElementById("tab-"+e.id);o&&o.setAttribute("aria-pressed","true")}_t(ve+1),e.style.zIndex=ve,G[e.id]&&(G[e.id].zIndex=ve,n=!0),n&&_(),document.querySelectorAll("#window-tabs > div").forEach(o=>o.classList.remove("bg-gray-50"));const t=document.getElementById("tab-"+e.id);t&&t.classList.add("bg-gray-50"),e.querySelector("video, audio")&&(Co(e.id),updateMediaControl())}let Re=-1,mt=!1;function Kr(){const e=Array.from(document.querySelectorAll("#windows-container > div")).filter(n=>n.style.display!=="none"&&n.id!=="taskbar");if(e.length!==0){if(e.length===1){Ie(e[0]);return}e.sort((n,t)=>{const o=parseInt(n.style.zIndex)||0;return(parseInt(t.style.zIndex)||0)-o}),mt?Re=(Re+1)%e.length:(Yr(e),mt=!0,Re=0),go(Re)}}function Yr(e){const n=document.getElementById("window-cycle-popup"),t=document.getElementById("window-cycle-list");if(!n||!t)return;t.innerHTML="",e.forEach((r,i)=>{var m;const a=((m=r.querySelector(".window-title"))==null?void 0:m.textContent)||"Unknown Window",s=r.id,c=nn(s,a),l=document.createElement("div");if(l.className="flex flex-col items-center p-3 border-2 border-transparent rounded-lg min-w-16 cursor-pointer hover:bg-gray-100 transition-all duration-200",l.setAttribute("data-window-index",i),c){const u=document.createElement("img");u.src=c,u.className="h-8 w-8 mb-1",u.alt="",l.appendChild(u)}else{const u=document.createElement("div");u.className="h-8 w-8 mb-1 bg-gray-400 rounded flex items-center justify-center text-white text-sm",u.textContent=a.charAt(0),l.appendChild(u)}const f=document.createElement("span");f.className="text-xs text-center break-words max-w-16",f.textContent=a.length>10?a.substring(0,10)+"...":a,l.appendChild(f),l.addEventListener("click",()=>{Re=i,yo(e[i])}),t.appendChild(l)});const o=r=>{t.contains(r.target)||(gt(),n.removeEventListener("click",o))};n.addEventListener("click",o),n.classList.remove("hidden"),n.style.display="flex",go(0)}function go(e){const n=document.querySelectorAll("#window-cycle-list > div");n.forEach(t=>{t.classList.remove("border-blue-500","bg-blue-100"),t.classList.add("border-transparent"),t.style.transform="translateY(0)",t.style.boxShadow="none"}),n[e]&&(n[e].classList.remove("border-transparent"),n[e].classList.add("border-blue-500","bg-blue-100"),n[e].style.transform="translateY(-2px)",n[e].style.boxShadow="0 4px 8px rgba(59, 130, 246, 0.3)")}function yo(e){var r;if(!e)return;Ie(e),e.focus();const n=document.getElementById("window-cycle-popup");n&&(n.classList.add("hidden"),n.style.display="none"),mt=!1,Re=-1;const t=((r=e.querySelector(".window-title"))==null?void 0:r.textContent)||"Unknown Window";let o=document.getElementById("window-cycle-announce");o||(o=document.createElement("div"),o.id="window-cycle-announce",o.className="sr-only",o.setAttribute("aria-live","polite"),o.setAttribute("aria-atomic","true"),document.body.appendChild(o)),o.textContent=`Switched to ${t}`}function gt(){if(mt){const e=Array.from(document.querySelectorAll("#windows-container > div")).filter(n=>n.style.display!=="none"&&n.id!=="taskbar");if(e.length>0){e.sort((t,o)=>{const r=parseInt(t.style.zIndex)||0;return(parseInt(o.style.zIndex)||0)-r});const n=e[Re]||e[0];yo(n)}}}function Cn(){var t;const e=Array.from(document.querySelectorAll("#windows-container > div")).filter(o=>o.style.display!=="none"&&o.id!=="taskbar");if(e.length===0)return;e.sort((o,r)=>{const i=parseInt(o.style.zIndex)||0;return(parseInt(r.style.zIndex)||0)-i});const n=e[0];if(n){ie(n.id);const o=((t=n.querySelector(".window-title"))==null?void 0:t.textContent)||"Unknown Window";let r=document.getElementById("window-cycle-announce");r||(r=document.createElement("div"),r.id="window-cycle-announce",r.className="sr-only",r.setAttribute("aria-live","polite"),r.setAttribute("aria-atomic","true"),document.body.appendChild(r)),r.textContent=`Closed ${o}`}}function Gr(){var t;const e=Array.from(document.querySelectorAll("#windows-container > div")).filter(o=>o.style.display!=="none"&&o.id!=="taskbar");if(e.length===0)return;e.sort((o,r)=>{const i=parseInt(o.style.zIndex)||0;return(parseInt(r.style.zIndex)||0)-i});const n=e[0];if(n){He(n.id);const o=((t=n.querySelector(".window-title"))==null?void 0:t.textContent)||"Unknown Window";let r=document.getElementById("window-cycle-announce");r||(r=document.createElement("div"),r.id="window-cycle-announce",r.className="sr-only",r.setAttribute("aria-live","polite"),r.setAttribute("aria-atomic","true"),document.body.appendChild(r)),r.textContent=`Minimized ${o}`}}function ie(e){const n=document.getElementById(e);n&&n.remove();const t=document.getElementById("tab-"+e);t&&t.remove(),Ue===e&&(Co(null),updateMediaControl()),delete G[e];for(const o in xe)if(xe[o]===e){delete xe[o];break}_()}function bo(e){const n=e.querySelector(".cursor-move");n&&n.addEventListener("mousedown",function(t){t.preventDefault();const o=e.getBoundingClientRect(),r=t.clientX-o.left,i=t.clientY-o.top;function a(c){e.style.left=c.clientX-r+"px",e.style.top=c.clientY-i+"px"}function s(){document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",s),G[e.id]&&(G[e.id].position={left:e.style.left,top:e.style.top},_())}document.addEventListener("mousemove",a),document.addEventListener("mouseup",s),Ie(e)})}function ho(e){const n=document.createElement("div");n.className="absolute bottom-0 right-0 w-4 h-4 cursor-se-resize",n.style.background="rgba(0,0,0,0.2)",e.appendChild(n),n.addEventListener("mousedown",function(t){t.preventDefault(),t.stopPropagation();const o=t.clientX,r=t.clientY,i=parseInt(document.defaultView.getComputedStyle(e).width,10),a=parseInt(document.defaultView.getComputedStyle(e).height,10);function s(l){const f=Math.max(i+l.clientX-o,350),m=Math.max(a+l.clientY-r,200);e.style.width=f+"px",e.style.height=m+"px"}function c(){document.documentElement.removeEventListener("mousemove",s,!1),document.documentElement.removeEventListener("mouseup",c,!1),G[e.id].dimensions={type:"integer",width:parseInt(e.style.width),height:parseInt(e.style.height)},_()}document.documentElement.addEventListener("mousemove",s,!1),document.documentElement.addEventListener("mouseup",c,!1)})}function on(e){const n=document.getElementById(e);if(!n)return;let t=G[e];t.fullScreen?(t.originalDimensions&&t.originalPosition?(n.style.left=t.originalPosition.left,n.style.top=t.originalPosition.top,n.style.width=t.originalDimensions.width+"px",n.style.height=t.originalDimensions.height+"px",t.dimensions=t.originalDimensions):(n.style.left="15%",n.style.top="15%",n.style.width="70vw",n.style.height="70vh",t.dimensions={type:"integer",width:window.innerWidth*.7,height:window.innerHeight*.7}),t.fullScreen=!1,bo(n),ho(n)):(t.originalDimensions=t.dimensions,t.originalPosition=t.position,n.style.left="0px",n.style.top="0px",n.style.width=window.innerWidth+"px",n.style.height=window.innerHeight-40+"px",t.dimensions={type:"default"},t.fullScreen=!0),_()}function K(e,n,t=null,o=null){const r="dialogWindow-"+Date.now(),i=n==="confirmation"&&(t||o);let a;i?a=`
      <div class="text-center p-4">
        <h2 class="text-lg mb-4">${e}</h2>
        <div class="flex gap-2 justify-center">
          <button id="${r}-ok-button" class="bg-gray-200 border-2 border-gray-400 px-4 py-2 hover:bg-gray-300" style="border-style: outset;">
            OK
          </button>
          <button id="${r}-cancel-button" class="bg-gray-200 border-2 border-gray-400 px-4 py-2 hover:bg-gray-300" style="border-style: outset;">
            Cancel
          </button>
        </div>
      </div>
    `:a=`
      <div class="text-center p-4">
        <h2 class="text-lg mb-4">${e}</h2>
        <button id="${r}-button" class="bg-gray-200 border-2 border-gray-400 px-4 py-2 hover:bg-gray-300" style="border-style: outset;">
          OK
        </button>
      </div>
    `;let s="⚠️ Information";if(n==="confirmation"&&(s=i?"⚠️ Confirmation":"✅ Success",In(e,"polite")),n==="error"){s="⚠️ Error";const l=document.getElementById("error-popup-audio");l&&l.play(),In(e,"assertive")}const c=Z(s,a,!1,r,!1,!1,{type:"integer",width:350,height:180},"default");return Ie(c),setTimeout(()=>{Ie(c)},10),setTimeout(()=>{if(i){const l=document.getElementById(`${r}-ok-button`),f=document.getElementById(`${r}-cancel-button`);l&&l.addEventListener("click",()=>{ie(r),t&&t()}),f&&f.addEventListener("click",()=>{ie(r),o&&o()})}else{const l=document.getElementById(`${r}-button`);l&&l.addEventListener("click",()=>{ie(r),t&&t()})}},100),c}function In(e,n="polite"){const t=document.getElementById(n==="assertive"?"sr-alerts":"sr-announcements");t.textContent=e,setTimeout(()=>{t.textContent=""},1e3)}document.addEventListener("click",e=>{e.target.closest("#settings-apply-button")&&(e.stopPropagation(),K("Are you sure you want to apply these desktop settings changes?","confirmation",()=>{Fe("settings-apply-button","Applied!"),setTimeout(()=>{Fe("settings-apply-button","Apply")},1e3),qr(),K("Your settings have successfully been saved!","info")}))});function Zr(e,n,t){const o=document.getElementById("context-menu");o.replaceChildren(),o.style.zIndex=(ve||1e3)+100;const r=(m,u,p)=>{const d=document.createElement("div");return d.className="px-4 py-2 hover:bg-gray-50 cursor-pointer",d.textContent=m,p&&d.addEventListener("click",p),o.appendChild(d),d},i=t.style.display==="none",a=G[n]&&G[n].fullScreen;i?r("Restore",!1,()=>{Ie(t),hideContextMenu()}):r("Minimize",!1,()=>{He(n),hideContextMenu()}),a||r("Maximize",!1,()=>{on(n),hideContextMenu()}),r("Close",!1,()=>{ie(n),hideContextMenu()}),o.classList.remove("hidden");const s=o.getBoundingClientRect(),c=48;let l=e.pageX;l+s.width>window.innerWidth&&(l=window.innerWidth-s.width-10);let f=window.innerHeight-c-s.height-5;o.style.left=l+"px",o.style.top=f+"px",setTimeout(()=>{document.addEventListener("click",hideContextMenu,{once:!0})},0)}function It(){const e=document.createElement("div");e.className="w-3xl fixed left-0 top-0 h-full w-full bg-gradient-to-b from-40% from-blue-500 to-cyan-500",e.id="splash-screen",e.style.zIndex="9000",e.innerHTML=`
  <div class="flex flex-col items-center justify-center h-full">
    <img id="splash-image" src="./image/startup.webp" alt="Startup" class="mb-4 max-w-48">
    <h1 class="sr-only">Doorways '25, a Nostalgia Inducing Operating System</h1>
    <div class="mx-auto w-72 text-sm pl-3 mb-2 bg-black py-1 border-2 border-lime-400 text-lime-300"><em>i hacked the mainframe credentials for u</em><br><span class="text-xs text-lime-500">sincerely, _N30_phreak_</span></div>
    <form id="splash-form" class="bg-gray-300 border border-gray-500 p-4 w-96">
      <div class="mb-2">
        <label class="block text-sm">Username</label>
        <input type="text" id="splash-username" value="admin" class="border px-1 py-1 w-full" readonly>
      </div>
      <div class="mb-2">
        <label class="block text-sm">Password</label>
        <input type="password" id="splash-password" value="••••••" class="border px-1 py-1 w-full" readonly>
      </div>
      <button id="splash-login" class="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2"><span class="border-b-2 border-r-2 border-black block h-full max-h-10 w-full py-1.5 px-3">Login</span></button>
    </form>
  </div>
`,document.body.appendChild(e);const n=document.getElementById("splash-audio");document.getElementById("splash-login").addEventListener("click",function(t){n.play(),t.preventDefault(),document.getElementById("splash-image").src="./image/loading.gif",n.currentTime=0,setTimeout(function(){e.remove()},3e3)})}function Vr(){const e=document.createElement("div");e.className="w-3xl fixed left-0 top-0 h-full w-full bg-gradient-to-b from-blue-500 to-cyan-500",e.id="splash-screen",e.style.zIndex="9999",e.innerHTML=`
  <div class="flex flex-col items-center justify-center h-full">
    <img id="splash-image" src="./image/startup.webp" alt="Startup" class="mb-4 max-w-48">
    <h2 class="text-4xl text-gray-900 font-bold mb-2">System Loading ...</h2>
  </div>
`,document.body.appendChild(e),setTimeout(function(){e.remove()},3e3)}typeof window<"u"&&(window.showSplash=It,window.showOSLoading=Vr);async function yt(){await M.setItem("explicitRestart",!0),ui(),pi(),ci([]),di({clockSeconds:!1,bgColor:"#20b1b1",bgImage:""}),It()}async function wo(){await M.setItem("explicitRestart",!0);try{await _()}catch(e){console.warn("Failed to save state before logout:",e)}It()}typeof window<"u"&&(window.restart=yt,window.logout=wo);function vo(){Z("Storage Manager",'<div id="storage-content" style="padding: 20px;">Loading storage information...</div>',!1,"storage-window",!1,!1,{type:"integer",width:600,height:500},"default"),setTimeout(bt,100)}async function bt(){const e=document.getElementById("storage-content");if(e)try{const n=await navigator.storage.estimate(),t=(n.quota/(1024*1024)).toFixed(2),o=(n.usage/(1024*1024)).toFixed(2),r=((n.quota-n.usage)/(1024*1024)).toFixed(2),i=(n.usage/n.quota*100).toFixed(1),a=await Jr(),s=`
      <div class="storage-manager">
        <h2 class="text-xl font-bold mb-4">Storage Information</h2>

        <!-- Storage Capacity -->
        <div class="mb-6 p-4 bg-gray-100 rounded">
          <h3 class="text-lg font-semibold mb-2">Storage Capacity</h3>
          <div class="mb-2">
            <div class="flex justify-between mb-1">
              <span>Used: ${o} MB</span>
              <span>Available: ${r} MB</span>
            </div>
            <div class="w-full bg-gray-300 rounded-full h-4">
              <div class="bg-blue-500 h-4 rounded-full" style="width: ${i}%"></div>
            </div>
            <div class="text-sm text-gray-600 mt-1">
              ${i}% of ${t} MB total capacity used
            </div>
          </div>
        </div>

        <!-- Data Categories -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-3">Data Categories</h3>
          <div class="grid grid-cols-2 gap-4">
            ${at("App Data",a.appData,"bg-blue-100")}
            ${at("Media Files",a.mediaData,"bg-green-100")}
            ${at("Files & Folders",a.fileData,"bg-yellow-100")}
            ${at("Miscellaneous",a.miscData,"bg-gray-100")}
          </div>
        </div>

        <!-- Detailed Breakdown -->
        <div class="mb-4">
          <h3 class="text-lg font-semibold mb-3">Detailed Breakdown</h3>
          <div class="bg-white border rounded p-3">
            ${Xr(a)}
          </div>
        </div>

        <!-- Actions -->
        <div class="mt-6 flex gap-3">
          <div id="refresh-btn-container"></div>
          <div id="cleanup-btn-container"></div>
          <div id="restore-btn-container"></div>
        </div>
      </div>
    `;e.innerHTML=s;const c=await ko(),l=Q("Refresh Data");l.onclick=et,document.getElementById("refresh-btn-container").appendChild(l);const f=Q("Cleanup Options");f.onclick=xo,document.getElementById("cleanup-btn-container").appendChild(f);const m=Q("Restore All Applications");m.onclick=ai,c.count===0?(m.disabled=!0,m.title="All applications are already in the Start menu",m.style.opacity="0.6",m.style.cursor="not-allowed"):m.title=`Restore ${c.count} missing applications to Start menu`,document.getElementById("restore-btn-container").appendChild(m)}catch(n){const t=document.createElement("div");t.className="text-red-500",t.textContent=`Error loading storage data: ${n.message}`,e.innerHTML="",e.appendChild(t)}}function at(e,n,t){const o=(n.totalSize/1024).toFixed(1);return`
    <div class="p-4 ${t} rounded">
      <h4 class="font-semibold">${e}</h4>
      <div class="text-2xl font-bold">${n.count}</div>
      <div class="text-sm text-gray-600">items (${o} KB)</div>
    </div>
  `}function Xr(e){let n='<div class="space-y-2 text-sm">';return e.appData.breakdown.length>0&&(n+="<div><strong>App Data:</strong></div>",e.appData.breakdown.forEach(t=>{n+=`<div class="ml-4">• ${t.name}: ${t.count} items</div>`})),e.mediaData.breakdown.length>0&&(n+='<div class="mt-3"><strong>Media Files:</strong></div>',e.mediaData.breakdown.forEach(t=>{const o=(t.size/1024).toFixed(1);n+=`<div class="ml-4">• ${t.type}: ${t.count} files (${o} KB)</div>`})),e.fileData.breakdown.length>0&&(n+='<div class="mt-3"><strong>Files & Folders:</strong></div>',e.fileData.breakdown.forEach(t=>{n+=`<div class="ml-4">• ${t.name}: ${t.count} items</div>`})),n+="</div>",n}async function Jr(){const e={appData:{count:0,totalSize:0,breakdown:[]},mediaData:{count:0,totalSize:0,breakdown:[]},fileData:{count:0,totalSize:0,breakdown:[]},miscData:{count:0,totalSize:0,breakdown:[]}};return await Qr(e),await ei(e),e}async function Qr(e){try{const t=await M.getItem("appState")||{},o=JSON.stringify(t).length;if(t.fileSystemState){const r=JSON.stringify(t.fileSystemState).length;e.fileData.totalSize+=r;const i=t.fileSystemState;i.folders&&Object.values(i.folders).forEach(a=>{qt(a,e.fileData)})}if(t.windowStates){const r=JSON.stringify(t.windowStates).length;e.appData.totalSize+=r,e.appData.count+=Object.keys(t.windowStates).length,e.appData.breakdown.push({name:"Window States",count:Object.keys(t.windowStates).length})}if(t.desktopIconsState){const r=JSON.stringify(t.desktopIconsState).length;e.appData.totalSize+=r,e.appData.count+=Object.keys(t.desktopIconsState).length,e.appData.breakdown.push({name:"Desktop Icons",count:Object.keys(t.desktopIconsState).length})}if(t.desktopSettings){const r=JSON.stringify(t.desktopSettings).length;e.appData.totalSize+=r,e.appData.count+=1,e.appData.breakdown.push({name:"Desktop Settings",count:1})}}catch(n){console.error("Error analyzing storage:",n)}}function qt(e,n){!e||typeof e!="object"||(e.type==="folder"?(n.count++,e.contents&&Object.values(e.contents).forEach(t=>{qt(t,n)})):e.type==="ugc-file"?(n.count++,["mp3","mp4","jpg","jpeg","png","gif","webp","wav","webm"].includes(e.content_type)):Object.values(e).forEach(t=>{t&&typeof t=="object"&&qt(t,n)}))}async function ei(e){try{const n=await indexedDB.databases();for(const t of n)t.name==="media_player_db"?await ti(e):(e.miscData.count+=1,e.miscData.breakdown.push({name:`Database: ${t.name}`,count:1}))}catch(n){console.error("Error analyzing IndexedDB:",n)}}async function ti(e){return new Promise((n,t)=>{const o=indexedDB.open("media_player_db");o.onsuccess=r=>{const i=r.target.result,c=i.transaction(["songs"],"readonly").objectStore("songs").getAll();c.onsuccess=()=>{const l=c.result,f={};l.forEach(m=>{const u=m.type||"unknown";f[u]||(f[u]={count:0,size:0}),f[u].count++,m.file&&m.file.size&&(f[u].size+=m.file.size,e.mediaData.totalSize+=m.file.size),e.mediaData.count++}),Object.entries(f).forEach(([m,u])=>{e.mediaData.breakdown.push({type:m.toUpperCase(),count:u.count,size:u.size})}),i.close(),n()},c.onerror=()=>{i.close(),t(c.error)}},o.onerror=()=>{t(o.error)}})}function et(){const e=document.getElementById("storage-content");e&&(e.innerHTML="Refreshing storage information...",setTimeout(bt,100))}function ni(e,n=null,t=null){const o=document.createElement("select");return o.className="bg-white border-t-2 border-l-2 border-black border-b-2 border-r-2 border-gray-300 px-2 py-1",o.setAttribute("aria-label","Select storage cleanup option"),o.setAttribute("title","Choose which type of data to clean up"),e.forEach(r=>{const i=document.createElement("option");typeof r=="string"?(i.value=r,i.textContent=r):(i.value=r.value,i.textContent=r.text||r.value),n!==null&&i.value===n&&(i.selected=!0),o.appendChild(i)}),t&&typeof t=="function"&&o.addEventListener("change",r=>t(r.target.value,r)),o}function xo(){const e=Z("Storage Cleanup",'<div id="cleanup-content" style="padding: 20px;">Loading cleanup options...</div>',!1,"storage-cleanup-window",!1,!1,{type:"integer",width:400,height:340},"default");setTimeout(()=>{const t=[...document.querySelectorAll("*")].filter(o=>getComputedStyle(o).zIndex>100&&getComputedStyle(o).zIndex<1e3).reduce((o,r)=>getComputedStyle(r).zIndex>getComputedStyle(o).zIndex?r:o);e.style.zIndex=`${parseInt(t.style.zIndex)+1}`},50),setTimeout(oi,100)}function oi(){const e=document.getElementById("cleanup-content");if(!e)return;const n=`
    <div class="cleanup-options">
      <h3 class="text-lg font-semibold mb-4">Storage Cleanup Options</h3>
      <p class="text-sm text-gray-600 mb-4">Choose what data to clear:</p>

      <div class="space-y-3">
        <div id="clear-media-btn-container"></div>
        <div id="clear-desktop-btn-container"></div>
        <div id="full-restart-btn-container"></div>
      </div>
    </div>
  `;e.innerHTML=n;const t=Q("Clear Media Player Data");t.onclick=ri,t.className+=" w-full mb-2",document.getElementById("clear-media-btn-container").appendChild(t);const o=Q("Reset Desktop Settings");o.onclick=ii,o.className+=" w-full mb-2",document.getElementById("clear-desktop-btn-container").appendChild(o);const r=Q("Factory Reset");r.onclick=So,r.className+=" w-full mb-2",r.style.backgroundColor="#ffcccc",document.getElementById("full-restart-btn-container").appendChild(r)}async function ri(){try{await new Promise((n,t)=>{const o=indexedDB.deleteDatabase("media_player_db");o.onsuccess=n,o.onerror=t});const e=getFileSystemStateSync();e.folders["C://Media"]&&(e.folders["C://Media"]={},setFileSystemState(e),saveState()),K("Media player data cleared successfully!","info"),et()}catch(e){K("Error clearing media player data: "+e.message,"error")}}async function ii(){const n=await M.getItem("appState")||{};n.desktopSettings={clockSeconds:!1,bgColor:"#20b1b1",bgImage:""},n.desktopIconsState={},n.startMenuOrder=[],await M.setItem("appState",n),K("Desktop settings reset successfully!","info"),et()}async function ko(){try{const e=[{id:"mycomp",text:"My Computer",icon:"image/computer.webp"},{id:"mediaapp",text:"Media Player",icon:"image/video.webp"},{id:"watercolourapp",text:"Watercolour",icon:"image/watercolour.webp"},{id:"letterpad",text:"LetterPad",icon:"image/file.webp"},{id:"calcapp",text:"Calculator",icon:"image/calculator.webp"},{id:"keyboard",text:"Keyboard",icon:"image/keyboard.webp"},{id:"sysset",text:"System Settings",icon:"image/gears.webp"},{id:"storageapp",text:"Storage Manager",icon:"image/drive_c.webp"},{id:"abtcomp",text:"About This Computer",icon:"image/info.webp"},{id:"solapp",text:"Solitaire",icon:"image/solitaire.webp"},{id:"chessapp",text:"Guillotine Chess",icon:"image/guillotine_chess.webp"},{id:"bombapp",text:"Bombbroomer",icon:"image/bombbroomer.webp"},{id:"pongapp",text:"Pong",icon:"image/pong.webp"},{id:"snakeapp",text:"Snake",icon:"image/snake.webp"}];let n=[];try{const r=await M.getItem("startMenuOrder");r&&Array.isArray(r)?n=r:n=typeof startMenuOrder<"u"?startMenuOrder:window.startMenuOrder||[]}catch{n=typeof startMenuOrder<"u"?startMenuOrder:window.startMenuOrder||[]}const t=new Set;n.forEach(r=>{typeof r=="string"?t.add(r):r&&r.type==="group"&&r.items&&r.items.forEach(i=>{i&&i.id&&t.add(i.id)})});const o=e.filter(r=>!t.has(r.id));return{count:o.length,apps:o}}catch(e){return console.error("Error checking for missing apps:",e),{count:0,apps:[]}}}async function ai(){try{const e=await ko();if(e.count===0){typeof K=="function"?K("All applications are already present in the Start menu.","info"):alert("All applications are already present in the Start menu.");return}const n=`This will restore ${e.count} missing applications to the Start menu:

${e.apps.map(t=>`• ${t.text}`).join(`
`)}

Proceed?`;typeof K=="function"?K(n,"confirmation",async()=>{await Ln(e.apps)}):confirm(n)&&await Ln(e.apps)}catch(e){console.error("❌ Error in restoreAllApplications:",e),typeof K=="function"?K("Failed to restore applications: "+e.message,"error"):alert("Failed to restore applications: "+e.message)}}async function Ln(e){try{let n=[];try{const o=await M.getItem("startMenuOrder");o&&Array.isArray(o)?n=[...o]:n=typeof startMenuOrder<"u"?[...startMenuOrder]:[...window.startMenuOrder||[]]}catch{n=typeof startMenuOrder<"u"?[...startMenuOrder]:[...window.startMenuOrder||[]]}const t={letterpad:"utilities-group",calcapp:"utilities-group",sysset:"utilities-group",storageapp:"utilities-group",abtcomp:"utilities-group",solapp:"games-group",chessapp:"games-group",bombapp:"games-group",pongapp:"games-group",snakeapp:"games-group"};e.forEach(o=>{const r=t[o.id];if(r){let i=!1;if(n=n.map(a=>typeof a=="object"&&a.type==="group"&&a.id===r?(i=!0,{...a,items:[...a.items||[],{id:o.id,text:o.text,icon:o.icon}]}):a),!i){const a=si(r);if(a){a.items=[{id:o.id,text:o.text,icon:o.icon}];const s=n.findIndex(c=>c==="rstrtcomp");s!==-1?n.splice(s,0,a):n.push(a)}}}else{const i=n.findIndex(a=>a==="rstrtcomp");i!==-1?n.splice(i,0,o.id):n.push(o.id)}}),window.startMenuOrder=n,typeof startMenuOrder<"u"&&(startMenuOrder=n),await M.setItem("startMenuOrder",n),typeof saveState=="function"&&await saveState(),typeof generateStartMenuHTML=="function"?generateStartMenuHTML():typeof window.generateStartMenuHTML=="function"&&window.generateStartMenuHTML(),typeof safeInitializeStartMenuDragDrop=="function"?setTimeout(()=>{safeInitializeStartMenuDragDrop()},50):typeof window.safeInitializeStartMenuDragDrop=="function"&&setTimeout(()=>{window.safeInitializeStartMenuDragDrop()},50),typeof K=="function"?K(`Successfully restored ${e.length} applications to the Start menu.`,"info"):alert(`Successfully restored ${e.length} applications to the Start menu.`),setTimeout(()=>{et()},500)}catch(n){console.error("❌ Error performing app restore:",n),typeof K=="function"?K("Failed to restore applications: "+n.message,"error"):alert("Failed to restore applications: "+n.message)}}function si(e){return{"utilities-group":{id:"utilities-group",text:"Utilities",type:"group",items:[]},"games-group":{id:"games-group",text:"Games",type:"group",items:[]}}[e]||null}function So(){K("This will completely wipe the entire hard drive and reset the system to factory defaults. All your files, settings, and data will be permanently deleted.","confirmation",()=>{confirm(`⚠️ FINAL WARNING ⚠️

This will permanently delete EVERYTHING you have ever saved in this application:

• All uploaded files and media
• All documents and folders
• All settings and customizations
• All application data

This action cannot be undone!

Are you absolutely sure you want to proceed?`)&&li()},()=>{})}function li(){M.clearSync();const e=indexedDB.deleteDatabase("media_player_db");e.onsuccess=()=>{},e.onerror=n=>{console.error("Factory reset: Error clearing media player database:",n)},windowStates={},desktopIconsState={},startMenuOrder=[],desktopSettings={clockSeconds:!1,bgColor:"#20b1b1",bgImage:""},window.location.reload()}let Me={folders:{"C://":{Documents:{id:"Documents",name:"Documents",type:"folder",fullPath:"C://Documents",contents:{}},Desktop:{id:"Desktop",name:"Desktop",type:"folder",fullPath:"C://Desktop",contents:{compostbin:{id:"compostbin",name:"Compost Bin",type:"app",fullPath:"C://Desktop/compostbin",content_type:"html",contents:{},icon:"./image/compost-bin.webp"}}},Media:{id:"Media",name:"Media",type:"folder",fullPath:"C://Media",contents:{}}},"A://":{"folder-34862398":{id:"folder-34862398",name:"example folder",type:"folder",fullPath:"A://folder-34862398",contents:{"folder-9523759823":{id:"folder-9523759823",name:"nested in example",type:"folder",fullPath:"A://folder-34862398/folder-9523759823",contents:{"folder-53829539":{id:"folder-53829539",name:"supernested",type:"folder",fullPath:"A://folder-34862398/folder-9523759823/folder-53829539",contents:{"file-593485739":{id:"file-593485739",name:"some md example",type:"ugc-file",content_type:"md",fullPath:"A://folder-34862398/folder-9523759823/folder-53829539/file-593485739",contents:"lol sup"}}}}}}}},"D://":{}}},G={},ne={},xe={},le={clockSeconds:!1,bgColor:"#20b1b1",bgImage:""},Y,Eo={},ve=100,Ue=null;function ci(e){Y=e,typeof window<"u"&&(window.startMenuOrder=e)}function _t(e){ve=e,typeof window<"u"&&(window.highestZ=e)}function Co(e){Ue=e,typeof window<"u"&&(window.activeMediaWindow=e)}function di(e){Object.assign(le,e),typeof window<"u"&&(window.desktopSettings=le)}function ui(){Object.keys(G).forEach(e=>delete G[e]),typeof window<"u"&&(window.windowStates=G)}function pi(){Object.keys(ne).forEach(e=>delete ne[e]),typeof window<"u"&&(window.desktopIconsState=ne)}typeof window<"u"&&(window.fileSystemState=Me,window.windowStates=G,window.desktopIconsState=ne,window.navWindows=xe,window.desktopSettings=le,window.fileFolderMapping=Eo,window.highestZ=ve,window.activeMediaWindow=Ue);let ht=!1;typeof window<"u"&&(window.isInitializing=ht);async function _(){if(ht)return;const e=typeof Y<"u"?Y:window.startMenuOrder||[],n={fileSystemState:Me,windowStates:G,desktopIconsState:ne,desktopSettings:le,navWindows:xe,startMenuOrder:e};try{await M.setItem("appState",n);const t=Date.now(),o=await M.getItem("appState")}catch(t){console.warn("Failed to save state to IndexedDB:",t),M.setItemSync("appState",n)}}typeof window<"u"&&(window.saveState=_);function Ce(){return Me}function ue(e){Me=e,typeof window<"u"&&(window.fileSystemState=e)}function Pe(e,n){G[e]&&(G[e].content=n,_())}async function Io(e,n,t,o,r=null){const i=await Ce();if(!i||!i.folders){console.error("File system not initialized, creating basic structure");const d={folders:{"C://":{Documents:{id:"Documents",name:"Documents",type:"folder",fullPath:"C://Documents",contents:{}},Desktop:{id:"Desktop",name:"Desktop",type:"folder",fullPath:"C://Desktop",contents:{}},Media:{id:"Media",name:"Media",type:"folder",fullPath:"C://Media",contents:{}}},"A://":{},"D://":{}}};ue(d),i=d}const a=t.match(/^([A-Z]:\/\/)/);if(!a)return console.error("Invalid path format:",t),null;const s=a[1],c=t.replace(/^[A-Z]:\/\//,"").split("/").filter(d=>d);i.folders[s]||(console.error("Drive does not exist:",s),i.folders[s]={});let l=i.folders[s];if(c.length===0)l=i.folders[s];else if(l=i.folders[t],!l)return console.error("Target folder not found in unified structure:",t),console.error("Available folders:",Object.keys(i.folders)),null;const f=c.length===0;let m="image/file.webp";["png","jpg","jpeg","gif"].includes(o)?m="image/image.webp":["mp4","webm"].includes(o)?m="image/video.webp":["mp3","wav","audio"].includes(o)?m="image/audio.webp":o==="html"?m="image/html.webp":["md","txt"].includes(o)&&(m="image/doc.webp");const u=`file-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,p={id:u,name:e,type:"ugc-file",fullPath:f?`${t}${e}`:`${t}/${e}`,content_type:o,icon:m,contents:n||"",file:r||null};if(r&&["png","jpg","jpeg","gif","webp","avif","mp3","wav","ogg","mp4","webm","avi","mov"].includes(o)){p.isLargeFile=!0,p.storageLocation="indexeddb";const d=URL.createObjectURL(r);p.tempObjectURL=d;const g=new FileReader;g.onload=async function(v){const x=v.target.result,F=x.length*.75/(1024*1024);try{await M.setItem(`file_data_${u}`,x);const W=await Ce();let P;f?P=W.folders[s][u]:P=W.folders[t][u],P?(P.isLargeFile=!0,P.storageLocation="indexeddb",P.dataURL=x):(console.error("🎵 ADDFILE: File entry not found after creation:",u),console.error("🎵 ADDFILE: Looking in:",f?s:t),console.error("🎵 ADDFILE: Available keys:",Object.keys(f?W.folders[s]||{}:W.folders[t]||{})))}catch(W){console.error("Failed to store file in IndexedDB:",W);const P=await Ce();let j;f?j=P.folders[s][u]:j=P.folders[t][u],j&&(j.isLargeFile=!0,j.storageLocation="failed"),showDialogBox(`File "${e}" could not be stored (${F.toFixed(2)}MB). Storage error: ${W.message}`,"error")}const I=await Ce();let R;f?R=I.folders[s][u]:R=I.folders[t][u],R?R.file=null:console.error("🎵 ADDFILE: Could not find file entry to remove File object:",u),ue(I);try{await _()}catch(W){console.error("Failed to save state after file storage:",W)}t==="C://Desktop"&&typeof renderDesktopIcons=="function"?renderDesktopIcons():typeof refreshAllExplorerWindows=="function"&&refreshAllExplorerWindows(t)},g.readAsDataURL(r)}if(l[u]=p,ue(i),!r||!["png","jpg","jpeg","gif","webp","avif","mp3","wav","ogg","mp4","webm","avi","mov"].includes(o))try{await _()}catch(d){console.error("Failed to save state after non-binary file:",d)}return t==="C://Desktop"?typeof renderDesktopIcons=="function"?renderDesktopIcons():typeof window.renderDesktopIcons=="function"?window.renderDesktopIcons():console.warn("renderDesktopIcons function not found"):typeof refreshAllExplorerWindows=="function"?refreshAllExplorerWindows(t):typeof window.refreshAllExplorerWindows=="function"?window.refreshAllExplorerWindows(t):console.warn("refreshAllExplorerWindows function not found"),t==="C://Media"&&["mp3","wav","ogg","audio","mp4","webm","avi","mov"].includes(o)&&typeof window.refreshMediaPlayerPlaylist=="function"&&setTimeout(()=>{window.refreshMediaPlayerPlaylist()},100),p}window.globalAddFileToFileSystem=Io;function Nt(e){if(e.folders||(e.folders={}),e.folders["C://"]&&typeof e.folders["C://"]=="object"){const o=e.folders["C://"];for(const[r,i]of Object.entries(o))if(i&&typeof i=="object"&&i.type==="folder"){const a=`C://${i.name||r}`;e.folders[a]||(e.folders[a]=i.contents||{},i.contents&&Object.values(i.contents).forEach(s=>{s.type==="folder"&&s.fullPath&&t(s.fullPath,s,e)}))}}const n=["C://Desktop","C://Documents","C://Media"];for(const o of n)e.folders[o]||(e.folders[o]={});function t(o,r,i){r.contents&&Object.keys(r.contents).length>0&&(i.folders[o]||(i.folders[o]={}),Object.assign(i.folders[o],r.contents),Object.values(r.contents).forEach(a=>{a.type==="folder"&&a.fullPath&&t(a.fullPath,a,i)}))}return e}async function jt(){ht=!0,typeof window<"u"&&(window.isInitializing=!0);try{await M.ensureReady()}catch(n){console.error("Failed to initialize storage:",n)}let e;try{e=await M.getItem("appState")}catch(n){console.error("Failed to load app state from storage:",n),e=null}if(e){const n=e;if(n.fileSystemState&&typeof n.fileSystemState=="object"){const o=Nt(n.fileSystemState);ue(o)}else{console.warn("Invalid fileSystemState in saved data, using default");const o=Nt(Me);ue(o)}G=n.windowStates&&typeof n.windowStates=="object"?n.windowStates:{},ne=n.desktopIconsState&&typeof n.desktopIconsState=="object"?n.desktopIconsState:{},xe=n.navWindows&&typeof n.navWindows=="object"?n.navWindows:{};let t=[];try{const o=await M.getItem("startMenuOrder");o&&Array.isArray(o)?t=o:n.startMenuOrder&&Array.isArray(n.startMenuOrder)&&(t=n.startMenuOrder)}catch(o){console.warn("⚠ Error loading from direct storage, using appState:",o),t=n.startMenuOrder&&Array.isArray(n.startMenuOrder)?n.startMenuOrder:[]}Y=t,typeof window<"u"&&(window.startMenuOrder=Y),le={clockSeconds:!1,bgColor:"#20b1b1",bgImage:"",...n.desktopSettings||{}},typeof window<"u"&&typeof window.applyDesktopSettings=="function"&&window.applyDesktopSettings(),setTimeout(async()=>{const o=await Ce();if(o&&o.folders&&o.folders["C://Media"]){const a=o.folders["C://Media"];if(a&&!Object.values(a).some(c=>c.name==="too_many_screws_final.mp3")){const c={id:"default-music-file",name:"too_many_screws_final.mp3",type:"ugc-file",fullPath:"C://Media/too_many_screws_final.mp3",content_type:"mp3",icon:"image/audio.webp",contents:"",file:null,isDefault:!0,path:"media/too_many_screws_final.mp3",isSystemFile:!0};o.folders["C://Media"]["default-music-file"]=c,ue(o),await _()}}const r=o.folders["C://Documents"]||{};Object.keys(r).length===0&&(typeof fetchDocuments=="function"?await fetchDocuments():typeof fetchDocumentsSync=="function"&&fetchDocumentsSync())},100)}else{Y=[],typeof window<"u"&&(window.startMenuOrder=Y);const t={fileSystemState:Nt(Me),windowStates:G,desktopIconsState:ne,desktopSettings:le,navWindows:xe};try{await M.setItem("appState",t)}catch(o){console.error("Failed to save initial app state:",o)}setTimeout(async()=>{const o=await Ce();if(o.folders["C://Media"]&&!Object.values(o.folders["C://Media"]).some(i=>i.name==="too_many_screws_final.mp3")){const i={id:"default-music-file",name:"too_many_screws_final.mp3",type:"ugc-file",fullPath:"C://Media/too_many_screws_final.mp3",content_type:"mp3",icon:"image/audio.webp",contents:"",file:null,isDefault:!0,path:"media/too_many_screws_final.mp3",isSystemFile:!0};o.folders["C://Media"]["default-music-file"]=i,ue(o),await _()}},100),setTimeout(async()=>{typeof fetchDocuments=="function"?await fetchDocuments():(console.warn("fetchDocuments function not available, trying sync version"),typeof fetchDocumentsSync=="function"&&fetchDocumentsSync())},200)}ht=!1,typeof window<"u"&&(window.isInitializing=!1)}async function fi(){const e=await M.getItem("fileSystemState");e&&(Me=e)}async function mi(){if(G&&Object.keys(G).length>0){const e=Object.entries(G).sort(([,n],[,t])=>(n.zIndex||0)-(t.zIndex||0));for(const[n,t]of e)createWindow(t.title,t.content,t.isNav,t.id,t.isMinimized,!0,t.dimensions,t.windowType,null,t.color||"white",t.zIndex),await Lo(t.id);if(typeof window.initializeAllLetterPadEditors=="function")try{await window.initializeAllLetterPadEditors()}catch(n){console.warn("Error during global LetterPad initialization:",n)}}}async function Lo(e){await new Promise(t=>setTimeout(t,50));const n={"storage-window":()=>{typeof bt=="function"?setTimeout(bt,100):console.warn("loadStorageData function not available for storage window restoration")},calculator:()=>{const t=document.getElementById("calculator");if(t){const o=t.querySelector(".p-2");We(o)&&initializeCalculatorUI(t)}},mediaplayer:()=>{const t=document.getElementById("mediaplayer");if(t){const o=t.querySelector(".p-2");We(o)&&initializeMediaPlayerUI(t)}},bombbroomer:()=>{const t=document.getElementById("bombbroomer");if(t){const o=t.querySelector(".p-2");We(o)&&(typeof initializeBombbroomerUI=="function"?initializeBombbroomerUI(t):console.warn("initializeBombbroomerUI function not available"))}},solitaire:()=>{const t=document.getElementById("solitaire");if(t){const o=t.querySelector(".p-2");We(o)&&initializeSolitaireUI(t)}},chess:()=>{const t=document.getElementById("chess");if(t){const o=t.querySelector(".p-2");We(o)&&(typeof initializeChessUI=="function"?initializeChessUI(t):console.warn("initializeChessUI function not available"))}},"compost-bin":()=>{const t=document.getElementById("compost-bin");if(t){const o=t.querySelector(".p-2");if(o&&We(o)){o.innerHTML="",o.className="p-2 bg-gray-100 h-full flex flex-col";const r=document.createElement("div");r.className="h-full flex flex-col";const i=document.createElement("div");i.className="bg-gray-200 border-b border-gray-400 p-2 flex justify-between items-center";const a=document.createElement("div");a.className="text-sm";const l=(getFileSystemStateSync().folders["C://Desktop"]||{}).compostbin,f=Object.keys((l==null?void 0:l.contents)||{}).length;a.textContent=`Compost Bin - ${f} item(s)`;const m=document.createElement("div");m.className="flex space-x-2";const u=document.createElement("button");u.className="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs",u.textContent="Empty Bin",typeof emptyCompostBin=="function"&&u.addEventListener("click",emptyCompostBin),m.appendChild(u),i.appendChild(a),i.appendChild(m);const p=document.createElement("div");p.className="flex-1 bg-white border border-gray-400 p-2 overflow-auto",p.id="compost-bin-content",typeof loadCompostBinContents=="function"?loadCompostBinContents(p):console.warn("🗑️ loadCompostBinContents function not available"),r.appendChild(i),r.appendChild(p),o.appendChild(r)}else{const r=t.querySelector("#compost-bin-content");r&&typeof loadCompostBinContents=="function"?(loadCompostBinContents(r),typeof updateCompostBinHeader=="function"&&updateCompostBinHeader(t)):console.warn("Compost bin content area not found or loadCompostBinContents not available")}}else console.warn("🗑️ Compost bin window not found during restoration")},watercolour:()=>{const t=document.getElementById("watercolour");if(t){const o=t.querySelector(".p-2");We(o)?initializeWatercolourUI(t):typeof initializeWatercolour=="function"?initializeWatercolour():initializeWatercolourUI(t)}},tubestream:()=>{typeof initializeTubeStream=="function"&&setTimeout(initializeTubeStream,100)},"explorer-window":()=>{const t=document.getElementById("explorer-window");t&&(typeof initializeFileExplorerUI=="function"?initializeFileExplorerUI(t):typeof restoreFileExplorerState=="function"&&setTimeout(restoreFileExplorerState,100))}};if(n[e])try{n[e]()}catch(t){console.warn(`Failed to initialize restored app ${e}:`,t)}else{const t=document.getElementById(e);if(t){const o=t.querySelector(".letterpad_editor");if(o)try{typeof initializeLetterPad=="function"?await initializeLetterPad(o):console.warn("initializeLetterPad function not available")}catch(r){console.warn(`Failed to initialize LetterPad editor in window ${e}:`,r)}}}}function We(e){if(!e)return!0;const n=e.innerHTML.trim();return!n||n.length<50&&!n.includes("button")&&!n.includes("canvas")&&!n.includes("input")?!0:!e.querySelector('button, canvas, input[type="text"], .game-board, #media-container, #game-grid, #calc-display, #compost-bin-content')}function gi(e,n){if(typeof n!="function"){console.warn(`Launch function not available for ${e}`);return}const t=document.getElementById(e);if(!t){console.warn(`Window ${e} not found for reinitialization`);return}try{const o=e+"-temp-"+Date.now();t.id=o,n();const r=document.getElementById(e);if(r&&r!==t){const i=t.querySelector(".p-2"),a=r.querySelector(".p-2");i&&a&&(i.innerHTML=a.innerHTML,i.className=a.className),r.remove();const s=document.getElementById("tab-"+e);s&&s.remove(),delete G[e]}t.id=e}catch(o){t&&t.id!==e&&(t.id=e),console.error(`Failed to reinitialize ${e}:`,o)}}function yi(){}async function bi(){try{await _()}catch(e){console.error("Failed to save state manually:",e)}}function hi(e){Lo(e)}function wi(e){const n={calculator:launchCalculator,mediaplayer:launchMediaPlayer,bombbroomer:launchBombbroomer,solitaire:launchSolitaire};n[e]?gi(e,n[e]):console.warn(`No launch function found for ${e}`)}function vi(){const e=document.getElementById("bombbroomer");e&&typeof initializeBombbroomerUI=="function"?initializeBombbroomerUI(e):console.warn("Bombbroomer window not found or function not available")}async function xi(){try{if(await _(),await M.getItem("appState")){const n=await navigator.storage.estimate();return!0}else return console.error("✗ No data found after save"),!1}catch(e){return console.error("✗ Data integrity test failed:",e),!1}}async function ki(){try{const e=await M.getItem("appState"),n=await M.getItem("explicitRestart");return!!e}catch(e){return console.error("✗ Session persistence test failed:",e),!1}}async function Si(){await M.setItem("explicitRestart",!0)}typeof window<"u"&&(window.debugWindowStates=yi,window.forceSaveState=bi,window.testAppRestoration=hi,window.testAppReinitialization=wi,window.testBombbroomerInit=vi,window.testDataIntegrity=xi,window.testSessionPersistence=ki,window.simulateRestart=Si,window.saveState=_,window.getFileSystemState=Ce,window.setFileSystemState=ue,window.updateContent=Pe);window.addEventListener("beforeunload",async e=>{try{const n={fileSystemState:Me,windowStates:G,desktopIconsState:ne,desktopSettings:le,navWindows:xe};M.setItemSync("appState",n)}catch(n){console.error("Failed to save state during page unload:",n)}});setInterval(async()=>{try{await _()}catch(e){console.error("Failed to save periodic backup:",e)}},3e4);async function Ei(){for(const e in ne){const n=document.getElementById(e);if(n){const t=ne[e];n.style.position="absolute",n.style.left=t.left,n.style.top=t.top}}}fi().then(()=>{}).catch(console.error);const Ze=[{id:"mycomp",text:"My Computer",icon:"image/computer.webp",type:"item"},{id:"mediaapp",text:"Media Player",icon:"image/video.webp",type:"item"},{id:"watercolourapp",text:"Watercolour",icon:"image/watercolour.webp",type:"item"},{id:"utilities-group",text:"Utilities",type:"group",items:[{id:"letterpad",text:"LetterPad",icon:"image/file.webp"},{id:"calcapp",text:"Calculator",icon:"image/calculator.webp"},{id:"keyboard",text:"Keyboard",icon:"image/keyboard.webp"},{id:"sysset",text:"System Settings",icon:"image/gears.webp"},{id:"storageapp",text:"Storage Manager",icon:"image/drive_c.webp"},{id:"abtcomp",text:"About This Computer",icon:"image/info.webp"}]},{id:"games-group",text:"Games",type:"group",items:[{id:"solapp",text:"Solitaire",icon:"image/solitaire.webp"},{id:"chessapp",text:"Guillotine Chess",icon:"image/guillotine_chess.webp"},{id:"bombapp",text:"Bombbroomer",icon:"image/bombbroomer.webp"},{id:"pongapp",text:"Pong",icon:"image/pong.webp"},{id:"snakeapp",text:"Snake",icon:"image/snake.webp"}]},{id:"rstrtcomp",text:"Restart",icon:"image/power.webp",type:"item",fixed:!0}];let S={isDragging:!1,draggedElement:null,draggedFromGroup:null,placeholder:null,startY:0,startX:0,draggedItemData:null};function rn(){const e=document.getElementById("start-menu");if(!e){console.error("Start menu container not found");return}const n=typeof Y<"u"?Y:window.startMenuOrder||[];let t=[...Ze];if(n&&n.length>0){const r=[],i=new Set;n.forEach(a=>{if(typeof a=="string"){const s=Ze.find(c=>c.id===a);s&&(r.push(s),i.add(a))}else if(a&&a.type==="group"){let s=Ze.find(c=>c.type==="group"&&(c.id===a.id||c.text===a.name));if(s){const c={...s,items:a.items||s.items};r.push(c),i.add(s.id)}else r.push({id:a.id||`custom-group-${Date.now()}`,text:a.name,type:"group",items:a.items||[]})}}),Ze.forEach(a=>{!i.has(a.id)&&!a.fixed&&r.push(a)}),Ze.forEach(a=>{a.fixed&&r.push(a)}),t=r}const o=document.createElement("ul");if(t.forEach(r=>{if(r.type==="item"){const i=Ci(r);o.appendChild(i)}else if(r.type==="group"){const i=Ii(r);o.appendChild(i)}}),e.innerHTML="",e.appendChild(o),typeof window.updateStartMenuFocusability=="function"){const r=!e.classList.contains("hidden");window.updateStartMenuFocusability(r)}}function Ci(e){const n=document.createElement("li");return n.id=e.id,n.className=e.fixed?"px-4 py-2 hover:bg-gray-50 cursor-pointer flex items-center relative":"px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center relative",n.setAttribute("role","menuitem"),n.setAttribute("tabindex","-1"),n.setAttribute("aria-label",e.text),n.innerHTML=`
    <img src="${e.icon}" class="h-6 w-6 inline mr-2" alt="${e.text} icon">
    ${e.text}
  `,n.addEventListener("click",t=>{const o=n.querySelector(".start-menu-context-menu");o&&o.style.display!=="none"||Ke(e.id)}),n.addEventListener("mouseenter",()=>{var t;(t=window.startMenuKeyboardNavState)!=null&&t.isKeyboardNavigating()&&Ut()}),e.fixed||Mo(n,e,!1),n}function Ii(e){const n=document.createElement("li");n.className="group relative",n.setAttribute("data-group-id",e.id);let t="";e.items.forEach(a=>{t+=`
      <li id="${a.id}" class="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center submenu-item relative" data-submenu-item data-parent-group="${e.id}" role="menuitem" tabindex="-1" aria-label="${a.text}">
        <img src="${a.icon}" class="h-6 w-6 inline mr-2" alt="${a.text} icon">
        ${a.text}
      </li>
    `}),n.innerHTML=`
    <a href="#" data-submenu-trigger class="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center justify-between" role="menuitem" tabindex="-1" aria-label="${e.text}" aria-haspopup="true" aria-expanded="false">
      <div class="flex items-center">
        ${e.text}
      </div>
      <span class="md:rotate-0 text-xs">&#9654;</span>
    </a>
    <ul class="submenu hidden pl-4 bg-gray-100 md:pl-0 md:absolute md:left-full md:bottom-0 md:w-48 md:bg-white md:border md:border-gray-500 md:shadow-lg" data-submenu-container data-group-id="${e.id}" role="menu">
      ${t}
    </ul>
  `,n.querySelectorAll("ul li").forEach((a,s)=>{a.addEventListener("click",l=>{var f;((f=a.querySelector(".start-menu-context-menu"))==null?void 0:f.style.display)==="none"&&Ke(a.id)}),a.addEventListener("mouseenter",()=>{var l;(l=window.startMenuKeyboardNavState)!=null&&l.isKeyboardNavigating()&&Ut()});const c=e.items[s];c&&Mo(a,c,!0,e.id)});const r=n.querySelector("[data-submenu-trigger]"),i=n.querySelector("[data-submenu-container]");if(r&&r.addEventListener("mouseenter",()=>{var a;(a=window.startMenuKeyboardNavState)!=null&&a.isKeyboardNavigating()&&Ut()}),r&&i){let a;window.matchMedia("(hover: hover)").matches?(n.addEventListener("mouseenter",()=>{clearTimeout(a),i.classList.remove("hidden"),i.classList.add("block")}),n.addEventListener("mouseleave",()=>{a=setTimeout(()=>{i.classList.add("hidden"),i.classList.remove("block")},100)})):r.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation();const l=!i.classList.contains("hidden");document.querySelectorAll("[data-submenu-container]").forEach(f=>{f!==i&&(f.classList.add("hidden"),f.classList.remove("block"))}),l?(i.classList.add("hidden"),i.classList.remove("block")):(i.classList.remove("hidden"),i.classList.add("block"))})}return n}function Ke(e){if(console.log("🔍 Start menu item clicked:",e),S.isDragging){console.log("🔍 Ignoring click - drag operation in progress");return}if(typeof toggleStartMenu=="function")toggleStartMenu();else{const n=document.getElementById("start-menu");if(n){n.classList.add("hidden"),n.setAttribute("aria-hidden","true"),typeof window.updateStartMenuFocusability=="function"&&window.updateStartMenuFocusability(!1);const t=document.getElementById("start-button");t&&t.setAttribute("aria-expanded","false")}}switch(e){case"mycomp":typeof openExplorer=="function"&&openExplorer("C://");break;case"abtcomp":typeof openAboutWindow=="function"&&openAboutWindow();break;case"sysset":typeof openNav=="function"&&openNav("Settings","",{type:"integer",width:600,height:400},"Settings");break;case"storageapp":typeof openApp=="function"&&openApp("storage");break;case"watercolourapp":typeof openApp=="function"&&openApp("watercolour");break;case"letterpad":typeof createNewFile=="function"&&createNewFile(null,"C://Documents",n=>{typeof openFile=="function"&&openFile(n,{target:document.body})});break;case"calcapp":typeof openApp=="function"&&openApp("calculator");break;case"keyboard":console.log("🔍 Keyboard case triggered, calling openApp"),typeof openApp=="function"&&openApp("keyboard");break;case"solapp":typeof openApp=="function"&&openApp("solitaire");break;case"chessapp":typeof openApp=="function"&&openApp("chess");break;case"bombapp":typeof openApp=="function"&&openApp("bombbroomer");break;case"pongapp":typeof openApp=="function"&&openApp("pong");break;case"snakeapp":typeof openApp=="function"&&openApp("snake");break;case"mediaapp":typeof openApp=="function"&&openApp("mediaplayer");break;case"rstrtcomp":typeof yt=="function"&&yt();break;default:console.warn("Unknown start menu item clicked:",e)}}function Mo(e,n,t=!1,o=null){let r=!1;const a=!["mycomp","storageapp","sysset"].includes(n.id),s=document.createElement("div");s.className="start-menu-context-menu absolute hidden bg-gray-100 border-r border-t border-b border-gray-500 z-50 w-48",s.style.display="none";let c=`
    <div class="context-menu-item px-4 py-2 hover:bg-gray-50 cursor-pointer select-none flex items-center" data-action="open">
      Open
    </div>
    <div class="context-menu-item px-4 py-2 hover:bg-gray-50 cursor-pointer select-none flex items-center" data-action="shortcut">
      Create shortcut
    </div>`;a&&(c+=`
    <div class="context-menu-item px-4 py-2 hover:bg-gray-50 cursor-pointer select-none flex items-center text-red-600" data-action="uninstall">
      Uninstall
    </div>`),s.innerHTML=c,e.appendChild(s),s.addEventListener("click",d=>{var v;d.stopPropagation();const g=(v=d.target.closest(".context-menu-item"))==null?void 0:v.dataset.action;g&&(Li(g,n,t,o),p(s))});let l;e.addEventListener("mouseenter",()=>{S.isDragging||(clearTimeout(l),l=setTimeout(()=>{!r&&!S.isDragging&&u(s,e)},800))}),e.addEventListener("mouseleave",()=>{clearTimeout(l),setTimeout(()=>{s.matches(":hover")||p(s)},200)}),s.addEventListener("mouseleave",()=>{setTimeout(()=>{e.matches(":hover")||p(s)},200)});let f,m=!1;e.addEventListener("touchstart",d=>{S.isDragging||(m=!1,f=setTimeout(()=>{!m&&!r&&(d.preventDefault(),u(s,e))},500))}),e.addEventListener("touchmove",()=>{m=!0,clearTimeout(f)}),e.addEventListener("touchend",()=>{clearTimeout(f)}),document.addEventListener("click",d=>{!s.contains(d.target)&&!e.contains(d.target)&&p(s)});function u(d,g){document.querySelectorAll(".start-menu-context-menu").forEach(F=>{F!==d&&(F.style.display="none")}),d.style.display="block",d.classList.remove("hidden"),r=!0;const v=g.getBoundingClientRect(),x=d.getBoundingClientRect();d.style.left=`${g.offsetWidth}px`,d.style.top="-1px",document.getElementById("start-menu").getBoundingClientRect(),v.right+x.width>window.innerWidth&&(d.style.left=`-${x.width+5}px`)}function p(d){d.style.display="none",d.classList.add("hidden"),r=!1}}function Li(e,n,t,o){switch(e){case"open":Ke(n.id);break;case"shortcut":if(Mi(n),typeof toggleStartMenu=="function")toggleStartMenu();else{const r=document.getElementById("start-menu");if(r){r.classList.add("hidden"),r.setAttribute("aria-hidden","true");const i=document.getElementById("start-button");i&&i.setAttribute("aria-expanded","false")}}break;case"uninstall":if(Ai(n,t,o),typeof toggleStartMenu=="function")toggleStartMenu();else{const r=document.getElementById("start-menu");if(r){r.classList.add("hidden"),r.setAttribute("aria-hidden","true");const i=document.getElementById("start-button");i&&i.setAttribute("aria-expanded","false")}}break}}async function Mi(e){try{const n=await getFileSystemState();if(!n.folders["C://Desktop"]){console.error("Desktop folder not found"),typeof showDialogBox=="function"&&showDialogBox("Desktop folder not found","error");return}const t=`shortcut-${e.id}-${Date.now()}`;let o=e.icon||"image/file.webp";const r={id:t,name:e.text,type:"app",fullPath:`C://Desktop/${t}`,content_type:"html",contents:{},icon:o,isShortcut:!0,targetId:e.id};n.folders["C://Desktop"][t]=r,await ue(n),await _(),typeof renderDesktopIcons=="function"?renderDesktopIcons():typeof window.renderDesktopIcons=="function"&&window.renderDesktopIcons()}catch(n){console.error("❌ Failed to create desktop shortcut:",n),typeof showDialogBox=="function"&&showDialogBox("Failed to create desktop shortcut","error")}}function Ai(e,n,t){const o=`Are you sure you want to uninstall "${e.text}" from the Start menu?`;typeof showDialogBox=="function"?showDialogBox(o,"confirmation",()=>{Mn(e,n,t)},()=>{}):confirm(o)&&Mn(e,n,t)}async function Mn(e,n,t){try{let o=[];try{const r=await M.getItem("startMenuOrder");r&&Array.isArray(r)?o=r:o=typeof Y<"u"?Y:window.startMenuOrder||[]}catch{o=typeof Y<"u"?Y:window.startMenuOrder||[]}if(n&&t){const r=o.map(i=>typeof i=="object"&&i.type==="group"&&i.id===t?{...i,items:i.items.filter(a=>a.id!==e.id)}:i);window.startMenuOrder=r,typeof Y<"u"&&(Y=r),await M.setItem("startMenuOrder",r)}else{const r=o.filter(i=>typeof i=="string"?i!==e.id:!0);window.startMenuOrder=r,typeof Y<"u"&&(Y=r),await M.setItem("startMenuOrder",r)}typeof _=="function"&&await _(),rn(),setTimeout(()=>{sn()},50),typeof showDialogBox=="function"&&showDialogBox(`"${e.id}" has been uninstalled from the Start menu`,"info")}catch(o){console.error("❌ Failed to uninstall item:",o),typeof showDialogBox=="function"&&showDialogBox("Failed to uninstall item","error")}}function Ao(){rn();const e=document.getElementById("start-menu");if(!e)return console.warn("Start menu element not found"),!1;const n=e.querySelectorAll("ul > li:not(.group):not(#rstrtcomp)"),t=e.querySelectorAll(".submenu-item");return n.forEach(o=>{Do(o)}),t.forEach(o=>{an(o)}),Di(),!0}function Di(){const e=document.getElementById("start-menu");e&&(e.addEventListener("dragover",n=>{const t=n.target.closest(".group");if(t&&S.isDragging){const o=t.querySelector("[data-submenu-container]");o&&(o.classList.remove("hidden"),o.classList.add("block"))}}),e.addEventListener("dragleave",n=>{S.isDragging||e.querySelectorAll("[data-submenu-container]").forEach(o=>{o.classList.remove("block")})}))}function an(e){e.addEventListener("pointerdown",t);function t(i){var f;if(i.button!==0)return;S.startY=i.clientY,S.startX=i.clientX,S.draggedElement=e,S.draggedFromGroup=e.getAttribute("data-parent-group");const a=((f=e.querySelector("img"))==null?void 0:f.src)||"",s=e.cloneNode(!0),c=s.querySelector(".start-menu-context-menu");c&&c.remove();const l=s.textContent.trim();S.draggedItemData={id:e.id,text:l,icon:a,parentGroup:S.draggedFromGroup},document.addEventListener("pointermove",o),document.addEventListener("pointerup",r),document.addEventListener("pointercancel",r),i.preventDefault()}function o(i){if(!i.isPrimary)return;const a=Math.sqrt(Math.pow(i.clientY-S.startY,2)+Math.pow(i.clientX-S.startX,2));!S.isDragging&&a>5&&(S.isDragging=!0,Bi(e)),S.isDragging&&Ti(i)}function r(i){i.isPrimary&&(document.removeEventListener("pointermove",o),document.removeEventListener("pointerup",r),document.removeEventListener("pointercancel",r),S.isDragging&&Fi(),Bo())}}function Do(e){e.addEventListener("pointerdown",t);function t(i){i.button===0&&(S.startY=i.clientY,S.draggedElement=e,document.addEventListener("pointermove",o),document.addEventListener("pointerup",r),document.addEventListener("pointercancel",r),i.preventDefault())}function o(i){if(!i.isPrimary)return;const a=Math.abs(i.clientY-S.startY);!S.isDragging&&a>5&&(S.isDragging=!0,$i(e)),S.isDragging&&Pi(i)}function r(i){i.isPrimary&&(document.removeEventListener("pointermove",o),document.removeEventListener("pointerup",r),document.removeEventListener("pointercancel",r),S.isDragging&&zi(),Bo())}}function Bo(){S.placeholder&&S.placeholder.remove(),S.draggedElement&&(S.draggedElement.classList.remove("opacity-50","cursor-grabbing"),S.draggedElement.classList.add("cursor-grab")),document.querySelectorAll(".start-menu-context-menu").forEach(e=>{e.style.display="none",e.classList.add("hidden")}),S.isDragging=!1,S.draggedElement=null,S.draggedFromGroup=null,S.placeholder=null,S.startY=0,S.startX=0,S.draggedItemData=null}function Bi(e,n){document.querySelectorAll(".start-menu-context-menu").forEach(t=>{t.style.display="none",t.classList.add("hidden")}),e.classList.add("opacity-50","cursor-grabbing"),e.classList.remove("cursor-grab"),S.placeholder=document.createElement("li"),S.placeholder.className="submenu-placeholder h-8 bg-blue-100 border-2 border-dashed border-blue-500 rounded my-0.5 px-4 py-1",S.placeholder.innerHTML='<span class="text-yellow-600 text-sm"></span>',e.parentNode.insertBefore(S.placeholder,e.nextSibling)}function Ti(e){if(!S.placeholder||!S.draggedItemData)return;const n=document.getElementById("start-menu"),t=document.elementFromPoint(e.clientX,e.clientY),o=t==null?void 0:t.closest("[data-submenu-container]");t==null||t.closest(".submenu-item");const r=t==null?void 0:t.closest("ul > li:not(.group)");if(o){o.getAttribute("data-group-id");const i=Array.from(o.querySelectorAll(".submenu-item")).filter(c=>c!==S.draggedElement&&!c.classList.contains("submenu-placeholder"));let a=null,s=!0;for(let c=0;c<i.length;c++){const l=i[c],f=l.getBoundingClientRect(),m=f.top+f.height/2;if(e.clientY<m){a=l,s=!0;break}else if(c===i.length-1){a=l,s=!1;break}}a?s?o.insertBefore(S.placeholder,a):o.insertBefore(S.placeholder,a.nextSibling):o.appendChild(S.placeholder)}else if(r&&!r.classList.contains("group")){const i=n.querySelector("ul"),a=Array.from(i.children).filter(l=>l!==S.draggedElement&&!l.classList.contains("start-menu-placeholder")&&!l.classList.contains("group")&&l.id!=="rstrtcomp");S.placeholder.classList.contains("start-menu-placeholder")||(S.placeholder.className="start-menu-placeholder h-10 bg-indigo-100 border-2 border-dashed border-indigo-500 rounded my-0.5",S.placeholder.innerHTML="");let s=null,c=!0;for(let l=0;l<a.length;l++){const f=a[l],m=f.getBoundingClientRect(),u=m.top+m.height/2;if(e.clientY<u){s=f,c=!0;break}else if(l===a.length-1){s=f,c=!1;break}}if(s)c?i.insertBefore(S.placeholder,s):i.insertBefore(S.placeholder,s.nextSibling);else{const l=i.querySelector("#rstrtcomp");l?i.insertBefore(S.placeholder,l):i.appendChild(S.placeholder)}}}function Fi(e){if(!S.placeholder||!S.draggedElement||!S.draggedItemData)return;S.draggedElement.classList.remove("opacity-50","cursor-grabbing");const n=S.placeholder.parentNode,t=n.tagName==="UL"&&!n.hasAttribute("data-submenu-container"),o=n.getAttribute("data-group-id");if(t){S.draggedElement.remove();const r=document.createElement("li");r.id=S.draggedItemData.id,r.className="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center",r.innerHTML=`
      <img src="${S.draggedItemData.icon}" class="h-6 w-6 inline mr-2" alt="${S.draggedItemData.text}">
      ${S.draggedItemData.text}
    `,r.addEventListener("click",()=>Ke(r.id)),n.insertBefore(r,S.placeholder),S.placeholder.remove(),Do(r)}else if(o&&o!==S.draggedFromGroup){S.draggedElement.remove();const r=document.createElement("li");r.id=S.draggedItemData.id,r.className="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center submenu-item",r.setAttribute("data-submenu-item",""),r.setAttribute("data-parent-group",o),r.innerHTML=`
      <img src="${S.draggedItemData.icon}" class="h-6 w-6 inline mr-2" alt="${S.draggedItemData.text}">
      ${S.draggedItemData.text}
    `,r.addEventListener("click",()=>Ke(r.id)),n.insertBefore(r,S.placeholder),S.placeholder.remove(),an(r)}else o===S.draggedFromGroup&&(n.insertBefore(S.draggedElement,S.placeholder),S.placeholder.remove());setTimeout(async()=>{try{await Ye()}catch(r){console.error("❌ Failed to save submenu changes:",r)}},10)}function $i(e,n){document.querySelectorAll(".start-menu-context-menu").forEach(t=>{t.style.display="none",t.classList.add("hidden")}),e.classList.add("opacity-50","cursor-grabbing"),e.classList.remove("cursor-grab"),S.placeholder=document.createElement("li"),S.placeholder.className="start-menu-placeholder h-10 bg-indigo-100 border-2 border-dashed border-indigo-500 rounded my-0.5",e.parentNode.insertBefore(S.placeholder,e.nextSibling)}function Pi(e){if(!S.placeholder)return;const n=document.getElementById("start-menu"),t=document.elementFromPoint(e.clientX,e.clientY),o=t==null?void 0:t.closest("[data-submenu-container]");if(o&&S.draggedElement&&!S.draggedElement.classList.contains("submenu-item")){o.getAttribute("data-group-id");const c=Array.from(o.querySelectorAll(".submenu-item")).filter(m=>!m.classList.contains("submenu-placeholder"));S.placeholder.classList.contains("submenu-placeholder")||(S.placeholder.className="submenu-placeholder h-8 bg-blue-100 border-2 border-dashed border-blue-500 rounded my-0.5 px-4 py-1",S.placeholder.innerHTML='<span class="text-blue-600 text-sm"></span>');let l=null,f=!0;for(let m=0;m<c.length;m++){const u=c[m],p=u.getBoundingClientRect(),d=p.top+p.height/2;if(e.clientY<d){l=u,f=!0;break}else if(m===c.length-1){l=u,f=!1;break}}l?f?o.insertBefore(S.placeholder,l):o.insertBefore(S.placeholder,l.nextSibling):o.appendChild(S.placeholder);return}const r=n.querySelector("ul"),i=Array.from(r.children).filter(c=>c!==S.draggedElement&&!c.classList.contains("start-menu-placeholder")&&!c.classList.contains("group")&&c.id!=="rstrtcomp");S.placeholder.classList.contains("start-menu-placeholder")||(S.placeholder.className="start-menu-placeholder h-10 bg-indigo-100 border-2 border-dashed border-indigo-500 rounded my-0.5",S.placeholder.innerHTML="");let a=null,s=!0;for(let c=0;c<i.length;c++){const l=i[c],f=l.getBoundingClientRect(),m=f.top+f.height/2;if(e.clientY<m){a=l,s=!0;break}else if(c===i.length-1){a=l,s=!1;break}}if(a)s?r.insertBefore(S.placeholder,a):r.insertBefore(S.placeholder,a.nextSibling);else{const c=r.querySelector("#rstrtcomp");c&&r.insertBefore(S.placeholder,c)}}function zi(e){var r;if(!S.placeholder||!S.draggedElement)return;S.draggedElement.classList.remove("opacity-50","cursor-grabbing");const n=S.placeholder.parentNode,t=n.hasAttribute("data-submenu-container"),o=n.getAttribute("data-group-id");if(t){const i=S.draggedElement.cloneNode(!0),a=i.querySelector(".start-menu-context-menu");a&&a.remove();const s={id:S.draggedElement.id,text:i.textContent.trim(),icon:((r=S.draggedElement.querySelector("img"))==null?void 0:r.src)||""};S.draggedElement.remove();const c=document.createElement("li");c.id=s.id,c.className="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center submenu-item",c.setAttribute("data-submenu-item",""),c.setAttribute("data-parent-group",o),c.innerHTML=`
      <img src="${s.icon}" class="h-6 w-6 inline mr-2" alt="${s.text}">
      ${s.text}
    `,c.addEventListener("click",()=>Ke(c.id)),n.insertBefore(c,S.placeholder),S.placeholder.remove(),an(c)}else S.draggedElement.classList.add("cursor-grab"),n.insertBefore(S.draggedElement,S.placeholder),S.placeholder.remove();setTimeout(async()=>{try{await Ye()}catch(i){console.error("❌ Failed to save start menu order:",i)}},10)}async function Ye(){if(typeof window.isInitializing<"u"&&window.isInitializing)return;const n=document.getElementById("start-menu").querySelector("ul"),t=Array.from(n.children),o=[];if(t.forEach(r=>{if(r.id&&!r.classList.contains("group")&&r.id!=="rstrtcomp")o.push(r.id);else if(r.classList.contains("group")){const i=r.getAttribute("data-group-id"),a=r.querySelector("[data-submenu-trigger]"),s=r.querySelector("[data-submenu-container]");if(a&&s&&i){const c=a.cloneNode(!0),l=c.querySelector(".start-menu-context-menu");l&&l.remove();const f=c.textContent.trim(),m=Array.from(s.querySelectorAll(".submenu-item")).map(p=>{var v;const d=p.cloneNode(!0),g=d.querySelector(".start-menu-context-menu");return g&&g.remove(),{id:p.id,text:d.textContent.trim(),icon:((v=p.querySelector("img"))==null?void 0:v.src)||""}}),u={type:"group",id:i,name:f,items:m};o.push(u)}}}),!o||o.length===0){console.warn("Refusing to save empty start menu order - likely a race condition");return}if(typeof window<"u"){window.startMenuOrder=o;try{typeof Y<"u"&&(Y=o)}catch{}}try{await M.setItem("startMenuOrder",o),typeof _=="function"?await _():typeof window.saveState=="function"?await window.saveState():console.warn("⚠ saveState function not available, only saved directly");try{const r=await M.getItem("startMenuOrder");JSON.stringify(r)===JSON.stringify(o)||console.warn("⚠ Start menu order mismatch in direct storage after save")}catch(r){console.warn("Could not verify direct save:",r)}}catch(r){console.error("Failed to save start menu order:",r)}}async function Lt(){let e=[];try{const n=await M.getItem("startMenuOrder");n&&Array.isArray(n)?e=n:e=typeof Y<"u"?Y:window.startMenuOrder||[]}catch(n){console.warn("⚠ Failed to load from direct storage, using global variables:",n),e=typeof Y<"u"?Y:window.startMenuOrder||[]}typeof window<"u"&&(window.startMenuOrder=e);try{typeof Y<"u"&&(Y=e)}catch{}rn(),Ht=!1,setTimeout(()=>{sn()},50)}let Ht=!1;document.addEventListener("DOMContentLoaded",()=>{});function sn(){if(Ht)return!0;const e=Ao();return e&&(Ht=!0),e}window.initializeStartMenuDragDrop=Ao;window.safeInitializeStartMenuDragDrop=sn;window.restoreStartMenuOrder=Lt;window.saveStartMenuOrder=Ye;window.debugStartMenuState=async function(){const e=document.getElementById("start-menu"),n=e==null?void 0:e.querySelector("ul");Array.from((n==null?void 0:n.children)||[]).map(t=>{var i;const o=t.cloneNode(!0),r=o.querySelector(".start-menu-context-menu");return r&&r.remove(),{id:t.id,text:(i=o.textContent)==null?void 0:i.trim()}});try{const t=await M.getItem("appState")}catch(t){console.error("Error reading from storage:",t)}};window.testSaveStartMenu=function(){Ye().catch(e=>{console.error("Test save failed:",e)})};window.testBasicSave=async function(){if(window.startMenuOrder=["test1","test2","test3"],typeof window.saveState=="function")try{await window.saveState();const e=await M.getItem("appState")}catch(e){console.error("❌ Basic save failed:",e)}else console.error("❌ window.saveState not available")};window.testRealSave=async function(){await Ye()};window.testRestore=function(){Lt()};function wt(){Lt()}window.initializeStartMenu=wt;window.testFullStartMenuFlow=async function(){await debugStartMenuState(),wt(),await debugStartMenuState(),await testRealSave(),testRestore(),await debugStartMenuState()};window.testStartMenuSave=async function(){const e=["app-calculator","app-chess","app-mediaplayer"];await Ye();const n=await M.getItem("startMenuOrder"),t=await M.getItem("appState");return{testOrder:e,directResult:n,appStateResult:t==null?void 0:t.startMenuOrder,globalResult:typeof Y<"u"?Y:null,windowResult:window.startMenuOrder}};window.testStartMenuRestore=async function(){var n;typeof window<"u"&&(window.startMenuOrder=[]);try{typeof Y<"u"&&(Y=[])}catch{console.warn("Could not clear global startMenuOrder")}return await Lt(),{globalResult:typeof Y<"u"?Y:null,windowResult:window.startMenuOrder,menuHTML:((n=document.getElementById("start-menu"))==null?void 0:n.innerHTML.substring(0,200))+"..."}};window.debugStorageContents=async function(){try{const e=await M.getItem("appState"),n=await M.getItem("startMenuOrder");return{appState:e,directStartMenu:n,globalStartMenu:typeof Y<"u"?Y:null,windowStartMenu:window.startMenuOrder}}catch(e){return console.error("❌ Error debugging storage:",e),{error:e.message}}};function Ut(){document.querySelectorAll('#start-menu [role="menuitem"]').forEach(n=>{n.classList.remove("bg-gray-50","focus-visible","keyboard-focused"),n.setAttribute("tabindex","-1"),n.blur()}),window.startMenuKeyboardNavState&&window.startMenuKeyboardNavState.setKeyboardNavigating(!1)}function Ni(e,n=!1){var o;const t=document.querySelectorAll('#start-menu [role="menuitem"]');if(t.forEach(r=>{r.classList.remove("bg-gray-50","focus-visible","keyboard-focused"),r.setAttribute("tabindex","-1"),r.hasAttribute("aria-haspopup")&&r.setAttribute("aria-expanded","false")}),document.querySelectorAll("[data-submenu-container]").forEach(r=>{r.classList.add("hidden"),r.classList.remove("block")}),t[e]){const r=t[e];if(r.classList.add("bg-gray-50","focus-visible","keyboard-focused"),r.setAttribute("tabindex","0"),r.focus(),n&&r.hasAttribute("data-submenu-trigger")){const i=r.closest("li"),a=i==null?void 0:i.querySelector("[data-submenu-container]");a&&(a.classList.remove("hidden"),a.classList.add("block"),r.setAttribute("aria-expanded","true"))}if(r.hasAttribute("data-submenu-item")){const i=r.getAttribute("data-parent-group");if(i){const a=document.querySelector(`[data-submenu-container][data-group-id="${i}"]`);if(a){a.classList.remove("hidden"),a.classList.add("block");const s=(o=a.closest("li"))==null?void 0:o.querySelector("[data-submenu-trigger]");s&&s.setAttribute("aria-expanded","true")}}}r.scrollIntoView({behavior:"smooth",block:"nearest"})}}function Wi(){let e=0,n=[],t=!1,o=!1;window.startMenuKeyboardNavState={isKeyboardNavigating:()=>o,setKeyboardNavigating:f=>{o=f}};function r(f,m=!1){o=!0,Ni(f,m)}document.addEventListener("keydown",function(f){if(f.key==="Meta"||f.key==="OS"){f.preventDefault();const m=document.getElementById("start-menu"),u=document.getElementById("start-button");m&&u&&(m.classList.contains("hidden")?(typeof toggleStartMenu=="function"?toggleStartMenu():(m.classList.remove("hidden"),m.setAttribute("aria-hidden","false"),u.setAttribute("aria-expanded","true"),typeof window.updateStartMenuFocusability=="function"&&window.updateStartMenuFocusability(!0)),setTimeout(c,10)):(typeof toggleStartMenu=="function"?toggleStartMenu():(m.classList.add("hidden"),m.setAttribute("aria-hidden","true"),u.setAttribute("aria-expanded","false"),typeof window.updateStartMenuFocusability=="function"&&window.updateStartMenuFocusability(!1)),u.focus()))}});function i(){return n=Array.from(document.querySelectorAll('#start-menu [role="menuitem"]')),n}function a(){return n.filter(f=>!f.hasAttribute("data-submenu-item"))}function s(f){return n.filter(m=>m.hasAttribute("data-submenu-item")&&m.getAttribute("data-parent-group")===f)}function c(){i(),e=0,t=!1,n.length>0&&r(e)}const l=document.getElementById("start-button");l&&l.addEventListener("click",()=>{setTimeout(c,10)}),document.addEventListener("keydown",function(f){const m=document.getElementById("start-menu");if(!(!m||m.classList.contains("hidden"))&&(i(),n.length!==0))switch(f.key){case"ArrowDown":if(f.preventDefault(),t){const u=n[e],p=u.getAttribute("data-parent-group"),d=s(p),v=(d.indexOf(u)+1)%d.length,x=d[v];e=n.indexOf(x)}else{const u=a(),p=n[e],g=(u.indexOf(p)+1)%u.length,v=u[g];e=n.indexOf(v)}r(e);break;case"ArrowUp":if(f.preventDefault(),t){const u=n[e],p=u.getAttribute("data-parent-group"),d=s(p),v=(d.indexOf(u)-1+d.length)%d.length,x=d[v];e=n.indexOf(x)}else{const u=a(),p=n[e],g=(u.indexOf(p)-1+u.length)%u.length,v=u[g];e=n.indexOf(v)}r(e);break;case"ArrowRight":if(f.preventDefault(),n[e]&&n[e].hasAttribute("data-submenu-trigger")&&n[e].classList.contains("focus-visible")){const u=n[e].closest("li"),p=u==null?void 0:u.querySelector("[data-submenu-container]"),d=p==null?void 0:p.querySelectorAll('[role="menuitem"]');if(d&&d.length>0){for(let g=0;g<n.length;g++)if(d[0]===n[g]){e=g,t=!0,r(e);break}}}break;case"ArrowLeft":if(f.preventDefault(),n[e]&&n[e].hasAttribute("data-submenu-item")){const u=n[e].getAttribute("data-parent-group");if(u)for(let p=0;p<n.length;p++){const d=n[p];if(d.hasAttribute("data-submenu-trigger")){const g=d.closest("li");if((g==null?void 0:g.getAttribute("data-group-id"))===u){e=p,t=!1,r(e,!1);break}}}}break;case"Enter":case" ":f.preventDefault(),n[e]&&n[e].click();break;case"Escape":f.preventDefault(),m&&(m.classList.add("hidden"),m.setAttribute("aria-hidden","true"),l&&(l.setAttribute("aria-expanded","false"),l.focus()));break;case"Home":if(f.preventDefault(),t){const p=n[e].getAttribute("data-parent-group"),d=s(p);if(d.length>0){const g=d[0];e=n.indexOf(g)}}else{const u=a();if(u.length>0){const p=u[0];e=n.indexOf(p)}}r(e);break;case"End":if(f.preventDefault(),t){const p=n[e].getAttribute("data-parent-group"),d=s(p);if(d.length>0){const g=d[d.length-1];e=n.indexOf(g)}}else{const u=a();if(u.length>0){const p=u[u.length-1];e=n.indexOf(p)}}r(e);break}}),i()}function Kt(e){const n=document.getElementById("start-menu");if(!n)return;n.querySelectorAll('[role="menuitem"], a[data-submenu-trigger]').forEach(o=>{e?o.setAttribute("tabindex","-1"):(o.setAttribute("tabindex","-1"),o.blur())})}function tt(){const e=document.getElementById("start-menu"),n=document.getElementById("start-button"),t=e.classList.contains("hidden");e.classList.toggle("hidden"),n.setAttribute("aria-expanded",t?"true":"false"),t?(e.setAttribute("aria-hidden","false"),Kt(!0)):(e.setAttribute("aria-hidden","true"),Kt(!1)),Fe("start-button"),Ri(),e.classList.contains("hidden")||setTimeout(()=>{typeof safeInitializeStartMenuDragDrop=="function"?safeInitializeStartMenuDragDrop():typeof initializeStartMenuDragDrop=="function"?initializeStartMenuDragDrop():console.warn("Start menu drag and drop initialization functions not available")},10)}function Mt(){for(const e in G)He(e);document.querySelectorAll("#window-tabs > div").forEach(e=>{e.classList.remove("bg-gray-50")})}function At(e,n="",t={type:"default"},o="default"){if(xe[e]){const r=document.getElementById(xe[e]);if(r){Ie(r);return}else delete xe[e]}Z(e,n,!0,null,!1,!1,t,o)}function Dt(){const e=document.getElementById("clock"),n=new Date;let t=n.getHours(),o=n.getMinutes(),r=n.getSeconds();t=t<10?"0"+t:t,o=o<10?"0"+o:o,r=r<10?"0"+r:r;let a=typeof le<"u"&&le&&le.clockSeconds||!1?`${t}:${o}:${r}`:`${t}:${o}`;e.textContent=a}function Bt(){const e=Tt();e&&(e.paused?e.play():e.pause(),ln())}function ln(){const e=Tt(),n=document.getElementById("media-control");e?(n.textContent=e.paused?"▶":"⏸",n.setAttribute("aria-label",e.paused?"Play media":"Pause media"),n.style.display="inline-block"):(n.textContent="",n.setAttribute("aria-label","No media playing"),n.style.display="none")}function Tt(){if(Ue){const e=document.getElementById(Ue);if(e)return e.querySelector("video, audio")}return null}setInterval(Dt,1e3);Dt();document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelectorAll("[data-submenu-trigger]");window.innerWidth<1024&&e.forEach(t=>{const o=t.nextElementSibling,r=t.querySelector("span");t.addEventListener("click",i=>{i.preventDefault(),o.classList.contains("hidden")?(o.classList.remove("hidden"),o.classList.add("block"),r.classList.add("rotate-90")):(o.classList.remove("block"),o.classList.add("hidden"),r.classList.remove("rotate-90"))})})});document.getElementById("media-control").addEventListener("click",()=>{Bt()});document.getElementById("min-all-btn").addEventListener("click",()=>{tt(),Mt()});document.getElementById("start-button").addEventListener("click",()=>{tt()});function Ri(){const e=document.getElementById("start-button").querySelector("img");e.src.includes("image/door-closed.webp")?e.src=e.src.replace("door-closed","door-open"):e.src=e.src.replace("door-open","door-closed")}const Oi=Object.freeze(Object.defineProperty({__proto__:null,getActiveMediaElement:Tt,minimizeAllWindows:Mt,openNav:At,toggleMediaPlayback:Bt,toggleStartMenu:tt,updateClock:Dt,updateMediaControl:ln,updateStartMenuFocusability:Kt},Symbol.toStringTag,{value:"Module"}));async function Oe(e){if(e.dataset.initialized==="true")return;e.dataset.initialized="true";try{await M.ensureReady()}catch(d){console.warn("Storage not ready, falling back to sync methods:",d)}const n=e.getAttribute("data-letterpad-editor-id"),t=`letterpad_${n}`;let o=null;try{const d=await M.getItem(t);if(d)try{o=d.content}catch(g){console.error("Error accessing stored markdown data for editor "+n,g)}}catch(d){console.warn("Failed to load LetterPad content for editor "+n+", trying sync method:",d);try{const g=M.getItemSync(t);g&&(o=g.content)}catch(g){console.warn("Sync fallback also failed:",g)}}const r=document.createElement("div");r.className="flex flex-col border rounded p-4 bg-white";const i=document.createElement("div");i.className="flex space-x-2 mb-2";const a=document.createElement("select");a.className="border rounded p-1",a.id="heading-selector",a.setAttribute("aria-label","Select text formatting style"),a.setAttribute("title","Choose the text style (paragraph, heading 1, etc.)"),[{value:"paragraph",text:"Paragraph"},{value:"h1",text:"Heading 1"},{value:"h2",text:"Heading 2"},{value:"h3",text:"Heading 3"}].forEach(d=>{const g=document.createElement("option");g.value=d.value,g.textContent=d.text,a.appendChild(g)}),i.appendChild(a);const c=document.createElement("button");c.type="button",c.className="border rounded p-1 hover:bg-gray-200",c.textContent="Bold",c.setAttribute("aria-label","Apply bold formatting"),c.setAttribute("title","Make selected text bold"),i.appendChild(c);const l=document.createElement("button");l.type="button",l.className="border rounded p-1 hover:bg-gray-200",l.textContent="Italic",l.setAttribute("aria-label","Apply italic formatting"),l.setAttribute("title","Make selected text italic"),i.appendChild(l);const f=document.createElement("button");f.type="button",f.className="border rounded p-1 hover:bg-gray-200",f.textContent="Underline",f.setAttribute("aria-label","Apply underline formatting"),f.setAttribute("title","Underline selected text"),i.appendChild(f);const m=document.createElement("textarea");m.className="w-full h-40 border rounded p-2 mb-2",m.id="markdown-editor",m.setAttribute("aria-label","Markdown text editor"),m.setAttribute("placeholder","Type your text here using Markdown formatting..."),m.setAttribute("title","Enter your text with Markdown formatting");const u=document.createElement("div");u.className="w-full h-40 border rounded p-2 overflow-auto";const p=document.createElement("button");p.type="button",p.className="border rounded p-1 hover:bg-gray-200 self-end",p.setAttribute("aria-label","Toggle between edit and preview mode"),p.setAttribute("title","Switch between editing and preview modes"),o?p.textContent="Edit":p.textContent="Save & Preview",r.appendChild(i),r.appendChild(m),r.appendChild(u),r.appendChild(p),e.appendChild(r),o?(m.value=o,u.innerHTML=Gt(o),m.classList.add("hidden"),i.classList.add("hidden"),p.classList.remove("hidden"),u.classList.remove("hidden")):(u.classList.add("hidden"),c.addEventListener("mousedown",function(d){d.preventDefault(),Yt("**",m)}),l.addEventListener("mousedown",function(d){d.preventDefault(),Yt("*",m)}),f.addEventListener("click",function(){const d=m.selectionStart,g=m.selectionEnd,v=m.value.substring(d,g),x=m.value.substring(0,d),F=m.value.substring(g);if(v.startsWith("<u>")&&v.endsWith("</u>")){const I=v.substring(3,v.length-4);m.value=x+I+F}else{const I=`<u>${v}</u>`;m.value=x+I+F}m.focus(),m.selectionStart=d,m.selectionEnd=g+7}),a.addEventListener("change",function(){const d=a.value,g=m.selectionStart,v=m.value,x=v.lastIndexOf(`
`,g-1)+1;let F="";d==="h1"?F="# ":d==="h2"?F="## ":d==="h3"?F="### ":F="";const I=v.indexOf(`
`,g),W=v.substring(x,I===-1?v.length:I).replace(/^(#{1,6}\s)?/,F);m.value=v.substring(0,x)+W+v.substring(I===-1?v.length:I)})),p.addEventListener("click",async function(){if(m.classList.contains("hidden"))u.classList.add("hidden"),m.classList.remove("hidden"),i.classList.remove("hidden"),p.textContent="Preview & Save";else{const d=m.value;u.innerHTML=Gt(d);try{await M.setItem(t,{content:d})}catch(g){console.warn("Failed to save LetterPad content for editor "+n,g)}m.classList.add("hidden"),u.classList.remove("hidden"),p.textContent="Edit",i.classList.add("hidden")}})}document.addEventListener("DOMContentLoaded",async function(){try{await M.ensureReady()}catch(t){console.warn("Storage not ready during LetterPad initialization:",t)}const e=document.querySelectorAll(".letterpad_editor");for(const t of e)try{await Oe(t)}catch(o){console.error("Error initializing LetterPad editor during DOMContentLoaded:",o)}new MutationObserver(t=>{t.forEach(o=>{o.type==="childList"&&o.addedNodes.forEach(r=>{r.nodeType===Node.ELEMENT_NODE&&(r.classList.contains("letterpad_editor")&&Oe(r).catch(i=>{console.error("Error initializing LetterPad editor:",i)}),r.querySelectorAll&&r.querySelectorAll(".letterpad_editor").forEach(i=>{Oe(i).catch(a=>{console.error("Error initializing LetterPad editor:",a)})}))})})}).observe(document.body,{childList:!0,subtree:!0})});async function To(){const e=document.querySelectorAll('.letterpad_editor:not([data-initialized="true"])');for(const n of e)try{await Oe(n)}catch(t){console.error("Error initializing LetterPad editor:",t)}}window.initializeAllLetterPadEditors=To;function Yt(e,n){const t=n.selectionStart,o=n.selectionEnd;if(t===o)return;const r=n.value.substring(t,o),i=n.value.substring(0,t),a=n.value.substring(o),s=e.length,c=r.startsWith(e),l=r.endsWith(e);let f,m=2*s;c&&l?(f=r.slice(s,-s),m=-m):f=e+r+e,n.value=i+f+a,setTimeout(()=>{n.focus(),n.selectionStart=t,n.selectionEnd=o+m},0)}function Gt(e){let n=e;return n=n.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),n=n.replace(/\*(.+?)\*/g,"<em>$1</em>"),n=n.replace(/###### (.*)/g,'<h6 class="mt-1 mb-2 text-2xl">$1</h6>'),n=n.replace(/##### (.*)/g,'<h5 class="mt-1 mb-2 text-3xl">$1</h5>'),n=n.replace(/#### (.*)/g,'<h4 class="mt-1 mb-2 text-4xl">$1</h4>'),n=n.replace(/### (.*)/g,'<h3 class="mt-1 mb-2 text-5xl">$1</h3>'),n=n.replace(/## (.*)/g,'<h2 class="mt-1 mb-2 text-6xl">$1</h2>'),n=n.replace(/# (.*)/g,'<h1 class="mt-1 mb-2 text-7xl">$1</h1>'),n=n.replace(/\n/g,"<br>"),qo(n,["strong","em","h1","h2","h3","h4","h5","h6","br","u"],["class"])}document.addEventListener("contextmenu",function(e){let n=e.target.closest(".draggable-icon, .file-item"),t=e.target.closest(".file-explorer-window"),o=e.target.closest("#explorer-window"),r=t||o,i=e.target.closest("#windows-container > div"),a=e.target.closest("#desktop-icons"),c=(e.target.id==="windows-container"||a)&&!i;if(!n&&!r&&!c)return;e.preventDefault();let l;if(t)l=t.getAttribute("data-current-path");else if(o){const f=o.querySelector(".file-explorer-window");l=(f==null?void 0:f.getAttribute("data-current-path"))||"C://"}else c?l="C://Desktop":l="C://";Fo(e,n,l)});document.addEventListener("click",function(){ye()});function Fo(e,n,t){const o=document.getElementById("context-menu");o.replaceChildren(),o.style.zIndex=ve+100;const r=(a,s,c,l=!1)=>{const f=document.createElement("div");return f.className=`px-4 py-2 relative ${s?"text-gray-400":"hover:bg-gray-50 cursor-pointer"}`,l?f.innerHTML=`${a} <span class="float-right">▶</span>`:f.textContent=a,!s&&c&&f.addEventListener("click",c),o.appendChild(f),f},i=(a,s)=>{const c=document.createElement("div");c.className="absolute left-full top-0 bg-white border border-gray-500 shadow-lg hidden min-w-32",c.style.zIndex=ve+101,s.forEach(({text:f,disabled:m,onclick:u})=>{const p=document.createElement("div");p.textContent=f,p.className=`px-4 py-2 ${m?"text-gray-400":"hover:bg-gray-50 cursor-pointer"}`,!m&&u&&p.addEventListener("click",d=>{ye(),u(d)}),c.appendChild(p)}),a.appendChild(c);let l;a.addEventListener("mouseenter",()=>{clearTimeout(l),c.classList.remove("hidden")}),a.addEventListener("mouseleave",()=>{l=setTimeout(()=>{c.classList.add("hidden")},200)}),a.addEventListener("touchstart",f=>{f.preventDefault(),c.classList.contains("hidden")?c.classList.remove("hidden"):c.classList.add("hidden")}),c.addEventListener("mouseenter",()=>{clearTimeout(l)}),c.addEventListener("mouseleave",()=>{l=setTimeout(()=>{c.classList.add("hidden")},200)})};if(n){n.classList.add("right-click-target");const a=n.getAttribute("data-is-vendor-application")==="true",s=n.getAttribute("data-item-id")==="compostbin",c=n.getAttribute("data-item-id");let l=!1;if(c&&!s){const f=V();if(f&&f.folders){const m=n.closest(".file-explorer-window");let u=t;m&&(u=m.getAttribute("data-current-path"));const p=f.folders[u];p&&p[c]&&(l=p[c].type==="folder")}}s?r("Empty Compost Bin",!1,f=>{f.stopPropagation(),ye(),typeof emptyCompostBin=="function"&&emptyCompostBin()}):(l&&r("Open in new window",!1,f=>{f.stopPropagation(),ye();const m=document.querySelector(".right-click-target");if(m){const u=m.getAttribute("data-item-id");u&&qe(u)}m.classList.remove("right-click-target")}),r("Edit Name",a,f=>qi(f)),r("Delete",a,f=>_i(f)),r("New Folder",!0),r("New File",!0),r("New Shortcut",!0))}else{r("New Folder",!1,s=>$o(s,t));const a=r("New File",!1,null,!0);i(a,[{text:"LetterPad",disabled:!1,onclick:async s=>await Ui(s,t)},{text:"Image",disabled:!1,onclick:s=>Ki(s,t)},{text:"Audio",disabled:!1,onclick:s=>Yi(s,t)},{text:"Video",disabled:!1,onclick:s=>Gi(s,t)}]),r("New Shortcut",!1,s=>Hi(s,t))}o.style.top=`${e.clientY}px`,o.style.left=`${e.clientX}px`,o.classList.remove("hidden")}function ye(){document.getElementById("context-menu").classList.add("hidden")}function qi(e,n){e.stopPropagation(),ye();const t=document.querySelector(".right-click-target");if(t.classList.remove("right-click-target"),!t){K("No item selected.","error");return}const o=t.getAttribute("data-item-id"),r=t.closest(".file-explorer-window");let i;r?i=r.getAttribute("data-current-path"):i=t.getAttribute("data-current-path");let a=V();if(!a||!a.folders){console.error("File system state not properly initialized:",a),K("File system not initialized. Please refresh the page.","error");return}let s={};const c=i.length===4;if(s=a.folders[i],!s){console.error("Folder contents not found for path:",i),K("Folder contents not found.","error");return}if(!(o in s)){K("Item not found.","error");return}let l=s[o];if(!l){K("Item not found in file system.","error");return}const f=`window-${Date.now()}`,u=Z("Edit Item Name","",!1,f,!1,!1,{type:"integer",width:300,height:150},"Default").querySelector(".p-2");u.classList.add("p-4");const p=document.createElement("form");p.id="edit-name-form",p.className="flex flex-col space-y-4",u.appendChild(p);const d=document.createElement("input");d.type="text",d.name="newName",d.required=!0,d.value=l.name,d.id="rename-input",d.setAttribute("aria-label","Enter new file or folder name"),d.setAttribute("title","Type the new name for this item"),d.className="mt-1 block w-full border border-gray-300 rounded p-2",p.appendChild(vt("New Name",d));const g=document.createElement("div");g.className="flex justify-end space-x-2",p.appendChild(g);const v=Q("Cancel"),x=Q("Submit");v.id="cancel-edit-button",x.id="submit-edit-button",g.append(v,x),v.addEventListener("click",()=>ie(f)),x.addEventListener("click",()=>Fe("submit-edit-button","Editing..."));const F=document.getElementById("edit-name-form");F.addEventListener("submit",function(R){R.preventDefault();const W=F.newName.value.trim();if(W&&W!==l.name){if(l.type==="folder"&&l.fullPath){let N=function(h,k){if(a.folders[h]){a.folders[k]=a.folders[h],delete a.folders[h];for(const C in a.folders[k]){const E=a.folders[k][C];if(E.type==="folder"&&E.fullPath&&E.fullPath.startsWith(h)){const z=E.fullPath,X=E.fullPath.replace(h,k);E.fullPath=X,a.folders[z]&&N(z,X)}}}};var P=N;const j=/^[A-Z]:\/\/$/;let H;j.test(i)?H=i+W:H=i+"/"+W;const $=l.fullPath;l.fullPath=H,N($,H)}l.name=W,i==="C://Desktop"?typeof ae=="function"?ae():console.error("renderDesktopIcons function not available"):typeof fe=="function"?fe(i):console.error("refreshAllExplorerWindows function not available"),setFileSystemState(a),_().catch(j=>{console.error("Failed to save state after renaming:",j)}),setTimeout(()=>{i==="C://Desktop"&&typeof ae=="function"?ae():typeof fe=="function"&&fe(i)},100)}ie(f)}),document.getElementById("cancel-edit-button").addEventListener("click",function(){ie(f)})}function _i(e){e.stopPropagation(),ye();const n=document.querySelector(".right-click-target");if(n&&n.classList.remove("right-click-target"),!n){K("No file selected.","error");return}const t=n.getAttribute("data-item-id"),o=n.closest(".file-explorer-window"),r=o?o.getAttribute("data-current-path"):n.getAttribute("data-current-path"),i=V();if(!i||!i.folders){console.error("File system state not properly initialized:",i),K("File system not initialized. Please refresh the page.","error");return}let a=i.folders[r];if(!a){console.error("Folder contents not found for path:",r),console.error("Available folders:",Object.keys(i.folders)),K("Folder not found in file system.","error");return}if(!(t in a)){console.error("Item not found in folder:",t,"at path:",r),console.error("Available items:",Object.keys(a)),K("Item not found.","error");return}const s=`window-${Date.now()}`,l=Z("Delete File?","",!1,s,!1,!1,{type:"integer",width:320,height:140},"Default").querySelector(".p-2");l.classList.add("p-4","flex","flex-col","justify-between","h-full");const f=document.createElement("p");f.textContent="Are you sure you want to delete this file?",l.appendChild(f);const m=document.createElement("div");m.className="flex justify-end space-x-2",l.appendChild(m);const u=Q("Cancel"),p=Q("Delete");m.append(u,p),u.addEventListener("click",()=>ie(s)),p.addEventListener("click",async()=>{const d=a[t],g=d&&d.content_type&&["mp3","wav","ogg","audio"].includes(d.content_type),v=r==="C://Media";if(r==="C://Desktop"){const x="icon-"+t;desktopIconsState[x]&&delete desktopIconsState[x]}delete a[t],i.folders[r]=a,await _o(i),fe(r),r==="C://Desktop"&&ae(),g&&v&&typeof window.refreshMediaPlayerPlaylist=="function"&&setTimeout(()=>{window.refreshMediaPlayerPlaylist()},100),ie(s)})}function $o(e,n){e.stopPropagation(),ye();const t=n||"C://";Vt("Enter the name for the new folder:","New Folder",async o=>{(!o||!o.trim())&&(o="Untitled"),o=o.trim();let r=V();if(!r||!r.folders){console.error("File system state not properly initialized:",r),K("File system not initialized. Please refresh the page.","error");return}const i="folder-"+Date.now(),a=/^[A-Z]:\/\/$/;let s=a.test(t)?t+o:t+"/"+o;const c={id:i,name:o,type:"folder",fullPath:s,contents:{}};let l;a.test(n)?(l=r.folders[n],l||(r.folders[n]={},l=r.folders[n])):n==="C://Desktop"?(r.folders["C://Desktop"]||(r.folders["C://Desktop"]={}),l=r.folders["C://Desktop"]):(l=r.folders[n],l||(console.warn("Parent folder contents not found, creating:",n),r.folders[n]={},l=r.folders[n])),l[i]=c,r.folders[s]={},await setFileSystemState(r);try{await _(),n==="C://Desktop"?typeof ae=="function"&&ae():typeof fe=="function"&&fe(t)}catch(f){console.error("Failed to save state after creating folder:",f)}},()=>{})}function ji(e,n,t=null){e&&e.stopPropagation(),ye();const o=n||"C://",r=`window-${Date.now()}`,a=Z("New File","",!1,r,!1,!1,{type:"integer",width:300,height:150},"Default").querySelector(".p-2");a.classList.add("p-4");const s=document.createElement("form");s.id="create-file-form",s.className="flex flex-col space-y-4",a.appendChild(s);const c=document.createElement("input");c.type="text",c.name="fileName",c.required=!0,c.value="New File.rtf",c.id="create-file-name",c.setAttribute("aria-label","Enter file name"),c.setAttribute("title","Enter the name for the new file"),c.className="mt-1 block w-full border border-gray-300 rounded p-2",s.appendChild(vt("File Name",c));const l=document.createElement("div");l.className="flex justify-end space-x-2",s.appendChild(l);const f=Q("Cancel");f.id="cancel-file-button";const m=Q("Submit");m.id="submit-file-button",l.append(f,m),f.addEventListener("click",u=>{u.preventDefault(),Fe("cancel-file-button","Cancelling..."),setTimeout(()=>ie(r),100)}),s.addEventListener("submit",u=>{u.preventDefault(),Fe("submit-file-button","Submitting..."),setTimeout(()=>ie(r),100);const p=c.value.trim()||"Untitled",d={id:`file-${Date.now()}`,name:p,type:"ugc-file",content:"",content_type:"markdown",icon_url:"image/doc.webp",description:""};Ft(d,o)&&(n==="C://Desktop"?ae():fe(o),_().catch(g=>{console.error("Failed to save state after creating file:",g)}),typeof t=="function"&&t(d.id,d))})}function Hi(e,n){e.stopPropagation(),ye();const t=`window-${Date.now()}`,r=Z("New Shortcut","",!1,t,!1,!1,{type:"integer",width:300,height:200},"Default").querySelector(".p-2");r.classList.add("p-4");const i=document.createElement("form");i.id="create-shortcut-form",i.className="flex flex-col space-y-4",r.appendChild(i);const a=document.createElement("input");a.type="text",a.name="shortcutName",a.placeholder="Example Website",a.id="shortcut-name",a.setAttribute("aria-label","Enter shortcut name"),a.setAttribute("title","Enter a display name for the shortcut"),a.className="mt-1 block w-full border border-gray-300 rounded p-2",i.appendChild(vt("Shortcut Name",a));const s=document.createElement("input");s.type="url",s.name="shortcutURL",s.required=!0,s.placeholder="https://example.com",s.id="shortcut-url",s.setAttribute("aria-label","Enter website URL"),s.setAttribute("title","Enter the full URL of the website"),s.className="mt-1 block w-full border border-gray-300 rounded p-2",i.appendChild(vt("Shortcut URL",s));const c=document.createElement("div");c.className="flex justify-end space-x-2";const l=Q("Cancel");l.id="cancel-shortcut-button";const f=Q("Submit");f.id="submit-shortcut-button",c.append(l,f),i.appendChild(c),l.addEventListener("click",()=>{e.preventDefault(),Fe("cancel-shortcut-button","Cancelling..."),setTimeout(()=>ie(t),100)}),i.addEventListener("submit",async m=>{m.preventDefault(),Fe("submit-shortcut-button","Submitting..."),setTimeout(()=>ie(t),100);const u=s.value.trim();if(!u)return;const p=a.value.trim()||u.replace(u.substring(15),"…"),d=`shortcut-${Date.now()}`;let g="https://www.google.com/s2/favicons?sz=64&domain=";try{g+=new URL(u).hostname}catch{g="image/doc.webp"}const v={id:d,name:p,type:"shortcut",url:u,icon_url:g,description:"",fullPath:n==="C://Desktop"?`C://Desktop/${p}`:`${n}/${p}`};if(!await Ft(v,n)){console.error("Failed to save shortcut to filesystem");return}n==="C://Desktop"?setTimeout(async()=>{await ae()},100):ze(),be();try{await _()}catch(F){console.error("Failed to save state after creating shortcut:",F)}})}async function Ui(e,n,t=null){e&&e.stopPropagation(),ye();const o=n||"C://";Vt("Enter the name for the new LetterPad document:","New LetterPad.md",async r=>{(!r||!r.trim())&&(r="New LetterPad.md"),r=r.trim(),r.endsWith(".md")||(r=r+".md");const i=`file-${Date.now()}`,a="",s={id:i,name:r,type:"ugc-file",content:a,content_type:"markdown",icon_url:"image/doc.webp"};if(await Ft(s,o)){try{await _()}catch(c){console.error("Failed to save state after creating LetterPad:",c)}n==="C://Desktop"?ae():fe(o),Z(r,`<div class="letterpad_editor min-h-48 h-full w-full" data-letterpad-editor-id="${i}"></div>`,!1,i,!1,!1,{type:"integer",width:600,height:500},"editor"),setTimeout(()=>{const c=`letterpad_${i}`;M.setItemSync(c,{content:a});const l=document.querySelector(`[data-letterpad-editor-id="${i}"]`);l&&typeof Oe=="function"&&Oe(l)},100),typeof t=="function"&&t(s.id,s)}},()=>{})}function Ki(e,n,t=null){e&&e.stopPropagation(),ye();const o=n||"C://",r=document.createElement("input");r.type="file",r.accept="image/*",r.setAttribute("aria-label","Select image file to upload"),r.setAttribute("title","Choose an image file from your computer"),r.style.display="none",r.addEventListener("change",async i=>{const a=i.target.files[0];if(a){const c=a.size/1048576;if(c>25){K(`Image file "${a.name}" is too large (${c.toFixed(2)}MB). Maximum allowed size is 25MB.`,"error"),document.body.removeChild(r);return}const l=a.name.split(".").pop().toLowerCase(),f=await cn(a.name,o,l,a);f&&typeof t=="function"&&t(f.id,f),n==="C://Desktop"?typeof ae=="function"&&ae():typeof fe=="function"&&fe(o)}document.body.removeChild(r)}),document.body.appendChild(r),r.click()}function Yi(e,n,t=null){e&&e.stopPropagation(),ye();const o=n||"C://",r=document.createElement("input");r.type="file",r.accept="audio/*",r.style.display="none",r.setAttribute("aria-label","Select audio file to upload"),r.setAttribute("title","Choose an audio file from your computer"),r.addEventListener("change",async i=>{const a=i.target.files[0];if(a){const c=a.size/1048576;if(c>50){K(`Audio file "${a.name}" is too large (${c.toFixed(2)}MB). Maximum allowed size is 50MB.`,"error"),document.body.removeChild(r);return}const l=a.name.split(".").pop().toLowerCase(),f=await cn(a.name,o,l,a);f&&typeof t=="function"&&t(f.id,f),n==="C://Desktop"?typeof ae=="function"&&ae():typeof fe=="function"&&fe(o)}document.body.removeChild(r)}),document.body.appendChild(r),r.click()}function Gi(e,n,t=null){e&&e.stopPropagation(),ye();const o=n||"C://",r=document.createElement("input");r.type="file",r.accept="video/*",r.style.display="none",r.setAttribute("aria-label","Select video file to upload"),r.setAttribute("title","Choose a video file from your computer"),r.addEventListener("change",async i=>{const a=i.target.files[0];if(a){const c=a.size/1048576;if(c>100){K(`Video file "${a.name}" is too large (${c.toFixed(2)}MB). Maximum allowed size is 100MB.`,"error"),document.body.removeChild(r);return}const l=a.name.split(".").pop().toLowerCase(),f=await cn(a.name,o,l,a);f&&typeof t=="function"&&t(f.id,f),n==="C://Desktop"?typeof ae=="function"&&ae():typeof fe=="function"&&fe(o)}document.body.removeChild(r)}),document.body.appendChild(r),r.click()}function vt(e,n){const t=document.createElement("div"),o=document.createElement("label");return o.className="block text-sm font-medium text-gray-700",o.textContent=e,t.append(o,n),t}function fe(e){const n=document.querySelectorAll(".file-explorer-window");let t=0;n.forEach((o,r)=>{if(o.getAttribute("data-current-path")===e)try{const a=Ne(e),s=document.createElement("div");s.innerHTML=a;const c=s.querySelector(".file-explorer-window");if(c){o.innerHTML=c.innerHTML,o.setAttribute("data-current-path",e);const l=o.closest(".window");l&&l.id&&Pe(l.id,a),t++}else console.warn(`Failed to get new explorer content for window ${r}`)}catch(a){console.error(`Error refreshing window ${r}:`,a)}}),setTimeout(()=>{typeof be=="function"&&be()},50)}window.refreshAllExplorerWindows=fe;async function Ft(e,n){const t=V();if(!t||!t.folders)return console.error("File system state not properly initialized:",t),K("File system not initialized. Please refresh the page.","error"),!1;let o=t.folders[n];return o||(console.warn("Parent folder contents not found, creating:",n),t.folders[n]={},o=t.folders[n]),o[e.id]=e,await setFileSystemState(t),V().folders[n],!0}async function cn(e,n,t,o){const r=`file-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;let i="image/file.webp";["png","jpg","jpeg","gif","webp","avif"].includes(t)?i="image/image.webp":["mp4","webm","avi","mov"].includes(t)?i="image/video.webp":["mp3","wav","ogg"].includes(t)&&(i="image/audio.webp");const a={id:r,name:e,type:"ugc-file",content_type:t,icon_url:i,content:"",isLargeFile:!0,storageLocation:"indexeddb",file:null};if(!Ft(a,n))return null;if(o&&["png","jpg","jpeg","gif","webp","avif","mp3","wav","ogg","mp4","webm","avi","mov"].includes(t)){const s=URL.createObjectURL(o),c=V(),l=c.folders[n];l&&l[r]&&(l[r].tempObjectURL=s,l[r].file=o,setFileSystemState(c));try{const f=await new Promise((d,g)=>{const v=new FileReader;v.onload=x=>d(x.target.result),v.onerror=g,v.readAsDataURL(o)}),m=f.length*.75/(1024*1024);await M.setItem(`file_data_${r}`,f);const u=V(),p=u.folders[n];p&&p[r]&&(p[r].isLargeFile=!0,p[r].storageLocation="indexeddb",p[r].content="",p[r].fileSizeInMB=m,p[r].actualSizeInMB=m,p[r].dataURL=f,p[r].file=null),setFileSystemState(u),await _(),n==="C://Media"&&["mp3","wav","ogg","mp4","webm","avi","mov"].includes(t)&&typeof window.refreshMediaPlayerPlaylist=="function"&&setTimeout(()=>{window.refreshMediaPlayerPlaylist()},200)}catch(f){console.error("Failed to store binary file:",f);const m=V(),u=m.folders[n];u&&u[r]&&(u[r].isLargeFile=!0,u[r].storageLocation="failed",setFileSystemState(m)),K(`File "${e}" could not be stored. Storage error: ${f.message}`,"error")}}else await _();return a}async function Zi(){const e=window.location.href.includes("reddit.com");let n="1.0.0";try{n=(await(await fetch("./package.json")).json()).version||"1.0.0"}catch(o){console.warn("Could not fetch version from package.json:",o)}const t=`
    <div class="p-4 gap-y-2 flex flex-col">
      <img src="./image/startup.webp" class="w-48 h-auto mx-auto mb-4" alt="Nostalgia OS startup logo">
      <h1 class="text-xl font-bold mb-2">About This Computer</h1>
      <p>Made by multimedia artist Ian McKenzie.</p>
      <p>More shenanigans @ ${e?"relentlesscurious.com":'<a href="https://www.relentlesscurious.com" target="_blank">relentlesscurious.com</a>'}</p>
      <p>Version: ${n}</p>
      <p>Copyright © Ian Rand McKenzie, 2025</p>
      <p>This project must be purchased for use, but is open source and free for those who contribute via code, security research, bug reporting, etc. — contributors may do so on <a target="_blank" href="https://github.com/ianrandmckenzie/nostalgia_os">github.com/ianrandmckenzie/nostalgia_os</a></p>
    </div>
  `;Z("About This Computer",t,!1,null,!1,!1,{type:"integer",width:400,height:640},"default",null,"gray-200 cursor-not-allowed pointer-events-none")}const Po=`
<div class="max-w-4xl mx-auto text-black font-mono bg-gray-50 p-6 h-full overflow-auto">
  <h1 class="text-3xl font-bold text-black mb-6">Security Policy</h1>

  <div class="bg-gray-100 rounded-lg p-4 mb-6 border border-gray-700">
    <p class="text-lg text-black mb-4">
      At relentlessCurious, we take security seriously. This policy outlines our commitment to maintaining a secure environment for our users and provides guidelines for responsible disclosure of security vulnerabilities.
    </p>
  </div>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Reporting Security Vulnerabilities</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black mb-3">
        If you discover a security vulnerability in our systems, please report it responsibly by contacting our developer, Ian, at:
      </p>
      <div class="bg-gray-200 rounded p-3 border border-gray-600 mb-3">
        <p class="text-black font-mono">hey@relentlesscurious.com</p>
      </div>
      <p class="text-black mb-3">
        Please include the following information in your report:
      </p>
      <ul class="list-disc list-inside text-black space-y-1 ml-4">
        <li>Description of the vulnerability</li>
        <li>Steps to reproduce the issue</li>
        <li>Potential impact assessment</li>
        <li>Suggested remediation (if applicable)</li>
        <li>Your contact information for follow-up</li>
      </ul>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Response Timeline</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="bg-gray-200 rounded p-3 border border-gray-600">
          <h3 class="text-lg font-semibold text-black mb-2">Initial Response</h3>
          <p class="text-black">Within 48 hours of receiving your report</p>
        </div>
        <div class="bg-gray-200 rounded p-3 border border-gray-600">
          <h3 class="text-lg font-semibold text-black mb-2">Investigation</h3>
          <p class="text-black">Within 7 days for initial assessment</p>
        </div>
        <div class="bg-gray-200 rounded p-3 border border-gray-600">
          <h3 class="text-lg font-semibold text-black mb-2">Resolution</h3>
          <p class="text-black">Timeline varies based on severity</p>
        </div>
        <div class="bg-gray-200 rounded p-3 border border-gray-600">
          <h3 class="text-lg font-semibold text-black mb-2">Disclosure</h3>
          <p class="text-black">After fix is deployed and verified</p>
        </div>
      </div>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Scope</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <h3 class="text-lg font-semibold text-black mb-2">In Scope</h3>
      <ul class="list-disc list-inside text-black space-y-1 mb-3 ml-4">
        <li>relentlessCurious.com and all subdomains</li>
        <li>Web applications and APIs</li>
        <li>Smart contracts (when deployed)</li>
        <li>Infrastructure vulnerabilities</li>
        <li>Social engineering vulnerabilities</li>
      </ul>

      <h3 class="text-lg font-semibold text-black mb-2">Out of Scope</h3>
      <ul class="list-disc list-inside text-black space-y-1 ml-4">
        <li>Third-party services we don't control</li>
        <li>Social media accounts</li>
        <li>Physical security issues</li>
        <li>Denial of Service (DoS) attacks</li>
        <li>Spam or social engineering attacks</li>
      </ul>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Responsible Disclosure Guidelines</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black mb-3">We ask that security researchers:</p>
      <ul class="list-disc list-inside text-black space-y-1 ml-4">
        <li>Allow us reasonable time to investigate and address the issue before public disclosure</li>
        <li>Avoid accessing, modifying, or deleting user data</li>
        <li>Do not perform testing that could degrade or damage our systems</li>
        <li>Do not use social engineering, phishing, or physical attacks</li>
        <li>Make a good faith effort to avoid privacy violations and data destruction</li>
        <li>Contact us immediately if you inadvertently access sensitive data</li>
      </ul>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Security Measures</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black mb-3">Our security implementation includes:</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="space-y-2">
          <h3 class="text-lg font-semibold text-black">Web Security</h3>
          <ul class="list-disc list-inside text-black text-sm space-y-1 ml-4">
            <li>Content Security Policy (CSP)</li>
            <li>HTTP Strict Transport Security (HSTS)</li>
            <li>Input validation and sanitization</li>
          </ul>
        </div>
        <div class="space-y-2">
          <h3 class="text-lg font-semibold text-black">Data Protection</h3>
          <ul class="list-disc list-inside text-black text-sm space-y-1 ml-4">
            <li>Encryption in transit and at rest</li>
            <li>Regular security audits</li>
            <li>Access controls and monitoring</li>
            <li>Secure development practices</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Recognition</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black mb-3">
        We appreciate the security research community's efforts in keeping our platform secure. Researchers who responsibly disclose valid security vulnerabilities may be:
      </p>
      <ul class="list-disc list-inside text-black space-y-1 ml-4">
        <li>Acknowledged in our security advisory (with permission)</li>
        <li>Listed in our hall of fame</li>
        <li>Considered for our bug bounty program (when available)</li>
      </ul>
    </div>
  </section>

  <section class="mb-6">
    <h2 class="text-xl font-semibold text-black mb-3">Legal Safe Harbor</h2>
    <div class="bg-gray-100 rounded-lg p-4 border border-gray-700">
      <p class="text-black">
        relentlessCurious will not pursue legal action against security researchers who:
      </p>
      <ul class="list-disc list-inside text-black space-y-1 mt-3 ml-4">
        <li>Follow our responsible disclosure policy</li>
        <li>Report vulnerabilities in good faith</li>
        <li>Do not violate any applicable laws</li>
        <li>Do not access, modify, or delete user data</li>
        <li>Do not disrupt our services</li>
      </ul>
    </div>
  </section>

  <footer class="mt-8 pt-6 border-t border-gray-700">
    <div class="text-center">
      <p class="text-black text-sm">
        Last updated: July 15, 2025
      </p>
      <p class="text-black text-sm mt-2">
        This policy is subject to change. Check back regularly for updates.
      </p>
    </div>
  </footer>
</div>
`,Vi={"/security-policy":{title:"Security Policy",content:Po,icon:"image/info.webp"}};function Xi(){At("Security Policy",Po,{type:"integer",width:800,height:600},"default")}function dn(e){const n=Vi[e];return n?(At(n.title,n.content,{type:"integer",width:800,height:600},"default"),!0):!1}function zo(){const e=window.location.pathname;e==="/security-policy"&&setTimeout(()=>{dn(e),window.history.replaceState({},"","/")},500)}window.addEventListener("popstate",function(e){const n=window.location.pathname;dn(n)||console.log("No route found for:",n)});const ut="1.0";async function Ji(){var n;await((n=M.ensureReady)==null?void 0:n.call(M))||Promise.resolve();let e=await M.getItem("version");if(e||await M.setItem("version",ut),e!==ut){const t=await M.getItem("explicitRestart");await M.removeItem("appState"),await M.removeItem("version"),await M.setItem("version",ut),t&&await M.setItem("explicitRestart",t)}}typeof window<"u"&&(window.version=ut,window.highestZ=ve,window.activeMediaWindow=Ue,window.windowStates=G,window.desktopIconsState=ne,window.navWindows=xe,window.desktopSettings=le,window.startMenuOrder=Y,window.fileFolderMapping=Eo,window.createWindow=Z,window.minimizeWindow=He,window.bringToFront=Ie,window.closeWindow=ie,window.toggleFullScreen=on,window.showDialogBox=K,window.getAppIcon=nn,window.renderDesktopIcons=ae,window.makeIconDraggable=Et,window.toggleStartMenu=tt,window.minimizeAllWindows=Mt,window.openNav=At,window.updateClock=Dt,window.toggleMediaPlayback=Bt,window.updateMediaControl=ln,window.getActiveMediaElement=Tt,window.openApp=ct,window.openExplorer=Qe,window.openExplorerInNewWindow=qe,window.refreshExplorerViews=ze,window.getExplorerWindowContent=Ne,window.getBreadcrumbsHtml=Dn,window.openFile=Ve,window.normalizePath=st,window.getFolderIdByFullPath=Uo,window.findFolderObjectByFullPath=An,window.findFolderFullPathById=xt,window.showContextMenu=Fo,window.hideContextMenu=ye,window.createNewFolder=$o,window.createNewFile=ji,window.refreshAllExplorerWindows=fe,window.saveFileExplorerState=_e,window.handleWatercolourImageSelection=Ko,window.launchCompostBin=$n,window.loadCompostBinContents=kt,window.emptyCompostBin=zn,window.launchStorageManager=vo,window.refreshStorageData=et,window.fullSystemRestart=So,window.openCleanupWindow=xo,window.makeWin95Dropdown=ni,window.openAboutWindow=Zi,window.launchCalculator=Un,window.initializeCalculatorUI=Kn,window.launchSolitaire=Yn,window.initializeSolitaireUI=Gn,window.launchChess=Zn,window.initializeChessUI=Vn,window.launchBombbroomer=io,window.initializeBombbroomerUI=ao,window.initializeLetterPad=Oe,window.initializeAllLetterPadEditors=To,window.applyFormatting=Yt,window.convertMarkdownToHTML=Gt,window.launchMailbox=Wn,window.launchWatercolour=qn,window.initializeWatercolourUI=_n,window.getWatercolourHTML=jn,window.initializeWatercolour=Hn,window.launchTubeStream=Rn,window.loadPrimaryStream=On,window.launchMediaPlayer=so,window.initializeMediaPlayerUI=lo,window.restoreMediaPlayerSession=co,window.saveMediaPlayerState=Te,window.loadMediaPlayerState=Jt,window.clearMediaPlayerState=kr,window.initializeRouter=zo,window.handleRoute=dn,window.openSecurityPolicy=Xi,window.restart=yt,window.logout=wo,window.storage=M);document.getElementById("desktop").addEventListener("click",function(e){e.target.closest(".draggable-icon")||document.querySelectorAll(".draggable-icon").forEach(n=>n.classList.remove("bg-gray-50"))});function Qi(){const e=document.getElementById("media-control");e&&e.addEventListener("keydown",function(o){(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),Bt())});const n=document.getElementById("start-button");n&&n.addEventListener("keydown",function(o){(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),tt())});const t=document.getElementById("min-all-btn");t&&t.addEventListener("keydown",function(o){(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),Mt())}),document.addEventListener("keydown",function(o){if(o.key==="Escape"){const r=document.getElementById("start-menu"),i=document.getElementById("context-menu");if(r&&!r.classList.contains("hidden")){document.getElementById("start-button").setAttribute("aria-expanded","false"),r.classList.add("hidden"),r.setAttribute("aria-hidden","true");const{toggleButtonActiveState:s}=window;s&&s("start-button")}i&&!i.classList.contains("hidden")&&(i.classList.add("hidden"),i.setAttribute("aria-hidden","true"))}})}window.addEventListener("click",async function(e){const n=document.getElementById("start-menu"),t=document.getElementById("start-button");if(!n.contains(e.target)&&!t.contains(e.target)){if(!n.classList.contains("hidden")){const{toggleButtonActiveState:o}=await Wt(async()=>{const{toggleButtonActiveState:r}=await Promise.resolve().then(()=>Fn);return{toggleButtonActiveState:r}},void 0);o("start-button")}n.classList.add("hidden"),n.setAttribute("aria-hidden","true"),t.setAttribute("aria-expanded","false")}});window.addEventListener("load",async function(){await Ji();const{toggleButtonActiveState:e,makeWin95Button:n,makeWin95Prompt:t,openFileExplorerForImageSelection:o}=await Wt(async()=>{const{toggleButtonActiveState:a,makeWin95Button:s,makeWin95Prompt:c,openFileExplorerForImageSelection:l}=await Promise.resolve().then(()=>Fn);return{toggleButtonActiveState:a,makeWin95Button:s,makeWin95Prompt:c,openFileExplorerForImageSelection:l}},void 0);window.toggleButtonActiveState=e,window.makeWin95Button=n,window.makeWin95Prompt=t,window.openFileExplorerForImageSelection=o;const r=await M.getItem("appState"),i=await M.getItem("explicitRestart");if((!r||i)&&(It(),i&&await M.removeItem("explicitRestart")),await jt(),await mi(),await ae(),await Ei(),typeof wt=="function"){wt();const{updateStartMenuFocusability:a}=await Wt(async()=>{const{updateStartMenuFocusability:c}=await Promise.resolve().then(()=>Oi);return{updateStartMenuFocusability:c}},void 0);window.updateStartMenuFocusability=a;const s=document.getElementById("start-menu");s&&s.classList.contains("hidden")&&a(!1)}else console.error("initializeStartMenu function not available");zo(),Qi(),document.querySelectorAll(".draggable-icon").forEach(a=>Et(a))});document.addEventListener("keydown",function(e){if(e.altKey)switch(e.key){case"Tab":e.preventDefault(),Kr();break;case"F4":e.preventDefault(),Cn();break}if(e.key==="Escape"&&gt(),e.key==="Enter"&&document.getElementById("window-cycle-popup")&&!document.getElementById("window-cycle-popup").classList.contains("hidden")&&(e.preventDefault(),gt()),e.ctrlKey||e.metaKey)switch(e.key){case"w":e.preventDefault(),Cn();break;case"m":e.preventDefault(),Gr();break}});document.addEventListener("keyup",function(e){if(e.key==="Alt"){const n=document.getElementById("window-cycle-popup");n&&!n.classList.contains("hidden")&&gt()}});Wi();
