(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(r){if(r.ep)return;r.ep=!0;const i=t(r);fetch(r.href,i)}})();const hn="modulepreload",bn=function(e){return"/"+e},Ht={},so=function(o,t,n){let r=Promise.resolve();if(t&&t.length>0){let a=function(d){return Promise.all(d.map(f=>Promise.resolve(f).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),l=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));r=a(t.map(d=>{if(d=bn(d),d in Ht)return;Ht[d]=!0;const f=d.endsWith(".css"),m=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${m}`))return;const u=document.createElement("link");if(u.rel=f?"stylesheet":hn,f||(u.as="script"),u.crossOrigin="",u.href=d,l&&u.setAttribute("nonce",l),document.head.appendChild(u),f)return new Promise((p,c)=>{u.addEventListener("load",p),u.addEventListener("error",()=>c(new Error(`Unable to preload CSS for ${d}`)))})}))}function i(a){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=a,window.dispatchEvent(s),!s.defaultPrevented)throw a}return r.then(a=>{for(const s of a||[])s.status==="rejected"&&i(s.reason);return o().catch(i)})};class wn{constructor(o="NostalgiaOS",t=1){this.dbName=o,this.version=t,this.db=null,this.cache=new Map,this.initPromise=this.init()}async init(){return new Promise((o,t)=>{const n=indexedDB.open(this.dbName,this.version);n.onerror=()=>{console.error("IndexedDB error:",n.error),t(n.error)},n.onsuccess=async()=>{this.db=n.result,await this.populateCache(),o(this.db)},n.onupgradeneeded=r=>{const i=r.target.result;i.objectStoreNames.contains("storage")||i.createObjectStore("storage",{keyPath:"key"})}})}async populateCache(){try{if(!this.db)return;const t=this.db.transaction(["storage"],"readonly").objectStore("storage");return new Promise((n,r)=>{const i=t.getAll();i.onsuccess=()=>{i.result.forEach(s=>{this.cache.set(s.key,s.value)}),n()},i.onerror=()=>{console.warn("Failed to populate cache:",i.error),r(i.error)}})}catch(o){console.warn("Failed to populate cache:",o)}}async ensureDB(){return this.db||await this.initPromise,this.db}async setItem(o,t){const i=(await this.ensureDB()).transaction(["storage"],"readwrite").objectStore("storage"),a={key:o,value:t,timestamp:Date.now()};return this.cache.set(o,t),new Promise((s,l)=>{const d=i.put(a);d.onsuccess=()=>s(),d.onerror=()=>l(d.error)})}async getItem(o){const r=(await this.ensureDB()).transaction(["storage"],"readonly").objectStore("storage");return new Promise((i,a)=>{const s=r.get(o);s.onsuccess=()=>{const l=s.result;let d=l?l.value:null;this.cache.set(o,d),i(d)},s.onerror=()=>a(s.error)})}async removeItem(o){const r=(await this.ensureDB()).transaction(["storage"],"readwrite").objectStore("storage");return this.cache.delete(o),new Promise((i,a)=>{const s=r.delete(o);s.onsuccess=()=>i(),s.onerror=()=>a(s.error)})}async clear(){const n=(await this.ensureDB()).transaction(["storage"],"readwrite").objectStore("storage");return this.cache.clear(),new Promise((r,i)=>{const a=n.clear();a.onsuccess=()=>r(),a.onerror=()=>i(a.error)})}async getAllKeys(){const n=(await this.ensureDB()).transaction(["storage"],"readonly").objectStore("storage");return new Promise((r,i)=>{const a=n.getAllKeys();a.onsuccess=()=>r(a.result),a.onerror=()=>i(a.error)})}setItemSync(o,t){this.cache.set(o,t),this.setItemWithRetry(o,t,3).catch(n=>{console.warn("Failed to save to IndexedDB after retries:",n)})}async setItemWithRetry(o,t,n=3){let r;for(let i=0;i<n;i++)try{await this.setItem(o,t);return}catch(a){r=a,console.warn(`setItem retry ${i+1}/${n} failed:`,a),i<n-1&&await new Promise(s=>setTimeout(s,Math.pow(2,i)*100))}throw r}getItemSync(o){return this.cache.has(o)?this.cache.get(o):(this.getItem(o).catch(console.warn),null)}removeItemSync(o){this.cache.delete(o),this.removeItem(o).catch(console.error)}clearSync(){this.cache.clear(),this.clear().catch(console.error)}}const ge=new wn,E={async ensureReady(){return await ge.ensureDB(),ge.cache.size===0&&await ge.populateCache(),ge.db},async setItem(e,o){return await ge.setItem(e,o)},async getItem(e){return await ge.getItem(e)},async removeItem(e){return await ge.removeItem(e)},async clear(){return await ge.clear()},async getAllKeys(){return await ge.getAllKeys()},async preloadKeys(e){for(const o of e)try{await this.getItem(o)}catch(t){console.warn(`Failed to preload key ${o}:`,t)}},setItemSync(e,o){return ge.setItemSync(e,o)},getItemSync(e){return ge.getItemSync(e)},removeItemSync(e){return ge.removeItemSync(e)},clearSync(){return ge.clearSync()}};typeof window<"u"&&(window.globalStorage=E,window.storage=E);async function vn(e){console.log("=== setFileSystemState called ==="),console.log("Saving filesystem with paths:",Object.keys(e.folders||{})),e.folders&&Object.keys(e.folders).forEach(o=>{const t=e.folders[o];if(t&&typeof t=="object"){const n=Object.keys(t).filter(r=>{const i=t[r];return i&&i.type==="shortcut"});n.length>0&&console.log(`Saving ${n.length} shortcuts in ${o}:`,n.map(r=>({id:r,name:t[r].name,url:t[r].url})))}});try{const o=await E.getItem("appState")||{};o.fileSystemState=e,await E.setItem("appState",o),fileSystemState=e,console.log("Filesystem state saved to IndexedDB successfully")}catch(o){console.warn("Failed to set file system state in IndexedDB:",o);try{const t=E.getItemSync("appState")||{};t.fileSystemState=e,E.setItemSync("appState",t),fileSystemState=e,console.log("Filesystem state saved using sync fallback")}catch(t){console.error("Failed to set file system state with fallback:",t)}}console.log("=== setFileSystemState complete ===")}function Y(){console.log("=== getFileSystemStateSync called ===");try{const e=E.getItemSync("appState");if(console.log("Loaded appState from storage:",!!e),e&&e.fileSystemState){const o=e.fileSystemState;return console.log("Filesystem from storage - available paths:",Object.keys(o.folders||{})),["C://","C://Desktop","C://Documents"].forEach(t=>{if(o.folders&&o.folders[t]){const n=Object.keys(o.folders[t]);console.log(`Path ${t} has ${n.length} items:`,n);const r=n.filter(i=>{const a=o.folders[t][i];return a&&a.type==="shortcut"});r.length>0&&console.log(`Found ${r.length} shortcuts in ${t}:`,r)}else console.log(`Path ${t} not found in filesystem`)}),console.log("=== getFileSystemStateSync returning stored state ==="),o}else console.log("No fileSystemState in appState, checking fallbacks")}catch(e){console.warn("Failed to get file system state sync:",e)}return typeof window<"u"&&window.fileSystemState?window.fileSystemState:typeof fileSystemState<"u"?fileSystemState:(console.error("No file system state available anywhere!"),{folders:{"C://":{},"A://":{},"D://":{}}})}function Mt(e){e=normalizePath(e);const o=Y();if(o.initialized!==!0&&En(),e.substring(1,4)==="://"&&e.length===4)return o.folders[e]||{};const t=o.folders[e]||{},n={};for(const[r,i]of Object.entries(t))r!=="contents"&&i&&typeof i=="object"&&i.type&&(n[r]=i);return n}const xn={files:[]};function En(){try{const e=Y();if(!e.folders||!e.folders["C://"]){console.warn("File system structure not properly initialized for sync document fetch");return}const o=xn.files.map(n=>{const r=n.url.split(".").pop().toLowerCase();let i="image/file.png";return["png","jpg","jpeg","gif"].includes(r)?i="image/image.png":["mp4","webm"].includes(r)?i="image/video.png":["mp3","wav"].includes(r)?i="image/audio.png":r==="html"?i="image/html.png":["md","txt"].includes(r)&&(i="image/doc.png"),{id:n.id,name:n.url,type:"file",content:"",fullPath:`C://Documents/${n.id}`,content_type:r,icon_url:i,url:n.url}});e.folders["C://Documents"]||(e.folders["C://Documents"]={});const t={};o.forEach(n=>{t[n.id]=n}),e.folders["C://Documents"]=t,e.initialized=!0;try{const n=E.getItemSync("appState")||{};n.fileSystemState=e,E.setItemSync("appState",n),fileSystemState=e}catch(n){console.warn("Failed to save file system state sync:",n),fileSystemState=e}}catch(e){console.error("Error loading documents sync:",e)}}document.addEventListener("dblclick",e=>{const o=e.target.closest("[data-open-file]");if(o){e.stopPropagation();const t=o.getAttribute("data-open-file");openFile(t,e)}});document.addEventListener("mobiledbltap",e=>{const o=e.target.closest("[data-open-file]");if(o){e.stopPropagation();const t=o.getAttribute("data-open-file");openFile(t,e)}});function Je(e){return/^[A-Z]:\/\/$/.test(e)?e:e.replace(/\/+$/,"")}function Sn(e){if(/^[A-Z]:\/\/$/.test(e))return e;const o=Y();function t(n){for(const r in n){const i=n[r];if(i.type==="folder"){if(i.fullPath===e)return r;const a=o.folders[i.fullPath]||{},s=t(a);if(s)return s}}return null}for(const n in o.folders)if(/^[A-Z]:\/\/$/.test(n)){const r=t(o.folders[n]);if(r)return r}return null}function lo(e,o=null){e=Je(e);const t=o||Y();if(/^[A-Z]:\/\/$/.test(e))return{id:e,name:e,fullPath:e,contents:t.folders[e]};function n(){for(const r in t.folders)if(/^[A-Z]:\/\/$/.test(r))for(const i in t.folders[r]){const a=t.folders[r][i];if(a.type==="folder"&&Je(a.fullPath)===e)return a}else for(const i in t.folders[r]){const a=t.folders[r][i];if(a.type==="folder"&&Je(a.fullPath)===e)return a}return null}return n()}function st(e,o=!1){if(/^[A-Z]:\/\/$/.test(e))return e;const t=Y();function n(r,i=null){for(const a in r){const s=r[a];if(s.type==="folder"||o===!0){if(a===e)return s.fullPath;if(s.type==="folder"&&s.fullPath&&t.folders[s.fullPath]){const l=n(t.folders[s.fullPath],s.fullPath);if(l)return l}}}return null}for(const r in t.folders)if(/^[A-Z]:\/\/$/.test(r)){const i=n(t.folders[r],r);if(i)return i}return null}function Ge(e,o=!1){let t;if(/^[A-Z]:\/\//.test(e)?t=e:t=st(e),!t){console.error("Folder not found for id/path:",e);return}const n=Ae(t);if(!o){let a=document.getElementById("explorer-window");if(a)return a.querySelector(".file-explorer-window").outerHTML=n,a.querySelector(".file-explorer-window").setAttribute("data-current-path",t),Fe(a.id,n),setTimeout(fe,100),setTimeout(async()=>{await Oe()},150),a}const r=o?`explorer-window-${Date.now()}`:"explorer-window",i=V(t,n,!1,r,!1,!1,{type:"integer",width:600,height:400},"Explorer");return setTimeout(async()=>{await Oe()},150),i}function Ue(e){const o=`openExplorer_${e}`,t=Date.now();if(window.explorerDebounce&&window.explorerDebounce[o]){const n=window.explorerDebounce[o];if(t-n<500)return}return window.explorerDebounce||(window.explorerDebounce={}),window.explorerDebounce[o]=t,setTimeout(()=>{window.explorerDebounce&&window.explorerDebounce[o]===t&&delete window.explorerDebounce[o]},1e3),Ge(e,!0)}window.openExplorerInNewWindow=Ue;function Te(){document.querySelectorAll(".file-explorer-window").forEach(e=>{const o=e.getAttribute("data-current-path"),t=Ae(o),n=e.parentElement;n.innerHTML=t}),fe()}function co(e){e=normalizePath(e);const o=e.match(/^([A-Z]:\/\/)(.*)/);if(!o)return e;const t=o[1],n=o[2];let r=`<span class="cursor-pointer hover:underline" data-path="${t}">${t}</span>`;if(!n)return r;let i=t;return n.split("/").filter(Boolean).forEach(a=>{i=i.endsWith("/")?i+a:`${i}/${a}`;const s=lo(i),l=s?s.name:a;r+=` / <span class="cursor-pointer hover:underline" data-path="${s?s.id:i}">${l}</span>`}),r}function Ae(e="C://"){e=normalizePath(e);const o=Mt(e),t=['<ul class="pl-5">'];Object.values(o).forEach(i=>{const a=i.type==="folder";let s=a?"image/folder.png":"image/file.png";i.icon?s=i.icon:i.icon_url&&(s=i.icon_url);const l="cursor-pointer hover:bg-gray-50 file-item truncate"+(a?" folder-item":""),d=i.description?` (${i.description})`:"";if(a)t.push(`<li class="${l}" data-item-id="${i.id}" data-open-folder="${i.id}" title="${i.name}"><img src="${s}" class="inline h-4 w-4 mr-2"> ${i.name}</li>`);else if(i.type==="shortcut")t.push(`<li class="${l}" data-item-id="${i.id}" data-open-shortcut="true" data-url="${i.url}" title="${i.name}${d}"><img src="${s}" class="inline h-4 w-4 mr-2"> ${i.name}${d}</li>`);else{const f=i.name||i.id||"Unknown File";i.name||console.warn("🔍 EXPLORER: File missing name property, using fallback:",f,"Item:",i),t.push(`<li class="${l}" data-item-id="${i.id}" data-open-file="${i.id}" title="${f}${d}"><img src="${s}" class="inline h-4 w-4 mr-2"> ${f}${d}</li>`)}}),t.push("</ul>");const n=["C://","A://","D://"].map(i=>`<li class="cursor-pointer border-b border-gray-200 hover:bg-gray-50 system-folder" data-open-drive="${i}"><img src="image/${i[0].toLowerCase()==="c"?"drive_c":i[0].toLowerCase()==="a"?"floppy":"cd"}.png" class="inline h-4 w-4 mr-2"> ${i}</li>`).join(""),r=co(e);return`
    <div class="file-explorer-window" data-current-path="${e}">
      <div class="flex">
        <!-- Left Sidebar -->
        <div id="file-sidebar" class="w-1/4 border-r p-2"><ul>${n}</ul></div>

        <!-- Main Content -->
        <div id="file-main" class="w-3/4 p-2 min-h-96">
          <div id="breadcrumbs" class="mb-2">Path: ${r}</div>
          <div id="files-area">
            ${t.join("")}
          </div>
        </div>
      </div>
    </div>
  `}document.addEventListener("click",e=>{const o=e.target.closest(".file-explorer-window");if(o&&o.getAttribute("data-image-selection-mode")==="true"){const t=e.target.closest("[data-open-file]");if(t){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const n=o.getAttribute("data-current-path"),r=Mt(n),i=Object.values(r).find(a=>a.id===t.dataset.openFile);if(i&&["png","jpg","jpeg","gif","webp","avif"].includes(i.content_type)){o.querySelectorAll("[data-open-file]").forEach(l=>{l.classList.remove("bg-blue-100","border-blue-300"),l.style.backgroundColor="",l.style.border=""}),t.classList.add("bg-blue-100","border-blue-300"),t.style.backgroundColor="#dbeafe",t.style.border="2px solid #93c5fd",t.style.borderRadius="4px";const s=document.getElementById("selected-image-name");if(s)if(s.textContent=`Selected: ${i.name}`,window.watercolourSelectedFile=i,typeof window.updateWatercolourImageSelectionButton=="function")window.updateWatercolourImageSelectionButton(!0);else{const l=document.getElementById("open-selected-image");l&&(l.disabled=!1)}else console.error("Selection UI elements not found",{selectedNameSpan:s})}else{const a=document.getElementById("selected-image-name");if(a)if(a.textContent="Please select an image file",typeof window.updateWatercolourImageSelectionButton=="function")window.updateWatercolourImageSelectionButton(!1);else{const s=document.getElementById("open-selected-image");s&&(s.disabled=!0)}}return}}},!0);document.addEventListener("dblclick",e=>{const o=e.target.closest("[data-open-folder],[data-open-file],[data-open-shortcut]");if(!o)return;const t=e.target.closest(".file-explorer-window");if(t&&t.getAttribute("data-image-selection-mode")==="true")return e.preventDefault(),e.stopPropagation(),!1;if(o.dataset.openFolder)if(t){const n=o.dataset.openFolder;let r;if(/^[A-Z]:\/\//.test(n)?r=n:r=st(n),r){const i=Ae(r);t.outerHTML=i;const a=t.closest(".window");a&&a.id&&Fe(a.id,i),setTimeout(fe,100),setTimeout(async()=>{await Oe()},150)}}else Ge(o.dataset.openFolder);else o.dataset.openFile?et(o.dataset.openFile,e):o.dataset.openShortcut&&bt(o)});document.addEventListener("click",e=>{const o=e.target.closest("[data-open-drive]");if(o){const t=o.closest(".file-explorer-window");if(t){const n=o.dataset.openDrive,r=Ae(n);t.outerHTML=r;const i=t.closest(".window");i&&i.id&&Fe(i.id,r),setTimeout(fe,100),setTimeout(async()=>{await Oe()},150)}else Ge(o.dataset.openDrive)}});document.addEventListener("click",e=>{const o=e.target.closest("[data-path]");if(o){e.stopPropagation();const t=o.closest(".file-explorer-window");if(t){let n=o.dataset.path;if(n&&!/^[A-Z]:\/\//.test(n)){const a=st(n);a&&(n=a)}const r=Ae(n);t.outerHTML=r;const i=t.closest(".window");i&&i.id&&Fe(i.id,r),setTimeout(fe,100),setTimeout(async()=>{await Oe()},150)}else Ge(o.dataset.path)}});function et(e,o){const t=document.getElementById(e);if(t){const p=[...document.querySelectorAll("*")].filter(c=>getComputedStyle(c).zIndex>100&&getComputedStyle(c).zIndex<1e3).reduce((c,h)=>getComputedStyle(h).zIndex>getComputedStyle(c).zIndex?h:c);t.style.zIndex=`${parseInt(p.style.zIndex)+1}`;return}let n;const r=o.target===document.body,i=o.target.closest(".file-explorer-window");let a;r?a="C://Documents":i?a=i.getAttribute("data-current-path"):o.srcElement.classList.contains("desktop-folder-icon")&&(a="C://Desktop");const s=Mt(a);if(n=Object.values(s).find(u=>u.id===e),!n||typeof n=="string"){const u=`File ${typeof n=="string"?`"${n}"`:""}`;j(`${u}not found.`,"error");return}let l="",d="default";n.type==="ugc-file"?n.content_type==="text"||n.content_type==="txt"?(l=`<div id="file-content" style="padding:10px;">
        <div id="text-editor" contenteditable="true" style="padding:10px; overflow:auto;">${n.content||n.contents||"Empty file"}</div>
      </div>`,d="editor",setTimeout(()=>{const u=document.getElementById("text-editor");u&&u.addEventListener("input",function(){Fe(n.id,this.innerHTML),n.content=this.innerHTML,O()})},100)):n.content_type==="markdown"||n.content_type==="md"?(l=`<div id="file-content" style="padding:10px;">
        <div class="letterpad_editor min-h-48 h-full w-full" data-letterpad-editor-id="${n.id}"></div>
      </div>`,d="editor",setTimeout(async()=>{const u=`letterpad_${n.id}`;let p=n.content||n.contents||"";try{const c=await E.getItem(u);c&&c.content!==void 0&&(p=c.content),await E.setItem(u,{content:p});const h=document.querySelector(`[data-letterpad-editor-id="${n.id}"]`);h&&typeof initializeLetterPad=="function"&&await initializeLetterPad(h)}catch(c){console.warn("Failed to initialize LetterPad editor:",c);try{const h=E.getItemSync(u);h&&h.content!==void 0&&(p=h.content),E.setItemSync(u,{content:p});const v=document.querySelector(`[data-letterpad-editor-id="${n.id}"]`);v&&typeof initializeLetterPad=="function"&&await initializeLetterPad(v)}catch(h){console.error("Failed to initialize LetterPad editor with fallback:",h)}}},100)):n.content_type==="html"?l=n.content||n.contents||'<p style="padding:10px;">Empty HTML file.</p>':["png","jpg","jpeg","gif","webp","avif"].includes(n.content_type)?n.dataURL?l=`<img src="${n.dataURL}" alt="${n.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:n.isLargeFile&&n.storageLocation==="indexeddb"?(l='<div style="padding:10px; text-align:center;">Loading image...</div>',d="image",setTimeout(async()=>{try{const u=await E.getItem(`file_data_${n.id}`);if(u){const p=`<img src="${u}" alt="${n.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`,c=document.getElementById(n.id);if(c){const h=c.querySelector(".p-2");h&&(h.innerHTML=p)}}else throw console.error("No image data found in IndexedDB for file:",n.id),new Error("Image data not found in storage")}catch(u){console.error("Error loading large image file:",u),console.error("File object details:",n);const p=document.getElementById(n.id);if(p){const c=p.querySelector(".p-2");c&&(c.innerHTML=`<p style="padding:10px;">Error loading image: ${u.message}</p>`)}}},100)):n.file&&n.file instanceof File?l=`<img src="${URL.createObjectURL(n.file)}" alt="${n.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:l=`<p style="padding:10px;">Image file not found or invalid.<br>Debug: isLargeFile=${n.isLargeFile}, storage=${n.storageLocation}</p>`:["mp3","wav","ogg"].includes(n.content_type)?n.dataURL?l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
              <source src="${n.dataURL}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:n.isLargeFile&&n.storageLocation==="indexeddb"?(l='<div style="padding:10px; text-align:center;">Loading audio...</div>',d="audio",setTimeout(async()=>{try{const u=await E.getItem(`file_data_${n.id}`);if(u){const p=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
                <source src="${u}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>`,c=document.getElementById(n.id);if(c){const h=c.querySelector(".p-2");h&&(h.innerHTML=p)}}else throw new Error("Audio data not found in IndexedDB")}catch(u){console.error("Error loading large audio file:",u);const p=document.getElementById(n.id);if(p){const c=p.querySelector(".p-2");c&&(c.innerHTML=`<p style="padding:10px;">Error loading audio: ${u.message}</p>`)}}},100)):n.file&&n.file instanceof File?l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
              <source src="${URL.createObjectURL(n.file)}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:n.tempObjectURL?l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;"
                     onerror="console.error('🔍 AUDIO: Audio element error:', event.target.error)">
              <source src="${n.tempObjectURL}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:n.isDefault||n.isSystemFile||n.path?l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
              <source src="${n.path||`media/${n.name}`}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:l='<p style="padding:10px;">Audio file not found or invalid.<br>Debug: Missing required properties for audio playback.</p>':["mp4","webm","avi","mov"].includes(n.content_type)?n.dataURL?l=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
            <source src="${n.dataURL}" type="video/mp4">
            Your browser does not support the video tag.
          </video>`:n.tempObjectURL?l=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;"
                     onerror="console.error('🔍 VIDEO: Video element error:', event.target.error)">
            <source src="${n.tempObjectURL}" type="video/mp4">
            Your browser does not support the video tag.
          </video>`:n.isLargeFile&&n.storageLocation==="indexeddb"?(l='<div style="padding:10px; text-align:center;">Loading video...</div>',d="video",setTimeout(async()=>{try{const u=await E.getItem(`file_data_${n.id}`);if(u){const p=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
                <source src="${u}" type="video/mp4">
                Your browser does not support the video tag.
              </video>`,c=document.getElementById(n.id);if(c){const h=c.querySelector(".p-2");h&&(h.innerHTML=p)}}}catch(u){console.error("Error loading large video file:",u);const p=document.getElementById(n.id);if(p){const c=p.querySelector(".p-2");c&&(c.innerHTML=`<p style="padding:10px;">Error loading video: ${u.message}</p>`)}}},100)):n.file&&n.file instanceof File?l=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
            <source src="${URL.createObjectURL(n.file)}" type="video/mp4">
            Your browser does not support the video tag.
          </video>`:l='<p style="padding:10px;">Video file not found or invalid.</p>':l=`<p style="padding:10px;">${n.content||n.contents||"Empty file"}</p>`:["image","jpg","jpeg","png","webp","avif","gif"].includes(n.content_type)?n.file?l=`<img src="${URL.createObjectURL(n.file)}" alt="${n.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:l=`<img src="./media/${n.name}" alt="${n.name}" class="mx-auto max-h-full max-w-full" style="padding:10px;">`:["video","mov","mp4","webm","avi"].includes(n.content_type)?l=`<video controls class="mx-auto max-h-full max-w-full" style="padding:10px;">
            <source src="./media/${n.name}" type="video/mp4">
            Your browser does not support the video tag.
          </video>`:["audio","mp3","ogg","wav"].includes(n.content_type)?n.file?l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
              <source src="${URL.createObjectURL(n.file)}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:n.isDefault||n.isSystemFile||n.path?l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
              <source src="${n.path||`media/${n.name}`}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:l=`<audio controls class="mx-auto" style="min-width:320px; min-height:60px; padding:10px;">
              <source src="./media/${n.name}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>`:n.content_type==="html"?(l=n.contents?n.contents:'<p style="padding:10px;">Loading HTML file...</p>',n.contents||fetch(`./media/${n.name}`).then(u=>u.text()).then(u=>{const p=document.getElementById(n.id),c=p?p.querySelector(".p-2"):null;c&&(c.innerHTML=u),n.contents=u,O()}).catch(u=>{console.error("Error loading HTML file:",u);const p=document.getElementById(n.id),c=p?p.querySelector(".p-2"):null;c&&(c.innerHTML="<p>Error loading HTML file.</p>")})):n.content_type==="text"||n.content_type==="txt"?(l='<div id="file-content" style="padding:10px;">Loading file...</div>',fetch(`./media/${n.name}`).then(u=>u.text()).then(u=>{const p=document.getElementById(n.id),c=p?p.querySelector(".p-2"):null;c&&(c.innerHTML=`<div id="text-editor" contenteditable="true" style="padding:10px; overflow:auto;">${u}</div>`,document.getElementById("text-editor").addEventListener("input",function(){Fe(n.id,this.innerHTML),n.type="ugc-file",n.content=this.innerHTML,O()})),n.content=u,O()}).catch(u=>{console.error("Error loading text file:",u);const p=document.getElementById(n.id),c=p?p.querySelector(".p-2"):null;c&&(c.innerHTML="<p>Error loading file.</p>")}),d="editor"):n.content_type==="markdown"||n.content_type==="md"?(l='<div id="file-content" style="padding:10px;">Loading file...</div>',fetch(`./media/${n.name}`).then(u=>u.text()).then(u=>{const p=document.getElementById(n.id),c=p?p.querySelector(".p-2"):null;c&&(c.innerHTML=`<div class="letterpad_editor min-h-48 h-full w-full" data-letterpad-editor-id="${n.id}"></div>`),O()}).catch(u=>{console.error("Error loading markdown file:",u);const p=document.getElementById(n.id),c=p?p.querySelector(".p-2"):null;c&&(c.innerHTML="<p>Error loading file.</p>")}),d="editor"):l=`<p style="padding:10px;">Content of ${n.name}</p>`;let f=null;o&&(f=o.target.closest("#windows-container > div"));let m=V(n.name,l,!1,n.id,!1,!1,{type:"integer",width:420,height:350},d,f);if(n.content_type==="image"){let u=m.querySelector("img");u&&(u.onload=function(){let p=u.naturalWidth+20,c=u.naturalHeight+60;m.style.width=p+"px",m.style.height=c+"px",H[m.id].dimensions={type:"integer",width:p,height:c},O()})}else if(n.content_type==="video"){let u=m.querySelector("video");u&&(u.onloadedmetadata=function(){let p=u.videoWidth+20,c=u.videoHeight+60;m.style.width=p+"px",m.style.height=c+"px",H[m.id].dimensions={type:"integer",width:p,height:c},O()})}}function bt(e){if(!e)return;const o=e.getAttribute("data-url");o&&window.open(o,"_blank")}function Cn(e){if(!e||!window.watercolourImageSelectionCallback)return!1;if(!["png","jpg","jpeg","gif","webp","avif"].includes(e.content_type))return alert("Please select an image file (.png, .jpg, .jpeg, .gif, .webp)"),!1;let o=null;if(e.dataURL){o=e.dataURL;const t={name:e.name,path:yt(),data:o,storageKey:e.storageLocation==="indexeddb"?`file_data_${e.id}`:null};return window.watercolourImageSelectionCallback(o,t),te("explorer-image-select"),window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null,!0}else{if(e.isLargeFile&&e.storageLocation==="indexeddb")return E.getItem(`file_data_${e.id}`).then(t=>{if(t){const n={name:e.name,path:yt(),data:t,storageKey:`file_data_${e.id}`};window.watercolourImageSelectionCallback(t,n),te("explorer-image-select"),window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null}else alert("Could not load image data.")}).catch(t=>{console.error("Error loading image:",t),alert("Error loading image: "+t.message)}),!0;if(e.file&&e.file instanceof File){const t=new FileReader;return t.onload=n=>{const r={name:e.name,path:yt(),data:n.target.result,storageKey:null};window.watercolourImageSelectionCallback(n.target.result,r),te("explorer-image-select"),window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null},t.readAsDataURL(e.file),!0}}return alert("Could not load the selected image."),!1}function yt(){const e=document.querySelectorAll(".file-explorer-window");return e.length>0&&e[e.length-1].getAttribute("data-current-path")||"C://Documents"}async function Oe(){try{const e=document.getElementById("explorer-window");if(e){const o=e.querySelector(".file-explorer-window");if(o){const n={currentPath:o.getAttribute("data-current-path")||"C://",timestamp:Date.now()};await E.setItem("fileExplorerState",n)}}}catch(e){console.warn("Failed to save file explorer state:",e);try{const o=document.getElementById("explorer-window");if(o){const t=o.querySelector(".file-explorer-window");if(t){const r={currentPath:t.getAttribute("data-current-path")||"C://",timestamp:Date.now()};E.setItemSync("fileExplorerState",r)}}}catch(o){console.error("Failed to save file explorer state with fallback:",o)}}}async function kn(){try{const e=await E.getItem("fileExplorerState");if(e)return e}catch(e){console.warn("Failed to load file explorer state:",e);try{const o=E.getItemSync("fileExplorerState");if(o)return o}catch(o){console.warn("Failed to load file explorer state with fallback:",o)}}return{currentPath:"C://",timestamp:0}}function In(e){console.log("🔧 Initializing File Explorer UI for restoration"),setTimeout(async()=>{await uo()},50)}async function uo(){console.log("🔄 Restoring File Explorer state...");const e=await kn();console.log("📁 Loaded File Explorer state:",e);const o=document.getElementById("explorer-window");if(o&&e.currentPath){console.log("🗂️ Restoring File Explorer to path:",e.currentPath);const t=Ae(e.currentPath);console.log("📄 Generated new content for path:",e.currentPath);const n=o.querySelector(".file-explorer-window");n?(console.log("🔄 Replacing File Explorer content..."),n.outerHTML=t,setTimeout(()=>{console.log("🎯 Setting up folder drop handlers..."),fe(),Te()},100),console.log("✅ File Explorer state restored successfully")):console.warn("⚠️ Could not find .file-explorer-window element")}else console.warn("⚠️ No explorer window found or no current path in state")}typeof window<"u"&&(window.initializeFileExplorerUI=In,window.restoreFileExplorerState=uo);function De(e,o=null){let t;typeof e!="string"?t=e:t=document.getElementById(e),t.classList.toggle("bg-gray-50"),t.classList.toggle("bg-gray-200"),t.classList.toggle("border-gray-300"),t.classList.toggle("border-black");const n=t.querySelector("span");n.classList.toggle("border-gray-300"),n.classList.toggle("border-black");const r=t.querySelector("img");r&&(r.classList.toggle("border-gray-300"),r.classList.toggle("border-black")),o&&(n.innerHTML=o)}function Ln(e){if(!e)return!0;try{return new URL(e,location.href).origin===location.origin}catch{return!1}}function po(){document.getElementById("error-overlay").classList.remove("hidden"),document.getElementById("error-overlay").style.zIndex="9999";function e(o){location.reload()}document.addEventListener("keydown",e,{once:!0})}window.onerror=function(e,o,t,n,r){Ln(o)&&po()};window.addEventListener("unhandledrejection",function(e){po()});function Dn(e){if(window.watercolourImageSelectionCallback=e,window.watercolourSelectedFile=null,typeof getExplorerWindowContent=="function"&&typeof createWindow=="function"){const t=getExplorerWindowContent("C://Documents").replace(/<div id="file-sidebar"[\s\S]*?<\/ul><\/div>/g,"").replace(/<div id="breadcrumbs"[\s\S]*?<\/div>/g,""),n=createWindow("Select Image - File Explorer",t,!0,"explorer-image-select",!1,!1,{type:"integer",width:600,height:550},"file-explorer");setTimeout(()=>{const r=[...document.querySelectorAll("*")].filter(i=>getComputedStyle(i).zIndex>100&&getComputedStyle(i).zIndex<1e3);if(r.length>0){const i=r.reduce((a,s)=>getComputedStyle(s).zIndex>getComputedStyle(a).zIndex?s:a);n.style.zIndex=`${parseInt(getComputedStyle(i).zIndex)+1}`}},50),setTimeout(()=>{if(n){const r=n.querySelector(".file-explorer-window");r?r.setAttribute("data-image-selection-mode","true"):console.error("Could not find .file-explorer-window div!");const i=n.querySelector(".p-2");if(i){const a=document.createElement("div");a.className="bg-blue-100 border border-blue-300 text-blue-800 px-3 py-2 rounded mb-3 text-sm",a.innerHTML='<strong>Select an image:</strong> Click any image file (.png, .jpg, .jpeg, .gif, .webp) to select it, then click "Open Selected Image".',i.insertBefore(a,i.firstChild);const s=document.createElement("div");s.className="-mt-2 p-3 bg-gray-50 border-t border-gray-200 flex items-center justify-between",s.id="watercolour-selection-ui";const l=document.createElement("div");l.className="flex gap-2";const d=ne("Cancel");d.id="cancel-selection";const f=ne("Open");f.id="open-selected-image",f.disabled=!0,f.style.opacity="0.5",f.style.cursor="not-allowed",l.appendChild(d),l.appendChild(f),s.innerHTML=`
            <div>
              <span id="selected-image-name" class="text-sm text-gray-600">No image selected</span>
            </div>
          `,s.appendChild(l),i.appendChild(s),d.addEventListener("click",()=>{window.watercolourImageSelectionCallback=null,window.watercolourSelectedFile=null,closeWindow("explorer-image-select")}),f.addEventListener("click",()=>{const m=window.watercolourSelectedFile;m&&window.watercolourImageSelectionCallback&&!f.disabled&&handleWatercolourImageSelection(m)}),window.updateWatercolourImageSelectionButton=function(m){m?(f.disabled=!1,f.style.opacity="1",f.style.cursor="pointer"):(f.disabled=!0,f.style.opacity="0.5",f.style.cursor="not-allowed")}}}else console.error("Explorer window not found!")},100)}else showDialogBox("File explorer functionality not available.","error")}function ne(e){const o=document.createElement("button");o.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2";const t=document.createElement("span");return t.className="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3",t.textContent=e,o.appendChild(t),o}function Bt(e,o="",t=null,n=null){const r="promptWindow-"+Date.now(),i=createWindow("💬 Input Required","",!1,r,!1,!1,{type:"integer",width:400,height:200},"default"),a=i.querySelector(".p-2");if(a){a.innerHTML="";const s=document.createElement("div");s.className="flex flex-col p-4 h-full justify-between";const l=document.createElement("div");l.className="mb-4",l.innerHTML=`<p class="text-sm mb-3">${e}</p>`;const d=document.createElement("input");d.type="text",d.id=`${r}-input`,d.value=o,d.className="w-full px-2 py-1 border-2 border-gray-400 bg-white",d.style.borderTopColor="#808080",d.style.borderLeftColor="#808080",d.style.borderBottomColor="#ffffff",d.style.borderRightColor="#ffffff",d.style.borderStyle="inset",l.appendChild(d),s.appendChild(l);const f=document.createElement("div");f.className="flex gap-2 justify-center";const m=ne("OK");m.id=`${r}-ok-button`;const u=ne("Cancel");u.id=`${r}-cancel-button`,f.appendChild(m),f.appendChild(u),s.appendChild(f),a.appendChild(s),setTimeout(()=>{d.focus(),d.select()},100),setTimeout(()=>{m.addEventListener("click",()=>{const p=d.value;closeWindow(r),t&&t(p)}),u.addEventListener("click",()=>{closeWindow(r),n&&n(null)}),d.addEventListener("keydown",p=>{if(p.key==="Enter"){p.preventDefault();const c=d.value;closeWindow(r),t&&t(c)}else p.key==="Escape"&&(p.preventDefault(),closeWindow(r),n&&n(null))})},150)}return bringToFront(i),setTimeout(()=>{bringToFront(i)},10),i}const fo=Object.freeze(Object.defineProperty({__proto__:null,makeWin95Button:ne,makeWin95Prompt:Bt,openFileExplorerForImageSelection:Dn,toggleButtonActiveState:De},Symbol.toStringTag,{value:"Module"}));function mo(){const e=document.getElementById("compost-bin");if(e){const c=[...document.querySelectorAll("*")].filter(h=>getComputedStyle(h).zIndex>100&&getComputedStyle(h).zIndex<1e3).reduce((h,v)=>getComputedStyle(v).zIndex>getComputedStyle(h).zIndex?v:h);e.style.zIndex=`${parseInt(c.style.zIndex)+1}`;return}const t=V("Compost Bin","",!1,"compost-bin",!1,!1,{type:"integer",width:600,height:400},"App",null,"gray").querySelector(".p-2");t.className="p-2 bg-gray-100 h-full flex flex-col";const n=document.createElement("div");n.className="h-full flex flex-col";const r=document.createElement("div");r.className="bg-gray-200 border-b border-gray-400 p-2 flex justify-between items-center";const i=document.createElement("div");i.className="text-sm";const l=(Y().folders["C://Desktop"]||{}).compostbin,d=Object.keys((l==null?void 0:l.contents)||{}).length;i.textContent=`Compost Bin - ${d} item(s)`;const f=document.createElement("div");f.className="flex space-x-2";const m=document.createElement("button");m.className="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs",m.textContent="Empty Bin",m.addEventListener("click",go),f.appendChild(m),r.appendChild(i),r.appendChild(f);const u=document.createElement("div");u.className="flex-1 bg-white border border-gray-400 p-2 overflow-auto",u.id="compost-bin-content",lt(u),n.appendChild(r),n.appendChild(u),t.appendChild(n)}function lt(e){const n=(Y().folders["C://Desktop"]||{}).compostbin,r=(n==null?void 0:n.contents)||{};if(e.innerHTML="",Object.keys(r).length===0){const a=document.createElement("div");a.className="text-center text-gray-500 mt-8",a.textContent="The Compost Bin is empty",e.appendChild(a);return}const i=document.createElement("div");i.className="grid grid-cols-6 gap-4 p-2",Object.values(r).forEach(a=>{const s=Mn(a);i.appendChild(s)}),e.appendChild(i)}function Mn(e){const o=document.createElement("div");o.className="flex flex-col items-center p-2 hover:bg-blue-100 cursor-pointer",o.draggable=!0,o.setAttribute("data-item-id",e.id);const t=document.createElement("img");t.className="w-8 h-8 mb-1",t.src=e.icon||Fn(e.type),t.alt=e.name;const n=document.createElement("div");return n.className="text-xs text-center text-gray-700 break-words max-w-16",n.textContent=e.name,o.appendChild(t),o.appendChild(n),o.addEventListener("dragstart",r=>{r.dataTransfer.setData("text/plain",e.id),r.dataTransfer.setData("application/x-compost-item","true"),r.dataTransfer.effectAllowed="move"}),o}async function Bn(e,o){const t=Y();if(e==="compostbin"){j("Cannot move the Compost Bin to itself!","error");return}let n=null,r=null;if(r=t.folders["C://Desktop"]||{},r&&r[e]){n=r[e];const a=(t.folders["C://Desktop"]||{}).compostbin;if(!a){console.error("Compost bin not found in unified structure"),j("Compost Bin not found!","error");return}a.contents||(a.contents={}),n.originalPath=o,a.contents[e]=n,delete r[e];{const l="icon-"+e;Q[l]&&delete Q[l]}await re(t),O(),Te(),X();const s=document.getElementById("compost-bin");if(s){const l=s.querySelector("#compost-bin-content");l&&(lt(l),yo(s))}}}function go(){const e=Y(),t=(e.folders["C://Desktop"]||{}).compostbin;if(!t){j("Compost Bin not found!","error");return}const n=Object.keys(t.contents||{}).length;if(n===0){j("The Compost Bin is already empty.","info");return}const r=`window-${Date.now()}`,a=V("Empty Compost Bin","",!1,r,!1,!1,{type:"integer",width:320,height:140},"Default").querySelector(".p-2");a.classList.add("p-4","flex","flex-col","justify-between","h-full");const s=document.createElement("p");s.textContent=`Are you sure you want to permanently delete all ${n} item(s) in the Compost Bin?`,a.appendChild(s);const l=document.createElement("div");l.className="flex justify-end space-x-2",a.appendChild(l);const d=document.createElement("button");d.className="px-4 py-2 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200",d.textContent="Cancel";const f=document.createElement("button");f.className="px-4 py-2 bg-red-500 border-2 border-red-600 hover:bg-red-400 text-white",f.textContent="Empty Bin",l.append(d,f),d.addEventListener("click",()=>closeWindow(r)),f.addEventListener("click",async()=>{const m=Object.keys(t.contents||{});t.contents={},m.forEach(p=>{const c="icon-"+p;Q[c]&&delete Q[c]}),await re(e),O();const u=document.getElementById("compost-bin");if(u){const p=u.querySelector("#compost-bin-content");p&&(lt(p),yo(u))}closeWindow(r),j(`${n} item(s) permanently deleted from Compost Bin`,"info")})}function yo(e){const o=e.querySelector(".bg-gray-200");if(o){const t=o.querySelector(".text-sm");if(t){const i=(Y().folders["C://Desktop"]||{}).compostbin,a=Object.keys((i==null?void 0:i.contents)||{}).length;t.textContent=`Compost Bin - ${a} item(s)`}}}function Fn(e){switch(e){case"folder":return"./image/folder.png";case"ugc-file":return"./image/doc.png";case"app":return"./image/computer.png";default:return"./image/file.png"}}function ho(){if(window.location.href.includes("reddit.com")){if(document.getElementById("mailbox-error"))return;V("⚠️ Error",'<div class="text-center p-4"><p class="mb-4">Mail app is not available in Reddit context.</p><button id="error-ok-btn" class="bg-gray-200 border-t-2 border-l-2 border-gray-300 h-8"><span class="border-b-2 border-r-2 border-black block h-full w-full py-1 px-3 leading-6">OK</span></button></div>',!1,"mailbox-error",!1,!1,{type:"integer",width:300,height:150},"Default"),setTimeout(()=>{const u=document.getElementById("error-ok-btn");u&&u.addEventListener("click",p=>{p.preventDefault(),p.stopPropagation(),te("mailbox-error")})},100);return}const t=V("Mailbox","",!1,"mailbox",!1,!1,{type:"integer",width:600,height:400},"App",null,"white").querySelector(".p-2");t.classList.add("flex","flex-col","h-full");const n=document.createElement("div");n.className="flex-1 flex overflow-hidden",t.appendChild(n);const r=document.createElement("div");r.id="mailbox-list",r.className="w-1/3 border-r border-gray-300 flex flex-col overflow-y-auto",n.appendChild(r);const i=document.createElement("button");i.id="compose-btn",i.className="p-2 border-b border-gray-300 text-blue-500 hover:bg-gray-100",i.textContent="Compose",r.appendChild(i);const a=document.createElement("div");a.id="mailbox-detail",a.className="flex-1 p-2 overflow-y-auto",n.appendChild(a);const s=document.createElement("div");s.id="placeholder",s.className="text-gray-500",s.textContent="Select a message to view",a.appendChild(s);function l(u){const p={};return u.forEach(c=>{const h=c.creator_model_id;p[h]||(p[h]={id:h,fields:{},created_at:c.created_at,updated_at:c.updated_at}),p[h].fields[c.html_input_label]={content:c.string_content||"",fieldId:c.id}}),Object.values(p).map(c=>{var h,v,M,F;return{id:c.id,email:((h=c.fields.email)==null?void 0:h.content)||((v=c.fields.name)==null?void 0:v.content)||"Unknown",textarea:((M=c.fields.message)==null?void 0:M.content)||"",subject:((F=c.fields.subject)==null?void 0:F.content)||"No Subject",public:!1,files:{}}})}function d(){try{for(;r.children.length>1;)r.removeChild(r.lastChild);fetch("https://endpoints.relentlesscurious.com/end_data/public/contact-form-data").then(u=>{if(!u.ok)throw new Error("Failed to fetch submissions");return u.json()}).then(u=>{l(u.data).forEach(c=>{const h=document.createElement("div");h.className="p-2 border-b border-gray-300 hover:bg-gray-200 cursor-pointer truncate",h.textContent=c.subject||c.email,h.addEventListener("click",()=>f(c)),r.appendChild(h)})}).catch(u=>{console.error("Error loading messages:",u);const p=document.createElement("div");p.className="p-2 text-red-500 text-sm",p.textContent="Failed to load messages",r.appendChild(p)})}catch(u){console.error("Error loading messages:",u)}}function f(u){for(;a.firstChild;)a.removeChild(a.firstChild);const p=document.createElement("div");p.className="mb-2";const c=document.createElement("div"),h=document.createElement("strong");h.textContent="From: ",c.append(h,document.createTextNode(u.email)),p.appendChild(c);const v=document.createElement("div"),M=document.createElement("strong");M.textContent="Subject: ",v.append(M,document.createTextNode(u.subject||"(No Subject)")),p.appendChild(v);const F=document.createElement("div");if(F.className="mb-2 whitespace-pre-wrap",F.textContent=u.textarea,a.append(p,F),u.files&&Object.keys(u.files).length){const T=document.createElement("div");T.className="mt-2";const G=document.createElement("strong");G.textContent="Attachments:",T.appendChild(G);const R=document.createElement("ul");R.className="list-disc list-inside",Object.values(u.files).forEach(z=>{const U=document.createElement("li"),_=document.createElement("a");_.href=z.url||z.contents||"#",_.className="text-blue-500 hover:underline",_.textContent=z.name,_.target="_blank",U.appendChild(_),R.appendChild(U)}),T.appendChild(R),a.appendChild(T)}}function m(){const p=V("Compose Message","",!1,"Compose Message",!1,!1,{type:"integer",width:400,height:600},"App",null,"white").querySelector(".p-2");p.classList.add("p-4");const c=document.createElement("form");c.id="compose-form",c.className="flex flex-col space-y-4",p.appendChild(c);const h=(oe,Z)=>{const B=document.createElement("div"),L=document.createElement("label");return L.className="block text-sm font-medium text-gray-700",L.textContent=oe,B.append(L,Z),B},v=document.createElement("input");v.type="email",v.name="from",v.required=!0,v.className="mt-1 block w-full border border-gray-300 rounded p-2",c.appendChild(h("From",v));const M=document.createElement("input");M.type="email",M.name="to",M.value="person@example.com",M.readOnly=!0,M.className="mt-1 block w-full border border-gray-300 rounded p-2 bg-gray-100",c.appendChild(h("To",M));const F=document.createElement("input");F.type="text",F.name="subject",F.className="mt-1 block w-full border border-gray-300 rounded p-2",c.appendChild(h("Subject (optional)",F));const T=document.createElement("textarea");T.name="message",T.required=!0,T.className="mt-1 block w-full border border-gray-300 rounded p-2",c.appendChild(h("Message",T));const G=document.createElement("input");G.type="tel",G.name="phone",G.className="mt-1 block w-full border border-gray-300 rounded p-2",c.appendChild(h("Phone (optional)",G));const R=document.createElement("input");R.type="text",R.name="company",R.className="mt-1 block w-full border border-gray-300 rounded p-2",c.appendChild(h("Company (optional)",R));const z=document.createElement("div");z.className="flex justify-end space-x-2",c.appendChild(z);const U=document.createElement("button");U.type="button",U.id="cancel-compose",U.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2",U.innerHTML='<span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Cancel</span>',z.appendChild(U);const _=document.createElement("button");_.type="submit",_.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2",_.innerHTML='<span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Send</span>',z.appendChild(_),c.addEventListener("submit",oe=>{oe.preventDefault();const Z=new FormData(c),B={name:Z.get("from"),email:Z.get("from"),subject:Z.get("subject")||"No Subject",message:Z.get("message"),phone:Z.get("phone")||"",company:Z.get("company")||""},L={creator_model:{title:`Contact: ${B.subject}`,creator_fields_attributes:{0:{html_input_label:"name",string_content:B.name},1:{html_input_label:"email",string_content:B.email},2:{html_input_label:"phone",string_content:B.phone},3:{html_input_label:"company",string_content:B.company},4:{html_input_label:"subject",string_content:B.subject},5:{html_input_label:"message",string_content:B.message}}}};fetch("https://endpoints.relentlesscurious.com/end_data/public/contact-form-create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(L)}).then($=>{if($.ok)showDialogBox("Message sent successfully!","success"),d(),te("Compose Message");else throw new Error("Failed to submit form")}).catch(()=>showDialogBox("Error sending message.","error"))}),U.addEventListener("click",()=>te("Compose Message"))}i.addEventListener("click",m),d()}async function bo(){const o=`<iframe width="560" height="315" style="margin:0 auto;" src="${await wo()}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>`;V("TubeStream",o,!1,"tubestream",!1,!1,{type:"integer",width:580,height:380},"default",null,"white")}async function wo(){const e="https://www.youtube.com/embed";try{const o=Tn.playlists[0],t=o.beginning_video_id,n=o.playlist_id,r=o.custom_parameters;return`${e}/${t}?list=${n}&${r}`}catch(o){return console.error("Error loading stream:",o),"https://www.youtube.com/embed/b6ZhmHfnklQ?autoplay=true"}}const Tn={playlists:[{id:"111",name:"Psytrance Mix",description:"Example usage #1",playlist_id:"PL7SZQy1OjmvdHsvEG1e8H305y3SxaIzxY",beginning_video_id:"b6ZhmHfnklQ",custom_parameters:"autoplay=true&loop=false"},{id:"222",name:"Skits",description:"Example usage #2",playlist_id:"PLfznZzH31A448eZ2rWURNfkmRGC0lsCaA",beginning_video_id:"24ny5EJr-hQ",custom_parameters:"autoplay=true&loop=true"},{id:"333",name:"Studio Shows",description:"Example usage #3",playlist_id:"PLfznZzH31A46GppLOHadmvL3I8H7ied2d",beginning_video_id:"J5a029oRpDA",custom_parameters:"autoplay=true&loop=false"}]};async function vo(){const e=document.getElementById("watercolour");if(e){const n=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,i)=>getComputedStyle(i).zIndex>getComputedStyle(r).zIndex?i:r);e.style.zIndex=`${parseInt(n.style.zIndex)+1}`;return}const o=Eo();V("Watercolour",o,!1,"watercolour",!1,!1,{type:"integer",width:700,height:440},"app",null,"white"),xo()}async function xo(e){await So()}function Eo(){return`
<div id="watercolour-container" style="background-color: #f3f4f6; position: relative; height: calc(100% - 0.25rem); margin-top: -0.5rem; margin: 0; padding: 0;">
  <!-- Top Menu Bar -->
  <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background-color: white; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); border-bottom: 1px solid #e5e7eb;">
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <!-- File Dropdown Menu -->
      <div style="position: relative;">
        <button id="fileMenuBtn" style="padding: 0.25rem 0.75rem; border-radius: 0.25rem; border: 1px solid #d1d5db; background-color: white; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'" onclick="toggleFileDropdown(event)">
          File
          <svg style="width: 0.75rem; height: 0.75rem; pointer-events: none;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div id="fileDropdown" style="position: absolute; left: 0; top: 100%; margin-top: 0.25rem; width: 10rem; background-color: white; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 50; display: none;">
          <button id="loadBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; border-bottom: 1px solid #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">Open...</button>
          <button id="newBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; border-bottom: 1px solid #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">New</button>
          <button id="saveAsBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; border-bottom: 1px solid #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">Save</button>
          <button id="exportBtn" style="width: 100%; text-align: left; padding: 0.5rem 0.75rem; background: none; border: none; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">Export...</button>
        </div>
      </div>

      <button id="undoBtn" style="padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #d1d5db; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">
        <svg style="height: 1rem; width: 1rem; display: inline;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
          <path style="opacity: 0.4;" d="M97.6 97.6c87.5-87.5 229.3-87.5 316.8 0C458.1 141.3 480 198.7 480 256s-21.9 114.7-65.6 158.4c-87.5 87.5-229.3 87.5-316.8 0l45.3-45.3c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L97.6 97.6z" />
          <path d="M176 224l24-24L40 40 16 64l0 160H176z" />
        </svg>
        Undo
      </button>
      <button id="redoBtn" style="padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #d1d5db; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">
        <svg style="height: 1rem; width: 1rem; display: inline;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
          <path style="opacity: 0.4;" d="M32 256c0 57.3 21.9 114.7 65.6 158.4c87.5 87.5 229.3 87.5 316.8 0l-45.3-45.3c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3s163.8-62.5 226.3 0c15.1-15.1 30.2-30.2 45.3-45.3c-87.5-87.5-229.3-87.5-316.8 0C53.9 141.3 32 198.7 32 256z" />
          <path d="M336 224l-24-24L472 40l24 24 0 160H336z" />
        </svg>
        Redo
      </button>
    </div>
    <div id="status" style="font-size: 0.75rem; color: #6b7280;">
      Tool: Brush | x: 0, y: 0
    </div>
  </div>

  <!-- Main Content Area -->
  <div style="display: flex;">
    <!-- Left Toolbar -->
    <div style="width: 3rem; padding: 0.5rem; background-color: white; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; gap: 0.5rem;">
      <button data-tool="brush" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: #f3f4f6; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='#f3f4f6'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./js/apps/watercolour/icons/brush.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Brush</span>
      </button>
      <button data-tool="line" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./js/apps/watercolour/icons/line.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Line</span>
      </button>
      <button data-tool="rectangle" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./js/apps/watercolour/icons/rectangle.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Rectangle</span>
      </button>
      <button data-tool="ellipse" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./js/apps/watercolour/icons/ellipse.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Ellipse</span>
      </button>
      <button data-tool="eraser" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./js/apps/watercolour/icons/eraser.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Eraser</span>
      </button>
      <button data-tool="fill" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./js/apps/watercolour/icons/fill.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Fill</span>
      </button>
      <button data-tool="picker" class="tool-btn" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; background-color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='white'">
        <img style="height: 1.5rem; width: 1.5rem;" src="./js/apps/watercolour/icons/picker.svg">
        <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Picker</span>
      </button>
    </div>

    <!-- Canvas Container -->
    <div style="flex: 1; position: relative;">
      <canvas id="watercolourCanvas" width="420" height="300" style="background: white; margin: 0.5rem; margin-bottom: 2rem; position: absolute; inset: 0; border: 1px solid #d1d5db;"></canvas>
    </div>

    <!-- Right Panel: Color Palette & Stroke Size -->
    <div style="width: 8rem; padding: 0.5rem; background-color: white; border-left: 1px solid #e5e7eb; display: flex; flex-direction: column; gap: 1rem;">
      <!-- Color Palette -->
      <div style="display: flex; flex-direction: column; gap: 0.5rem;">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.25rem;">
          <!-- 16 predefined colors -->
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #000000;" data-color="#000000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #808080;" data-color="#808080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #800000;" data-color="#800000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FF0000;" data-color="#FF0000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #808000;" data-color="#808000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FFFF00;" data-color="#FFFF00"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #008000;" data-color="#008000"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #00FF00;" data-color="#00FF00"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #008080;" data-color="#008080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #00FFFF;" data-color="#00FFFF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #000080;" data-color="#000080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #0000FF;" data-color="#0000FF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #800080;" data-color="#800080"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FF00FF;" data-color="#FF00FF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #FFFFFF;" data-color="#FFFFFF"></div>
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 0.125rem; cursor: pointer; border: 1px solid #d1d5db; background-color: #C0C0C0;" data-color="#C0C0C0"></div>
        </div>
        <input id="colorPicker" type="color" style="width: 100%;" />
      </div>
      <!-- Stroke Size -->
      <div>
        <label for="strokeSize" style="font-size: 0.875rem;">Size</label>
        <input id="strokeSize" type="range" min="1" max="50" value="5" style="width: 100%;" />
      </div>
    </div>
  </div>

  <!-- Hidden text input for Text Tool -->
  <input type="text" id="textInput" style="position: absolute; border: 1px solid #9ca3af; padding: 0.25rem; display: none; font-size: 16px; line-height: 1; color: #000;" />
</div>
`}async function So(){window.toggleFileDropdown=function(g){g.stopPropagation();const y=document.getElementById("fileDropdown");y&&(y.style.display=y.style.display==="none"?"block":"none")},document.addEventListener("click",function(g){const y=document.getElementById("fileDropdown"),b=document.getElementById("fileMenuBtn");y&&b&&!b.contains(g.target)&&!y.contains(g.target)&&(y.style.display="none")});const e=document.getElementById("watercolourCanvas"),o=e.getContext("2d",{willReadFrequently:!0});let t=null,n=!1,r="brush",i,a,s="#000000",l=5,d=null,f=null,m=null;const u=document.getElementById("textInput"),p=document.getElementById("strokeSize"),c=document.getElementById("colorPicker");let h=[],v=[];p.addEventListener("input",g=>{l=g.target.value,o.lineWidth=l,r==="text"&&u.style.display==="block"&&(u.style.fontSize=`${l*4}px`),ie().catch(console.error)}),c.addEventListener("change",g=>{s=g.target.value,o.strokeStyle=s,o.fillStyle=s,r==="text"&&u.style.display==="block"&&(u.style.color=s),ie().catch(console.error)}),window.addEventListener("resize",oe),document.body.addEventListener("touchmove",g=>{n&&g.preventDefault()},{passive:!1}),document.addEventListener("wheel",g=>{n&&g.preventDefault()},{passive:!1}),document.querySelectorAll(".tool-btn").forEach(g=>{g.addEventListener("click",()=>{document.querySelectorAll(".tool-btn").forEach(y=>y.classList.remove("bg-gray-100")),g.classList.add("bg-gray-100"),r=g.getAttribute("data-tool"),e.style.cursor=`url("./icons/resized_${r}.png"), auto`,ie().catch(console.error)})}),document.getElementById("strokeSize").addEventListener("input",g=>{l=g.target.value,o.lineWidth=l}),document.getElementById("colorPicker").addEventListener("change",g=>{s=g.target.value,o.strokeStyle=s,o.fillStyle=s}),document.querySelectorAll("[data-color]").forEach(g=>{g.addEventListener("click",()=>{s=g.getAttribute("data-color"),o.strokeStyle=s,o.fillStyle=s,document.getElementById("colorPicker").value=s,ie().catch(console.error)})});let M=0;const F=3;function T(){if(M++,M>F){G();return}const g=document.getElementById("fileMenuBtn"),y=document.getElementById("fileDropdown"),b=document.getElementById("saveAsBtn");if(g&&y&&b){R();return}setTimeout(T,200)}function G(){const g=document.getElementById("loadBtn"),y=document.getElementById("newBtn"),b=document.getElementById("exportBtn");if(!g||!y||!b){console.error("Could not find expected buttons");return}g.addEventListener("click",()=>{le()}),y.addEventListener("click",()=>{showDialogBox("Clear canvas? Unsaved work will be lost.","confirmation",()=>{const k=e.offsetWidth,I=e.offsetHeight;o.clearRect(0,0,k,I),o.fillStyle="white",o.fillRect(0,0,k,I),d=e.toDataURL(),z(),m=null})}),b.addEventListener("click",()=>{const k=document.createElement("a");k.download="drawing.png",k.href=e.toDataURL(),k.click()})}function R(){const g=document.getElementById("fileMenuBtn"),y=document.getElementById("fileDropdown"),b=document.getElementById("saveAsBtn"),k=document.getElementById("loadBtn"),I=document.getElementById("newBtn"),A=document.getElementById("exportBtn");g.addEventListener("click",S=>{S.stopPropagation(),y.classList.toggle("hidden")}),document.addEventListener("click",S=>{!g.contains(S.target)&&!y.contains(S.target)&&y.classList.add("hidden")}),y.addEventListener("click",()=>{y.classList.add("hidden")}),b.addEventListener("click",async()=>{await xe()}),k.addEventListener("click",()=>{le()}),I.addEventListener("click",()=>{showDialogBox("Clear canvas? Unsaved work will be lost.","confirmation",()=>{const S=e.offsetWidth,x=e.offsetHeight;o.clearRect(0,0,S,x),o.fillStyle="white",o.fillRect(0,0,S,x),d=e.toDataURL(),z()})}),A.addEventListener("click",()=>{const S=document.createElement("a");S.download="drawing.png",S.href=e.toDataURL(),S.click()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",T):T(),e.addEventListener("pointerdown",g=>{g.preventDefault();const y=_(g);if(i=y.x,a=y.y,r==="fill"){z(),$(y.x,y.y,s),d=e.toDataURL(),z();return}if(n=!0,r==="brush"||r==="eraser")o.beginPath(),o.moveTo(i,a);else if(["line","rectangle","ellipse"].includes(r))f=document.createElement("canvas"),f.width=e.width,f.height=e.height,f.getContext("2d").drawImage(e,0,0);else if(r==="text"){const b=_(g);if(u.style.display==="block"){B();return}const k=e.getBoundingClientRect();u.style.left=k.left+b.x+"px",u.style.top=k.top+b.y+"px",u.style.display="block",u.style.fontSize=`${l*4}px`,u.style.color=s,u.dataset.x=b.x,u.dataset.y=b.y,setTimeout(()=>{u.focus(),u.onblur=B},0),u.onkeydown=I=>{I.key==="Enter"&&B()}}}),e.addEventListener("pointermove",g=>{const y=_(g);if(Z(y.x,y.y),!!n){if(g.preventDefault(),r==="brush")o.lineTo(y.x,y.y),o.stroke();else if(r==="eraser")o.strokeStyle="white",o.lineTo(y.x,y.y),o.stroke(),o.strokeStyle=s;else if(["line","rectangle","ellipse"].includes(r)){const b=e.offsetWidth,k=e.offsetHeight;o.clearRect(0,0,b,k),f&&o.drawImage(f,0,0,b,k),L(y.x,y.y)}}}),e.addEventListener("pointerup",g=>{const y=_(g);n&&["line","rectangle","ellipse"].includes(r)&&L(y.x,y.y,!0),n=!1,d=e.toDataURL(),z(),f=null}),e.addEventListener("click",g=>{const y=_(g);if(r==="picker"){const b=window.devicePixelRatio||1,k=o.getImageData(Math.floor(y.x*b),Math.floor(y.y*b),1,1).data;s=de(k[0],k[1],k[2]),o.strokeStyle=s,o.fillStyle=s,document.getElementById("colorPicker").value=s,ie().catch(console.error)}}),document.getElementById("undoBtn").addEventListener("click",()=>{if(h.length>1){const g=h.pop();v.push(g);const y=h[h.length-1];U(y),d=y,ie().catch(console.error)}}),document.getElementById("redoBtn").addEventListener("click",()=>{if(v.length){const g=v.pop();h.push(g),U(g),d=g,ie().catch(console.error)}});function z(){const g=e.toDataURL();h.push(g),d=g,v=[],ie().catch(console.error)}function U(g){const y=new Image;y.src=g,y.onload=()=>{const b=e.offsetWidth,k=e.offsetHeight;o.clearRect(0,0,b,k),o.drawImage(y,0,0,b,k)}}function _(g){const y=e.getBoundingClientRect();return{x:g.clientX-y.left,y:g.clientY-y.top}}function oe(){const g=window.devicePixelRatio||1,y=e.offsetWidth,b=e.offsetHeight;if(o.getImageData(0,0,e.width,e.height),e.width=y*g,e.height=b*g,e.style.width=y+"px",e.style.height=b+"px",o.setTransform(g,0,0,g,0,0),d){const k=new Image;k.src=d,k.onload=()=>{o.clearRect(0,0,y,b),o.drawImage(k,0,0,y,b)}}else o.fillStyle="white",o.fillRect(0,0,y,b)}function Z(g,y){const b=document.getElementById("status");b.textContent=`Tool: ${r.charAt(0).toUpperCase()+r.slice(1)} | x: ${Math.floor(g)}, y: ${Math.floor(y)}`}function B(){const g=parseFloat(u.dataset.x),y=parseFloat(u.dataset.y),b=u.value;u.style.display="none",u.value="",u.onblur=null,o.fillStyle=s,o.font=`${l*4}px sans-serif`,o.textBaseline="top",o.fillText(b,g,y),z()}function L(g,y,b=!1){const k=i,I=a,A=g-i,S=y-a;o.lineWidth=l,o.strokeStyle=s,o.fillStyle=s,r==="line"?(o.beginPath(),o.moveTo(k,I),o.lineTo(g,y),o.stroke()):r==="rectangle"?o.strokeRect(k,I,A,S):r==="ellipse"&&(o.beginPath(),o.ellipse(k+A/2,I+S/2,Math.abs(A/2),Math.abs(S/2),0,0,Math.PI*2),o.stroke())}function $(g,y,b){const k=window.devicePixelRatio||1,I=e.width,A=e.height,S=o.getImageData(0,0,I,A),x=S.data,q=N(b),J=q.r,ae=q.g,K=q.b,P=Math.floor(g*k),ue=Math.floor(y*k),ce=(ue*I+P)*4,be=x[ce],me=x[ce+1],Se=x[ce+2],Ze=x[ce+3];if(be===J&&me===ae&&Se===K)return;const Ve=[[P,ue]];for(;Ve.length;){const[Ce,yn]=Ve.pop();let we=yn;for(;we>=0&&D(x,Ce,we,I,be,me,Se,Ze);)we--;we++;let mt=!1,gt=!1;for(;we<A&&D(x,Ce,we,I,be,me,Se,Ze);){const Ke=(we*I+Ce)*4;x[Ke]=J,x[Ke+1]=ae,x[Ke+2]=K,x[Ke+3]=255,Ce>0&&(D(x,Ce-1,we,I,be,me,Se,Ze)?mt||(Ve.push([Ce-1,we]),mt=!0):mt=!1),Ce<I-1&&(D(x,Ce+1,we,I,be,me,Se,Ze)?gt||(Ve.push([Ce+1,we]),gt=!0):gt=!1),we++}}o.putImageData(S,0,0)}function D(g,y,b,k,I,A,S,x){const q=(b*k+y)*4;return g[q]===I&&g[q+1]===A&&g[q+2]===S&&g[q+3]===x}function N(g){g=g.replace(/^#/,"");let y=parseInt(g,16);return g.length===3?{r:(y>>8)*17,g:(y>>4&15)*17,b:(y&15)*17}:{r:y>>16&255,g:y>>8&255,b:y&255}}function de(g,y,b){return"#"+((1<<24)+(g<<16)+(y<<8)+b).toString(16).slice(1)}async function xe(){try{const g=e.toDataURL("image/png"),y=globalStorage,b=globalAddFileToFileSystem;if(!y){showDialogBox("Cannot access storage. Please ensure the main OS is loaded.","error");return}const k=Date.now(),I=`watercolour_drawing_${k}`;await y.setItem(I,g),makeWin95Prompt("Enter a filename for your drawing:",`drawing_${k}.png`,async A=>{if(A){const S=A.endsWith(".png")?A:A+".png",x=Me();if(b){const J=await(await fetch(g)).blob(),ae=new File([J],S,{type:"image/png"}),K=await b(S,g,x,"png",ae);m={name:S,path:x,storageKey:I,data:g},refreshExplorerViews&&refreshExplorerViews(),x==="C://Desktop"&&renderDesktopIcons&&renderDesktopIcons(),showDialogBox(`Drawing saved as "${S}" in ${x}!`,"info")}else showDialogBox("File system not available. Drawing saved to storage only.","info")}else showDialogBox("Drawing saved to storage but not added to file system.","info")},()=>{showDialogBox("Drawing saved to storage but not added to file system.","info")})}catch(g){console.error("Error saving drawing:",g),showDialogBox("Error saving drawing: "+g.message,"error")}}function le(){if(openFileExplorerForImageSelection)openFileExplorerForImageSelection((g,y)=>{g&&Ee(g,y)});else if(V&&getExplorerWindowContent){window.watercolourLoadCallback=(y,b)=>{y&&Ee(y,b)};const g=getExplorerWindowContent("C://Documents");V("Select Image - File Explorer",g,!0,"explorer-watercolour-load",!1,!1,{type:"integer",width:600,height:500},"file-explorer"),showDialogBox("Select an image file from the file explorer to load it onto the canvas.","info")}else showDialogBox("File explorer not available. Please ensure the main OS is loaded.","error")}function Ee(g,y=null){const b=new Image;b.onload=()=>{const k=e.offsetWidth,I=e.offsetHeight;o.clearRect(0,0,k,I),o.fillStyle="white",o.fillRect(0,0,k,I);const A=Math.min(k/b.width,I/b.height),S=b.width*A,x=b.height*A,q=(k-S)/2,J=(I-x)/2;o.drawImage(b,q,J,S,x),d=e.toDataURL(),z()},b.onerror=()=>{console.error("Error loading selected image."),showDialogBox("Error loading selected image.","error")},b.src=g}function Me(){if(parent&&parent.document){const g=parent.document.querySelectorAll(".file-explorer-window");if(g.length>0){const b=g[g.length-1].getAttribute("data-current-path");if(b)return b}}return"C://Documents"}async function ie(){try{const g={currentTool:r,activeColor:s,strokeSize:l,canvasData:e.toDataURL(),currentFile:m,undoStack:h.slice(-10),redoStack:v.slice(-10)};await storage.setItem("watercolour_state",g)}catch(g){console.warn("Failed to save Watercolour state:",g);try{const y={currentTool:r,activeColor:s,strokeSize:l,canvasData:e.toDataURL(),currentFile:m,undoStack:h.slice(-10),redoStack:v.slice(-10)};storage.setItemSync("watercolour_state",y)}catch(y){console.error("Failed to save Watercolour state with fallback:",y)}}}async function ze(){try{const g=await storage.getItem("watercolour_state");if(g)return g}catch(g){console.warn("Failed to load Watercolour state:",g);try{const y=storage.getItemSync("watercolour_state");if(y)return y}catch(y){console.warn("Failed to load Watercolour state with fallback:",y)}}return null}async function C(){t=await ze(),t&&(r=t.currentTool||"brush",s=t.activeColor||"#000000",l=t.strokeSize||5,m=t.currentFile||null,h=t.undoStack||[],v=t.redoStack||[]);const g=window.devicePixelRatio||1,y=e.offsetWidth,b=e.offsetHeight;e.width=y*g,e.height=b*g,e.style.width=y+"px",e.style.height=b+"px",o.setTransform(g,0,0,g,0,0),p&&(p.value=l),c&&(c.value=s),o.strokeStyle=s,o.fillStyle=s,o.lineWidth=l,document.querySelectorAll(".tool-btn").forEach(I=>{I.classList.remove("bg-gray-100"),I.getAttribute("data-tool")===r&&I.classList.add("bg-gray-100")});const k=t==null?void 0:t.canvasData;if(k){const I=new Image;I.onload=function(){o.clearRect(0,0,y,b),o.drawImage(I,0,0,y,b)},I.src=k}else o.fillStyle="white",o.fillRect(0,0,y,b),z()}await C()}function Co(){const e=document.getElementById("calculator");if(e){const n=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,i)=>getComputedStyle(i).zIndex>getComputedStyle(r).zIndex?i:r);e.style.zIndex=`${parseInt(n.style.zIndex)+1}`;return}const o=V("Calculator","",!1,"calculator",!1,!1,{type:"integer",width:250,height:360},"App",null,"gray-100");ko(o).catch(t=>{console.error("Error initializing Calculator:",t)})}async function ko(e){const o=e.querySelector(".p-2");o.className="p-4 bg-gray-100 h-full overflow-hidden",o.innerHTML="";let t=await $n();t||(t={display:"0",previousValue:null,operation:null,waitingForOperand:!1});const n=document.createElement("div");n.className="flex flex-col h-full space-y-1 pb-6";const r=document.createElement("div");r.className="bg-white border-2 p-2 mb-2",r.style.borderTopColor="#808080",r.style.borderLeftColor="#808080",r.style.borderBottomColor="#ffffff",r.style.borderRightColor="#ffffff";const i=document.createElement("div");i.id="calc-display",i.className="text-right text-lg font-mono bg-white text-black min-h-6 px-1",i.textContent=t.display,r.appendChild(i);const a=document.createElement("div");a.className="grid grid-cols-4 gap-1 flex-1",[{text:"C",type:"clear",className:"col-span-2"},{text:"±",type:"sign"},{text:"/",type:"operator"},{text:"7",type:"number"},{text:"8",type:"number"},{text:"9",type:"number"},{text:"*",type:"operator"},{text:"4",type:"number"},{text:"5",type:"number"},{text:"6",type:"number"},{text:"-",type:"operator"},{text:"1",type:"number"},{text:"2",type:"number"},{text:"3",type:"number"},{text:"+",type:"operator"},{text:"0",type:"number",className:"col-span-2"},{text:".",type:"decimal"},{text:"=",type:"equals"}].forEach(p=>{const c=document.createElement("button");c.textContent=p.text,c.className=`bg-gray-200 border-2 hover:bg-gray-300 font-mono text-sm py-2 select-none ${p.className||""}`,c.style.borderTopColor="#ffffff",c.style.borderLeftColor="#ffffff",c.style.borderBottomColor="#808080",c.style.borderRightColor="#808080",c.style.transition="none",c.addEventListener("mousedown",()=>{c.style.borderTopColor="#808080",c.style.borderLeftColor="#808080",c.style.borderBottomColor="#ffffff",c.style.borderRightColor="#ffffff",c.classList.add("bg-gray-300")}),c.addEventListener("mouseup",()=>{c.style.borderTopColor="#ffffff",c.style.borderLeftColor="#ffffff",c.style.borderBottomColor="#808080",c.style.borderRightColor="#808080",c.classList.remove("bg-gray-300")}),c.addEventListener("mouseleave",()=>{c.style.borderTopColor="#ffffff",c.style.borderLeftColor="#ffffff",c.style.borderBottomColor="#808080",c.style.borderRightColor="#808080",c.classList.remove("bg-gray-300")}),c.addEventListener("click",async()=>await d(p.text,p.type)),a.appendChild(c)}),n.appendChild(r),n.appendChild(a),o.appendChild(n);async function l(){i.textContent=t.display,await An(t)}async function d(p,c){switch(c){case"number":t.waitingForOperand?(t.display=p,t.waitingForOperand=!1):t.display=t.display==="0"?p:t.display+p;break;case"decimal":t.waitingForOperand?(t.display="0.",t.waitingForOperand=!1):t.display.indexOf(".")===-1&&(t.display+=".");break;case"clear":t.display="0",t.previousValue=null,t.operation=null,t.waitingForOperand=!1;break;case"sign":t.display!=="0"&&(t.display=t.display.charAt(0)==="-"?t.display.slice(1):"-"+t.display);break;case"operator":const h=parseFloat(t.display);if(t.previousValue===null)t.previousValue=h;else if(t.operation){const M=t.previousValue||0,F=f(M,h,t.operation);t.display=String(F),t.previousValue=F}t.waitingForOperand=!0,t.operation=p;break;case"equals":const v=parseFloat(t.display);if(t.previousValue!==null&&t.operation){const M=t.previousValue||0,F=f(M,v,t.operation);t.display=String(F),t.previousValue=null,t.operation=null,t.waitingForOperand=!0}break}await l()}function f(p,c,h){switch(h){case"+":return p+c;case"-":return p-c;case"*":return p*c;case"/":return c!==0?p/c:0;default:return c}}async function m(p){const c=p.key;/[0-9]/.test(c)?await d(c,"number"):["+","-","*","/"].includes(c)?await d(c,"operator"):c==="."?await d(c,"decimal"):c==="Enter"||c==="="?await d("=","equals"):c==="Escape"||c==="c"||c==="C"?await d("C","clear"):c==="Backspace"&&(t.display.length>1?t.display=t.display.slice(0,-1):t.display="0",await l())}document.addEventListener("keydown",m);const u=new MutationObserver(p=>{p.forEach(c=>{c.removedNodes.forEach(h=>{h.id==="calculator"&&(document.removeEventListener("keydown",m),u.disconnect())})})});u.observe(document.getElementById("windows-container"),{childList:!0})}async function An(e){try{await E.setItem("calculator_state",e)}catch(o){console.warn("Failed to save Calculator state:",o)}}async function $n(){try{const e=await E.getItem("calculator_state");if(e)return e}catch(e){console.warn("Failed to load Calculator state:",e)}return null}function Io(){const e=document.getElementById("solitaire");if(e){const n=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,i)=>getComputedStyle(i).zIndex>getComputedStyle(r).zIndex?i:r);e.style.zIndex=`${parseInt(n.style.zIndex)+1}`;return}const o=V("Solitaire","",!1,"solitaire",!1,!1,{type:"integer",width:700,height:500},"App",null,"green");Lo(o).catch(console.error)}async function Lo(e){const o=e.querySelector(".p-2");o.className="p-2 bg-green-600 h-full overflow-hidden",o.style.backgroundImage="radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1) 0%, transparent 50%)",o.innerHTML="";let t=await Pn();t||(t={deck:[],waste:[],foundations:[[],[],[],[]],tableaus:[[],[],[],[],[],[],[]],score:0,moves:0,time:0,gameStarted:!1,selectedCard:null,selectedPile:null,dragElement:null});let n=null;const r=["♠","♣","♥","♦"],i=["A","2","3","4","5","6","7","8","9","10","J","Q","K"],a={"♠":"black","♣":"black","♥":"red","♦":"red"},s=document.createElement("div");s.className="flex flex-col h-full";const l=document.createElement("div");l.className="bg-gray-200 border-b border-gray-400 p-1 flex items-center space-x-4";const d=document.createElement("button");d.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",d.textContent="Game";const f=document.createElement("button");f.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",f.textContent="New Game",f.addEventListener("click",Ee);const m=document.createElement("div");m.className="text-sm font-mono ml-auto flex space-x-4",m.innerHTML='<span>Score: <span id="score">0</span></span><span>Time: <span id="time">0:00</span></span>',l.appendChild(f),l.appendChild(m);const u=document.createElement("div");u.className="flex-1 p-4 relative overflow-scroll",u.id="solitaire-game-area";const p=document.createElement("div");p.className="lg:flex justify-between mb-6";const c=document.createElement("div");c.className="flex space-x-4 mb-4 lg:mb-0";const h=document.createElement("div");h.className="w-16 h-24 border-2 border-gray-400 rounded bg-blue-800 flex items-center justify-center cursor-pointer",h.style.borderStyle="outset",h.id="deck-slot",h.addEventListener("click",U);const v=document.createElement("div");v.className="w-16 h-24 border-2 border-gray-400 rounded bg-green-700 relative",v.style.borderStyle="inset",v.id="waste-slot",c.appendChild(h),c.appendChild(v);const M=document.createElement("div");M.className="flex space-x-2";for(let C=0;C<4;C++){const g=document.createElement("div");g.className="w-16 h-24 border-2 border-gray-400 rounded bg-green-700 relative",g.style.borderStyle="inset",g.id=`foundation-${C}`,g.dataset.foundationIndex=C,g.addEventListener("click",y=>void 0),M.appendChild(g)}p.appendChild(c),p.appendChild(M);const F=document.createElement("div");F.className="flex space-x-2";for(let C=0;C<7;C++){const g=document.createElement("div");g.className="w-16 min-h-32 relative",g.id=`tableau-${C}`,g.dataset.tableauIndex=C,g.addEventListener("click",y=>void 0),F.appendChild(g)}u.appendChild(p),u.appendChild(F),s.appendChild(l),s.appendChild(u),o.appendChild(s);function T(C,g,y=!0){const b=document.createElement("div");if(b.className="card absolute w-16 h-24 border border-gray-800 rounded bg-white cursor-pointer transition-all duration-200",b.style.fontSize="10px",b.style.userSelect="none",b.style.pointerEvents="auto",b.dataset.suit=C,b.dataset.value=g,b.dataset.faceUp=y,y){const k=a[C];b.style.color=k,b.innerHTML=`
        <div class="p-1 h-full flex flex-col justify-between">
          <div class="flex justify-between">
            <span class="font-bold">${g}</span>
            <span class="text-lg">${C}</span>
          </div>
          <div class="text-center text-2xl">${C}</div>
          <div class="flex justify-between rotate-180">
            <span class="font-bold">${g}</span>
            <span class="text-lg">${C}</span>
          </div>
        </div>
      `}else b.style.background="linear-gradient(45deg, #000080, #0000cd)",b.style.color="white",b.innerHTML=`
        <div class="w-full h-full flex items-center justify-center text-xs">
          <div class="text-center">♠♥♦♣</div>
        </div>
      `;return b.addEventListener("mousedown",_),b.addEventListener("touchstart",_,{passive:!1}),b.addEventListener("dblclick",Z),b}function G(){t.deck=[];for(const C of r)for(const g of i)t.deck.push({suit:C,value:g});for(let C=t.deck.length-1;C>0;C--){const g=Math.floor(Math.random()*(C+1));[t.deck[C],t.deck[g]]=[t.deck[g],t.deck[C]]}}function R(){t.waste=[],t.foundations=[[],[],[],[]],t.tableaus=[[],[],[],[],[],[],[]];for(let C=0;C<7;C++)for(let g=0;g<=C;g++){const y=t.deck.pop();y.faceUp=g===C,t.tableaus[C].push(y)}z(),Be(t).catch(console.error)}function z(){document.querySelectorAll(".card").forEach(y=>y.remove());const C=document.getElementById("deck-slot");t.deck.length>0?(C.innerHTML="🂠",C.style.fontSize="40px",C.style.color="white"):(C.innerHTML="↻",C.style.fontSize="24px",C.style.color="white");const g=document.getElementById("waste-slot");if(g.innerHTML="",t.waste.length>0){const y=t.waste[t.waste.length-1],b=T(y.suit,y.value,!0);b.classList.add("card"),b.style.position="absolute",b.style.top="0",b.style.left="0",g.appendChild(b)}for(let y=0;y<4;y++){const b=document.getElementById(`foundation-${y}`);b.innerHTML="";const k=r[y];if(b.innerHTML=`<div class="absolute inset-0 flex items-center justify-center text-4xl text-gray-500 opacity-30">${k}</div>`,t.foundations[y].length>0){const I=t.foundations[y][t.foundations[y].length-1],A=T(I.suit,I.value,!0);A.classList.add("card"),A.style.position="absolute",A.style.top="0",A.style.left="0",b.appendChild(A)}}for(let y=0;y<7;y++){const b=document.getElementById(`tableau-${y}`);b.innerHTML="",t.tableaus[y].length===0&&(b.innerHTML='<div class="w-16 h-24 border-2 border-gray-400 border-dashed rounded bg-green-700 opacity-50"></div>'),t.tableaus[y].forEach((k,I)=>{const A=T(k.suit,k.value,k.faceUp);A.classList.add("card"),A.style.position="absolute",A.style.top=`${I*20}px`,A.style.left="0",A.style.zIndex=I+1,A.dataset.tableauIndex=y,A.dataset.cardIndex=I,b.appendChild(A)})}le()}function U(){if(t.deck.length>0){const C=t.deck.pop();C.faceUp=!0,t.waste.push(C),t.moves++}else t.waste.length>0&&(t.deck=t.waste.reverse(),t.deck.forEach(C=>C.faceUp=!1),t.waste=[],t.moves++);z(),Be(t).catch(console.error)}function _(C){let g=C.target;for(;g&&g!==document.body&&!(g.classList&&g.classList.contains("card"));)g=g.parentElement;if(!g||!g.classList.contains("card")||g.dataset.faceUp!=="true")return;C.preventDefault(),C.stopPropagation(),t.selectedCard=g,t.dragElement=g.cloneNode(!0),t.dragElement.style.position="fixed",t.dragElement.style.pointerEvents="none",t.dragElement.style.zIndex="1000",t.dragElement.style.transform="rotate(5deg)";const y=C.type==="touchstart"?C.touches[0]:C;t.dragElement.style.left=y.clientX-32+"px",t.dragElement.style.top=y.clientY-48+"px",document.body.appendChild(t.dragElement),g.style.opacity="0.5";function b(I){if(t.dragElement){const A=I.type==="touchmove"?I.touches[0]:I;t.dragElement.style.left=A.clientX-32+"px",t.dragElement.style.top=A.clientY-48+"px"}}function k(I){if(document.removeEventListener("mousemove",b),document.removeEventListener("mouseup",k),document.removeEventListener("touchmove",b),document.removeEventListener("touchend",k),t.dragElement&&(document.body.removeChild(t.dragElement),t.dragElement=null),t.selectedCard){t.selectedCard.style.opacity="1";const A=I.type==="touchend"?I.changedTouches[0]:I,S=document.elementFromPoint(A.clientX,A.clientY);oe(S),t.selectedCard=null}}document.addEventListener("mousemove",b),document.addEventListener("mouseup",k),document.addEventListener("touchmove",b,{passive:!1}),document.addEventListener("touchend",k)}function oe(C){const g=t.selectedCard;if(!g||!C)return;let y=C,b=null,k=null;for(;y&&y!==document.body;){if(y.id&&y.id.startsWith("foundation-")){b=y,k="foundation";break}if(y.dataset&&y.dataset.tableauIndex!==void 0){b=y,k="tableau";break}if(y.classList&&y.classList.contains("card")&&y.dataset.tableauIndex!==void 0){b=y.parentElement,k="tableau";break}y=y.parentElement}if(b&&k==="foundation"){const I=parseInt(b.dataset.foundationIndex);B(g,I)&&$(g)}else if(b&&k==="tableau"){const I=parseInt(b.dataset.tableauIndex);L(g,I)&&D(g,I)}}function Z(C){let g=C.target;for(;g&&!g.classList.contains("card");)g=g.parentElement;if(!(!g||g.dataset.faceUp!=="true")){for(let y=0;y<4;y++)if(B(g,y)){$(g);return}}}function B(C,g){const y=C.dataset.suit,b=C.dataset.value,k=t.foundations[g],I=r[g];if(y!==I){const A=r.indexOf(y);return A!==-1&&t.foundations[A].length===0?b==="A":!1}if(k.length===0)return b==="A";{const A=k[k.length-1],S=i.indexOf(A.value);return i.indexOf(b)===S+1}}function L(C,g){const y=C.dataset.suit,b=C.dataset.value,k=t.tableaus[g];if(k.length===0)return b==="K";const I=k[k.length-1];if(!I.faceUp)return!1;const A=a[I.suit],S=a[y],x=i.indexOf(I.value),q=i.indexOf(b);return A!==S&&q===x-1}function $(C,g){const y=C.dataset.suit,b=r.indexOf(y);if(b===-1)return;N(C);const k={suit:y,value:C.dataset.value,faceUp:!0};t.foundations[b].push(k),t.moves++,t.score+=10,z(),ie(),Be(t).catch(console.error)}function D(C,g){const y=N(C,!0);t.tableaus[g].push(...y),t.moves++,z(),Be(t).catch(console.error)}function N(C,g=!1){const y=C.dataset.suit,b=C.dataset.value;if(t.waste.length>0&&t.waste[t.waste.length-1].suit===y&&t.waste[t.waste.length-1].value===b)return[t.waste.pop()];for(let k=0;k<7;k++){const I=t.tableaus[k],A=I.findIndex(S=>S.suit===y&&S.value===b);if(A!==-1){const S=g?I.length-A:1,x=I.splice(A,S);return I.length>0&&!I[I.length-1].faceUp&&(I[I.length-1].faceUp=!0,t.score+=5,Be(t).catch(console.error)),x}}return[]}function de(C,g){}function xe(C,g){}function le(){if(document.getElementById("score").textContent=t.score,t.gameStarted){const C=Math.floor(t.time/60),g=t.time%60;document.getElementById("time").textContent=`${C}:${g.toString().padStart(2,"0")}`}}function Ee(){t.score=0,t.moves=0,t.time=0,t.gameStarted=!0,n&&clearInterval(n),n=setInterval(()=>{t.time++,le(),Be(t).catch(console.error)},1e3),G(),R(),zn().catch(console.error)}function Me(){t.gameStarted&&(n=setInterval(()=>{t.time++,le(),Be(t).catch(console.error)},1e3)),le(),z()}function ie(){t.foundations.reduce((g,y)=>g+y.length,0)===52&&(n&&clearInterval(n),Be(t).catch(console.error),setTimeout(()=>{On()},500))}const ze=new MutationObserver(C=>{C.forEach(g=>{g.removedNodes.forEach(y=>{y.id==="solitaire"&&(n&&clearInterval(n),ze.disconnect())})})});ze.observe(document.getElementById("windows-container"),{childList:!0}),!t.gameStarted||t.deck.length===0?Ee():Me()}async function Be(e){try{const o={...e,selectedCard:null,selectedPile:null,dragElement:null};await E.setItem("solitaire_gameState",o)}catch(o){console.warn("Failed to save Solitaire game state:",o);try{const t={...e,selectedCard:null,selectedPile:null,dragElement:null};E.setItemSync("solitaire_gameState",t)}catch(t){console.error("Failed to save Solitaire game state with fallback:",t)}}}async function Pn(){try{const e=await E.getItem("solitaire_gameState");if(e){const o=e;return o.selectedCard=null,o.selectedPile=null,o.dragElement=null,o}}catch(e){console.warn("Failed to load Solitaire game state:",e);try{const o=E.getItemSync("solitaire_gameState");if(o){const t=o;return t.selectedCard=null,t.selectedPile=null,t.dragElement=null,t}}catch(o){console.warn("Failed to load Solitaire game state with fallback:",o)}}return null}async function zn(){try{await E.removeItem("solitaire_gameState")}catch(e){console.warn("Failed to clear Solitaire game state:",e);try{E.removeItemSync("solitaire_gameState")}catch(o){console.error("Failed to clear Solitaire game state with fallback:",o)}}}function On(){const e=document.createElement("canvas");e.id="solitaire-win-canvas",Object.assign(e.style,{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",zIndex:9999,pointerEvents:"none"}),document.body.appendChild(e);const o=e.getContext("2d");e.width=window.innerWidth,e.height=window.innerHeight;const t=["♠","♥","♣","♦"],n=["A","2","3","4","5","6","7","8","9","10","J","Q","K"],r={"♠":"black","♣":"black","♥":"red","♦":"red"},i=[],a=.2,s=75,l=100,d=.02;let f=0,m,u=!0;const p=setInterval(()=>{if(f===52)return clearInterval(p);const h=t[f%4],v=n[Math.floor(f/4)];i.push({x:Math.random()*e.width,y:-50,vx:(Math.random()-.5)*4,vy:Math.random()*2,suit:h,value:v,color:r[h]}),f++},100);function c(){o.fillStyle=`rgba(10,100,10,${d})`,o.fillRect(0,0,e.width,e.height),i.forEach(h=>{h.vy+=a,h.x+=h.vx,h.y+=h.vy,h.y>e.height-l&&(h.y=e.height-l,h.vy*=-.7),o.fillStyle="white",o.fillRect(h.x,h.y,s,l),o.strokeStyle="#333",o.strokeRect(h.x,h.y,s,l),o.fillStyle=h.color,o.font="24px sans-serif",o.fillText(h.value+h.suit,h.x+10,h.y+30)}),u&&(m=requestAnimationFrame(c))}c(),setTimeout(()=>{u=!1,clearInterval(p),cancelAnimationFrame(m),document.body.removeChild(e),showDialogBox("Congratulations! You won!","confirmation")},8e3)}function Do(){const e=document.getElementById("chess");if(e){const n=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,i)=>getComputedStyle(i).zIndex>getComputedStyle(r).zIndex?i:r);e.style.zIndex=`${parseInt(n.style.zIndex)+1}`;return}const o=V("Guillotine Chess","",!1,"chess",!1,!1,{type:"integer",width:600,height:690},"App",null,"white");Mo(o).catch(t=>{console.error("Error initializing Chess:",t)})}async function Mo(e){const o=e.querySelector(".p-2");o.className="p-4 bg-white h-full overflow-hidden",o.innerHTML="";let t=await Zn();t||(t={board:Gt(),currentPlayer:"white",difficulty:"easy",gameOver:!1,winner:null,moveHistory:[],selectedSquare:null,possibleMoves:[],gameStarted:!0,enPassantTarget:null,halfMoveClock:0,fullMoveNumber:1});const n=document.createElement("div");n.className="flex flex-col h-full";const r=document.createElement("div");r.className="flex justify-between items-center mb-4 p-2 bg-gray-100 rounded",r.innerHTML=`
    <div class="flex items-center space-x-4">
      <span class="font-semibold">Difficulty: <span id="difficulty-dropdown-container"></span></span>
      <span class="font-semibold">Turn: <span class="text-${t.currentPlayer==="white"?"gray-800":"gray-600"}">${t.currentPlayer.charAt(0).toUpperCase()+t.currentPlayer.slice(1)}</span></span>
    </div>
    <div class="space-x-2" id="button-container">
    </div>
  `,n.appendChild(r);const a=Kn([{value:"easy",text:"Easy"},{value:"medium",text:"Medium"},{value:"hard",text:"Hard"}],t.difficulty,async m=>{t.difficulty=m,await ot(t)});a.id="difficulty-select",a.className+=" ml-1",r.querySelector("#difficulty-dropdown-container").appendChild(a);const s=Vn("New Game");s.id="new-game-btn",r.querySelector("#button-container").appendChild(s);const l=document.createElement("div");l.className="flex-1 flex items-center justify-center";const d=document.createElement("div");d.id="chess-board",d.className="grid grid-cols-8 border-4 border-gray-800",d.style.width="480px",d.style.height="480px",d.style.gap="0";for(let m=0;m<8;m++)for(let u=0;u<8;u++){const p=document.createElement("div");p.className=`chess-square flex items-center justify-center cursor-pointer text-4xl font-bold select-none ${(m+u)%2===0?"bg-amber-100":"bg-amber-600"}`,p.style.width="60px",p.style.height="60px",p.dataset.row=m,p.dataset.col=u;const c=t.board[m][u];c&&(p.textContent=Bo(c),p.style.color=c.color==="white"?"#000":"#444"),p.addEventListener("click",async()=>await Nn(m,u,t,e)),d.appendChild(p)}l.appendChild(d),n.appendChild(l);const f=document.createElement("div");f.id="status-bar",f.className="mt-4 p-2 text-center",t.gameOver?f.innerHTML=`<span class="text-lg font-bold text-green-600">Game Over! ${t.winner?t.winner.charAt(0).toUpperCase()+t.winner.slice(1)+" wins!":"Draw!"}</span>`:f.innerHTML='<span class="text-gray-600">Guillotine Chess: Capture the King to win! Kings can be captured like any other piece.</span>',n.appendChild(f),r.querySelector("#new-game-btn").addEventListener("click",async()=>{t.board=Gt(),t.currentPlayer="white",t.gameOver=!1,t.winner=null,t.moveHistory=[],t.selectedSquare=null,t.possibleMoves=[],await ot(t),Ft(t,e)}),o.appendChild(n),tt(t),t.currentPlayer==="black"&&!t.gameOver&&setTimeout(async()=>await $o(t,e),500)}function Ft(e,o){const t=o.querySelector("#difficulty-select");t&&(t.value=e.difficulty);const n=o.querySelector(".text-gray-800, .text-gray-600");n&&n.parentElement&&n.parentElement.textContent.includes("Turn:")&&(n.textContent=e.currentPlayer.charAt(0).toUpperCase()+e.currentPlayer.slice(1),n.className=e.currentPlayer==="white"?"text-gray-800":"text-gray-600"),document.querySelectorAll(".chess-square").forEach(a=>{const s=parseInt(a.dataset.row),l=parseInt(a.dataset.col),d=e.board[s][l];d?(a.textContent=Bo(d),a.style.color=d.color==="white"?"#000":"#444"):a.textContent=""});const i=o.querySelector("#status-bar");i&&(e.gameOver?i.innerHTML=`<span class="text-lg font-bold text-green-600">Game Over! ${e.winner?e.winner.charAt(0).toUpperCase()+e.winner.slice(1)+" wins!":"Draw!"}</span>`:i.innerHTML='<span class="text-gray-600">Guillotine Chess: Capture the King to win! Kings can be captured like any other piece.</span>'),e.selectedSquare=null,e.possibleMoves=[],tt(e),e.currentPlayer==="black"&&!e.gameOver&&setTimeout(async()=>await $o(e,o),500)}function Gt(){const e=Array(8).fill(null).map(()=>Array(8).fill(null)),o=["rook","knight","bishop","queen","king","bishop","knight","rook"];for(let t=0;t<8;t++)e[0][t]={type:o[t],color:"black"},e[1][t]={type:"pawn",color:"black"};for(let t=0;t<8;t++)e[6][t]={type:"pawn",color:"white"},e[7][t]={type:o[t],color:"white"};return e}function Bo(e){return{white:{king:"♔",queen:"♕",rook:"♖",bishop:"♗",knight:"♘",pawn:"♙"},black:{king:"♚",queen:"♛",rook:"♜",bishop:"♝",knight:"♞",pawn:"♟"}}[e.color][e.type]}async function Nn(e,o,t,n){if(t.gameOver||t.currentPlayer==="black")return;const r=t.board[e][o];if(t.selectedSquare){const[i,a]=t.selectedSquare;if(i===e&&a===o){t.selectedSquare=null,t.possibleMoves=[],tt(t);return}if(t.possibleMoves.some(s=>s.row===e&&s.col===o)){Ao(t,i,a,e,o),t.selectedSquare=null,t.possibleMoves=[],t.currentPlayer=t.currentPlayer==="white"?"black":"white",await ot(t),zo(t)&&(t.gameOver=!0,t.winner=Oo(t)),Ft(t,n);return}}r&&r.color===t.currentPlayer&&(t.selectedSquare=[e,o],t.possibleMoves=ct(t,e,o),tt(t))}function tt(e){document.querySelectorAll(".chess-square").forEach(t=>{const n=parseInt(t.dataset.row),r=parseInt(t.dataset.col);t.className=`chess-square flex items-center justify-center cursor-pointer text-4xl font-bold select-none ${(n+r)%2===0?"bg-amber-100":"bg-amber-600"}`,t.style.width="60px",t.style.height="60px",e.selectedSquare&&e.selectedSquare[0]===n&&e.selectedSquare[1]===r&&(t.className+=" bg-blue-300"),e.possibleMoves.some(i=>i.row===n&&i.col===r)&&(t.className+=" bg-green-300")})}function ct(e,o,t){const n=e.board[o][t];if(!n)return[];const r=[];switch(n.type){case"pawn":r.push(...Wn(e.board,o,t,n.color)),r.push(...Rn(e,o,t));break;case"rook":r.push(...Fo(e.board,o,t,n.color));break;case"knight":r.push(..._n(e.board,o,t,n.color));break;case"bishop":r.push(...To(e.board,o,t,n.color));break;case"queen":r.push(...qn(e.board,o,t,n.color));break;case"king":r.push(...jn(e.board,o,t,n.color));break}return r}function Rn(e,o,t){const n=e.board[o][t];if(n.type!=="pawn"||!e.enPassantTarget)return[];const r=[],i=n.color==="white"?-1:1,a=e.enPassantTarget.row,s=e.enPassantTarget.col;return o===a-i&&Math.abs(t-s)===1&&r.push({row:a,col:s}),r}function Wn(e,o,t,n){const r=[],i=n==="white"?-1:1,a=n==="white"?6:1;Ne(o+i,t)&&!e[o+i][t]&&(r.push({row:o+i,col:t}),o===a&&!e[o+2*i][t]&&r.push({row:o+2*i,col:t}));for(const s of[-1,1]){const l=o+i,d=t+s;Ne(l,d)&&e[l][d]&&e[l][d].color!==n&&r.push({row:l,col:d})}return r}function Fo(e,o,t,n){const r=[],i=[[0,1],[0,-1],[1,0],[-1,0]];for(const[a,s]of i)for(let l=1;l<8;l++){const d=o+l*a,f=t+l*s;if(!Ne(d,f))break;if(!e[d][f])r.push({row:d,col:f});else{e[d][f].color!==n&&r.push({row:d,col:f});break}}return r}function _n(e,o,t,n){const r=[],i=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];for(const[a,s]of i){const l=o+a,d=t+s;Ne(l,d)&&(!e[l][d]||e[l][d].color!==n)&&r.push({row:l,col:d})}return r}function To(e,o,t,n){const r=[],i=[[1,1],[1,-1],[-1,1],[-1,-1]];for(const[a,s]of i)for(let l=1;l<8;l++){const d=o+l*a,f=t+l*s;if(!Ne(d,f))break;if(!e[d][f])r.push({row:d,col:f});else{e[d][f].color!==n&&r.push({row:d,col:f});break}}return r}function qn(e,o,t,n){return[...Fo(e,o,t,n),...To(e,o,t,n)]}function jn(e,o,t,n){const r=[],i=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const[a,s]of i){const l=o+a,d=t+s;Ne(l,d)&&(!e[l][d]||e[l][d].color!==n)&&r.push({row:l,col:d})}return r}function Ne(e,o){return e>=0&&e<8&&o>=0&&o<8}function Ao(e,o,t,n,r){const i=e.board[o][t],a=e.board[n][r];if(e.enPassantTarget=null,a&&a.type==="king"&&(e.gameOver=!0,e.winner=i.color),i.type==="pawn"&&t!==r&&!a){const s=i.color==="white"?n+1:n-1;e.board[s][r]=null}if(i.type==="pawn"&&Math.abs(n-o)===2){const s=i.color==="white"?n+1:n-1;e.enPassantTarget={row:s,col:r}}i.type==="pawn"&&(n===0||n===7)&&(i.type="queen"),i.type==="pawn"||a?e.halfMoveClock=0:e.halfMoveClock++,i.color==="black"&&e.fullMoveNumber++,e.board[n][r]=i,e.board[o][t]=null,e.moveHistory.push({from:{row:o,col:t},to:{row:n,col:r},piece:{...i},captured:a,enPassantTarget:e.enPassantTarget,halfMoveClock:e.halfMoveClock})}async function $o(e,o){let t;switch(e.difficulty){case"easy":t=Un(e.board,"black");break;case"medium":t=wt(e.board,"black",1);break;case"hard":t=wt(e.board,"black",2);break}t&&(Ao(e,t.from.row,t.from.col,t.to.row,t.to.col),e.currentPlayer="white",zo(e)&&(e.gameOver=!0,e.winner=Oo(e)),await ot(e),Ft(e,o))}function Un(e,o){const t=[];for(let n=0;n<8;n++)for(let r=0;r<8;r++){const i=e[n][r];if(i&&i.color===o){const s=ct({board:e,enPassantTarget:null},n,r);for(const l of s)t.push({from:{row:n,col:r},to:l})}}return t.length>0?t[Math.floor(Math.random()*t.length)]:null}function wt(e,o,t){const n=[];for(let r=0;r<8;r++)for(let i=0;i<8;i++){const a=e[r][i];if(a&&a.color===o){const l=ct({board:e,enPassantTarget:null},r,i);for(const d of l)n.push({from:{row:r,col:i},to:d,score:Hn(e,{row:r,col:i},d,o,t)})}}return n.length===0?null:(n.sort((r,i)=>i.score-r.score),n[0])}function Hn(e,o,t,n,r){const i=e.map(d=>d.map(f=>f?{...f}:null)),a=i[o.row][o.col],s=i[t.row][t.col];i[t.row][t.col]=a,i[o.row][o.col]=null;let l=0;if(s&&(l+=Po(s.type)),l+=Gn(i,n),r>1){const f=wt(i,n==="white"?"black":"white",r-1);f&&(l-=f.score)}return l}function Po(e){return{pawn:1,knight:3,bishop:3,rook:5,queen:9,king:100}[e]||0}function Gn(e,o){let t=0;for(let n=0;n<8;n++)for(let r=0;r<8;r++){const i=e[n][r];i&&i.color===o&&(t+=Po(i.type),n>=3&&n<=4&&r>=3&&r<=4&&(t+=.1))}return t}function zo(e){if(e.gameOver)return!0;let o=!1,t=!1;for(let r=0;r<8;r++)for(let i=0;i<8;i++){const a=e.board[r][i];a&&a.type==="king"&&(a.color==="white"&&(o=!0),a.color==="black"&&(t=!0))}if(!o)return e.gameOver=!0,e.winner="black",!0;if(!t)return e.gameOver=!0,e.winner="white",!0;const n=e.currentPlayer;return!Yn(e,n)||e.halfMoveClock>=100?(e.gameOver=!0,e.winner="draw",!0):!1}function Yn(e,o){for(let t=0;t<8;t++)for(let n=0;n<8;n++){const r=e.board[t][n];if(r&&r.color===o&&ct(e,t,n).length>0)return!0}return!1}function Oo(e){return e.winner}async function ot(e){try{await E.setItem("chessGameState",e)}catch(o){console.warn("Failed to save chess game state:",o)}}async function Zn(){try{const e=await E.getItem("chessGameState");return e||null}catch(e){return console.warn("Failed to load chess game state:",e),null}}function Vn(e){const o=document.createElement("button");o.className="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2";const t=document.createElement("span");return t.className="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3",t.textContent=e,o.appendChild(t),o}function Kn(e,o=null,t=null){const n=document.createElement("select");return n.className="bg-white border-t-2 border-l-2 border-black border-b-2 border-r-2 border-gray-300 px-2 py-1",e.forEach(r=>{const i=document.createElement("option");typeof r=="string"?(i.value=r,i.textContent=r):(i.value=r.value,i.textContent=r.text||r.value),o!==null&&i.value===o&&(i.selected=!0),n.appendChild(i)}),t&&typeof t=="function"&&n.addEventListener("change",r=>t(r.target.value,r)),n}function No(){const e=document.getElementById("bombbroomer");if(e){const n=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,i)=>getComputedStyle(i).zIndex>getComputedStyle(r).zIndex?i:r);e.style.zIndex=`${parseInt(n.style.zIndex)+1}`;return}const o=V("Bombbroomer","",!1,"bombbroomer",!1,!1,{type:"integer",width:400,height:490},"App",null,"gray");Ro(o).catch(t=>{console.error("Error initializing Bombbroomer:",t)})}async function Ro(e){const o=e.querySelector(".p-2");o.className="p-2 bg-gray-200 h-full overflow-hidden",o.innerHTML="";let t=await Xn();t||(t={grid:[],gameStarted:!1,gameOver:!1,gameWon:!1,bombs:10,flaggedCount:0,rows:9,cols:9,firstClick:!0,timer:0,timerInterval:null});const n=document.createElement("div");n.className="flex flex-col h-full bg-gray-200 pb-4";const r=document.createElement("div");r.className="bg-gray-200 border-b-2 border-gray-400 p-1 flex items-center space-x-4",r.style.borderStyle="inset";const i=document.createElement("button");i.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",i.textContent="Game";const a=document.createElement("button");a.className="px-2 py-1 hover:bg-gray-300 text-sm border border-transparent hover:border-gray-400",a.textContent="New Game",a.addEventListener("click",async()=>await _()),r.appendChild(a);const s=document.createElement("div");s.className="bg-gray-200 border-2 border-gray-400 p-2 flex justify-between items-center",s.style.borderStyle="inset";const l=document.createElement("div");l.className="bg-black text-red-500 px-2 py-1 font-mono text-lg border-2 border-gray-500",l.style.borderStyle="inset",l.id="bomb-counter",l.textContent="010";const d=document.createElement("button");d.className="w-8 h-8 bg-gray-200 border-2 border-gray-400 text-lg hover:bg-gray-300",d.style.borderStyle="outset",d.id="face-button",d.textContent="🙂",d.addEventListener("click",async()=>await _());const f=document.createElement("div");f.className="bg-black text-red-500 px-2 py-1 font-mono text-lg border-2 border-gray-500",f.style.borderStyle="inset",f.id="timer-display",f.textContent="000",s.appendChild(l),s.appendChild(d),s.appendChild(f);const m=document.createElement("div");m.className="flex-1 p-4 flex items-center justify-center";const u=document.createElement("div");u.className="grid grid-cols-9 gap-0 border-2 border-gray-400 bg-gray-300",u.style.borderStyle="inset",u.id="game-grid",m.appendChild(u),n.appendChild(r),n.appendChild(s),n.appendChild(m),o.appendChild(n);function p(){t.grid=[],t.gameStarted=!1,t.gameOver=!1,t.gameWon=!1,t.flaggedCount=0,t.firstClick=!0,t.timer=0,t.timerInterval&&clearInterval(t.timerInterval);for(let B=0;B<t.rows;B++){t.grid[B]=[];for(let L=0;L<t.cols;L++)t.grid[B][L]={isBomb:!1,isRevealed:!1,isFlagged:!1,neighborCount:0}}U(),v()}function c(B,L){let $=0;for(;$<t.bombs;){const D=Math.floor(Math.random()*t.rows),N=Math.floor(Math.random()*t.cols);!t.grid[D][N].isBomb&&!(D===B&&N===L)&&(t.grid[D][N].isBomb=!0,$++)}for(let D=0;D<t.rows;D++)for(let N=0;N<t.cols;N++)t.grid[D][N].isBomb||(t.grid[D][N].neighborCount=h(D,N))}function h(B,L){let $=0;for(let D=Math.max(0,B-1);D<=Math.min(t.rows-1,B+1);D++)for(let N=Math.max(0,L-1);N<=Math.min(t.cols-1,L+1);N++)(D!==B||N!==L)&&t.grid[D][N].isBomb&&$++;return $}function v(){const B=document.getElementById("game-grid");B.innerHTML="";for(let L=0;L<t.rows;L++)for(let $=0;$<t.cols;$++){const D=document.createElement("button");D.className="w-8 h-8 border border-gray-500 bg-gray-200 text-sm font-bold flex items-center justify-center",D.style.borderStyle="outset",D.dataset.row=L,D.dataset.col=$;const N=t.grid[L][$];if(N.isRevealed){if(D.style.borderStyle="inset",D.className=D.className.replace("bg-gray-200","bg-gray-300"),N.isBomb)D.textContent="💣",D.style.backgroundColor=t.gameOver?"#ff0000":"#gray-300";else if(N.neighborCount>0){D.textContent=N.neighborCount;const de=["","#0000ff","#008000","#ff0000","#800080","#800000","#008080","#000000","#808080"];D.style.color=de[N.neighborCount]||"#000000"}}else N.isFlagged&&(D.textContent="🚩");D.addEventListener("click",async de=>await M(de,L,$)),D.addEventListener("contextmenu",async de=>await F(de,L,$)),B.appendChild(D)}}async function M(B,L,$){if(B.preventDefault(),t.gameOver||t.gameWon)return;const D=t.grid[L][$];D.isRevealed||D.isFlagged||(t.firstClick&&(c(L,$),t.firstClick=!1,t.gameStarted=!0,G()),D.isBomb?await R():(T(L,$),await z()),v(),await qe(t))}async function F(B,L,$){if(B.preventDefault(),t.gameOver||t.gameWon)return;const D=t.grid[L][$];D.isRevealed||(D.isFlagged?(D.isFlagged=!1,t.flaggedCount--):(D.isFlagged=!0,t.flaggedCount++),U(),v(),await qe(t))}function T(B,L){const $=t.grid[B][L];if(!($.isRevealed||$.isFlagged)&&($.isRevealed=!0,$.neighborCount===0))for(let D=Math.max(0,B-1);D<=Math.min(t.rows-1,B+1);D++)for(let N=Math.max(0,L-1);N<=Math.min(t.cols-1,L+1);N++)(D!==B||N!==L)&&T(D,N)}function G(){t.timerInterval=setInterval(async()=>{t.timer++,U(),await qe(t)},1e3)}async function R(){t.gameOver=!0,t.timerInterval&&clearInterval(t.timerInterval);for(let B=0;B<t.rows;B++)for(let L=0;L<t.cols;L++)t.grid[B][L].isBomb&&(t.grid[B][L].isRevealed=!0);await qe(t),document.getElementById("face-button").textContent="😵",setTimeout(()=>{showDialogBox("Game Over! Try again?","confirmation")},500)}async function z(){let B=0;for(let $=0;$<t.rows;$++)for(let D=0;D<t.cols;D++)t.grid[$][D].isRevealed&&!t.grid[$][D].isBomb&&B++;const L=t.rows*t.cols-t.bombs;B===L&&(t.gameWon=!0,t.timerInterval&&clearInterval(t.timerInterval),await qe(t),document.getElementById("face-button").textContent="😎",setTimeout(()=>{showDialogBox("Congratulations! You won!","confirmation")},500))}function U(){const B=document.getElementById("bomb-counter"),L=document.getElementById("timer-display"),$=t.bombs-t.flaggedCount;B.textContent=$.toString().padStart(3,"0"),L.textContent=Math.min(t.timer,999).toString().padStart(3,"0")}async function _(){document.getElementById("face-button").textContent="🙂",p(),await Jn()}function oe(){const B=document.getElementById("face-button");t.gameOver?B.textContent="😵":t.gameWon?B.textContent="😎":B.textContent="🙂",t.gameStarted&&!t.gameOver&&!t.gameWon&&G(),U(),v()}const Z=new MutationObserver(B=>{B.forEach(L=>{L.removedNodes.forEach($=>{$.id==="bombbroomer"&&(t.timerInterval&&clearInterval(t.timerInterval),Z.disconnect())})})});Z.observe(document.getElementById("windows-container"),{childList:!0}),t.grid.length===0?_():oe()}async function qe(e){try{const o={...e,timerInterval:null};await E.setItem("bombbroomer_gameState",o)}catch(o){console.warn("Failed to save Bombbroomer game state:",o)}}async function Xn(){try{const e=await E.getItem("bombbroomer_gameState");if(e){const o=e;return o.timerInterval=null,o}}catch(e){console.warn("Failed to load Bombbroomer game state:",e)}return null}async function Jn(){try{await E.removeItem("bombbroomer_gameState")}catch(e){console.warn("Failed to clear Bombbroomer game state:",e)}}function Wo(){const e=document.getElementById("mediaplayer");if(e){const n=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,i)=>getComputedStyle(i).zIndex>getComputedStyle(r).zIndex?i:r);e.style.zIndex=`${parseInt(n.style.zIndex)+1}`;return}const o=V("Media Player","",!1,"mediaplayer",!1,!1,{type:"integer",width:500,height:400},"App",null,"gray");_o(o).catch(console.error)}async function _o(e){const o=e.querySelector(".p-2");o.className="p-2 bg-gray-200 h-full flex",o.innerHTML="";let t=await Tt();t?((!isFinite(t.volume)||t.volume<0||t.volume>1)&&(t.volume=.5),(!isFinite(t.currentTime)||t.currentTime<0)&&(t.currentTime=0),Number.isInteger(t.currentTrackIndex)||(t.currentTrackIndex=-1),Array.isArray(t.playlist)||(t.playlist=[])):t={currentTrackIndex:-1,currentTime:0,volume:.5,isPlaying:!1,playlist:[]};const n=document.createElement("div");n.className="w-1/2 bg-white border-2 border-gray-400 mr-2 flex flex-col",n.innerHTML=`
    <div class="bg-gray-300 border-b-2 border-gray-400 p-2 flex justify-between items-center">
      <div class="text-xs font-bold">Media Playlist:</div>
      <button id="add-song-btn" onclick="setTimeout(function(){toggleButtonActiveState('add-song-btn', 'Add Media')}, 1000);toggleButtonActiveState('add-song-btn', 'Adding media...');" class="bg-gray-200 border-t-2 border-l-2 border-gray-300"><span class="border-b-2 border-r-2 border-black block h-full w-full py-1 px-2 text-xs">Add</span></button>
      <input type="file" id="song-file-input" class="hidden" accept="audio/*,video/*">
    </div>
    <div id="playlist-container" class="flex-1 p-2 overflow-y-auto space-y-1">
      <div class="text-xs text-gray-500">Loading playlist...</div>
    </div>
  `;const r=document.createElement("div");r.className="w-1/2 flex flex-col";const i=document.createElement("div");i.id="media-container",i.className="w-full bg-black mb-2 flex items-center justify-center min-h-32",i.innerHTML=`
    <audio id="audio-player" class="w-full hidden"></audio>
    <video id="video-player" class="w-full max-h-48 hidden" controls></video>
    <div id="audio-placeholder" class="text-white text-2xl p-4 flex items-center justify-center" style="display: none;">🎵 🎶 🎵</div>
    <div id="media-placeholder" class="text-white text-sm p-4">No media selected</div>
  `,r.appendChild(i);const a=document.createElement("div");a.className="bg-gray-300 border-2 border-gray-400 p-3 mb-2";const s=document.createElement("div");s.className="text-center mb-2",s.innerHTML=`
    <div id="current-track-name" class="font-bold text-sm">Media Player</div>
    <div id="current-time" class="text-xs text-gray-600">Ready to play</div>
  `;const l=document.createElement("div");l.className="mb-3",l.innerHTML=`
    <div id="progress-container" class="w-full h-2 bg-gray-400 border border-gray-500 cursor-pointer">
      <div id="progress-bar" class="h-full bg-blue-500" style="width: 0%"></div>
    </div>
  `;const d=document.createElement("div");d.className="flex justify-center space-x-2 mb-2",d.innerHTML=`
    <button id="prev-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs">⏮</button>
    <button id="play-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs">▶</button>
    <button id="stop-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs">⏹</button>
    <button id="next-btn" class="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs">⏭</button>
  `;const f=document.createElement("div");f.className="flex items-center justify-center space-x-2",f.innerHTML=`
    <span class="text-xs">🔊</span>
    <input type="range" id="volume-control" min="0" max="1" step="0.01" value="0.5" class="w-20">
    <span class="text-xs" id="volume-display">50%</span>
  `,a.appendChild(s),a.appendChild(l),a.appendChild(d),a.appendChild(f),r.appendChild(a),o.appendChild(n),o.appendChild(r);const m=o.querySelector("#audio-player"),u=o.querySelector("#video-player");let p=t.currentTrackIndex,c=t.playlist;const h=o.querySelector("#play-btn"),v=o.querySelector("#next-btn"),M=o.querySelector("#prev-btn"),F=o.querySelector("#stop-btn"),T=o.querySelector("#volume-control"),G=o.querySelector("#progress-bar"),R=o.querySelector("#progress-container"),z=o.querySelector("#add-song-btn"),U=o.querySelector("#song-file-input");let _;const oe="media_player_db",Z="songs";function B(){const S=indexedDB.open(oe,1);S.onerror=x=>{console.error("Database error: ",x.target.errorCode)},S.onupgradeneeded=x=>{_=x.target.result,_.createObjectStore(Z,{keyPath:"id",autoIncrement:!0}).createIndex("name","name",{unique:!1})},S.onsuccess=x=>{_=x.target.result,$().catch(console.error)}}function L(S){const x=S.name.split(".").pop().toLowerCase();nn(S.name,"","C://Media",x,S).then(q=>{q?$().catch(console.error):console.error("🎵 MEDIAPLAYER: Failed to add song to file system")}).catch(q=>{console.error("🎵 MEDIAPLAYER: Error adding song to file system:",q)})}async function $(){c=[];try{const q=Y().folders["C://Media"];if(q){const ae=Object.entries(q).filter(([P,ue])=>P!=="contents"&&ue&&typeof ue=="object"&&ue.type).map(([P,ue])=>ue).map(async P=>{if(P.content_type&&["mp3","wav","audio","mp4","webm","avi","mov"].includes(P.content_type)){const ue=["mp4","webm","avi","mov"].includes(P.content_type),ce={name:P.name,file:P.file,id:P.id,isFileSystem:!0,source:"filesystem",isVideo:ue,contentType:P.content_type,type:P.file&&P.file.type?P.file.type:ue?"video/"+P.content_type:"audio/"+P.content_type};if(P.storageLocation==="indexeddb"&&!P.dataURL||!P.dataURL&&!P.file&&!P.path&&P.id&&P.id.startsWith("file-"))try{const be=await storage.getItem(`file_data_${P.id}`);if(be){P.dataURL=be,ce.dataURL=be;const me=Y();me.folders["C://Media"]&&me.folders["C://Media"][P.id]&&(me.folders["C://Media"][P.id].dataURL=be,me.folders["C://Media"][P.id].tempObjectURL=null,setFileSystemState(me))}else{console.warn("🎵 MEDIAPLAYER: No stored data found in IndexedDB for:",P.name,"File ID:",P.id);const me=`file_data_${P.name}`,Se=await storage.getItem(me);Se&&(P.dataURL=Se,ce.dataURL=Se)}}catch(be){console.error("🎵 MEDIAPLAYER: Failed to load data from IndexedDB for:",P.name,be)}return P.isDefault&&P.path?(ce.path=P.path,ce.isDefault=!0):P.dataURL||ce.dataURL?ce.dataURL=P.dataURL||ce.dataURL:P.file?ce.file=P.file:P.tempObjectURL?ce.tempObjectURL=P.tempObjectURL:ce.path=`media/${P.name}`,ce}return null});c=(await Promise.all(ae)).filter(P=>P!==null)}}catch(x){console.error("Could not load songs from file system:",x)}c.some(x=>x.name==="too_many_screws_final.mp3")||c.unshift({name:"too_many_screws_final.mp3",path:"media/too_many_screws_final.mp3",isDefault:!0,id:"fallback-default-song",source:"fallback"}),D(),c.length>0&&(t.currentTrackIndex>=0&&t.currentTrackIndex<c.length?(N(t.currentTrackIndex),m.addEventListener("loadedmetadata",()=>{m.currentTime=t.currentTime||0},{once:!0})):N(0))}function D(){const S=o.querySelector("#playlist-container");S.innerHTML="",c.forEach((x,q)=>{const J=document.createElement("div");J.className="text-xs cursor-pointer hover:bg-gray-100 p-1 rounded";const ae=x.name||x.id||"Unknown Track";x.name||console.warn("🎵 MEDIAPLAYER: Track missing name property, using fallback:",ae,"Track:",x),J.textContent=ae,J.dataset.index=q,J.addEventListener("click",()=>{N(q),xe()}),S.appendChild(J)})}function N(S){if(S<0||S>=c.length)return;p=S,t.currentTrackIndex=p;const x=c[S],q=x.type&&x.type.startsWith("video/")||x.contentType&&["mp4","webm","avi","mov"].includes(x.contentType)||x.isVideo===!0||x.file&&x.file.type&&x.file.type.startsWith("video/");m.style.display="none",u.style.display="none";const J=o.querySelector("#media-placeholder"),ae=o.querySelector("#audio-placeholder");J&&(J.style.display="none"),ae&&(ae.style.display="none");const K=q?u:m,P=q?m:u;if(q?K.style.display="block":ae&&(ae.style.display="flex"),P.pause(),P.currentTime=0,x.isDefault||x.path&&!x.file&&!x.dataURL)K.src=x.path;else if(x.dataURL)K.src=x.dataURL;else if(x.tempObjectURL)K.src=x.tempObjectURL;else if(x.isFileSystem&&x.file){const ue=URL.createObjectURL(x.file);K.src=ue}else if(x.file){const ue=URL.createObjectURL(x.file);K.src=ue}else{console.error("Unable to load track - no valid source:",x);return}o.querySelector("#current-track-name").textContent=x.name||x.id||"Unknown Track",de(),ke(t).catch(console.error)}function de(){o.querySelectorAll("#playlist-container > div").forEach((x,q)=>{q===p?x.classList.add("bg-blue-200"):x.classList.remove("bg-blue-200")})}function xe(){const x=le().play();x!==void 0&&x.catch(q=>{q.name==="AbortError"||console.error("Playback failed:",q)})}function le(){return u.style.display==="block"?u:m}function Ee(){const S=le();S.paused?xe():S.pause()}function Me(){const S=le();S.pause(),S.currentTime=0}function ie(){const S=(p+1)%c.length;N(S),xe()}function ze(){const S=(p-1+c.length)%c.length;N(S),xe()}function C(){const S=le();S.volume=T.value;const x=S===m?u:m;x.volume=T.value,t.volume=S.volume,o.querySelector("#volume-display").textContent=`${Math.round(T.value*100)}%`,ke(t).catch(console.error)}function g(){const S=le();if(S.duration){const x=S.currentTime/S.duration*100;G.style.width=`${x}%`;const q=J=>{const ae=Math.floor(J/60),K=Math.floor(J%60).toString().padStart(2,"0");return`${ae}:${K}`};o.querySelector("#current-time").textContent=`${q(S.currentTime)} / ${q(S.duration)}`}}function y(S){const x=le();if(!x.duration)return;const q=S.offsetX,J=R.offsetWidth;x.currentTime=q/J*x.duration}h.addEventListener("click",Ee),m.addEventListener("play",()=>h.textContent="⏸"),m.addEventListener("pause",()=>h.textContent="▶"),m.addEventListener("ended",ie),m.addEventListener("timeupdate",g),m.addEventListener("volumechange",()=>{T.value=m.volume,C()}),u.addEventListener("play",()=>h.textContent="⏸"),u.addEventListener("pause",()=>h.textContent="▶"),u.addEventListener("ended",ie),u.addEventListener("timeupdate",g),u.addEventListener("volumechange",()=>{T.value=u.volume,C()}),m.addEventListener("error",S=>{console.error("🎵 MEDIAPLAYER: Audio error:",S.target.error,"Source:",m.src)}),u.addEventListener("error",S=>{console.error("🎵 MEDIAPLAYER: Video error:",S.target.error,"Source:",u.src)}),m.addEventListener("loadstart",()=>{}),u.addEventListener("loadstart",()=>{}),F.addEventListener("click",Me),v.addEventListener("click",ie),M.addEventListener("click",ze),T.addEventListener("input",C),R.addEventListener("click",y),z.addEventListener("click",()=>U.click()),U.addEventListener("change",S=>{const x=S.target.files[0];x&&L(x)});const b=isFinite(t.volume)&&t.volume>=0&&t.volume<=1?t.volume:.5;T.value=b,m.volume=b,u.volume=b,o.querySelector("#volume-display").textContent=`${Math.round(b*100)}%`,t.volume=b,m.addEventListener("timeupdate",()=>{m.style.display==="block"&&(t.currentTime=m.currentTime,Math.floor(m.currentTime)%5===0&&ke(t).catch(console.error))}),m.addEventListener("play",()=>{m.style.display==="block"&&(t.isPlaying=!0,ke(t).catch(console.error))}),m.addEventListener("pause",()=>{m.style.display==="block"&&(t.isPlaying=!1,ke(t).catch(console.error))}),u.addEventListener("timeupdate",()=>{u.style.display==="block"&&(t.currentTime=u.currentTime,Math.floor(u.currentTime)%5===0&&ke(t).catch(console.error))}),u.addEventListener("play",()=>{u.style.display==="block"&&(t.isPlaying=!0,ke(t).catch(console.error))}),u.addEventListener("pause",()=>{u.style.display==="block"&&(t.isPlaying=!1,ke(t).catch(console.error))}),B(),C(),t.currentTrackIndex>=0&&c.length>t.currentTrackIndex&&setTimeout(async()=>{await qo()},500),window.refreshMediaPlayerPlaylist=function(){_&&$().catch(console.error)};const k=setInterval(()=>{try{const x=Y().folders["C://Media"];if(x){const q=Object.values(x).filter(K=>K.content_type&&["mp3","wav","audio","mp4","webm","avi","mov"].includes(K.content_type)).map(K=>K.name),J=c.filter(K=>K.source==="filesystem"||K.isFileSystem).map(K=>K.name);q.filter(K=>!J.includes(K)).length>0&&$().catch(console.error)}}catch{}},1e4),I=e,A=I.remove;I.remove=function(){return clearInterval(k),window.refreshMediaPlayerPlaylist===window.refreshMediaPlayerPlaylist&&delete window.refreshMediaPlayerPlaylist,A.call(this)}}async function qo(){const e=await Tt();if(!(!e||e.currentTrackIndex<0)&&playlist.length>e.currentTrackIndex){let t=function(){const n=getActivePlayer();e.currentTime>0&&(n.currentTime=e.currentTime),e.isPlaying&&safePlay()};var o=t;loadTrack(e.currentTrackIndex),audio.addEventListener("loadedmetadata",function n(){audio.style.display==="block"&&t(),audio.removeEventListener("loadedmetadata",n)}),video.addEventListener("loadedmetadata",function n(){video.style.display==="block"&&t(),video.removeEventListener("loadedmetadata",n)})}}async function ke(e){try{await storage.setItem("mediaplayer_state",e)}catch(o){console.warn("Failed to save Media Player state:",o);try{storage.setItemSync("mediaplayer_state",e)}catch(t){console.error("Failed to save Media Player state with fallback:",t)}}}async function Tt(){try{const e=await storage.getItem("mediaplayer_state");if(e)return e}catch(e){console.warn("Failed to load Media Player state:",e);try{const o=storage.getItemSync("mediaplayer_state");if(o)return o}catch(o){console.warn("Failed to load Media Player state with fallback:",o)}}return null}async function Qn(){try{await storage.removeItem("mediaplayer_state")}catch(e){console.warn("Failed to clear Media Player state:",e);try{storage.removeItemSync("mediaplayer_state")}catch(o){console.error("Failed to clear Media Player state with fallback:",o)}}}function vt(e){const o=document.getElementById(e);if(o){const n=[...document.querySelectorAll("*")].filter(r=>getComputedStyle(r).zIndex>100&&getComputedStyle(r).zIndex<1e3).reduce((r,i)=>getComputedStyle(i).zIndex>getComputedStyle(r).zIndex?i:r);o.style.zIndex=`${parseInt(n.style.zIndex)+1}`;return}e==="mailbox"&&ho(),e==="tubestream"&&bo(),e==="watercolour"&&vo(),e==="calculator"&&Co(),e==="solitaire"&&Io(),e==="chess"&&Do(),e==="bombbroomer"&&No(),e==="mediaplayer"&&Wo(),e==="compostbin"&&mo(),e==="storage"&&Xo()}function dt(e){let o=!1,t,n,r=5,i=0;e.addEventListener("pointerdown",function(a){if(!a.isPrimary)return;a.preventDefault(),o=!1,t=a.clientX,n=a.clientY,i=Date.now();const s=e.getBoundingClientRect(),l=a.clientX-s.left,d=a.clientY-s.top;function f(u){if(!u.isPrimary)return;const p=Math.sqrt(Math.pow(u.clientX-t,2)+Math.pow(u.clientY-n,2));!o&&p>r&&(o=!0,e.classList.add("dragging"),e.style.zIndex="1000",document.querySelectorAll(".desktop-folder-icon[data-item-id]").forEach(c=>{const h=xt(c.getAttribute("data-item-id")),v=c.getAttribute("data-item-id");(h&&h.type==="folder"||v==="compostbin")&&c!==e&&c.classList.add("drag-hover-target")}),document.body.style.overflow="hidden"),o&&(e.style.left=u.clientX-l+"px",e.style.top=u.clientY-d+"px",e.style.position="absolute",Yt(e),or(u.clientX,u.clientY,e))}async function m(u){if(u.isPrimary){if(document.removeEventListener("pointermove",f),document.removeEventListener("pointerup",m),document.removeEventListener("pointercancel",m),o){e.style.zIndex="",e.classList.remove("dragging");const p=e.style.pointerEvents;e.style.pointerEvents="none";const c=document.elementFromPoint(u.clientX,u.clientY);e.style.pointerEvents=p;const h=c?c.closest(".desktop-folder-icon[data-item-id]"):null,v=c?c.closest(".file-explorer-window"):null;if(h&&h!==e){const M=h.getAttribute("data-item-id"),F=xt(M),T=e.getAttribute("data-item-id");if(T!==M){if(M==="compostbin"){await Bn(T,"C://Desktop");return}else if(F&&F.type==="folder"){await At(T,M);return}}}else if(v){const M=e.getAttribute("data-item-id"),F=v.getAttribute("data-current-path");if(F&&M){await Et(M,F);return}}Yt(e),Q[e.id]={left:e.style.left,top:e.style.top},O()}document.querySelectorAll(".drag-hover-target").forEach(p=>{p.classList.remove("drag-hover-target")}),document.querySelectorAll(".desktop-folder-icon").forEach(p=>{p.classList.remove("dragover")}),document.querySelectorAll(".file-explorer-window").forEach(p=>{p.classList.remove("dragover")}),document.body.style.overflow="",o=!1}}document.addEventListener("pointermove",f),document.addEventListener("pointerup",m),document.addEventListener("pointercancel",m)}),e.addEventListener("click",function(a){const s=Date.now()-i;!o&&s>100&&(document.querySelectorAll(".draggable-icon").forEach(l=>l.classList.remove("bg-gray-50")),e.classList.add("bg-gray-50"))})}function er(){const e=document.getElementById("bgColorInput").value,o=document.getElementById("bgImageInput").value.trim(),t=document.getElementById("clockSecondsInput").checked;ee.bgColor=e,ee.bgImage=o,ee.clockSeconds=t,jo(),O()}async function X(){const e=document.getElementById("desktop-icons");e.innerHTML="",document.getElementById("windows-container").querySelectorAll(".desktop-folder-icon").forEach(p=>{p.parentElement&&p.parentElement.classList.contains("draggable-icon")&&p.parentElement.remove()});let n=await Ie();if(!n||!n.folders||!n.folders["C://Desktop"]){if(typeof kt=="function")await kt(),n=await Ie();else if(console.warn("initializeAppState not available, using default fileSystemState"),typeof window.fileSystemState<"u"?n=window.fileSystemState:typeof ve<"u"?n=ve:(console.error("No fileSystemState available, creating minimal fallback structure"),n={folders:{"C://":{Documents:{id:"Documents",name:"Documents",type:"folder",fullPath:"C://Documents",contents:{}},Desktop:{id:"Desktop",name:"Desktop",type:"folder",fullPath:"C://Desktop",contents:{compostbin:{id:"compostbin",name:"Compost Bin",type:"app",fullPath:"C://Desktop/compostbin",content_type:"html",contents:{},icon:"./image/compost-bin.png"}}},Media:{id:"Media",name:"Media",type:"folder",fullPath:"C://Media",contents:{}}},"A://":{},"D://":{}}}),typeof re=="function")try{re(n)}catch(p){console.warn("Failed to update global file system state:",p)}}if(!n||!n.folders||!n.folders["C://Desktop"]){console.error("File system structure is still invalid after initialization attempts:",n);return}const r=n.folders["C://Desktop"]||{};r||(n.folders["C://Desktop"]={});const i=96,a=128,s=16,l=16,d=16,f=window.innerHeight-80,m=Math.floor((f-d)/(a+s));let u=0;Object.values(r).forEach(p=>{const c=document.createElement("div");c.id="icon-"+p.id,c.className="flex flex-col items-center cursor-pointer draggable-icon desktop-folder-icon z-10 h-32 truncate-ellipsis w-24 text-wrap absolute";let h=p.type==="folder"?"image/folder.png":"image/file.png";if(p.icon?h=p.icon:p.icon_url&&(h=p.icon_url),c.setAttribute("data-item-id",p.id),c.setAttribute("data-current-path","C://Desktop"),p.type==="ugc-file"||p.type==="file"?(c.addEventListener("dblclick",v=>{v.stopPropagation(),et(p.id,v)}),c.addEventListener("mobiledbltap",v=>{v.stopPropagation(),et(p.id,v)})):p.type==="app"?(c.dataset.isVendorApplication=!0,h=p.icon,c.addEventListener("dblclick",()=>vt(p.id)),c.addEventListener("mobiledbltap",()=>vt(p.id))):p.type==="folder"?(c.addEventListener("dblclick",()=>Ue(p.id)),c.addEventListener("mobiledbltap",()=>Ue(p.id))):p.type==="shortcut"&&(c.dataset.url=p.url,h=p.icon_url,c.addEventListener("dblclick",()=>bt(c)),c.addEventListener("mobiledbltap",()=>bt(c))),c.innerHTML=`
      <img src="${h}" alt="${p.name}" class="mb-1 p-1 h-16 w-16 desktop-folder-icon" />
      <span class="text-xs text-black max-w-20 text-center desktop-folder-icon truncate block">${p.name}</span>
    `,Q[c.id]){const v=Q[c.id];c.style.left=v.left,c.style.top=v.top}else{const v=Math.floor(u/m),M=u%m,F=l+v*(i+s),T=d+M*(a+s);c.style.left=F+"px",c.style.top=T+"px",u++}e.appendChild(c),dt(c),Uo(c)}),typeof fe=="function"&&fe()}function jo(){const e=document.getElementById("desktop");ee.bgColor&&(e.style.backgroundColor=ee.bgColor),ee.bgImage?(e.style.backgroundImage=`url(${ee.bgImage})`,e.style.backgroundSize="cover",e.style.backgroundRepeat="no-repeat"):e.style.backgroundImage="none"}function tr(){return`
    <div class="space-y-4">
      <div>
        <label class="block text-sm">Desktop Background Color:</label>
        <input id="bgColorInput" type="color" value="${ee.bgColor}" class="border" />
      </div>
      <div>
        <label class="block text-sm">Background Image URL:</label>
        <input id="bgImageInput" type="text" placeholder="Enter image URL" value="${ee.bgImage}" class="border w-full" />
      </div>
      <div>
        <label class="block text-sm">Show Seconds on Clock:</label>
        <input id="clockSecondsInput" type="checkbox" ${ee.clockSeconds?"checked":""} />
      </div>
      <button id="settings-apply-button" class="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2">
        <span class="border-b-2 border-r-2 border-black block h-full w-full py-1.5 px-3">Apply</span>
      </button>
    </div>
  `}function Yt(e){const t=document.getElementById("desktop").getBoundingClientRect(),n=e.getBoundingClientRect();let r=parseInt(e.style.left)||0,i=parseInt(e.style.top)||0;r=Math.max(0,Math.min(r,t.width-n.width)),i=Math.max(0,Math.min(i,t.height-n.height-40)),e.style.left=r+"px",e.style.top=i+"px"}function xt(e){const o=Y();for(const t in o.folders){const n=o.folders[t];if(n[e])return n[e];if(n.contents&&n.contents[e])return n.contents[e]}return null}function Uo(e){let o=0;e.addEventListener("pointerdown",function(t){let n=new Date().getTime(),r=n-o;if(r<300&&r>0){let i=new Event("mobiledbltap");e.dispatchEvent(i)}o=n})}document.querySelectorAll("[onmobiledbltap]").forEach(e=>{Uo(e),e.addEventListener("mobiledbltap",function(){let o=e.getAttribute("onmobiledbltap");if(o)try{new Function(o)()}catch(t){console.error(`Error executing: ${o}`,t)}})});function or(e,o,t){document.querySelectorAll(".desktop-folder-icon").forEach(s=>{s.classList.remove("dragover")}),document.querySelectorAll(".file-explorer-window").forEach(s=>{s.classList.remove("dragover")});const n=t.style.pointerEvents;t.style.pointerEvents="none";const r=document.elementFromPoint(e,o),i=r?r.closest(".desktop-folder-icon[data-item-id]"):null,a=r?r.closest(".file-explorer-window"):null;if(t.style.pointerEvents=n,i&&i!==t){const s=i.getAttribute("data-item-id"),l=xt(s);(l&&l.type==="folder"||s==="compostbin")&&i.classList.add("dragover")}else a&&a.classList.add("dragover")}typeof window<"u"&&(window.renderDesktopIcons=X,window.makeIconDraggable=dt,window.applyDesktopSettings=jo,rr());function fe(){requestAnimationFrame(()=>{document.querySelectorAll(".file-item").forEach(n=>{n.removeEventListener("dragstart",Zt),n.removeEventListener("dragover",Vt),n.removeEventListener("dragleave",Kt),n.removeEventListener("drop",Xt),n.removeEventListener("dragend",Jt),n.setAttribute("draggable",!0),n.addEventListener("dragstart",Zt),n.addEventListener("dragover",Vt),n.addEventListener("dragleave",Kt),n.addEventListener("drop",Xt),n.addEventListener("dragend",Jt)}),document.querySelectorAll(".file-explorer-window").forEach(n=>{n.removeEventListener("dragover",oo),n.removeEventListener("dragleave",no),n.removeEventListener("drop",ro),n.addEventListener("dragover",oo),n.addEventListener("dragleave",no),n.addEventListener("drop",ro)}),document.querySelectorAll(".desktop-folder-icon[data-item-id]").forEach(n=>{const r=n.getAttribute("data-item-id"),i=Pt(r);(i&&i.type==="folder"||r==="compostbin")&&(n.removeEventListener("dragover",Qt),n.removeEventListener("dragleave",eo),n.removeEventListener("drop",to),n.addEventListener("dragover",Qt),n.addEventListener("dragleave",eo),n.addEventListener("drop",to))})})}function Zt(e){e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",this.getAttribute("data-item-id")),this.classList.add("dragging")}function Vt(e){(e.dataTransfer.types.includes("application/x-compost-item")||e.dataTransfer.types.includes("text/plain"))&&(e.preventDefault(),e.dataTransfer.dropEffect="move",this.classList.add("dragover"))}function Kt(e){this.classList.remove("dragover")}async function Xt(e){e.stopPropagation(),this.classList.remove("dragover");const o=e.dataTransfer.getData("text/plain"),t=this.getAttribute("data-item-id"),n=e.dataTransfer.getData("application/x-compost-item")==="true";if(o===t)return;const r=document.querySelector(`[data-item-id="${o}"]`),i=this;if(n){if(i.classList.contains("folder-item")){const a=i.closest(".file-explorer-window"),s=a?a.getAttribute("data-current-path"):"C://",l=s==="C://"?s+t:s+"/"+t;await zt(o,l)}return}if(i.classList.contains("folder-item"))await At(o,t);else{const a=this.getBoundingClientRect(),s=e.clientY-a.top,l=this.parentElement;s<a.height/2?l.insertBefore(r,this):l.insertBefore(r,this.nextSibling),await nr()}r&&r.classList.remove("dragging")}function Jt(e){this.classList.remove("dragging"),document.querySelectorAll(".file-item").forEach(t=>t.classList.remove("dragover"));const o=document.getElementById("desktop");o&&o.classList.remove("drag-hover-target"),document.querySelectorAll(".drag-hover-target").forEach(t=>{t.classList.remove("drag-hover-target")})}async function At(e,o){let t=Y();const n=$t(e,t);if(!n){console.error("Item not found:",e);return}const{item:r,parent:i}=n,a=r.fullPath&&r.fullPath.includes("C://Desktop");if(delete i[e],a){const d="icon-"+e;Q[d]&&delete Q[d]}let s=findFolderFullPathById(o),l=findFolderObjectByFullPath(s,t);if(!l){console.error("Target folder not found:",o);return}l.contents||(l.contents={}),l.contents[e]=r,/^[A-Z]:\/\/$/.test(s)||(t.folders[s]||(t.folders[s]={}),t.folders[s][e]=r),r.fullPath=s+"/"+r.name,await re(t),O(),Te(),(s.includes("Desktop")||Ho(e).includes("Desktop"))&&X()}async function Et(e,o){let t=Y();const n=$t(e,t);if(!n){console.error("Item not found:",e);return}const{item:r,parent:i}=n,a=r.fullPath&&r.fullPath.includes("C://Desktop");if(delete i[e],a){const s="icon-"+e;typeof Q<"u"&&Q[s]&&delete Q[s]}t.folders[o]||(t.folders[o]={}),t.folders[o][e]=r,r.fullPath=o+"/"+r.name,await re(t),O(),Te(),(o.includes("Desktop")||a)&&X()}async function nr(){const e=document.querySelector(".file-explorer-window");if(!e)return;const o=e.getAttribute("data-current-path"),t=Array.from(e.querySelectorAll("ul > li"));let n=Y(),r=findFolderObjectByFullPath(o,n);if(!r||!r.contents)return;let i={};t.forEach(a=>{const s=a.getAttribute("data-item-id");r.contents[s]&&(i[s]=r.contents[s])}),r.contents=i,await re(n),O()}function $t(e,o){console.log("Looking for item:",e),console.log("File system folders:",Object.keys(o.folders));for(const t in o.folders){const n=o.folders[t];if(console.log(`Checking folder ${t}:`,Object.keys(n)),n[e])return console.log("Found item in folder:",t),{item:n[e],parent:n};if(n.contents&&n.contents[e])return console.log("Found item in folder contents:",t),{item:n.contents[e],parent:n.contents}}return console.log("Item not found anywhere"),null}function Pt(e){const o=Y();for(const t in o.folders){const n=o.folders[t];if(n[e])return n[e];if(n.contents&&n.contents[e])return n.contents[e]}return null}function Ho(e){const o=Y();for(const t in o.folders){const n=o.folders[t];if(n[e]||n.contents&&n.contents[e])return t}return""}function Qt(e){(e.dataTransfer.types.includes("application/x-compost-item")||e.dataTransfer.types.includes("text/plain"))&&(e.preventDefault(),e.dataTransfer.dropEffect="move",this.classList.add("dragover"))}function eo(e){this.classList.remove("dragover")}async function to(e){e.preventDefault(),e.stopPropagation(),this.classList.remove("dragover");const o=e.dataTransfer.getData("text/plain"),t=this.getAttribute("data-item-id"),n=e.dataTransfer.getData("application/x-compost-item")==="true";if(o&&t&&o!==t)if(n){const r=Pt(t);r&&r.type==="folder"&&await zt(o,r.fullPath)}else if(t==="compostbin"){const r=Ho(o);await moveItemToCompostBin(o,r)}else await At(o,t)}function oo(e){e.dataTransfer.types.includes("text/plain")&&(e.preventDefault(),e.dataTransfer.dropEffect="move",this.classList.add("dragover"))}function no(e){this.contains(e.relatedTarget)||this.classList.remove("dragover")}async function ro(e){e.preventDefault(),e.stopPropagation(),this.classList.remove("dragover");const o=e.dataTransfer.getData("text/plain"),t=this.getAttribute("data-current-path");if(o&&t){const n=Pt(o);if(n){const r=n.fullPath;if(r&&r.startsWith(t))return;r&&r.includes("C://Desktop")?await Et(o,t):await Et(o,t)}}}fe();async function zt(e,o){const t=Y(),r=(t.folders["C://Desktop"]||{}).compostbin;if(!r||!r.contents||!r.contents[e]){console.error("Item not found in compost bin:",e);return}const i=r.contents[e];delete r.contents[e];let a;if(o==="C://Desktop")t.folders["C://Desktop"]||(t.folders["C://Desktop"]={}),a=t.folders["C://Desktop"];else{const l=findFolderObjectByFullPath(o,t);if(!l){console.error("Target folder not found:",o);return}l.contents||(l.contents={}),a=l.contents}i.fullPath=o+"/"+i.id,a[e]=i,await re(t),O(),Te(),X();const s=document.getElementById("compost-bin");if(s){const l=s.querySelector("#compost-bin-content");l&&(loadCompostBinContents(l),updateCompostBinHeader(s))}}function rr(){const e=document.getElementById("desktop");e&&(e.addEventListener("dragover",o=>{const t=o.dataTransfer.types.includes("application/x-compost-item"),n=o.dataTransfer.types.includes("text/plain");(t||n)&&(o.preventDefault(),o.dataTransfer.dropEffect="move",e.classList.add("drag-hover-target"))}),e.addEventListener("dragleave",o=>{e.contains(o.relatedTarget)||e.classList.remove("drag-hover-target")}),e.addEventListener("drop",async o=>{o.preventDefault(),e.classList.remove("drag-hover-target");const t=o.dataTransfer.getData("application/x-compost-item")==="true",n=o.dataTransfer.getData("text/plain");n&&(t?await zt(n,"C://Desktop"):await ir(n))}))}async function ir(e){const o=Y(),t=$t(e,o);if(!t){console.error("Item not found:",e);return}const{item:n,parent:r}=t;n.fullPath&&n.fullPath==="C://Desktop/"+n.id||(delete r[e],o.folders["C://Desktop"]||(o.folders["C://Desktop"]={}),o.folders["C://Desktop"][e]=n,n.fullPath="C://Desktop/"+n.id,await re(o),O(),Te(),X())}function Go(e,o){const t={calculator:"image/calculator.png",mediaplayer:"image/video.png",bombbroomer:"image/bombbroomer.png",solitaire:"image/solitaire.png",chess:"image/guillotine_chess.png",mailbox:"image/mail.png",watercolour:"image/watercolour.png",compostbin:"image/compost-bin.png",storage:"image/drive_c.png","explorer-window":"image/computer.png",tubestream:"image/video.png"},n={Settings:"image/gears.png","About This Computer":"image/info.png","My Computer":"image/computer.png","File Explorer":"image/computer.png","Media Player":"image/video.png",Calculator:"image/calculator.png",Bombbroomer:"image/bombbroomer.png",Solitaire:"image/solitaire.png","Guillotine Chess":"image/guillotine_chess.png",Chess:"image/guillotine_chess.png","Inpeek Mailbox":"image/mail.png",Watercolour:"image/watercolour.png","Compost Bin":"image/compost-bin.png","Storage Manager":"image/drive_c.png",TubeStream:"image/video.png"};if(t[e])return t[e];if(n[o])return n[o];if(e&&e.includes("-")){const r=o.toLowerCase(),i=e.toLowerCase();if(r.match(/\.(jpg|jpeg|png|gif|webp|avif|bmp)$/i)||i.match(/\.(jpg|jpeg|png|gif|webp|avif|bmp)$/i))return"image/image.png";if(r.match(/\.(mp4|webm|avi|mov|mkv)$/i)||i.match(/\.(mp4|webm|avi|mov|mkv)$/i))return"image/video.png";if(r.match(/\.(mp3|wav|ogg|m4a|flac)$/i)||i.match(/\.(mp3|wav|ogg|m4a|flac)$/i))return"image/audio.png";if(r.match(/\.(txt|md|doc|docx)$/i)||i.match(/\.(txt|md|doc|docx)$/i)||r.includes("letterpad"))return"image/file.png";if(r.match(/\.(html|htm)$/i)||i.match(/\.(html|htm)$/i))return"image/html.png"}return o.includes("LetterPad")||o.includes(".md")||o.includes(".txt")?"image/file.png":o.includes(".jpg")||o.includes(".png")||o.includes(".gif")||o.includes(".webp")||o.includes(".jpeg")||o.includes(".bmp")||o.includes(".avif")?"image/image.png":o.includes(".mp4")||o.includes(".webm")||o.includes(".avi")||o.includes(".mov")||o.includes(".mkv")?"image/video.png":o.includes(".mp3")||o.includes(".wav")||o.includes(".ogg")||o.includes(".m4a")||o.includes(".flac")?"image/audio.png":o.includes(".html")||o.includes(".htm")?"image/html.png":null}function V(e,o,t=!1,n=null,r=!1,i=!1,a={type:"default"},s="default",l=null,d="white",f=null){let m=o;n||(n="window-"+Date.now()),s==="Settings"&&(m=tr()),s==="Explorer"&&(m=o||getExplorerWindowContent()),s==="App"&&(m=o);let u="";a.type==="integer"?u=`width: ${a.width}px; height: ${a.height}px; max-width:100%; max-height:100%;`:u="width: 100%; height: 100%;";const p=document.createElement("div");p.id=n,p.className="absolute border border-gray-500 shadow-lg overflow-auto z-20",p.style.cssText=u,p.style.minWidth="350px",p.style.minHeight="240px",r&&(p.style.display="none"),p.textContent="";const c=document.createElement("div");c.className="relative w-full h-[calc(100%-2.5rem)]";const h=document.createElement("div");h.className="bg-handlebar-blue sticky top-0 left-0 text-white px-2 py-1 flex justify-between items-center cursor-move",h.style.backgroundColor="#003f7f";const v=document.createElement("span");v.textContent=e,v.className="flex-1 truncate pr-2",v.style.maxWidth="calc(100% - 120px)";const M=document.createElement("div");M.className="my-1 flex-shrink-0";const F=document.createElement("button");F.id=`minimizeWindow-${n}`,F.className="bg-yellow-500 h-6 w-6 text-white",F.textContent="_",F.addEventListener("click",L=>{He(n),L.stopPropagation()});const T=document.createElement("button");T.id=`toggleFullScreen-${n}`,T.className="bg-green-500 h-6 w-6 text-white ml-1",T.textContent="⛶",T.addEventListener("click",L=>{Ot(n),L.stopPropagation()});const G=document.createElement("button");G.id=`closeWindow-${n}`,G.className="bg-red-500 h-6 w-6 text-white ml-1",G.textContent="X",G.addEventListener("click",L=>{te(n),L.stopPropagation()}),M.append(F,T,G),h.append(v,M);const R=document.createElement("div");R.className=`p-2 bg-${d} h-full ${s==="editor"?"w-full":""} overflow-auto`,R.innerHTML=m,s==="default"&&(R.contentEditable="true",R.addEventListener("input",()=>{updateContent(n,R.innerHTML)})),s==="Explorer"&&setTimeout(()=>{typeof fe=="function"&&fe()},50),c.append(h,R),p.appendChild(c),f!=null?(p.style.zIndex=f,parseInt(f)>ye&&Ct(parseInt(f))):(Ct(ye+1),p.style.zIndex=ye),p.addEventListener("click",function(){Le(p)}),document.getElementById("windows-container").appendChild(p);const z=document.createElement("div");z.id="tab-"+n,z.className="bg-gray-200 border border-gray-500 px-2 py-1 cursor-pointer flex items-center";const U=Go(n,e);if(U){const L=document.createElement("img");L.src=U,L.className="h-4 w-4 mr-2",L.alt=e,z.appendChild(L);const $=document.createElement("span");$.textContent=e,z.appendChild($)}else z.textContent=e;z.onclick=function(){p.style.display==="none"?Le(p):He(p.id)},z.addEventListener("contextmenu",function(L){L.preventDefault(),ar(L,n,p)}),document.getElementById("window-tabs").appendChild(z);const _=H[n],oe=_?_.position:null,Z=_?_.dimensions:a,B=_?_.fullScreen:!1;if(H[n]={id:n,title:e,content:m,isNav:t,isMinimized:r,dimensions:i&&_?Z:a,windowType:s,position:oe,fullScreen:B,color:d,zIndex:parseInt(p.style.zIndex)||ye},t&&(he[e]=n),r||Le(p),a.type!=="default"){if(i&&oe&&(p.style.left=oe.left,p.style.top=oe.top),i&&Z&&Z.type==="integer"&&(p.style.width=Z.width+"px",p.style.height=Z.height+"px"),!i||!oe)if(l){let L=parseInt(l.style.left,10)||0,$=parseInt(l.style.top,10)||0,D=L+30,N=$+30,de=window.innerWidth,xe=window.innerHeight-40,le=a.width,Ee=a.height;if(D+le>de||N+Ee>xe){D=0,N=0;const Me=Array.from(document.querySelectorAll("#windows-container > div")).find(ie=>(parseInt(ie.style.left,10)||0)<=10&&(parseInt(ie.style.top,10)||0)<=10);Me&&(D=(parseInt(Me.style.left,10)||0)+30)}p.style.left=D+"px",p.style.top=N+"px"}else p.style.left="100px",p.style.top="100px";Yo(p),Zo(p)}return i||O(),p}function He(e){const o=document.getElementById(e);if(o){o.style.display="none",H[e]&&(H[e].isMinimized=!0,O());const t=document.getElementById("tab-"+e);t&&t.classList.remove("bg-gray-50")}}function Le(e){let o=!1;e.style.display==="none"&&(e.style.display="block",H[e.id]&&(H[e.id].isMinimized=!1,o=!0)),Ct(ye+1),e.style.zIndex=ye,H[e.id]&&(H[e.id].zIndex=ye,o=!0),o&&O(),document.querySelectorAll("#window-tabs > div").forEach(n=>n.classList.remove("bg-gray-50"));const t=document.getElementById("tab-"+e.id);t&&t.classList.add("bg-gray-50"),e.querySelector("video, audio")&&(on(e.id),updateMediaControl())}function te(e){const o=document.getElementById(e);o&&o.remove();const t=document.getElementById("tab-"+e);t&&t.remove(),Re===e&&(on(null),updateMediaControl()),delete H[e];for(const n in he)if(he[n]===e){delete he[n];break}O()}function Yo(e){const o=e.querySelector(".cursor-move");o&&o.addEventListener("mousedown",function(t){t.preventDefault();const n=e.getBoundingClientRect(),r=t.clientX-n.left,i=t.clientY-n.top;function a(l){e.style.left=l.clientX-r+"px",e.style.top=l.clientY-i+"px"}function s(){document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",s),H[e.id]&&(H[e.id].position={left:e.style.left,top:e.style.top},O())}document.addEventListener("mousemove",a),document.addEventListener("mouseup",s),Le(e)})}function Zo(e){const o=document.createElement("div");o.className="absolute bottom-0 right-0 w-4 h-4 cursor-se-resize",o.style.background="rgba(0,0,0,0.2)",e.appendChild(o),o.addEventListener("mousedown",function(t){t.preventDefault(),t.stopPropagation();const n=t.clientX,r=t.clientY,i=parseInt(document.defaultView.getComputedStyle(e).width,10),a=parseInt(document.defaultView.getComputedStyle(e).height,10);function s(d){const f=Math.max(i+d.clientX-n,350),m=Math.max(a+d.clientY-r,200);e.style.width=f+"px",e.style.height=m+"px"}function l(){document.documentElement.removeEventListener("mousemove",s,!1),document.documentElement.removeEventListener("mouseup",l,!1),H[e.id].dimensions={type:"integer",width:parseInt(e.style.width),height:parseInt(e.style.height)},O()}document.documentElement.addEventListener("mousemove",s,!1),document.documentElement.addEventListener("mouseup",l,!1)})}function Ot(e){const o=document.getElementById(e);if(!o)return;let t=H[e];t.fullScreen?(t.originalDimensions&&t.originalPosition?(o.style.left=t.originalPosition.left,o.style.top=t.originalPosition.top,o.style.width=t.originalDimensions.width+"px",o.style.height=t.originalDimensions.height+"px",t.dimensions=t.originalDimensions):(o.style.left="15%",o.style.top="15%",o.style.width="70vw",o.style.height="70vh",t.dimensions={type:"integer",width:window.innerWidth*.7,height:window.innerHeight*.7}),t.fullScreen=!1,Yo(o),Zo(o)):(t.originalDimensions=t.dimensions,t.originalPosition=t.position,o.style.left="0px",o.style.top="0px",o.style.width=window.innerWidth+"px",o.style.height=window.innerHeight-40+"px",t.dimensions={type:"default"},t.fullScreen=!0),O()}function j(e,o,t=null,n=null){const r="dialogWindow-"+Date.now(),i=o==="confirmation"&&(t||n);let a;i?a=`
      <div class="text-center p-4">
        <h2 class="text-lg mb-4">${e}</h2>
        <div class="flex gap-2 justify-center">
          <button id="${r}-ok-button" class="bg-gray-200 border-2 border-gray-400 px-4 py-2 hover:bg-gray-300" style="border-style: outset;">
            OK
          </button>
          <button id="${r}-cancel-button" class="bg-gray-200 border-2 border-gray-400 px-4 py-2 hover:bg-gray-300" style="border-style: outset;">
            Cancel
          </button>
        </div>
      </div>
    `:a=`
      <div class="text-center p-4">
        <h2 class="text-lg mb-4">${e}</h2>
        <button id="${r}-button" class="bg-gray-200 border-2 border-gray-400 px-4 py-2 hover:bg-gray-300" style="border-style: outset;">
          OK
        </button>
      </div>
    `;let s="⚠️ Information";if(o==="confirmation"&&(s=i?"⚠️ Confirmation":"✅ Success"),o==="error"){s="⚠️ Error";const d=document.getElementById("error-popup-audio");d&&d.play()}const l=V(s,a,!1,r,!1,!1,{type:"integer",width:350,height:180},"default");return Le(l),setTimeout(()=>{Le(l)},10),setTimeout(()=>{if(i){const d=document.getElementById(`${r}-ok-button`),f=document.getElementById(`${r}-cancel-button`);d&&d.addEventListener("click",()=>{te(r),t&&t()}),f&&f.addEventListener("click",()=>{te(r),n&&n()})}else{const d=document.getElementById(`${r}-button`);d&&d.addEventListener("click",()=>{te(r),t&&t()})}},100),l}document.addEventListener("click",e=>{e.target.closest("#settings-apply-button")&&(e.stopPropagation(),j("Are you sure you want to apply these desktop settings changes?","confirmation",()=>{De("settings-apply-button","Applied!"),setTimeout(()=>{De("settings-apply-button","Apply")},1e3),er(),j("Your settings have successfully been saved!","info")}))});function ar(e,o,t){const n=document.getElementById("context-menu");n.replaceChildren(),n.style.zIndex=(ye||1e3)+100;const r=(m,u,p)=>{const c=document.createElement("div");return c.className="px-4 py-2 hover:bg-gray-50 cursor-pointer",c.textContent=m,p&&c.addEventListener("click",p),n.appendChild(c),c},i=t.style.display==="none",a=H[o]&&H[o].fullScreen;i?r("Restore",!1,()=>{Le(t),hideContextMenu()}):r("Minimize",!1,()=>{He(o),hideContextMenu()}),a||r("Maximize",!1,()=>{Ot(o),hideContextMenu()}),r("Close",!1,()=>{te(o),hideContextMenu()}),n.classList.remove("hidden");const s=n.getBoundingClientRect(),l=48;let d=e.pageX;d+s.width>window.innerWidth&&(d=window.innerWidth-s.width-10);let f=window.innerHeight-l-s.height-5;n.style.left=d+"px",n.style.top=f+"px",setTimeout(()=>{document.addEventListener("click",hideContextMenu,{once:!0})},0)}function ut(){const e=document.createElement("div");e.className="w-3xl fixed left-0 top-0 h-full w-full bg-gradient-to-b from-40% from-blue-500 to-cyan-500",e.id="splash-screen",e.style.zIndex="9000",e.innerHTML=`
  <div class="flex flex-col items-center justify-center h-full">
    <img id="splash-image" src="./image/startup.png" alt="Startup" class="mb-4 max-w-48">
    <h1 class="sr-only">Doorways '25, a Nostalgia Inducing Operating System</h1>
    <div class="mx-auto w-72 text-sm pl-3 mb-2 bg-black py-1 border-2 border-lime-400 text-lime-300"><em>i hacked the mainframe credentials for u</em><br><span class="text-xs text-lime-500">sincerely, _N30_phreak_</span></div>
    <form id="splash-form" class="bg-gray-300 border border-gray-500 p-4 w-96">
      <div class="mb-2">
        <label class="block text-sm">Username</label>
        <input type="text" id="splash-username" value="admin" class="border px-1 py-1 w-full" readonly>
      </div>
      <div class="mb-2">
        <label class="block text-sm">Password</label>
        <input type="password" id="splash-password" value="••••••" class="border px-1 py-1 w-full" readonly>
      </div>
      <button id="splash-login" class="bg-gray-200 border-t-2 border-l-2 border-gray-300 mr-2"><span class="border-b-2 border-r-2 border-black block h-full max-h-10 w-full py-1.5 px-3">Login</span></button>
    </form>
  </div>
`,document.body.appendChild(e);const o=document.getElementById("splash-audio");document.getElementById("splash-login").addEventListener("click",function(t){o.play(),t.preventDefault(),document.getElementById("splash-image").src="./image/loading.gif",o.currentTime=0,setTimeout(function(){e.remove()},3e3)})}function sr(){const e=document.createElement("div");e.className="w-3xl fixed left-0 top-0 h-full w-full bg-gradient-to-b from-blue-500 to-cyan-500",e.id="splash-screen",e.style.zIndex="9999",e.innerHTML=`
  <div class="flex flex-col items-center justify-center h-full">
    <img id="splash-image" src="./image/startup.png" alt="Startup" class="mb-4 max-w-48">
    <h2 class="text-4xl text-gray-900 font-bold mb-2">System Loading ...</h2>
  </div>
`,document.body.appendChild(e),setTimeout(function(){e.remove()},3e3)}typeof window<"u"&&(window.showSplash=ut,window.showOSLoading=sr);async function Vo(){await E.setItem("explicitRestart",!0),Er(),Sr(),vr([]),xr({clockSeconds:!1,bgColor:"#20b1b1",bgImage:""}),ut()}async function Ko(){await E.setItem("explicitRestart",!0);try{await O()}catch(e){console.warn("Failed to save state before logout:",e)}ut()}typeof window<"u"&&(window.restart=Vo,window.logout=Ko);function Xo(){V("Storage Manager",'<div id="storage-content" style="padding: 20px;">Loading storage information...</div>',!1,"storage-window",!1,!1,{type:"integer",width:600,height:500},"default"),setTimeout(nt,100)}async function nt(){const e=document.getElementById("storage-content");if(e)try{const o=await navigator.storage.estimate(),t=(o.quota/(1024*1024)).toFixed(2),n=(o.usage/(1024*1024)).toFixed(2),r=((o.quota-o.usage)/(1024*1024)).toFixed(2),i=(o.usage/o.quota*100).toFixed(1),a=await cr(),s=`
      <div class="storage-manager">
        <h2 class="text-xl font-bold mb-4">Storage Information</h2>

        <!-- Storage Capacity -->
        <div class="mb-6 p-4 bg-gray-100 rounded">
          <h3 class="text-lg font-semibold mb-2">Storage Capacity</h3>
          <div class="mb-2">
            <div class="flex justify-between mb-1">
              <span>Used: ${n} MB</span>
              <span>Available: ${r} MB</span>
            </div>
            <div class="w-full bg-gray-300 rounded-full h-4">
              <div class="bg-blue-500 h-4 rounded-full" style="width: ${i}%"></div>
            </div>
            <div class="text-sm text-gray-600 mt-1">
              ${i}% of ${t} MB total capacity used
            </div>
          </div>
        </div>

        <!-- Data Categories -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-3">Data Categories</h3>
          <div class="grid grid-cols-2 gap-4">
            ${Xe("App Data",a.appData,"bg-blue-100")}
            ${Xe("Media Files",a.mediaData,"bg-green-100")}
            ${Xe("Files & Folders",a.fileData,"bg-yellow-100")}
            ${Xe("Miscellaneous",a.miscData,"bg-gray-100")}
          </div>
        </div>

        <!-- Detailed Breakdown -->
        <div class="mb-4">
          <h3 class="text-lg font-semibold mb-3">Detailed Breakdown</h3>
          <div class="bg-white border rounded p-3">
            ${lr(a)}
          </div>
        </div>

        <!-- Actions -->
        <div class="mt-6 flex gap-3">
          <div id="refresh-btn-container"></div>
          <div id="cleanup-btn-container"></div>
          <div id="restore-btn-container"></div>
        </div>
      </div>
    `;e.innerHTML=s;const l=await Qo(),d=ne("Refresh Data");d.onclick=Ye,document.getElementById("refresh-btn-container").appendChild(d);const f=ne("Cleanup Options");f.onclick=Jo,document.getElementById("cleanup-btn-container").appendChild(f);const m=ne("Restore All Applications");m.onclick=hr,l.count===0?(m.disabled=!0,m.title="All applications are already in the Start menu",m.style.opacity="0.6",m.style.cursor="not-allowed"):m.title=`Restore ${l.count} missing applications to Start menu`,document.getElementById("restore-btn-container").appendChild(m)}catch(o){e.innerHTML=`<div class="text-red-500">Error loading storage data: ${o.message}</div>`}}function Xe(e,o,t){const n=(o.totalSize/1024).toFixed(1);return`
    <div class="p-4 ${t} rounded">
      <h4 class="font-semibold">${e}</h4>
      <div class="text-2xl font-bold">${o.count}</div>
      <div class="text-sm text-gray-600">items (${n} KB)</div>
    </div>
  `}function lr(e){let o='<div class="space-y-2 text-sm">';return e.appData.breakdown.length>0&&(o+="<div><strong>App Data:</strong></div>",e.appData.breakdown.forEach(t=>{o+=`<div class="ml-4">• ${t.name}: ${t.count} items</div>`})),e.mediaData.breakdown.length>0&&(o+='<div class="mt-3"><strong>Media Files:</strong></div>',e.mediaData.breakdown.forEach(t=>{const n=(t.size/1024).toFixed(1);o+=`<div class="ml-4">• ${t.type}: ${t.count} files (${n} KB)</div>`})),e.fileData.breakdown.length>0&&(o+='<div class="mt-3"><strong>Files & Folders:</strong></div>',e.fileData.breakdown.forEach(t=>{o+=`<div class="ml-4">• ${t.name}: ${t.count} items</div>`})),o+="</div>",o}async function cr(){const e={appData:{count:0,totalSize:0,breakdown:[]},mediaData:{count:0,totalSize:0,breakdown:[]},fileData:{count:0,totalSize:0,breakdown:[]},miscData:{count:0,totalSize:0,breakdown:[]}};return await dr(e),await ur(e),e}async function dr(e){try{const t=await E.getItem("appState")||{},n=JSON.stringify(t).length;if(t.fileSystemState){const r=JSON.stringify(t.fileSystemState).length;e.fileData.totalSize+=r;const i=t.fileSystemState;i.folders&&Object.values(i.folders).forEach(a=>{St(a,e.fileData)})}if(t.windowStates){const r=JSON.stringify(t.windowStates).length;e.appData.totalSize+=r,e.appData.count+=Object.keys(t.windowStates).length,e.appData.breakdown.push({name:"Window States",count:Object.keys(t.windowStates).length})}if(t.desktopIconsState){const r=JSON.stringify(t.desktopIconsState).length;e.appData.totalSize+=r,e.appData.count+=Object.keys(t.desktopIconsState).length,e.appData.breakdown.push({name:"Desktop Icons",count:Object.keys(t.desktopIconsState).length})}if(t.desktopSettings){const r=JSON.stringify(t.desktopSettings).length;e.appData.totalSize+=r,e.appData.count+=1,e.appData.breakdown.push({name:"Desktop Settings",count:1})}}catch(o){console.error("Error analyzing storage:",o)}}function St(e,o){!e||typeof e!="object"||(e.type==="folder"?(o.count++,e.contents&&Object.values(e.contents).forEach(t=>{St(t,o)})):e.type==="ugc-file"?(o.count++,["mp3","mp4","jpg","jpeg","png","gif","webp","wav","webm"].includes(e.content_type)):Object.values(e).forEach(t=>{t&&typeof t=="object"&&St(t,o)}))}async function ur(e){try{const o=await indexedDB.databases();for(const t of o)t.name==="media_player_db"?await pr(e):(e.miscData.count+=1,e.miscData.breakdown.push({name:`Database: ${t.name}`,count:1}))}catch(o){console.error("Error analyzing IndexedDB:",o)}}async function pr(e){return new Promise((o,t)=>{const n=indexedDB.open("media_player_db");n.onsuccess=r=>{const i=r.target.result,l=i.transaction(["songs"],"readonly").objectStore("songs").getAll();l.onsuccess=()=>{const d=l.result,f={};d.forEach(m=>{const u=m.type||"unknown";f[u]||(f[u]={count:0,size:0}),f[u].count++,m.file&&m.file.size&&(f[u].size+=m.file.size,e.mediaData.totalSize+=m.file.size),e.mediaData.count++}),Object.entries(f).forEach(([m,u])=>{e.mediaData.breakdown.push({type:m.toUpperCase(),count:u.count,size:u.size})}),i.close(),o()},l.onerror=()=>{i.close(),t(l.error)}},n.onerror=()=>{t(n.error)}})}function Ye(){const e=document.getElementById("storage-content");e&&(e.innerHTML="Refreshing storage information...",setTimeout(nt,100))}function fr(e,o=null,t=null){const n=document.createElement("select");return n.className="bg-white border-t-2 border-l-2 border-black border-b-2 border-r-2 border-gray-300 px-2 py-1",e.forEach(r=>{const i=document.createElement("option");typeof r=="string"?(i.value=r,i.textContent=r):(i.value=r.value,i.textContent=r.text||r.value),o!==null&&i.value===o&&(i.selected=!0),n.appendChild(i)}),t&&typeof t=="function"&&n.addEventListener("change",r=>t(r.target.value,r)),n}function Jo(){const e=V("Storage Cleanup",'<div id="cleanup-content" style="padding: 20px;">Loading cleanup options...</div>',!1,"storage-cleanup-window",!1,!1,{type:"integer",width:400,height:340},"default");setTimeout(()=>{const t=[...document.querySelectorAll("*")].filter(n=>getComputedStyle(n).zIndex>100&&getComputedStyle(n).zIndex<1e3).reduce((n,r)=>getComputedStyle(r).zIndex>getComputedStyle(n).zIndex?r:n);e.style.zIndex=`${parseInt(t.style.zIndex)+1}`},50),setTimeout(mr,100)}function mr(){const e=document.getElementById("cleanup-content");if(!e)return;const o=`
    <div class="cleanup-options">
      <h3 class="text-lg font-semibold mb-4">Storage Cleanup Options</h3>
      <p class="text-sm text-gray-600 mb-4">Choose what data to clear:</p>

      <div class="space-y-3">
        <div id="clear-media-btn-container"></div>
        <div id="clear-desktop-btn-container"></div>
        <div id="full-restart-btn-container"></div>
      </div>
    </div>
  `;e.innerHTML=o;const t=ne("Clear Media Player Data");t.onclick=gr,t.className+=" w-full mb-2",document.getElementById("clear-media-btn-container").appendChild(t);const n=ne("Reset Desktop Settings");n.onclick=yr,n.className+=" w-full mb-2",document.getElementById("clear-desktop-btn-container").appendChild(n);const r=ne("Factory Reset");r.onclick=en,r.className+=" w-full mb-2",r.style.backgroundColor="#ffcccc",document.getElementById("full-restart-btn-container").appendChild(r)}async function gr(){try{await new Promise((o,t)=>{const n=indexedDB.deleteDatabase("media_player_db");n.onsuccess=o,n.onerror=t});const e=getFileSystemStateSync();e.folders["C://Media"]&&(e.folders["C://Media"]={},setFileSystemState(e),saveState()),j("Media player data cleared successfully!","info"),Ye()}catch(e){j("Error clearing media player data: "+e.message,"error")}}async function yr(){const o=await E.getItem("appState")||{};o.desktopSettings={clockSeconds:!1,bgColor:"#20b1b1",bgImage:""},o.desktopIconsState={},o.startMenuOrder=[],await E.setItem("appState",o),j("Desktop settings reset successfully!","info"),Ye()}async function Qo(){try{const e=[{id:"mycomp",text:"My Computer",icon:"image/computer.png"},{id:"mediaapp",text:"Media Player",icon:"image/video.png"},{id:"watercolourapp",text:"Watercolour",icon:"image/watercolour.png"},{id:"letterpad",text:"LetterPad",icon:"image/file.png"},{id:"calcapp",text:"Calculator",icon:"image/calculator.png"},{id:"sysset",text:"System Settings",icon:"image/gears.png"},{id:"storageapp",text:"Storage Manager",icon:"image/drive_c.png"},{id:"abtcomp",text:"About This Computer",icon:"image/info.png"},{id:"solapp",text:"Solitaire",icon:"image/solitaire.png"},{id:"chessapp",text:"Guillotine Chess",icon:"image/guillotine_chess.png"},{id:"bombapp",text:"Bombbroomer",icon:"image/bombbroomer.png"}];let o=[];try{const r=await E.getItem("startMenuOrder");r&&Array.isArray(r)?o=r:o=typeof startMenuOrder<"u"?startMenuOrder:window.startMenuOrder||[]}catch{o=typeof startMenuOrder<"u"?startMenuOrder:window.startMenuOrder||[]}const t=new Set;o.forEach(r=>{typeof r=="string"?t.add(r):r&&r.type==="group"&&r.items&&r.items.forEach(i=>{i&&i.id&&t.add(i.id)})});const n=e.filter(r=>!t.has(r.id));return console.log("🔍 Apps check - Visible:",Array.from(t)),console.log("🔍 Apps check - Missing:",n.map(r=>r.id)),{count:n.length,apps:n}}catch(e){return console.error("Error checking for missing apps:",e),{count:0,apps:[]}}}async function hr(){try{console.log("🔄 Starting application restore...");const e=await Qo();if(e.count===0){typeof j=="function"?j("All applications are already present in the Start menu.","info"):alert("All applications are already present in the Start menu.");return}const o=`This will restore ${e.count} missing applications to the Start menu:

${e.apps.map(t=>`• ${t.text}`).join(`
`)}

Proceed?`;typeof j=="function"?j(o,"confirmation",async()=>{await io(e.apps)}):confirm(o)&&await io(e.apps)}catch(e){console.error("❌ Error in restoreAllApplications:",e),typeof j=="function"?j("Failed to restore applications: "+e.message,"error"):alert("Failed to restore applications: "+e.message)}}async function io(e){try{console.log("🔄 Performing app restore for:",e.map(n=>n.id));let o=[];try{const n=await E.getItem("startMenuOrder");n&&Array.isArray(n)?o=[...n]:o=typeof startMenuOrder<"u"?[...startMenuOrder]:[...window.startMenuOrder||[]]}catch{o=typeof startMenuOrder<"u"?[...startMenuOrder]:[...window.startMenuOrder||[]]}const t={letterpad:"utilities-group",calcapp:"utilities-group",sysset:"utilities-group",storageapp:"utilities-group",abtcomp:"utilities-group",solapp:"games-group",chessapp:"games-group",bombapp:"games-group"};e.forEach(n=>{const r=t[n.id];if(r){let i=!1;if(o=o.map(a=>typeof a=="object"&&a.type==="group"&&a.id===r?(i=!0,{...a,items:[...a.items||[],{id:n.id,text:n.text,icon:n.icon}]}):a),!i){const a=br(r);if(a){a.items=[{id:n.id,text:n.text,icon:n.icon}];const s=o.findIndex(l=>l==="rstrtcomp");s!==-1?o.splice(s,0,a):o.push(a)}}}else{const i=o.findIndex(a=>a==="rstrtcomp");i!==-1?o.splice(i,0,n.id):o.push(n.id)}}),window.startMenuOrder=o,typeof startMenuOrder<"u"&&(startMenuOrder=o),await E.setItem("startMenuOrder",o),typeof saveState=="function"&&await saveState(),typeof generateStartMenuHTML=="function"?generateStartMenuHTML():typeof window.generateStartMenuHTML=="function"&&window.generateStartMenuHTML(),typeof safeInitializeStartMenuDragDrop=="function"?setTimeout(()=>{safeInitializeStartMenuDragDrop()},50):typeof window.safeInitializeStartMenuDragDrop=="function"&&setTimeout(()=>{window.safeInitializeStartMenuDragDrop()},50),typeof j=="function"?j(`Successfully restored ${e.length} applications to the Start menu.`,"info"):alert(`Successfully restored ${e.length} applications to the Start menu.`),setTimeout(()=>{Ye()},500),console.log("✅ App restore completed successfully")}catch(o){console.error("❌ Error performing app restore:",o),typeof j=="function"?j("Failed to restore applications: "+o.message,"error"):alert("Failed to restore applications: "+o.message)}}function br(e){return{"utilities-group":{id:"utilities-group",text:"Utilities",type:"group",items:[]},"games-group":{id:"games-group",text:"Games",type:"group",items:[]}}[e]||null}function en(){j("This will completely wipe the entire hard drive and reset the system to factory defaults. All your files, settings, and data will be permanently deleted.","confirmation",()=>{confirm(`⚠️ FINAL WARNING ⚠️

This will permanently delete EVERYTHING you have ever saved in this application:

• All uploaded files and media
• All documents and folders
• All settings and customizations
• All application data

This action cannot be undone!

Are you absolutely sure you want to proceed?`)&&wr()},()=>{})}function wr(){E.clearSync();const e=indexedDB.deleteDatabase("media_player_db");e.onsuccess=()=>{},e.onerror=o=>{console.error("Factory reset: Error clearing media player database:",o)},windowStates={},desktopIconsState={},startMenuOrder=[],desktopSettings={clockSeconds:!1,bgColor:"#20b1b1",bgImage:""},window.location.reload()}let ve={folders:{"C://":{Documents:{id:"Documents",name:"Documents",type:"folder",fullPath:"C://Documents",contents:{}},Desktop:{id:"Desktop",name:"Desktop",type:"folder",fullPath:"C://Desktop",contents:{compostbin:{id:"compostbin",name:"Compost Bin",type:"app",fullPath:"C://Desktop/compostbin",content_type:"html",contents:{},icon:"./image/compost-bin.png"}}},Media:{id:"Media",name:"Media",type:"folder",fullPath:"C://Media",contents:{}}},"A://":{"folder-34862398":{id:"folder-34862398",name:"example folder",type:"folder",fullPath:"A://folder-34862398",contents:{"folder-9523759823":{id:"folder-9523759823",name:"nested in example",type:"folder",fullPath:"A://folder-34862398/folder-9523759823",contents:{"folder-53829539":{id:"folder-53829539",name:"supernested",type:"folder",fullPath:"A://folder-34862398/folder-9523759823/folder-53829539",contents:{"file-593485739":{id:"file-593485739",name:"some md example",type:"ugc-file",content_type:"md",fullPath:"A://folder-34862398/folder-9523759823/folder-53829539/file-593485739",contents:"lol sup"}}}}}}}},"D://":{}}},H={},Q={},he={},ee={clockSeconds:!1,bgColor:"#20b1b1",bgImage:""},W,tn={},ye=100,Re=null;function vr(e){W=e,typeof window<"u"&&(window.startMenuOrder=e)}function Ct(e){ye=e,typeof window<"u"&&(window.highestZ=e)}function on(e){Re=e,typeof window<"u"&&(window.activeMediaWindow=e)}function xr(e){Object.assign(ee,e),typeof window<"u"&&(window.desktopSettings=ee)}function Er(){Object.keys(H).forEach(e=>delete H[e]),typeof window<"u"&&(window.windowStates=H)}function Sr(){Object.keys(Q).forEach(e=>delete Q[e]),typeof window<"u"&&(window.desktopIconsState=Q)}typeof window<"u"&&(window.fileSystemState=ve,window.windowStates=H,window.desktopIconsState=Q,window.navWindows=he,window.desktopSettings=ee,window.fileFolderMapping=tn,window.highestZ=ye,window.activeMediaWindow=Re);let rt=!1;typeof window<"u"&&(window.isInitializing=rt);async function O(){if(rt)return;const e=typeof W<"u"?W:window.startMenuOrder||[],o={fileSystemState:ve,windowStates:H,desktopIconsState:Q,desktopSettings:ee,navWindows:he,startMenuOrder:e};try{await E.setItem("appState",o);const t=Date.now(),n=await E.getItem("appState")}catch(t){console.warn("Failed to save state to IndexedDB:",t),E.setItemSync("appState",o)}}typeof window<"u"&&(window.saveState=O);function Ie(){return ve}function re(e){ve=e,typeof window<"u"&&(window.fileSystemState=e)}function Fe(e,o){H[e]&&(H[e].content=o,O())}async function nn(e,o,t,n,r=null){const i=await Ie();if(!i||!i.folders){console.error("File system not initialized, creating basic structure");const c={folders:{"C://":{Documents:{id:"Documents",name:"Documents",type:"folder",fullPath:"C://Documents",contents:{}},Desktop:{id:"Desktop",name:"Desktop",type:"folder",fullPath:"C://Desktop",contents:{}},Media:{id:"Media",name:"Media",type:"folder",fullPath:"C://Media",contents:{}}},"A://":{},"D://":{}}};re(c),i=c}const a=t.match(/^([A-Z]:\/\/)/);if(!a)return console.error("Invalid path format:",t),null;const s=a[1],l=t.replace(/^[A-Z]:\/\//,"").split("/").filter(c=>c);i.folders[s]||(console.error("Drive does not exist:",s),i.folders[s]={});let d=i.folders[s];if(l.length===0)d=i.folders[s];else if(d=i.folders[t],!d)return console.error("Target folder not found in unified structure:",t),console.error("Available folders:",Object.keys(i.folders)),null;const f=l.length===0;let m="image/file.png";["png","jpg","jpeg","gif"].includes(n)?m="image/image.png":["mp4","webm"].includes(n)?m="image/video.png":["mp3","wav","audio"].includes(n)?m="image/audio.png":n==="html"?m="image/html.png":["md","txt"].includes(n)&&(m="image/doc.png");const u=`file-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,p={id:u,name:e,type:"ugc-file",fullPath:f?`${t}${e}`:`${t}/${e}`,content_type:n,icon:m,contents:o||"",file:r||null};if(r&&["png","jpg","jpeg","gif","webp","avif","mp3","wav","ogg","mp4","webm","avi","mov"].includes(n)){p.isLargeFile=!0,p.storageLocation="indexeddb";const c=URL.createObjectURL(r);p.tempObjectURL=c;const h=new FileReader;h.onload=async function(v){const M=v.target.result,F=M.length*.75/(1024*1024);try{await E.setItem(`file_data_${u}`,M);const R=await Ie();let z;f?z=R.folders[s][u]:z=R.folders[t][u],z?(z.isLargeFile=!0,z.storageLocation="indexeddb",z.dataURL=M):(console.error("🎵 ADDFILE: File entry not found after creation:",u),console.error("🎵 ADDFILE: Looking in:",f?s:t),console.error("🎵 ADDFILE: Available keys:",Object.keys(f?R.folders[s]||{}:R.folders[t]||{})))}catch(R){console.error("Failed to store file in IndexedDB:",R);const z=await Ie();let U;f?U=z.folders[s][u]:U=z.folders[t][u],U&&(U.isLargeFile=!0,U.storageLocation="failed"),showDialogBox(`File "${e}" could not be stored (${F.toFixed(2)}MB). Storage error: ${R.message}`,"error")}const T=await Ie();let G;f?G=T.folders[s][u]:G=T.folders[t][u],G?G.file=null:console.error("🎵 ADDFILE: Could not find file entry to remove File object:",u),re(T);try{await O()}catch(R){console.error("Failed to save state after file storage:",R)}t==="C://Desktop"&&typeof renderDesktopIcons=="function"?renderDesktopIcons():typeof refreshAllExplorerWindows=="function"&&refreshAllExplorerWindows(t)},h.readAsDataURL(r)}if(d[u]=p,re(i),!r||!["png","jpg","jpeg","gif","webp","avif","mp3","wav","ogg","mp4","webm","avi","mov"].includes(n))try{await O()}catch(c){console.error("Failed to save state after non-binary file:",c)}return t==="C://Desktop"?typeof renderDesktopIcons=="function"?renderDesktopIcons():typeof window.renderDesktopIcons=="function"?window.renderDesktopIcons():console.warn("renderDesktopIcons function not found"):typeof refreshAllExplorerWindows=="function"?refreshAllExplorerWindows(t):typeof window.refreshAllExplorerWindows=="function"?window.refreshAllExplorerWindows(t):console.warn("refreshAllExplorerWindows function not found"),t==="C://Media"&&["mp3","wav","ogg","audio","mp4","webm","avi","mov"].includes(n)&&typeof window.refreshMediaPlayerPlaylist=="function"&&setTimeout(()=>{window.refreshMediaPlayerPlaylist()},100),p}window.globalAddFileToFileSystem=nn;function ht(e){console.log("=== Migration starting ==="),console.log("Input filesystem state:",e),e.folders||(e.folders={});let o=!1;if(e.folders["C://"]&&typeof e.folders["C://"]=="object"){console.log("Found C:// contents for migration:",Object.keys(e.folders["C://"]),e.folders["C://"]);const r=e.folders["C://"];for(const[i,a]of Object.entries(r))if(a&&typeof a=="object")if(console.log("Processing item:",i,"type:",a.type),a.type==="folder"){const s=`C://${a.name||i}`;e.folders[s]||(e.folders[s]=a.contents||{},o=!0,console.log("Migrated folder to:",s),a.contents&&Object.values(a.contents).forEach(l=>{l.type==="folder"&&l.fullPath&&n(l.fullPath,l,e)}))}else console.log("Preserving non-folder item in C://:",i,a.type,a.name)}const t=["C://Desktop","C://Documents","C://Media"];for(const r of t)e.folders[r]||(e.folders[r]={},o=!0,console.log("Created essential folder:",r));function n(r,i,a){i.contents&&Object.keys(i.contents).length>0&&(a.folders[r]||(a.folders[r]={}),Object.assign(a.folders[r],i.contents),Object.values(i.contents).forEach(s=>{s.type==="folder"&&s.fullPath&&n(s.fullPath,s,a)}))}return console.log(o?"Migration completed with changes":"No migration needed"),console.log("Final migrated filesystem state:",e),console.log("=== Migration complete ==="),e}async function kt(){rt=!0,typeof window<"u"&&(window.isInitializing=!0);try{await E.ensureReady()}catch(o){console.error("Failed to initialize storage:",o)}let e;try{e=await E.getItem("appState")}catch(o){console.error("Failed to load app state from storage:",o),e=null}if(e){const o=e;if(o.fileSystemState&&typeof o.fileSystemState=="object"){const n=ht(o.fileSystemState);re(n)}else{console.warn("Invalid fileSystemState in saved data, using default");const n=ht(ve);re(n)}H=o.windowStates&&typeof o.windowStates=="object"?o.windowStates:{},Q=o.desktopIconsState&&typeof o.desktopIconsState=="object"?o.desktopIconsState:{},he=o.navWindows&&typeof o.navWindows=="object"?o.navWindows:{};let t=[];try{const n=await E.getItem("startMenuOrder");n&&Array.isArray(n)?t=n:o.startMenuOrder&&Array.isArray(o.startMenuOrder)&&(t=o.startMenuOrder)}catch(n){console.warn("⚠ Error loading from direct storage, using appState:",n),t=o.startMenuOrder&&Array.isArray(o.startMenuOrder)?o.startMenuOrder:[]}W=t,typeof window<"u"&&(window.startMenuOrder=W),ee={clockSeconds:!1,bgColor:"#20b1b1",bgImage:"",...o.desktopSettings||{}},typeof window<"u"&&typeof window.applyDesktopSettings=="function"&&window.applyDesktopSettings(),setTimeout(async()=>{const n=await Ie();if(n&&n.folders&&n.folders["C://Media"]){const a=n.folders["C://Media"];if(a&&!Object.values(a).some(l=>l.name==="too_many_screws_final.mp3")){const l={id:"default-music-file",name:"too_many_screws_final.mp3",type:"ugc-file",fullPath:"C://Media/too_many_screws_final.mp3",content_type:"mp3",icon:"image/audio.png",contents:"",file:null,isDefault:!0,path:"media/too_many_screws_final.mp3",isSystemFile:!0};n.folders["C://Media"]["default-music-file"]=l,re(n),await O()}}const r=n.folders["C://Documents"]||{};Object.keys(r).length===0&&(typeof fetchDocuments=="function"?await fetchDocuments():typeof fetchDocumentsSync=="function"&&fetchDocumentsSync())},100)}else{W=[],typeof window<"u"&&(window.startMenuOrder=W);const t={fileSystemState:ht(ve),windowStates:H,desktopIconsState:Q,desktopSettings:ee,navWindows:he};try{await E.setItem("appState",t)}catch(n){console.error("Failed to save initial app state:",n)}setTimeout(async()=>{const n=await Ie();if(n.folders["C://Media"]&&!Object.values(n.folders["C://Media"]).some(i=>i.name==="too_many_screws_final.mp3")){const i={id:"default-music-file",name:"too_many_screws_final.mp3",type:"ugc-file",fullPath:"C://Media/too_many_screws_final.mp3",content_type:"mp3",icon:"image/audio.png",contents:"",file:null,isDefault:!0,path:"media/too_many_screws_final.mp3",isSystemFile:!0};n.folders["C://Media"]["default-music-file"]=i,re(n),await O()}},100),setTimeout(async()=>{typeof fetchDocuments=="function"?await fetchDocuments():(console.warn("fetchDocuments function not available, trying sync version"),typeof fetchDocumentsSync=="function"&&fetchDocumentsSync())},200)}rt=!1,typeof window<"u"&&(window.isInitializing=!1)}async function Cr(){const e=await E.getItem("fileSystemState");e&&(ve=e)}async function kr(){if(H&&Object.keys(H).length>0){const e=Object.entries(H).sort(([,o],[,t])=>(o.zIndex||0)-(t.zIndex||0));for(const[o,t]of e)createWindow(t.title,t.content,t.isNav,t.id,t.isMinimized,!0,t.dimensions,t.windowType,null,t.color||"white",t.zIndex),await rn(t.id);if(typeof window.initializeAllLetterPadEditors=="function")try{await window.initializeAllLetterPadEditors()}catch(o){console.warn("Error during global LetterPad initialization:",o)}}}async function rn(e){await new Promise(t=>setTimeout(t,50));const o={"storage-window":()=>{typeof nt=="function"?setTimeout(nt,100):console.warn("loadStorageData function not available for storage window restoration")},calculator:()=>{const t=document.getElementById("calculator");if(t){const n=t.querySelector(".p-2");$e(n)&&initializeCalculatorUI(t)}},mediaplayer:()=>{const t=document.getElementById("mediaplayer");if(t){const n=t.querySelector(".p-2");$e(n)&&initializeMediaPlayerUI(t)}},bombbroomer:()=>{const t=document.getElementById("bombbroomer");if(t){const n=t.querySelector(".p-2");$e(n)&&(typeof initializeBombbroomerUI=="function"?initializeBombbroomerUI(t):console.warn("initializeBombbroomerUI function not available"))}},solitaire:()=>{const t=document.getElementById("solitaire");if(t){const n=t.querySelector(".p-2");$e(n)&&initializeSolitaireUI(t)}},chess:()=>{const t=document.getElementById("chess");if(t){const n=t.querySelector(".p-2");$e(n)&&(typeof initializeChessUI=="function"?initializeChessUI(t):console.warn("initializeChessUI function not available"))}},"compost-bin":()=>{console.log("🗑️ Initializing restored Compost Bin window");const t=document.getElementById("compost-bin");if(t){const n=t.querySelector(".p-2");if(console.log("🗑️ Content element found:",!!n,"Current content:",n==null?void 0:n.innerHTML.length,"chars"),n&&$e(n)){console.log("🗑️ Compost Bin needs reinitialization - rebuilding UI"),n.innerHTML="",n.className="p-2 bg-gray-100 h-full flex flex-col";const r=document.createElement("div");r.className="h-full flex flex-col";const i=document.createElement("div");i.className="bg-gray-200 border-b border-gray-400 p-2 flex justify-between items-center";const a=document.createElement("div");a.className="text-sm";const d=(getFileSystemStateSync().folders["C://Desktop"]||{}).compostbin,f=Object.keys((d==null?void 0:d.contents)||{}).length;a.textContent=`Compost Bin - ${f} item(s)`;const m=document.createElement("div");m.className="flex space-x-2";const u=document.createElement("button");u.className="px-3 py-1 bg-gray-300 border-2 border-gray-400 hover:bg-gray-200 text-xs",u.textContent="Empty Bin",typeof emptyCompostBin=="function"&&u.addEventListener("click",emptyCompostBin),m.appendChild(u),i.appendChild(a),i.appendChild(m);const p=document.createElement("div");p.className="flex-1 bg-white border border-gray-400 p-2 overflow-auto",p.id="compost-bin-content",typeof loadCompostBinContents=="function"?(console.log("🗑️ Loading compost bin contents"),loadCompostBinContents(p)):console.warn("🗑️ loadCompostBinContents function not available"),r.appendChild(i),r.appendChild(p),n.appendChild(r),console.log("🗑️ Compost Bin UI rebuilt successfully")}else{console.log("🗑️ Compost Bin content exists, just reloading contents");const r=t.querySelector("#compost-bin-content");r&&typeof loadCompostBinContents=="function"?(loadCompostBinContents(r),typeof updateCompostBinHeader=="function"&&updateCompostBinHeader(t)):console.warn("Compost bin content area not found or loadCompostBinContents not available")}}else console.warn("🗑️ Compost bin window not found during restoration")},watercolour:()=>{const t=document.getElementById("watercolour");if(t){const n=t.querySelector(".p-2");$e(n)?initializeWatercolourUI(t):typeof initializeWatercolour=="function"?initializeWatercolour():initializeWatercolourUI(t)}},tubestream:()=>{typeof initializeTubeStream=="function"&&setTimeout(initializeTubeStream,100)},"explorer-window":()=>{const t=document.getElementById("explorer-window");t&&(typeof initializeFileExplorerUI=="function"?initializeFileExplorerUI(t):typeof restoreFileExplorerState=="function"&&setTimeout(restoreFileExplorerState,100))}};if(o[e])try{o[e]()}catch(t){console.warn(`Failed to initialize restored app ${e}:`,t)}else{const t=document.getElementById(e);if(t){const n=t.querySelector(".letterpad_editor");if(n)try{typeof initializeLetterPad=="function"?await initializeLetterPad(n):console.warn("initializeLetterPad function not available")}catch(r){console.warn(`Failed to initialize LetterPad editor in window ${e}:`,r)}}}}function $e(e){if(!e)return!0;const o=e.innerHTML.trim();return!o||o.length<50&&!o.includes("button")&&!o.includes("canvas")&&!o.includes("input")?!0:!e.querySelector('button, canvas, input[type="text"], .game-board, #media-container, #game-grid, #calc-display, #compost-bin-content')}function Ir(e,o){if(typeof o!="function"){console.warn(`Launch function not available for ${e}`);return}const t=document.getElementById(e);if(!t){console.warn(`Window ${e} not found for reinitialization`);return}try{const n=e+"-temp-"+Date.now();t.id=n,o();const r=document.getElementById(e);if(r&&r!==t){const i=t.querySelector(".p-2"),a=r.querySelector(".p-2");i&&a&&(i.innerHTML=a.innerHTML,i.className=a.className),r.remove();const s=document.getElementById("tab-"+e);s&&s.remove(),delete H[e]}t.id=e}catch(n){t&&t.id!==e&&(t.id=e),console.error(`Failed to reinitialize ${e}:`,n)}}function Lr(){}async function Dr(){try{await O()}catch(e){console.error("Failed to save state manually:",e)}}function Mr(e){rn(e)}function Br(e){const o={calculator:launchCalculator,mediaplayer:launchMediaPlayer,bombbroomer:launchBombbroomer,solitaire:launchSolitaire};o[e]?Ir(e,o[e]):console.warn(`No launch function found for ${e}`)}function Fr(){const e=document.getElementById("bombbroomer");e&&typeof initializeBombbroomerUI=="function"?initializeBombbroomerUI(e):console.warn("Bombbroomer window not found or function not available")}async function Tr(){try{if(await O(),await E.getItem("appState")){const o=await navigator.storage.estimate();return!0}else return console.error("✗ No data found after save"),!1}catch(e){return console.error("✗ Data integrity test failed:",e),!1}}async function Ar(){try{const e=await E.getItem("appState"),o=await E.getItem("explicitRestart");return!!e}catch(e){return console.error("✗ Session persistence test failed:",e),!1}}async function $r(){await E.setItem("explicitRestart",!0)}typeof window<"u"&&(window.debugWindowStates=Lr,window.forceSaveState=Dr,window.testAppRestoration=Mr,window.testAppReinitialization=Br,window.testBombbroomerInit=Fr,window.testDataIntegrity=Tr,window.testSessionPersistence=Ar,window.simulateRestart=$r,window.saveState=O,window.getFileSystemState=Ie,window.setFileSystemState=re,window.updateContent=Fe);window.addEventListener("beforeunload",async e=>{try{const o={fileSystemState:ve,windowStates:H,desktopIconsState:Q,desktopSettings:ee,navWindows:he};E.setItemSync("appState",o)}catch(o){console.error("Failed to save state during page unload:",o)}});setInterval(async()=>{try{await O()}catch(e){console.error("Failed to save periodic backup:",e)}},3e4);async function Pr(){for(const e in Q){const o=document.getElementById(e);if(o){const t=Q[e];o.style.position="absolute",o.style.left=t.left,o.style.top=t.top}}}Cr().then(()=>{}).catch(console.error);const je=[{id:"mycomp",text:"My Computer",icon:"image/computer.png",type:"item"},{id:"mediaapp",text:"Media Player",icon:"image/video.png",type:"item"},{id:"watercolourapp",text:"Watercolour",icon:"image/watercolour.png",type:"item"},{id:"utilities-group",text:"Utilities",type:"group",items:[{id:"letterpad",text:"LetterPad",icon:"image/file.png"},{id:"calcapp",text:"Calculator",icon:"image/calculator.png"},{id:"sysset",text:"System Settings",icon:"image/gears.png"},{id:"storageapp",text:"Storage Manager",icon:"image/drive_c.png"},{id:"abtcomp",text:"About This Computer",icon:"image/info.png"}]},{id:"games-group",text:"Games",type:"group",items:[{id:"solapp",text:"Solitaire",icon:"image/solitaire.png"},{id:"chessapp",text:"Guillotine Chess",icon:"image/guillotine_chess.png"},{id:"bombapp",text:"Bombbroomer",icon:"image/bombbroomer.png"}]},{id:"rstrtcomp",text:"Restart",icon:"image/power.png",type:"item",fixed:!0}];let w={isDragging:!1,draggedElement:null,draggedFromGroup:null,placeholder:null,startY:0,startX:0,draggedItemData:null};function Nt(){const e=document.getElementById("start-menu");if(!e){console.error("Start menu container not found");return}const o=typeof W<"u"?W:window.startMenuOrder||[];let t=[...je];if(o&&o.length>0){const r=[],i=new Set;o.forEach(a=>{if(typeof a=="string"){const s=je.find(l=>l.id===a);s&&(r.push(s),i.add(a))}else if(a&&a.type==="group"){let s=je.find(l=>l.type==="group"&&(l.id===a.id||l.text===a.name));if(s){const l={...s,items:a.items||s.items};r.push(l),i.add(s.id)}else console.log("🔄 Recreating custom group:",a.name),r.push({id:a.id||`custom-group-${Date.now()}`,text:a.name,type:"group",items:a.items||[]})}}),je.forEach(a=>{!i.has(a.id)&&!a.fixed&&r.push(a)}),je.forEach(a=>{a.fixed&&r.push(a)}),t=r}const n=document.createElement("ul");t.forEach(r=>{if(r.type==="item"){const i=zr(r);n.appendChild(i)}else if(r.type==="group"){const i=Or(r);n.appendChild(i)}}),e.innerHTML="",e.appendChild(n),console.log("✅ Start menu HTML generated with",t.length,"items")}function zr(e){const o=document.createElement("li");return o.id=e.id,o.className=e.fixed?"px-4 py-2 hover:bg-gray-50 cursor-pointer flex items-center relative":"px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center relative",o.innerHTML=`
    <img src="${e.icon}" class="h-6 w-6 inline mr-2" alt="${e.text}">
    ${e.text}
  `,o.addEventListener("click",t=>{var n;((n=o.querySelector(".start-menu-context-menu"))==null?void 0:n.style.display)==="none"&&We(e.id)}),e.fixed||an(o,e,!1),o}function Or(e){const o=document.createElement("li");o.className="group relative",o.setAttribute("data-group-id",e.id);let t="";e.items.forEach(a=>{t+=`
      <li id="${a.id}" class="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center submenu-item relative" data-submenu-item data-parent-group="${e.id}">
        <img src="${a.icon}" class="h-6 w-6 inline mr-2" alt="${a.text}">
        ${a.text}
      </li>
    `}),o.innerHTML=`
    <a href="#" data-submenu-trigger class="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center justify-between">
      <div class="flex items-center">
        ${e.text}
      </div>
      <span class="md:rotate-0 text-xs">&#9654;</span>
    </a>
    <ul class="submenu hidden pl-4 bg-gray-100 md:pl-0 md:absolute md:left-full md:bottom-0 md:w-48 md:bg-white md:border md:border-gray-500 md:shadow-lg" data-submenu-container data-group-id="${e.id}">
      ${t}
    </ul>
  `,o.querySelectorAll("ul li").forEach((a,s)=>{a.addEventListener("click",d=>{var f;((f=a.querySelector(".start-menu-context-menu"))==null?void 0:f.style.display)==="none"&&We(a.id)});const l=e.items[s];l&&an(a,l,!0,e.id)});const r=o.querySelector("[data-submenu-trigger]"),i=o.querySelector("[data-submenu-container]");if(r&&i){let a;window.matchMedia("(hover: hover)").matches?(o.addEventListener("mouseenter",()=>{clearTimeout(a),i.classList.remove("hidden"),i.classList.add("block")}),o.addEventListener("mouseleave",()=>{a=setTimeout(()=>{i.classList.add("hidden"),i.classList.remove("block")},100)})):r.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation();const d=!i.classList.contains("hidden");document.querySelectorAll("[data-submenu-container]").forEach(f=>{f!==i&&(f.classList.add("hidden"),f.classList.remove("block"))}),d?(i.classList.add("hidden"),i.classList.remove("block")):(i.classList.remove("hidden"),i.classList.add("block"))})}return o}function We(e){if(!w.isDragging){if(typeof toggleStartMenu=="function")toggleStartMenu();else{const o=document.getElementById("start-menu");o&&o.classList.add("hidden")}switch(e){case"mycomp":typeof openExplorer=="function"&&openExplorer("C://");break;case"abtcomp":typeof openAboutWindow=="function"&&openAboutWindow();break;case"sysset":typeof openNav=="function"&&openNav("Settings","",{type:"integer",width:600,height:400},"Settings");break;case"storageapp":typeof openApp=="function"&&openApp("storage");break;case"watercolourapp":typeof openApp=="function"&&openApp("watercolour");break;case"letterpad":typeof createNewFile=="function"&&createNewFile(null,"C://Documents",o=>{typeof openFile=="function"&&openFile(o,{target:document.body})});break;case"calcapp":typeof openApp=="function"&&openApp("calculator");break;case"solapp":typeof openApp=="function"&&openApp("solitaire");break;case"chessapp":typeof openApp=="function"&&openApp("chess");break;case"bombapp":typeof openApp=="function"&&openApp("bombbroomer");break;case"mediaapp":typeof openApp=="function"&&openApp("mediaplayer");break;case"rstrtcomp":typeof restart=="function"&&restart();break;default:console.warn("Unknown start menu item clicked:",e)}}}function an(e,o,t=!1,n=null){let r=!1;const a=!["mycomp","storageapp","sysset"].includes(o.id),s=document.createElement("div");s.className="start-menu-context-menu absolute hidden bg-gray-100 border-r border-t border-b border-gray-500 z-50 w-48",s.style.display="none";let l=`
    <div class="context-menu-item px-4 py-2 hover:bg-gray-50 cursor-pointer select-none flex items-center" data-action="open">
      Open
    </div>
    <div class="context-menu-item px-4 py-2 hover:bg-gray-50 cursor-pointer select-none flex items-center" data-action="shortcut">
      Create shortcut
    </div>`;a&&(l+=`
    <div class="context-menu-item px-4 py-2 hover:bg-gray-50 cursor-pointer select-none flex items-center text-red-600" data-action="uninstall">
      Uninstall
    </div>`),s.innerHTML=l,e.appendChild(s),s.addEventListener("click",c=>{var v;c.stopPropagation();const h=(v=c.target.closest(".context-menu-item"))==null?void 0:v.dataset.action;h&&(Nr(h,o,t,n),p(s))});let d;e.addEventListener("mouseenter",()=>{w.isDragging||(clearTimeout(d),d=setTimeout(()=>{!r&&!w.isDragging&&u(s,e)},800))}),e.addEventListener("mouseleave",()=>{clearTimeout(d),setTimeout(()=>{s.matches(":hover")||p(s)},200)}),s.addEventListener("mouseleave",()=>{setTimeout(()=>{e.matches(":hover")||p(s)},200)});let f,m=!1;e.addEventListener("touchstart",c=>{w.isDragging||(m=!1,f=setTimeout(()=>{!m&&!r&&(c.preventDefault(),u(s,e))},500))}),e.addEventListener("touchmove",()=>{m=!0,clearTimeout(f)}),e.addEventListener("touchend",()=>{clearTimeout(f)}),document.addEventListener("click",c=>{!s.contains(c.target)&&!e.contains(c.target)&&p(s)});function u(c,h){document.querySelectorAll(".start-menu-context-menu").forEach(F=>{F!==c&&(F.style.display="none")}),c.style.display="block",c.classList.remove("hidden"),r=!0;const v=h.getBoundingClientRect(),M=c.getBoundingClientRect();c.style.left=`${h.offsetWidth}px`,c.style.top="-1px",document.getElementById("start-menu").getBoundingClientRect(),v.right+M.width>window.innerWidth&&(c.style.left=`-${M.width+5}px`)}function p(c){c.style.display="none",c.classList.add("hidden"),r=!1}}function Nr(e,o,t,n){switch(e){case"open":We(o.id);break;case"shortcut":if(Rr(o),typeof toggleStartMenu=="function")toggleStartMenu();else{const r=document.getElementById("start-menu");r&&r.classList.add("hidden")}break;case"uninstall":if(Wr(o,t,n),typeof toggleStartMenu=="function")toggleStartMenu();else{const r=document.getElementById("start-menu");r&&r.classList.add("hidden")}break}}async function Rr(e){try{const o=await getFileSystemState();if(!o.folders["C://Desktop"]){console.error("Desktop folder not found"),typeof showDialogBox=="function"&&showDialogBox("Desktop folder not found","error");return}const t=`shortcut-${e.id}-${Date.now()}`;let n=e.icon||"image/file.png";const r={id:t,name:e.text,type:"app",fullPath:`C://Desktop/${t}`,content_type:"html",contents:{},icon:n,isShortcut:!0,targetId:e.id};o.folders["C://Desktop"][t]=r,await re(o),await O(),typeof renderDesktopIcons=="function"?renderDesktopIcons():typeof window.renderDesktopIcons=="function"&&window.renderDesktopIcons(),console.log("✅ Desktop shortcut created:",r)}catch(o){console.error("❌ Failed to create desktop shortcut:",o),typeof showDialogBox=="function"&&showDialogBox("Failed to create desktop shortcut","error")}}function Wr(e,o,t){const n=`Are you sure you want to uninstall "${e.text}" from the Start menu?`;typeof showDialogBox=="function"?showDialogBox(n,"confirmation",()=>{ao(e,o,t)},()=>{console.log("Uninstall cancelled by user")}):confirm(n)&&ao(e,o,t)}async function ao(e,o,t){try{console.log("🗑️ Uninstalling item:",e.id,{isSubmenuItem:o,parentGroupId:t});let n=[];try{const r=await E.getItem("startMenuOrder");r&&Array.isArray(r)?n=r:n=typeof W<"u"?W:window.startMenuOrder||[]}catch{n=typeof W<"u"?W:window.startMenuOrder||[]}if(o&&t){const r=n.map(i=>typeof i=="object"&&i.type==="group"&&i.id===t?{...i,items:i.items.filter(a=>a.id!==e.id)}:i);window.startMenuOrder=r,typeof W<"u"&&(W=r),await E.setItem("startMenuOrder",r)}else{const r=n.filter(i=>typeof i=="string"?i!==e.id:!0);window.startMenuOrder=r,typeof W<"u"&&(W=r),await E.setItem("startMenuOrder",r)}typeof O=="function"&&await O(),Nt(),setTimeout(()=>{Wt()},50),typeof showDialogBox=="function"&&showDialogBox(`"${e.id}" has been uninstalled from the Start menu`,"info"),console.log("✅ Item uninstalled successfully")}catch(n){console.error("❌ Failed to uninstall item:",n),typeof showDialogBox=="function"&&showDialogBox("Failed to uninstall item","error")}}function sn(){Nt();const e=document.getElementById("start-menu");if(!e)return console.warn("Start menu element not found"),!1;const o=e.querySelectorAll("ul > li:not(.group):not(#rstrtcomp)"),t=e.querySelectorAll(".submenu-item");return console.log("🎯 Initializing drag and drop for",o.length,"main menu items and",t.length,"submenu items"),o.forEach(n=>{ln(n)}),t.forEach(n=>{Rt(n)}),_r(),!0}function _r(){const e=document.getElementById("start-menu");e&&(e.addEventListener("dragover",o=>{const t=o.target.closest(".group");if(t&&w.isDragging){const n=t.querySelector("[data-submenu-container]");n&&(n.classList.remove("hidden"),n.classList.add("block"))}}),e.addEventListener("dragleave",o=>{w.isDragging||e.querySelectorAll("[data-submenu-container]").forEach(n=>{n.classList.remove("block")})}))}function Rt(e){e.addEventListener("pointerdown",t);function t(i){var f;if(i.button!==0)return;w.startY=i.clientY,w.startX=i.clientX,w.draggedElement=e,w.draggedFromGroup=e.getAttribute("data-parent-group");const a=((f=e.querySelector("img"))==null?void 0:f.src)||"",s=e.cloneNode(!0),l=s.querySelector(".start-menu-context-menu");l&&l.remove();const d=s.textContent.trim();w.draggedItemData={id:e.id,text:d,icon:a,parentGroup:w.draggedFromGroup},document.addEventListener("pointermove",n),document.addEventListener("pointerup",r),document.addEventListener("pointercancel",r),i.preventDefault()}function n(i){if(!i.isPrimary)return;const a=Math.sqrt(Math.pow(i.clientY-w.startY,2)+Math.pow(i.clientX-w.startX,2));!w.isDragging&&a>5&&(w.isDragging=!0,qr(e)),w.isDragging&&jr(i)}function r(i){i.isPrimary&&(document.removeEventListener("pointermove",n),document.removeEventListener("pointerup",r),document.removeEventListener("pointercancel",r),w.isDragging&&Ur(),cn())}}function ln(e){e.addEventListener("pointerdown",t);function t(i){i.button===0&&(w.startY=i.clientY,w.draggedElement=e,document.addEventListener("pointermove",n),document.addEventListener("pointerup",r),document.addEventListener("pointercancel",r),i.preventDefault())}function n(i){if(!i.isPrimary)return;const a=Math.abs(i.clientY-w.startY);!w.isDragging&&a>5&&(w.isDragging=!0,Hr(e)),w.isDragging&&Gr(i)}function r(i){i.isPrimary&&(document.removeEventListener("pointermove",n),document.removeEventListener("pointerup",r),document.removeEventListener("pointercancel",r),w.isDragging&&Yr(),cn())}}function cn(){w.placeholder&&w.placeholder.remove(),w.draggedElement&&(w.draggedElement.classList.remove("opacity-50","cursor-grabbing"),w.draggedElement.classList.add("cursor-grab")),document.querySelectorAll(".start-menu-context-menu").forEach(e=>{e.style.display="none",e.classList.add("hidden")}),w.isDragging=!1,w.draggedElement=null,w.draggedFromGroup=null,w.placeholder=null,w.startY=0,w.startX=0,w.draggedItemData=null}function qr(e,o){document.querySelectorAll(".start-menu-context-menu").forEach(t=>{t.style.display="none",t.classList.add("hidden")}),e.classList.add("opacity-50","cursor-grabbing"),e.classList.remove("cursor-grab"),w.placeholder=document.createElement("li"),w.placeholder.className="submenu-placeholder h-8 bg-blue-100 border-2 border-dashed border-blue-500 rounded my-0.5 px-4 py-1",w.placeholder.innerHTML='<span class="text-yellow-600 text-sm"></span>',e.parentNode.insertBefore(w.placeholder,e.nextSibling)}function jr(e){if(!w.placeholder||!w.draggedItemData)return;const o=document.getElementById("start-menu"),t=document.elementFromPoint(e.clientX,e.clientY),n=t==null?void 0:t.closest("[data-submenu-container]");t==null||t.closest(".submenu-item");const r=t==null?void 0:t.closest("ul > li:not(.group)");if(n){n.getAttribute("data-group-id");const i=Array.from(n.querySelectorAll(".submenu-item")).filter(l=>l!==w.draggedElement&&!l.classList.contains("submenu-placeholder"));let a=null,s=!0;for(let l=0;l<i.length;l++){const d=i[l],f=d.getBoundingClientRect(),m=f.top+f.height/2;if(e.clientY<m){a=d,s=!0;break}else if(l===i.length-1){a=d,s=!1;break}}a?s?n.insertBefore(w.placeholder,a):n.insertBefore(w.placeholder,a.nextSibling):n.appendChild(w.placeholder)}else if(r&&!r.classList.contains("group")){const i=o.querySelector("ul"),a=Array.from(i.children).filter(d=>d!==w.draggedElement&&!d.classList.contains("start-menu-placeholder")&&!d.classList.contains("group")&&d.id!=="rstrtcomp");w.placeholder.classList.contains("start-menu-placeholder")||(w.placeholder.className="start-menu-placeholder h-10 bg-indigo-100 border-2 border-dashed border-indigo-500 rounded my-0.5",w.placeholder.innerHTML="");let s=null,l=!0;for(let d=0;d<a.length;d++){const f=a[d],m=f.getBoundingClientRect(),u=m.top+m.height/2;if(e.clientY<u){s=f,l=!0;break}else if(d===a.length-1){s=f,l=!1;break}}if(s)l?i.insertBefore(w.placeholder,s):i.insertBefore(w.placeholder,s.nextSibling);else{const d=i.querySelector("#rstrtcomp");d?i.insertBefore(w.placeholder,d):i.appendChild(w.placeholder)}}}function Ur(e){if(!w.placeholder||!w.draggedElement||!w.draggedItemData){console.log("❌ Submenu drag operation aborted - missing required elements");return}console.log("🎯 Completing submenu drag operation..."),w.draggedElement.classList.remove("opacity-50","cursor-grabbing");const o=w.placeholder.parentNode,t=o.tagName==="UL"&&!o.hasAttribute("data-submenu-container"),n=o.getAttribute("data-group-id");if(t){console.log("📤 Moving item from submenu to main menu"),w.draggedElement.remove();const r=document.createElement("li");r.id=w.draggedItemData.id,r.className="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center",r.innerHTML=`
      <img src="${w.draggedItemData.icon}" class="h-6 w-6 inline mr-2" alt="${w.draggedItemData.text}">
      ${w.draggedItemData.text}
    `,r.addEventListener("click",()=>We(r.id)),o.insertBefore(r,w.placeholder),w.placeholder.remove(),ln(r)}else if(n&&n!==w.draggedFromGroup){console.log("🔄 Moving item between submenus"),w.draggedElement.remove();const r=document.createElement("li");r.id=w.draggedItemData.id,r.className="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center submenu-item",r.setAttribute("data-submenu-item",""),r.setAttribute("data-parent-group",n),r.innerHTML=`
      <img src="${w.draggedItemData.icon}" class="h-6 w-6 inline mr-2" alt="${w.draggedItemData.text}">
      ${w.draggedItemData.text}
    `,r.addEventListener("click",()=>We(r.id)),o.insertBefore(r,w.placeholder),w.placeholder.remove(),Rt(r)}else n===w.draggedFromGroup&&(console.log("🔄 Reordering within same submenu"),o.insertBefore(w.draggedElement,w.placeholder),w.placeholder.remove());setTimeout(async()=>{try{await _e(),console.log("💾 Submenu drag operation saved")}catch(r){console.error("❌ Failed to save submenu changes:",r)}},10)}function Hr(e,o){document.querySelectorAll(".start-menu-context-menu").forEach(t=>{t.style.display="none",t.classList.add("hidden")}),e.classList.add("opacity-50","cursor-grabbing"),e.classList.remove("cursor-grab"),w.placeholder=document.createElement("li"),w.placeholder.className="start-menu-placeholder h-10 bg-indigo-100 border-2 border-dashed border-indigo-500 rounded my-0.5",e.parentNode.insertBefore(w.placeholder,e.nextSibling)}function Gr(e){if(!w.placeholder)return;const o=document.getElementById("start-menu"),t=document.elementFromPoint(e.clientX,e.clientY),n=t==null?void 0:t.closest("[data-submenu-container]");if(n&&w.draggedElement&&!w.draggedElement.classList.contains("submenu-item")){n.getAttribute("data-group-id");const l=Array.from(n.querySelectorAll(".submenu-item")).filter(m=>!m.classList.contains("submenu-placeholder"));w.placeholder.classList.contains("submenu-placeholder")||(w.placeholder.className="submenu-placeholder h-8 bg-blue-100 border-2 border-dashed border-blue-500 rounded my-0.5 px-4 py-1",w.placeholder.innerHTML='<span class="text-blue-600 text-sm"></span>');let d=null,f=!0;for(let m=0;m<l.length;m++){const u=l[m],p=u.getBoundingClientRect(),c=p.top+p.height/2;if(e.clientY<c){d=u,f=!0;break}else if(m===l.length-1){d=u,f=!1;break}}d?f?n.insertBefore(w.placeholder,d):n.insertBefore(w.placeholder,d.nextSibling):n.appendChild(w.placeholder);return}const r=o.querySelector("ul"),i=Array.from(r.children).filter(l=>l!==w.draggedElement&&!l.classList.contains("start-menu-placeholder")&&!l.classList.contains("group")&&l.id!=="rstrtcomp");w.placeholder.classList.contains("start-menu-placeholder")||(w.placeholder.className="start-menu-placeholder h-10 bg-indigo-100 border-2 border-dashed border-indigo-500 rounded my-0.5",w.placeholder.innerHTML="");let a=null,s=!0;for(let l=0;l<i.length;l++){const d=i[l],f=d.getBoundingClientRect(),m=f.top+f.height/2;if(e.clientY<m){a=d,s=!0;break}else if(l===i.length-1){a=d,s=!1;break}}if(a)s?r.insertBefore(w.placeholder,a):r.insertBefore(w.placeholder,a.nextSibling);else{const l=r.querySelector("#rstrtcomp");l&&r.insertBefore(w.placeholder,l)}}function Yr(e){var r;if(!w.placeholder||!w.draggedElement){console.log("❌ Drag operation aborted - missing placeholder or dragged element");return}console.log("🎯 Starting main menu drag completion..."),console.log("Dragged element:",w.draggedElement.id,(()=>{var s;const i=w.draggedElement.cloneNode(!0),a=i.querySelector(".start-menu-context-menu");return a&&a.remove(),(s=i.textContent)==null?void 0:s.trim()})()),w.draggedElement.classList.remove("opacity-50","cursor-grabbing");const o=w.placeholder.parentNode,t=o.hasAttribute("data-submenu-container"),n=o.getAttribute("data-group-id");if(t){console.log("📥 Moving main menu item to submenu:",n);const i=w.draggedElement.cloneNode(!0),a=i.querySelector(".start-menu-context-menu");a&&a.remove();const s={id:w.draggedElement.id,text:i.textContent.trim(),icon:((r=w.draggedElement.querySelector("img"))==null?void 0:r.src)||""};w.draggedElement.remove();const l=document.createElement("li");l.id=s.id,l.className="px-4 py-2 hover:bg-gray-50 cursor-grab select-none flex items-center submenu-item",l.setAttribute("data-submenu-item",""),l.setAttribute("data-parent-group",n),l.innerHTML=`
      <img src="${s.icon}" class="h-6 w-6 inline mr-2" alt="${s.text}">
      ${s.text}
    `,l.addEventListener("click",()=>We(l.id)),o.insertBefore(l,w.placeholder),w.placeholder.remove(),Rt(l)}else w.draggedElement.classList.add("cursor-grab"),o.insertBefore(w.draggedElement,w.placeholder),w.placeholder.remove();console.log("✅ DOM manipulation complete, waiting 10ms before save..."),setTimeout(async()=>{try{console.log("🔄 Starting save operation..."),await _e(),console.log("💾 Save operation completed")}catch(i){console.error("❌ Failed to save start menu order:",i)}},10)}async function _e(){if(typeof window.isInitializing<"u"&&window.isInitializing)return;const o=document.getElementById("start-menu").querySelector("ul"),t=Array.from(o.children),n=[];if(t.forEach(r=>{if(r.id&&!r.classList.contains("group")&&r.id!=="rstrtcomp")n.push(r.id);else if(r.classList.contains("group")){const i=r.getAttribute("data-group-id"),a=r.querySelector("[data-submenu-trigger]"),s=r.querySelector("[data-submenu-container]");if(a&&s&&i){const l=a.cloneNode(!0),d=l.querySelector(".start-menu-context-menu");d&&d.remove();const f=l.textContent.trim(),m=Array.from(s.querySelectorAll(".submenu-item")).map(p=>{var v;const c=p.cloneNode(!0),h=c.querySelector(".start-menu-context-menu");return h&&h.remove(),{id:p.id,text:c.textContent.trim(),icon:((v=p.querySelector("img"))==null?void 0:v.src)||""}}),u={type:"group",id:i,name:f,items:m};n.push(u),console.log("🗂️ Saved group structure:",u)}}}),!n||n.length===0){console.warn("Refusing to save empty start menu order - likely a race condition");return}if(console.log("💾 Saving start menu order:",n),typeof window<"u"){window.startMenuOrder=n;try{typeof W<"u"&&(W=n)}catch{console.warn("Global startMenuOrder variable not accessible, using window reference only")}}try{await E.setItem("startMenuOrder",n),console.log("✅ Start menu order saved directly to storage"),typeof O=="function"?(await O(),console.log("✅ Start menu order also saved via appState")):typeof window.saveState=="function"?(await window.saveState(),console.log("✅ Start menu order also saved via window.saveState")):console.warn("⚠ saveState function not available, only saved directly");try{const r=await E.getItem("startMenuOrder");console.log("🔍 Verification: Start menu order in direct storage:",r),JSON.stringify(r)===JSON.stringify(n)?console.log("✓ Start menu order successfully saved and verified via direct storage"):console.warn("⚠ Start menu order mismatch in direct storage after save")}catch(r){console.warn("Could not verify direct save:",r)}}catch(r){console.error("Failed to save start menu order:",r)}}async function pt(){let e=[];try{const o=await E.getItem("startMenuOrder");o&&Array.isArray(o)?(e=o,console.log("✅ Loaded start menu order from direct storage:",e)):(console.log("🔍 No direct storage found, trying global variables..."),e=typeof W<"u"?W:window.startMenuOrder||[])}catch(o){console.warn("⚠ Failed to load from direct storage, using global variables:",o),e=typeof W<"u"?W:window.startMenuOrder||[]}console.log("🔄 Restoring start menu order:",e),console.log("🔍 Global startMenuOrder:",typeof W<"u"?W:"UNDEFINED"),console.log("🔍 Window startMenuOrder:",window.startMenuOrder),typeof window<"u"&&(window.startMenuOrder=e);try{typeof W<"u"&&(W=e)}catch{console.warn("Could not update global startMenuOrder variable")}Nt(),It=!1,setTimeout(()=>{Wt()},50),console.log("✅ Start menu order restored")}let It=!1;document.addEventListener("DOMContentLoaded",()=>{});function Wt(){if(It)return!0;const e=sn();return e&&(It=!0),e}window.initializeStartMenuDragDrop=sn;window.safeInitializeStartMenuDragDrop=Wt;window.restoreStartMenuOrder=pt;window.saveStartMenuOrder=_e;window.debugStartMenuState=async function(){console.log("=== START MENU DEBUG STATE ===");const e=document.getElementById("start-menu"),o=e==null?void 0:e.querySelector("ul"),t=Array.from((o==null?void 0:o.children)||[]).map(n=>{var a;const r=n.cloneNode(!0),i=r.querySelector(".start-menu-context-menu");return i&&i.remove(),{id:n.id,text:(a=r.textContent)==null?void 0:a.trim()}});console.log("Current DOM order:",t),console.log("Global startMenuOrder:",typeof W<"u"?W:"UNDEFINED"),console.log("Window startMenuOrder:",window.startMenuOrder);try{const n=await E.getItem("appState");console.log("Storage appState.startMenuOrder:",n==null?void 0:n.startMenuOrder),console.log("Full storage keys:",await E.getAllKeys())}catch(n){console.error("Error reading from storage:",n)}console.log("saveState function available:",typeof O<"u"||typeof window.saveState<"u"),console.log("storage object available:",typeof E<"u"),console.log("=== END DEBUG STATE ===")};window.testSaveStartMenu=function(){_e().catch(e=>{console.error("Test save failed:",e)})};window.testBasicSave=async function(){if(window.startMenuOrder=["test1","test2","test3"],typeof window.saveState=="function")try{await window.saveState(),console.log("✅ Basic save successful");const e=await E.getItem("appState");console.log("Read back:",e==null?void 0:e.startMenuOrder)}catch(e){console.error("❌ Basic save failed:",e)}else console.error("❌ window.saveState not available")};window.testRealSave=async function(){console.log("🧪 Testing real start menu save..."),await _e(),console.log("🧪 Real save test complete")};window.testRestore=function(){console.log("🧪 Testing start menu restoration..."),pt(),console.log("🧪 Restoration test complete")};function it(){console.log("🚀 Initializing start menu system..."),pt(),console.log("✅ Start menu system initialized")}window.initializeStartMenu=it;window.testFullStartMenuFlow=async function(){console.log("🧪 === FULL START MENU FLOW TEST ==="),console.log("Step 1: Initial state check"),await debugStartMenuState(),console.log("Step 2: Initializing start menu"),it(),console.log("Step 3: State after initialization"),await debugStartMenuState(),console.log("Step 4: Testing save functionality"),await testRealSave(),console.log("Step 5: Testing restoration"),testRestore(),console.log("Step 6: Final state check"),await debugStartMenuState(),console.log("🧪 === END FULL FLOW TEST ===")};window.testStartMenuSave=async function(){console.log("🧪 Testing start menu save functionality...");const e=["app-calculator","app-chess","app-mediaplayer"];console.log("📋 Test order to save:",e),await _e();const o=await E.getItem("startMenuOrder");console.log("📦 Direct storage result:",o);const t=await E.getItem("appState");return console.log("📦 AppState startMenuOrder:",t==null?void 0:t.startMenuOrder),console.log("🌐 Global startMenuOrder:",typeof W<"u"?W:"UNDEFINED"),console.log("🌐 Window startMenuOrder:",window.startMenuOrder),{testOrder:e,directResult:o,appStateResult:t==null?void 0:t.startMenuOrder,globalResult:typeof W<"u"?W:null,windowResult:window.startMenuOrder}};window.testStartMenuRestore=async function(){var o;console.log("🧪 Testing start menu restore functionality..."),typeof window<"u"&&(window.startMenuOrder=[]);try{typeof W<"u"&&(W=[])}catch{console.warn("Could not clear global startMenuOrder")}console.log("🧹 Cleared global variables"),await pt();const e={globalResult:typeof W<"u"?W:null,windowResult:window.startMenuOrder,menuHTML:((o=document.getElementById("start-menu"))==null?void 0:o.innerHTML.substring(0,200))+"..."};return console.log("🔍 Restore results:",e),e};window.debugStorageContents=async function(){console.log("🔍 Debugging storage contents...");try{const e=await E.getItem("appState"),o=await E.getItem("startMenuOrder");return console.log("📦 AppState:",e),console.log("📦 Direct startMenuOrder:",o),console.log("🌐 Global startMenuOrder:",typeof W<"u"?W:"UNDEFINED"),console.log("🌐 Window startMenuOrder:",window.startMenuOrder),{appState:e,directStartMenu:o,globalStartMenu:typeof W<"u"?W:null,windowStartMenu:window.startMenuOrder}}catch(e){return console.error("❌ Error debugging storage:",e),{error:e.message}}};function _t(){const e=document.getElementById("start-menu");e.classList.toggle("hidden"),De("start-button"),Vr(),e.classList.contains("hidden")||setTimeout(()=>{typeof safeInitializeStartMenuDragDrop=="function"?safeInitializeStartMenuDragDrop():typeof initializeStartMenuDragDrop=="function"?initializeStartMenuDragDrop():console.warn("Start menu drag and drop initialization functions not available")},10)}function dn(){for(const e in H)He(e);document.querySelectorAll("#window-tabs > div").forEach(e=>{e.classList.remove("bg-gray-50")})}function Zr(e,o="",t={type:"default"},n="default"){if(he[e]){const r=document.getElementById(he[e]);if(r){Le(r);return}else delete he[e]}V(e,o,!0,null,!1,!1,t,n)}function qt(){const e=document.getElementById("clock"),o=new Date;let t=o.getHours(),n=o.getMinutes(),r=o.getSeconds();t=t<10?"0"+t:t,n=n<10?"0"+n:n,r=r<10?"0"+r:r;let a=typeof ee<"u"&&ee&&ee.clockSeconds||!1?`${t}:${n}:${r}`:`${t}:${n}`;e.textContent=a}function un(){const e=jt();e&&(e.paused?e.play():e.pause(),pn())}function pn(){const e=jt(),o=document.getElementById("media-control");e?o.textContent=e.paused?"▶":"⏸":o.textContent=""}function jt(){if(Re){const e=document.getElementById(Re);if(e)return e.querySelector("video, audio")}return null}setInterval(qt,1e3);qt();document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelectorAll("[data-submenu-trigger]");window.innerWidth<1024&&e.forEach(t=>{const n=t.nextElementSibling,r=t.querySelector("span");t.addEventListener("click",i=>{i.preventDefault(),n.classList.contains("hidden")?(n.classList.remove("hidden"),n.classList.add("block"),r.classList.add("rotate-90")):(n.classList.remove("block"),n.classList.add("hidden"),r.classList.remove("rotate-90"))})})});document.getElementById("media-control").addEventListener("click",()=>{un()});document.getElementById("min-all-btn").addEventListener("click",()=>{_t(),dn()});document.getElementById("start-button").addEventListener("click",()=>{_t()});function Vr(){const e=document.getElementById("start-button").querySelector("img");e.src.includes("image/door-closed.png")?e.src=e.src.replace("door-closed","door-open"):e.src=e.src.replace("door-open","door-closed")}async function Pe(e){if(e.dataset.initialized==="true")return;e.dataset.initialized="true";try{await E.ensureReady()}catch(c){console.warn("Storage not ready, falling back to sync methods:",c)}const o=e.getAttribute("data-letterpad-editor-id"),t=`letterpad_${o}`;let n=null;try{const c=await E.getItem(t);if(c)try{n=c.content}catch(h){console.error("Error accessing stored markdown data for editor "+o,h)}}catch(c){console.warn("Failed to load LetterPad content for editor "+o+", trying sync method:",c);try{const h=E.getItemSync(t);h&&(n=h.content)}catch(h){console.warn("Sync fallback also failed:",h)}}const r=document.createElement("div");r.className="flex flex-col border rounded p-4 bg-white";const i=document.createElement("div");i.className="flex space-x-2 mb-2";const a=document.createElement("select");a.className="border rounded p-1",[{value:"paragraph",text:"Paragraph"},{value:"h1",text:"Heading 1"},{value:"h2",text:"Heading 2"},{value:"h3",text:"Heading 3"}].forEach(c=>{const h=document.createElement("option");h.value=c.value,h.textContent=c.text,a.appendChild(h)}),i.appendChild(a);const l=document.createElement("button");l.type="button",l.className="border rounded p-1 hover:bg-gray-200",l.textContent="Bold",i.appendChild(l);const d=document.createElement("button");d.type="button",d.className="border rounded p-1 hover:bg-gray-200",d.textContent="Italic",i.appendChild(d);const f=document.createElement("button");f.type="button",f.className="border rounded p-1 hover:bg-gray-200",f.textContent="Underline",i.appendChild(f);const m=document.createElement("textarea");m.className="w-full h-40 border rounded p-2 mb-2";const u=document.createElement("div");u.className="w-full h-40 border rounded p-2 overflow-auto";const p=document.createElement("button");p.type="button",p.className="border rounded p-1 hover:bg-gray-200 self-end",n?p.textContent="Edit":p.textContent="Save & Preview",r.appendChild(i),r.appendChild(m),r.appendChild(u),r.appendChild(p),e.appendChild(r),n?(m.value=n,u.innerHTML=Dt(n),m.classList.add("hidden"),i.classList.add("hidden"),p.classList.remove("hidden"),u.classList.remove("hidden")):(u.classList.add("hidden"),l.addEventListener("mousedown",function(c){c.preventDefault(),Lt("**",m)}),d.addEventListener("mousedown",function(c){c.preventDefault(),Lt("*",m)}),f.addEventListener("click",function(){const c=m.selectionStart,h=m.selectionEnd,v=m.value.substring(c,h),M=m.value.substring(0,c),F=m.value.substring(h);if(v.startsWith("<u>")&&v.endsWith("</u>")){const T=v.substring(3,v.length-4);m.value=M+T+F}else{const T=`<u>${v}</u>`;m.value=M+T+F}m.focus(),m.selectionStart=c,m.selectionEnd=h+7}),a.addEventListener("change",function(){const c=a.value,h=m.selectionStart,v=m.value,M=v.lastIndexOf(`
`,h-1)+1;let F="";c==="h1"?F="# ":c==="h2"?F="## ":c==="h3"?F="### ":F="";const T=v.indexOf(`
`,h),R=v.substring(M,T===-1?v.length:T).replace(/^(#{1,6}\s)?/,F);m.value=v.substring(0,M)+R+v.substring(T===-1?v.length:T)})),p.addEventListener("click",async function(){if(m.classList.contains("hidden"))u.classList.add("hidden"),m.classList.remove("hidden"),i.classList.remove("hidden"),p.textContent="Preview & Save";else{const c=m.value;u.innerHTML=Dt(c);try{await E.setItem(t,{content:c})}catch(h){console.warn("Failed to save LetterPad content for editor "+o,h)}m.classList.add("hidden"),u.classList.remove("hidden"),p.textContent="Edit",i.classList.add("hidden")}})}document.addEventListener("DOMContentLoaded",async function(){try{await E.ensureReady()}catch(t){console.warn("Storage not ready during LetterPad initialization:",t)}const e=document.querySelectorAll(".letterpad_editor");for(const t of e)try{await Pe(t)}catch(n){console.error("Error initializing LetterPad editor during DOMContentLoaded:",n)}new MutationObserver(t=>{t.forEach(n=>{n.type==="childList"&&n.addedNodes.forEach(r=>{r.nodeType===Node.ELEMENT_NODE&&(r.classList.contains("letterpad_editor")&&Pe(r).catch(i=>{console.error("Error initializing LetterPad editor:",i)}),r.querySelectorAll&&r.querySelectorAll(".letterpad_editor").forEach(i=>{Pe(i).catch(a=>{console.error("Error initializing LetterPad editor:",a)})}))})})}).observe(document.body,{childList:!0,subtree:!0})});async function fn(){const e=document.querySelectorAll('.letterpad_editor:not([data-initialized="true"])');for(const o of e)try{await Pe(o)}catch(t){console.error("Error initializing LetterPad editor:",t)}}window.initializeAllLetterPadEditors=fn;function Lt(e,o){const t=o.selectionStart,n=o.selectionEnd;if(t===n)return;const r=o.value.substring(t,n),i=o.value.substring(0,t),a=o.value.substring(n),s=e.length,l=r.startsWith(e),d=r.endsWith(e);let f,m=2*s;l&&d?(f=r.slice(s,-s),m=-m):f=e+r+e,o.value=i+f+a,setTimeout(()=>{o.focus(),o.selectionStart=t,o.selectionEnd=n+m},0)}function Dt(e){let o=e;return o=o.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),o=o.replace(/\*(.+?)\*/g,"<em>$1</em>"),o=o.replace(/###### (.*)/g,'<h6 class="mt-1 mb-2 text-2xl">$1</h6>'),o=o.replace(/##### (.*)/g,'<h5 class="mt-1 mb-2 text-3xl">$1</h5>'),o=o.replace(/#### (.*)/g,'<h4 class="mt-1 mb-2 text-4xl">$1</h4>'),o=o.replace(/### (.*)/g,'<h3 class="mt-1 mb-2 text-5xl">$1</h3>'),o=o.replace(/## (.*)/g,'<h2 class="mt-1 mb-2 text-6xl">$1</h2>'),o=o.replace(/# (.*)/g,'<h1 class="mt-1 mb-2 text-7xl">$1</h1>'),o=o.replace(/\n/g,"<br>"),o}document.addEventListener("contextmenu",function(e){let o=e.target.closest(".draggable-icon, .file-item"),t=e.target.closest(".file-explorer-window"),n=e.target.closest("#explorer-window"),r=t||n,i=e.target.closest("#windows-container > div"),a=e.target.closest("#desktop-icons"),l=(e.target.id==="windows-container"||a)&&!i;if(!o&&!r&&!l)return;e.preventDefault();let d;if(t)d=t.getAttribute("data-current-path");else if(n){const f=n.querySelector(".file-explorer-window");d=(f==null?void 0:f.getAttribute("data-current-path"))||"C://"}else l?d="C://Desktop":d="C://";mn(e,o,d)});document.addEventListener("click",function(){pe()});function mn(e,o,t){const n=document.getElementById("context-menu");n.replaceChildren(),n.style.zIndex=ye+100;const r=(a,s,l,d=!1)=>{const f=document.createElement("div");return f.className=`px-4 py-2 relative ${s?"text-gray-400":"hover:bg-gray-50 cursor-pointer"}`,d?f.innerHTML=`${a} <span class="float-right">▶</span>`:f.textContent=a,!s&&l&&f.addEventListener("click",l),n.appendChild(f),f},i=(a,s)=>{const l=document.createElement("div");l.className="absolute left-full top-0 bg-white border border-gray-500 shadow-lg hidden min-w-32",l.style.zIndex=ye+101,s.forEach(({text:f,disabled:m,onclick:u})=>{const p=document.createElement("div");p.textContent=f,p.className=`px-4 py-2 ${m?"text-gray-400":"hover:bg-gray-50 cursor-pointer"}`,!m&&u&&p.addEventListener("click",c=>{pe(),u(c)}),l.appendChild(p)}),a.appendChild(l);let d;a.addEventListener("mouseenter",()=>{clearTimeout(d),l.classList.remove("hidden")}),a.addEventListener("mouseleave",()=>{d=setTimeout(()=>{l.classList.add("hidden")},200)}),a.addEventListener("touchstart",f=>{f.preventDefault(),l.classList.contains("hidden")?l.classList.remove("hidden"):l.classList.add("hidden")}),l.addEventListener("mouseenter",()=>{clearTimeout(d)}),l.addEventListener("mouseleave",()=>{d=setTimeout(()=>{l.classList.add("hidden")},200)})};if(o){o.classList.add("right-click-target");const a=o.getAttribute("data-is-vendor-application")==="true",s=o.getAttribute("data-item-id")==="compostbin",l=o.getAttribute("data-item-id");let d=!1;if(l&&!s){const f=Y();if(f&&f.folders){const m=o.closest(".file-explorer-window");let u=t;m&&(u=m.getAttribute("data-current-path"));const p=f.folders[u];p&&p[l]&&(d=p[l].type==="folder")}}s?r("Empty Compost Bin",!1,f=>{f.stopPropagation(),pe(),typeof emptyCompostBin=="function"&&emptyCompostBin()}):(d&&r("Open in new window",!1,f=>{f.stopPropagation(),pe();const m=document.querySelector(".right-click-target");if(m){const u=m.getAttribute("data-item-id");u&&Ue(u)}m.classList.remove("right-click-target")}),r("Edit Name",a,f=>Kr(f)),r("Delete",a,f=>Xr(f)),r("New Folder",!0),r("New File",!0),r("New Shortcut",!0))}else{r("New Folder",!1,s=>gn(s,t));const a=r("New File",!1,null,!0);i(a,[{text:"LetterPad",disabled:!1,onclick:async s=>await ei(s,t)},{text:"Image",disabled:!1,onclick:s=>ti(s,t)},{text:"Audio",disabled:!1,onclick:s=>oi(s,t)},{text:"Video",disabled:!1,onclick:s=>ni(s,t)}]),r("New Shortcut",!1,s=>Qr(s,t))}n.style.top=`${e.clientY}px`,n.style.left=`${e.clientX}px`,n.classList.remove("hidden")}function pe(){document.getElementById("context-menu").classList.add("hidden")}function Kr(e,o){e.stopPropagation(),pe();const t=document.querySelector(".right-click-target");if(t.classList.remove("right-click-target"),!t){j("No item selected.","error");return}const n=t.getAttribute("data-item-id"),r=t.closest(".file-explorer-window");let i;r?i=r.getAttribute("data-current-path"):i=t.getAttribute("data-current-path");let a=Y();if(!a||!a.folders){console.error("File system state not properly initialized:",a),j("File system not initialized. Please refresh the page.","error");return}let s={};const l=i.length===4;if(s=a.folders[i],!s){console.error("Folder contents not found for path:",i),j("Folder contents not found.","error");return}if(!(n in s)){j("Item not found.","error");return}let d=s[n];if(!d){j("Item not found in file system.","error");return}const f=`window-${Date.now()}`,u=V("Edit Item Name","",!1,f,!1,!1,{type:"integer",width:300,height:150},"Default").querySelector(".p-2");u.classList.add("p-4");const p=document.createElement("form");p.id="edit-name-form",p.className="flex flex-col space-y-4",u.appendChild(p);const c=document.createElement("input");c.type="text",c.name="newName",c.required=!0,c.value=d.name,c.className="mt-1 block w-full border border-gray-300 rounded p-2",p.appendChild(at("New Name",c));const h=document.createElement("div");h.className="flex justify-end space-x-2",p.appendChild(h);const v=ne("Cancel"),M=ne("Submit");v.id="cancel-edit-button",M.id="submit-edit-button",h.append(v,M),v.addEventListener("click",()=>te(f)),M.addEventListener("click",()=>De("submit-edit-button","Editing..."));const F=document.getElementById("edit-name-form");F.addEventListener("submit",function(G){G.preventDefault();const R=F.newName.value.trim();if(R&&R!==d.name){if(d.type==="folder"&&d.fullPath){let Z=function(B,L){if(a.folders[B]){a.folders[L]=a.folders[B],delete a.folders[B];for(const $ in a.folders[L]){const D=a.folders[L][$];if(D.type==="folder"&&D.fullPath&&D.fullPath.startsWith(B)){const N=D.fullPath,de=D.fullPath.replace(B,L);D.fullPath=de,a.folders[N]&&Z(N,de)}}}};var z=Z;const U=/^[A-Z]:\/\/$/;let _;U.test(i)?_=i+R:_=i+"/"+R;const oe=d.fullPath;d.fullPath=_,Z(oe,_)}d.name=R,i==="C://Desktop"?typeof X=="function"?X():console.error("renderDesktopIcons function not available"):typeof se=="function"?se(i):console.error("refreshAllExplorerWindows function not available"),setFileSystemState(a),O().catch(U=>{console.error("Failed to save state after renaming:",U)}),setTimeout(()=>{i==="C://Desktop"&&typeof X=="function"?X():typeof se=="function"&&se(i)},100)}te(f)}),document.getElementById("cancel-edit-button").addEventListener("click",function(){te(f)})}function Xr(e){e.stopPropagation(),pe();const o=document.querySelector(".right-click-target");if(o&&o.classList.remove("right-click-target"),!o){j("No file selected.","error");return}const t=o.getAttribute("data-item-id"),n=o.closest(".file-explorer-window"),r=n?n.getAttribute("data-current-path"):o.getAttribute("data-current-path"),i=Y();if(!i||!i.folders){console.error("File system state not properly initialized:",i),j("File system not initialized. Please refresh the page.","error");return}let a=i.folders[r];if(!a){console.error("Folder contents not found for path:",r),console.error("Available folders:",Object.keys(i.folders)),j("Folder not found in file system.","error");return}if(!(t in a)){console.error("Item not found in folder:",t,"at path:",r),console.error("Available items:",Object.keys(a)),j("Item not found.","error");return}const s=`window-${Date.now()}`,d=V("Delete File?","",!1,s,!1,!1,{type:"integer",width:320,height:140},"Default").querySelector(".p-2");d.classList.add("p-4","flex","flex-col","justify-between","h-full");const f=document.createElement("p");f.textContent="Are you sure you want to delete this file?",d.appendChild(f);const m=document.createElement("div");m.className="flex justify-end space-x-2",d.appendChild(m);const u=ne("Cancel"),p=ne("Delete");m.append(u,p),u.addEventListener("click",()=>te(s)),p.addEventListener("click",async()=>{const c=a[t],h=c&&c.content_type&&["mp3","wav","ogg","audio"].includes(c.content_type),v=r==="C://Media";if(r==="C://Desktop"){const M="icon-"+t;desktopIconsState[M]&&delete desktopIconsState[M]}delete a[t],i.folders[r]=a,await vn(i),se(r),r==="C://Desktop"&&X(),h&&v&&typeof window.refreshMediaPlayerPlaylist=="function"&&setTimeout(()=>{window.refreshMediaPlayerPlaylist()},100),te(s)})}function gn(e,o){e.stopPropagation(),pe();const t=o||"C://";Bt("Enter the name for the new folder:","New Folder",async n=>{(!n||!n.trim())&&(n="Untitled"),n=n.trim();let r=Y();if(!r||!r.folders){console.error("File system state not properly initialized:",r),j("File system not initialized. Please refresh the page.","error");return}const i="folder-"+Date.now(),a=/^[A-Z]:\/\/$/;let s=a.test(t)?t+n:t+"/"+n;const l={id:i,name:n,type:"folder",fullPath:s,contents:{}};let d;a.test(o)?(d=r.folders[o],d||(r.folders[o]={},d=r.folders[o])):o==="C://Desktop"?(r.folders["C://Desktop"]||(r.folders["C://Desktop"]={}),d=r.folders["C://Desktop"]):(d=r.folders[o],d||(console.warn("Parent folder contents not found, creating:",o),r.folders[o]={},d=r.folders[o])),d[i]=l,r.folders[s]={},await setFileSystemState(r);try{await O(),o==="C://Desktop"?typeof X=="function"&&X():typeof se=="function"&&se(t)}catch(f){console.error("Failed to save state after creating folder:",f)}},()=>{})}function Jr(e,o,t=null){e&&e.stopPropagation(),pe();const n=o||"C://",r=`window-${Date.now()}`,a=V("New File","",!1,r,!1,!1,{type:"integer",width:300,height:150},"Default").querySelector(".p-2");a.classList.add("p-4");const s=document.createElement("form");s.id="create-file-form",s.className="flex flex-col space-y-4",a.appendChild(s);const l=document.createElement("input");l.type="text",l.name="fileName",l.required=!0,l.value="New File.rtf",l.className="mt-1 block w-full border border-gray-300 rounded p-2",s.appendChild(at("File Name",l));const d=document.createElement("div");d.className="flex justify-end space-x-2",s.appendChild(d);const f=ne("Cancel");f.id="cancel-file-button";const m=ne("Submit");m.id="submit-file-button",d.append(f,m),f.addEventListener("click",u=>{u.preventDefault(),De("cancel-file-button","Cancelling..."),setTimeout(()=>te(r),100)}),s.addEventListener("submit",u=>{u.preventDefault(),De("submit-file-button","Submitting..."),setTimeout(()=>te(r),100);const p=l.value.trim()||"Untitled",c={id:`file-${Date.now()}`,name:p,type:"ugc-file",content:"",content_type:"markdown",icon_url:"image/doc.png",description:""};ft(c,n)&&(o==="C://Desktop"?X():se(n),O().catch(h=>{console.error("Failed to save state after creating file:",h)}),typeof t=="function"&&t(c.id,c))})}function Qr(e,o){e.stopPropagation(),pe(),console.log("createNewShortcut called with fromFullPath:",o);const t=o||"C://",n=`window-${Date.now()}`,i=V("New Shortcut","",!1,n,!1,!1,{type:"integer",width:300,height:200},"Default").querySelector(".p-2");i.classList.add("p-4");const a=document.createElement("form");a.id="create-shortcut-form",a.className="flex flex-col space-y-4",i.appendChild(a);const s=document.createElement("input");s.type="text",s.name="shortcutName",s.placeholder="Example Website",s.className="mt-1 block w-full border border-gray-300 rounded p-2",a.appendChild(at("Shortcut Name",s));const l=document.createElement("input");l.type="url",l.name="shortcutURL",l.required=!0,l.placeholder="https://example.com",l.className="mt-1 block w-full border border-gray-300 rounded p-2",a.appendChild(at("Shortcut URL",l));const d=document.createElement("div");d.className="flex justify-end space-x-2";const f=ne("Cancel");f.id="cancel-shortcut-button";const m=ne("Submit");m.id="submit-shortcut-button",d.append(f,m),a.appendChild(d),f.addEventListener("click",()=>{e.preventDefault(),De("cancel-shortcut-button","Cancelling..."),setTimeout(()=>te(n),100)}),a.addEventListener("submit",async u=>{u.preventDefault(),De("submit-shortcut-button","Submitting..."),setTimeout(()=>te(n),100);const p=l.value.trim();if(!p)return;const c=s.value.trim()||p.replace(p.substring(15),"…");console.log("=== Shortcut Form Submission ==="),console.log("Shortcut URL:",p),console.log("Shortcut Name:",c),console.log("fromFullPath parameter:",o),console.log("parentPath variable:",t);const h=`shortcut-${Date.now()}`;let v="https://www.google.com/s2/favicons?sz=64&domain=";try{v+=new URL(p).hostname}catch{v="image/doc.png"}const M={id:h,name:c,type:"shortcut",url:p,icon_url:v,description:"",fullPath:o==="C://Desktop"?`C://Desktop/${c}`:`${o}/${c}`};console.log("Creating shortcut object:",M),console.log("Will save to path:",o);const F=await ft(M,o);if(console.log("Save operation result:",F),!F){console.error("Failed to save shortcut to filesystem");return}o==="C://Desktop"?(console.log("Refreshing desktop icons..."),setTimeout(async()=>{await X(),console.log("Desktop icons refreshed")},100)):Te(),fe();try{await O(),console.log("Global state saved successfully")}catch(T){console.error("Failed to save state after creating shortcut:",T)}console.log("=== Shortcut creation complete ===")})}async function ei(e,o,t=null){e&&e.stopPropagation(),pe();const n=o||"C://";Bt("Enter the name for the new LetterPad document:","New LetterPad.md",async r=>{(!r||!r.trim())&&(r="New LetterPad.md"),r=r.trim(),r.endsWith(".md")||(r=r+".md");const i=`file-${Date.now()}`,a="",s={id:i,name:r,type:"ugc-file",content:a,content_type:"markdown",icon_url:"image/doc.png"};if(await ft(s,n)){try{await O()}catch(l){console.error("Failed to save state after creating LetterPad:",l)}o==="C://Desktop"?X():se(n),V(r,`<div class="letterpad_editor min-h-48 h-full w-full" data-letterpad-editor-id="${i}"></div>`,!1,i,!1,!1,{type:"integer",width:600,height:500},"editor"),setTimeout(()=>{const l=`letterpad_${i}`;E.setItemSync(l,{content:a});const d=document.querySelector(`[data-letterpad-editor-id="${i}"]`);d&&typeof Pe=="function"&&Pe(d)},100),typeof t=="function"&&t(s.id,s)}},()=>{})}function ti(e,o,t=null){e&&e.stopPropagation(),pe();const n=o||"C://",r=document.createElement("input");r.type="file",r.accept="image/*",r.style.display="none",r.addEventListener("change",async i=>{const a=i.target.files[0];if(a){const l=a.size/1048576;if(l>25){j(`Image file "${a.name}" is too large (${l.toFixed(2)}MB). Maximum allowed size is 25MB.`,"error"),document.body.removeChild(r);return}const d=a.name.split(".").pop().toLowerCase(),f=await Ut(a.name,n,d,a);f&&typeof t=="function"&&t(f.id,f),o==="C://Desktop"?typeof X=="function"&&X():typeof se=="function"&&se(n)}document.body.removeChild(r)}),document.body.appendChild(r),r.click()}function oi(e,o,t=null){e&&e.stopPropagation(),pe();const n=o||"C://",r=document.createElement("input");r.type="file",r.accept="audio/*",r.style.display="none",r.addEventListener("change",async i=>{const a=i.target.files[0];if(a){const l=a.size/1048576;if(l>50){j(`Audio file "${a.name}" is too large (${l.toFixed(2)}MB). Maximum allowed size is 50MB.`,"error"),document.body.removeChild(r);return}const d=a.name.split(".").pop().toLowerCase(),f=await Ut(a.name,n,d,a);f&&typeof t=="function"&&t(f.id,f),o==="C://Desktop"?typeof X=="function"&&X():typeof se=="function"&&se(n)}document.body.removeChild(r)}),document.body.appendChild(r),r.click()}function ni(e,o,t=null){e&&e.stopPropagation(),pe();const n=o||"C://",r=document.createElement("input");r.type="file",r.accept="video/*",r.style.display="none",r.addEventListener("change",async i=>{const a=i.target.files[0];if(a){const l=a.size/1048576;if(l>100){j(`Video file "${a.name}" is too large (${l.toFixed(2)}MB). Maximum allowed size is 100MB.`,"error"),document.body.removeChild(r);return}const d=a.name.split(".").pop().toLowerCase(),f=await Ut(a.name,n,d,a);f&&typeof t=="function"&&t(f.id,f),o==="C://Desktop"?typeof X=="function"&&X():typeof se=="function"&&se(n)}document.body.removeChild(r)}),document.body.appendChild(r),r.click()}function at(e,o){const t=document.createElement("div"),n=document.createElement("label");return n.className="block text-sm font-medium text-gray-700",n.textContent=e,t.append(n,o),t}function se(e){const o=document.querySelectorAll(".file-explorer-window");let t=0;o.forEach((n,r)=>{if(n.getAttribute("data-current-path")===e)try{const a=Ae(e),s=document.createElement("div");s.innerHTML=a;const l=s.querySelector(".file-explorer-window");if(l){n.innerHTML=l.innerHTML,n.setAttribute("data-current-path",e);const d=n.closest(".window");d&&d.id&&Fe(d.id,a),t++}else console.warn(`Failed to get new explorer content for window ${r}`)}catch(a){console.error(`Error refreshing window ${r}:`,a)}}),setTimeout(()=>{typeof fe=="function"&&fe()},50)}window.refreshAllExplorerWindows=se;async function ft(e,o){console.log("=== addItemToFileSystem called ==="),console.log("Item:",e),console.log("Target path:",o);const t=Y();if(console.log("Current filesystem state keys:",t?Object.keys(t):"null"),console.log("Available folder paths:",t&&t.folders?Object.keys(t.folders):"no folders"),!t||!t.folders)return console.error("File system state not properly initialized:",t),j("File system not initialized. Please refresh the page.","error"),!1;let n=t.folders[o];console.log("Destination folder exists:",!!n),n||(console.warn("Parent folder contents not found, creating:",o),t.folders[o]={},n=t.folders[o],console.log("Created new destination folder for path:",o)),console.log("Items in destination before adding:",Object.keys(n)),n[e.id]=e,console.log("Added item to filesystem:",e.id,"type:",e.type,"to path:",o),console.log("Items in destination after adding:",Object.keys(n)),console.log("Saving filesystem state..."),await setFileSystemState(t),console.log("Filesystem state saved");const i=Y().folders[o];return console.log("Verification - item exists after save:",!!(i&&i[e.id])),console.log("=== addItemToFileSystem complete ==="),!0}async function Ut(e,o,t,n){const r=`file-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;let i="image/file.png";["png","jpg","jpeg","gif","webp","avif"].includes(t)?i="image/image.png":["mp4","webm","avi","mov"].includes(t)?i="image/video.png":["mp3","wav","ogg"].includes(t)&&(i="image/audio.png");const a={id:r,name:e,type:"ugc-file",content_type:t,icon_url:i,content:"",isLargeFile:!0,storageLocation:"indexeddb",file:null};if(!ft(a,o))return null;if(n&&["png","jpg","jpeg","gif","webp","avif","mp3","wav","ogg","mp4","webm","avi","mov"].includes(t)){const s=URL.createObjectURL(n),l=Y(),d=l.folders[o];d&&d[r]&&(d[r].tempObjectURL=s,d[r].file=n,setFileSystemState(l));try{const f=await new Promise((c,h)=>{const v=new FileReader;v.onload=M=>c(M.target.result),v.onerror=h,v.readAsDataURL(n)}),m=f.length*.75/(1024*1024);await E.setItem(`file_data_${r}`,f);const u=Y(),p=u.folders[o];p&&p[r]&&(p[r].isLargeFile=!0,p[r].storageLocation="indexeddb",p[r].content="",p[r].fileSizeInMB=m,p[r].actualSizeInMB=m,p[r].dataURL=f,p[r].file=null),setFileSystemState(u),await O(),o==="C://Media"&&["mp3","wav","ogg","mp4","webm","avi","mov"].includes(t)&&typeof window.refreshMediaPlayerPlaylist=="function"&&setTimeout(()=>{window.refreshMediaPlayerPlaylist()},200)}catch(f){console.error("Failed to store binary file:",f);const m=Y(),u=m.folders[o];u&&u[r]&&(u[r].isLargeFile=!0,u[r].storageLocation="failed",setFileSystemState(m)),j(`File "${e}" could not be stored. Storage error: ${f.message}`,"error")}}else await O();return a}async function ri(){const e=window.location.href.includes("reddit.com");let o="1.0.0";try{o=(await(await fetch("./package.json")).json()).version||"1.0.0"}catch(n){console.warn("Could not fetch version from package.json:",n)}const t=`
    <div class="p-4 gap-y-2 flex flex-col">
      <img src="./image/startup.png" class="w-48 h-auto mx-auto mb-4">
      <h1 class="text-xl font-bold mb-2">About This Computer</h1>
      <p>Made by multimedia artist Ian McKenzie.</p>
      <p>More shenanigans @ ${e?"relentlesscurious.com":'<a href="https://www.relentlesscurious.com" target="_blank">relentlesscurious.com</a>'}</p>
      <p>Version: ${o}</p>
      <p>Copyright © Ian Rand McKenzie, 2025</p>
      <p>This project must be purchased for use, but is open source and free for those who contribute via code, security research, bug reporting, etc. — contributors may do so on <a target="_blank" href="https://github.com/ianrandmckenzie/nostalgia_os">github.com/ianrandmckenzie/nostalgia_os</a></p>
    </div>
  `;V("About This Computer",t,!1,null,!1,!1,{type:"integer",width:400,height:640},"default",null,"gray-200 cursor-not-allowed pointer-events-none")}const Qe="1.0";async function ii(){console.log("✅ All scripts have been successfully converted to ES modules")}async function ai(){var o;await((o=E.ensureReady)==null?void 0:o.call(E))||Promise.resolve();let e=await E.getItem("version");if(e||await E.setItem("version",Qe),e!==Qe){const t=await E.getItem("explicitRestart");await E.removeItem("appState"),await E.removeItem("version"),await E.setItem("version",Qe),t&&await E.setItem("explicitRestart",t)}}typeof window<"u"&&(window.version=Qe,window.highestZ=ye,window.activeMediaWindow=Re,window.windowStates=H,window.desktopIconsState=Q,window.navWindows=he,window.desktopSettings=ee,window.startMenuOrder=W,window.fileFolderMapping=tn,window.createWindow=V,window.minimizeWindow=He,window.bringToFront=Le,window.closeWindow=te,window.toggleFullScreen=Ot,window.showDialogBox=j,window.getAppIcon=Go,window.renderDesktopIcons=X,window.makeIconDraggable=dt,window.toggleStartMenu=_t,window.minimizeAllWindows=dn,window.openNav=Zr,window.updateClock=qt,window.toggleMediaPlayback=un,window.updateMediaControl=pn,window.getActiveMediaElement=jt,window.openApp=vt,window.openExplorer=Ge,window.openExplorerInNewWindow=Ue,window.refreshExplorerViews=Te,window.getExplorerWindowContent=Ae,window.getBreadcrumbsHtml=co,window.openFile=et,window.normalizePath=Je,window.getFolderIdByFullPath=Sn,window.findFolderObjectByFullPath=lo,window.findFolderFullPathById=st,window.showContextMenu=mn,window.hideContextMenu=pe,window.createNewFolder=gn,window.createNewFile=Jr,window.refreshAllExplorerWindows=se,window.saveFileExplorerState=Oe,window.handleWatercolourImageSelection=Cn,window.launchCompostBin=mo,window.loadCompostBinContents=lt,window.emptyCompostBin=go,window.launchStorageManager=Xo,window.refreshStorageData=Ye,window.fullSystemRestart=en,window.openCleanupWindow=Jo,window.makeWin95Dropdown=fr,window.openAboutWindow=ri,window.launchCalculator=Co,window.initializeCalculatorUI=ko,window.launchSolitaire=Io,window.initializeSolitaireUI=Lo,window.launchChess=Do,window.initializeChessUI=Mo,window.launchBombbroomer=No,window.initializeBombbroomerUI=Ro,window.initializeLetterPad=Pe,window.initializeAllLetterPadEditors=fn,window.applyFormatting=Lt,window.convertMarkdownToHTML=Dt,window.launchMailbox=ho,window.launchWatercolour=vo,window.initializeWatercolourUI=xo,window.getWatercolourHTML=Eo,window.initializeWatercolour=So,window.launchTubeStream=bo,window.loadPrimaryStream=wo,window.launchMediaPlayer=Wo,window.initializeMediaPlayerUI=_o,window.restoreMediaPlayerSession=qo,window.saveMediaPlayerState=ke,window.loadMediaPlayerState=Tt,window.clearMediaPlayerState=Qn,window.restart=Vo,window.logout=Ko,window.storage=E);document.getElementById("desktop").addEventListener("click",function(e){e.target.closest(".draggable-icon")||document.querySelectorAll(".draggable-icon").forEach(o=>o.classList.remove("bg-gray-50"))});window.addEventListener("click",async function(e){const o=document.getElementById("start-menu"),t=document.getElementById("start-button");if(!o.contains(e.target)&&!t.contains(e.target)){if(!o.classList.contains("hidden")){const{toggleButtonActiveState:n}=await so(async()=>{const{toggleButtonActiveState:r}=await Promise.resolve().then(()=>fo);return{toggleButtonActiveState:r}},void 0);n("start-button")}o.classList.add("hidden")}});window.addEventListener("load",async function(){await ai(),await ii();const{toggleButtonActiveState:e,makeWin95Button:o,makeWin95Prompt:t,openFileExplorerForImageSelection:n}=await so(async()=>{const{toggleButtonActiveState:a,makeWin95Button:s,makeWin95Prompt:l,openFileExplorerForImageSelection:d}=await Promise.resolve().then(()=>fo);return{toggleButtonActiveState:a,makeWin95Button:s,makeWin95Prompt:l,openFileExplorerForImageSelection:d}},void 0);window.toggleButtonActiveState=e,window.makeWin95Button=o,window.makeWin95Prompt=t,window.openFileExplorerForImageSelection=n;const r=await E.getItem("appState"),i=await E.getItem("explicitRestart");(!r||i)&&(ut(),i&&await E.removeItem("explicitRestart")),await kt(),await kr(),await X(),await Pr(),typeof it=="function"?it():console.error("initializeStartMenu function not available"),document.querySelectorAll(".draggable-icon").forEach(a=>dt(a))});
